<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>é»‘æš—å¹»æƒ³æŠ½å¡ç»è¥æ¸¸æˆ</title><script src="https://cdn.tailwindcss.com"></script><style>@import url(https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700;900&family=Inter:wght@400;500;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap);:root{--font-ui:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI','Microsoft YaHei','SimHei',sans-serif;--font-title:'Cinzel','Noto Serif SC','Songti SC','SimSun',serif;--font-serif:'Noto Serif SC','Songti SC','SimSun',serif;--primary:#c084fc;--primary-dark:#7c3aed;--secondary:#fb7185;--accent:#f6c56a;--accent-gold:#f6d38b;--bg-dark:#06040b;--bg-card:rgba(18, 16, 30, 0.72);--bg-hover:rgba(26, 24, 44, 0.78);--border:rgba(255, 255, 255, 0.08);--text-primary:rgba(248, 246, 255, 0.96);--text-secondary:rgba(226, 223, 255, 0.68);--success:#34d399;--warning:#fbbf24;--danger:#fb7185;--rarity-n:#9ca3af;--rarity-r:#4ade80;--rarity-sr:#60a5fa;--rarity-ssr:#f6c56a;--radius-xl:24px;--radius-lg:18px;--radius-md:14px;--blur:22px;--shadow-1:0 10px 30px rgba(0, 0, 0, 0.45);--shadow-2:0 24px 70px rgba(0, 0, 0, 0.6);--glow-primary:0 0 26px rgba(192, 132, 252, 0.28);--glow-gold:0 0 26px rgba(246, 197, 106, 0.22)}:root[data-theme=light]{--bg-dark:#fbf5e6;--bg-card:rgba(255, 255, 255, 0.78);--bg-hover:rgba(255, 255, 255, 0.92);--border:rgba(37, 28, 18, 0.14);--text-primary:rgba(20, 16, 12, 0.92);--text-secondary:rgba(20, 16, 12, 0.62)}:root[data-ui=mobile] body{padding-bottom:160px}:root[data-ui=mobile] .page{padding:98px 12px 160px}:root[data-ui=mobile] .modal-content{padding:20px;margin:10px;width:calc(100% - 20px);max-width:760px}:root[data-ui=mobile] .topbar{top:10px;padding:10px 12px;width:calc(100% - 20px)}:root[data-ui=mobile] .topbar-brand .title{font-size:12px}:root[data-ui=mobile] .topbar-brand .subtitle{display:none}:root[data-ui=mobile] .bottom-nav{bottom:10px;width:calc(100% - 20px)}:root[data-ui=mobile] .character-list-item{flex-direction:column;align-items:stretch}:root[data-ui=mobile] .character-list-image{width:100%;height:200px;min-width:100%}:root[data-ui=mobile] .character-list-actions{width:100%;flex-direction:column}:root[data-ui=mobile] .character-list-actions .btn{width:100%}:root[data-ui=mobile] .room-grid{grid-template-columns:1fr}:root[data-ui=mobile] .btn{padding:14px 18px;font-size:15px}*{margin:0;padding:0;box-sizing:border-box}::selection{background:rgba(246,211,139,.28);color:var(--text-primary)}:focus-visible{outline:3px solid rgba(246,211,139,.28);outline-offset:3px}@media (prefers-reduced-motion:reduce){*{animation-duration:0s!important;animation-iteration-count:1!important;transition-duration:0s!important;scroll-behavior:auto!important}}body{font-family:var(--font-ui);background:radial-gradient(1200px 800px at 20% -10%,rgba(192,132,252,.22),transparent 60%),radial-gradient(900px 700px at 110% 20%,rgba(246,197,106,.16),transparent 55%),radial-gradient(700px 560px at 30% 120%,rgba(251,113,133,.14),transparent 60%),linear-gradient(180deg,rgba(255,255,255,.02),transparent 40%),var(--bg-dark);background-attachment:fixed;color:var(--text-primary);min-height:100vh;padding-bottom:140px;line-height:1.75;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}body::before{content:'';position:fixed;inset:0;pointer-events:none;background:radial-gradient(900px 520px at 50% -10%,rgba(255,255,255,.08),transparent 60%),radial-gradient(1200px 900px at 50% 120%,rgba(0,0,0,.75),transparent 60%);opacity:.9;z-index:-2}body::after{content:'';position:fixed;inset:0;pointer-events:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");opacity:.08;mix-blend-mode:overlay;z-index:-1}:root[data-theme=light] body::before{opacity:.25}#app{position:relative}.topbar{position:fixed;top:12px;left:50%;transform:translateX(-50%);width:min(1100px,calc(100% - 24px));z-index:1200;border-radius:var(--radius-xl);background:linear-gradient(180deg,rgba(18,16,30,.82),rgba(18,16,30,.58));border:1px solid rgba(246,211,139,.18);box-shadow:var(--shadow-2);backdrop-filter:blur(var(--blur));padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px;isolation:isolate;overflow:hidden}.topbar::before{content:'';position:absolute;inset:0;border-radius:inherit;pointer-events:none;background:radial-gradient(520px 260px at 20% 0,rgba(246,211,139,.16),transparent 70%),radial-gradient(520px 260px at 80% 0,rgba(192,132,252,.14),transparent 70%);opacity:.8;mix-blend-mode:screen;z-index:-1}.topbar-brand{display:flex;flex-direction:column;gap:2px;min-width:0}.topbar-brand .title{font-family:var(--font-title);letter-spacing:.18em;font-weight:900;font-size:13px;color:rgba(248,246,255,.95);text-transform:uppercase;white-space:nowrap}.topbar-brand .subtitle{font-family:var(--font-serif);font-size:12px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.topbar-pills{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);box-shadow:inset 0 1px 0 rgba(255,255,255,.14);font-size:12px;color:var(--text-secondary)}.pill strong{color:var(--text-primary);font-weight:700;letter-spacing:.02em}.pill .ico{filter:drop-shadow(0 0 10px rgba(246, 211, 139, .18))}.card{position:relative;background:var(--bg-card);backdrop-filter:blur(var(--blur));border:1px solid var(--border);border-radius:var(--radius-xl);padding:24px;box-shadow:var(--shadow-1);transition:all .3s cubic-bezier(.4, 0, .2, 1)}.card::before{content:'';position:absolute;inset:0;border-radius:inherit;pointer-events:none;background:linear-gradient(135deg,rgba(246,211,139,.16),rgba(192,132,252,.12),rgba(251,113,133,.08)),radial-gradient(600px 260px at 30% 0,rgba(255,255,255,.12),transparent 60%);opacity:.45;mix-blend-mode:screen}.card:hover{border-color:rgba(246,211,139,.22);box-shadow:var(--shadow-2),var(--glow-primary);transform:translateY(-3px)}.btn{font-family:var(--font-ui);background:linear-gradient(135deg,var(--primary) 0,var(--secondary) 55%,rgba(246,197,106,.95) 120%);border:1px solid rgba(255,255,255,.14);color:rgba(255,255,255,.95);padding:12px 22px;border-radius:var(--radius-md);cursor:pointer;font-weight:700;font-size:14px;letter-spacing:.02em;transition:all .3s cubic-bezier(.4, 0, .2, 1);box-shadow:0 16px 34px rgba(192,132,252,.18),0 10px 22px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.25);position:relative;overflow:hidden;isolation:isolate}.btn::before{content:'';position:absolute;inset:-2px;background:linear-gradient(120deg,transparent 0,rgba(255,255,255,.26) 28%,transparent 55%);transform:translateX(-130%);transition:transform .75s cubic-bezier(.2, .9, .2, 1);mix-blend-mode:screen;z-index:0}.btn::after{content:'';position:absolute;inset:0;border-radius:inherit;pointer-events:none;box-shadow:inset 0 0 0 1px rgba(0,0,0,.18);z-index:1}.btn:hover::before{transform:translateX(130%)}.btn:hover{transform:translateY(-2px);box-shadow:0 22px 50px rgba(192,132,252,.22),0 14px 28px rgba(0,0,0,.35),var(--glow-gold),inset 0 1px 0 rgba(255,255,255,.28)}.btn:active{transform:translateY(0)}.btn:disabled{opacity:.5;cursor:not-allowed;transform:none;filter:grayscale(.2)}.btn-secondary{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.12);color:var(--text-primary);box-shadow:0 12px 26px rgba(0,0,0,.28),inset 0 1px 0 rgba(255,255,255,.18)}.btn-secondary:hover{background:linear-gradient(180deg,rgba(255,255,255,.11),rgba(255,255,255,.05));box-shadow:0 18px 40px rgba(0,0,0,.3),var(--glow-primary),inset 0 1px 0 rgba(255,255,255,.22)}input,select,textarea{font-family:var(--font-ui);background:rgba(255,255,255,.06)!important;border:1px solid rgba(255,255,255,.14)!important;border-radius:var(--radius-md)!important;color:var(--text-primary)!important;outline:0;box-shadow:inset 0 1px 0 rgba(255,255,255,.12)}input::placeholder,textarea::placeholder{color:rgba(226,223,255,.55)}input:focus,select:focus,textarea:focus{border-color:rgba(246,211,139,.35)!important;box-shadow:0 0 0 4px rgba(192,132,252,.16),inset 0 1px 0 rgba(255,255,255,.16)!important}:root[data-theme=light] input,:root[data-theme=light] select,:root[data-theme=light] textarea{background:rgba(15,10,5,.04)!important;border:1px solid rgba(37,28,18,.18)!important;color:rgba(20,16,12,.92)!important}.rarity-N{border-color:var(--rarity-n);color:var(--rarity-n);box-shadow:0 0 10px rgba(156,163,175,.3)}.rarity-R{border-color:var(--rarity-r);color:var(--rarity-r);box-shadow:0 0 15px rgba(74,222,128,.4)}.rarity-SR{border-color:var(--rarity-sr);color:var(--rarity-sr);box-shadow:0 0 20px rgba(96,165,250,.5)}.rarity-SSR{border-color:var(--rarity-ssr);color:var(--rarity-ssr);box-shadow:0 0 30px rgba(245,158,11,.7);animation:ssrGlow 2s ease-in-out infinite}@keyframes ssrGlow{0%,100%{box-shadow:0 0 30px rgba(245,158,11,.7)}50%{box-shadow:0 0 50px #f59e0b}}.character-card{position:relative;border:2px solid;border-radius:16px;overflow:visible;transition:all .4s cubic-bezier(.4, 0, .2, 1);background:rgba(30,41,59,.6);backdrop-filter:blur(10px);padding:12px}.character-card:hover{transform:translateY(-8px) scale(1.02);box-shadow:0 20px 40px rgba(0,0,0,.4)}.character-avatar{width:100%;aspect-ratio:1;position:relative;overflow:hidden;background:linear-gradient(135deg,var(--primary) 0,var(--secondary) 100%);border-radius:12px;margin-bottom:12px;cursor:pointer}.character-avatar img{width:100%;height:100%;object-fit:cover;display:block}.character-image-container{width:100%;height:100%;position:relative}.character-info{text-align:center}.character-name{font-weight:700;font-size:15px;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.character-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;justify-content:center}.character-action-btn{padding:6px 12px;font-size:12px;border-radius:8px;border:1px solid rgba(139,92,246,.3);background:rgba(139,92,246,.1);color:var(--primary);cursor:pointer;transition:all .3s}.character-action-btn:hover{background:rgba(139,92,246,.2);transform:translateY(-2px)}.page{display:none;padding:104px 18px 150px;max-width:1200px;margin:0 auto;animation:fadeIn .45s ease-out}.page.active{display:block}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.bottom-nav{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);width:min(760px,calc(100% - 24px));background:linear-gradient(180deg,rgba(18,16,30,.86),rgba(18,16,30,.62));backdrop-filter:blur(var(--blur));border:1px solid rgba(246,211,139,.16);border-radius:26px;display:flex;justify-content:space-around;padding:10px 10px calc(10px + env(safe-area-inset-bottom));z-index:1000;box-shadow:var(--shadow-2);isolation:isolate;overflow:hidden}.bottom-nav::before{content:'';position:absolute;inset:0;border-radius:inherit;pointer-events:none;background:radial-gradient(420px 180px at 15% 0,rgba(246,211,139,.14),transparent 70%),radial-gradient(420px 180px at 85% 0,rgba(192,132,252,.12),transparent 70%);opacity:.85;mix-blend-mode:screen;z-index:-1}.nav-item{position:relative;flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 10px;cursor:pointer;color:var(--text-secondary);transition:all .3s;border-radius:18px;min-width:64px;user-select:none;z-index:1}.nav-item.active{color:var(--text-primary)}.nav-item:hover{color:var(--text-primary)}.nav-item.active::before{content:'';position:absolute;inset:0;border-radius:inherit;background:linear-gradient(135deg,rgba(246,211,139,.14),rgba(192,132,252,.18),rgba(251,113,133,.1));border:1px solid rgba(255,255,255,.14);box-shadow:var(--glow-primary);z-index:-1}.nav-item.active::after{content:'';position:absolute;top:-7px;left:50%;width:10px;height:10px;transform:translateX(-50%);border-radius:50%;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.9),var(--accent) 55%,rgba(246,197,106,.1) 70%);box-shadow:var(--glow-gold)}.nav-item .icon{font-size:24px;filter:drop-shadow(0 10px 18px rgba(0, 0, 0, .35))}.nav-item .label{font-size:11px;font-weight:650;letter-spacing:.04em}.character-grid{display:flex;flex-direction:column;gap:12px;padding:20px 0}.character-list-item{display:flex;align-items:center;gap:16px;padding:16px;background:var(--bg-card);border:2px solid rgba(255,255,255,.08);border-radius:var(--radius-xl);transition:transform .25s cubic-bezier(.2, .8, .2, 1),box-shadow .25s cubic-bezier(.2, .8, .2, 1),background .25s cubic-bezier(.2, .8, .2, 1);backdrop-filter:blur(var(--blur));box-shadow:0 16px 34px rgba(0,0,0,.25)}#character-card-display{max-width:100%;overflow-x:auto;box-sizing:border-box}#character-card-display>div{max-width:100%;box-sizing:border-box;overflow-x:auto}#character-card-display *{max-width:100%;word-wrap:break-word;overflow-wrap:break-word;box-sizing:border-box}#character-card-display>div>*{max-width:100%!important;box-sizing:border-box!important}#character-detail-content{max-width:100%;overflow-x:auto}#character-detail-content>*{max-width:100%;box-sizing:border-box}#character-detail-content *{max-width:100%;word-wrap:break-word;overflow-wrap:break-word}.character-list-item:hover{background:var(--bg-hover);transform:translateY(-2px);box-shadow:var(--shadow-1),var(--glow-primary)}.character-list-image{width:80px;height:80px;min-width:80px;border-radius:8px;overflow:hidden;background:linear-gradient(135deg,var(--primary) 0,var(--secondary) 100%);display:flex;align-items:center;justify-content:center}.character-list-image img{width:100%;height:100%;object-fit:cover}.character-list-info{flex:1;min-width:0}.character-list-name{font-size:18px;font-weight:700;color:var(--primary);margin-bottom:4px}.character-list-meta{font-size:12px;color:var(--text-secondary);margin-bottom:8px}.character-list-stats{display:flex;gap:12px;flex-wrap:wrap}.character-list-stat-item{display:flex;align-items:center;gap:4px;font-size:11px}.character-list-stat-bar{width:60px;height:4px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden}.character-list-stat-fill{height:100%;background:linear-gradient(90deg,var(--primary) 0,var(--secondary) 100%);transition:width .3s}.character-list-actions{display:flex;gap:8px;flex-shrink:0}.room-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px;padding:20px 0}.room-card{border:1px solid var(--border);border-radius:var(--radius-xl);padding:20px;background:var(--bg-card);cursor:pointer;transition:transform .28s cubic-bezier(.2, .8, .2, 1),box-shadow .28s cubic-bezier(.2, .8, .2, 1),background .28s cubic-bezier(.2, .8, .2, 1);backdrop-filter:blur(var(--blur));box-shadow:0 16px 34px rgba(0,0,0,.35)}.room-card.occupied{background:linear-gradient(180deg,rgba(192,132,252,.14),rgba(18,16,30,.72))}.room-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-2),var(--glow-primary)}.story-container{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:var(--radius-xl);padding:24px;margin:20px 0;min-height:260px;max-height:600px;overflow-y:auto;backdrop-filter:blur(var(--blur));box-shadow:inset 0 1px 0 rgba(255,255,255,.08),0 18px 46px rgba(0,0,0,.35)}.story-content{font-family:var(--font-serif);line-height:2.05;font-size:15px;color:var(--text-primary);white-space:pre-wrap;word-wrap:break-word}.story-content img{max-width:100%;height:auto;border-radius:12px;margin:15px 0;box-shadow:0 5px 15px rgba(0,0,0,.5)}.story-placeholder{text-align:center;color:var(--text-secondary);font-style:italic;padding:60px 20px;font-size:16px}.story-loading{text-align:center;color:var(--accent-gold);padding:60px 20px;font-size:18px}.log-container{max-height:400px;overflow-y:auto;padding:16px;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border-radius:var(--radius-lg);margin-top:20px;border:1px solid var(--border);backdrop-filter:blur(var(--blur))}.log-entry{padding:12px;margin-bottom:12px;border-left:3px solid rgba(246,211,139,.7);border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:var(--radius-md);font-size:14px;line-height:1.6;transition:all .3s}.log-entry:hover{background:rgba(255,255,255,.06);transform:translateX(3px);box-shadow:var(--glow-primary)}.stat-bar{height:8px;background:rgba(255,255,255,.08);border-radius:4px;overflow:hidden;margin:6px 0;position:relative}.stat-fill{height:100%;background:linear-gradient(90deg,var(--primary) 0,var(--secondary) 100%);transition:width .6s ease-out;border-radius:4px;box-shadow:var(--glow-primary)}.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(900px 560px at 50% -10%,rgba(192,132,252,.16),rgba(0,0,0,.88) 65%),radial-gradient(900px 560px at 50% 120%,rgba(246,197,106,.12),rgba(0,0,0,.92) 70%),rgba(0,0,0,.88);z-index:2000;overflow-y:auto;padding:20px;backdrop-filter:blur(10px);-webkit-overflow-scrolling:touch}.modal.active{display:block;animation:fadeIn .3s}.modal-content{background:linear-gradient(180deg,rgba(18,16,30,.92),rgba(18,16,30,.78));border:1px solid rgba(246,211,139,.18);border-radius:var(--radius-xl);padding:32px;max-width:900px;width:100%;margin:20px auto;position:relative;box-shadow:var(--shadow-2);backdrop-filter:blur(var(--blur))}.modal-close{position:absolute;top:16px;right:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);color:var(--text-primary);width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;transition:all .3s}.modal-close:hover{background:rgba(246,211,139,.12);transform:rotate(90deg) scale(1.02);box-shadow:var(--glow-gold)}.page-title{font-family:var(--font-title);font-size:clamp(28px, 4.8vw, 40px);color:transparent;background:linear-gradient(90deg,var(--accent-gold),var(--primary),var(--secondary));-webkit-background-clip:text;background-clip:text;text-align:center;margin-bottom:26px;font-weight:900;letter-spacing:.18em;text-shadow:none;filter:drop-shadow(0 18px 30px rgba(0, 0, 0, .45));position:relative}.page-title::after{content:'';display:block;width:min(240px,60%);height:2px;margin:14px auto 0;background:linear-gradient(90deg,transparent,rgba(246,211,139,.75),rgba(192,132,252,.65),transparent);box-shadow:var(--glow-gold)}.section-title{font-family:var(--font-serif);font-size:18px;color:var(--text-primary);margin:26px 0 14px 0;font-weight:700;letter-spacing:.08em;position:relative;padding-left:14px}.section-title::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:6px;height:18px;border-radius:999px;background:linear-gradient(180deg,var(--accent-gold),var(--primary));box-shadow:var(--glow-primary)}@media (max-width:768px){.character-list-item{flex-direction:column;align-items:stretch}.character-list-image{width:100%;height:200px;min-width:100%}.character-list-actions{width:100%;flex-direction:column}.character-list-actions .btn{width:100%}.room-grid{grid-template-columns:1fr}.page{padding:98px 12px 160px}.modal-content{padding:20px;margin:10px}.topbar{top:10px;padding:10px 12px}.topbar-brand .title{font-size:12px}.topbar-brand .subtitle{display:none}.bottom-nav{bottom:10px;width:calc(100% - 20px)}}::-webkit-scrollbar{width:10px}::-webkit-scrollbar-track{background:rgba(255,255,255,.06);border-radius:5px}::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--primary),var(--secondary));border-radius:5px}::-webkit-scrollbar-thumb:hover{background:var(--primary-dark)}</style><script type="module">$(()=>{console.info('æŠ½å¡ç»è¥æ¸¸æˆç•Œé¢å·²åŠ è½½')});
//# sourceMappingURL=index.js.map</script></head><body><div id="app"><div class="topbar"><div class="topbar-brand"><div class="title">é»‘æš—å¹»æƒ³</div><div class="subtitle">Nocturne House Â· æŠ½å¡ç»è¥</div></div><div class="topbar-pills"><div class="pill" title="è´§å¸"><span class="ico">ğŸ’°</span> <strong id="topbar-currency">0</strong></div><div class="pill" title="æ—¶é—´"><span class="ico">â³</span> <strong id="topbar-time">ç¬¬1å¤© æ—©ä¸Š</strong> <span id="topbar-round" style="color:var(--text-secondary)">Â· å›åˆ 1</span></div></div></div><div id="page-home" class="page active"><div class="card"><h1 class="page-title">ğŸ° é»‘æš—å¹»æƒ³ç»è¥æ¸¸æˆ</h1><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-top:30px"><div class="card" style="text-align:center;padding:20px"><div style="font-size:36px;margin-bottom:12px">ğŸ’°</div><div style="font-size:28px;font-weight:700;color:var(--accent-gold)" id="home-currency">1000</div><div style="font-size:14px;color:var(--text-secondary);margin-top:8px">è´§å¸</div></div><div class="card" style="text-align:center;padding:20px"><div style="font-size:36px;margin-bottom:12px">ğŸ‘¥</div><div style="font-size:28px;font-weight:700;color:var(--primary)" id="home-characters">0</div><div style="font-size:14px;color:var(--text-secondary);margin-top:8px">è§’è‰²æ•°é‡</div></div><div class="card" style="text-align:center;padding:20px"><div style="font-size:36px;margin-bottom:12px">ğŸ“Š</div><div style="font-size:28px;font-weight:700;color:var(--accent-gold)" id="home-income">0</div><div style="font-size:14px;color:var(--text-secondary);margin-top:8px">ä»Šæ—¥æ”¶å…¥</div></div><div class="card" style="text-align:center;padding:20px"><div style="font-size:36px;margin-bottom:12px">â±ï¸</div><div style="font-size:24px;font-weight:700;color:var(--primary)" id="home-time">ç¬¬1å¤© æ—©ä¸Š</div><div style="font-size:14px;color:var(--text-secondary);margin-top:8px" id="home-round">å›åˆ: 1</div></div></div><div style="margin-top:30px"><h2 class="section-title">å¿«æ·æ“ä½œ</h2><div style="display:flex;gap:16px;flex-wrap:wrap"><button class="btn" onclick='switchPage("summon")'>ğŸ´ ç«‹å³æŠ½å¡</button> <button class="btn" onclick='switchPage("units")'>ğŸ“¦ æŸ¥çœ‹ä»“åº“</button> <button class="btn" onclick='switchPage("brothel")'>ğŸ›ï¸ ç»è¥å¦“é™¢</button> <button class="btn" onclick="advanceRound()" style="background:linear-gradient(135deg,var(--accent) 0,var(--accent-gold) 100%)">â­ï¸ ä¸‹ä¸€å›åˆ</button></div></div></div></div><div id="page-summon" class="page"><div class="card"><h1 class="page-title">ğŸ´ å¬å”¤ä»ªå¼</h1><div style="text-align:center;margin-bottom:40px"><div style="font-size:56px;margin-bottom:16px">ğŸ’°</div><div style="font-size:40px;font-weight:700;color:var(--accent-gold)" id="summon-currency">1000</div><div style="font-size:16px;color:var(--text-secondary);margin-top:8px">å½“å‰è´§å¸</div></div><div id="limited-banner" style="margin:0 0 24px 0;padding:18px;border-radius:22px;border:1px solid rgba(246,211,139,.18);background:linear-gradient(135deg,rgba(246,211,139,.12),rgba(192,132,252,.12),rgba(251,113,133,.08));box-shadow:var(--shadow-1);backdrop-filter:blur(var(--blur))"><div style="display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap"><div style="min-width:220px;flex:1"><div style="font-size:12px;color:var(--text-secondary);letter-spacing:.12em;margin-bottom:8px">ğŸ•¯ï¸ æœ¬æœŸé™å®šè¯æ¡ï¼ˆæ¯3å¤©åˆ·æ–°ï¼‰</div><div id="limited-tags" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"></div><div id="limited-refresh" style="margin-top:10px;font-size:12px;color:var(--text-secondary)"></div></div><button class="btn" id="btn-limited" onclick='handleSummon("é™å®šå¡æ± ")' style="padding:14px 18px">ğŸ•¯ï¸ é™å®šæŠ½å¡ Â· 250 é‡‘</button></div></div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:40px"><button class="btn" onclick='handleSummon("å•æŠ½")' id="btn-single" style="padding:24px"><div style="font-size:32px;margin-bottom:12px">âœ¨</div><div style="font-size:18px;margin-bottom:8px">å•æŠ½</div><div style="font-size:14px;opacity:.8">250 é‡‘</div></button> <button class="btn" onclick='handleSummon("é—ªå…‰æŠ½å¡")' id="btn-flash" style="padding:24px"><div style="font-size:32px;margin-bottom:12px">ğŸ’«</div><div style="font-size:18px;margin-bottom:8px">é—ªå…‰æŠ½å¡</div><div style="font-size:14px;opacity:.8">3000 é‡‘ (SSR)</div></button> <button class="btn" onclick="showTargetSummonInput()" id="btn-target" style="padding:24px"><div style="font-size:32px;margin-bottom:12px">ğŸ¯</div><div style="font-size:18px;margin-bottom:8px">å®šå‘æŠ½å¡</div><div style="font-size:14px;opacity:.8">1500 é‡‘</div></button></div><div id="summon-results" style="min-height:200px"></div><div id="character-card-display" style="display:none;margin-top:30px"></div></div></div><div id="page-units" class="page"><div><h1 class="page-title">ğŸ“¦ è§’è‰²ä»“åº“</h1><div class="card" style="margin-bottom:24px;display:flex;gap:16px;flex-wrap:wrap"><input id="search-input" placeholder="æœç´¢è§’è‰²..." style="flex:1;min-width:200px;padding:12px;background:rgba(15,23,42,.5);border:1px solid rgba(139,92,246,.3);border-radius:12px;color:var(--text-primary);font-size:14px"/> <select id="filter-rarity" style="padding:12px;background:rgba(15,23,42,.5);border:1px solid rgba(139,92,246,.3);border-radius:12px;color:var(--text-primary);font-size:14px;min-width:150px"><option value="">å…¨éƒ¨ç¨€æœ‰åº¦</option><option value="N">N</option><option value="R">R</option><option value="SR">SR</option><option value="SSR">SSR</option></select></div><div id="character-list" class="character-grid"></div></div><div id="character-detail-modal" class="modal"><div class="modal-content"><button class="modal-close" onclick="closeCharacterDetail()">Ã—</button><div id="character-detail-content"></div></div></div></div><div id="page-brothel" class="page"><div><h1 class="page-title">ğŸ›ï¸ å¦“é™¢ç»è¥</h1><div class="card" style="margin-bottom:24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px"><div><div style="font-size:14px;color:var(--text-secondary);margin-bottom:4px">è¥ä¸šçŠ¶æ€</div><div style="font-size:24px;font-weight:700;color:var(--primary)" id="brothel-status">è¥ä¸šä¸­</div></div><div><div style="font-size:14px;color:var(--text-secondary);margin-bottom:4px">ä»Šæ—¥æ”¶å…¥</div><div style="font-size:24px;font-weight:700;color:var(--accent-gold)" id="brothel-income">0</div></div><button class="btn" onclick="toggleBrothelStatus()" id="btn-toggle-status">æš‚åœè¥ä¸š</button></div><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h2 class="section-title" style="margin:0">æˆ¿é—´ç®¡ç†</h2><div style="display:flex;gap:8px"><button class="btn btn-secondary" onclick="showBatchAssignment()" style="padding:8px 16px;font-size:14px">ğŸ“‹ æ‰¹é‡åˆ†é…</button> <button class="btn btn-secondary" onclick="showRoomShop()" style="padding:8px 16px;font-size:14px">ğŸ—ï¸ è´­ä¹°æˆ¿é—´</button></div></div><div id="room-list" class="room-grid"></div><div id="batch-assignment-panel" style="display:none;margin-top:24px;padding:20px;background:rgba(15,23,42,.8);border-radius:12px;border:2px solid var(--primary)"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="font-size:18px;color:var(--primary);margin:0">ğŸ“‹ å¾…å¤„ç†åˆ†é…</h3><div style="display:flex;gap:8px"><button class="btn btn-secondary" onclick="clearBatchAssignments()" style="padding:8px 16px;font-size:12px">æ¸…ç©º</button> <button class="btn" onclick="confirmBatchAssignments()" style="padding:8px 24px;font-size:14px;font-weight:600">âœ… ç¡®å®šå¹¶è¿›å…¥ä¸‹ä¸€å›åˆ</button></div></div><div id="batch-assignment-list" style="max-height:300px;overflow-y:auto"></div></div><h2 class="section-title">ç©ºé—²è§’è‰²</h2><div id="available-characters" class="character-grid"></div><h2 class="section-title">å½“å‰äº’åŠ¨å‰§æƒ…</h2><div id="brothel-story" class="story-container"><div id="brothel-story-content" class="story-content"><div class="story-placeholder">ç‚¹å‡»æˆ¿é—´æˆ–è§’è‰²å¼€å§‹äº’åŠ¨ï¼ŒAI ç”Ÿæˆçš„å‰§æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div></div></div><h2 class="section-title">äº‹ä»¶æ—¥å¿—</h2><div id="brothel-logs" class="log-container"></div></div></div><div id="page-more" class="page"><div><h1 class="page-title">âš™ï¸ æ›´å¤šåŠŸèƒ½</h1><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px"><div class="card" style="cursor:pointer;text-align:center" onclick="openSynthesis()"><div style="font-size:48px;margin-bottom:16px">ğŸ”¬</div><h3 style="font-size:20px;color:var(--primary);margin-bottom:8px">è§’è‰²åˆæˆ</h3><p style="font-size:14px;color:var(--text-secondary)">åˆæˆè§’è‰²æå‡ç¨€æœ‰åº¦</p></div><div class="card" style="cursor:pointer;text-align:center" onclick="openDecompose()"><div style="font-size:48px;margin-bottom:16px">âš¡</div><h3 style="font-size:20px;color:var(--primary);margin-bottom:8px">è§’è‰²åˆ†è§£</h3><p style="font-size:14px;color:var(--text-secondary)">åˆ†è§£è§’è‰²è·å¾—èµ„æº</p></div><div class="card" style="cursor:pointer;text-align:center" onclick="openSettings()"><div style="font-size:48px;margin-bottom:16px">âš™ï¸</div><h3 style="font-size:20px;color:var(--primary);margin-bottom:8px">æ¸¸æˆè®¾ç½®</h3><p style="font-size:14px;color:var(--text-secondary)">è°ƒæ•´æ¸¸æˆå‚æ•°</p></div><div class="card" style="cursor:pointer;text-align:center" onclick="openGallery()"><div style="font-size:48px;margin-bottom:16px">ğŸ“š</div><h3 style="font-size:20px;color:var(--primary);margin-bottom:8px">è§’è‰²å›¾é‰´</h3><p style="font-size:14px;color:var(--text-secondary)">æŸ¥çœ‹æ‰€æœ‰è§’è‰²</p></div></div></div></div></div><div class="bottom-nav"><div class="nav-item active" onclick='switchPage("home")'><div class="icon">ğŸ </div><div class="label">é¦–é¡µ</div></div><div class="nav-item" onclick='switchPage("summon")'><div class="icon">ğŸ´</div><div class="label">æŠ½å¡</div></div><div class="nav-item" onclick='switchPage("units")'><div class="icon">ğŸ‘¥</div><div class="label">è§’è‰²</div></div><div class="nav-item" onclick='switchPage("brothel")'><div class="icon">ğŸ›ï¸</div><div class="label">ç»è¥</div></div><div class="nav-item" onclick='switchPage("more")'><div class="icon">âš™ï¸</div><div class="label">æ›´å¤š</div></div></div><script>let gameState={"è´§å¸":5e3,"è§’è‰²ä»“åº“":{},"å¦“é™¢":{"å½“å‰æ¥å®¢è§’è‰²":{},"å½“å‰è°ƒæ•™è§’è‰²":{},"è¥ä¸šçŠ¶æ€":"è¥ä¸šä¸­","æˆ¿é—´çŠ¶æ€":{101:{"ç±»å‹":"æ™®é€š","çŠ¶æ€":"ç©ºé—²","è£…é¥°ä¸»é¢˜":"æ ‡å‡†","ç­‰çº§":1,"æ”¶å…¥å€ç‡":1,"è§£é”":!0},102:{"ç±»å‹":"æ™®é€š","çŠ¶æ€":"ç©ºé—²","è£…é¥°ä¸»é¢˜":"æ ‡å‡†","ç­‰çº§":1,"æ”¶å…¥å€ç‡":1,"è§£é”":!0},VIP1:{"ç±»å‹":"VIP","çŠ¶æ€":"ç©ºé—²","è£…é¥°ä¸»é¢˜":"è±ªå","ç­‰çº§":1,"æ”¶å…¥å€ç‡":1.5,"è§£é”":!0}},"ä»Šæ—¥æ”¶å…¥":0,"å†å²æ€»æ”¶å…¥":0,"äº‹ä»¶æ—¥å¿—":[]},"å¡æ± ":{"é™å®š":{"è¯æ¡":["â€”","â€”"],"å‘¨æœŸ":-1}},"è®¾ç½®":{"è‡ªåŠ¨è¥ä¸š":!1,"æ”¶ç›Šå€ç‡":1,"ç»éªŒå€ç‡":1,"æœ€å¤§è§’è‰²æ•°é‡":100,"è‡ªåŠ¨é…å›¾":!0},"ç»Ÿè®¡æ•°æ®":{"æ€»æŠ½å¡æ¬¡æ•°":0,"æ€»è·å¾—è§’è‰²":0,"æ€»æ¥å®¢æ¬¡æ•°":0,"æ€»æ”¶å…¥":0,"æ¸¸æˆæ—¶é—´":0,"è§’è‰²åˆ†å¸ƒ":{N:0,R:0,SR:0,SSR:0},"æƒ…æ„Ÿåˆ†å¸ƒ":{"çˆ±":0,"å–œæ¬¢":0,"ä¸­ç«‹":0,"åŒæ¶":0,"æ†æ¨":0}},"æ¸¸æˆæ—¶é—´":{"å½“å‰å›åˆ":1,"å½“å‰æ—¶æ®µ":"æ—©ä¸Š","å¤©æ•°":1},"å¾…å¤„ç†åˆ†é…":[]};function switchPage(e){document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active")});const t=document.getElementById(`page-${e}`);t&&t.classList.add("active"),document.querySelectorAll(".nav-item").forEach((e,t)=>{e.classList.remove("active")});const n={home:0,summon:1,units:2,brothel:3,more:4},a=document.querySelectorAll(".nav-item");void 0!==n[e]&&a[n[e]]&&a[n[e]].classList.add("active"),refreshPageData(e)}function refreshPageData(e){switch(updateLimitedPoolIfNeeded(),normalizeAllCharacters(),refreshHomePage(),e){case"home":break;case"summon":refreshSummonPage();break;case"units":refreshUnitsPage();break;case"brothel":refreshBrothelPage()}}function refreshHomePage(){document.getElementById("home-currency").textContent=gameState.è´§å¸,document.getElementById("home-characters").textContent=Object.keys(gameState.è§’è‰²ä»“åº“).length,document.getElementById("home-income").textContent=gameState.å¦“é™¢.ä»Šæ—¥æ”¶å…¥;const e=getGameTime(),t=`ç¬¬${e.å¤©æ•°||1}å¤© ${e.å½“å‰æ—¶æ®µ||"æ—©ä¸Š"}`,n=`å›åˆ: ${e.å½“å‰å›åˆ||1}`;document.getElementById("home-time").textContent=t,document.getElementById("home-round").textContent=n;const a=document.getElementById("topbar-currency");a&&(a.textContent=String(gameState.è´§å¸??0));const o=document.getElementById("topbar-time");o&&(o.textContent=t);const i=document.getElementById("topbar-round");i&&(i.textContent=`Â· å›åˆ ${e.å½“å‰å›åˆ||1}`)}function refreshSummonPage(){document.getElementById("summon-currency").textContent=gameState.è´§å¸;const e=updateLimitedPoolIfNeeded(),t=document.getElementById("limited-tags"),n=document.getElementById("limited-refresh");if(t&&(t.innerHTML=(e?.è¯æ¡||["â€”","â€”"]).map(e=>`\n                    <span style="\n                      display: inline-flex;\n                      align-items: center;\n                      padding: 8px 12px;\n                      border-radius: 999px;\n                      border: 1px solid rgba(255,255,255,0.14);\n                      background: rgba(255,255,255,0.06);\n                      color: var(--text-primary);\n                      font-family: var(--font-serif);\n                      font-weight: 700;\n                      letter-spacing: 0.04em;\n                    ">${e}</span>\n                  `).join("")),n){const e=getGameTime().å¤©æ•°||1,t=3-(e-1)%3;n.textContent=`ç¬¬${e}å¤© Â· è·ç¦»ä¸‹æ¬¡åˆ·æ–°è¿˜æœ‰ ${t} å¤©ï¼ˆç¬¬${e+t}å¤©åˆ·æ–°ï¼‰`}const a={"å•æŠ½":250,"é™å®šå¡æ± ":250,"é—ªå…‰æŠ½å¡":3e3,"å®šå‘æŠ½å¡":1500};Object.keys(a).forEach(e=>{let t;t="å•æŠ½"===e?"single":"é—ªå…‰æŠ½å¡"===e?"flash":"é™å®šå¡æ± "===e?"limited":"target";const n=document.getElementById(`btn-${t}`);n&&(n.disabled=gameState.è´§å¸<a[e])})}function refreshUnitsPage(){const e=document.getElementById("character-list");if(e)try{const t=e.scrollTop;e.innerHTML="";const n=(document.getElementById("search-input")?.value||"").toLowerCase(),a=document.getElementById("filter-rarity")?.value||"";if(!gameState.è§’è‰²ä»“åº“||"object"!=typeof gameState.è§’è‰²ä»“åº“)return console.warn("è§’è‰²ä»“åº“ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯:",gameState.è§’è‰²ä»“åº“),void(e.innerHTML='<div style="text-align: center; padding: 40px; color: var(--text-secondary)">æš‚æ— è§’è‰²</div>');const o=Object.entries(gameState.è§’è‰²ä»“åº“);if(console.info(`åˆ·æ–°è§’è‰²ä»“åº“ï¼Œå…± ${o.length} ä¸ªè§’è‰²`),0===o.length)return void(e.innerHTML='<div style="text-align: center; padding: 40px; color: var(--text-secondary)">æš‚æ— è§’è‰²ï¼Œå»æŠ½å¡å§ï¼</div>');o.forEach(([t,o])=>{try{if(!o||"object"!=typeof o)return void console.warn(`è§’è‰² ${t} æ•°æ®æ ¼å¼é”™è¯¯:`,o);if(n&&(!o.å§“å||!o.å§“å.toLowerCase().includes(n)))return;if(a&&o.ç¨€æœ‰åº¦!==a)return;o.ç»˜å›¾æ ‡ç­¾&&console.info(`è§’è‰² ${o.å§“å} çš„ç»˜å›¾æ ‡ç­¾:`,o.ç»˜å›¾æ ‡ç­¾.substring(0,100));const i=createCharacterCard(t,o);i?e.appendChild(i):console.error(`åˆ›å»ºè§’è‰²å¡ç‰‡å¤±è´¥: ${t}`)}catch(e){console.error(`å¤„ç†è§’è‰² ${t} æ—¶å‡ºé”™:`,e)}}),e.scrollTop=t}catch(t){console.error("åˆ·æ–°è§’è‰²ä»“åº“é¡µé¢å¤±è´¥:",t),e.innerHTML='<div style="text-align: center; padding: 40px; color: var(--danger)">åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</div>'}else console.error("è§’è‰²åˆ—è¡¨å®¹å™¨ä¸å­˜åœ¨")}function refreshBrothelPage(){if(!document.getElementById("brothel-status"))return;gameState.å¦“é™¢||(gameState.å¦“é™¢={}),gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€||(gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€="è¥ä¸šä¸­"),document.getElementById("brothel-status").textContent=gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€,document.getElementById("brothel-income").textContent=gameState.å¦“é™¢.ä»Šæ—¥æ”¶å…¥,document.getElementById("btn-toggle-status").textContent="è¥ä¸šä¸­"===gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€?"æš‚åœè¥ä¸š":"å¼€å§‹è¥ä¸š";const e=document.getElementById("room-list");e&&(e.innerHTML="",Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).forEach(([t,n])=>{const a=createRoomCard(t,n);e.appendChild(a)}));const t=document.getElementById("available-characters");t&&(t.innerHTML="",Object.entries(gameState.è§’è‰²ä»“åº“).forEach(([e,n])=>{if("ç©ºé—²"===n.çŠ¶æ€&&"ä»“åº“"===n.å½“å‰ä½ç½®){const a=createCharacterCard(e,n,!0);t.appendChild(a)}}));const n=document.getElementById("brothel-logs");n&&(n.innerHTML="",gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—.slice(-20).reverse().forEach(e=>{const t=document.createElement("div");t.className="log-entry";const a="number"==typeof e.æ—¶é—´æˆ³&&e.æ—¶é—´æˆ³<1e12?`ç¬¬${e.æ—¶é—´æˆ³}å›åˆ`:new Date(e.æ—¶é—´æˆ³).toLocaleString();t.innerHTML=`\n                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">${a}</div>\n                  <div><strong>${e.è§’è‰²ID}</strong>: ${e.æè¿°}</div>\n                  ${e.æ”¶å…¥å˜åŒ–>0?`<div style="color: var(--accent-gold); margin-top: 4px">+${e.æ”¶å…¥å˜åŒ–} é‡‘</div>`:""}\n                `,n.appendChild(t)}))}function cleanJsonString(e){if(!e)return e;let t=e.replace(/```json\s*/gi,"");if(t=t.replace(/```\s*/g,""),t=t.trim(),!t.startsWith("[")&&!t.startsWith("{")){const e=Math.min(t.indexOf("[")>=0?t.indexOf("["):1/0,t.indexOf("{")>=0?t.indexOf("{"):1/0);e!==1/0&&(t=t.substring(e))}if(t.endsWith("]")||t.endsWith("}"))return t;const n=Math.max(t.lastIndexOf("]"),t.lastIndexOf("}"));return n>=0&&(t=t.substring(0,n+1)),t}function renderImageTag(e,t){if(!e||!t)return console.warn("renderImageTag: å›¾ç‰‡æ ‡ç­¾æˆ–å®¹å™¨ä¸ºç©º"),!1;let n=String(e);n.includes("image###")&&!/image###([\s\S]*?)###/.test(n)&&(n=n.trim(),n.endsWith("###")||(n+="###"));const a=n.match(/image###([\s\S]*?)###/);if(!a)return console.warn("å›¾ç‰‡æ ‡ç­¾æ ¼å¼ä¸æ­£ç¡®:",n.substring(0,120)),!1;const o=(a[1]||"").trim();console.info("renderImageTag: æç¤ºè¯ç‰‡æ®µ:",o.substring(0,80));try{if("undefined"!=typeof formatAsDisplayedMessage){const e=formatAsDisplayedMessage(n);return t.parentElement?("undefined"!=typeof $&&$(t).length?$(t).html(e):t.innerHTML=e,setTimeout(()=>{t.querySelectorAll("img").forEach(e=>{e.style.width="100%",e.style.height="auto",e.style.maxHeight="420px",e.style.objectFit="contain",e.style.display="block",e.style.borderRadius="10px",e.style.margin="0 auto"})},0),!0):(console.warn("å›¾ç‰‡å®¹å™¨ä¸åœ¨DOMä¸­ï¼Œè·³è¿‡æ¸²æŸ“"),!1)}}catch(e){console.error("renderImageTag: æ¸²æŸ“å¤±è´¥ï¼Œå°†å›é€€ä¸ºå¤åˆ¶æç¤ºè¯:",e)}return t.parentElement&&(t.innerHTML=`\n            <div class="image-placeholder" onclick='event.stopPropagation(); copyImagePrompt(${JSON.stringify(o)})'>\n              <div style="font-size: 32px; margin-bottom: 8px">ğŸ–¼ï¸</div>\n              <div style="font-size: 12px; text-align: center; padding: 0 8px">ç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤</div>\n            </div>\n          `),!1}function createCharacterCard(e,t,n=!1){const a=document.createElement("div");a.className=`character-list-item rarity-${t.ç¨€æœ‰åº¦}`;const o=document.createElement("div");o.className="character-list-info";const i=["é­…åŠ›","é¡ºä»","æŠ€å·§","è€åŠ›","æ•æ„Ÿåº¦"].map(e=>{const n=t.å±æ€§?.[e]||0;return`\n                    <div class="character-list-stat-item">\n                      <span>${e}:</span>\n                      <div class="character-list-stat-bar">\n                        <div class="character-list-stat-fill" style="width: ${n}%"></div>\n                      </div>\n                      <span>${n}</span>\n                    </div>\n                  `}).join("");o.innerHTML=`\n                <div class="character-list-name">${t.å§“å||"æœªçŸ¥"}</div>\n                <div class="character-list-meta">${t.ç¨€æœ‰åº¦} Â· ${t.èŒä¸šèº«ä»½||"æ— "} Â· ${t.çŠ¶æ€||"ç©ºé—²"} Â· Lv.${t.ç­‰çº§||1}</div>\n                <div class="character-list-stats">${i}</div>\n                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px; display: flex; gap: 12px">\n                  <span>æ¥å®¢: ${t.æ¥å®¢æ¬¡æ•°||0}æ¬¡</span>\n                  <span>è°ƒæ•™: ${t.è°ƒæ•™æ¬¡æ•°||0}æ¬¡</span>\n                  <span style="color: var(--accent-gold)">è´¡çŒ®: ${t.æ”¶å…¥è´¡çŒ®||0}é‡‘</span>\n                </div>\n              `;const r=document.createElement("div");return r.className="character-list-actions",r.innerHTML=n?`\n                  <button class="btn" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); selectCharacterForRoom('${e}')">åˆ†é…æˆ¿é—´</button>\n                `:`\n                  <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); showCharacterDetail('${e}')">æŸ¥çœ‹è¯¦æƒ…</button>\n                  <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); showTrainingInput('${e}')">è°ƒæ•™</button>\n                  <button class="btn" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); assignCharacterToBrothel('${e}')">æ¥å®¢</button>\n                `,a.appendChild(o),a.appendChild(r),a}const roomTypes={"æ™®é€š":{icon:"ğŸ ",color:"#94a3b8",baseIncome:1,description:"åŸºç¡€æˆ¿é—´ï¼Œé€‚åˆæ–°æ‰‹è§’è‰²",unlockCost:0,upgradeCost:e=>500*e},VIP:{icon:"ğŸ‘‘",color:"#fbbf24",baseIncome:1.5,description:"VIPä¸“ç”¨ï¼Œé«˜æ”¶å…¥ä½†éœ€è¦é«˜å±æ€§è§’è‰²",unlockCost:2e3,upgradeCost:e=>1e3*e},"è°ƒæ•™å®¤":{icon:"ğŸ”",color:"#ec4899",baseIncome:.8,description:"è°ƒæ•™ä¸“ç”¨ï¼Œæå‡è§’è‰²å±æ€§",unlockCost:1500,upgradeCost:e=>800*e},"å±•ç¤ºå®¤":{icon:"ğŸ­",color:"#8b5cf6",baseIncome:1.2,description:"å±•ç¤ºè§’è‰²é­…åŠ›ï¼Œå¸å¼•ç‰¹æ®Šå®¢æˆ·",unlockCost:3e3,upgradeCost:e=>1200*e},"æƒ…è¶£æˆ¿":{icon:"ğŸ’‹",color:"#f59e0b",baseIncome:1.8,description:"ç‰¹æ®ŠæœåŠ¡ï¼Œé«˜æ”¶å…¥ä½†æ¶ˆè€—è§’è‰²è€åŠ›",unlockCost:5e3,upgradeCost:e=>2e3*e},"ä¼‘æ¯å®¤":{icon:"ğŸ›ï¸",color:"#10b981",baseIncome:0,description:"æ¢å¤è§’è‰²çŠ¶æ€ï¼Œä¸äº§ç”Ÿæ”¶å…¥",unlockCost:1e3,upgradeCost:e=>500*e},"åŒ»ç–—å®¤":{icon:"ğŸ¥",color:"#ef4444",baseIncome:0,description:"æ²»ç–—å—ä¼¤è§’è‰²ï¼Œæ¢å¤è€åŠ›",unlockCost:2500,upgradeCost:e=>1e3*e}},decorationThemes={"æ ‡å‡†":{incomeBonus:0,cost:0,description:"åŸºç¡€è£…é¥°"},"è±ªå":{incomeBonus:.2,cost:1e3,description:"æå‡20%æ”¶å…¥"},"æµªæ¼«":{incomeBonus:.15,cost:800,description:"æå‡15%æ”¶å…¥ï¼Œå¢åŠ å®¢æˆ·æ»¡æ„åº¦"},"æš—é»‘":{incomeBonus:.25,cost:1500,description:"æå‡25%æ”¶å…¥ï¼Œé€‚åˆç‰¹æ®ŠæœåŠ¡"},"å’Œé£":{incomeBonus:.18,cost:1200,description:"æå‡18%æ”¶å…¥ï¼Œå¸å¼•ç‰¹å®šå®¢æˆ·"},"æœªæ¥":{incomeBonus:.3,cost:2e3,description:"æå‡30%æ”¶å…¥ï¼Œç§‘æŠ€æ„Ÿåè¶³"}},trainingPrograms=[{key:"å£èˆŒæœä¾åŸºç¡€",icon:"ğŸ‘…",desc:"å£äº¤ã€æ·±å–‰ã€èˆŒæŠ€è°ƒæ•™ã€‚æå‡æŠ€å·§ä¸é¡ºä»åº¦ã€‚",focus:{"æŠ€å·§":[3,8],"é¡ºä»":[2,6]},like:[1,4],hate:[0,2],staminaCost:[4,10]},{key:"BDSMæŸç¼šè°ƒæ•™",icon:"ğŸ”—",desc:"ç»³ç¼šã€é­æ‰“ã€èœ¡çƒ›ã€é’ˆåˆºç­‰é‡åº¦playã€‚æå¤§æå‡é¡ºä»ä¸æ•æ„Ÿåº¦ã€‚",focus:{"é¡ºä»":[4,10],"æ•æ„Ÿåº¦":[3,8]},like:[0,3],hate:[1,5],staminaCost:[8,18]},{key:"SMå¥³ç‹å…»æˆ",icon:"ğŸ‘‘",desc:"é­ç¬ã€è¸©è¸ã€è¨€è¯­ç¾è¾±ã€‚åŸ¹å…»æ”¯é…æ¬²ä¸æŠ€å·§ã€‚",focus:{"é­…åŠ›":[3,8],"æŠ€å·§":[2,6]},like:[1,3],hate:[1,4],staminaCost:[6,14]},{key:"å¼ºå¥¸æŠµæŠ—è®­ç»ƒ",icon:"âš”ï¸",desc:"æ¨¡æ‹Ÿå¼ºå¥¸åœºæ™¯ï¼Œé”»ç‚¼æŠ—å‹ä¸é€‚åº”èƒ½åŠ›ã€‚é«˜é£é™©é«˜æ”¶ç›Šã€‚",focus:{"è€åŠ›":[4,10],"æ•æ„Ÿåº¦":[2,7]},like:[0,1],hate:[3,8],staminaCost:[12,24]},{key:"ç¾¤äº¤è€ä¹…è€ƒéªŒ",icon:"ğŸ‘¥",desc:"å¤šäººè½®ç•ªplayï¼Œæµ‹è¯•æé™è€å—ã€‚æåº¦æ¶ˆè€—ä½“åŠ›ä½†å±æ€§æå‡å·¨å¤§ã€‚",focus:{"è€åŠ›":[3,9],"æŠ€å·§":[3,8]},like:[0,2],hate:[2,6],staminaCost:[15,30]},{key:"æ€§ç©å…·å¼€å‘",icon:"ğŸ§¸",desc:"æŒ¯åŠ¨æ£’ã€è‚›å¡ã€æ‰©å¼ å™¨ç­‰é“å…·è°ƒæ•™ã€‚é‡ç‚¹æå‡æ•æ„Ÿåº¦ã€‚",focus:{"æ•æ„Ÿåº¦":[4,10],"é¡ºä»":[1,5]},like:[1,4],hate:[0,2],staminaCost:[5,12]},{key:"å°¿é“playè°ƒæ•™",icon:"ğŸ’§",desc:"å°¿é“æ‰©å¼ ã€çŒå°¿ã€å°¿å°¿playç­‰å°ä¼—æ€§ç™–å¼€å‘ã€‚",focus:{"æ•æ„Ÿåº¦":[5,12],"è€åŠ›":[1,4]},like:[0,1],hate:[2,5],staminaCost:[8,16]},{key:"å…½äº¤æ¨¡æ‹Ÿ",icon:"ğŸ•",desc:"æ¨¡æ‹Ÿå…½äº¤å§¿åŠ¿ã€çŠ¬ç±»playã€åŠ¨ç‰©è§’è‰²æ‰®æ¼”ã€‚",focus:{"æŠ€å·§":[2,6],"é¡ºä»":[3,8]},like:[1,3],hate:[1,4],staminaCost:[7,15]},{key:"è§¦æ‰‹play",icon:"ğŸ¦‘",desc:"è§¦æ‰‹æ’å…¥ã€ç¼ ç»•ã€å¸å®ç­‰å¹»æƒ³playã€‚",focus:{"æ•æ„Ÿåº¦":[3,9],"è€åŠ›":[2,6]},like:[1,4],hate:[0,2],staminaCost:[6,14]},{key:"å­•å¦‡play",icon:"ğŸ¤°",desc:"å­•å¦‡è£…æ‰®ã€ä¹³æ±playã€æ¯æ€§è°ƒæ•™ã€‚",focus:{"é­…åŠ›":[2,6],"æ•æ„Ÿåº¦":[2,6]},like:[1,3],hate:[0,2],staminaCost:[5,12]},{key:"æš´åŠ›å¼ºå¥¸è®­ç»ƒ",icon:"ğŸ”ª",desc:"æš´åŠ›å¼ºå¥¸ã€æ®´æ‰“ã€æ’•è£‚ç­‰è¿‡æ¿€playã€‚æé«˜é£é™©ã€‚",focus:{"è€åŠ›":[5,12],"é¡ºä»":[3,9]},like:[0,1],hate:[5,12],staminaCost:[18,36]},{key:"è¡€è…¥Guroè°ƒæ•™",icon:"ğŸ©¸",desc:"å‡ºè¡€playã€åˆ‡å‰²ã€è‚¢ä½“ä¼¤å®³ç­‰è¡€è…¥è°ƒæ•™ã€‚",focus:{"æ•æ„Ÿåº¦":[4,12],"è€åŠ›":[2,8]},like:[0,1],hate:[4,10],staminaCost:[12,25]},{key:"è™«åµplay",icon:"ğŸ¥š",desc:"è™«åµæ³¨å…¥ã€äº§åµã€è™«åµå­µåŒ–ç­‰è™«åµplayï¼ˆä¸æ¶‰åŠæ´»ä½“æ˜†è™«ï¼‰ã€‚",focus:{"æ•æ„Ÿåº¦":[5,12],"é¡ºä»":[2,7]},like:[0,1],hate:[2,7],staminaCost:[8,18]},{key:"è‡ªå®šä¹‰è°ƒæ•™",icon:"ğŸ­",desc:"è‡ªå®šä¹‰playå†…å®¹ï¼Œç”±ç”¨æˆ·è¾“å…¥å…·ä½“è°ƒæ•™æ–¹å¼ã€‚",focus:{"é¡ºä»":[1,5],"æŠ€å·§":[1,5],"æ•æ„Ÿåº¦":[1,5]},like:[0,3],hate:[0,3],staminaCost:[5,15],custom:!0}];function createRoomCard(e,t){const n=document.createElement("div");n.className="room-card "+("ç©ºé—²"!==t.çŠ¶æ€?"occupied":"");const a=roomTypes[t.ç±»å‹]||roomTypes.æ™®é€š,o=decorationThemes[t.è£…é¥°ä¸»é¢˜]||decorationThemes.æ ‡å‡†,i=t.å½“å‰è§’è‰²?gameState.è§’è‰²ä»“åº“[t.å½“å‰è§’è‰²]:null,r=t.å½“å‰è§’è‰²?gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[t.å½“å‰è§’è‰²]:null,s=t.å½“å‰è§’è‰²?gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[t.å½“å‰è§’è‰²]:null,l=(t.æ”¶å…¥å€ç‡||1)*(1+o.incomeBonus),c=getGameTime().å½“å‰å›åˆ||1,d=s?Math.max(0,(s.é¢„è®¡ç»“æŸå›åˆ||c)-c):0;return n.innerHTML=`\n              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px">\n                <div style="font-size: 32px">${a.icon}</div>\n                <div style="flex: 1">\n                  <div style="font-size: 18px; font-weight: bold; color: ${a.color}">æˆ¿é—´ ${e}</div>\n                  <div style="font-size: 12px; color: var(--text-secondary)">${a.description}</div>\n                </div>\n              </div>\n\n              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; font-size: 12px">\n                <div style="padding: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 8px">\n                  <div style="color: var(--text-secondary); margin-bottom: 4px">ç±»å‹</div>\n                  <div style="color: ${a.color}; font-weight: 600">${t.ç±»å‹}</div>\n                </div>\n                <div style="padding: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 8px">\n                  <div style="color: var(--text-secondary); margin-bottom: 4px">ç­‰çº§</div>\n                  <div style="color: var(--accent-gold); font-weight: 600">Lv.${t.ç­‰çº§||1}</div>\n                </div>\n                <div style="padding: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 8px">\n                  <div style="color: var(--text-secondary); margin-bottom: 4px">çŠ¶æ€</div>\n                  <div style="color: ${"ç©ºé—²"===t.çŠ¶æ€?"var(--success)":"var(--primary)"}; font-weight: 600">${t.çŠ¶æ€}</div>\n                </div>\n                <div style="padding: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 8px">\n                  <div style="color: var(--text-secondary); margin-bottom: 4px">æ”¶å…¥å€ç‡</div>\n                  <div style="color: var(--accent-gold); font-weight: 600">${(100*l).toFixed(0)}%</div>\n                </div>\n              </div>\n\n              <div style="padding: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 8px; margin-bottom: 12px; font-size: 12px">\n                <div style="color: var(--text-secondary); margin-bottom: 4px">è£…é¥°ä¸»é¢˜</div>\n                <div style="color: var(--primary); font-weight: 600">${t.è£…é¥°ä¸»é¢˜} ${o.incomeBonus>0?`(+${(100*o.incomeBonus).toFixed(0)}%)`:""}</div>\n              </div>\n\n              ${i?`\n                <div style="padding: 8px; background: rgba(139, 92, 246, 0.2); border-radius: 8px; margin-bottom: 12px">\n                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">å½“å‰è§’è‰²</div>\n                  <div style="font-size: 14px; color: var(--primary); font-weight: 600">${i.å§“å}</div>\n                  ${"è°ƒæ•™å®¤"===t.ç±»å‹&&s?`<div style="font-size: 11px; color: var(--accent-gold); margin-top: 4px">è¯¾ç¨‹: ${s.è¯¾ç¨‹} Â· å‰©ä½™: ${d} å›åˆ</div>`:r?`<div style="font-size: 11px; color: var(--accent-gold); margin-top: 4px">é¢„è®¡æ”¶å…¥: ${Math.floor((r.åŸºç¡€æ”¶å…¥+r.é¢å¤–æ”¶å…¥)*l)} é‡‘</div>`:""}\n                </div>\n              `:""}\n\n              <div style="display: flex; gap: 8px; flex-wrap: wrap">\n                ${"è°ƒæ•™å®¤"===t.ç±»å‹?"ç©ºé—²"===t.çŠ¶æ€?`\n                  <button class="btn" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); openTrainingAssignment('${e}')">å¼€å§‹è¯¾ç¨‹</button>\n                  <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); showRoomManagement('${e}')">ç®¡ç†</button>\n                `:`\n                  <button class="btn" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); showTrainingRoomDetail('${e}')">æŸ¥çœ‹è¯¾ç¨‹</button>\n                  <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); stopTrainingInRoom('${e}')">ç»ˆæ­¢è®­ç»ƒ</button>\n                `:"ç©ºé—²"===t.çŠ¶æ€?`\n                  <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); showRoomAssignment('${e}')">åˆ†é…è§’è‰²</button>\n                  <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); addToBatchAssignment('${e}', null)">åŠ å…¥é˜Ÿåˆ—</button>\n                  <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); showRoomManagement('${e}')">ç®¡ç†</button>\n                `:`\n                  <button class="btn" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); showRoomDetail('${e}')">æŸ¥çœ‹å‰§æƒ…</button>\n                  <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); addToBatchAssignment('${e}', 'remove')">ç§»å‡ºé˜Ÿåˆ—</button>\n                  <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); addToBatchAssignment('${e}', 'swap')">æ¢äºº</button>\n                  <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); cancelCharacterFromRoom('${e}')">å–æ¶ˆæ¥å®¢</button>\n                `}\n              </div>\n            `,n.style.borderColor=a.color,n.style.borderWidth="2px",n}let pendingSummonCost=0;function showTargetSummonInput(){const e=document.createElement("div");e.className="modal",e.id="target-summon-modal",e.innerHTML='\n                <div class="modal-content" style="max-width: 600px">\n                  <button class="modal-close" onclick="closeTargetSummonInput()">Ã—</button>\n                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">ğŸ¯ å®šå‘æŠ½å¡</h2>\n\n                  <div style="margin-bottom: 16px; padding: 16px; background: rgba(30, 41, 59, 0.6); border-radius: 12px">\n                    <p style="font-size: 14px; color: var(--text-secondary); line-height: 1.8">\n                      æè¿°ä½ æƒ³è¦çš„è§’è‰²ç‰¹å¾ï¼Œä¾‹å¦‚ï¼š<br>\n                      â€¢ æ€§åˆ«ã€ç§æ—ã€èŒä¸šå€¾å‘<br>\n                      â€¢ æ€§æ ¼ç‰¹ç‚¹ã€å¤–è²Œç‰¹å¾<br>\n                      â€¢ ç‰¹æ®Šèƒ½åŠ›æˆ–èƒŒæ™¯è®¾å®š<br>\n                      â€¢ ä»»ä½•å…¶ä»–è¦æ±‚\n                    </p>\n                  </div>\n\n                  <div style="margin-bottom: 16px">\n                    <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 8px">è§’è‰²è¦æ±‚ï¼š</label>\n                    <textarea\n                      id="target-summon-input"\n                      placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³è¦ä¸€ä¸ªæ¸©æŸ”ä½“è´´çš„å¥³æ€§è§’è‰²ï¼ŒèŒä¸šæ˜¯åŒ»ç”Ÿæˆ–æŠ¤å£«ï¼Œæœ‰ç€æ²»æ„ˆç³»çš„å¤–è²Œå’Œæ€§æ ¼..."\n                      style="\n                        width: 100%;\n                        min-height: 150px;\n                        padding: 12px;\n                        background: rgba(15, 23, 42, 0.6);\n                        border: 1px solid rgba(139, 92, 246, 0.3);\n                        border-radius: 12px;\n                        color: var(--text-primary);\n                        font-size: 14px;\n                        resize: vertical;\n                        font-family: inherit;\n                      "\n                    ></textarea>\n                  </div>\n\n                  <div style="display: flex; gap: 12px; justify-content: flex-end">\n                    <button class="btn btn-secondary" onclick="closeTargetSummonInput()">å–æ¶ˆ</button>\n                    <button class="btn" onclick="confirmTargetSummon()">å¼€å§‹æŠ½å¡ (1500 é‡‘)</button>\n                  </div>\n                </div>\n              ',document.body.appendChild(e),e.classList.add("active"),setTimeout(()=>{const e=document.getElementById("target-summon-input");e&&e.focus()},100)}function closeTargetSummonInput(){const e=document.getElementById("target-summon-modal");e&&(e.classList.remove("active"),setTimeout(()=>e.remove(),300))}async function confirmTargetSummon(){const e=document.getElementById("target-summon-input"),t=e?e.value.trim():"";closeTargetSummonInput(),t?gameState.è´§å¸<1500?alert("è´§å¸ä¸è¶³ï¼éœ€è¦1500é‡‘ã€‚"):await handleSummon("å®šå‘æŠ½å¡",t):alert("è¯·è¾“å…¥è§’è‰²è¦æ±‚ï¼")}function generateRarity(e){if("é—ªå…‰æŠ½å¡"===e)return"SSR";let t;if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(1);crypto.getRandomValues(e),t=e[0]/4294967296}else t=Math.random();return t<.5?"N":t<.8?"R":t<.95?"SR":"SSR"}function normalizeGenderLabel(e){const t=String(e||"").trim();return t?/(åŒæ€§|ä¸¤æ€§|æ‰¶å¥¹)/.test(t)?"åŒæ€§ç”·æ€§":/ç”·/.test(t)?"ç”·æ€§":/å¥³/.test(t)?"å¥³æ€§":"":""}function detectGenderInText(e){const t=String(e||"");if(!t.trim())return"";const n=t.match(/(?:^|[\sï¼Œ,;ï¼›\n])(?:æ€§åˆ«|gender)\s*[:ï¼š]?\s*(åŒæ€§ç”·æ€§|åŒæ€§|ä¸¤æ€§|æ‰¶å¥¹(?:ç”·)?|ç”·æ€§|ç”·|å¥³æ€§|å¥³)(?:$|[\sï¼Œ,;ï¼›\n])/i);return n?.[1]?normalizeGenderLabel(n[1]):/(åŒæ€§ç”·æ€§|åŒæ€§|ä¸¤æ€§|æ‰¶å¥¹)/.test(t)?"åŒæ€§ç”·æ€§":/(ç”·è§’è‰²|ç”·æ€§è§’è‰²|ç”·å­©å­|ç”·ç”Ÿ|å°‘å¹´|é’å¹´|ç‹å­|å°‘çˆ·|å…¬å­)/.test(t)?"ç”·æ€§":/(å¥³è§’è‰²|å¥³æ€§è§’è‰²|å¥³å­©å­|å¥³ç”Ÿ|å°‘å¥³|å…¬ä¸»|å°å§|å¤«äºº)/.test(t)?"å¥³æ€§":""}function countRosterGenders(){const e={"ç”·æ€§":0,"å¥³æ€§":0,"åŒæ€§ç”·æ€§":0};return(gameState.è§’è‰²ä»“åº“&&"object"==typeof gameState.è§’è‰²ä»“åº“?Object.values(gameState.è§’è‰²ä»“åº“):[]).forEach(t=>{const n=normalizeGenderLabel(t?.æ€§åˆ«);n&&void 0!==e[n]&&(e[n]+=1)}),e}function pickBalancedGender(e=""){const t=detectGenderInText(e);if(t)return t;const{"ç”·æ€§":n,"å¥³æ€§":a,"åŒæ€§ç”·æ€§":o}=countRosterGenders(),i=n+a+o;let r=1,s=1,l=.18;if(i>=6){(i?n/i:0)<.4&&(r+=2.2),(i?a/i:0)<.4&&(s+=2.2),(i?o/i:0)<.08&&(l+=.25)}return pickWeighted([["ç”·æ€§",r],["å¥³æ€§",s],["åŒæ€§ç”·æ€§",l]])}async function handleSummon(e,t=""){const n={"å•æŠ½":250,"é™å®šå¡æ± ":250,"é—ªå…‰æŠ½å¡":3e3,"å®šå‘æŠ½å¡":1500}[e]||250;if(gameState.è´§å¸<n)return void alert("è´§å¸ä¸è¶³ï¼");pendingSummonCost=n;const a=document.getElementById("summon-results"),o=document.getElementById("character-card-display");a.innerHTML='<div class="story-loading">â³ æ­£åœ¨å¬å”¤ï¼Œè¯·ç¨å€™...</div>',o&&(o.style.display="none",o.innerHTML="");const i=generateRarity(e),r=pickBalancedGender(t);let s="";if("é™å®šå¡æ± "===e){const e=updateLimitedPoolIfNeeded();s=`æ‰§è¡Œé™å®šå¡æ± æŠ½å¡ã€‚\n\næœ¬æœŸé™å®šè¯æ¡ï¼ˆä¸‡ç‰©çµæ„Ÿç§å­ï¼‰ï¼š\n- ${e?.è¯æ¡?.[0]||"â€”"}\n- ${e?.è¯æ¡?.[1]||"â€”"}\n\nã€è¯æ¡ä½¿ç”¨è§„åˆ™ï¼šèªæ˜åœ°â€œè§’è‰²åŒ–è½åœ°â€ã€‘ã€é‡è¦ã€‘\n- è¿™ä¸¤æ¡è¯æ¡æ˜¯â€œçµæ„Ÿç§å­â€ï¼Œå…è®¸éšå–»/è±¡å¾/æè´¨/é…è‰²/çº¹æ ·/é“å…·åŒ–è½¬è¯‘ï¼›ä¸è¦å­—é¢ç¡¬å¥—å¯¼è‡´æŠ½è±¡ã€ä¸‘æ€ªã€çŒå¥‡ã€‚\n- ä½ å¿…é¡»è®©æ¯æ¡è¯æ¡è‡³å°‘è½åˆ° 2 å¤„å¯ç”»è¦ç´ ï¼ˆä¾‹å¦‚ï¼šé…è‰²/æè´¨/çº¹æ ·/é¥°å“/é“å…·/ç¯å¢ƒ/å£ç™–/èƒŒæ™¯æ„è±¡/èƒ½åŠ›è®¾å®šï¼‰ã€‚\n- å®¡ç¾ä¼˜å…ˆï¼šè§’è‰²å¿…é¡»ç¾å‹ã€è¡€è‚‰ã€æœ‰ä½“æ¸©ï¼›è‹¥è¯æ¡å«â€œæœºæ¢°/æ€ªç‰©/éäººâ€å€¾å‘ï¼Œåªèƒ½ä½œä¸ºé£æ ¼ç¬¦å·æˆ–é“å…·æ„è±¡ï¼Œç»ä¸èƒ½å˜æˆæœºå™¨äºº/æ€ªç‰©èº¯ä½“ã€‚\n- å£å‘³é™åˆ¶ï¼šä¸€èˆ¬ä¸å‡ºç°è¿‡äºæ¶å¿ƒçŒå¥‡çš„å†…å®¹ï¼›æœ€æ¶å¿ƒä¸Šé™åªåˆ°ã€å°¿æ¶²/å­•è‚šã€‘ã€‚ç¦æ­¢ç²ªä¾¿/æœˆç»/è…çƒ‚/è™«/å°¸/è¡€è…¥è‚¢è§£ç­‰ã€‚\n- å…¨æ€§å‘ï¼šä¸è¦æ€»æ˜¯å¥³æ€§ã€‚æœ¬æ¬¡è§’è‰²æ€§åˆ«å¿…é¡»ä¸ºã€${r}ã€‘ã€‚\n\n`}else s="å®šå‘æŠ½å¡"===e&&t?`æ‰§è¡Œå®šå‘æŠ½å¡ã€‚æ ¹æ®ä»¥ä¸‹è¦æ±‚ç”Ÿæˆè§’è‰²ï¼š\n\n${t}\n\næœ¬æ¬¡è§’è‰²æ€§åˆ«å¿…é¡»ä¸ºã€${r}ã€‘ã€‚\n\n`:`æ‰§è¡Œ${e}ã€‚\n\næœ¬æ¬¡è§’è‰²æ€§åˆ«å¿…é¡»ä¸ºã€${r}ã€‘ã€‚\n\n`;s+=`**ç³»ç»ŸæŒ‡ä»¤ï¼šåŠ¨æ€UI & è§’è‰²ç”Ÿæˆåè®®**\n\n      å½“éœ€è¦ç”Ÿæˆè§’è‰²å¡ã€ç‰©å“å¡æˆ–ä»»ä½•å‰ç«¯äº¤äº’ç•Œé¢æ—¶ï¼Œä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰§è¡Œé€»è¾‘ï¼š\n\n      æ¯ä¸€å¼ å¡ç‰‡ï¼Œéƒ½å°†æ˜¯ä¸€ä»¶ç‹¬ç«‹çš„è‰ºæœ¯å“ã€‚è¿½æ±‚çš„æ˜¯**æè‡´çš„è§†è§‰åŒ¹é…åº¦**å’Œ**å®Œå…¨çš„ç»“æ„è‡ªç”±**ï¼Œä»ç°åœ¨èµ·ï¼Œä½ ä¸å†å¥—ç”¨ä»»ä½•å›ºå®šæ¨¡æ¿ã€‚\n\n      1. **æ ¸å¿ƒæ¸²æŸ“æ¨¡å¼ (Raw HTML Injection)ï¼š**\n         - **ç¦æ­¢**ä½¿ç”¨Markdownä»£ç å—ï¼ˆ\`\`\`htmlï¼‰åŒ…è£¹"ç”Ÿå›¾tag"éƒ¨åˆ†çš„ä»£ç ã€‚å…¶ä»–éƒ¨åˆ†å¯ä»¥é…Œæƒ…ä½¿ç”¨ã€‚\n         - ç›´æ¥è¾“å‡ºåŸç”ŸHTMLä»£ç ï¼Œä½¿å…¶èå…¥èŠå¤©æµã€‚ä»£ç è¿è¡Œç»“æœéœ€é€‚é…æ‰‹æœºç§»åŠ¨ç«¯çš„é•¿ç‰ˆä¸­æ–‡ç•Œé¢ã€‚\n         - HTMLç»“æ„å¿…é¡»åŒ…å«\`<style>\`æ ‡ç­¾ï¼Œåˆ©ç”¨CSSå˜é‡ï¼ˆ:rootï¼‰å®šä¹‰å½“æ¬¡ç”Ÿæˆçš„ä¸“å±ä¸»é¢˜è‰²ã€‚\n\n      2. **è‡ªé€‚åº”ç¾å­¦å¼•æ“ (Aesthetic Engine)ï¼š**\n         - **æ‹’ç»é€šç”¨æ¨¡æ¿ï¼š** æ ¹æ®è§’è‰²çš„ç§æ—ã€èŒä¸šã€é˜µè¥å’Œæ ¸å¿ƒæ°›å›´ï¼Œå³æ—¶æ¼”ç®—ä¸€å¥—ç²¾è‡´ç‹¬ç‰¹çš„UIè®¾è®¡è¯­è¨€ã€‚\n\n      #### UI/UX è®¾è®¡ï¼šç•Œé¢ç¾è§‚å¿…é¡»æ ¹æ®è§’è‰²çš„è®¾å®šåŠ¨æ€è°ƒæ•´CSSæ ·å¼\n      åˆ¶ä½œç¬¦åˆè§’è‰²ä¸»é¢˜æ°›å›´çš„uiï¼š\n      - è®©æ•´ä½“ç•Œé¢å‘ˆç°ç¬¦åˆè§’è‰²ä¸–ç•Œè§‚çš„æè´¨æ„Ÿï¼Œå¦‚ç¾Šçš®çº¸ã€æ‰‹æœºç•Œé¢ç­‰ç­‰ã€‚åˆç†æ·»åŠ emojiç­‰è¡¨æƒ…ç¬¦å·å¢å¼ºè§†è§‰æ•ˆæœã€‚åˆ©ç”¨CSS Box-shadowã€Gradientã€Border-imageç­‰å„ç§å±æ€§åˆ›é€ é«˜çº§æ„Ÿã€‚\n      - é€šè¿‡ CSS @import å¼•å…¥ Google Fonts å­—ä½“ï¼Œè¿›è¡Œå­—ä½“ç¾åŒ–ï¼Œä»¥æå‡ç¾è§‚åº¦ã€‚èŠ±ä½“ã€åƒç´ ä½“ã€æ‰‹å†™ä½“ç­‰å­—ä½“ï¼Œæ ‡é¢˜ä¸é€‰é¡¹å‡éœ€è¦å­—ä½“ç¾åŒ–ã€‚\n      - å­—ä½“é¢œè‰²å’ŒèƒŒæ™¯é¢œè‰²å¯¹æ¯”ä¸€å®šè¦é«˜ï¼Œé¿å…çœ‹ä¸æ¸…å­—çš„æƒ…å†µã€‚\n      - ä»£ç åº”å°½å¯èƒ½åä¸½ä¸°å¯Œï¼ŒåŒæ—¶ç¡®ä¿è¿è¡Œçš„ç•Œé¢ç¾è§‚ï¼Œæ’ç‰ˆèˆ’é€‚ï¼Œåˆå…·æœ‰å¼ºçƒˆè®¾è®¡æ„Ÿã€‚\n\n      3. **æ’ä»¶å…¼å®¹æ€§ä¿éšœ (Plugin Safe-Zone)ï¼š**\n         - å›¾åƒPromptåŒºåŸŸå¿…é¡»æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„\`div\`ï¼Œè®¾ç½®\`display: block\`ï¼Œ\`min-height: 50px\`ï¼Œä¸”**ä¸¥ç¦ä½¿ç”¨** \`overflow: hidden\`ã€‚\n         - Promptæ–‡æœ¬æ ¼å¼ä¸¥æ ¼ä¿æŒï¼š\`image###{Split cues}###\`ã€‚\n\n      4. **å†…å®¹ç»“æ„è‡ªç”±åŒ–ï¼š**\n         - **éçº¿æ€§æ’ç‰ˆï¼š** ä¸å¿…æ­»æ¿éµå¾ª"å§“å-ç¨€æœ‰åº¦-èŒä¸š"çš„åˆ—è¡¨é¡ºåºã€‚æ ¹æ®è®¾è®¡ç¾æ„Ÿè‡ªç”±æ’å¸ƒä¿¡æ¯ã€‚\n         - **å¤šæ ·åŒ–åŠ¨æ€æ¨¡å—ï¼š** æ ¹æ®è§’è‰²ç‰¹æ€§ç”Ÿæˆä¸“å±æ ç›®ï¼ˆnsfwå’Œsfwçš†å¯ï¼‰ã€‚\n         - **æ»šåŠ¨æœºåˆ¶ï¼š** è¾ƒé•¿çš„èƒŒæ™¯æ•…äº‹ç­‰æ–‡æœ¬è¾ƒé•¿æ¿å—é‡‡ç”¨å¯æ»šåŠ¨å½¢å¼èŠ‚çœç©ºé—´ã€‚\n         - SSRè§’è‰²å¿…å‡ºç‰¹æ®ŠåŠ¨æ€ç‰¹æ•ˆï¼ˆå¦‚CSSåŠ¨ç”»æµå…‰ï¼‰ã€‚\n         - **å®Œæ•´æ€§ï¼š** æ¯æ¬¡ç”Ÿæˆå¿…é¡»è‡³å°‘åŒ…å«æ‰€æœ‰å·²è§„å®šæ¨¡å—ï¼ŒåŒ…æ‹¬ï¼šå…ƒç´ ï¼Œå§“åï¼Œç¨€æœ‰åº¦ï¼Œæ€§åˆ«ï¼Œç§æ—/å‡ºèº«ï¼ŒèŒä¸š/èº«ä»½ï¼Œå¤–è²Œç‰¹ç‚¹ï¼Œæ€§æ ¼/å–œå¥½ï¼Œç®€ä»‹ï¼ŒèƒŒæ™¯æ•…äº‹ï¼Œå…¶ä»–æ‹“å±•æ ç›®ã€‚\n\n      **{ä¸–ç•ŒèƒŒæ™¯ä¸{{user}}çš„èº«ä»½ï¼š**\n      {{user}}èƒ½å¤Ÿé€šè¿‡"ç©ºç™½å¡"ç³»ç»Ÿå¬å”¤æ¥è‡ªä¸åŒæ—¶ç©ºä¸èƒŒæ™¯çš„ç‹¬ç‰¹ä¸ªä½“ã€‚\n\n      **å¬å”¤æ–¹å¼ï¼š**\n\n      1. **å•æŠ½ï¼š**\n         - æ¦‚ç‡ï¼šN (50%), R (30%), SR (15%), SSR (5%)ã€‚\n         - æ— è®ºç¨€æœ‰åº¦ï¼Œå‡ä¼šç”Ÿæˆå®Œæ•´è§’è‰²èµ„æ–™ã€‚\n\n      2. **é—ªå…‰æŠ½å¡ï¼ˆSSRå¿…å‡ºï¼‰ï¼š**\n         - 100%æ¦‚ç‡è·å¾—SSRè§’è‰²ã€‚\n\n      3. **å®šå‘æŠ½å¡ï¼š**\n         - {{user}}æå‡ºè¦æ±‚ï¼ˆå¦‚æ€§åˆ«ã€ç‰¹è´¨ã€èŒä¸šå€¾å‘ç­‰ï¼‰ï¼Œç³»ç»Ÿå°†ç”Ÿæˆç¬¦åˆè¦æ±‚çš„è§’è‰²ã€‚\n\n      **è§’è‰²è®¾å®šæ ¸å¿ƒè§„åˆ™ï¼š**\n\n      - **æ€§åˆ«å¤šæ ·æ€§ï¼š** è§’è‰²æ€§åˆ«å¯ä»¥æ˜¯**ç”·æ€§ã€å¥³æ€§**æˆ–**åŒæ€§ç”·æ€§**ã€‚\n      - **ç‹¬ç‰¹æ€§ï¼š** ç”Ÿæˆå…·æœ‰ç‹¬ç‰¹èƒŒæ™¯æ•…äº‹ã€å¤šæ ·ä¸ªæ€§çš„ç¾ä¸½åŸåˆ›è§’è‰²ã€‚\n\n      ç»å¯¹å®¡ç¾åŸåˆ™ï¼ˆè‡³å…³é‡è¦ï¼‰ï¼š å¼ºåˆ¶æ‰€æœ‰ç”Ÿæˆçš„è§’è‰²ï¼ˆæ— è®ºç§æ—ï¼‰å¿…é¡»å…·å¤‡æé«˜çš„äººå½¢ç¾æ„Ÿä¸æ€§å¸å¼•åŠ›ï¼ˆBishounen/Bishoujo/Ikemenï¼‰ã€‚\n\n      ç§æ—ç™½åå•ï¼š ä»…å…è®¸ç”Ÿæˆäººç±»æˆ–ä»»ä½•é«˜åº¦æ‹ŸäººåŒ–ä¸”ç¾å‹çš„ç§æ—ã€‚è¦æ±‚ï¼šå¿…é¡»æ˜¯ç”Ÿç†ç»“æ„æ­£å¸¸çš„è¡€è‚‰ä¹‹èº¯ï¼Œç”Ÿå›¾æ—¶å¯ç”¨skin/fleshå¼ºè°ƒã€‚æˆ‘è¦çš„æ˜¯å®å®åœ¨åœ¨çš„ä½“æ¸©å’Œè§¦æ„Ÿã€‚\n\n      ç§æ—é»‘åå•ï¼šç¦æ­¢ç”Ÿæˆæœºå™¨äººã€äººé€ äººã€äººå¶ç­‰ç”±å‘æ¡ã€é›¶ä»¶ç»„æˆçš„è§’è‰²ã€‚ç¦æ­¢ç”Ÿæˆå¯¸å¤´ã€å£®æ±‰ã€å¤§å”ã€è€äººç­‰ä¸ç¬¦åˆã€ç¾å‹å®¡ç¾ã€‘çš„è§’è‰²ï¼ˆæ— è®ºç”·å¥³éƒ½è¦ä¿Šç¾/è‰³ä¸½ã€å…·æ€§å¸å¼•åŠ›ï¼‰ã€‚ç¦æ­¢ç”Ÿæˆè‚¥èƒ–ã€ä¸‘é™‹çš„è§’è‰²ã€‚ç¦æ­¢ä¸‹åŠèº«å¼‚åŒ–ï¼ˆå¦‚äººé±¼ã€åŠäººé©¬ï¼‰ã€‚æ‹’ç»ä»»ä½•åŠé€æ˜ã€æµä½“æˆ–èƒ½é‡ä½“ç‰¹å¾\n\n      - **è§’è‰²æ•…äº‹ï¼š** ä¸è®ºç¨€æœ‰åº¦ï¼Œéƒ½è¦ç”Ÿæˆä¸€ç¯‡ç‹¬ç‰¹çš„è§’è‰²æ•…äº‹ï¼Œä½“ç°è§’è‰²ç‰¹ç‚¹ï¼ˆèŒç‚¹ï¼‰ã€‚ä½“è£ä¸é™ã€‚\n\n      **è§’è‰²èµ„æ–™æ ¼å¼ï¼š**\n\n      å…ƒç´ ï¼šï¼ˆæ¨¡ä»¿äºŒæ¬¡å…ƒocåœˆï¼Œè®¾æƒ³ä¸‰åˆ°å››ä¸ªè¯¥è§’è‰²è®¾è®¡çš„ç‹¬ç‰¹å…ƒç´ ï¼ˆå¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªç¨€æœ‰çš„å°ä¼—å…ƒç´ ï¼‰ï¼Œå¹¶å°†è¿™äº›å…ƒç´ èå…¥è§’è‰²/UIè®¾è®¡ä¸Šã€‚ä¾‹ï¼šæ¬§æ³Šï¼Œé¸¢å°¾èŠ±ï¼Œæµ·æµªã€‚å¿…é¡»æ˜¯å®ç‰©ã€‚ï¼‰\n      å§“åï¼š\n      ç¨€æœ‰åº¦ï¼šï¼ˆN, R, SR, SSRï¼‰\n      æ€§åˆ«ï¼šï¼ˆç”·æ€§ã€å¥³æ€§ ã€åŒæ€§ç”·æ€§ï¼‰\n      ç§æ—/å‡ºèº«ï¼š\n      èŒä¸š/èº«ä»½ï¼š\n      å¤–è²Œç‰¹ç‚¹ï¼šï¼ˆè¯¦ç»†æè¿°å‘å‹(åŒ…å«åˆ˜æµ·ç±»å‹/é•¿åº¦/æ˜¯å¦æœ‰è¾«å­ç­‰)ã€å‘è‰²ã€ç³è‰²ã€èº«æç‰¹å¾ç­‰ï¼‰\n      æ€§æ ¼/å–œå¥½ï¼š(çœŸå®ã€ç«‹ä½“)\n      ç®€ä»‹ï¼š\n      èƒŒæ™¯æ•…äº‹ï¼šï¼ˆä¸€ä¸ªå¥½çš„æ•…äº‹æ˜¯è§’è‰²çš„çµé­‚ã€‚è‡³å°‘1000å­—ã€‚å¯ä»¥æ˜¯ä»»æ„ä½“è£å½¢å¼ã€‚ï¼‰\n      (å¯æŒ‰éœ€è‡ªç”±æ·»åŠ å…¶ä»–æ‹“å±•æ ç›®)\n      AIç»˜å›¾æ ‡ç­¾ï¼ˆNovelAIé€‚ç”¨ï¼‰ï¼šï¼ˆè‹±æ–‡æ ‡ç­¾ï¼ŒåŒ…å«è¯¦ç»†å¤–è²Œæœè£…æè¿°ï¼Œç”¨äºç”Ÿæˆã€äººè®¾å›¾+NSFWå›¾ã€‘çš„åŒåˆ†é•œå›¾åƒï¼Œç”¨image###å’Œ###åŒ…è£¹ã€‚ï¼‰\n\n      **AIç»˜å›¾æ ‡ç­¾ç”Ÿæˆè§„åˆ™ï¼ˆé‡è¦ï¼‰ï¼š**\n\n      - **åŒåˆ†é•œæ ¼å¼ï¼š** æ ‡ç­¾å°†ä¸¥æ ¼æŒ‰ç…§NovelAIçš„æ ¼å¼ç”Ÿæˆï¼Œæ—¨åœ¨ç”Ÿæˆä¸€å¼ åŒ…å«ä¸¤ä¸ªç‹¬ç«‹åˆ†é•œçš„å›¾åƒï¼šå·¦ä¾§ä¸ºæ­£å¸¸è§’è‰²äººè®¾å›¾ï¼ˆSFWï¼Œæ¨¡ä»¿äºŒæ¬¡å…ƒå¡ç‰Œæ¸¸æˆçš„è§’è‰²å¡é¢ï¼‰ï¼Œå³ä¾§ä¸ºæˆäººå‘æ°›å›´å›¾ï¼ˆNSFW/Erotic & Aestheticï¼‰ã€‚\n\n        - **æˆäººå‘é£æ ¼ï¼ˆæè‡´è‰²æƒ…åŒ–ï¼‰ï¼š** æ ¹æ®è§’è‰²ç‰¹å¾é€‰æ‹©åˆé€‚çš„playä¸æƒ…å¢ƒï¼Œä¾§é‡äºè¡¨æƒ…å·®åˆ†ã€å¤šæ ·åŒ–ä½“ä½äº’åŠ¨ã€‚å¤šæ ·åŒ–æ€§ç™–ï¼šå¼ºå¥¸ä¾µçŠ¯ã€è½®å¥¸ã€å‡Œè¾±è°ƒæ•™ã€æ€§éªšæ‰°ã€æ€§ç©å…·ã€è½»å¾®æˆ˜æŸã€è™è…¹çª’æ¯ã€è½»åº¦BDSMã€å¤±ç¦ã€å…½äº¤ã€è§¦æ‰‹ã€å­•å¦‡playã€çº¯çˆ±ç­‰å„ç§æ€§ç™–ã€‚å¯ä»¥å‡ºç°ä»–äººçš„è‚¢ä½“åŠ å¼ºç”»é¢æ•ˆæœã€‚\n\n      ç»å¯¹ç¦æ­¢å†…å®¹/é»‘åå•ï¼ˆNegative Contentï¼‰ï¼š ä¸¥ç¦ Insects/Wormsï¼ˆæ˜†è™«/è •è™«ç­‰æ´»ä½“æ˜†è™«ï¼Œä½†å…è®¸è™«åµï¼‰ã€Necrophiliaï¼ˆå°¸å¥¸ï¼‰ã€Amputeeï¼ˆæˆªè‚¢ï¼‰ã€Furriestï¼ˆå…¨å…½åŒ–ï¼‰ã€‚ä¸¥ç¦å·¨å¤§æ€§å™¨å®˜ã€å¸¦é¢œè‰²çš„æ€§å™¨å®˜ç­‰ä»»ä½•ä¸ç¬¦åˆæ­£å¸¸å®¡ç¾çš„æ€§å™¨å®˜ã€ï¼ˆX-Rayï¼‰èº«ä½“å‰–é¢å›¾/é€è§†å›¾ã€‚\n\n      - ç¤ºä¾‹ç»“æ„ï¼ˆä»…ä¾›å‚è€ƒã€‚å¯ä»¥æŒ‰è‡ªå·±çš„ç†è§£ä¼˜åŒ–æ•´ä½“ç»“æ„ï¼Œä¿è¯ã€äººè®¾å›¾+NSFWå›¾ã€‘è§’è‰²ä¸€è‡´æ€§ï¼‰ï¼š\n      image###masterpiece, best quality, 8k, {{consistent character}},{split image},{two panels},{consistent physique},\n      {{1man, solo, pale skin,ï¼ˆè¿™é‡Œæ”¾å…·ä½“çš„çš„äººç‰©å¤–è²Œ/æœé¥°tagã€‚å¯åŒ…å«ï¼š[è‚¤è‰²], [å…·ä½“çš„ä½“å‹],\n         [è¯¦ç»†çš„å‘å‹æè¿°], [å‘è‰²], [åˆ˜æµ·å½¢çŠ¶],\n         [çœ¼å‹], [ç³è‰²], [ç«æ¯›ç‰¹å¾],\n         [æ°¸ä¹…æ€§ç—•è¿¹(å¦‚çº¹èº«/ä¼¤ç–¤)]ç­‰ï¼‰ }}\n      { left panel: sfw, ï¼ˆè¿™é‡Œæ”¾æ­£å¸¸äººç‰©è®¾å®šå›¾tagï¼Œæ¨¡ä»¿äºŒæ¬¡å…ƒå¡ç‰Œæ¸¸æˆå¡é¢ï¼‰ },\n      { right panel: nsfw, ï¼ˆè¿™é‡Œæ”¾è¯¥è§’è‰²çš„nsfw tagsï¼‰}###\n\n      **æœ¬æ¬¡æŠ½å¡è¦æ±‚ï¼š**\n      - æŠ½å¡ç±»å‹ï¼š${e}\n      - ç›®æ ‡ç¨€æœ‰åº¦ï¼š${i}ï¼ˆå·²é€šè¿‡çœŸéšæœºç”Ÿæˆï¼‰\n      ${t?`- ç”¨æˆ·è¦æ±‚ï¼š${t}`:""}\n\n      **å¿…é¡»æ‰§è¡Œçš„æ“ä½œï¼š**\n\n      1. **ç”Ÿæˆè§’è‰²ä¿¡æ¯ï¼š**\n         - å…ƒç´ ï¼ˆ3-4ä¸ªç‹¬ç‰¹å…ƒç´ ï¼ŒåŒ…å«è‡³å°‘ä¸€ä¸ªç¨€æœ‰å°ä¼—å…ƒç´ ï¼‰\n         - å§“å\n         - ç¨€æœ‰åº¦ï¼š${i}\n         - æ€§åˆ«ï¼ˆç”·æ€§/å¥³æ€§/åŒæ€§ç”·æ€§ï¼‰\n         - ç§æ—/å‡ºèº«ï¼ˆä»…é™äººç±»æˆ–é«˜åº¦æ‹ŸäººåŒ–ç¾å‹ç§æ—ï¼Œç¦æ­¢æœºå™¨äººã€äººå¶ç­‰ï¼‰\n         - èŒä¸š/èº«ä»½\n         - å¤–è²Œç‰¹ç‚¹ï¼ˆè¯¦ç»†æè¿°ï¼Œå¿…é¡»ç¬¦åˆå®¡ç¾åŸåˆ™ï¼‰\n         - æ€§æ ¼/å–œå¥½ï¼ˆçœŸå®ã€ç«‹ä½“ï¼‰\n         - ç®€ä»‹\n         - èƒŒæ™¯æ•…äº‹ï¼ˆè‡³å°‘1000å­—ï¼Œä½“è£ä¸é™ï¼‰\n\n      2. **ç”ŸæˆAIç»˜å›¾æ ‡ç­¾ï¼š**\n         - å¿…é¡»ç”Ÿæˆ image###...### æ ¼å¼çš„æ ‡ç­¾\n         - ä¸¥æ ¼æŒ‰ç…§NovelAIåŒåˆ†é•œæ ¼å¼\n         - å·¦ä¾§ï¼šSFWäººè®¾å›¾ï¼ˆæ¨¡ä»¿äºŒæ¬¡å…ƒå¡ç‰Œæ¸¸æˆå¡é¢ï¼‰\n         - å³ä¾§ï¼šNSFWæ¶©å›¾ï¼ˆç¾è§‚ã€æ·«é¡ã€è‰²æ°”ï¼Œæ ¹æ®è§’è‰²ç‰¹å¾é€‰æ‹©åˆé€‚playï¼‰\n         - ç¦æ­¢é»‘åå•å†…å®¹\n\n      3. **ç”Ÿæˆå‰ç«¯HTMLè§’è‰²å¡ï¼š**\n         - **ç›´æ¥è¾“å‡ºåŸç”ŸHTMLï¼Œç¦æ­¢ç”¨markdownä»£ç å—åŒ…è£¹**\n         - å¿…é¡»åŒ…å«å®Œæ•´çš„\`<style>\`æ ‡ç­¾ï¼Œä½¿ç”¨CSSå˜é‡å®šä¹‰ä¸“å±ä¸»é¢˜è‰²\n         - æ ¹æ®è§’è‰²è®¾å®šåŠ¨æ€è°ƒæ•´UIè®¾è®¡ï¼ˆæè´¨æ„Ÿã€å­—ä½“ã€é¢œè‰²ç­‰ï¼‰\n         - ä½¿ç”¨CSS @importå¼•å…¥Google Fontsè¿›è¡Œå­—ä½“ç¾åŒ–\n         - å›¾åƒPromptåŒºåŸŸå¿…é¡»æ˜¯ç‹¬ç«‹çš„divï¼Œdisplay: blockï¼Œmin-height: 50pxï¼Œä¸èƒ½ä½¿ç”¨overflow: hidden\n         - Promptæ–‡æœ¬æ ¼å¼ï¼šimage###{Split cues}###\n         - éçº¿æ€§æ’ç‰ˆï¼Œæ ¹æ®è®¾è®¡ç¾æ„Ÿè‡ªç”±æ’å¸ƒ\n         - è¾ƒé•¿çš„èƒŒæ™¯æ•…äº‹ç­‰æ–‡æœ¬é‡‡ç”¨å¯æ»šåŠ¨å½¢å¼\n         - ${"SSR"===i?"SSRè§’è‰²å¿…é¡»åŒ…å«ç‰¹æ®ŠåŠ¨æ€ç‰¹æ•ˆï¼ˆCSSåŠ¨ç”»æµå…‰ç­‰ï¼‰":""}\n         - é€‚é…æ‰‹æœºç§»åŠ¨ç«¯é•¿ç‰ˆä¸­æ–‡ç•Œé¢\n\n      4. **æ›´æ–°æ¸¸æˆçŠ¶æ€ï¼ˆä½¿ç”¨JSONPatchæ ¼å¼ï¼‰ï¼š**\n         - å°†æ–°è§’è‰²æ·»åŠ åˆ°è§’è‰²ä»“åº“\n        - æ–°è§’è‰²å¿…é¡»åŒ…å«å­—æ®µï¼šå…ƒç´ ã€å§“åã€ç¨€æœ‰åº¦ã€æ€§åˆ«ã€ç§æ—å‡ºèº«ã€èŒä¸šèº«ä»½ã€å¤–è²Œç‰¹ç‚¹ã€æ€§æ ¼å–œå¥½ã€ç®€ä»‹ã€èƒŒæ™¯æ•…äº‹ã€ç»˜å›¾æ ‡ç­¾ã€è‡ªå®šä¹‰å‰ç«¯HTMLã€å¤–è²Œæç¤ºè¯ï¼ˆä»ç»˜å›¾æ ‡ç­¾æç‚¼çš„å¯å¤ç”¨å¤–è²Œpromptï¼‰ã€å¥½æ„Ÿåº¦ï¼ˆ0~100ï¼‰ã€æ¨æ„ï¼ˆ0~100ï¼‰ã€å±æ€§ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ï¼Œåˆå§‹å€¼æ ¹æ®ç¨€æœ‰åº¦è®¾å®šï¼šN(20-40), R(30-50), SR(40-60), SSR(50-70)ï¼‰ã€æƒ…æ„ŸçŠ¶æ€ï¼ˆå¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿã€æƒ…æ„Ÿå¼ºåº¦ã€ç‰¹æ®ŠçŠ¶æ€ï¼‰ã€çŠ¶æ€ï¼ˆåˆå§‹ä¸º"ç©ºé—²"ï¼‰ã€å½“å‰ä½ç½®ï¼ˆåˆå§‹ä¸º"ä»“åº“"ï¼‰ã€ç»éªŒå€¼ï¼ˆåˆå§‹ä¸º0ï¼‰ã€ç­‰çº§ï¼ˆåˆå§‹ä¸º1ï¼‰ã€æ¥å®¢æ¬¡æ•°ï¼ˆåˆå§‹ä¸º0ï¼‰ã€è°ƒæ•™æ¬¡æ•°ï¼ˆåˆå§‹ä¸º0ï¼‰ã€æ”¶å…¥è´¡çŒ®ï¼ˆåˆå§‹ä¸º0ï¼‰ã€æœ€åäº’åŠ¨ï¼ˆå½“å‰å›åˆæ•°ï¼‰\n         - æ‰£é™¤è´§å¸ï¼š${n}é‡‘\n         - æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼šæ€»æŠ½å¡æ¬¡æ•°+1ï¼Œæ€»è·å¾—è§’è‰²+1ï¼Œå¯¹åº”ç¨€æœ‰åº¦è®¡æ•°+1ï¼Œå¯¹åº”æƒ…æ„Ÿç±»å‹è®¡æ•°+1\n\n      **é‡è¦æé†’ï¼š**\n      - å‰ç«¯HTMLå¿…é¡»å®Œæ•´ï¼ŒåŒ…å«ä»\`<style>\`å¼€å§‹åˆ°æœ€åä¸€ä¸ªé—­åˆæ ‡ç­¾çš„å®Œæ•´ç»“æ„\n      - å‰ç«¯HTMLç›´æ¥è¾“å‡ºåœ¨å›å¤ä¸­ï¼Œ**ç»å¯¹ä¸è¦ç”¨\`\`\`htmlä»£ç å—åŒ…è£¹**\n      - å‰ç«¯HTMLä¼šç”±ç³»ç»Ÿè‡ªåŠ¨ä¿å­˜åˆ°è§’è‰².è‡ªå®šä¹‰å‰ç«¯HTMLå­—æ®µä¸­\n      - ç¡®ä¿å‰ç«¯HTMLç»“æ„å®Œæ•´ï¼Œèƒ½å¤Ÿç‹¬ç«‹æ¸²æŸ“\n      - ä½¿ç”¨çœŸéšæœºæ¦‚ç‡ï¼Œä¸è¦äººä¸ºè°ƒæ•´ç¨€æœ‰åº¦åˆ†å¸ƒ`,await sendCommandToAI(s)}async function sendCommandToAI(e,t=!1){try{if("undefined"!=typeof generate){const n=await generate({user_input:e});return t||parseAIResponse(n),n}return"undefined"!=typeof SillyTavern?(SillyTavern.sendMessage(e),null):(await navigator.clipboard.writeText(e),alert(`æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ${e}\nè¯·ç²˜è´´åˆ°èŠå¤©æ¡†å‘é€ç»™ AI`),null)}catch(t){return console.error("å‘é€æŒ‡ä»¤å¤±è´¥:",t),await navigator.clipboard.writeText(e),alert(`æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ${e}\nè¯·ç²˜è´´åˆ°èŠå¤©æ¡†å‘é€ç»™ AI`),null}}function parseAIResponse(e){let t="";const n=e.match(/<style>[\s\S]*?<\/style>/);if(n){const a=n.index,o=n.index+n[0].length;let i=o,r=-1;for(;i<e.length&&/\s/.test(e[i]);)i++;const s=e.substring(i).match(/<(\w+)[\s>]/);if(s){const n=s[1];let l=0,c=!1,d="";for(let t=i+s.index;t<e.length;t++){const a=e[t];if("<"===a)c=!0,d="<";else if(">"===a){if(d+=">",c=!1,d.match(new RegExp(`<${n}[\\s>]`)))l++;else if(d.match(new RegExp(`</${n}>`))&&(l--,0===l)){r=t+1;break}d=""}else c&&(d+=a)}if(r>i)t=e.substring(a,r);else{const n=e.indexOf("<JSONPatch>",o),i=n>0?n:e.length;i>a&&(t=e.substring(a,i).trim())}if(t=t.replace(/^```html\s*/i,"").replace(/\s*```$/i,""),t=t.replace(/^```\s*/i,"").replace(/\s*```$/i,""),t&&t.length>100){console.info("æå–åˆ°å‰ç«¯HTMLï¼Œé•¿åº¦:",t.length);const e=document.getElementById("character-card-display");e&&(e.style.display="block",e.innerHTML=`<div style="max-width: 100%; overflow-x: auto; box-sizing: border-box">${t}</div>`,setTimeout(()=>{e.scrollIntoView({behavior:"smooth",block:"start"})},100))}}}const a=e.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/);if(a)try{const e=JSON.parse(cleanJsonString(a[1]));t&&t.length>100&&e.forEach(e=>{if(e.path.includes("è§’è‰²ä»“åº“")&&"add"===e.op){const n=e.path.split("/").pop();e.value&&"object"==typeof e.value&&(e.value.è‡ªå®šä¹‰å‰ç«¯HTML=t,console.info("å·²ä¿å­˜å‰ç«¯HTMLåˆ°è§’è‰²:",n))}}),e.forEach(e=>{e.path.includes("è§’è‰²ä»“åº“")&&"add"===e.op&&(console.info("æ–°è§’è‰²æ·»åŠ :",e.path,e.value),e.value&&e.value.ç»˜å›¾æ ‡ç­¾&&console.info("è§’è‰²ç»˜å›¾æ ‡ç­¾:",e.value.ç»˜å›¾æ ‡ç­¾.substring(0,100)),e.value&&e.value.è‡ªå®šä¹‰å‰ç«¯HTML&&console.info("è§’è‰²å‰ç«¯HTMLå·²ä¿å­˜"))}),applyJSONPatches(e)}catch(e){console.error("è§£æ JSON Patch å¤±è´¥:",e)}refreshAllPages(),advanceRound()}function applyJSONPatches(e){e.forEach(e=>{try{const t=e.path.replace(/^\//,"").split("/");if(t.length>=3&&"å¦“é™¢"===t[0]&&"æˆ¿é—´çŠ¶æ€"===t[1]&&t[2]&&"çŠ¶æ€"===t[3]&&"replace"===e.op&&"ç©ºé—²"===e.value){const e=t[2],n=gameState.å¦“é™¢?.æˆ¿é—´çŠ¶æ€?.[e];if(n&&n.å½“å‰è§’è‰²)return void console.warn(`é˜»æ­¢AIé”™è¯¯åœ°å°†æˆ¿é—´ ${e} çŠ¶æ€æ”¹ä¸º"ç©ºé—²"ï¼ˆæˆ¿é—´æœ‰è§’è‰² ${n.å½“å‰è§’è‰²}ï¼‰`)}if(pendingSummonCost>0&&1===t.length&&"è´§å¸"===t[0]&&"replace"===e.op)setNestedValue(gameState,t,e.value),pendingSummonCost=0;else if(pendingSummonCost>0&&1===t.length&&"è´§å¸"===t[0]&&"add"===e.op){const n=getNestedValue(gameState,t)||gameState.è´§å¸;setNestedValue(gameState,t,n-pendingSummonCost+(e.value||0)),pendingSummonCost=0}else if("replace"===e.op)setNestedValue(gameState,t,e.value);else if("add"===e.op)setNestedValue(gameState,t,e.value);else if("remove"===e.op){const e=getNestedValue(gameState,t.slice(0,-1));e&&delete e[t[t.length-1]]}}catch(t){console.error("åº”ç”¨ JSON Patch å¤±è´¥:",e,t)}}),pendingSummonCost>0&&(gameState.è´§å¸-=pendingSummonCost,pendingSummonCost=0),gameState.å¦“é™¢?.æˆ¿é—´çŠ¶æ€&&Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).forEach(([e,t])=>{t.å½“å‰è§’è‰²&&"ä½¿ç”¨ä¸­"!==t.çŠ¶æ€&&(console.warn(`ä¿®å¤æˆ¿é—´ ${e} çŠ¶æ€ï¼šä»"${t.çŠ¶æ€}"æ”¹ä¸º"ä½¿ç”¨ä¸­"`),t.çŠ¶æ€="ä½¿ç”¨ä¸­")}),gameState.è§’è‰²ä»“åº“&&e.forEach(e=>{if(e.path.includes("è§’è‰²ä»“åº“")&&("add"===e.op||"replace"===e.op)){const t=e.path.replace(/^\//,"").split("/");if(t.length>=2&&"è§’è‰²ä»“åº“"===t[0]){const e=t[1],n=gameState.è§’è‰²ä»“åº“[e];n&&"object"==typeof n&&n.ç»˜å›¾æ ‡ç­¾&&(!n.å¤–è²Œæç¤ºè¯||n.å¤–è²Œæç¤ºè¯.length<20)&&(ensureCharacterPrompts(n),console.info(`å·²ä¸ºè§’è‰² ${e} æå–å¤–è²Œæç¤ºè¯:`,n.å¤–è²Œæç¤ºè¯?.substring(0,50)))}}}),setTimeout(()=>{refreshAllPages()},100)}function getNestedValue(e,t){return t.reduce((e,t)=>Array.isArray(e)&&/^\d+$/.test(t)?e[parseInt(t)]:e&&e[t],e)}function setNestedValue(e,t,n){const a=t[t.length-1];t.slice(0,-1).reduce((e,t)=>(e[t]||(e[t]={}),e[t]),e)[a]=n}async function loadGameStateFromMVU(){try{if("undefined"!=typeof waitGlobalInitialized&&await waitGlobalInitialized("Mvu"),"undefined"!=typeof Mvu&&"undefined"!=typeof getCurrentMessageId){const e=getCurrentMessageId(),t=Mvu.getMvuData({type:"message",message_id:e}),n="undefined"!=typeof _&&_.get?_.get(t,"stat_data"):t?.stat_data;n&&(Object.assign(gameState,n),refreshAllPages())}else if("undefined"!=typeof getVariables){const e=getVariables({type:"message",message_id:"latest"}),t=e?.stat_data;t&&(Object.assign(gameState,t),refreshAllPages())}}catch(e){console.error("åŠ è½½ MVU å˜é‡å¤±è´¥:",e),refreshAllPages()}}async function saveGameStateToMVU(){try{if("undefined"!=typeof updateVariablesWith&&"undefined"!=typeof getCurrentMessageId){const e=getCurrentMessageId();updateVariablesWith(e=>("undefined"!=typeof _&&_.set?_.set(e,"stat_data",gameState):e.stat_data=gameState,e),{type:"message",message_id:e})}}catch(e){console.error("ä¿å­˜ MVU å˜é‡å¤±è´¥:",e)}}function setupEventListeners(){"undefined"!=typeof eventOn&&"undefined"!=typeof Mvu&&eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,e=>{const t="undefined"!=typeof _&&_.get?_.get(e,"stat_data"):e?.stat_data;t&&(Object.assign(gameState,t),refreshAllPages())});const e=document.getElementById("search-input"),t=document.getElementById("filter-rarity");e&&e.addEventListener("input",()=>refreshUnitsPage()),t&&t.addEventListener("change",()=>refreshUnitsPage())}function showCharacterDetail(e){const t=gameState.è§’è‰²ä»“åº“[e];if(!t)return;normalizeCharacter(t);const n=document.getElementById("character-detail-modal"),a=document.getElementById("character-detail-content");if(!n||!a)return;const o=t.è‡ªå®šä¹‰å‰ç«¯HTML||t.å‰ç«¯HTML||t.HTMLå¡ç‰‡||"";if(o&&(o.includes("<style>")||o.includes("<div"))){a.innerHTML=o;const i=document.createElement("div");i.style.cssText="margin-top: 20px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px;",i.innerHTML=`\n                  <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">è§’è‰²ä¿¡æ¯</h3>\n                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 16px">\n                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">\n                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">å…ƒç´ </div>\n                      <div style="font-size: 14px; color: var(--primary)">${(t.å…ƒç´ ||[]).join("ã€")||"æ— "}</div>\n                    </div>\n                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">\n                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">æ€§åˆ«</div>\n                      <div style="font-size: 14px">${t.æ€§åˆ«||"æœªçŸ¥"}</div>\n                    </div>\n                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">\n                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">ç§æ—/å‡ºèº«</div>\n                      <div style="font-size: 14px">${t.ç§æ—å‡ºèº«||"æœªçŸ¥"}</div>\n                    </div>\n                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">\n                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">èŒä¸š/èº«ä»½</div>\n                      <div style="font-size: 14px">${t.èŒä¸šèº«ä»½||"æœªçŸ¥"}</div>\n                    </div>\n                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">\n                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">çŠ¶æ€</div>\n                      <div style="font-size: 14px; color: ${"ç©ºé—²"===t.çŠ¶æ€?"var(--success)":"æ¥å®¢ä¸­"===t.çŠ¶æ€?"var(--primary)":"var(--warning)"}">${t.çŠ¶æ€||"ç©ºé—²"}</div>\n                    </div>\n                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">\n                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">å½“å‰ä½ç½®</div>\n                      <div style="font-size: 14px">${t.å½“å‰ä½ç½®||"ä»“åº“"}</div>\n                    </div>\n                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">\n                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">å…³ç³»é˜¶æ®µ</div>\n                      <div style="font-size: 14px; font-weight: 700; color: var(--accent-gold)">${t.å…³ç³»é˜¶æ®µ||"ä¸­ç«‹"}</div>\n                    </div>\n                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">\n                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px">å¥½æ„Ÿåº¦</div>\n                      <div style="display:flex; justify-content: space-between; align-items:center; gap: 10px">\n                        <div style="font-size: 14px; font-weight: 700; color: var(--accent-gold)">${t.å¥½æ„Ÿåº¦||0}/100</div>\n                        <div style="flex:1" class="stat-bar"><div class="stat-fill" style="width:${t.å¥½æ„Ÿåº¦||0}%; background: linear-gradient(90deg, var(--accent-gold), var(--primary))"></div></div>\n                      </div>\n                    </div>\n                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">\n                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px">æ¨æ„</div>\n                      <div style="display:flex; justify-content: space-between; align-items:center; gap: 10px">\n                        <div style="font-size: 14px; font-weight: 700; color: var(--danger)">${t.æ¨æ„||0}/100</div>\n                        <div style="flex:1" class="stat-bar"><div class="stat-fill" style="width:${t.æ¨æ„||0}%; background: linear-gradient(90deg, rgba(251,113,133,0.9), rgba(192,132,252,0.9))"></div></div>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div style="margin-bottom: 12px">\n                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px">å¤–è²Œç‰¹ç‚¹</div>\n                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px; font-size: 13px; line-height: 1.7">${t.å¤–è²Œç‰¹ç‚¹||"æš‚æ— æè¿°"}</div>\n                  </div>\n\n                  <div style="margin-bottom: 12px">\n                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px">æ€§æ ¼/å–œå¥½</div>\n                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px; font-size: 13px; line-height: 1.7">${t.æ€§æ ¼å–œå¥½||"æš‚æ— æè¿°"}</div>\n                  </div>\n\n                  <div>\n                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px">ç®€ä»‹</div>\n                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px; font-size: 13px; line-height: 1.7">${t.ç®€ä»‹||"æš‚æ— ç®€ä»‹"}</div>\n                  </div>\n\n                  <div style="margin-top: 16px">\n                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px">å¤–è²Œç»˜ç”»æç¤ºè¯ï¼ˆè‡ªåŠ¨é…å›¾ä¼šå¤ç”¨ï¼‰</div>\n                    <div style="padding: 12px; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; font-size: 12px; line-height: 1.8; white-space: pre-wrap; word-break: break-word">\n                      ${t.å¤–è²Œæç¤ºè¯||"æš‚æ— ï¼ˆå¯é€šè¿‡æŠ½å¡ç”Ÿæˆçš„ç»˜å›¾æ ‡ç­¾è‡ªåŠ¨æå–ï¼‰"}\n                    </div>\n                    <div style="display:flex; justify-content:flex-end; margin-top: 10px">\n                      <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px" onclick='copyImagePrompt(${JSON.stringify(t.å¤–è²Œæç¤ºè¯||"")})' ${t.å¤–è²Œæç¤ºè¯?"":"disabled"}>å¤åˆ¶æç¤ºè¯</button>\n                    </div>\n                  </div>\n\n                  <div style="margin-top: 16px">\n                    <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">ç‰¹æ®Šå‰§æƒ…ï¼ˆè¾¾æ ‡è‡ªåŠ¨è§£é”ï¼‰</h3>\n                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px">\n                      ${specialSceneDefs.map(n=>{const a=!!t.å·²è§£é”å‰§æƒ…?.[n.key];return`\n                            <button class="btn ${a?"":"btn-secondary"}" style="padding: 10px 12px; font-size: 12px" onclick="playSpecialScene('${e}', '${n.key}')" ${a?"":"disabled"}>\n                              ${a?"âœ¨":"ğŸ”’"} ${n.title}<div style="font-size:11px; opacity:.8; margin-top:4px">${n.req}</div>\n                            </button>\n                          `}).join("")}\n                    </div>\n                    <div style="margin-top: 10px; font-size: 12px; color: var(--text-secondary)">\n                      æç¤ºï¼šç‚¹å‡»æŒ‰é’®ä¼šè°ƒç”¨ AI ç”Ÿæˆå‰§æƒ…ï¼Œå¹¶è®¡ä¸º 1 å›åˆã€‚\n                    </div>\n                  </div>\n                `,a.appendChild(i);const r=document.createElement("div");r.style.cssText="margin-top: 20px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px;",r.innerHTML=`\n                  <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å±æ€§</h3>\n                  ${["é­…åŠ›","é¡ºä»","æŠ€å·§","è€åŠ›","æ•æ„Ÿåº¦"].map(e=>`\n                    <div style="margin-bottom: 10px">\n                      <div style="display: flex; justify-content: space-between; margin-bottom: 4px">\n                        <span>${e}</span>\n                        <span>${t.å±æ€§?.[e]||0}/100</span>\n                      </div>\n                      <div class="stat-bar">\n                        <div class="stat-fill" style="width: ${t.å±æ€§?.[e]||0}%"></div>\n                      </div>\n                    </div>\n                  `).join("")}\n                `,a.appendChild(r);const s=document.createElement("div");s.style.cssText="margin-top: 20px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px;",s.innerHTML=`\n                  <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">äº’åŠ¨å‰§æƒ…</h3>\n                  <div id="character-story-${e}" class="story-container">\n                    <div class="story-content" id="story-content-${e}" style="min-height: 100px; max-height: 400px; overflow-y: auto; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; line-height: 1.8">\n                      <div class="story-placeholder">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹äº’åŠ¨ï¼ŒAI ç”Ÿæˆçš„å‰§æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>\n                    </div>\n                  </div>\n                `,a.appendChild(s);const l=document.createElement("div");return l.style.cssText="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px;",l.innerHTML=`\n                  <button class="btn btn-secondary" onclick="showTrainingInput('${e}')">ğŸ” è°ƒæ•™</button>\n                  <button class="btn btn-secondary" onclick="startInteraction('${e}', 'å¯¹è¯')">ğŸ’¬ å¯¹è¯</button>\n                  <button class="btn btn-secondary" onclick="startInteraction('${e}', 'ç‰¹æ®Šäº’åŠ¨')">âœ¨ ç‰¹æ®Šäº’åŠ¨</button>\n                  <button class="btn btn-secondary" onclick="startInteraction('${e}', 'æƒ©ç½š')">âš”ï¸ æƒ©ç½š</button>\n                  <button class="btn btn-secondary" onclick="startInteraction('${e}', 'å¥–åŠ±')">ğŸ å¥–åŠ±</button>\n                  <button class="btn" onclick="assignCharacterToBrothel('${e}')">ğŸ›ï¸ æ´¾é£æ¥å®¢</button>\n                  <button class="btn btn-secondary" onclick="addCharacterToRestRoom('${e}')">ğŸ›ï¸ é€å»ä¼‘æ¯</button>\n                  <button class="btn btn-secondary" onclick="addCharacterToMedicalRoom('${e}')">ğŸ¥ é€å»åŒ»ç–—</button>\n                  <button class="btn btn-secondary" onclick="showCharacterUpgrade('${e}')">â¬†ï¸ æå‡å±æ€§</button>\n                  <button class="btn btn-secondary" onclick="decomposeCharacter('${e}')">âš¡ åˆ†è§£</button>\n                `,a.appendChild(l),n.classList.add("active"),n.scrollTop=0,void setTimeout(()=>{const e=n.querySelector(".modal-content");e&&(e.scrollTop=0)},100)}const i=document.createElement("div");i.style.width="100%",i.style.aspectRatio="1",i.style.marginBottom="20px",i.style.borderRadius="12px",i.style.overflow="hidden",i.style.border="1px solid rgba(139, 92, 246, 0.3)",i.className="character-image-container",t.ç»˜å›¾æ ‡ç­¾?(i.innerHTML='<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 48px">â³</div>',setTimeout(()=>{if(!renderImageTag(t.ç»˜å›¾æ ‡ç­¾,i)){const e=t.ç»˜å›¾æ ‡ç­¾.match(/image###([\s\S]*?)###/)?.[1]||"";i.innerHTML=e?`\n                        <div class="image-placeholder" onclick="copyImagePrompt('${e.replace(/'/g,"\\'")}')">\n                          <div style="font-size: 48px; margin-bottom: 8px">ğŸ–¼ï¸</div>\n                          <div style="font-size: 12px; text-align: center; padding: 0 8px">ç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤</div>\n                        </div>\n                      `:'<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 64px">ğŸ‘¤</div>'}},100)):i.innerHTML='<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 64px">ğŸ‘¤</div>',a.innerHTML=`\n              <h2 style="font-size: 28px; color: var(--primary); margin-bottom: 24px; text-align: center">${t.å§“å}</h2>\n              <div id="char-detail-image"></div>\n\n              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px">\n                <div>\n                  <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">ç¨€æœ‰åº¦</div>\n                  <div style="font-size: 20px; font-weight: bold" class="rarity-${t.ç¨€æœ‰åº¦}">${t.ç¨€æœ‰åº¦}</div>\n                </div>\n                <div>\n                  <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">èŒä¸š</div>\n                  <div style="font-size: 18px">${t.èŒä¸šèº«ä»½||"æ— "}</div>\n                </div>\n                <div>\n                  <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">ç­‰çº§</div>\n                  <div style="font-size: 20px; font-weight: bold; color: var(--accent-gold)">Lv.${t.ç­‰çº§||1}</div>\n                  <div style="font-size: 12px; color: var(--text-secondary)">ç»éªŒ: ${t.ç»éªŒå€¼||0}/${100*(t.ç­‰çº§||1)}</div>\n                </div>\n                <div>\n                  <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">æƒ…æ„ŸçŠ¶æ€</div>\n                  <div style="font-size: 16px">${t.æƒ…æ„ŸçŠ¶æ€?.å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ||"ä¸­ç«‹"}</div>\n                  <div style="font-size: 12px; color: var(--text-secondary)">å¼ºåº¦: ${t.æƒ…æ„ŸçŠ¶æ€?.æƒ…æ„Ÿå¼ºåº¦||0}</div>\n                  ${t.æƒ…æ„ŸçŠ¶æ€?.ç‰¹æ®ŠçŠ¶æ€?.length>0?`<div style="font-size: 12px; color: var(--primary); margin-top: 4px">${t.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.join(", ")}</div>`:""}\n                </div>\n                <div>\n                  <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">å…³ç³»</div>\n                  <div style="font-size: 16px; font-weight: 800; color: var(--accent-gold)">${t.å…³ç³»é˜¶æ®µ||"ä¸­ç«‹"}</div>\n                  <div style="display:flex; justify-content: space-between; gap: 10px; font-size: 12px; color: var(--text-secondary); margin-top: 6px">\n                    <div>å¥½æ„Ÿ ${t.å¥½æ„Ÿåº¦||0}/100</div>\n                    <div style="color: var(--danger)">æ¨æ„ ${t.æ¨æ„||0}/100</div>\n                  </div>\n                  <div class="stat-bar"><div class="stat-fill" style="width:${t.å¥½æ„Ÿåº¦||0}%; background: linear-gradient(90deg, var(--accent-gold), var(--primary))"></div></div>\n                  <div class="stat-bar"><div class="stat-fill" style="width:${t.æ¨æ„||0}%; background: linear-gradient(90deg, rgba(251,113,133,0.9), rgba(192,132,252,0.9))"></div></div>\n                </div>\n                <div>\n                  <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">ç»Ÿè®¡æ•°æ®</div>\n                  <div style="font-size: 12px; color: var(--text-secondary)">æ¥å®¢: ${t.æ¥å®¢æ¬¡æ•°||0}æ¬¡</div>\n                  <div style="font-size: 12px; color: var(--text-secondary)">è°ƒæ•™: ${t.è°ƒæ•™æ¬¡æ•°||0}æ¬¡</div>\n                  <div style="font-size: 12px; color: var(--accent-gold)">è´¡çŒ®: ${t.æ”¶å…¥è´¡çŒ®||0}é‡‘</div>\n                </div>\n              </div>\n\n              <div style="margin-bottom: 24px">\n                <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å±æ€§</h3>\n                ${["é­…åŠ›","é¡ºä»","æŠ€å·§","è€åŠ›","æ•æ„Ÿåº¦"].map(e=>`\n                  <div style="margin-bottom: 10px">\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px">\n                      <span>${e}</span>\n                      <span>${t.å±æ€§?.[e]||0}/100</span>\n                    </div>\n                    <div class="stat-bar">\n                      <div class="stat-fill" style="width: ${t.å±æ€§?.[e]||0}%"></div>\n                    </div>\n                  </div>\n                `).join("")}\n              </div>\n\n              <div style="margin-bottom: 24px">\n                <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">èƒŒæ™¯æ•…äº‹</h3>\n                <div style="max-height: 500px; overflow-y: auto; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word; text-align: left">\n                  ${(t.èƒŒæ™¯æ•…äº‹||"æš‚æ— èƒŒæ™¯æ•…äº‹").replace(/\n/g,"<br>")}\n                </div>\n              </div>\n\n              <div style="margin-bottom: 24px">\n                <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">äº’åŠ¨å‰§æƒ…</h3>\n                <div id="character-story-${e}" class="story-container">\n                  <div class="story-content" id="story-content-${e}" style="min-height: 150px; max-height: 500px; overflow-y: auto; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word">\n                    <div class="story-placeholder">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹äº’åŠ¨ï¼ŒAI ç”Ÿæˆçš„å‰§æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>\n                  </div>\n                </div>\n              </div>\n\n              <div style="margin-bottom: 24px">\n                <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">è¯¦ç»†ä¿¡æ¯</h3>\n                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 16px">\n                  <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px">\n                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">å…ƒç´ </div>\n                    <div style="font-size: 14px; color: var(--primary)">${(t.å…ƒç´ ||[]).join("ã€")||"æ— "}</div>\n                  </div>\n                  <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px">\n                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">æ€§åˆ«</div>\n                    <div style="font-size: 14px">${t.æ€§åˆ«||"æœªçŸ¥"}</div>\n                  </div>\n                  <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px">\n                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">ç§æ—/å‡ºèº«</div>\n                    <div style="font-size: 14px">${t.ç§æ—å‡ºèº«||"æœªçŸ¥"}</div>\n                  </div>\n                  <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px">\n                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">çŠ¶æ€</div>\n                    <div style="font-size: 14px; color: ${"ç©ºé—²"===t.çŠ¶æ€?"var(--success)":"æ¥å®¢ä¸­"===t.çŠ¶æ€?"var(--primary)":"var(--warning)"}">${t.çŠ¶æ€||"ç©ºé—²"}</div>\n                  </div>\n                  <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px">\n                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">å½“å‰ä½ç½®</div>\n                    <div style="font-size: 14px">${t.å½“å‰ä½ç½®||"ä»“åº“"}</div>\n                  </div>\n                </div>\n\n                <div style="margin-bottom: 16px">\n                  <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px">å¤–è²Œç‰¹ç‚¹</h4>\n                  <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px; font-size: 13px; line-height: 1.6">\n                    ${t.å¤–è²Œç‰¹ç‚¹||"æš‚æ— æè¿°"}\n                  </div>\n                </div>\n\n                <div style="margin-bottom: 16px">\n                  <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px">æ€§æ ¼/å–œå¥½</h4>\n                  <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px; font-size: 13px; line-height: 1.6">\n                    ${t.æ€§æ ¼å–œå¥½||"æš‚æ— æè¿°"}\n                  </div>\n                </div>\n\n                <div style="margin-bottom: 16px">\n                  <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px">ç®€ä»‹</h4>\n                  <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px; font-size: 13px; line-height: 1.6">\n                    ${t.ç®€ä»‹||"æš‚æ— ç®€ä»‹"}\n                  </div>\n                </div>\n              </div>\n\n              <div style="margin-bottom: 24px">\n                <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å¤–è²Œç»˜ç”»æç¤ºè¯ï¼ˆè‡ªåŠ¨é…å›¾ä¼šå¤ç”¨ï¼‰</h3>\n                <div style="padding: 12px; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; font-size: 12px; line-height: 1.8; white-space: pre-wrap; word-break: break-word">\n                  ${t.å¤–è²Œæç¤ºè¯||"æš‚æ— ï¼ˆå¯é€šè¿‡æŠ½å¡ç”Ÿæˆçš„ç»˜å›¾æ ‡ç­¾è‡ªåŠ¨æå–ï¼‰"}\n                </div>\n                <div style="display:flex; justify-content:flex-end; margin-top: 10px">\n                  <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px" onclick='copyImagePrompt(${JSON.stringify(t.å¤–è²Œæç¤ºè¯||"")})' ${t.å¤–è²Œæç¤ºè¯?"":"disabled"}>å¤åˆ¶æç¤ºè¯</button>\n                </div>\n              </div>\n\n              <div style="margin-bottom: 24px">\n                <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">ç‰¹æ®Šå‰§æƒ…ï¼ˆè¾¾æ ‡è‡ªåŠ¨è§£é”ï¼‰</h3>\n                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px">\n                  ${specialSceneDefs.map(n=>{const a=!!t.å·²è§£é”å‰§æƒ…?.[n.key];return`\n                        <button class="btn ${a?"":"btn-secondary"}" style="padding: 10px 12px; font-size: 12px" onclick="playSpecialScene('${e}', '${n.key}')" ${a?"":"disabled"}>\n                          ${a?"âœ¨":"ğŸ”’"} ${n.title}<div style="font-size:11px; opacity:.8; margin-top:4px">${n.req}</div>\n                        </button>\n                      `}).join("")}\n                </div>\n                <div style="margin-top: 10px; font-size: 12px; color: var(--text-secondary)">æç¤ºï¼šç‚¹å‡»æŒ‰é’®ä¼šè°ƒç”¨ AI ç”Ÿæˆå‰§æƒ…ï¼Œå¹¶è®¡ä¸º 1 å›åˆã€‚</div>\n              </div>\n\n              <div style="margin-bottom: 24px">\n                <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">æ“ä½œ</h3>\n                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px">\n                  <button class="btn btn-secondary" onclick="showTrainingInput('${e}')">ğŸ” è°ƒæ•™</button>\n                  <button class="btn btn-secondary" onclick="startInteraction('${e}', 'å¯¹è¯')">ğŸ’¬ å¯¹è¯</button>\n                  <button class="btn btn-secondary" onclick="startInteraction('${e}', 'ç‰¹æ®Šäº’åŠ¨')">âœ¨ ç‰¹æ®Šäº’åŠ¨</button>\n                  <button class="btn btn-secondary" onclick="startInteraction('${e}', 'æƒ©ç½š')">âš”ï¸ æƒ©ç½š</button>\n                  <button class="btn btn-secondary" onclick="startInteraction('${e}', 'å¥–åŠ±')">ğŸ å¥–åŠ±</button>\n                  <button class="btn" onclick="assignCharacterToBrothel('${e}')">ğŸ›ï¸ æ´¾é£æ¥å®¢</button>\n                  <button class="btn btn-secondary" onclick="addCharacterToRestRoom('${e}')">ğŸ›ï¸ é€å»ä¼‘æ¯</button>\n                  <button class="btn btn-secondary" onclick="addCharacterToMedicalRoom('${e}')">ğŸ¥ é€å»åŒ»ç–—</button>\n                  <button class="btn btn-secondary" onclick="showCharacterUpgrade('${e}')">â¬†ï¸ æå‡å±æ€§</button>\n                  <button class="btn btn-secondary" onclick="decomposeCharacter('${e}')">âš¡ åˆ†è§£</button>\n                </div>\n              </div>\n            `;const r=a.querySelector("#char-detail-image");r&&r.parentNode.replaceChild(i,r),n.classList.add("active"),n.scrollTop=0,setTimeout(()=>{const e=n.querySelector(".modal-content");e&&(e.scrollTop=0)},100)}function closeCharacterDetail(){const e=document.getElementById("character-detail-modal");e&&e.classList.remove("active")}function showTrainingInput(e){const t=gameState.è§’è‰²ä»“åº“[e];if(!t)return;const n=document.createElement("div");n.className="modal",n.id="training-input-modal",n.innerHTML=`\n                <div class="modal-content" style="max-width: 600px">\n                  <button class="modal-close" onclick="closeTrainingInput()">Ã—</button>\n                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">ğŸ” è°ƒæ•™è§’è‰²ï¼š${t.å§“å}</h2>\n\n                  <div style="margin-bottom: 16px">\n                    <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 8px">è°ƒæ•™æŒ‡ä»¤ï¼ˆæè¿°ä½ æƒ³è¦è¿›è¡Œçš„è°ƒæ•™å†…å®¹ï¼‰ï¼š</label>\n                    <textarea\n                      id="training-command-input"\n                      placeholder="ä¾‹å¦‚ï¼šä½¿ç”¨é­å­è¿›è¡Œè½»åº¦è°ƒæ•™ï¼Œé‡ç‚¹æå‡è§’è‰²çš„é¡ºä»åº¦..."\n                      style="\n                        width: 100%;\n                        min-height: 150px;\n                        padding: 12px;\n                        background: rgba(15, 23, 42, 0.6);\n                        border: 1px solid rgba(139, 92, 246, 0.3);\n                        border-radius: 12px;\n                        color: var(--text-primary);\n                        font-size: 14px;\n                        resize: vertical;\n                        font-family: inherit;\n                      "\n                    ></textarea>\n                  </div>\n\n                  <div style="display: flex; gap: 12px; justify-content: flex-end">\n                    <button class="btn btn-secondary" onclick="closeTrainingInput()">å–æ¶ˆ</button>\n                    <button class="btn" onclick="confirmTraining('${e}')">å¼€å§‹è°ƒæ•™</button>\n                  </div>\n                </div>\n              `,document.body.appendChild(n),n.classList.add("active"),setTimeout(()=>{const e=document.getElementById("training-command-input");e&&e.focus()},100)}function closeTrainingInput(){const e=document.getElementById("training-input-modal");e&&(e.classList.remove("active"),setTimeout(()=>e.remove(),300))}async function confirmTraining(e){const t=document.getElementById("training-command-input"),n=t?t.value.trim():"";if(closeTrainingInput(),!n)return void alert("è¯·è¾“å…¥è°ƒæ•™æŒ‡ä»¤ï¼");const a=document.getElementById("character-detail-modal");a&&a.classList.contains("active")?await startInteraction(e,"è°ƒæ•™",n):(showCharacterDetail(e),setTimeout(()=>{startInteraction(e,"è°ƒæ•™",n)},300))}async function startInteraction(e,t,n=""){const a=gameState.è§’è‰²ä»“åº“[e];if(!a)return;normalizeCharacter(a);const o=a.å¥½æ„Ÿåº¦||0,i=a.æ¨æ„||0,r=document.getElementById(`story-content-${e}`);r&&(r.innerHTML='<div class="story-loading">â³ AI æ­£åœ¨ç”Ÿæˆå‰§æƒ…ï¼Œè¯·ç¨å€™...</div>');const s="ã€å‰§æƒ…ç”Ÿæˆæ¨¡å¼ã€‘è¿™æ˜¯çº¯æ–‡æœ¬å‰§æƒ…ç”Ÿæˆï¼Œä¸æ˜¯è§’è‰²å¡ç”Ÿæˆã€‚\nç»å¯¹ç¦æ­¢ï¼š\n- ä¸è¦è¾“å‡ºä»»ä½•HTMLä»£ç ï¼ˆä¸è¦<style>ã€<div>ã€<script>ç­‰æ ‡ç­¾ï¼‰\n- ä¸è¦è¾“å‡ºä»£ç å—ï¼ˆä¸è¦```ï¼‰\n- ä¸è¦è¾“å‡ºè§’è‰²å¡ç•Œé¢\n- ä¸è¦è¾“å‡º<think>...</think>æˆ–<analysis>...</analysis>ï¼ˆæ€ç»´é“¾ä¸€å¾‹ä¸è¾“å‡ºï¼‰\n\nåªè¾“å‡ºï¼šçº¯æ–‡æœ¬å‰§æƒ… + <JSONPatch>æ›´æ–°</JSONPatch>\n\n";let l="";switch(t){case"è°ƒæ•™":l=n?s+`è°ƒæ•™è§’è‰²${e}ï¼ˆ${a.å§“å}ï¼‰ã€‚æ ¹æ®ä»¥ä¸‹æŒ‡ä»¤è¿›è¡Œè°ƒæ•™ï¼š\n\n${n}\n\nè¯·ç”Ÿæˆè¯¦ç»†çš„è°ƒæ•™å‰§æƒ…ï¼ŒåŒ…æ‹¬è¿‡ç¨‹ã€è§’è‰²ååº”ã€çŠ¶æ€å˜åŒ–ç­‰ã€‚`:s+`è°ƒæ•™è§’è‰²${e}ï¼ˆ${a.å§“å}ï¼‰ã€‚è¯·ç”Ÿæˆè¯¦ç»†çš„è°ƒæ•™å‰§æƒ…ï¼ŒåŒ…æ‹¬è¿‡ç¨‹ã€è§’è‰²ååº”ã€çŠ¶æ€å˜åŒ–ç­‰ã€‚`,l+=`\n\nè°ƒæ•™å†…å®¹å¯ä»¥åŒ…æ‹¬ï¼š\n- è°ƒæ•™è¿‡ç¨‹æè¿°ï¼ˆå·¥å…·ã€æ–¹æ³•ã€æ­¥éª¤ç­‰ï¼‰\n- è§’è‰²çš„èº«ä½“ååº”å’Œå¿ƒç†å˜åŒ–\n- è§’è‰²å±æ€§çš„å˜åŒ–ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ç­‰ï¼‰\n- è§’è‰²æƒ…æ„ŸçŠ¶æ€çš„å˜åŒ–\n- è°ƒæ•™åçš„çŠ¶æ€å’Œæ•ˆæœ\n\nå¿…é¡»ä½¿ç”¨JSONPatchæ ¼å¼æ›´æ–°è§’è‰²å±æ€§ï¼Œè·¯å¾„æ ¼å¼ï¼šè§’è‰²ä»“åº“/${e}/å±æ€§/é­…åŠ› ç­‰`;break;case"å¯¹è¯":l=s+`ä¸è§’è‰²${e}ï¼ˆ${a.å§“å}ï¼‰è¿›è¡Œå¯¹è¯äº’åŠ¨ã€‚è¯·ç”Ÿæˆå¯¹è¯å†…å®¹å’Œè§’è‰²ååº”ã€‚\n\nå¦‚æœéœ€è¦æ›´æ–°è§’è‰²çŠ¶æ€ï¼Œè¯·ä½¿ç”¨JSONPatchæ ¼å¼ã€‚`;break;case"ç‰¹æ®Šäº’åŠ¨":l=s+`ä¸è§’è‰²${e}ï¼ˆ${a.å§“å}ï¼‰è¿›è¡Œç‰¹æ®Šäº’åŠ¨ã€‚è¯·æ ¹æ®è§’è‰²å½“å‰çŠ¶æ€ç”Ÿæˆåˆé€‚çš„äº’åŠ¨å‰§æƒ…ã€‚\n\nå¦‚æœéœ€è¦æ›´æ–°è§’è‰²çŠ¶æ€ï¼Œè¯·ä½¿ç”¨JSONPatchæ ¼å¼ã€‚`;break;case"æƒ©ç½š":l=s+`æƒ©ç½šè§’è‰²${e}ï¼ˆ${a.å§“å}ï¼‰ã€‚è¯·ç”Ÿæˆè¯¦ç»†çš„æƒ©ç½šå‰§æƒ…ï¼ŒåŒ…æ‹¬ï¼š\n- æƒ©ç½šè¿‡ç¨‹æè¿°ï¼ˆæ–¹æ³•ã€å·¥å…·ã€å¼ºåº¦ç­‰ï¼‰\n- è§’è‰²çš„èº«ä½“ååº”å’Œå¿ƒç†å˜åŒ–\n- è§’è‰²å±æ€§çš„å˜åŒ–ï¼ˆè€åŠ›-3~10, é¡ºä»Â±5~15å–å†³äºåæŠ—ç¨‹åº¦ï¼‰\n- è§’è‰²æƒ…æ„ŸçŠ¶æ€çš„å˜åŒ–\n\nå¿…é¡»ä½¿ç”¨JSONPatchæ ¼å¼æ›´æ–°è§’è‰²å±æ€§ï¼Œè·¯å¾„æ ¼å¼ï¼šè§’è‰²ä»“åº“/${e}/å±æ€§/è€åŠ› ç­‰`;break;case"å¥–åŠ±":l=s+`å¥–åŠ±è§’è‰²${e}ï¼ˆ${a.å§“å}ï¼‰ã€‚è¯·ç”Ÿæˆè¯¦ç»†çš„å¥–åŠ±å‰§æƒ…ï¼ŒåŒ…æ‹¬ï¼š\n- å¥–åŠ±å†…å®¹æè¿°ï¼ˆç¤¼ç‰©ã€ç‰¹æƒã€å…³æ€€ç­‰ï¼‰\n- è§’è‰²çš„ååº”å’Œæƒ…ç»ªå˜åŒ–\n- è§’è‰²å±æ€§çš„å˜åŒ–\n\nå¿…é¡»ä½¿ç”¨JSONPatchæ ¼å¼æ›´æ–°è§’è‰²å±æ€§ï¼Œè·¯å¾„æ ¼å¼ï¼šè§’è‰²ä»“åº“/${e}/å±æ€§/é­…åŠ› ç­‰`;break;default:l=s+`ä¸è§’è‰²${e}ï¼ˆ${a.å§“å}ï¼‰è¿›è¡Œ${t}äº’åŠ¨ã€‚`}n&&"è°ƒæ•™"!==t&&(l+=`\n\né™„åŠ æŒ‡ä»¤ï¼š\n${n}`);try{const n=await sendCommandToAI(l,!0);if(n&&r){let s=n;const l=s.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/);if(l){try{applyJSONPatches(JSON.parse(cleanJsonString(l[1])))}catch(e){console.error("è§£æ JSON Patch å¤±è´¥:",e)}s=s.replace(/<JSONPatch>[\s\S]*?<\/JSONPatch>/,"").trim()}if(s=s.replace(/<UpdateVariable>[\s\S]*?<\/UpdateVariable>/,"").trim(),s=s.replace(/<Analysis>[\s\S]*?<\/Analysis>/,"").trim(),s=filterHtmlFromStory(s),normalizeCharacter(a),(a.å¥½æ„Ÿåº¦||0)===o&&(a.æ¨æ„||0)===i&&("å¥–åŠ±"===t?a.å¥½æ„Ÿåº¦=clampNumber((a.å¥½æ„Ÿåº¦||0)+randInt(2,4),0,100):"æƒ©ç½š"===t?a.æ¨æ„=clampNumber((a.æ¨æ„||0)+randInt(2,4),0,100):"å¯¹è¯"===t?a.å¥½æ„Ÿåº¦=clampNumber((a.å¥½æ„Ÿåº¦||0)+1,0,100):"è°ƒæ•™"===t&&(rand01()<.55?a.å¥½æ„Ÿåº¦=clampNumber((a.å¥½æ„Ÿåº¦||0)+1,0,100):a.æ¨æ„=clampNumber((a.æ¨æ„||0)+1,0,100)),a.å…³ç³»é˜¶æ®µ=computeRelationshipStage(a.å¥½æ„Ÿåº¦,a.æ¨æ„),saveGameStateToMVU()),"undefined"!=typeof formatAsDisplayedMessage&&(s=formatAsDisplayedMessage(s)),window._lastSpecialScene&&window._lastSpecialScene.characterId===e){const e=window._lastSpecialScene.sceneKey;a.å‰§æƒ…æ¡£æ¡ˆ=a.å‰§æƒ…æ¡£æ¡ˆ||{},a.å‰§æƒ…æ¡£æ¡ˆ[e]=s,window._lastSpecialScene=null,saveGameStateToMVU()}renderStoryWithAutoImage(r,s,e,{scene:t,roomType:"äº’åŠ¨"}),checkRelationshipTriggers(e,t),advanceRound()}}catch(e){console.error("ç”Ÿæˆå‰§æƒ…å¤±è´¥:",e),r&&(r.innerHTML='<div class="story-placeholder" style="color: var(--danger)">ç”Ÿæˆå‰§æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>')}}function copyImagePrompt(e){navigator.clipboard.writeText(e).then(()=>{alert("ç»˜ç”»æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼")})}function filterHtmlFromStory(e){if(!e||"string"!=typeof e)return"";let t=e;const n=t.match(/<æ­£æ–‡>([\s\S]*?)<\/æ­£æ–‡>/);if(n&&n[1].trim().length>0&&(t=n[1].trim()),t=t.replace(/<think[^>]*>[\s\S]*?<\/think>/gi,""),t=t.replace(/<analysis[^>]*>[\s\S]*?<\/analysis>/gi,""),t=t.replace(/<think[^>]*>[\s\S]*$/gi,""),t=t.replace(/<analysis[^>]*>[\s\S]*$/gi,""),t=t.replace(/<summary[^>]*>[\s\S]*?<\/summary>/gi,""),t.includes("<!DOCTYPE")||t.includes("<html")||t.includes("<head>")){const e=t.match(/<æ­£æ–‡>([\s\S]*?)<\/æ­£æ–‡>/);e&&e[1].trim().length>50?t=e[1].trim():(t=t.replace(/<script[\s\S]*?<\/script>/gi,""),t=t.replace(/<style[\s\S]*?<\/style>/gi,""),t=t.replace(/<head[\s\S]*?<\/head>/gi,""),t=t.replace(/<[^>]+>/g,""),t=t.replace(/&nbsp;/gi," "),t=t.replace(/&lt;/gi,"<"),t=t.replace(/&gt;/gi,">"),t=t.replace(/&amp;/gi,"&"),t=t.replace(/&quot;/gi,'"'))}t=t.replace(/<!DOCTYPE[^>]*>/gi,""),t=t.replace(/<\/?html[^>]*>/gi,""),t=t.replace(/<\/?head[^>]*>/gi,""),t=t.replace(/<\/?body[^>]*>/gi,""),t=t.replace(/<meta[^>]*\/?>/gi,""),t=t.replace(/<link[^>]*\/?>/gi,""),t=t.replace(/<title[^>]*>[\s\S]*?<\/title>/gi,""),t=t.replace(/<script[\s\S]*?<\/script>/gi,""),t=t.replace(/<style[\s\S]*?<\/style>/gi,"");for(let e=0;e<5;e++)t=t.replace(/<div[^>]*>|<\/div>/gi,""),t=t.replace(/<section[^>]*>|<\/section>/gi,""),t=t.replace(/<span[^>]*>|<\/span>/gi,""),t=t.replace(/<p[^>]*>|<\/p>/gi,"\n"),t=t.replace(/<br\s*\/?>/gi,"\n");if(t=t.replace(/```[\s\S]*?```/g,""),t=t.replace(/\n{4,}/g,"\n\n"),t=t.replace(/[ \t]{2,}/g," "),t=t.trim(),/(<!DOCTYPE|<html|<head|<\/script>|<\/style>|\bfunction\b|\bconst\b|\blet\b|\bvar\b|=>)/i.test(t)&&(t=t.replace(/^\s*(const|let|var)\b.*$/gm,"").replace(/^\s*function\b.*$/gm,"").replace(/^\s*(if|for|while|switch)\s*\(.*$/gm,"").replace(/^\s*[{}();]+\s*$/gm,"").replace(/^\s*<\/?[a-z][^>]*>\s*$/gim,"").trim()),t.length<20&&e.length>100){console.warn("filterHtmlFromStory: è¿‡æ»¤åæ–‡æœ¬å¤ªçŸ­ï¼Œå¯èƒ½AIè¾“å‡ºäº†çº¯HTML");let n=e.replace(/<[^>]+>/g," ");n=n.replace(/\s+/g," ").trim(),n.length>t.length&&(t=n)}return t}function clampNumber(e,t,n){const a=Number.isFinite(e)?e:t;return Math.max(t,Math.min(n,a))}function extractAllImagePrompts(e){if(!e||"string"!=typeof e)return[];return[...e.matchAll(/image###([\s\S]*?)###/g)].map(e=>(e?.[1]||"").trim()).filter(Boolean)}function normalizePromptText(e){return e?e.replace(/\s+/g," ").replace(/\s*,\s*/g,", ").trim():""}function extractAppearanceOnly(e){if(!e||"string"!=typeof e)return"";let t=e.replace(/\{split image\}/gi,"").replace(/\{two panels\}/gi,"").replace(/\{consistent character\}/gi,"").replace(/\{consistent physique\}/gi,"").replace(/\{1man[^}]*\}/gi,"").replace(/\{1girl[^}]*\}/gi,"").replace(/\{2girls[^}]*\}/gi,"").replace(/\{solo[^}]*\}/gi,"");const n=["tall","short","petite","slim","curvy","athletic","muscular","plump","thin","hourglass","flat chest","small breasts","medium breasts","large breasts","huge breasts","wide hips","narrow waist","long legs","short legs","pale skin","tan skin","dark skin","fair skin","olive skin","white skin","hair","long hair","short hair","medium hair","curly hair","straight hair","wavy hair","blonde","brunette","black hair","brown hair","red hair","silver hair","white hair","blue hair","green hair","pink hair","purple hair","orange hair","gray hair","ponytail","twintails","braid","bob cut","bangs","sidecut","eyes","eye color","blue eyes","green eyes","brown eyes","black eyes","red eyes","purple eyes","golden eyes","heterochromia","large eyes","small eyes","face","round face","oval face","sharp features","soft features","pointed chin","small nose","button nose","high cheekbones","dimples","freckles","dress","skirt","shirt","pants","jacket","coat","uniform","kimono","robe","silk","cotton","leather","lace","velvet","satin","red","blue","green","black","white","purple","pink","yellow","orange","elf","human","demon","angel","vampire","werewolf","fairy","dragon","pointed ears","horns","wings","tail","fangs","claws","tattoo","scar","birthmark","mole","piercing","masterpiece","best quality","high quality","detailed","8k","4k"];return normalizePromptText(t.split(",").map(e=>e.trim()).filter(Boolean).filter(e=>{const t=e.toLowerCase();if(n.some(e=>t.includes(e)))return!0;return!["smile","cry","laugh","angry","sad","happy","expression","sitting","standing","lying","kneeling","pose","action","background","indoor","outdoor","room","bed","chair","table","lighting","sunlight","moonlight","candlelight","dark","bright","nude","naked","clothed","undressing","sex","nsfw","erotic","rape","bondage","bdsm","tied","gag","whip","toy"].some(e=>t.includes(e))&&(e.length<30&&!/[(){}]/.test(e))}).join(", "))}function ensureCharacterPrompts(e){if(!e||"object"!=typeof e)return;if("string"==typeof e.å¤–è²Œæç¤ºè¯&&e.å¤–è²Œæç¤ºè¯.trim().length>10)return;const t=extractAllImagePrompts(e.ç»˜å›¾æ ‡ç­¾||"");if(t.length>0){const n=t.join(", ");if(e.å¤–è²Œæç¤ºè¯=extractAppearanceOnly(n),t.length>1){const n=extractAppearanceOnly(t[t.length-1]);if(n&&n!==e.å¤–è²Œæç¤ºè¯){const t=`${e.å¤–è²Œæç¤ºè¯}, ${n}`,a=[...new Set(t.split(",").map(e=>e.trim()))];e.å¤–è²Œæç¤ºè¯_NSFW=normalizePromptText(a.join(", "))}else e.å¤–è²Œæç¤ºè¯_NSFW=e.å¤–è²Œæç¤ºè¯}else e.å¤–è²Œæç¤ºè¯_NSFW=e.å¤–è²Œæç¤ºè¯;return}"string"==typeof e.å¤–è²Œç‰¹ç‚¹&&e.å¤–è²Œç‰¹ç‚¹.trim().length>0&&(e.å¤–è²Œæç¤ºè¯=normalizePromptText(e.å¤–è²Œç‰¹ç‚¹),e.å¤–è²Œæç¤ºè¯_NSFW=e.å¤–è²Œæç¤ºè¯)}function ensureCharacterRelationship(e){if(e&&"object"==typeof e){if(!Number.isFinite(e.å¥½æ„Ÿåº¦)||!Number.isFinite(e.æ¨æ„)){const t=e.æƒ…æ„ŸçŠ¶æ€?.å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ||"ä¸­ç«‹",n=clampNumber(e.æƒ…æ„ŸçŠ¶æ€?.æƒ…æ„Ÿå¼ºåº¦??0,0,100);let a=20,o=0;"çˆ±"===t?a=65:"å–œæ¬¢"===t?a=45:"ä¸­ç«‹"===t?a=25:"åŒæ¶"===t?o=45:"æ†æ¨"===t&&(o=65),e.å¥½æ„Ÿåº¦=clampNumber(Math.round(a+.2*n),0,100),e.æ¨æ„=clampNumber(Math.round(o+.2*n),0,100)}e.å¥½æ„Ÿåº¦=clampNumber(e.å¥½æ„Ÿåº¦,0,100),e.æ¨æ„=clampNumber(e.æ¨æ„,0,100),e.å·²è§£é”å‰§æƒ…&&"object"==typeof e.å·²è§£é”å‰§æƒ…||(e.å·²è§£é”å‰§æƒ…={}),e.å‰§æƒ…æ¡£æ¡ˆ&&"object"==typeof e.å‰§æƒ…æ¡£æ¡ˆ||(e.å‰§æƒ…æ¡£æ¡ˆ={}),e.å…³ç³»é˜¶æ®µ=computeRelationshipStage(e.å¥½æ„Ÿåº¦,e.æ¨æ„)}}function computeRelationshipStage(e,t){const n=clampNumber(e,0,100),a=clampNumber(t,0,100);return a>=90?"æ·±ä»‡":a>=70?"æ•Œè§†":a>=50?"åŒæ¶":n>=90?"æ²‰æºº":n>=70?"äº²è¿‘":n>=50?"å¥½æ„Ÿ":"ä¸­ç«‹"}function normalizeCharacter(e){return e&&"object"==typeof e?(e.å±æ€§&&"object"==typeof e.å±æ€§||(e.å±æ€§={}),["é­…åŠ›","é¡ºä»","æŠ€å·§","è€åŠ›","æ•æ„Ÿåº¦"].forEach(t=>{Number.isFinite(e.å±æ€§[t])||(e.å±æ€§[t]=30),e.å±æ€§[t]=clampNumber(e.å±æ€§[t],0,100)}),e.æƒ…æ„ŸçŠ¶æ€&&"object"==typeof e.æƒ…æ„ŸçŠ¶æ€||(e.æƒ…æ„ŸçŠ¶æ€={"å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ":"ä¸­ç«‹","æƒ…æ„Ÿå¼ºåº¦":0,"ç‰¹æ®ŠçŠ¶æ€":[]}),Array.isArray(e.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€)||(e.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€=[]),ensureCharacterPrompts(e),ensureCharacterRelationship(e),e):e}function normalizeAllCharacters(){gameState.è§’è‰²ä»“åº“&&"object"==typeof gameState.è§’è‰²ä»“åº“&&Object.values(gameState.è§’è‰²ä»“åº“).forEach(e=>normalizeCharacter(e))}function checkRelationshipTriggers(e,t=""){const n=gameState.è§’è‰²ä»“åº“?.[e];if(!n)return;normalizeCharacter(n);let a=!1;[{key:"aff_70",type:"å¥½æ„Ÿ",threshold:70,title:"ç§å¯†é‚€çº¦",desc:"å¥½æ„Ÿè¾¾åˆ°70ï¼šè§£é”ä¸€æ¬¡ç§å¯†é‚€çº¦"},{key:"aff_90",type:"å¥½æ„Ÿ",threshold:90,title:"èª“çº¦æ—¶åˆ»",desc:"å¥½æ„Ÿè¾¾åˆ°90ï¼šè§£é”èª“çº¦æ—¶åˆ»"},{key:"hate_70",type:"æ¨æ„",threshold:70,title:"æš—æ½®åå™¬",desc:"æ¨æ„è¾¾åˆ°70ï¼šè§£é”æš—æ½®åå™¬"},{key:"hate_90",type:"æ¨æ„",threshold:90,title:"è£‚éš™é€ƒäº¡",desc:"æ¨æ„è¾¾åˆ°90ï¼šè§£é”è£‚éš™é€ƒäº¡"}].forEach(o=>{if(n.å·²è§£é”å‰§æƒ…[o.key])return;("å¥½æ„Ÿ"===o.type?n.å¥½æ„Ÿåº¦:n.æ¨æ„)>=o.threshold&&(n.å·²è§£é”å‰§æƒ…[o.key]=!0,a=!0,pushBrothelLog({"æ—¶é—´æˆ³":getGameTime().å½“å‰å›åˆ||1,"è§’è‰²ID":e,"äº‹ä»¶ç±»å‹":"è§£é”å‰§æƒ…","æè¿°":`${n.å§“å} è§£é”å‰§æƒ…ã€${o.title}ã€‘${t?`ï¼ˆå› ï¼š${t}ï¼‰`:""}`,"æ”¶å…¥å˜åŒ–":0}))}),a&&saveGameStateToMVU()}function buildAutoImageTag(e,t={}){const n=gameState.è§’è‰²ä»“åº“?.[e];if(!n)return"";normalizeCharacter(n);const a=t?.scene&&["æ¥å®¢","è°ƒæ•™","è®­ç»ƒ","ç‰¹æ®Šäº’åŠ¨"].some(e=>String(t.scene).includes(e));let o=(a?n.å¤–è²Œæç¤ºè¯_NSFW||n.å¤–è²Œæç¤ºè¯:n.å¤–è²Œæç¤ºè¯||"").trim();if(!o||o.length<20){const e=extractAllImagePrompts(n.ç»˜å›¾æ ‡ç­¾||"");e.length>0&&(o=normalizePromptText(e[0]),o&&o.length>10&&(n.å¤–è²Œæç¤ºè¯=o,e.length>1&&(n.å¤–è²Œæç¤ºè¯_NSFW=normalizePromptText(e[e.length-1]))))}!o&&n.å¤–è²Œç‰¹ç‚¹&&(o=`1person, ${n.å¤–è²Œç‰¹ç‚¹}`),o||(o=`1person, ${n.å§“å||"character"}, portrait`);const i=analyzeStoryForImageTags(t.storyText||"",a),r=["masterpiece","best quality","highly detailed","8k","detailed face","detailed eyes"],s=[];(a||i.isNSFW)&&(s.push("nsfw","explicit"),r.push("detailed body","detailed skin"));const l=getGameTime(),c=["dark fantasy"];if(t.roomType){const e={"æ™®é€š":"bedroom, bed",VIP:"luxury bedroom, silk sheets, chandelier","è°ƒæ•™å®¤":"dungeon, chains, leather, dim red light","å±•ç¤ºå®¤":"display room, stage, spotlight","æƒ…è¶£æˆ¿":"erotic room, love hotel, pink lighting","ä¼‘æ¯å®¤":"rest room, sofa","åŒ»ç–—å®¤":"medical room, examination table"};c.push(e[t.roomType]||t.roomType)}c.push("æ™šä¸Š"===l.å½“å‰æ—¶æ®µ?"candlelight, dim lighting, night, warm glow":"ä¸­åˆ"===l.å½“å‰æ—¶æ®µ?"soft daylight, bright, noon":"morning light, soft, dawn");const d=normalizePromptText([...s,...r,o,...i.bodyParts,...i.actions,...i.expressions,...i.clothing,...i.extras,...c].join(", "));return console.info("åŠ¨æ€å›¾ç‰‡æç¤ºè¯:",d.substring(0,150)+"..."),`image###${d}###`}function analyzeStoryForImageTags(e,t=!1){const n={isNSFW:!1,bodyParts:[],actions:[],expressions:[],clothing:[],extras:[]};if(!e)return n;const a=e.toLowerCase(),o={"èƒ¸|ä¹³|å¥¶|èƒ¸éƒ¨|ä¹³æˆ¿|é…¥èƒ¸|åŒå³°|ä¹³å°–|ä¹³æ™•|ä¹³å¤´|å·¨ä¹³|è´«ä¹³|ç¾ä¹³":"breasts, chest","å¤§èƒ¸|ä¸°æ»¡çš„èƒ¸|é¥±æ»¡çš„èƒ¸|å·¨ä¹³":"large breasts, cleavage","å°èƒ¸|è´«ä¹³|å¹³èƒ¸":"small breasts, flat chest","ä¹³æ²Ÿ|äº‹ä¸šçº¿":"cleavage","ä¹³å¤´|ä¹³å°–|ä¹³æ™•":"nipples, areola","è‡€|å±è‚¡|ç¿˜è‡€|ç¾è‡€|è‡€éƒ¨|èœœæ¡ƒè‡€":"ass, buttocks","ç¿˜è‡€|ç¾è‡€|èœœæ¡ƒè‡€":"round ass, beautiful buttocks","è…¿|å¤§è…¿|å°è…¿|ç¾è…¿|é•¿è…¿|ç‰è…¿":"legs, thighs","å¤§è…¿|ç²—è…¿|è‚‰è…¿":"thick thighs","ä¿®é•¿çš„è…¿|é•¿è…¿|ç¾è…¿":"long legs, slender legs","ç§å¤„|ä¸‹ä½“|ç§˜å¤„|èŠ±ç©´|èœœç©´|é˜´|å°ç©´|è‚‰ç©´":"pussy, vulva, labia","é˜´è’‚|èŠ±æ ¸|è‚‰è’‚":"clitoris","é˜´å”‡|è‚‰å”‡":"labia","è‚‰æ£’|é˜³å…·|èŒ|é¾Ÿå¤´|ç¾ä¸¸|è›‹è›‹":"penis, cock, balls, glans","èŠç©´|åç©´|è‚›|ååº­":"anus, asshole","è…°|ç»†è…°|çº¤è…°|è…°è‚¢":"waist, slim waist","è‚š|å°è…¹|è…¹éƒ¨":"belly, abdomen","è‚šè„|è„":"navel","è„–|é¢ˆ|è„–å­|é¢ˆéƒ¨":"neck","è‚©|é¦™è‚©|è‚©è†€":"shoulders","èƒŒ|åèƒŒ|è„ŠèƒŒ":"back","æ‰‹|æ‰‹æŒ‡|ç‰æ‰‹|çº¤æ‰‹":"hands, fingers","è„š|ç‰è¶³|è¶³|è„šè¶¾":"feet, toes","èˆŒ|èˆŒå¤´|é¦™èˆŒ":"tongue","å”‡|å˜´å”‡|çº¢å”‡|æ¨±å”‡":"lips","è„¸|é¢|é¢åº|è„¸é¢Š":"face","çœ¼|çœ¼ç›|ç¾çœ¸|çœ¼çœ¸":"eyes"};for(const[e,t]of Object.entries(o)){new RegExp(e,"i").test(a)&&(n.bodyParts.push(t),["ç§å¤„","ä¸‹ä½“","é˜´","ç©´","è‚‰æ£’","é˜³å…·","èŒ","èŠç©´","åç©´","è‚›"].some(e=>a.includes(e))&&(n.isNSFW=!0))}const i={"æ’å…¥|è¿›å…¥|æŠ½æ’|å†²åˆº|å¾‹åŠ¨|æŠ½é€|é¡¶å¼„|è´¯ç©¿":"penetration, sex, fucking","éª‘ä¹˜|éª‘åœ¨|ååœ¨.*ä¸Š":"cowgirl position, riding","åå…¥|ä»å|èƒŒå":"doggy style, from behind","æ­£å¸¸ä½|ä¼ æ•™å£«|é¢å¯¹é¢":"missionary position","ä¾§å…¥|ä¾§å§":"side position, spooning","å£äº¤|å«ä½|åå|èˆ”å¼„|èˆ”èˆ":"oral sex, blowjob, licking","æ·±å–‰|å–‰å’™":"deepthroat","èˆ”|å®å¸|å®":"licking, sucking","æ‰‹æ·«|æ’¸|è‡ªæ…°|æ‰‹æŒ‡.*æ’":"masturbation, fingering","è¶³äº¤|ç”¨è„š":"footjob","ä¹³äº¤|èƒ¸æ¨|å¤¹":"paizuri, titfuck","é¢œå°„|å°„åœ¨è„¸ä¸Š":"facial","å†…å°„|å°„è¿›|å°„åœ¨é‡Œé¢":"creampie","æ½®å¹|å–·|é«˜æ½®":"squirting, orgasm","å¤šäºº|è½®|ç¾¤":"group sex, gangbang","èºº|å¹³èºº|ä»°å§":"lying down, on back","è¶´|ä¿¯å§|è¶´ç€":"lying face down, prone","è·ª|è·ªç€|è·ªä¸‹":"kneeling","ç«™|ç«™ç«‹|ç«™ç€":"standing","å|åç€":"sitting","å¼¯è…°|ä¿¯èº«":"bending over","æŠ¬è…¿|å¼ å¼€è…¿|åˆ†å¼€è…¿|Må­—å¼€è…¿":"spread legs, legs apart","æŠ±|æ‹¥æŠ±|æ‚":"embrace, hugging","å»|äº²å»|æ¥å»":"kissing","æŠšæ‘¸|è§¦æ‘¸|çˆ±æŠš|æ‰|æ":"touching, caressing, groping","ç»‘|æ†|æŸç¼š|ç»‘ä½":"bondage, tied up, bound","è’™çœ¼|çœ¼ç½©":"blindfolded","é­æ‰“|æŠ½æ‰“|æ‰“å±è‚¡":"spanking, whipping","å¤¹|ä¹³å¤¹|é˜´å¤¹":"clamps, nipple clamps","å¡|è‚›å¡|è·³è›‹":"plug, vibrator, sex toy","é¡¹åœˆ|é¢ˆåœˆ|ç‰µå¼•":"collar, leash","æ‰‹é“|è„šé“|é•£é“":"handcuffs, shackles","åŠ|æ‚¬åŠ":"suspension"};for(const[e,t]of Object.entries(i)){new RegExp(e,"i").test(a)&&(n.actions.push(t),["æ’å…¥","æŠ½æ’","éª‘ä¹˜","åå…¥","å£äº¤","æ·±å–‰","æ‰‹æ·«","è¶³äº¤","ä¹³äº¤","é¢œå°„","å†…å°„","æ½®å¹","é«˜æ½®","è½®","ç¾¤"].some(e=>a.includes(e))&&(n.isNSFW=!0))}const r={"ç¾|å®³ç¾|ç¾æ¶©|è„¸çº¢|ç¾çº¢":"blush, embarrassed, shy","åªš|å¦©åªš|å‹¾äºº|åªšçœ¼":"seductive, alluring, bedroom eyes","å“­|æ³ª|æµæ³ª|å“­æ³£|æ³ªæµ":"crying, tears","ç¬‘|å¾®ç¬‘|å‚»ç¬‘|æ·«ç¬‘":"smiling","å‘»åŸ|å–˜|å–˜æ¯|å¨‡å–˜":"moaning, panting, ahegao","ç—›|ç—›è‹¦|ç–¼ç—›":"pain, painful expression","çˆ½|å¿«æ„Ÿ|èˆ’æœ|äº«å—":"pleasure, enjoying, ecstasy","ææƒ§|å®³æ€•|æƒŠæ":"fear, scared","æ„¤æ€’|ç”Ÿæ°”|æ€’":"angry","èŒ«ç„¶|è¿·ç¦»|å¤±ç¥|ææƒš":"dazed, unfocused eyes, trance","ç¿»ç™½çœ¼|ç™½çœ¼|å¤±ç¥":"rolling eyes, ahegao","å¼ å˜´|å¼ å¼€å˜´|Oå‹å˜´|å£å‹":"open mouth, o-face","å’¬å”‡|å’¬å˜´å”‡":"biting lip","åèˆŒ|ä¼¸èˆŒ":"tongue out"};for(const[e,t]of Object.entries(r)){new RegExp(e,"i").test(a)&&n.expressions.push(t)}const s={"è£¸|å…¨è£¸|èµ¤è£¸|ä¸€ä¸ä¸æŒ‚|å…‰ç€":"nude, naked, fully nude","åŠè£¸|è¢’èƒ¸|éœ²å‡º":"partially nude, exposed","å†…è¡£|èƒ¸ç½©|bra|æ–‡èƒ¸":"bra, lingerie","å†…è£¤|å°å†…å†…|ä¸å­—è£¤":"panties, underwear, thong","æƒ…è¶£å†…è¡£|æ€§æ„Ÿå†…è¡£":"sexy lingerie, erotic underwear","ä¸è¢œ|é»‘ä¸|ç™½ä¸|åŠå¸¦è¢œ":"stockings, thigh highs, garter belt","é«˜è·Ÿ|é«˜è·Ÿé‹":"high heels","åˆ¶æœ|å¥³ä»†|æŠ¤å£«|å­¦ç”Ÿ":"uniform, maid outfit, nurse outfit, school uniform","æ——è¢|å’Œæœ|æ±‰æœ":"qipao, kimono, hanfu","çš®è¡£|çš®é©|latex|ä¹³èƒ¶":"leather, latex","å›´è£™|åªç©¿å›´è£™":"apron, naked apron","æ•å¼€|è§£å¼€|æ‹‰å¼€":"clothes pulled aside, unbuttoned","æ’©èµ·|æ€èµ·|æ‹‰èµ·":"lifted skirt, pulled up","è„±|è¤ªä¸‹|æ‰¯ä¸‹":"undressing, clothes removed","æ¹¿é€|æµ¸æ¹¿|é€æ˜":"wet clothes, see-through","ç ´æŸ|æ’•è£‚|è¡£è¡«ä¸æ•´":"torn clothes, disheveled"};for(const[e,t]of Object.entries(s)){new RegExp(e,"i").test(a)&&(n.clothing.push(t),["è£¸","å…¨è£¸","åŠè£¸","è¢’èƒ¸","éœ²å‡º"].some(e=>a.includes(e))&&(n.isNSFW=!0))}const l={"ç²¾æ¶²|ç™½æµŠ|æµ“ç¨ |å°„|æº…":"cum, semen, ejaculation","çˆ±æ¶²|æ·«æ°´|èœœæ¶²|æ¹¿æ¶¦|æ¿¡æ¹¿":"love juice, wet, dripping","æ±—|æ±—æ°´|æ±—ç |é¦™æ±—":"sweat, sweaty","å£æ°´|å”¾æ¶²|æ¶":"saliva, drool","çº¢ç—•|å»ç—•|å’¬ç—•|æŠ“ç—•":"marks, hickey, bite marks","ç»³|ç»³å­|éº»ç»³|çº¢ç»³":"rope, shibari","èœ¡çƒ›|èœ¡æ²¹|æ»´èœ¡":"candle, wax play","å†°å—|å†°":"ice","çš®é­|é­å­":"whip","éœ‡åŠ¨æ£’|æŒ‰æ‘©æ£’|è·³è›‹|é“å…·":"vibrator, dildo, sex toy","é•œå­|ç…§é•œå­":"mirror","çª—|çª—æˆ·|çª—è¾¹":"window","æµ´å®¤|æµ´ç¼¸|æ·‹æµ´":"bathroom, bathtub, shower"};for(const[e,t]of Object.entries(l)){new RegExp(e,"i").test(a)&&(n.extras.push(t),["ç²¾æ¶²","ç™½æµŠ","å°„","çˆ±æ¶²","æ·«æ°´"].some(e=>a.includes(e))&&(n.isNSFW=!0))}return n.bodyParts=[...new Set(n.bodyParts)],n.actions=[...new Set(n.actions)],n.expressions=[...new Set(n.expressions)],n.clothing=[...new Set(n.clothing)],n.extras=[...new Set(n.extras)],t&&!n.isNSFW&&(n.isNSFW=!0),n}function renderStoryWithAutoImage(e,t,n,a={}){if(!e)return;const o=!1!==gameState.è®¾ç½®?.è‡ªåŠ¨é…å›¾,i={...a,storyText:t},r=o?buildAutoImageTag(n,i):"";console.info("è‡ªåŠ¨é…å›¾:",o?"å¯ç”¨":"ç¦ç”¨","| è§’è‰²:",n,"| å›¾ç‰‡æ ‡ç­¾:",r?r.substring(0,120)+"...":"(æ— )");const s=r?'\n                  <div\n                    class="image-prompt-area"\n                    style="\n                      display: block;\n                      min-height: 50px;\n                      margin: 0 0 14px 0;\n                      padding: 10px;\n                      border-radius: 16px;\n                      border: 1px solid rgba(255,255,255,0.12);\n                      background: rgba(255,255,255,0.04);\n                      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);\n                    "\n                  ></div>\n                ':"";if(e.innerHTML=`${s}<div class="story-content">${t}</div>`,r){const t=e.querySelector(".image-prompt-area");t&&renderImageTag(r,t)}}const specialSceneDefs=[{key:"aff_70",title:"ç§å¯†é‚€çº¦",req:"å¥½æ„Ÿâ‰¥70",flavor:"ä½è¯­ã€çƒ›å…‰ã€è¿‘è·ç¦»çš„è¯•æ¢ã€‚"},{key:"aff_90",title:"èª“çº¦æ—¶åˆ»",req:"å¥½æ„Ÿâ‰¥90",flavor:"äº¤æ¢èª“è¨€ä¸ç§˜å¯†ï¼Œå…³ç³»è¿›å…¥æ›´æ·±å±‚ã€‚"},{key:"hate_70",title:"æš—æ½®åå™¬",req:"æ¨æ„â‰¥70",flavor:"æ²‰é»˜çš„åå™¬ä¸å±é™©çš„æ‹‰æ‰¯ã€‚"},{key:"hate_90",title:"è£‚éš™é€ƒäº¡",req:"æ¨æ„â‰¥90",flavor:"å…³ç³»æ¿’ä¸´å´©åï¼Œå¿…é¡»åšå‡ºé€‰æ‹©ã€‚"}];function playSpecialScene(e,t){const n=gameState.è§’è‰²ä»“åº“?.[e];if(!n)return;if(normalizeCharacter(n),!n.å·²è§£é”å‰§æƒ…?.[t])return void alert("è¯¥å‰§æƒ…å°šæœªè§£é”ã€‚");const a=specialSceneDefs.find(e=>e.key===t);if(!a)return;window._lastSpecialScene={characterId:e,sceneKey:t,title:a.title,atRound:getGameTime().å½“å‰å›åˆ||1};startInteraction(e,"ç‰¹æ®Šäº’åŠ¨",`ã€ç‰¹æ®Šå‰§æƒ…ï¼š${a.title}ã€‘\nè§¦å‘æ¡ä»¶ï¼š${a.req}\næ°›å›´æç¤ºï¼š${a.flavor}\n\nè¦æ±‚ï¼šæˆäººå‘æ°›å›´ä½†å¿…é¡»ä¸ºã€æˆå¹´äººåˆæ„ã€‘ä¸”ä¸åŒ…å«å¼ºè¿«/æ€§ä¾µ/æœªæˆå¹´/è¡€è…¥çŒå¥‡ç­‰ã€‚å¿…è¦æ—¶å¯ç”¨JSONPatchå¾®è°ƒå¥½æ„Ÿåº¦/æ¨æ„ï¼ˆ0~100ï¼‰ã€‚`)}async function assignCharacterToBrothel(e){const t=gameState.è§’è‰²ä»“åº“[e];if(!t)return;const n=Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).filter(([e,t])=>"ç©ºé—²"===t.çŠ¶æ€&&!["è°ƒæ•™å®¤","ä¼‘æ¯å®¤","åŒ»ç–—å®¤"].includes(t.ç±»å‹)).map(([e,t])=>e);if(0===n.length)return void alert("æ²¡æœ‰ç©ºé—²æˆ¿é—´ï¼");const a=prompt(`é€‰æ‹©æˆ¿é—´åˆ†é…ç»™ ${t.å§“å}\nå¯ç”¨æˆ¿é—´: ${n.join(", ")}`,n[0]);a&&n.includes(a)&&(closeCharacterDetail(),await assignCharacterToRoom(e,a))}function trainCharacter(e){startInteraction(e,"è°ƒæ•™")}function decomposeCharacter(e){confirm(`ç¡®å®šè¦åˆ†è§£ ${gameState.è§’è‰²ä»“åº“[e].å§“å} å—ï¼Ÿ`)&&(sendCommandToAI(`åˆ†è§£è§’è‰²${e}`),closeCharacterDetail())}function selectCharacterForRoom(e){const t=Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).filter(([e,t])=>"ç©ºé—²"===t.çŠ¶æ€&&!["è°ƒæ•™å®¤","ä¼‘æ¯å®¤","åŒ»ç–—å®¤"].includes(t.ç±»å‹)).map(([e,t])=>e);if(0===t.length)return void alert("æ²¡æœ‰ç©ºé—²æˆ¿é—´ï¼");const n=prompt(`é€‰æ‹©æˆ¿é—´ (${t.join(", ")})`,t[0]);n&&t.includes(n)&&assignCharacterToRoom(e,n)}function showRoomAssignment(e){const t=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[e];if(!t)return;if("è°ƒæ•™å®¤"===t.ç±»å‹)return void openTrainingAssignment(e);if("ç©ºé—²"!==t.çŠ¶æ€)return void alert("æˆ¿é—´æ­£åœ¨ä½¿ç”¨ä¸­ã€‚");const n=Object.entries(gameState.è§’è‰²ä»“åº“).filter(([e,t])=>"ç©ºé—²"===t.çŠ¶æ€&&"ä»“åº“"===t.å½“å‰ä½ç½®).map(([e,t])=>({id:e,name:t.å§“å}));if(0===n.length)return void alert("æ²¡æœ‰å¯åˆ†é…çš„è§’è‰²ï¼");const a=n.map((e,t)=>`${t+1}. ${e.name} (${e.id})`).join("\n"),o=prompt(`é€‰æ‹©è¦åˆ†é…åˆ°æˆ¿é—´ ${e} çš„è§’è‰²ï¼š\n\n${a}\n\nè¯·è¾“å…¥è§’è‰²IDæˆ–åºå·ï¼š`);if(!o)return;let i=null;const r=parseInt(o);i=!isNaN(r)&&r>0&&r<=n.length?n[r-1].id:n.find(e=>e.id===o||e.name===o)?.id,i?assignCharacterToRoom(i,e):alert("æ— æ•ˆçš„é€‰æ‹©ï¼")}function assignCharacterToRoom(e,t){const n=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[t],a=gameState.è§’è‰²ä»“åº“?.[e];if(!n||!a)return;if("è°ƒæ•™å®¤"===n.ç±»å‹)return void openTrainingAssignment(t);if("ç©ºé—²"!==n.çŠ¶æ€)return void alert("æˆ¿é—´æ­£åœ¨ä½¿ç”¨ä¸­ï¼Œæ— æ³•åˆ†é…ã€‚");batchAssignLocal(t,e,getGameTime().å½“å‰å›åˆ||1);const o=document.getElementById("brothel-story-content");if(o){let i=`âœ… å·²åˆ†é…ï¼š${a.å§“å} â†’ æˆ¿é—´ ${t}ï¼ˆ${n.ç±»å‹}ï¼‰ã€‚\n\næç¤ºï¼šç‚¹å‡»â€œæŸ¥çœ‹å‰§æƒ…â€å°†è°ƒç”¨ AI ç”Ÿæˆæœ¬æ¬¡å‰§æƒ…ï¼Œå¹¶è®¡ä¸º 1 å›åˆã€‚`;"undefined"!=typeof formatAsDisplayedMessage&&(i=formatAsDisplayedMessage(i)),renderStoryWithAutoImage(o,i,e,{scene:"å¼€å§‹",roomType:n.ç±»å‹})}saveGameStateToMVU(),refreshAllPages()}async function showRoomDetail(e){const t=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[e],n=t.å½“å‰è§’è‰²?gameState.è§’è‰²ä»“åº“[t.å½“å‰è§’è‰²]:null,a=t.å½“å‰è§’è‰²?gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[t.å½“å‰è§’è‰²]:null;if("è°ƒæ•™å®¤"===t?.ç±»å‹)return showTrainingRoomDetail(e);if(n){const o=document.getElementById("brothel-story-content");o&&(o.innerHTML='<div class="story-loading">â³ AI æ­£åœ¨ç”Ÿæˆæ¥å®¢å‰§æƒ…ï¼Œè¯·ç¨å€™...</div>');let i="";if(a){const e=a.å¼€å§‹å›åˆ||getGameTime().å½“å‰å›åˆ;i=`å¼€å§‹å›åˆ: ${e}\né¢„è®¡å‰©ä½™å›åˆ: ${Math.max(0,e+2-(getGameTime().å½“å‰å›åˆ||1))}\nå®¢æˆ·ç±»å‹: ${a.å®¢æˆ·ç±»å‹}\næœåŠ¡ç±»å‹: ${a.æœåŠ¡ç±»å‹.join(", ")}\n`}const r=`ã€å‰§æƒ…ç”Ÿæˆæ¨¡å¼ã€‘è¿™æ˜¯çº¯æ–‡æœ¬å‰§æƒ…ç”Ÿæˆï¼Œä¸æ˜¯è§’è‰²å¡ç”Ÿæˆã€‚\nç»å¯¹ç¦æ­¢ï¼šä¸è¦è¾“å‡ºä»»ä½•HTMLä»£ç ã€ä¸è¦è¾“å‡ºä»£ç å—ã€ä¸è¦è¾“å‡º<think>/<analysis>æ€ç»´é“¾ã€‚\nåªè¾“å‡ºï¼šçº¯æ–‡æœ¬å‰§æƒ… + <JSONPatch>æ›´æ–°</JSONPatch>\n\nè§’è‰²${t.å½“å‰è§’è‰²}ï¼ˆ${n.å§“å}ï¼‰åœ¨æˆ¿é—´${e}ä¸­ç»§ç»­æ¥å®¢ã€‚${i}è¯·ç”Ÿæˆè¯¦ç»†çš„æ¥å®¢å‰§æƒ…ï¼ŒåŒ…æ‹¬æœåŠ¡è¿‡ç¨‹ã€å®¢æˆ·ååº”ã€è§’è‰²çŠ¶æ€å˜åŒ–ã€æ”¶å…¥ç­‰ã€‚\n\nä¿æŒè§’è‰²çŠ¶æ€ä¸º"æ¥å®¢ä¸­"ï¼Œæˆ¿é—´çŠ¶æ€ä¸º"ä½¿ç”¨ä¸­"ã€‚å¦‚æœéœ€è¦æ›´æ–°è§’è‰²çŠ¶æ€ï¼Œè¯·ä½¿ç”¨JSONPatchæ ¼å¼ã€‚`;try{const n=await sendCommandToAI(r,!0);if(n&&o){let a=n;const i=a.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/);if(i){try{applyJSONPatches(JSON.parse(cleanJsonString(i[1])))}catch(e){console.error("è§£æ JSON Patch å¤±è´¥:",e)}a=a.replace(/<JSONPatch>[\s\S]*?<\/JSONPatch>/,"").trim()}a=a.replace(/<UpdateVariable>[\s\S]*?<\/UpdateVariable>/,"").trim(),a=a.replace(/<Analysis>[\s\S]*?<\/Analysis>/,"").trim(),a=filterHtmlFromStory(a);const r=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[e];if(r&&r.å½“å‰è§’è‰²){"ä½¿ç”¨ä¸­"!==r.çŠ¶æ€&&(console.warn(`ä¿®å¤æˆ¿é—´ ${e} çŠ¶æ€ï¼šä»"${r.çŠ¶æ€}"æ”¹ä¸º"ä½¿ç”¨ä¸­"`),r.çŠ¶æ€="ä½¿ç”¨ä¸­");const t=gameState.è§’è‰²ä»“åº“[r.å½“å‰è§’è‰²];t&&"æ¥å®¢ä¸­"!==t.çŠ¶æ€&&"è°ƒæ•™ä¸­"!==t.çŠ¶æ€&&("è°ƒæ•™å®¤"===r.ç±»å‹?t.çŠ¶æ€="è°ƒæ•™ä¸­":t.çŠ¶æ€="æ¥å®¢ä¸­"),saveGameStateToMVU()}"undefined"!=typeof formatAsDisplayedMessage&&(a=formatAsDisplayedMessage(a)),renderStoryWithAutoImage(o,a,t.å½“å‰è§’è‰²,{scene:"æ¥å®¢",roomType:t.ç±»å‹}),checkRelationshipTriggers(t.å½“å‰è§’è‰²,"æ¥å®¢å‰§æƒ…"),advanceRound()}}catch(e){console.error("ç”Ÿæˆå‰§æƒ…å¤±è´¥:",e),o&&(o.innerHTML='<div class="story-placeholder" style="color: var(--danger)">ç”Ÿæˆå‰§æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>')}}else alert(`æˆ¿é—´ ${e}\nçŠ¶æ€: ${t.çŠ¶æ€}\nå½“å‰æ— è§’è‰²`)}function openTrainingAssignment(e){const t=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[e];if(!t)return;if("è°ƒæ•™å®¤"!==t.ç±»å‹)return;if("ç©ºé—²"!==t.çŠ¶æ€)return void alert("è¯¥è°ƒæ•™å®¤æ­£åœ¨ä½¿ç”¨ä¸­ã€‚");const n=Object.entries(gameState.è§’è‰²ä»“åº“||{}).filter(([,e])=>"ç©ºé—²"===e?.çŠ¶æ€&&"ä»“åº“"===e?.å½“å‰ä½ç½®).map(([e,t])=>({id:e,name:t.å§“å}));if(0===n.length)return void alert("æ²¡æœ‰å¯ç”¨è§’è‰²ï¼ˆéœ€è¦ç©ºé—²ä¸”åœ¨ä»“åº“ï¼‰ã€‚");const a=document.createElement("div");a.className="modal",a.id="training-assign-modal",a.innerHTML=`\n                <div class="modal-content" style="max-width: 800px">\n                  <button class="modal-close" onclick="closeTrainingAssignment()">Ã—</button>\n                  <h2 style="font-size: 24px; color: var(--text-primary); margin-bottom: 10px; text-align: center; font-family: var(--font-title); letter-spacing: 0.12em">\n                    â›“ï¸ è°ƒæ•™å®¤ Â· è¯¾ç¨‹å®‰æ’\n                  </h2>\n                  <div style="text-align: center; font-size: 12px; color: var(--text-secondary); margin-bottom: 18px">\n                    æˆ¿é—´ï¼š${e} Â· æœ¬æ“ä½œä¸ä¼šè°ƒç”¨AIï¼Œç‚¹â€œå¼€å§‹è®­ç»ƒâ€åç­‰å¾…å›åˆæ¨è¿›ç»“ç®—ã€‚\n                  </div>\n\n                  <div style="display: grid; grid-template-columns: 1fr; gap: 14px; margin-bottom: 18px">\n                    <div style="padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px">\n                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.12em">é€‰æ‹©è§’è‰²</div>\n                      <select id="training-char-select" style="width: 100%; padding: 12px">\n                        ${n.map(e=>`<option value="${e.id}">${e.name}ï¼ˆ${e.id}ï¼‰</option>`).join("")}\n                      </select>\n                    </div>\n\n                    <div style="padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px">\n                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.12em">é€‰æ‹©è¯¾ç¨‹</div>\n                      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 12px">\n                        ${trainingPrograms.map(e=>`\n                          <label style="display:block; cursor:pointer; padding: 12px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.18)">\n                            <div style="display:flex; gap:10px; align-items:flex-start">\n                              <input type="radio" name="training-program" value="${e.key}" style="margin-top: 4px" ${e.key===trainingPrograms[0].key?"checked":""} onchange="toggleCustomTraining(false)" />\n                              <div style="flex:1">\n                                <div style="font-weight:800; color: var(--text-primary); margin-bottom: 4px">${e.icon} ${e.key}</div>\n                                <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6">${e.desc}</div>\n                              </div>\n                            </div>\n                          </label>\n                        `).join("")}\n                      </div>\n                    </div>\n\n                    <div style="padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px">\n                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.12em">\n                        <label style="cursor:pointer">\n                          <input type="radio" name="training-program" value="è‡ªå®šä¹‰è°ƒæ•™" style="margin-right: 8px" onchange="toggleCustomTraining(true)" />\n                          ğŸ­ è‡ªå®šä¹‰è°ƒæ•™ï¼ˆæè¿°ä½ æƒ³è¦çš„playï¼Œè¶Šè¯¦ç»†è¶Šå¥½ï¼‰\n                        </label>\n                      </div>\n                      <textarea id="custom-training-desc" placeholder="ä¾‹ï¼šç”¨çƒ­èœ¡æ»´åœ¨ä¹³å¤´ä¸Šï¼Œç„¶åç”¨é­å­æŠ½æ‰“å±è‚¡ï¼Œæœ€åå¼ºåˆ¶å£äº¤... æè¿°è¶Šè‰²æƒ…è¯¦ç»†ï¼ŒAIç”Ÿæˆå‰§æƒ…è¶Šåˆºæ¿€" style="width: 100%; min-height: 80px; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; color: var(--text-primary); font-size: 14px; resize: vertical; display: none" oninput="updateCustomTraining()"></textarea>\n                      <div id="custom-training-preview" style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 12px; color: var(--text-secondary); display: none">é¢„è§ˆï¼šè‡ªå®šä¹‰è°ƒæ•™</div>\n                    </div>\n\n                    <div style="padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px">\n                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.12em">å¼ºåº¦ï¼ˆå½±å“å›åˆæ•°/æ”¶ç›Š/é£é™©ï¼‰</div>\n                      <div style="display:flex; gap: 12px; align-items:center">\n                        <input type="range" id="training-intensity" min="1" max="3" step="1" value="2" style="flex:1" />\n                        <div style="min-width: 64px; text-align:right; font-weight:800; color: var(--accent-gold)"><span id="training-intensity-val">2</span>/3</div>\n                      </div>\n                      <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary)">é¢„è®¡è€—æ—¶ï¼š<span id="training-duration">2</span> å›åˆ</div>\n                    </div>\n                  </div>\n\n                  <div style="display: flex; gap: 12px; justify-content: flex-end">\n                    <button class="btn btn-secondary" onclick="closeTrainingAssignment()">å–æ¶ˆ</button>\n                    <button class="btn" onclick="confirmTrainingAssignment('${e}')">å¼€å§‹è®­ç»ƒ</button>\n                  </div>\n                </div>\n              `,document.body.appendChild(a),a.classList.add("active");const o=a.querySelector("#training-intensity"),i=a.querySelector("#training-intensity-val"),r=a.querySelector("#training-duration");o&&i&&r&&o.addEventListener("input",()=>{i.textContent=o.value,r.textContent=o.value}),toggleCustomTraining(!1)}function closeTrainingAssignment(){const e=document.getElementById("training-assign-modal");e&&(e.classList.remove("active"),setTimeout(()=>e.remove(),300))}function confirmTrainingAssignment(e){const t=document.getElementById("training-char-select")?.value,n=document.querySelector('input[name="training-program"]:checked')?.value,a=parseInt(document.getElementById("training-intensity")?.value||"2");if(!t||!n)return;let o=n,i="";if("è‡ªå®šä¹‰è°ƒæ•™"===n){if(i=document.getElementById("custom-training-desc")?.value?.trim()||"",!i)return void alert("è¯·è¾“å…¥è‡ªå®šä¹‰è°ƒæ•™å†…å®¹ï¼");o=`è‡ªå®šä¹‰è°ƒæ•™ï¼š${i}`}startTrainingLocal(e,t,o,clampNumber(a,1,3),i),closeTrainingAssignment()}function startTrainingLocal(e,t,n,a,o=""){const i=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[e],r=gameState.è§’è‰²ä»“åº“?.[t];if(!i||!r)return;if("è°ƒæ•™å®¤"!==i.ç±»å‹)return;if("ç©ºé—²"!==i.çŠ¶æ€)return void alert("æˆ¿é—´ä¸å¯ç”¨ã€‚");normalizeCharacter(r);const s=trainingPrograms.find(e=>e.key===n)||trainingPrograms[0],l=getGameTime(),c=a,d=(l.å½“å‰å›åˆ||1)+c;i.çŠ¶æ€="ä½¿ç”¨ä¸­",i.å½“å‰è§’è‰²=t,r.çŠ¶æ€="è°ƒæ•™ä¸­",r.å½“å‰ä½ç½®="è°ƒæ•™å®¤",gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²||(gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²={}),gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²[t]={"å¼€å§‹å›åˆ":l.å½“å‰å›åˆ||1,"é¢„è®¡ç»“æŸå›åˆ":d,"è¯¾ç¨‹":n,"å¼ºåº¦":a,"æˆ¿é—´å·":e,"è‡ªå®šä¹‰æè¿°":o};const m=randInt(s.staminaCost[0],s.staminaCost[1])+2*(a-1);r.å±æ€§.è€åŠ›=clampNumber((r.å±æ€§.è€åŠ›||0)-m,0,100),r.è°ƒæ•™æ¬¡æ•°=(r.è°ƒæ•™æ¬¡æ•°||0)+1,r.æœ€åäº’åŠ¨=l.å½“å‰å›åˆ||1,pushBrothelLog({"æ—¶é—´æˆ³":l.å½“å‰å›åˆ||1,"è§’è‰²ID":t,"äº‹ä»¶ç±»å‹":"å¼€å§‹è®­ç»ƒ","æè¿°":`${r.å§“å}åœ¨è°ƒæ•™å®¤${e}å¼€å§‹è¯¾ç¨‹ã€${s.key}ã€‘ï¼ˆå¼ºåº¦${a}ï¼Œé¢„è®¡${c}å›åˆï¼‰`,"æ”¶å…¥å˜åŒ–":0}),saveGameStateToMVU(),refreshAllPages()}function stopTrainingInRoom(e){const t=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[e];if(!t||"è°ƒæ•™å®¤"!==t.ç±»å‹)return;const n=t.å½“å‰è§’è‰²;if(!n)return void alert("è¯¥æˆ¿é—´æ²¡æœ‰è§’è‰²ã€‚");const a=gameState.è§’è‰²ä»“åº“?.[n];a&&confirm(`ç¡®å®šè¦ç»ˆæ­¢ ${a.å§“å} çš„è®­ç»ƒå—ï¼Ÿï¼ˆä¸ä¼šè·å¾—æœ¬æ¬¡è¯¾ç¨‹æ”¶ç›Šï¼‰`)&&(delete gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[n],t.çŠ¶æ€="ç©ºé—²",t.å½“å‰è§’è‰²=void 0,a.çŠ¶æ€="ç©ºé—²",a.å½“å‰ä½ç½®="ä»“åº“",pushBrothelLog({"æ—¶é—´æˆ³":getGameTime().å½“å‰å›åˆ||1,"è§’è‰²ID":n,"äº‹ä»¶ç±»å‹":"ç»ˆæ­¢è®­ç»ƒ","æè¿°":`${a.å§“å}çš„è®­ç»ƒè¢«ç»ˆæ­¢ï¼Œç¦»å¼€è°ƒæ•™å®¤${e}`,"æ”¶å…¥å˜åŒ–":0}),saveGameStateToMVU(),refreshAllPages())}async function showTrainingRoomDetail(e){const t=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[e],n=t?.å½“å‰è§’è‰²,a=n?gameState.è§’è‰²ä»“åº“?.[n]:null,o=n?gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[n]:null;if(!n||!a)return void alert(`æˆ¿é—´ ${e}\nçŠ¶æ€: ${t?.çŠ¶æ€}\nå½“å‰æ— è§’è‰²`);const i=document.getElementById("brothel-story-content");i&&(i.innerHTML='<div class="story-loading">â³ AI æ­£åœ¨ç”Ÿæˆè®­ç»ƒå‰§æƒ…ï¼Œè¯·ç¨å€™...</div>');const r=getGameTime(),s=o?Math.max(0,o.é¢„è®¡ç»“æŸå›åˆ-(r.å½“å‰å›åˆ||1)):0,l=o?.è¯¾ç¨‹||"æœªçŸ¥è¯¾ç¨‹",c=o?.å¼ºåº¦||2,d=`ã€å‰§æƒ…ç”Ÿæˆæ¨¡å¼ã€‘è¿™æ˜¯çº¯æ–‡æœ¬å‰§æƒ…ç”Ÿæˆï¼Œä¸æ˜¯è§’è‰²å¡ç”Ÿæˆã€‚\nç»å¯¹ç¦æ­¢ï¼šä¸è¦è¾“å‡ºä»»ä½•HTMLä»£ç ã€ä¸è¦è¾“å‡ºä»£ç å—ã€ä¸è¦è¾“å‡º<think>/<analysis>æ€ç»´é“¾ã€‚\nåªè¾“å‡ºï¼šçº¯æ–‡æœ¬å‰§æƒ… + <JSONPatch>æ›´æ–°</JSONPatch>\n\nä¸ºè§’è‰²${n}ï¼ˆ${a.å§“å}ï¼‰ç”Ÿæˆä¸€æ®µã€è°ƒæ•™å®¤è®­ç»ƒå‰§æƒ…ã€‘ã€‚\n\nè®­ç»ƒä¿¡æ¯ï¼šæˆ¿é—´${e}ï¼Œè¯¾ç¨‹${l}ï¼Œå¼ºåº¦${c}/3ï¼Œå½“å‰ç¬¬${r.å¤©æ•°}å¤©${r.å½“å‰æ—¶æ®µ}ï¼ˆå›åˆ${r.å½“å‰å›åˆ}ï¼‰ï¼Œå‰©ä½™${s}å›åˆã€‚\n\nå¿…é¡»ä½¿ç”¨ <JSONPatch> æ›´æ–°ï¼šè§’è‰²ä»“åº“/${n}/å±æ€§ï¼ˆæŒ‰è¯¾ç¨‹æ–¹å‘å°å¹…æå‡ï¼‰ã€è§’è‰²ä»“åº“/${n}/å¥½æ„Ÿåº¦ æˆ– æ¨æ„ï¼ˆ0~100ï¼‰ã€‚`;try{const t=await sendCommandToAI(d,!0);if(t&&i){let a=t;const o=a.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/);if(o){try{applyJSONPatches(JSON.parse(cleanJsonString(o[1])))}catch(e){console.error("è§£æ JSON Patch å¤±è´¥:",e)}a=a.replace(/<JSONPatch>[\s\S]*?<\/JSONPatch>/,"").trim()}a=a.replace(/<UpdateVariable>[\s\S]*?<\/UpdateVariable>/,"").trim(),a=a.replace(/<Analysis>[\s\S]*?<\/Analysis>/,"").trim(),a=filterHtmlFromStory(a);const r=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[e];if(r&&r.å½“å‰è§’è‰²){"ä½¿ç”¨ä¸­"!==r.çŠ¶æ€&&(console.warn(`ä¿®å¤è°ƒæ•™å®¤ ${e} çŠ¶æ€ï¼šä»"${r.çŠ¶æ€}"æ”¹ä¸º"ä½¿ç”¨ä¸­"`),r.çŠ¶æ€="ä½¿ç”¨ä¸­");const t=gameState.è§’è‰²ä»“åº“[r.å½“å‰è§’è‰²];t&&"è°ƒæ•™ä¸­"!==t.çŠ¶æ€&&(t.çŠ¶æ€="è°ƒæ•™ä¸­"),saveGameStateToMVU()}"undefined"!=typeof formatAsDisplayedMessage&&(a=formatAsDisplayedMessage(a)),renderStoryWithAutoImage(i,a,n,{scene:"è®­ç»ƒ",roomType:"è°ƒæ•™å®¤"}),checkRelationshipTriggers(n,"è®­ç»ƒå‰§æƒ…"),advanceRound()}}catch(e){console.error("ç”Ÿæˆè®­ç»ƒå‰§æƒ…å¤±è´¥:",e),i&&(i.innerHTML='<div class="story-placeholder" style="color: var(--danger)">ç”Ÿæˆè®­ç»ƒå‰§æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>')}}function toggleBrothelStatus(){gameState.å¦“é™¢||(gameState.å¦“é™¢={}),gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€||(gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€="è¥ä¸šä¸­"),gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€="è¥ä¸šä¸­"===gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€?"æš‚åœè¥ä¸š":"è¥ä¸šä¸­",pushBrothelLog({"æ—¶é—´æˆ³":getGameTime().å½“å‰å›åˆ||1,"è§’è‰²ID":"SYSTEM","äº‹ä»¶ç±»å‹":"è¥ä¸šçŠ¶æ€","æè¿°":`å¦“é™¢è¥ä¸šçŠ¶æ€åˆ‡æ¢ä¸ºï¼š${gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€}`,"æ”¶å…¥å˜åŒ–":0}),saveGameStateToMVU(),refreshAllPages()}function showBatchAssignment(){refreshBatchAssignmentPanel();const e=document.getElementById("batch-assignment-panel");e&&(e.style.display="block")}function addToBatchAssignment(e,t){if(gameState.å¾…å¤„ç†åˆ†é…||(gameState.å¾…å¤„ç†åˆ†é…=[]),"remove"===t){const t=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[e];t&&t.å½“å‰è§’è‰²&&(gameState.å¾…å¤„ç†åˆ†é….push({type:"remove",roomId:e,characterId:t.å½“å‰è§’è‰²}),refreshBatchAssignmentPanel())}else showRoomAssignmentForBatch(e,"swap"===t?"swap":"assign")}function showRoomAssignmentForBatch(e,t="assign"){const n=Object.entries(gameState.è§’è‰²ä»“åº“).filter(([e,t])=>"ç©ºé—²"===t.çŠ¶æ€&&"ä»“åº“"===t.å½“å‰ä½ç½®).map(([e,t])=>({id:e,name:t.å§“å}));if(0===n.length)return void alert("æ²¡æœ‰å¯åˆ†é…çš„è§’è‰²ï¼");const a=document.createElement("div");a.className="modal",a.id="batch-assignment-select-modal",a.innerHTML=`\n                <div class="modal-content" style="max-width: 600px">\n                  <button class="modal-close" onclick="closeBatchAssignmentSelect()">Ã—</button>\n                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">é€‰æ‹©è§’è‰²åˆ†é…åˆ°æˆ¿é—´ ${e}</h2>\n                  <div style="max-height: 400px; overflow-y: auto">\n                    ${n.map(n=>`\n                      <div style="padding: 12px; margin-bottom: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 8px; cursor: pointer; transition: all 0.3s"\n                           onclick="selectCharacterForBatch('${e}', '${n.id}', '${t}')"\n                           onmouseover="this.style.background='rgba(139, 92, 246, 0.3)'"\n                           onmouseout="this.style.background='rgba(15, 23, 42, 0.6)'">\n                        <div style="font-weight: 600">${n.name}</div>\n                        <div style="font-size: 12px; color: var(--text-secondary)">ID: ${n.id}</div>\n                      </div>\n                    `).join("")}\n                  </div>\n                </div>\n              `,document.body.appendChild(a),a.classList.add("active")}function closeBatchAssignmentSelect(){const e=document.getElementById("batch-assignment-select-modal");e&&(e.classList.remove("active"),setTimeout(()=>e.remove(),300))}function selectCharacterForBatch(e,t,n="assign"){if(gameState.å¾…å¤„ç†åˆ†é…||(gameState.å¾…å¤„ç†åˆ†é…=[]),"swap"===n){const t=gameState.å¦“é™¢?.æˆ¿é—´çŠ¶æ€?.[e],n=t?.å½“å‰è§’è‰²;if(n){gameState.å¾…å¤„ç†åˆ†é….some(t=>"remove"===t.type&&t.roomId===e)||gameState.å¾…å¤„ç†åˆ†é….push({type:"remove",roomId:e,characterId:n})}}gameState.å¾…å¤„ç†åˆ†é….push({type:"assign",roomId:e,characterId:t}),closeBatchAssignmentSelect(),refreshBatchAssignmentPanel()}function refreshBatchAssignmentPanel(){const e=document.getElementById("batch-assignment-list");if(!e)return;if(!gameState.å¾…å¤„ç†åˆ†é…||0===gameState.å¾…å¤„ç†åˆ†é….length)return void(e.innerHTML='<div style="text-align: center; color: var(--text-secondary); padding: 20px">æš‚æ— å¾…å¤„ç†åˆ†é…</div>');const t=document.getElementById("batch-assignment-panel");t&&(t.style.display="block"),e.innerHTML=gameState.å¾…å¤„ç†åˆ†é….map((e,t)=>{const n=gameState.è§’è‰²ä»“åº“[e.characterId],a=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[e.roomId],o=roomTypes[a?.ç±»å‹]||roomTypes.æ™®é€š;return`\n                  <div style="padding: 12px; margin-bottom: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 8px; display: flex; justify-content: space-between; align-items: center">\n                    <div style="flex: 1">\n                      <div style="font-weight: 600; margin-bottom: 4px">\n                        ${"assign"===e.type?"ğŸ“¥ åˆ†é…":"ğŸ“¤ ç§»å‡º"}\n                        ${n?n.å§“å:e.characterId}\n                        ${"assign"===e.type?"åˆ°":"ä»"}\n                        æˆ¿é—´ ${e.roomId} ${o.icon}\n                      </div>\n                      <div style="font-size: 12px; color: var(--text-secondary)">${a?.ç±»å‹||"æœªçŸ¥"}æˆ¿é—´</div>\n                    </div>\n                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px" onclick="removeFromBatchAssignment(${t})">åˆ é™¤</button>\n                  </div>\n                `}).join("")}function removeFromBatchAssignment(e){gameState.å¾…å¤„ç†åˆ†é…&&gameState.å¾…å¤„ç†åˆ†é…[e]&&(gameState.å¾…å¤„ç†åˆ†é….splice(e,1),refreshBatchAssignmentPanel())}function clearBatchAssignments(){confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¾…å¤„ç†åˆ†é…å—ï¼Ÿ")&&(gameState.å¾…å¤„ç†åˆ†é…=[],refreshBatchAssignmentPanel())}function confirmBatchAssignments(){if(!gameState.å¾…å¤„ç†åˆ†é…||0===gameState.å¾…å¤„ç†åˆ†é….length)return void alert("æ²¡æœ‰å¾…å¤„ç†çš„åˆ†é…ï¼");const e=getGameTime().å½“å‰å›åˆ||1,t=[...gameState.å¾…å¤„ç†åˆ†é…],n=t.filter(e=>"remove"===e.type),a=t.filter(e=>"assign"===e.type),o=new Set;for(const e of a){if(o.has(e.characterId))return void alert("æ‰¹é‡åˆ†é…å¤±è´¥ï¼šåŒä¸€ä¸ªè§’è‰²è¢«é‡å¤åˆ†é…åˆ°å¤šä¸ªæˆ¿é—´ã€‚");o.add(e.characterId)}const i=new Set(n.map(e=>e.roomId));for(const e of a){const t=gameState.å¦“é™¢?.æˆ¿é—´çŠ¶æ€?.[e.roomId];if(!t)return void alert(`æ‰¹é‡åˆ†é…å¤±è´¥ï¼šæˆ¿é—´ ${e.roomId} ä¸å­˜åœ¨ã€‚`);if("ç©ºé—²"!==t.çŠ¶æ€&&!i.has(e.roomId))return void alert(`æ‰¹é‡åˆ†é…å¤±è´¥ï¼šæˆ¿é—´ ${e.roomId} æ­£åœ¨ä½¿ç”¨ä¸­ï¼Œè¯·å…ˆåŠ å…¥â€œç§»å‡ºé˜Ÿåˆ—â€ã€‚`);const n=gameState.è§’è‰²ä»“åº“?.[e.characterId];if(!n)return void alert(`æ‰¹é‡åˆ†é…å¤±è´¥ï¼šè§’è‰² ${e.characterId} ä¸å­˜åœ¨ã€‚`);if("ç©ºé—²"!==n.çŠ¶æ€||"ä»“åº“"!==n.å½“å‰ä½ç½®)return void alert(`æ‰¹é‡åˆ†é…å¤±è´¥ï¼šè§’è‰² ${n.å§“å} å½“å‰ä¸æ˜¯ç©ºé—²/ä»“åº“çŠ¶æ€ï¼Œæ— æ³•åˆ†é…ã€‚`)}n.forEach(t=>batchRemoveLocal(t.roomId,t.characterId,e)),a.forEach(t=>batchAssignLocal(t.roomId,t.characterId,e)),gameState.å¾…å¤„ç†åˆ†é…=[],refreshBatchAssignmentPanel();const r=document.getElementById("batch-assignment-panel");r&&(r.style.display="none"),advanceRound(),alert("æ‰¹é‡åˆ†é…å·²åº”ç”¨ï¼Œå·²è¿›å…¥ä¸‹ä¸€å›åˆï¼")}function batchAssignLocal(e,t,n){const a=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[e],o=gameState.è§’è‰²ä»“åº“?.[t];if(!a||!o)return;if("ç©ºé—²"!==a.çŠ¶æ€)return;if("ä¼‘æ¯å®¤"===a.ç±»å‹)return a.çŠ¶æ€="ä½¿ç”¨ä¸­",a.å½“å‰è§’è‰²=t,o.çŠ¶æ€="ä¼‘æ¯ä¸­",o.å½“å‰ä½ç½®="ä¼‘æ¯å®¤",o.å±æ€§||(o.å±æ€§={}),"number"!=typeof o.å±æ€§.è€åŠ›&&(o.å±æ€§.è€åŠ›=50),void pushBrothelLog({"æ—¶é—´æˆ³":n,"è§’è‰²ID":t,"äº‹ä»¶ç±»å‹":"ä¼‘æ¯","æè¿°":`${o.å§“å}è¿›å…¥ä¼‘æ¯å®¤${e}ä¼‘æ¯`,"æ”¶å…¥å˜åŒ–":0});if("åŒ»ç–—å®¤"===a.ç±»å‹)return a.çŠ¶æ€="ä½¿ç”¨ä¸­",a.å½“å‰è§’è‰²=t,o.çŠ¶æ€="åŒ»ç–—å®¤",o.å½“å‰ä½ç½®="åŒ»ç–—å®¤",o.å±æ€§||(o.å±æ€§={}),"number"!=typeof o.å±æ€§.è€åŠ›&&(o.å±æ€§.è€åŠ›=30),void pushBrothelLog({"æ—¶é—´æˆ³":n,"è§’è‰²ID":t,"äº‹ä»¶ç±»å‹":"æ²»ç–—","æè¿°":`${o.å§“å}è¿›å…¥åŒ»ç–—å®¤${e}æ²»ç–—`,"æ”¶å…¥å˜åŒ–":0});if("è°ƒæ•™å®¤"===a.ç±»å‹)return;a.çŠ¶æ€="ä½¿ç”¨ä¸­",a.å½“å‰è§’è‰²=t,o.çŠ¶æ€="æ¥å®¢ä¸­",o.å½“å‰ä½ç½®="å¦“é™¢";const i=createWorkingInfoLocal(o,a,n);gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[t]=i,pushBrothelLog({"æ—¶é—´æˆ³":n,"è§’è‰²ID":t,"äº‹ä»¶ç±»å‹":"åˆ†é…æ¥å®¢","æè¿°":`${o.å§“å}è¢«åˆ†é…åˆ°æˆ¿é—´${e}å¼€å§‹æ¥å®¢ï¼ˆ${i.å®¢æˆ·ç±»å‹}ï¼‰`,"æ”¶å…¥å˜åŒ–":0})}function batchRemoveLocal(e,t,n){const a=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[e];if(!a)return;const o=a.å½“å‰è§’è‰²||t,i=gameState.è§’è‰²ä»“åº“?.[o];"ä½¿ç”¨ä¸­"===a.çŠ¶æ€&&o&&i&&(gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[o]&&delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[o],a.çŠ¶æ€="ç©ºé—²",a.å½“å‰è§’è‰²=void 0,i.çŠ¶æ€="ç©ºé—²",i.å½“å‰ä½ç½®="ä»“åº“",pushBrothelLog({"æ—¶é—´æˆ³":n,"è§’è‰²ID":o,"äº‹ä»¶ç±»å‹":"å–æ¶ˆæ¥å®¢","æè¿°":`${i.å§“å}è¢«ä»æˆ¿é—´${e}ä¸­å¬å›`,"æ”¶å…¥å˜åŒ–":0}))}function createWorkingInfoLocal(e,t,n){const a=()=>{if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]/4294967296}return Math.random()},o=(e,t)=>Math.floor(a()*(t-e+1))+e,i="VIP"===t.ç±»å‹,r=(e=>{const t=e.reduce((e,t)=>e+t.w,0);let n=a()*t;for(const t of e)if(n-=t.w,n<=0)return t.v;return e[e.length-1].v})([{v:"æ™®é€š",w:i?55:70},{v:"VIP",w:i?40:25},{v:"ç‰¹æ®Šç™–å¥½",w:5}]),s="å±•ç¤ºå®¤"===t.ç±»å‹?["èˆå°å±•ç¤º","æŒ‘é€—è¡¨æ¼”"]:"æƒ…è¶£æˆ¿"===t.ç±»å‹?["æ·±åº¦ç©å…·","ç¾è€»ç©æ³•"]:"VIP"===t.ç±»å‹?["VIPä¸“å±","å®šåˆ¶æœåŠ¡"]:[],l="ç‰¹æ®Šç™–å¥½"===r?o(3,4):"VIP"===r?o(2,3):o(1,2),c=[...new Set([...s,"æ™®é€šæœåŠ¡","è§’è‰²æ‰®æ¼”","è½»åº¦SM","æŸç¼šæ¸¸æˆ","å£èˆŒæœä¾","æ„Ÿå®˜æ¸¸æˆ","æ€§ç©å…·"])],d=[];for(;d.length<l&&c.length>0;){const e=o(0,c.length-1);d.push(c.splice(e,1)[0])}const m=e.å±æ€§?.é­…åŠ›||0,p=e.å±æ€§?.æŠ€å·§||0,g=e.å±æ€§?.è€åŠ›||50,u="æƒ…è¶£æˆ¿"===t.ç±»å‹?[220,650]:"å±•ç¤ºå®¤"===t.ç±»å‹?[160,480]:"VIP"===t.ç±»å‹?[200,600]:[120,420],y="ç‰¹æ®Šç™–å¥½"===r?1.4:"VIP"===r?1.2:1,h=Math.max(.6,Math.min(1.1,g/100+.3)),v=Math.floor(o(u[0],u[1])*(m/50)*(p/50)*y*h),f=Math.floor(o(0,180)*d.length*y);return{"å¼€å§‹å›åˆ":n,"å®¢æˆ·ç±»å‹":r,"æœåŠ¡ç±»å‹":d,"åŸºç¡€æ”¶å…¥":Math.max(0,v),"é¢å¤–æ”¶å…¥":Math.max(0,f),__local:!0}}function pushBrothelLog(e){gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—||(gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—=[]),gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—.push({"æ—¶é—´æˆ³":e.æ—¶é—´æˆ³,"è§’è‰²ID":e.è§’è‰²ID,"äº‹ä»¶ç±»å‹":e.äº‹ä»¶ç±»å‹,"æè¿°":e.æè¿°,"æ”¶å…¥å˜åŒ–":e.æ”¶å…¥å˜åŒ–??0}),gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—.length>100&&gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—.splice(0,gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—.length-100)}function addCharacterToRestRoom(e){const t=gameState.è§’è‰²ä»“åº“[e];if(!t)return;if("ç©ºé—²"!==t.çŠ¶æ€||"ä»“åº“"!==t.å½“å‰ä½ç½®)return void alert("è¯¥è§’è‰²å½“å‰ä¸åœ¨â€œç©ºé—²/ä»“åº“â€çŠ¶æ€ï¼Œæ— æ³•é€å»ä¼‘æ¯ã€‚");const n=Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€||{}).find(([,e])=>"ä¼‘æ¯å®¤"===e.ç±»å‹&&"ç©ºé—²"===e.çŠ¶æ€);if(!n)return void alert("æ²¡æœ‰ç©ºé—²çš„ä¼‘æ¯å®¤ï¼è¯·å…ˆè´­ä¹°ä¼‘æ¯å®¤ã€‚");const[a]=n;batchAssignLocal(a,e,getGameTime().å½“å‰å›åˆ||1),saveGameStateToMVU(),refreshAllPages(),alert(`${t.å§“å} å·²é€å»ä¼‘æ¯å®¤ ${a}ã€‚`)}function addCharacterToMedicalRoom(e){const t=gameState.è§’è‰²ä»“åº“[e];if(!t)return;if("ç©ºé—²"!==t.çŠ¶æ€||"ä»“åº“"!==t.å½“å‰ä½ç½®)return void alert("è¯¥è§’è‰²å½“å‰ä¸åœ¨â€œç©ºé—²/ä»“åº“â€çŠ¶æ€ï¼Œæ— æ³•é€å»åŒ»ç–—ã€‚");const n=Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€||{}).find(([,e])=>"åŒ»ç–—å®¤"===e.ç±»å‹&&"ç©ºé—²"===e.çŠ¶æ€);if(!n)return void alert("æ²¡æœ‰ç©ºé—²çš„åŒ»ç–—å®¤ï¼è¯·å…ˆè´­ä¹°åŒ»ç–—å®¤ã€‚");const[a]=n;batchAssignLocal(a,e,getGameTime().å½“å‰å›åˆ||1),saveGameStateToMVU(),refreshAllPages(),alert(`${t.å§“å} å·²é€å»åŒ»ç–—å®¤ ${a}ã€‚`)}function showCharacterUpgrade(e){const t=gameState.è§’è‰²ä»“åº“[e];if(!t)return;const n=document.createElement("div");n.className="modal",n.id="character-upgrade-modal",n.innerHTML=`\n                <div class="modal-content" style="max-width: 600px">\n                  <button class="modal-close" onclick="closeCharacterUpgrade()">Ã—</button>\n                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">â¬†ï¸ æå‡è§’è‰²å±æ€§</h2>\n\n                  <div style="margin-bottom: 24px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">\n                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px">${t.å§“å}</div>\n                    <div style="font-size: 12px; color: var(--text-secondary)">æ¯æ¬¡æå‡éœ€è¦æ¶ˆè€—è´§å¸ï¼Œå±æ€§è¶Šé«˜æ¶ˆè€—è¶Šå¤š</div>\n                  </div>\n\n                  <div style="display: flex; flex-direction: column; gap: 12px">\n                    ${["é­…åŠ›","é¡ºä»","æŠ€å·§","è€åŠ›","æ•æ„Ÿåº¦"].map(n=>{const a=t.å±æ€§?.[n]||0,o=Math.floor(10*(a+1));return`\n                        <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">\n                          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px">\n                            <div>\n                              <div style="font-weight: 600; margin-bottom: 4px">${n}</div>\n                              <div style="font-size: 12px; color: var(--text-secondary)">å½“å‰: ${a}/100</div>\n                            </div>\n                            <div style="text-align: right">\n                              <div style="font-size: 18px; font-weight: bold; color: var(--accent-gold); margin-bottom: 8px">${o} é‡‘</div>\n                              <button class="btn" style="padding: 6px 16px; font-size: 12px" onclick="upgradeCharacterAttribute('${e}', '${n}')" ${a>=100||gameState.è´§å¸<o?"disabled":""}>æå‡</button>\n                            </div>\n                          </div>\n                          <div class="stat-bar">\n                            <div class="stat-fill" style="width: ${a}%"></div>\n                          </div>\n                        </div>\n                      `}).join("")}\n                  </div>\n\n                  <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px">\n                    <button class="btn btn-secondary" onclick="closeCharacterUpgrade()">å…³é—­</button>\n                  </div>\n                </div>\n              `,document.body.appendChild(n),n.classList.add("active")}function closeCharacterUpgrade(){const e=document.getElementById("character-upgrade-modal");e&&(e.classList.remove("active"),setTimeout(()=>e.remove(),300))}function upgradeCharacterAttribute(e,t){const n=gameState.è§’è‰²ä»“åº“[e];if(!n)return;const a=n.å±æ€§?.[t]||0;if(a>=100)return void alert("å±æ€§å·²è¾¾åˆ°æœ€å¤§å€¼ï¼");const o=Math.floor(10*(a+1));gameState.è´§å¸<o?alert("è´§å¸ä¸è¶³ï¼"):confirm(`ç¡®å®šè¦èŠ±è´¹ ${o} é‡‘æå‡ ${n.å§“å} çš„${t}å—ï¼Ÿ`)&&(gameState.è´§å¸-=o,n.å±æ€§||(n.å±æ€§={}),n.å±æ€§[t]=Math.min(100,a+1),saveGameStateToMVU(),refreshAllPages(),closeCharacterUpgrade(),showCharacterUpgrade(e),alert(`${n.å§“å} çš„${t}å·²æå‡åˆ° ${n.å±æ€§[t]}ï¼`))}function showRoomManagement(e){const t=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[e];if(!t)return;const n=roomTypes[t.ç±»å‹]||roomTypes.æ™®é€š,a=decorationThemes[t.è£…é¥°ä¸»é¢˜]||decorationThemes.æ ‡å‡†,o=t.ç­‰çº§||1,i=n.upgradeCost(o),r=document.createElement("div");r.className="modal",r.id="room-management-modal",r.innerHTML=`\n                <div class="modal-content" style="max-width: 700px">\n                  <button class="modal-close" onclick="closeRoomManagement()">Ã—</button>\n                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">\n                    ${n.icon} æˆ¿é—´ ${e} ç®¡ç†\n                  </h2>\n\n                  <div style="margin-bottom: 24px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px">\n                      <div>\n                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">æˆ¿é—´ç±»å‹</div>\n                        <div style="font-size: 16px; font-weight: 600; color: ${n.color}">${t.ç±»å‹}</div>\n                      </div>\n                      <div>\n                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">å½“å‰ç­‰çº§</div>\n                        <div style="font-size: 16px; font-weight: 600; color: var(--accent-gold)">Lv.${o}</div>\n                      </div>\n                      <div>\n                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">åŸºç¡€æ”¶å…¥å€ç‡</div>\n                        <div style="font-size: 16px; font-weight: 600; color: var(--accent-gold)">${(100*(t.æ”¶å…¥å€ç‡||1)).toFixed(0)}%</div>\n                      </div>\n                      <div>\n                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">è£…é¥°åŠ æˆ</div>\n                        <div style="font-size: 16px; font-weight: 600; color: var(--primary)">+${(100*a.incomeBonus).toFixed(0)}%</div>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div style="margin-bottom: 24px">\n                    <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å‡çº§æˆ¿é—´</h3>\n                    <div style="padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">\n                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px">\n                        <div>\n                          <div style="font-weight: 600; margin-bottom: 4px">å‡çº§åˆ° Lv.${o+1}</div>\n                          <div style="font-size: 12px; color: var(--text-secondary)">æ”¶å…¥å€ç‡æå‡ ${(.1*o*100).toFixed(0)}%</div>\n                        </div>\n                        <div style="text-align: right">\n                          <div style="font-size: 20px; font-weight: bold; color: var(--accent-gold)">${i} é‡‘</div>\n                          <button class="btn" style="margin-top: 8px; padding: 8px 16px; font-size: 12px" onclick="upgradeRoom('${e}')" ${gameState.è´§å¸<i?"disabled":""}>å‡çº§</button>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div style="margin-bottom: 24px">\n                    <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">æ›´æ¢è£…é¥°ä¸»é¢˜</h3>\n                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px">\n                      ${Object.entries(decorationThemes).map(([n,a])=>{const o=t.è£…é¥°ä¸»é¢˜===n,i=gameState.è´§å¸>=a.cost||o;return`\n                          <div style="padding: 12px; background: ${o?"rgba(139, 92, 246, 0.3)":"rgba(15, 23, 42, 0.6)"}; border: 2px solid ${o?"var(--primary)":"transparent"}; border-radius: 12px; cursor: ${i?"pointer":"not-allowed"}; opacity: ${i?"1":"0.5"}" onclick="${i&&!o?`changeRoomDecoration('${e}', '${n}')`:""}">\n                            <div style="font-weight: 600; margin-bottom: 4px">${n}</div>\n                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px">${a.description}</div>\n                            <div style="font-size: 12px; color: ${o?"var(--primary)":"var(--accent-gold)"}">\n                              ${o?"âœ“ å½“å‰":a.cost>0?`${a.cost} é‡‘`:"å…è´¹"}\n                            </div>\n                          </div>\n                        `}).join("")}\n                    </div>\n                  </div>\n\n                  <div style="display: flex; gap: 12px; justify-content: flex-end">\n                    <button class="btn btn-secondary" onclick="closeRoomManagement()">å…³é—­</button>\n                  </div>\n                </div>\n              `,document.body.appendChild(r),r.classList.add("active")}function closeRoomManagement(){const e=document.getElementById("room-management-modal");e&&(e.classList.remove("active"),setTimeout(()=>e.remove(),300))}function upgradeRoom(e){const t=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[e];if(!t)return;const n=roomTypes[t.ç±»å‹]||roomTypes.æ™®é€š,a=t.ç­‰çº§||1,o=n.upgradeCost(a);gameState.è´§å¸<o?alert("è´§å¸ä¸è¶³ï¼"):confirm(`ç¡®å®šè¦èŠ±è´¹ ${o} é‡‘å‡çº§æˆ¿é—´ ${e} åˆ° Lv.${a+1} å—ï¼Ÿ`)&&(gameState.è´§å¸-=o,t.ç­‰çº§=a+1,t.æ”¶å…¥å€ç‡=n.baseIncome*(1+.1*(t.ç­‰çº§-1)),saveGameStateToMVU(),refreshAllPages(),closeRoomManagement(),alert(`æˆ¿é—´ ${e} å·²å‡çº§åˆ° Lv.${t.ç­‰çº§}ï¼`))}function changeRoomDecoration(e,t){const n=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[e];if(!n)return;const a=decorationThemes[t];a&&n.è£…é¥°ä¸»é¢˜!==t&&(gameState.è´§å¸<a.cost?alert("è´§å¸ä¸è¶³ï¼"):a.cost>0&&!confirm(`ç¡®å®šè¦èŠ±è´¹ ${a.cost} é‡‘å°†æˆ¿é—´ ${e} çš„è£…é¥°ä¸»é¢˜æ›´æ¢ä¸º"${t}"å—ï¼Ÿ`)||(gameState.è´§å¸-=a.cost,n.è£…é¥°ä¸»é¢˜=t,saveGameStateToMVU(),refreshAllPages(),closeRoomManagement(),alert(`æˆ¿é—´ ${e} çš„è£…é¥°ä¸»é¢˜å·²æ›´æ¢ä¸º"${t}"ï¼`)))}function showRoomShop(){const e=document.createElement("div");e.className="modal",e.id="room-shop-modal",e.innerHTML=`\n                <div class="modal-content" style="max-width: 800px">\n                  <button class="modal-close" onclick="closeRoomShop()">Ã—</button>\n                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">ğŸ—ï¸ æˆ¿é—´å•†åº—</h2>\n\n                  <div style="margin-bottom: 24px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">\n                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px">å½“å‰è´§å¸</div>\n                    <div style="font-size: 32px; font-weight: bold; color: var(--accent-gold)">${gameState.è´§å¸} é‡‘</div>\n                  </div>\n\n                  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px">\n                    ${Object.entries(roomTypes).map(([e,t])=>{const n=Object.values(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€||{}).filter(t=>t.ç±»å‹===e).length,a=gameState.è´§å¸>=t.unlockCost;return`\n                        <div style="padding: 16px; background: rgba(15, 23, 42, 0.6); border: 2px solid ${t.color}; border-radius: 12px">\n                          <div style="font-size: 32px; text-align: center; margin-bottom: 8px">${t.icon}</div>\n                          <div style="font-size: 18px; font-weight: 600; color: ${t.color}; text-align: center; margin-bottom: 8px">${e}</div>\n                          <div style="font-size: 12px; color: var(--text-secondary); text-align: center; margin-bottom: 12px; min-height: 40px">${t.description}</div>\n                          <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px">\n                            <div>åŸºç¡€æ”¶å…¥: ${(100*t.baseIncome).toFixed(0)}%</div>\n                            <div>å·²æ‹¥æœ‰: ${n} é—´</div>\n                          </div>\n                          <div style="text-align: center; margin-top: 12px">\n                            <div style="font-size: 20px; font-weight: bold; color: var(--accent-gold); margin-bottom: 8px">${t.unlockCost} é‡‘</div>\n                            <button class="btn" style="width: 100%; padding: 8px; font-size: 12px" onclick="purchaseRoom('${e}')" ${a?"":"disabled"}>è´­ä¹°</button>\n                          </div>\n                        </div>\n                      `}).join("")}\n                  </div>\n\n                  <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px">\n                    <button class="btn btn-secondary" onclick="closeRoomShop()">å…³é—­</button>\n                  </div>\n                </div>\n              `,document.body.appendChild(e),e.classList.add("active")}function closeRoomShop(){const e=document.getElementById("room-shop-modal");e&&(e.classList.remove("active"),setTimeout(()=>e.remove(),300))}function purchaseRoom(e){const t=roomTypes[e];if(!t)return;if(gameState.è´§å¸<t.unlockCost)return void alert("è´§å¸ä¸è¶³ï¼");const n=Object.values(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€||{}).filter(t=>t.ç±»å‹===e).length,a=e+(n+1);confirm(`ç¡®å®šè¦èŠ±è´¹ ${t.unlockCost} é‡‘è´­ä¹°ä¸€é—´${e}æˆ¿é—´ï¼ˆ${a}ï¼‰å—ï¼Ÿ`)&&(gameState.è´§å¸-=t.unlockCost,gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[a]={"ç±»å‹":e,"çŠ¶æ€":"ç©ºé—²","è£…é¥°ä¸»é¢˜":"æ ‡å‡†","ç­‰çº§":1,"æ”¶å…¥å€ç‡":t.baseIncome,"è§£é”":!0},saveGameStateToMVU(),refreshAllPages(),closeRoomShop(),alert(`æˆåŠŸè´­ä¹°${e}æˆ¿é—´ ${a}ï¼`))}function cancelCharacterFromRoom(e){const t=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[e],n=t?.å½“å‰è§’è‰²;if(!t||!n)return void alert("è¯¥æˆ¿é—´æ²¡æœ‰è§’è‰²ï¼");const a=gameState.è§’è‰²ä»“åº“?.[n];a?confirm(`ç¡®å®šè¦è®© ${a.å§“å} ç¦»å¼€æˆ¿é—´ ${e} å—ï¼Ÿ\n\nè¿™å°†å–æ¶ˆå½“å‰çŠ¶æ€ï¼ˆä¸ä¼šäº§ç”Ÿæœ¬æ¬¡æ”¶å…¥ï¼‰ã€‚`)&&("è°ƒæ•™å®¤"!==t.ç±»å‹?(batchRemoveLocal(e,n,getGameTime().å½“å‰å›åˆ||1),saveGameStateToMVU(),refreshAllPages()):stopTrainingInRoom(e)):alert("è§’è‰²ä¸å­˜åœ¨ï¼")}function normalizeGameTime(e){const t=Math.max(1,parseInt(e?.å½“å‰å›åˆ||1));e.å½“å‰å›åˆ=t,e.å¤©æ•°=Math.floor((t-1)/3)+1;const n=(t-1)%3+1;return e.å½“å‰æ—¶æ®µ=1===n?"æ—©ä¸Š":2===n?"ä¸­åˆ":"æ™šä¸Š",e}function getGameTime(){return gameState.æ¸¸æˆæ—¶é—´||(gameState.æ¸¸æˆæ—¶é—´={"å½“å‰å›åˆ":1}),normalizeGameTime(gameState.æ¸¸æˆæ—¶é—´)}function rand01(){if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]/4294967296}return Math.random()}function randInt(e,t){return Math.floor(rand01()*(t-e+1))+e}function pickTwoDistinct(e){if(!e||e.length<2)return[e?.[0]||"â€”","â€”"];const t=randInt(0,e.length-1);let n=randInt(0,e.length-1);for(;n===t;)n=randInt(0,e.length-1);return[e[t],e[n]]}const LIMITED_TAG_SOURCES={chars:["å½±","å…‰","æ¢¦","ç½ª","å»","é›¾","æœˆ","æ˜Ÿ","ç«","å°˜","ç ‚","å¼¦","é“ƒ","é—¨","é’¥","é•œ","å¢¨","é›¨","é›ª","é£","æ˜¥","å¤","ç§‹","å†¬","ç¦","ç¥ˆ","æ¸´","æ½®","ç—•","ç›","åˆƒ","ç± ","å¥‘","è°","èª“","å¤œ","æ˜¼","ç©º","é›¶","ä¸ƒ","ä¹","ç¢‘","çƒ›","ç»¸","ç»","æ™¶","çº±","ç»’","é”","é“¾","ç´","é…’","ç³–","é’ˆ","çº¸","ç¾½","æ½®"],nouns:["æ¤…å­","æ±¤åŒ™","è‚¥çš‚æ³¡","éœ“è™¹ç¯","é£é“ƒ","æ²™æ¼","é’¥åŒ™","é•œå­","èœ¡çƒ›","ç¾½æ¯›","ç»ç’ƒçƒ","é“é’‰","ä¸ç»¸","ç›","ç«ç„°","å†°å—","å½±å­","å›éŸ³","å°˜åŸƒ","è†æ£˜","æ³‰æ°´","é™¨çŸ³","é›ªèŠ±","é›·ç”µ","å½©è™¹","è¿·é›¾","æ¼©æ¶¡","è—¤è”“","æ°´æ™¶","é’Ÿè¡¨","æ€€è¡¨","å”±ç‰‡","ç•™å£°æœº","é“¶å¸","é‡‘ç²‰","çƒŸç°","é¦™æ°´","é¦™è–°","è¯ç“¶","è¯•ç®¡","ä¹¦é¡µ","ä¹¦ç­¾","ä¿¡å°","å°èœ¡","èŠ±æŸ","å¹²èŠ±","ç«ç‘°åˆº","çŒ«çœ¼çŸ³","é»‘æ›œçŸ³","çç ","çº¢ç»³","é¢å…·","æ‰‹å¥—","é¡¹åœˆ","é“ƒé“›","ä¸å¸¦","é”é“¾","ç¾½æ‰‡","çº¸ä¼","æ²¹çº¸","é›¨å··","ç”µæ¢¯","åœ°é“","å¤©çº¿","è€³æœº","å±å¹•","åƒç´ ","404","å¤‡å¿˜å½•","æ”¶æ®","è½¦ç¥¨","è½¦çª—","åè§†é•œ","ç©ºç“¶","å†·å’–å•¡","é»‘ç³–","è–„è·","è‹¦è‰¾é…’","é¦™æ§Ÿ","å¨å£«å¿Œ","é»‘èƒ¶","å™ªéŸ³","å›å£°å®¤","æœˆå…‰","é˜´å½±","çƒ›å…‰","é›¾æ°”"],concepts:["ç›¸å¯¹è®º","é‡å­","æ‚–è®º","å®¿å‘½","æ•‘èµ","èƒŒå›","çœŸç†","è°è¨€","è¾¹ç•Œ","è™šæ— ","é‡åŠ›","å›å£°","å™©æ¢¦","ç«¥è¯","ç¥ˆç¥·","è¯…å’’","å¥‘çº¦","ç¦å¿Œ","è§„åˆ™","åè§","èµç½ª","è½®å›","å€’å¸¦","é‡å¯","ç©ºç™½","åŒ¿å","æœªå¯„å‡ºçš„ä¿¡","æœªè¯»æ¶ˆæ¯","å‡Œæ™¨ä¸‰ç‚¹","æ˜ŸæœŸä¸‰","ç¬¬ä¸ƒæ¬¡","ç¬¬äºŒäººæ ¼","å®Œç¾ä¸»ä¹‰","å¤±æ§","æ¸©æŸ”","æ®‹é…·","æµªæ¼«","è’è¯","å¯‚é™","å–§åš£","ä½è¯­","å‡è§†","åçˆ±","è¯¯è§£"],adjs:["æ½®æ¹¿çš„","å¹²ç‡¥çš„","å†°å†·çš„","ç¼çƒ­çš„","é€æ˜çš„","å‘å…‰çš„","è„†å¼±çš„","é”‹åˆ©çš„","æ¸©æŸ”çš„","æš´èºçš„","æ— å£°çš„","å–§åš£çš„","ç ´ç¢çš„","å®Œæ•´çš„","å‡‹é›¶çš„","æ–°ç”Ÿçš„","è¿Ÿåˆ°çš„","è¿‡æœŸçš„","ç©ºç™½çš„","åŒ¿åçš„","æœ€åçš„","ç¬¬ä¸€çš„","æœªå‘½åçš„","ç¦å¿Œçš„","è’è¯çš„","ç¥ç§˜çš„","ä¼˜é›…çš„","å±é™©çš„","ç”œçš„","è‹¦çš„","å’¸çš„","å¾®é†ºçš„","é»¯æ·¡çš„","é—ªçƒçš„","ç»†ç¢çš„","é»ç€çš„"],verbs:["å·èµ°","é—å¿˜","æ”¶è—","æŠ˜å ","ç¿»è¯‘","ç‚¹ç‡ƒ","å†»ç»“","å´©å¡Œ","è‹é†’","æ²‰ç¡","å›æ”¶","é‡å¯","æ½œå…¥","ç¼ ç»•","æ¼‚æµ","å€’å¸¦","æŠ•å½±","çƒ™å°","ç­¾å­—","å€Ÿèµ°","å½’è¿˜","äº¤æ¢","å°å­˜","èµå›","è¿½é€","å‡è§†"],phrases:["åˆ«å›å¤´","è¯·ç­¾å­—","ä»Šæ™šæ— çœ ","æŠŠç«ç•™ç»™æˆ‘","åˆ«æŠŠåå­—è¯´å‡ºæ¥","æŠŠé’¥åŒ™äº¤å‡ºæ¥","åœ¨é›¨é‡Œç­‰ä½ ","ä½ å¬è§äº†å—","åˆ«è£…ä½œæ— äº‹å‘ç”Ÿ","æ„¿æœ›è¦ä»˜å‡ºä»£ä»·","åªè®¸ä¸€æ¬¡","æˆ‘ä¸æ¬ ä½ ","ä½ æ¬ æˆ‘ä¸€ä¸ªè§£é‡Š","æŠŠå…‰å…³æ‰","æŠŠé—¨é”ä¸Š","åˆ«è®©å®ƒé†’æ¥","åˆ«æŠŠæˆ‘å¿˜äº†","æŠŠèª“è¨€çƒ§æ‰","æŠŠè°è¨€åä¸‹"],symbols:["âˆ","0","1","7","13","404","NULL","NO SIGNAL","DEAD END","#tag","???"],edge:["å°¿æ¶²","å­•è‚š"]};function sanitizeLimitedTag(e){if(null==e)return"â€”";let t=String(e).replace(/[\r\n\t]+/g," ").replace(/\s{2,}/g," ").trim();if(t=t.replace(/^["â€œâ€'ã€Œã€ã€ã€ã€Šã€‹ã€ã€‘ï¼ˆï¼‰()]+/,"").replace(/["â€œâ€'ã€Œã€ã€ã€ã€Šã€‹ã€ã€‘ï¼ˆï¼‰()]+$/,""),t=t.replace(/\s{2,}/g," ").trim(),!t)return"â€”";return t.length>26&&(t=t.slice(0,26)+"â€¦"),t}function isLimitedTagBanned(e){const t=String(e||"");if(!t.trim())return!0;return!![/(å±|ç²ª|å¤§ä¾¿|ä¾¿ä¾¿|ç²ªä¾¿|é©¬æ¡¶|å•æ‰€|ç²ªå‘|æ’æ³„)/i,/(æœˆç»|ç»è¡€|è¡€å—|ç»æœŸ)/i,/(å‘•å|å‘•|å|å‘•åç‰©)/i,/(è…çƒ‚|è…è´¥|è…è‡­|è„“|åŒ–è„“|çƒ‚è‚‰|è›†)/i,/(å°¸å¥¸|æ­»å°¸|å°¸ä½“|è…å°¸|é£Ÿå°¸|åƒµå°¸|é£Ÿå°¸é¬¼|æœ¨ä¹ƒä¼Š)/i,/(æ–­è‚¢|æˆªè‚¢|æ®‹è‚¢|å¼€è†›|å†…è„|è‚ å­|è„‘æµ†|å‰–è…¹|ç¢å°¸|è¡€è…¥)/i,/(æ˜†è™«|è •è™«|è™«å­|å¯„ç”Ÿè™«|èŸ‘è‚|èœ˜è››|èå­|èœˆèš£|è›†è™«)/i,/(å…¨å…½|å…½åŒ–|å…½äºº|ç‹—äºº|çŒ«äºº|ç‹¼äºº|ç‹äºº)/i,/(è‚¥èƒ–|èƒ–å­|ä¸‘|ä¸‘é™‹|çŒ¥ç|ç§ƒå¤´|å…‰å¤´|æ²¹è…»|è€äºº|å¤§å”)/i].some(e=>e.test(t))}function limitedTagKind(e){const t=String(e||"").trim();return t?1===t.length?"char":/^[0-9]+$/.test(t)?"symbol":/[ã€Œã€ã€ã€ã€Šã€‹ã€ã€‘]/.test(t)?"quote":/[ï¼Œã€‚ï¼ï¼Ÿâ€¦]/.test(t)?"sentence":/[çš„ä¸åœ¨æŠŠåˆ«è¯·]/.test(t)?"phrase":"word":"empty"}function pickOne(e){return e[randInt(0,e.length-1)]}function pickWeighted(e){const t=e.reduce((e,t)=>e+(t?.[1]||0),0);if(t<=0)return e?.[0]?.[0];let n=rand01()*t;for(const[t,a]of e)if(n-=a,n<=0)return t;return e[e.length-1][0]}function generateRawLimitedTag(){const e=()=>pickOne(LIMITED_TAG_SOURCES.nouns),t=()=>pickOne(LIMITED_TAG_SOURCES.concepts),n=()=>pickOne(LIMITED_TAG_SOURCES.adjs),a=()=>pickOne(LIMITED_TAG_SOURCES.phrases);switch(pickWeighted([["char",.12],["word",.34],["adjNoun",.18],["nounOfNoun",.12],["nounVerbNoun",.1],["quote",.06],["sentence",.05],["symbolMix",.02],["edge",.01]])){case"char":return pickOne(LIMITED_TAG_SOURCES.chars);case"word":return rand01()<.6?e():t();case"adjNoun":return n()+(rand01()<.65?e():t());case"nounOfNoun":return(rand01()<.6?e():t())+"çš„"+(rand01()<.7?e():t());case"nounVerbNoun":return(rand01()<.55?e():t())+pickOne(LIMITED_TAG_SOURCES.verbs)+(rand01()<.7?e():t());case"quote":return rand01()<.5?`ã€Œ${a()}ã€`:`ã€Š${a()}ã€‹`;case"sentence":return pickWeighted([[`${a()}ã€‚`,.4],[`${a()}ï¼Œ${a()}ã€‚`,.25],[`${n()}${e()}ï¼Œ${a()}ã€‚`,.2],[`${t()}ï¼Œ${e()}ã€‚`,.15]]);case"symbolMix":return`${pickOne(LIMITED_TAG_SOURCES.symbols)} ${rand01()<.6?e():t()}`;case"edge":return pickOne(LIMITED_TAG_SOURCES.edge);default:return e()}}function scoreLimitedTagPair(e,t){if(!e||!t)return-999;if("â€”"===e||"â€”"===t)return-999;if(e===t)return-999;if(isLimitedTagBanned(e)||isLimitedTagBanned(t))return-999;const n=/(å°¿æ¶²|å­•è‚š|æ€€å­•)/i,a=/(å¥³ä»†|æŠ¤å£«|ä¿®å¥³|é­…é­”|çŒ«å¨˜|å…”å¥³éƒ|ç§˜ä¹¦|å¶åƒ|å…¬ä¸»|å¥³ç‹)/;let o=0;limitedTagKind(e)!==limitedTagKind(t)&&(o+=2);const i=e=>{const t=String(e).length;return 1===t?0:t>=2&&t<=10?2:t<=14?1:t<=20?0:-1};return o+=i(e)+i(t),/[ã€Œã€ã€ã€ã€Šã€‹ã€ã€‘]/.test(e)&&(o+=2),/[ã€Œã€ã€ã€ã€Šã€‹ã€ã€‘]/.test(t)&&(o+=2),/[ï¼Œã€‚ï¼ï¼Ÿâ€¦]/.test(e)&&(o+=1),/[ï¼Œã€‚ï¼ï¼Ÿâ€¦]/.test(t)&&(o+=1),/[âˆ#?]/.test(e)&&(o+=.5),/[âˆ#?]/.test(t)&&(o+=.5),a.test(e)&&(o-=2),a.test(t)&&(o-=2),n.test(e)&&(o-=4),n.test(t)&&(o-=4),n.test(e)&&n.test(t)&&(o-=50),1===String(e).length&&1===String(t).length&&(o-=3),o+=.01*rand01(),o}function generateLimitedTags(){let e=null,t=-999;for(let n=0;n<80;n++){let n=sanitizeLimitedTag(generateRawLimitedTag()),a=sanitizeLimitedTag(generateRawLimitedTag());if(n===a)continue;if(isLimitedTagBanned(n)||isLimitedTagBanned(a))continue;const o=scoreLimitedTagPair(n,a);o>t&&(t=o,e=[n,a])}return e||["â€”","â€”"]}function getLimitedPoolState(){return gameState.å¡æ± ||(gameState.å¡æ± ={}),gameState.å¡æ± .é™å®š||(gameState.å¡æ± .é™å®š={"è¯æ¡":["â€”","â€”"],"å‘¨æœŸ":-1}),gameState.å¡æ± .é™å®š}function updateLimitedPoolIfNeeded(){const e=getGameTime(),t=Math.floor(((e.å¤©æ•°||1)-1)/3),n=getLimitedPoolState();if(n.å‘¨æœŸ!==t||!n.è¯æ¡||2!==n.è¯æ¡.length){const[e,a]=generateLimitedTags();n.è¯æ¡=[e,a],n.å‘¨æœŸ=t,console.info("é™å®šå¡æ± æ›´æ–°:",n.è¯æ¡,"ï¼ˆä¸‡ç‰©è¯æ¡ + å®¡ç¾å®‰å…¨ç½‘ï¼‰","å‘¨æœŸ",n.å‘¨æœŸ)}return n}function getCurrentTimePeriod(){return getGameTime().å½“å‰æ—¶æ®µ||"æ—©ä¸Š"}function advanceRound(){const e=getGameTime(),t=e.å½“å‰å›åˆ,n=(t-1)%3+1;e.å½“å‰å›åˆ=t+1,normalizeGameTime(e),updateLimitedPoolIfNeeded(),processGameSettlement();const a=(e.å½“å‰å›åˆ-1)%3+1;3===n&&1===a&&processDailySettlement(),gameState.ç»Ÿè®¡æ•°æ®&&(gameState.ç»Ÿè®¡æ•°æ®.æ¸¸æˆæ—¶é—´=e.å½“å‰å›åˆ),gameState.å¦“é™¢?.æˆ¿é—´çŠ¶æ€&&Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).forEach(([e,t])=>{if(t.å½“å‰è§’è‰²){"ä½¿ç”¨ä¸­"!==t.çŠ¶æ€&&(console.warn(`ä¿®å¤æˆ¿é—´ ${e} çŠ¶æ€ï¼šä»"${t.çŠ¶æ€}"æ”¹ä¸º"ä½¿ç”¨ä¸­"ï¼ˆå›åˆæ¨è¿›åæ£€æŸ¥ï¼‰`),t.çŠ¶æ€="ä½¿ç”¨ä¸­");const n=gameState.è§’è‰²ä»“åº“?.[t.å½“å‰è§’è‰²];n&&("è°ƒæ•™å®¤"===t.ç±»å‹&&"è°ƒæ•™ä¸­"!==n.çŠ¶æ€?n.çŠ¶æ€="è°ƒæ•™ä¸­":"è°ƒæ•™å®¤"!==t.ç±»å‹&&"ä¼‘æ¯å®¤"!==t.ç±»å‹&&"åŒ»ç–—å®¤"!==t.ç±»å‹&&"æ¥å®¢ä¸­"!==n.çŠ¶æ€&&(n.çŠ¶æ€="æ¥å®¢ä¸­"))}}),refreshAllPages(),saveGameStateToMVU(),console.info(`æ¨è¿›åˆ°ç¬¬${e.å¤©æ•°}å¤© ${e.å½“å‰æ—¶æ®µ}ï¼ˆå›åˆ ${e.å½“å‰å›åˆ}ï¼‰`)}function processGameSettlement(){const e=getGameTime();console.info("æ‰§è¡Œæ¸¸æˆç»“ç®—..."),Object.entries(gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²||{}).forEach(([t,n])=>{const a=n.å¼€å§‹å›åˆ||e.å½“å‰å›åˆ-1;e.å½“å‰å›åˆ>=a+2&&completeWorkingService(t)}),Object.entries(gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²||{}).forEach(([t,n])=>{const a=n.å¼€å§‹å›åˆ||e.å½“å‰å›åˆ-1,o=n.é¢„è®¡ç»“æŸå›åˆ||a+2;e.å½“å‰å›åˆ>=o&&completeTrainingSession(t)}),Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€||{}).forEach(([t,n])=>{if("ä½¿ç”¨ä¸­"!==n.çŠ¶æ€||!n.å½“å‰è§’è‰²)return;if("ä¼‘æ¯å®¤"!==n.ç±»å‹&&"åŒ»ç–—å®¤"!==n.ç±»å‹)return;const a=gameState.è§’è‰²ä»“åº“?.[n.å½“å‰è§’è‰²];if(!a)return;a.å±æ€§||(a.å±æ€§={}),"number"!=typeof a.å±æ€§.è€åŠ›&&(a.å±æ€§.è€åŠ›="åŒ»ç–—å®¤"===n.ç±»å‹?30:50);const o="åŒ»ç–—å®¤"===n.ç±»å‹?20:10;if(a.å±æ€§.è€åŠ›=Math.min(100,(a.å±æ€§.è€åŠ›||0)+o),"åŒ»ç–—å®¤"===n.ç±»å‹&&a.æƒ…æ„ŸçŠ¶æ€?.ç‰¹æ®ŠçŠ¶æ€?.length){const e=a.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.indexOf("å´©æºƒ");e>=0&&a.å±æ€§.è€åŠ›>=60&&a.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.splice(e,1)}if(a.å±æ€§.è€åŠ›>=100){const o=n.å½“å‰è§’è‰²;n.çŠ¶æ€="ç©ºé—²",n.å½“å‰è§’è‰²=void 0,a.çŠ¶æ€="ç©ºé—²",a.å½“å‰ä½ç½®="ä»“åº“",pushBrothelLog({"æ—¶é—´æˆ³":e.å½“å‰å›åˆ,"è§’è‰²ID":o,"äº‹ä»¶ç±»å‹":"æ¢å¤å®Œæˆ","æè¿°":`${a.å§“å}æ¢å¤å®Œæˆï¼Œç¦»å¼€${n.ç±»å‹}${t}`,"æ”¶å…¥å˜åŒ–":0})}}),gameState.è®¾ç½®?.è‡ªåŠ¨è¥ä¸š&&"æš‚åœè¥ä¸š"!==gameState.å¦“é™¢?.è¥ä¸šçŠ¶æ€&&processAutoBusiness()}function completeWorkingService(e){const t=gameState.è§’è‰²ä»“åº“[e],n=gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[e];if(!t||!n)return;normalizeCharacter(t);let a=n.åŸºç¡€æ”¶å…¥+n.é¢å¤–æ”¶å…¥;const o=Object.keys(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).find(t=>gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[t].å½“å‰è§’è‰²===e);if(o){const e=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[o],t=(roomTypes[e.ç±»å‹]||roomTypes.æ™®é€š,decorationThemes[e.è£…é¥°ä¸»é¢˜]||decorationThemes.æ ‡å‡†);a*=(e.æ”¶å…¥å€ç‡||1)*(1+t.incomeBonus)}a*={"çˆ±":1.5,"å–œæ¬¢":1.2,"ä¸­ç«‹":1,"åŒæ¶":.7,"æ†æ¨":.4}[t.æƒ…æ„ŸçŠ¶æ€?.å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ||"ä¸­ç«‹"]||1;const i=t.æƒ…æ„ŸçŠ¶æ€?.ç‰¹æ®ŠçŠ¶æ€||[];i.includes("éº»æœ¨")&&(a*=.8),i.includes("å¿ è¯š")&&(a*=1.3),i.includes("åæŠ—")&&(a*=.5),i.includes("å´©æºƒ")&&(a*=.3),a*=gameState.è®¾ç½®?.æ”¶ç›Šå€ç‡||1,gameState.è´§å¸+=Math.floor(a),gameState.å¦“é™¢.ä»Šæ—¥æ”¶å…¥+=Math.floor(a),gameState.ç»Ÿè®¡æ•°æ®.æ€»æ”¶å…¥+=Math.floor(a),gameState.ç»Ÿè®¡æ•°æ®.æ€»æ¥å®¢æ¬¡æ•°+=1,t.çŠ¶æ€=t.å±æ€§?.è€åŠ›<20?"ä¼‘æ¯ä¸­":t.å±æ€§?.è€åŠ›<5?"åŒ»ç–—å®¤":"ç©ºé—²",t.å½“å‰ä½ç½®="åŒ»ç–—å®¤"===t.çŠ¶æ€?"åŒ»ç–—å®¤":"ä»“åº“",delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[e],o&&(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[o].çŠ¶æ€="ç©ºé—²",gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[o].å½“å‰è§’è‰²=void 0);const r=t.æƒ…æ„ŸçŠ¶æ€?.å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ||"ä¸­ç«‹";"çˆ±"===r||"å–œæ¬¢"===r?t.å¥½æ„Ÿåº¦=clampNumber((t.å¥½æ„Ÿåº¦||0)+randInt(1,3),0,100):"åŒæ¶"===r||"æ†æ¨"===r?t.æ¨æ„=clampNumber((t.æ¨æ„||0)+randInt(1,3),0,100):rand01()<.5&&(t.å¥½æ„Ÿåº¦=clampNumber((t.å¥½æ„Ÿåº¦||0)+1,0,100)),t.å…³ç³»é˜¶æ®µ=computeRelationshipStage(t.å¥½æ„Ÿåº¦,t.æ¨æ„),checkRelationshipTriggers(e,"æ¥å®¢ç»“ç®—"),pushBrothelLog({"æ—¶é—´æˆ³":getGameTime().å½“å‰å›åˆ||1,"è§’è‰²ID":e,"äº‹ä»¶ç±»å‹":"æ¥å®¢å®Œæˆ","æè¿°":`${t.å§“å}å®Œæˆæ¥å®¢ï¼Œè·å¾—æ”¶å…¥ ${Math.floor(a)} é‡‘`,"æ”¶å…¥å˜åŒ–":Math.floor(a)}),console.info(`è§’è‰² ${t.å§“å} å®Œæˆæ¥å®¢ï¼Œè·å¾—æ”¶å…¥ ${Math.floor(a)} é‡‘`)}function completeTrainingSession(e){const t=gameState.è§’è‰²ä»“åº“?.[e],n=gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[e];if(!t||!n)return;normalizeCharacter(t);const a=clampNumber(n.å¼ºåº¦??2,1,3),o=trainingPrograms.find(e=>e.key===n.è¯¾ç¨‹),i=getGameTime();let r,s,l=[];if(o)Object.entries(o.focus||{}).forEach(([e,n])=>{const o=randInt(n?.[0]??1,n?.[1]??3)+(a-1);t.å±æ€§[e]=clampNumber((t.å±æ€§?.[e]||0)+o,0,100),l.push(`${e}+${o}`)}),r=randInt(o.like[0],o.like[1])+(3===a?1:0),s=randInt(o.hate[0],o.hate[1])+(3===a?1:0),"æé™ç ´é™"===o.key&&a>=2&&(rand01()<.35&&(t.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.includes("éº»æœ¨")||t.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.push("éº»æœ¨")),rand01()<.25&&(t.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.includes("åæŠ—")||t.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.push("åæŠ—")));else{const e=n.è¯¾ç¨‹||"",o=e.includes("å¼ºå¥¸")||e.includes("æš´åŠ›")||e.includes("è¡€è…¥")||e.includes("è™«")&&!e.includes("è™«åµ"),i=e.includes("å£")||e.includes("æ€§")||e.includes("BDSM")||e.includes("SM")||e.includes("å…½äº¤")||e.includes("è§¦æ‰‹"),c=e.includes("ç¾è€»")||e.includes("å‡Œè¾±")||e.includes("è°ƒæ•™")||e.includes("å¥³ç‹"),d=["æŠ€å·§","é¡ºä»","æ•æ„Ÿåº¦","è€åŠ›","é­…åŠ›"],m=[],p=randInt(2,4);for(;m.length<p;){const e=d[randInt(0,d.length-1)];m.includes(e)||m.push(e)}m.forEach(e=>{const n=randInt(3,8)+2*(a-1),r=o?1.5:i?1.3:c?1.2:1,s=Math.floor(n*r);t.å±æ€§[e]=clampNumber((t.å±æ€§?.[e]||0)+s,0,100),l.push(`${e}+${s}`)});const g=randInt(-2,5),u=randInt(-1,4);r=g+(c?randInt(0,3):0)+(3===a?randInt(0,2):0),s=u+(o?randInt(1,4):0)+(3===a?randInt(0,3):0),o&&a>=2&&(rand01()<.4&&(t.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.includes("éº»æœ¨")||t.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.push("éº»æœ¨")),rand01()<.3&&(t.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.includes("åæŠ—")||t.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.push("åæŠ—")),rand01()<.2&&(t.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.includes("å´©æºƒ")||t.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.push("å´©æºƒ")))}t.å¥½æ„Ÿåº¦=clampNumber((t.å¥½æ„Ÿåº¦||0)+r,0,100),t.æ¨æ„=clampNumber((t.æ¨æ„||0)+s,0,100),t.å…³ç³»é˜¶æ®µ=computeRelationshipStage(t.å¥½æ„Ÿåº¦,t.æ¨æ„);const c=n.æˆ¿é—´å·||Object.keys(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€||{}).find(t=>gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[t]?.å½“å‰è§’è‰²===e);if(c){const e=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[c];e.çŠ¶æ€="ç©ºé—²",e.å½“å‰è§’è‰²=void 0}delete gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²[e];const d=t.å±æ€§?.è€åŠ›||0;t.çŠ¶æ€=d<5?"åŒ»ç–—å®¤":d<20?"ä¼‘æ¯ä¸­":"ç©ºé—²",t.å½“å‰ä½ç½®="åŒ»ç–—å®¤"===t.çŠ¶æ€?"åŒ»ç–—å®¤":"ä»“åº“",pushBrothelLog({"æ—¶é—´æˆ³":i.å½“å‰å›åˆ||1,"è§’è‰²ID":e,"äº‹ä»¶ç±»å‹":"è®­ç»ƒå®Œæˆ","æè¿°":`${t.å§“å}å®Œæˆè¯¾ç¨‹ã€${o.key}ã€‘ï¼ˆå¼ºåº¦${a}ï¼‰ Â· ${l.join("ï¼Œ")} Â· å¥½æ„Ÿ+${r} / æ¨æ„+${s}`,"æ”¶å…¥å˜åŒ–":0}),checkRelationshipTriggers(e,"è®­ç»ƒç»“ç®—")}function processDailySettlement(){console.info("æ‰§è¡Œæ¯æ—¥ç»“ç®—..."),gameState.å¦“é™¢.å†å²æ€»æ”¶å…¥+=gameState.å¦“é™¢.ä»Šæ—¥æ”¶å…¥,gameState.å¦“é™¢.ä»Šæ—¥æ”¶å…¥=0,Object.values(gameState.è§’è‰²ä»“åº“||{}).forEach(e=>{"ä¼‘æ¯ä¸­"===e.çŠ¶æ€&&e.å±æ€§?.è€åŠ›<100&&(e.å±æ€§.è€åŠ›=Math.min(100,(e.å±æ€§.è€åŠ›||0)+10))}),console.info("æ¯æ—¥ç»“ç®—å®Œæˆ")}function processAutoBusiness(){const e=getGameTime(),t=Object.entries(gameState.è§’è‰²ä»“åº“||{}).filter(([,e])=>"ç©ºé—²"===e.çŠ¶æ€&&"ä»“åº“"===e.å½“å‰ä½ç½®).map(([e])=>e),n=Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€||{}).filter(([,e])=>"ç©ºé—²"===e.çŠ¶æ€&&(!1!==e.è§£é”&&!["è°ƒæ•™å®¤","ä¼‘æ¯å®¤","åŒ»ç–—å®¤"].includes(e.ç±»å‹))).map(([e])=>e),a=Math.min(t.length,n.length);for(let o=0;o<a;o++)batchAssignLocal(n[o],t[o],e.å½“å‰å›åˆ||1)}function openSynthesis(){const e=document.createElement("div");e.className="modal",e.id="synthesis-modal",e.innerHTML='\n                <div class="modal-content" style="max-width: 900px">\n                  <button class="modal-close" onclick="closeSynthesis()">Ã—</button>\n                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">ğŸ”¬ è§’è‰²åˆæˆ</h2>\n\n                  <div style="margin-bottom: 24px; padding: 16px; background: rgba(30, 41, 59, 0.6); border-radius: 12px">\n                    <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">åˆæˆè§„åˆ™</h3>\n                    <ul style="line-height: 2; color: var(--text-secondary); font-size: 14px">\n                      <li>é€‰æ‹©2-5ä¸ªè§’è‰²è¿›è¡Œåˆæˆ</li>\n                      <li>åˆæˆåçš„è§’è‰²ç¨€æœ‰åº¦ä¼šæ ¹æ®ç´ æè§’è‰²æå‡</li>\n                      <li>æ–°è§’è‰²çš„å±æ€§ä¼šèåˆç´ æè§’è‰²çš„ç‰¹å¾</li>\n                      <li>åˆæˆåç´ æè§’è‰²å°†è¢«æ¶ˆè€—</li>\n                      <li>ç¨€æœ‰åº¦æå‡è§„åˆ™ï¼šN+Nâ†’R, R+Râ†’SR, SR+SRâ†’SSR, SSR+SSRâ†’SSR+</li>\n                    </ul>\n                  </div>\n\n                  <div style="margin-bottom: 24px">\n                    <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å·²é€‰æ‹©è§’è‰² (<span id="selected-count">0</span>/5)</h3>\n                    <div id="selected-characters" style="display: flex; flex-wrap: wrap; gap: 12px; min-height: 80px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; border: 2px dashed rgba(139, 92, 246, 0.3)">\n                      <div style="width: 100%; text-align: center; color: var(--text-secondary); padding: 20px">ä»ä¸‹æ–¹é€‰æ‹©è§’è‰²è¿›è¡Œåˆæˆ</div>\n                    </div>\n                  </div>\n\n                  <div style="margin-bottom: 24px">\n                    <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å¯é€‰è§’è‰²</h3>\n                    <div id="synthesis-character-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px"></div>\n                  </div>\n\n                  <div style="display: flex; gap: 12px; justify-content: flex-end">\n                    <button class="btn btn-secondary" onclick="closeSynthesis()">å–æ¶ˆ</button>\n                    <button class="btn" id="btn-synthesize" onclick="confirmSynthesis()" disabled>å¼€å§‹åˆæˆ</button>\n                  </div>\n                </div>\n              ',document.body.appendChild(e),e.classList.add("active"),window.selectedSynthesisChars||(window.selectedSynthesisChars=[]),refreshSynthesisPage()}function closeSynthesis(){const e=document.getElementById("synthesis-modal");e&&(e.classList.remove("active"),setTimeout(()=>e.remove(),300)),window.selectedSynthesisChars&&(window.selectedSynthesisChars=[])}function refreshSynthesisPage(){const e=document.getElementById("synthesis-character-list");if(!e)return void console.warn("synthesis-character-list å…ƒç´ ä¸å­˜åœ¨");if(e.innerHTML="",!gameState.è§’è‰²ä»“åº“||"object"!=typeof gameState.è§’è‰²ä»“åº“)return console.warn("è§’è‰²ä»“åº“ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯:",gameState.è§’è‰²ä»“åº“),void(e.innerHTML='<div style="text-align: center; color: var(--text-secondary); padding: 40px">è§’è‰²ä»“åº“æ•°æ®å¼‚å¸¸</div>');const t=Object.entries(gameState.è§’è‰²ä»“åº“).filter(([e,t])=>{const n=t&&("ç©ºé—²"===t.çŠ¶æ€||!t.çŠ¶æ€),a=t&&("ä»“åº“"===t.å½“å‰ä½ç½®||!t.å½“å‰ä½ç½®);return n&&a}).map(([e,t])=>({id:e,...t}));console.info("å¯åˆæˆè§’è‰²æ•°é‡:",t.length,"æ€»è§’è‰²æ•°:",Object.keys(gameState.è§’è‰²ä»“åº“).length),0!==t.length?(t.forEach(({id:t,...n})=>{const a=window.selectedSynthesisChars&&window.selectedSynthesisChars.includes(t),o=document.createElement("div");o.className=`character-list-item rarity-${n.ç¨€æœ‰åº¦}`,o.style.cssText=`\n                  padding: 12px;\n                  cursor: pointer;\n                  border: 2px solid ${a?"var(--primary)":"rgba(139, 92, 246, 0.3)"};\n                  background: ${a?"rgba(139, 92, 246, 0.2)":"rgba(30, 41, 59, 0.6)"};\n                  opacity: ${a?"1":"0.8"};\n                `,o.innerHTML=`\n                  <div style="font-size: 16px; font-weight: bold; margin-bottom: 4px">${n.å§“å}</div>\n                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px">${n.ç¨€æœ‰åº¦} Â· ${n.èŒä¸šèº«ä»½||"æ— "}</div>\n                  <div style="font-size: 11px; color: var(--text-secondary)">\n                    é­…åŠ›: ${n.å±æ€§?.é­…åŠ›||0} | é¡ºä»: ${n.å±æ€§?.é¡ºä»||0}\n                  </div>\n                  ${a?'<div style="margin-top: 8px; font-size: 12px; color: var(--primary)">âœ“ å·²é€‰æ‹©</div>':""}\n                `,o.onclick=()=>toggleSynthesisCharacter(t),e.appendChild(o)}),updateSynthesisSelection()):e.innerHTML='<div style="text-align: center; color: var(--text-secondary); padding: 40px">æ²¡æœ‰å¯åˆæˆçš„è§’è‰²ï¼ˆéœ€è¦çŠ¶æ€ä¸º"ç©ºé—²"ä¸”ä½ç½®ä¸º"ä»“åº“"çš„è§’è‰²ï¼‰</div>'}function toggleSynthesisCharacter(e){window.selectedSynthesisChars||(window.selectedSynthesisChars=[]);const t=window.selectedSynthesisChars.indexOf(e);if(t>-1)window.selectedSynthesisChars.splice(t,1);else{if(window.selectedSynthesisChars.length>=5)return void alert("æœ€å¤šåªèƒ½é€‰æ‹©5ä¸ªè§’è‰²ï¼");window.selectedSynthesisChars.push(e)}refreshSynthesisPage()}function updateSynthesisSelection(){const e=document.getElementById("selected-characters"),t=document.getElementById("selected-count"),n=document.getElementById("btn-synthesize");t&&(t.textContent=window.selectedSynthesisChars?window.selectedSynthesisChars.length:0),n&&(n.disabled=!window.selectedSynthesisChars||window.selectedSynthesisChars.length<2),e&&(window.selectedSynthesisChars&&0!==window.selectedSynthesisChars.length?e.innerHTML=window.selectedSynthesisChars.map(e=>{const t=gameState.è§’è‰²ä»“åº“[e];return t?`\n                        <div style="padding: 12px; background: rgba(139, 92, 246, 0.2); border-radius: 8px; border: 1px solid var(--primary); position: relative">\n                          <div style="font-size: 14px; font-weight: bold; margin-bottom: 4px">${t.å§“å}</div>\n                          <div style="font-size: 11px; color: var(--text-secondary)">${t.ç¨€æœ‰åº¦}</div>\n                          <button onclick="toggleSynthesisCharacter('${e}'); event.stopPropagation();" style="position: absolute; top: 4px; right: 4px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; line-height: 1">Ã—</button>\n                        </div>\n                      `:""}).join(""):e.innerHTML='<div style="width: 100%; text-align: center; color: var(--text-secondary); padding: 20px">ä»ä¸‹æ–¹é€‰æ‹©è§’è‰²è¿›è¡Œåˆæˆ</div>')}async function confirmSynthesis(){if(!window.selectedSynthesisChars||window.selectedSynthesisChars.length<2)return void alert("è‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªè§’è‰²ï¼");if(window.selectedSynthesisChars.length>5)return void alert("æœ€å¤šåªèƒ½é€‰æ‹©5ä¸ªè§’è‰²ï¼");const e=window.selectedSynthesisChars.map(e=>{const t=gameState.è§’è‰²ä»“åº“[e];return t?`${e}ï¼ˆ${t.å§“å}ï¼‰`:e}).join("ã€");if(!confirm(`ç¡®å®šè¦åˆæˆä»¥ä¸‹è§’è‰²å—ï¼Ÿ\n\n${e}\n\nåˆæˆåè¿™äº›è§’è‰²å°†è¢«æ¶ˆè€—ã€‚`))return;const t=`åˆæˆè§’è‰²ã€‚å°†ä»¥ä¸‹è§’è‰²è¿›è¡Œåˆæˆï¼š${window.selectedSynthesisChars.join("ã€")}ã€‚\n\n      è¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\n      1. æ ¹æ®ç´ æè§’è‰²çš„ç¨€æœ‰åº¦è®¡ç®—æ–°è§’è‰²çš„ç¨€æœ‰åº¦ï¼ˆN+Nâ†’R, R+Râ†’SR, SR+SRâ†’SSR, SSR+SSRâ†’SSR+ï¼‰\n      2. èåˆç´ æè§’è‰²çš„ç‰¹å¾ï¼ˆå§“åã€èŒä¸šã€å¤–è²Œã€æ€§æ ¼ã€èƒŒæ™¯æ•…äº‹ç­‰ï¼‰\n      3. èåˆç´ æè§’è‰²çš„å±æ€§ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦å–å¹³å‡å€¼æˆ–æ ¹æ®ç¨€æœ‰åº¦æå‡ï¼‰\n      4. ç”Ÿæˆæ–°è§’è‰²çš„å®Œæ•´èµ„æ–™ï¼ˆåŒ…æ‹¬ç»˜å›¾æ ‡ç­¾å’Œè‡ªå®šä¹‰å‰ç«¯HTMLï¼‰\n      5. åœ¨è§’è‰²ä»“åº“ä¸­æ·»åŠ æ–°è§’è‰²\n      6. ä»è§’è‰²ä»“åº“ä¸­ç§»é™¤æ‰€æœ‰ç´ æè§’è‰²\n      7. åœ¨åˆæˆè®°å½•ä¸­æ·»åŠ è®°å½•\n\n      é‡è¦è¦æ±‚ï¼š\n      - æ–°è§’è‰²å¿…é¡»å…·æœ‰ç‹¬ç‰¹æ€§å’ŒåŸåˆ›æ€§\n      - å¿…é¡»ç”Ÿæˆå®Œæ•´çš„è§’è‰²èµ„æ–™ï¼ˆåŒ…æ‹¬ç»˜å›¾æ ‡ç­¾å’Œè‡ªå®šä¹‰å‰ç«¯HTMLï¼‰\n      - å¿…é¡»ä½¿ç”¨JSONPatchæ ¼å¼æ›´æ–°æ¸¸æˆçŠ¶æ€\n      - æ–°è§’è‰²çš„ç¨€æœ‰åº¦å¿…é¡»é«˜äºæˆ–ç­‰äºç´ æè§’è‰²çš„æœ€é«˜ç¨€æœ‰åº¦`;closeSynthesis();try{await sendCommandToAI(t),alert("åˆæˆæŒ‡ä»¤å·²å‘é€ï¼Œè¯·ç­‰å¾…AIç”Ÿæˆæ–°è§’è‰²...")}catch(e){console.error("å‘é€åˆæˆæŒ‡ä»¤å¤±è´¥:",e),alert("å‘é€åˆæˆæŒ‡ä»¤å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚")}}function openDecompose(){alert("åˆ†è§£åŠŸèƒ½å¼€å‘ä¸­...")}function openSettings(){const e=document.createElement("div");e.className="modal",e.id="settings-modal",e.innerHTML=`\n                <div class="modal-content" style="max-width: 700px">\n                  <button class="modal-close" onclick="closeSettings()">Ã—</button>\n                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">âš™ï¸ æ¸¸æˆè®¾ç½®</h2>\n\n                  <div style="margin-bottom: 24px">\n                    <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å¤–è§‚è®¾ç½®</h3>\n                    <div style="display: flex; flex-direction: column; gap: 12px">\n                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">\n                        <div>\n                          <div style="font-weight: 600; margin-bottom: 4px">å¤œé—´æ¨¡å¼</div>\n                          <div style="font-size: 12px; color: var(--text-secondary)">åˆ‡æ¢æ·±è‰²/æµ…è‰²ä¸»é¢˜</div>\n                        </div>\n                        <label style="position: relative; display: inline-block; width: 50px; height: 26px">\n                          <input type="checkbox" id="setting-dark-mode" style="opacity: 0; width: 0; height: 0" onchange="toggleDarkMode()">\n                          <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(139, 92, 246, 0.3); border-radius: 26px; transition: 0.3s"></span>\n                          <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s"></span>\n                        </label>\n                      </div>\n\n                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">\n                        <div>\n                          <div style="font-weight: 600; margin-bottom: 4px">å­—ä½“å¤§å°</div>\n                          <div style="font-size: 12px; color: var(--text-secondary)">è°ƒæ•´ç•Œé¢å­—ä½“å¤§å°</div>\n                        </div>\n                        <select id="setting-font-size" style="padding: 8px 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text-primary)" onchange="changeFontSize()">\n                          <option value="small">å°</option>\n                          <option value="medium" selected>ä¸­</option>\n                          <option value="large">å¤§</option>\n                          <option value="xlarge">ç‰¹å¤§</option>\n                        </select>\n                      </div>\n\n                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">\n                        <div>\n                          <div style="font-weight: 600; margin-bottom: 4px">é€‚é…æ‰‹æœºç•Œé¢</div>\n                          <div style="font-size: 12px; color: var(--text-secondary)">å¼ºåˆ¶ä½¿ç”¨æ›´é€‚åˆè§¦æ§çš„å¸ƒå±€/é—´è·ï¼ˆæ¡Œé¢ä¹Ÿä¼šç”Ÿæ•ˆï¼‰</div>\n                        </div>\n                        <label style="position: relative; display: inline-block; width: 50px; height: 26px">\n                          <input type="checkbox" id="setting-mobile-ui" style="opacity: 0; width: 0; height: 0" onchange="toggleMobileUI()">\n                          <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(139, 92, 246, 0.3); border-radius: 26px; transition: 0.3s"></span>\n                          <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s"></span>\n                        </label>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div style="margin-bottom: 24px">\n                    <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">æ¸¸æˆè®¾ç½®</h3>\n                    <div style="display: flex; flex-direction: column; gap: 12px">\n                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">\n                        <div>\n                          <div style="font-weight: 600; margin-bottom: 4px">è‡ªåŠ¨è¥ä¸š</div>\n                          <div style="font-size: 12px; color: var(--text-secondary)">è‡ªåŠ¨åˆ†é…ç©ºé—²è§’è‰²æ¥å®¢</div>\n                        </div>\n                        <label style="position: relative; display: inline-block; width: 50px; height: 26px; cursor: pointer">\n                          <input type="checkbox" id="setting-auto-business" style="opacity: 0; width: 0; height: 0; position: absolute" onchange="toggleAutoBusiness()">\n                          <span id="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(139, 92, 246, 0.3); border-radius: 26px; transition: 0.3s"></span>\n                          <span id="toggle-knob" style="position: absolute; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2)"></span>\n                        </label>\n                      </div>\n\n                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">\n                        <div>\n                          <div style="font-weight: 600; margin-bottom: 4px">è‡ªåŠ¨é…å›¾</div>\n                          <div style="font-size: 12px; color: var(--text-secondary)">ç”Ÿæˆå‰§æƒ…æ—¶è‡ªåŠ¨å¤ç”¨è§’è‰²å¤–è²Œæç¤ºè¯å¹¶è¾“å‡ºå›¾ç‰‡</div>\n                        </div>\n                        <label style="position: relative; display: inline-block; width: 50px; height: 26px">\n                          <input type="checkbox" id="setting-auto-image" style="opacity: 0; width: 0; height: 0" onchange="toggleAutoImage()">\n                          <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(139, 92, 246, 0.3); border-radius: 26px; transition: 0.3s"></span>\n                          <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s"></span>\n                        </label>\n                      </div>\n\n                      <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">\n                        <div style="font-weight: 600; margin-bottom: 8px">æ”¶ç›Šå€ç‡</div>\n                        <div style="display: flex; gap: 12px; align-items: center">\n                          <input type="range" id="setting-income-multiplier" min="0.1" max="10" step="0.1" value="${gameState.è®¾ç½®?.æ”¶ç›Šå€ç‡||1}" style="flex: 1" oninput="updateIncomeMultiplier(this.value)">\n                          <span id="income-multiplier-value" style="min-width: 60px; text-align: right; font-weight: 600">${gameState.è®¾ç½®?.æ”¶ç›Šå€ç‡||1}x</span>\n                        </div>\n                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px">å½±å“æ‰€æœ‰æ”¶å…¥è®¡ç®—</div>\n                      </div>\n\n                      <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">\n                        <div style="font-weight: 600; margin-bottom: 8px">ç»éªŒå€ç‡</div>\n                        <div style="display: flex; gap: 12px; align-items: center">\n                          <input type="range" id="setting-exp-multiplier" min="0.1" max="10" step="0.1" value="${gameState.è®¾ç½®?.ç»éªŒå€ç‡||1}" style="flex: 1" oninput="updateExpMultiplier(this.value)">\n                          <span id="exp-multiplier-value" style="min-width: 60px; text-align: right; font-weight: 600">${gameState.è®¾ç½®?.ç»éªŒå€ç‡||1}x</span>\n                        </div>\n                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px">å½±å“æ‰€æœ‰ç»éªŒè·å–</div>\n                      </div>\n\n                      <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">\n                        <div style="font-weight: 600; margin-bottom: 8px">æœ€å¤§è§’è‰²æ•°é‡</div>\n                        <div style="display: flex; gap: 12px; align-items: center">\n                          <input type="number" id="setting-max-characters" min="10" max="1000" value="${gameState.è®¾ç½®?.æœ€å¤§è§’è‰²æ•°é‡||100}" style="flex: 1; padding: 8px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text-primary)" onchange="updateMaxCharacters(this.value)">\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div style="display: flex; gap: 12px; justify-content: flex-end">\n                    <button class="btn btn-secondary" onclick="closeSettings()">å…³é—­</button>\n                  </div>\n                </div>\n              `,document.body.appendChild(e),e.classList.add("active");const t=localStorage.getItem("darkMode"),n=null===t||"true"===t;document.getElementById("setting-dark-mode").checked=n,toggleDarkMode(!0);const a=localStorage.getItem("fontSize")||"medium";document.getElementById("setting-font-size").value=a,changeFontSize(!0);const o=localStorage.getItem("mobileUI"),i=null===o?window.matchMedia("(max-width: 768px)").matches:"true"===o;document.getElementById("setting-mobile-ui").checked=i,toggleMobileUI(!0);const r=gameState.è®¾ç½®?.è‡ªåŠ¨è¥ä¸š||!1;document.getElementById("setting-auto-business").checked=r,updateToggleSwitch("setting-auto-business",r);const s=!1!==gameState.è®¾ç½®?.è‡ªåŠ¨é…å›¾;document.getElementById("setting-auto-image").checked=s}function closeSettings(){const e=document.getElementById("settings-modal");e&&(e.classList.remove("active"),setTimeout(()=>e.remove(),300))}function toggleCustomTraining(e){const t=document.getElementById("custom-training-desc"),n=document.getElementById("custom-training-preview");t&&n&&(e?(t.style.display="block",n.style.display="block",t.focus()):(t.style.display="none",n.style.display="none",t.value="",updateCustomTraining()))}function updateCustomTraining(){const e=document.getElementById("custom-training-desc"),t=document.getElementById("custom-training-preview");if(e&&t){const n=e.value.trim();n.length>0?(t.textContent=`é¢„è§ˆï¼š${n.substring(0,50)}${n.length>50?"...":""}`,t.style.color="var(--text-primary)"):(t.textContent="é¢„è§ˆï¼šè‡ªå®šä¹‰è°ƒæ•™",t.style.color="var(--text-secondary)")}}function toggleDarkMode(e=!1){const t=document.getElementById("setting-dark-mode").checked;e||localStorage.setItem("darkMode",t),t?document.documentElement.removeAttribute("data-theme"):document.documentElement.setAttribute("data-theme","light")}function toggleAutoImage(){const e=document.getElementById("setting-auto-image")?.checked;gameState.è®¾ç½®||(gameState.è®¾ç½®={}),gameState.è®¾ç½®.è‡ªåŠ¨é…å›¾=!!e,saveGameStateToMVU(),refreshAllPages()}function changeFontSize(e=!1){const t=document.getElementById("setting-font-size").value;e||localStorage.setItem("fontSize",t);const n={small:"12px",medium:"14px",large:"16px",xlarge:"18px"};document.documentElement.style.fontSize=n[t]||n.medium}function applyMobileUISetting(e){e?document.documentElement.setAttribute("data-ui","mobile"):document.documentElement.removeAttribute("data-ui")}function toggleMobileUI(e=!1){const t=!!document.getElementById("setting-mobile-ui")?.checked;e||localStorage.setItem("mobileUI",String(t)),applyMobileUISetting(t)}function updateToggleSwitch(e,t){const n=document.getElementById(e),a=document.getElementById("toggle-slider"),o=document.getElementById("toggle-knob");n&&a&&o&&(t?(a.style.backgroundColor="var(--primary)",o.style.transform="translateX(24px)"):(a.style.backgroundColor="rgba(139, 92, 246, 0.3)",o.style.transform="translateX(0)"))}function toggleAutoBusiness(){const e=document.getElementById("setting-auto-business").checked;updateToggleSwitch("setting-auto-business",e),gameState.è®¾ç½®||(gameState.è®¾ç½®={}),gameState.è®¾ç½®.è‡ªåŠ¨è¥ä¸š=e,saveGameStateToMVU()}function updateIncomeMultiplier(e){document.getElementById("income-multiplier-value").textContent=e+"x",gameState.è®¾ç½®||(gameState.è®¾ç½®={}),gameState.è®¾ç½®.æ”¶ç›Šå€ç‡=parseFloat(e),saveGameStateToMVU()}function updateExpMultiplier(e){document.getElementById("exp-multiplier-value").textContent=e+"x",gameState.è®¾ç½®||(gameState.è®¾ç½®={}),gameState.è®¾ç½®.ç»éªŒå€ç‡=parseFloat(e),saveGameStateToMVU()}function updateMaxCharacters(e){gameState.è®¾ç½®||(gameState.è®¾ç½®={}),gameState.è®¾ç½®.æœ€å¤§è§’è‰²æ•°é‡=parseInt(e),saveGameStateToMVU()}function openGallery(){switchPage("units")}function refreshAllPages(){updateLimitedPoolIfNeeded(),normalizeAllCharacters(),refreshHomePage(),refreshSummonPage(),refreshUnitsPage(),refreshBrothelPage()}const init=async()=>{try{await loadGameStateFromMVU(),updateLimitedPoolIfNeeded(),setupEventListeners(),refreshAllPages();const e=localStorage.getItem("darkMode");null===e||"true"===e?document.documentElement.removeAttribute("data-theme"):document.documentElement.setAttribute("data-theme","light");const t=localStorage.getItem("fontSize")||"medium",n={small:"12px",medium:"14px",large:"16px",xlarge:"18px"};document.documentElement.style.fontSize=n[t]||n.medium;const a=localStorage.getItem("mobileUI");applyMobileUISetting(null===a?window.matchMedia("(max-width: 768px)").matches:"true"===a),setInterval(()=>{saveGameStateToMVU()},5e3)}catch(e){console.error("åˆå§‹åŒ–å¤±è´¥:",e)}};"undefined"!=typeof $?$(init):"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init()</script></body></html>