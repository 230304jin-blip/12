<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é»‘æš—å¹»æƒ³æŠ½å¡ç»è¥æ¸¸æˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* ==================== ç°ä»£ UI è®¾è®¡å˜é‡ ==================== */
      :root {
        --primary: #8b5cf6;
        --primary-dark: #6d28d9;
        --secondary: #ec4899;
        --accent: #f59e0b;
        --accent-gold: #fbbf24;
        --bg-dark: #0f172a;
        --bg-card: #1e293b;
        --bg-hover: #334155;
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --border: #334155;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --rarity-n: #9ca3af;
        --rarity-r: #4ade80;
        --rarity-sr: #60a5fa;
        --rarity-ssr: #f59e0b;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', 'SimHei', sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
        background-attachment: fixed;
        color: var(--text-primary);
        min-height: 100vh;
        padding-bottom: 80px;
        line-height: 1.6;
      }

      /* ==================== ç°ä»£å¡ç‰‡è®¾è®¡ ==================== */
      .card {
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .card:hover {
        border-color: rgba(139, 92, 246, 0.4);
        box-shadow: 0 12px 40px rgba(139, 92, 246, 0.2);
        transform: translateY(-2px);
      }

      /* ==================== ç°ä»£æŒ‰é’® ==================== */
      .btn {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        transform: translate(-50%, -50%);
        transition:
          width 0.6s,
          height 0.6s;
      }

      .btn:hover::before {
        width: 300px;
        height: 300px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background: rgba(51, 65, 85, 0.8);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .btn-secondary:hover {
        background: rgba(71, 85, 105, 0.8);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      /* ==================== ç¨€æœ‰åº¦æ ·å¼ ==================== */
      .rarity-N {
        border-color: var(--rarity-n);
        color: var(--rarity-n);
        box-shadow: 0 0 10px rgba(156, 163, 175, 0.3);
      }
      .rarity-R {
        border-color: var(--rarity-r);
        color: var(--rarity-r);
        box-shadow: 0 0 15px rgba(74, 222, 128, 0.4);
      }
      .rarity-SR {
        border-color: var(--rarity-sr);
        color: var(--rarity-sr);
        box-shadow: 0 0 20px rgba(96, 165, 250, 0.5);
      }
      .rarity-SSR {
        border-color: var(--rarity-ssr);
        color: var(--rarity-ssr);
        box-shadow: 0 0 30px rgba(245, 158, 11, 0.7);
        animation: ssrGlow 2s ease-in-out infinite;
      }

      @keyframes ssrGlow {
        0%,
        100% {
          box-shadow: 0 0 30px rgba(245, 158, 11, 0.7);
        }
        50% {
          box-shadow: 0 0 50px rgba(245, 158, 11, 1);
        }
      }

      /* ==================== è§’è‰²å¡ç‰‡ï¼ˆæ–°è®¾è®¡ï¼šä»¥å›¾ç‰‡ä¸ºä¸­å¿ƒï¼‰ ==================== */
      .character-card {
        position: relative;
        border: 2px solid;
        border-radius: 16px;
        overflow: visible;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background: rgba(30, 41, 59, 0.6);
        backdrop-filter: blur(10px);
        padding: 12px;
      }

      .character-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      }

      .character-avatar {
        width: 100%;
        aspect-ratio: 1;
        position: relative;
        overflow: hidden;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        border-radius: 12px;
        margin-bottom: 12px;
        cursor: pointer;
      }

      .character-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .character-image-container {
        width: 100%;
        height: 100%;
        position: relative;
      }

      .character-info {
        text-align: center;
      }

      .character-name {
        font-weight: 700;
        font-size: 15px;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .character-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .character-action-btn {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 8px;
        border: 1px solid rgba(139, 92, 246, 0.3);
        background: rgba(139, 92, 246, 0.1);
        color: var(--primary);
        cursor: pointer;
        transition: all 0.3s;
      }

      .character-action-btn:hover {
        background: rgba(139, 92, 246, 0.2);
        transform: translateY(-2px);
      }

      /* ==================== é¡µé¢å¸ƒå±€ ==================== */
      .page {
        display: none;
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
        animation: fadeIn 0.4s ease-out;
      }

      .page.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ==================== åº•éƒ¨å¯¼èˆª ==================== */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(139, 92, 246, 0.2);
        display: flex;
        justify-content: space-around;
        padding: 12px 0;
        z-index: 1000;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 8px 20px;
        cursor: pointer;
        color: var(--text-secondary);
        transition: all 0.3s;
        border-radius: 12px;
        min-width: 70px;
      }

      .nav-item.active {
        color: var(--primary);
        background: rgba(139, 92, 246, 0.15);
        transform: translateY(-2px);
      }

      .nav-item:hover {
        color: var(--primary);
        background: rgba(139, 92, 246, 0.1);
      }

      .nav-item .icon {
        font-size: 24px;
      }

      .nav-item .label {
        font-size: 11px;
        font-weight: 500;
      }

      /* ==================== åˆ—è¡¨å¸ƒå±€ ==================== */
      .character-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 20px 0;
      }

      .character-list-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        background: rgba(30, 41, 59, 0.6);
        border: 2px solid;
        border-radius: 12px;
        transition: all 0.3s;
      }

      /* é™åˆ¶å‰ç«¯è§’è‰²å¡çš„æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢çªç ´UIç•Œé™ */
      #character-card-display {
        max-width: 100%;
        overflow-x: auto;
        box-sizing: border-box;
      }

      #character-card-display > div {
        max-width: 100%;
        box-sizing: border-box;
        overflow-x: auto;
      }

      #character-card-display * {
        max-width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
        box-sizing: border-box;
      }

      /* å¼ºåˆ¶é™åˆ¶å‰ç«¯è§’è‰²å¡å†…çš„æ‰€æœ‰å…ƒç´  */
      #character-card-display > div > * {
        max-width: 100% !important;
        box-sizing: border-box !important;
      }

      #character-detail-content {
        max-width: 100%;
        overflow-x: auto;
      }

      #character-detail-content > * {
        max-width: 100%;
        box-sizing: border-box;
      }

      /* ç¡®ä¿å‰ç«¯è§’è‰²å¡å†…çš„å…ƒç´ ä¸ä¼šæº¢å‡º */
      #character-detail-content * {
        max-width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .character-list-item:hover {
        background: rgba(30, 41, 59, 0.8);
        transform: translateX(4px);
      }

      .character-list-image {
        width: 80px;
        height: 80px;
        min-width: 80px;
        border-radius: 8px;
        overflow: hidden;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .character-list-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .character-list-info {
        flex: 1;
        min-width: 0;
      }

      .character-list-name {
        font-size: 18px;
        font-weight: bold;
        color: var(--primary);
        margin-bottom: 4px;
      }

      .character-list-meta {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }

      .character-list-stats {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .character-list-stat-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
      }

      .character-list-stat-bar {
        width: 60px;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
      }

      .character-list-stat-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
        transition: width 0.3s;
      }

      .character-list-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }

      .room-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
        padding: 20px 0;
      }

      /* ==================== æˆ¿é—´å¡ç‰‡ ==================== */
      .room-card {
        border: 2px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        background: rgba(30, 41, 59, 0.6);
        cursor: pointer;
        transition: all 0.3s;
        backdrop-filter: blur(10px);
      }

      .room-card.occupied {
        border-color: var(--primary);
        background: rgba(139, 92, 246, 0.2);
      }

      .room-card:hover {
        transform: scale(1.05);
        box-shadow: 0 0 25px rgba(139, 92, 246, 0.5);
      }

      /* ==================== å‰§æƒ…æ˜¾ç¤ºåŒºåŸŸ ==================== */
      .story-container {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 16px;
        padding: 24px;
        margin: 20px 0;
        min-height: 300px;
        max-height: 600px;
        overflow-y: auto;
        backdrop-filter: blur(10px);
        box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .story-content {
        line-height: 2;
        font-size: 15px;
        color: var(--text-primary);
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .story-content img {
        max-width: 100%;
        height: auto;
        border-radius: 12px;
        margin: 15px 0;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      }

      .story-placeholder {
        text-align: center;
        color: var(--text-secondary);
        font-style: italic;
        padding: 60px 20px;
        font-size: 16px;
      }

      .story-loading {
        text-align: center;
        color: var(--primary);
        padding: 60px 20px;
        font-size: 18px;
      }

      /* ==================== æ—¥å¿— ==================== */
      .log-container {
        max-height: 400px;
        overflow-y: auto;
        padding: 16px;
        background: rgba(15, 23, 42, 0.6);
        border-radius: 12px;
        margin-top: 20px;
        border: 1px solid rgba(139, 92, 246, 0.2);
      }

      .log-entry {
        padding: 12px;
        margin-bottom: 12px;
        border-left: 3px solid var(--primary);
        background: rgba(139, 92, 246, 0.1);
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.6;
        transition: all 0.3s;
      }

      .log-entry:hover {
        background: rgba(139, 92, 246, 0.2);
        transform: translateX(5px);
      }

      /* ==================== å±æ€§è¿›åº¦æ¡ ==================== */
      .stat-bar {
        height: 8px;
        background: rgba(51, 65, 85, 0.5);
        border-radius: 4px;
        overflow: hidden;
        margin: 6px 0;
        position: relative;
      }

      .stat-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
        transition: width 0.6s ease-out;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
      }

      /* ==================== æ¨¡æ€æ¡† ==================== */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 2000;
        overflow-y: auto;
        padding: 20px;
        backdrop-filter: blur(5px);
        -webkit-overflow-scrolling: touch;
      }

      .modal.active {
        display: block;
        animation: fadeIn 0.3s;
      }

      .modal-content {
        background: rgba(30, 41, 59, 0.98);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 20px;
        padding: 32px;
        max-width: 900px;
        width: 100%;
        margin: 20px auto;
        position: relative;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(20px);
        min-height: calc(100vh - 40px);
      }

      .modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.3);
        color: var(--primary);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }

      .modal-close:hover {
        background: rgba(139, 92, 246, 0.2);
        transform: rotate(90deg);
      }

      /* ==================== æ ‡é¢˜æ ·å¼ ==================== */
      .page-title {
        font-size: 32px;
        color: var(--primary);
        text-align: center;
        margin-bottom: 30px;
        text-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        font-weight: 700;
        letter-spacing: 2px;
      }

      .section-title {
        font-size: 20px;
        color: var(--primary);
        margin: 24px 0 16px 0;
        font-weight: 600;
        text-shadow: 0 0 5px rgba(139, 92, 246, 0.3);
      }

      /* ==================== å“åº”å¼è®¾è®¡ ==================== */
      @media (max-width: 768px) {
        .character-list-item {
          flex-direction: column;
          align-items: stretch;
        }

        .character-list-image {
          width: 100%;
          height: 200px;
          min-width: 100%;
        }

        .character-list-actions {
          width: 100%;
          flex-direction: column;
        }

        .character-list-actions .btn {
          width: 100%;
        }

        .room-grid {
          grid-template-columns: 1fr;
        }

        .page {
          padding: 10px;
        }

        .modal-content {
          padding: 20px;
          margin: 10px;
        }
      }

      /* ==================== æ»šåŠ¨æ¡ ==================== */
      ::-webkit-scrollbar {
        width: 10px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(15, 23, 42, 0.5);
        border-radius: 5px;
      }

      ::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 5px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- é¦–é¡µ -->
      <div id="page-home" class="page active">
        <div class="card">
          <h1 class="page-title">ğŸ° é»‘æš—å¹»æƒ³ç»è¥æ¸¸æˆ</h1>

          <div
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: 20px;
              margin-top: 30px;
            "
          >
            <div class="card" style="text-align: center; padding: 20px">
              <div style="font-size: 36px; margin-bottom: 12px">ğŸ’°</div>
              <div style="font-size: 28px; font-weight: bold; color: var(--accent-gold)" id="home-currency">1000</div>
              <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px">è´§å¸</div>
            </div>

            <div class="card" style="text-align: center; padding: 20px">
              <div style="font-size: 36px; margin-bottom: 12px">ğŸ‘¥</div>
              <div style="font-size: 28px; font-weight: bold; color: var(--primary)" id="home-characters">0</div>
              <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px">è§’è‰²æ•°é‡</div>
            </div>

            <div class="card" style="text-align: center; padding: 20px">
              <div style="font-size: 36px; margin-bottom: 12px">ğŸ“Š</div>
              <div style="font-size: 28px; font-weight: bold; color: var(--accent-gold)" id="home-income">0</div>
              <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px">ä»Šæ—¥æ”¶å…¥</div>
            </div>
          </div>

          <div style="margin-top: 30px">
            <h2 class="section-title">å¿«æ·æ“ä½œ</h2>
            <div style="display: flex; gap: 16px; flex-wrap: wrap">
              <button class="btn" onclick="switchPage('summon')">ğŸ´ ç«‹å³æŠ½å¡</button>
              <button class="btn" onclick="switchPage('units')">ğŸ“¦ æŸ¥çœ‹ä»“åº“</button>
              <button class="btn" onclick="switchPage('brothel')">ğŸ›ï¸ ç»è¥å¦“é™¢</button>
            </div>
          </div>
        </div>
      </div>

      <!-- æŠ½å¡é¡µé¢ -->
      <div id="page-summon" class="page">
        <div class="card">
          <h1 class="page-title">ğŸ´ å¬å”¤ä»ªå¼</h1>

          <div style="text-align: center; margin-bottom: 40px">
            <div style="font-size: 56px; margin-bottom: 16px">ğŸ’°</div>
            <div style="font-size: 40px; font-weight: bold; color: var(--accent-gold)" id="summon-currency">1000</div>
            <div style="font-size: 16px; color: var(--text-secondary); margin-top: 8px">å½“å‰è´§å¸</div>
          </div>

          <div
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: 20px;
              margin-bottom: 40px;
            "
          >
            <button class="btn" onclick="handleSummon('å•æŠ½')" id="btn-single" style="padding: 24px">
              <div style="font-size: 32px; margin-bottom: 12px">âœ¨</div>
              <div style="font-size: 18px; margin-bottom: 8px">å•æŠ½</div>
              <div style="font-size: 14px; opacity: 0.8">100 é‡‘</div>
            </button>

            <button class="btn" onclick="handleSummon('é—ªå…‰æŠ½å¡')" id="btn-flash" style="padding: 24px">
              <div style="font-size: 32px; margin-bottom: 12px">ğŸ’«</div>
              <div style="font-size: 18px; margin-bottom: 8px">é—ªå…‰æŠ½å¡</div>
              <div style="font-size: 14px; opacity: 0.8">500 é‡‘ (SSR)</div>
            </button>

            <button class="btn" onclick="showTargetSummonInput()" id="btn-target" style="padding: 24px">
              <div style="font-size: 32px; margin-bottom: 12px">ğŸ¯</div>
              <div style="font-size: 18px; margin-bottom: 8px">å®šå‘æŠ½å¡</div>
              <div style="font-size: 14px; opacity: 0.8">300 é‡‘</div>
            </button>
          </div>

          <!-- æŠ½å¡ç»“æœå±•ç¤ºåŒº -->
          <div id="summon-results" style="min-height: 200px"></div>

          <!-- è§’è‰²å¡å±•ç¤ºåŒºï¼ˆç”¨äºæ˜¾ç¤ºå¸¦å‰ç«¯çš„è§’è‰²å¡ï¼‰ -->
          <div id="character-card-display" style="display: none; margin-top: 30px"></div>
        </div>
      </div>

      <!-- è§’è‰²ä»“åº“é¡µé¢ -->
      <div id="page-units" class="page">
        <div>
          <h1 class="page-title">ğŸ“¦ è§’è‰²ä»“åº“</h1>

          <div class="card" style="margin-bottom: 24px; display: flex; gap: 16px; flex-wrap: wrap">
            <input
              type="text"
              id="search-input"
              placeholder="æœç´¢è§’è‰²..."
              style="
                flex: 1;
                min-width: 200px;
                padding: 12px;
                background: rgba(15, 23, 42, 0.5);
                border: 1px solid rgba(139, 92, 246, 0.3);
                border-radius: 12px;
                color: var(--text-primary);
                font-size: 14px;
              "
            />
            <select
              id="filter-rarity"
              style="
                padding: 12px;
                background: rgba(15, 23, 42, 0.5);
                border: 1px solid rgba(139, 92, 246, 0.3);
                border-radius: 12px;
                color: var(--text-primary);
                font-size: 14px;
                min-width: 150px;
              "
            >
              <option value="">å…¨éƒ¨ç¨€æœ‰åº¦</option>
              <option value="N">N</option>
              <option value="R">R</option>
              <option value="SR">SR</option>
              <option value="SSR">SSR</option>
            </select>
          </div>

          <div id="character-list" class="character-grid"></div>
        </div>

        <!-- è§’è‰²è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div id="character-detail-modal" class="modal">
          <div class="modal-content">
            <button class="modal-close" onclick="closeCharacterDetail()">Ã—</button>
            <div id="character-detail-content"></div>
          </div>
        </div>
      </div>

      <!-- å¦“é™¢ç»è¥é¡µé¢ -->
      <div id="page-brothel" class="page">
        <div>
          <h1 class="page-title">ğŸ›ï¸ å¦“é™¢ç»è¥</h1>

          <div
            class="card"
            style="
              margin-bottom: 24px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              flex-wrap: wrap;
              gap: 16px;
            "
          >
            <div>
              <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">è¥ä¸šçŠ¶æ€</div>
              <div style="font-size: 24px; font-weight: bold; color: var(--primary)" id="brothel-status">è¥ä¸šä¸­</div>
            </div>
            <div>
              <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">ä»Šæ—¥æ”¶å…¥</div>
              <div style="font-size: 24px; font-weight: bold; color: var(--accent-gold)" id="brothel-income">0</div>
            </div>
            <button class="btn" onclick="toggleBrothelStatus()" id="btn-toggle-status">æš‚åœè¥ä¸š</button>
          </div>

          <h2 class="section-title">æˆ¿é—´ç®¡ç†</h2>
          <div id="room-list" class="room-grid"></div>

          <h2 class="section-title">ç©ºé—²è§’è‰²</h2>
          <div id="available-characters" class="character-grid"></div>

          <h2 class="section-title">å½“å‰äº’åŠ¨å‰§æƒ…</h2>
          <div id="brothel-story" class="story-container">
            <div id="brothel-story-content" class="story-content">
              <div class="story-placeholder">ç‚¹å‡»æˆ¿é—´æˆ–è§’è‰²å¼€å§‹äº’åŠ¨ï¼ŒAI ç”Ÿæˆçš„å‰§æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
            </div>
          </div>

          <h2 class="section-title">äº‹ä»¶æ—¥å¿—</h2>
          <div id="brothel-logs" class="log-container"></div>
        </div>
      </div>

      <!-- æ›´å¤šé¡µé¢ -->
      <div id="page-more" class="page">
        <div>
          <h1 class="page-title">âš™ï¸ æ›´å¤šåŠŸèƒ½</h1>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px">
            <div class="card" style="cursor: pointer; text-align: center" onclick="openSynthesis()">
              <div style="font-size: 48px; margin-bottom: 16px">ğŸ”¬</div>
              <h3 style="font-size: 20px; color: var(--primary); margin-bottom: 8px">è§’è‰²åˆæˆ</h3>
              <p style="font-size: 14px; color: var(--text-secondary)">åˆæˆè§’è‰²æå‡ç¨€æœ‰åº¦</p>
            </div>

            <div class="card" style="cursor: pointer; text-align: center" onclick="openDecompose()">
              <div style="font-size: 48px; margin-bottom: 16px">âš¡</div>
              <h3 style="font-size: 20px; color: var(--primary); margin-bottom: 8px">è§’è‰²åˆ†è§£</h3>
              <p style="font-size: 14px; color: var(--text-secondary)">åˆ†è§£è§’è‰²è·å¾—èµ„æº</p>
            </div>

            <div class="card" style="cursor: pointer; text-align: center" onclick="openSettings()">
              <div style="font-size: 48px; margin-bottom: 16px">âš™ï¸</div>
              <h3 style="font-size: 20px; color: var(--primary); margin-bottom: 8px">æ¸¸æˆè®¾ç½®</h3>
              <p style="font-size: 14px; color: var(--text-secondary)">è°ƒæ•´æ¸¸æˆå‚æ•°</p>
            </div>

            <div class="card" style="cursor: pointer; text-align: center" onclick="openGallery()">
              <div style="font-size: 48px; margin-bottom: 16px">ğŸ“š</div>
              <h3 style="font-size: 20px; color: var(--primary); margin-bottom: 8px">è§’è‰²å›¾é‰´</h3>
              <p style="font-size: 14px; color: var(--text-secondary)">æŸ¥çœ‹æ‰€æœ‰è§’è‰²</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
      <div class="nav-item active" onclick="switchPage('home')">
        <div class="icon">ğŸ </div>
        <div class="label">é¦–é¡µ</div>
      </div>
      <div class="nav-item" onclick="switchPage('summon')">
        <div class="icon">ğŸ´</div>
        <div class="label">æŠ½å¡</div>
      </div>
      <div class="nav-item" onclick="switchPage('units')">
        <div class="icon">ğŸ‘¥</div>
        <div class="label">è§’è‰²</div>
      </div>
      <div class="nav-item" onclick="switchPage('brothel')">
        <div class="icon">ğŸ›ï¸</div>
        <div class="label">ç»è¥</div>
      </div>
      <div class="nav-item" onclick="switchPage('more')">
        <div class="icon">âš™ï¸</div>
        <div class="label">æ›´å¤š</div>
      </div>
    </div>

    <script>
      // ==================== å…¨å±€çŠ¶æ€ç®¡ç† ====================
      let gameState = {
        è´§å¸: 1000,
        æŠ½å¡è®°å½•: {},
        è§’è‰²ä»“åº“: {},
        å¦“é™¢: {
          è¥ä¸šçŠ¶æ€: 'è¥ä¸šä¸­',
          å½“å‰æ¥å®¢è§’è‰²: {},
          ç­‰å¾…é˜Ÿåˆ—: [],
          æˆ¿é—´çŠ¶æ€: {
            101: { ç±»å‹: 'æ™®é€š', çŠ¶æ€: 'ç©ºé—²', è£…é¥°ä¸»é¢˜: 'æ ‡å‡†' },
            102: { ç±»å‹: 'æ™®é€š', çŠ¶æ€: 'ç©ºé—²', è£…é¥°ä¸»é¢˜: 'æ ‡å‡†' },
            VIP1: { ç±»å‹: 'VIP', çŠ¶æ€: 'ç©ºé—²', è£…é¥°ä¸»é¢˜: 'è±ªå' },
          },
          ä»Šæ—¥æ”¶å…¥: 0,
          å†å²æ€»æ”¶å…¥: 0,
          äº‹ä»¶æ—¥å¿—: [],
        },
        åˆæˆè®°å½•: {},
        åˆ†è§£è®°å½•: {},
        è®¾ç½®: {
          è‡ªåŠ¨è¥ä¸š: false,
          è‡ªåŠ¨è°ƒæ•™: false,
          å±é™©å†…å®¹è¿‡æ»¤: false,
          è¯­è¨€: 'ä¸­æ–‡',
          åŠ¨ç”»æ•ˆæœ: true,
          æ”¶ç›Šå€ç‡: 1,
          ç»éªŒå€ç‡: 1,
          æœ€å¤§è§’è‰²æ•°é‡: 100,
          è‡ªåŠ¨æ¸…ç†æ—§è§’è‰²: false,
          æ¸…ç†é˜ˆå€¼: 20,
        },
        ç»Ÿè®¡æ•°æ®: {
          æ€»æŠ½å¡æ¬¡æ•°: 0,
          æ€»è·å¾—è§’è‰²: 0,
          æ€»æ¥å®¢æ¬¡æ•°: 0,
          æ€»æ”¶å…¥: 0,
          æ¸¸æˆæ—¶é—´: 0,
          è§’è‰²åˆ†å¸ƒ: { N: 0, R: 0, SR: 0, SSR: 0 },
          æƒ…æ„Ÿåˆ†å¸ƒ: { çˆ±: 0, å–œæ¬¢: 0, ä¸­ç«‹: 0, åŒæ¶: 0, æ†æ¨: 0 },
        },
        æ¸¸æˆæ—¶é—´: {
          å½“å‰æ—¶é—´æˆ³: Date.now(),
          ä¸Šæ¬¡æ›´æ–°æ—¶é—´: Date.now(),
          æ¸¸æˆå¼€å§‹æ—¶é—´: Date.now(),
          ä¸‹æ¬¡ç»“ç®—æ—¶é—´: Date.now() + 3600000,
          ç»“ç®—é—´éš”: 3600000,
        },
      };

      // ==================== é¡µé¢åˆ‡æ¢ ====================
      function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });

        const targetPage = document.getElementById(`page-${pageId}`);
        if (targetPage) {
          targetPage.classList.add('active');
        }

        document.querySelectorAll('.nav-item').forEach((item, index) => {
          item.classList.remove('active');
        });

        const navMap = { home: 0, summon: 1, units: 2, brothel: 3, more: 4 };
        const navItems = document.querySelectorAll('.nav-item');
        if (navMap[pageId] !== undefined && navItems[navMap[pageId]]) {
          navItems[navMap[pageId]].classList.add('active');
        }

        refreshPageData(pageId);
      }

      function refreshPageData(pageId) {
        switch (pageId) {
          case 'home':
            refreshHomePage();
            break;
          case 'summon':
            refreshSummonPage();
            break;
          case 'units':
            refreshUnitsPage();
            break;
          case 'brothel':
            refreshBrothelPage();
            break;
        }
      }

      // ==================== æ•°æ®åˆ·æ–° ====================
      function refreshHomePage() {
        document.getElementById('home-currency').textContent = gameState.è´§å¸;
        document.getElementById('home-characters').textContent = Object.keys(gameState.è§’è‰²ä»“åº“).length;
        document.getElementById('home-income').textContent = gameState.å¦“é™¢.ä»Šæ—¥æ”¶å…¥;
      }

      function refreshSummonPage() {
        document.getElementById('summon-currency').textContent = gameState.è´§å¸;

        const costs = { å•æŠ½: 100, é—ªå…‰æŠ½å¡: 500, å®šå‘æŠ½å¡: 300 };
        Object.keys(costs).forEach(type => {
          const btnId = type === 'å•æŠ½' ? 'single' : type === 'é—ªå…‰æŠ½å¡' ? 'flash' : 'target';
          const btn = document.getElementById(`btn-${btnId}`);
          if (btn) {
            btn.disabled = gameState.è´§å¸ < costs[type];
          }
        });
      }

      function refreshUnitsPage() {
        const container = document.getElementById('character-list');
        if (!container) {
          console.error('è§’è‰²åˆ—è¡¨å®¹å™¨ä¸å­˜åœ¨');
          return;
        }

        try {
          // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
          const scrollTop = container.scrollTop;

          // æ¸…ç©ºå®¹å™¨
          container.innerHTML = '';

          const searchTerm = (document.getElementById('search-input')?.value || '').toLowerCase();
          const filterRarity = document.getElementById('filter-rarity')?.value || '';

          // æ£€æŸ¥è§’è‰²ä»“åº“æ˜¯å¦å­˜åœ¨
          if (!gameState.è§’è‰²ä»“åº“ || typeof gameState.è§’è‰²ä»“åº“ !== 'object') {
            console.warn('è§’è‰²ä»“åº“ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯:', gameState.è§’è‰²ä»“åº“);
            container.innerHTML =
              '<div style="text-align: center; padding: 40px; color: var(--text-secondary)">æš‚æ— è§’è‰²</div>';
            return;
          }

          const characters = Object.entries(gameState.è§’è‰²ä»“åº“);
          console.info(`åˆ·æ–°è§’è‰²ä»“åº“ï¼Œå…± ${characters.length} ä¸ªè§’è‰²`);

          if (characters.length === 0) {
            container.innerHTML =
              '<div style="text-align: center; padding: 40px; color: var(--text-secondary)">æš‚æ— è§’è‰²ï¼Œå»æŠ½å¡å§ï¼</div>';
            return;
          }

          characters.forEach(([id, char]) => {
            try {
              if (!char || typeof char !== 'object') {
                console.warn(`è§’è‰² ${id} æ•°æ®æ ¼å¼é”™è¯¯:`, char);
                return;
              }

              if (searchTerm && (!char.å§“å || !char.å§“å.toLowerCase().includes(searchTerm))) return;
              if (filterRarity && char.ç¨€æœ‰åº¦ !== filterRarity) return;

              // è°ƒè¯•ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ç»˜å›¾æ ‡ç­¾
              if (char.ç»˜å›¾æ ‡ç­¾) {
                console.info(`è§’è‰² ${char.å§“å} çš„ç»˜å›¾æ ‡ç­¾:`, char.ç»˜å›¾æ ‡ç­¾.substring(0, 100));
              }

              const card = createCharacterCard(id, char);
              if (card) {
                container.appendChild(card);
              } else {
                console.error(`åˆ›å»ºè§’è‰²å¡ç‰‡å¤±è´¥: ${id}`);
              }
            } catch (error) {
              console.error(`å¤„ç†è§’è‰² ${id} æ—¶å‡ºé”™:`, error);
            }
          });

          // æ¢å¤æ»šåŠ¨ä½ç½®
          container.scrollTop = scrollTop;
        } catch (error) {
          console.error('åˆ·æ–°è§’è‰²ä»“åº“é¡µé¢å¤±è´¥:', error);
          container.innerHTML =
            '<div style="text-align: center; padding: 40px; color: var(--danger)">åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</div>';
        }
      }

      function refreshBrothelPage() {
        if (!document.getElementById('brothel-status')) return;

        document.getElementById('brothel-status').textContent = gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€;
        document.getElementById('brothel-income').textContent = gameState.å¦“é™¢.ä»Šæ—¥æ”¶å…¥;
        document.getElementById('btn-toggle-status').textContent =
          gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€ === 'è¥ä¸šä¸­' ? 'æš‚åœè¥ä¸š' : 'å¼€å§‹è¥ä¸š';

        const roomContainer = document.getElementById('room-list');
        if (roomContainer) {
          roomContainer.innerHTML = '';
          Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€)
            .filter(([roomId, room]) => room.ç±»å‹ !== 'è°ƒæ•™å®¤') // è¿‡æ»¤æ‰è°ƒæ•™å®¤
            .forEach(([roomId, room]) => {
              const roomCard = createRoomCard(roomId, room);
              roomContainer.appendChild(roomCard);
            });
        }

        const charContainer = document.getElementById('available-characters');
        if (charContainer) {
          charContainer.innerHTML = '';
          Object.entries(gameState.è§’è‰²ä»“åº“).forEach(([id, char]) => {
            if (char.çŠ¶æ€ === 'ç©ºé—²' && char.å½“å‰ä½ç½® === 'ä»“åº“') {
              const card = createCharacterCard(id, char, true);
              charContainer.appendChild(card);
            }
          });
        }

        const logContainer = document.getElementById('brothel-logs');
        if (logContainer) {
          logContainer.innerHTML = '';
          gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—
            .slice(-20)
            .reverse()
            .forEach(log => {
              const entry = document.createElement('div');
              entry.className = 'log-entry';
              entry.innerHTML = `
            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">${new Date(log.æ—¶é—´æˆ³).toLocaleString()}</div>
            <div><strong>${log.è§’è‰²ID}</strong>: ${log.æè¿°}</div>
            ${log.æ”¶å…¥å˜åŒ– > 0 ? `<div style="color: var(--accent-gold); margin-top: 4px">+${log.æ”¶å…¥å˜åŒ–} é‡‘</div>` : ''}
          `;
              logContainer.appendChild(entry);
            });
        }
      }

      // ==================== å›¾ç‰‡æ¸²æŸ“ï¼ˆä½¿ç”¨å’Œå‰§æƒ…æ˜¾ç¤ºç›¸åŒçš„æ–¹æ³•ï¼‰ ====================
      function renderImageTag(imageTag, container) {
        if (!imageTag) {
          return false;
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡æ ‡ç­¾æ ¼å¼ï¼ˆæ”¯æŒå¤šè¡Œå†…å®¹ï¼‰
        const imageMatch = imageTag.match(/image###([\s\S]*?)###/);
        if (!imageMatch) {
          console.warn('å›¾ç‰‡æ ‡ç­¾æ ¼å¼ä¸æ­£ç¡®:', imageTag.substring(0, 50));
          return false;
        }

        try {
          if (typeof formatAsDisplayedMessage !== 'undefined') {
            // ç›´æ¥ä½¿ç”¨ formatAsDisplayedMessageï¼Œå’Œå‰§æƒ…æ˜¾ç¤ºä½¿ç”¨å®Œå…¨ä¸€æ ·çš„æ–¹æ³•
            const html = formatAsDisplayedMessage(imageTag);

            // æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿˜åœ¨DOMä¸­
            if (!container.parentElement) {
              console.warn('å›¾ç‰‡å®¹å™¨ä¸åœ¨DOMä¸­ï¼Œè·³è¿‡æ¸²æŸ“');
              return false;
            }

            // è®¾ç½® HTMLï¼ˆä½¿ç”¨ jQuery å¦‚æœå¯ç”¨ï¼‰
            if (typeof $ !== 'undefined' && $(container).length) {
              $(container).html(html);
            } else {
              container.innerHTML = html;
            }

            // ç­‰å¾… DOM æ›´æ–°åæŸ¥æ‰¾å¹¶å¤„ç†å›¾ç‰‡
            setTimeout(() => {
              // å†æ¬¡æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿˜åœ¨DOMä¸­
              if (!container.parentElement) {
                console.warn('å›¾ç‰‡å®¹å™¨åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è¢«ç§»é™¤');
                return;
              }

              // æŸ¥æ‰¾æ‰€æœ‰å±‚çº§çš„å›¾ç‰‡
              const imgs = container.querySelectorAll('img');

              if (imgs.length > 0) {
                imgs.forEach(img => {
                  // ç¡®ä¿å›¾ç‰‡æ ·å¼æ­£ç¡®
                  img.style.width = '100%';
                  img.style.height = '100%';
                  img.style.objectFit = 'cover';
                  img.style.display = 'block';
                  img.style.borderRadius = '0';

                  // å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç†
                  img.onerror = () => {
                    const prompt = imageMatch[1];
                    if (container.parentElement) {
                      container.innerHTML = `
                        <div class="image-placeholder" onclick="event.stopPropagation(); copyImagePrompt('${prompt.replace(/'/g, "\\'")}')">
                          <div style="font-size: 32px; margin-bottom: 8px">ğŸ–¼ï¸</div>
                          <div style="font-size: 12px; text-align: center; padding: 0 8px">å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤</div>
                        </div>
                      `;
                    }
                  };

                  // å›¾ç‰‡åŠ è½½æˆåŠŸ
                  img.onload = () => {
                    console.info('è§’è‰²å›¾ç‰‡åŠ è½½æˆåŠŸ:', img.src.substring(0, 100));
                  };
                });
              } else {
                // æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡ï¼Œå¯èƒ½æ˜¯ formatAsDisplayedMessage è¿”å›äº†å…¶ä»–æ ¼å¼
                // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡æœ¬èŠ‚ç‚¹åŒ…å«å›¾ç‰‡æ ‡ç­¾
                const textContent = container.textContent || container.innerText || '';
                if (textContent.includes('image###')) {
                  // ä»ç„¶æ˜¾ç¤ºå ä½ç¬¦
                  const prompt = imageMatch[1];
                  if (container.parentElement) {
                    container.innerHTML = `
                      <div class="image-placeholder" onclick="event.stopPropagation(); copyImagePrompt('${prompt.replace(/'/g, "\\'")}')">
                        <div style="font-size: 32px; margin-bottom: 8px">ğŸ–¼ï¸</div>
                        <div style="font-size: 12px; text-align: center; padding: 0 8px">å›¾ç‰‡æœªæ¸²æŸ“ï¼Œç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤</div>
                      </div>
                    `;
                  }
                }
              }
            }, 300); // å¢åŠ ç­‰å¾…æ—¶é—´ï¼Œç¡®ä¿ formatAsDisplayedMessage å®Œæˆå¤„ç†

            return true;
          } else {
            // é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤ºå ä½ç¬¦
            const prompt = imageMatch[1];
            container.innerHTML = `
              <div class="image-placeholder" onclick="event.stopPropagation(); copyImagePrompt('${prompt.replace(/'/g, "\\'")}')">
                <div style="font-size: 32px; margin-bottom: 8px">ğŸ–¼ï¸</div>
                <div style="font-size: 12px; text-align: center; padding: 0 8px">ç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤</div>
              </div>
            `;
            return false;
          }
        } catch (error) {
          console.error('æ¸²æŸ“å›¾ç‰‡å¤±è´¥:', error);
          const prompt = imageMatch?.[1] || '';
          if (prompt && container.parentElement) {
            container.innerHTML = `
              <div class="image-placeholder" onclick="event.stopPropagation(); copyImagePrompt('${prompt.replace(/'/g, "\\'")}')">
                <div style="font-size: 32px; margin-bottom: 8px">ğŸ–¼ï¸</div>
                <div style="font-size: 12px; text-align: center; padding: 0 8px">æ¸²æŸ“å¤±è´¥ï¼Œç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤</div>
              </div>
            `;
          }
          return false;
        }
      }

      // ==================== UI ç»„ä»¶åˆ›å»ºï¼ˆåˆ—è¡¨å½¢å¼ï¼Œç®€åŒ–ç‰ˆï¼‰ ====================
      function createCharacterCard(id, char, isSelectable = false) {
        const item = document.createElement('div');
        item.className = `character-list-item rarity-${char.ç¨€æœ‰åº¦}`;

        // åˆ›å»ºä¿¡æ¯åŒºåŸŸï¼ˆä¸å†åŒ…å«å›¾ç‰‡å ä½ç¬¦ï¼‰
        const infoContainer = document.createElement('div');
        infoContainer.className = 'character-list-info';

        // ç”Ÿæˆå±æ€§æ¡
        const statsHtml = ['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦']
          .map(stat => {
            const value = char.å±æ€§?.[stat] || 0;
            return `
              <div class="character-list-stat-item">
                <span>${stat}:</span>
                <div class="character-list-stat-bar">
                  <div class="character-list-stat-fill" style="width: ${value}%"></div>
                </div>
                <span>${value}</span>
              </div>
            `;
          })
          .join('');

        infoContainer.innerHTML = `
          <div class="character-list-name">${char.å§“å || 'æœªçŸ¥'}</div>
          <div class="character-list-meta">${char.ç¨€æœ‰åº¦} Â· ${char.èŒä¸šèº«ä»½ || 'æ— '} Â· ${char.çŠ¶æ€ || 'ç©ºé—²'} Â· Lv.${char.ç­‰çº§ || 1}</div>
          <div class="character-list-stats">${statsHtml}</div>
          <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px; display: flex; gap: 12px">
            <span>æ¥å®¢: ${char.æ¥å®¢æ¬¡æ•° || 0}æ¬¡</span>
            <span>è°ƒæ•™: ${char.è°ƒæ•™æ¬¡æ•° || 0}æ¬¡</span>
            <span style="color: var(--accent-gold)">è´¡çŒ®: ${char.æ”¶å…¥è´¡çŒ® || 0}é‡‘</span>
          </div>
        `;

        // åˆ›å»ºæ“ä½œæŒ‰é’®åŒºåŸŸ
        const actionsContainer = document.createElement('div');
        actionsContainer.className = 'character-list-actions';

        if (isSelectable) {
          actionsContainer.innerHTML = `
            <button class="btn" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); selectCharacterForRoom('${id}')">åˆ†é…æˆ¿é—´</button>
          `;
        } else {
          actionsContainer.innerHTML = `
            <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); showCharacterDetail('${id}')">æŸ¥çœ‹è¯¦æƒ…</button>
            <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); showTrainingInput('${id}')">è°ƒæ•™</button>
            <button class="btn" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); assignCharacterToBrothel('${id}')">æ¥å®¢</button>
          `;
        }

        // ç»„è£…åˆ—è¡¨é¡¹ï¼ˆä¸å†åŒ…å«å›¾ç‰‡å ä½ç¬¦ï¼‰
        item.appendChild(infoContainer);
        item.appendChild(actionsContainer);

        return item;
      }

      function createRoomCard(roomId, room) {
        const card = document.createElement('div');
        card.className = `room-card ${room.çŠ¶æ€ !== 'ç©ºé—²' ? 'occupied' : ''}`;

        const char = room.å½“å‰è§’è‰² ? gameState.è§’è‰²ä»“åº“[room.å½“å‰è§’è‰²] : null;
        const workingChar = room.å½“å‰è§’è‰² ? gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[room.å½“å‰è§’è‰²] : null;

        card.innerHTML = `
        <div style="font-size: 20px; font-weight: bold; margin-bottom: 12px">æˆ¿é—´ ${roomId}</div>
        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 6px">ç±»å‹: ${room.ç±»å‹}</div>
        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 6px">çŠ¶æ€: ${room.çŠ¶æ€}</div>
        ${char ? `<div style="font-size: 14px; color: var(--primary); margin-top: 12px">å½“å‰: ${char.å§“å}</div>` : ''}
        ${workingChar ? `<div style="font-size: 12px; color: var(--accent-gold); margin-top: 4px">æ”¶å…¥: ${workingChar.åŸºç¡€æ”¶å…¥ + workingChar.é¢å¤–æ”¶å…¥} é‡‘</div>` : ''}
        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap">
          ${room.çŠ¶æ€ === 'ç©ºé—²' ? `<button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); showRoomAssignment('${roomId}')">åˆ†é…è§’è‰²</button>` : ''}
          ${room.çŠ¶æ€ !== 'ç©ºé—²' ? `<button class="btn" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); showRoomDetail('${roomId}')">æŸ¥çœ‹å‰§æƒ…</button>` : ''}
        </div>
      `;

        return card;
      }

      // ==================== æŠ½å¡åŠŸèƒ½ ====================
      let pendingSummonCost = 0; // è®°å½•å¾…å¤„ç†çš„æŠ½å¡è´¹ç”¨

      // ==================== å®šå‘æŠ½å¡è¾“å…¥ ====================
      function showTargetSummonInput() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'target-summon-modal';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 600px">
            <button class="modal-close" onclick="closeTargetSummonInput()">Ã—</button>
            <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">ğŸ¯ å®šå‘æŠ½å¡</h2>

            <div style="margin-bottom: 16px; padding: 16px; background: rgba(30, 41, 59, 0.6); border-radius: 12px">
              <p style="font-size: 14px; color: var(--text-secondary); line-height: 1.8">
                æè¿°ä½ æƒ³è¦çš„è§’è‰²ç‰¹å¾ï¼Œä¾‹å¦‚ï¼š<br>
                â€¢ æ€§åˆ«ã€ç§æ—ã€èŒä¸šå€¾å‘<br>
                â€¢ æ€§æ ¼ç‰¹ç‚¹ã€å¤–è²Œç‰¹å¾<br>
                â€¢ ç‰¹æ®Šèƒ½åŠ›æˆ–èƒŒæ™¯è®¾å®š<br>
                â€¢ ä»»ä½•å…¶ä»–è¦æ±‚
              </p>
            </div>

            <div style="margin-bottom: 16px">
              <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 8px">è§’è‰²è¦æ±‚ï¼š</label>
              <textarea
                id="target-summon-input"
                placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³è¦ä¸€ä¸ªæ¸©æŸ”ä½“è´´çš„å¥³æ€§è§’è‰²ï¼ŒèŒä¸šæ˜¯åŒ»ç”Ÿæˆ–æŠ¤å£«ï¼Œæœ‰ç€æ²»æ„ˆç³»çš„å¤–è²Œå’Œæ€§æ ¼..."
                style="
                  width: 100%;
                  min-height: 150px;
                  padding: 12px;
                  background: rgba(15, 23, 42, 0.6);
                  border: 1px solid rgba(139, 92, 246, 0.3);
                  border-radius: 12px;
                  color: var(--text-primary);
                  font-size: 14px;
                  resize: vertical;
                  font-family: inherit;
                "
              ></textarea>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end">
              <button class="btn btn-secondary" onclick="closeTargetSummonInput()">å–æ¶ˆ</button>
              <button class="btn" onclick="confirmTargetSummon()">å¼€å§‹æŠ½å¡ (300 é‡‘)</button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
        modal.classList.add('active');

        // èšç„¦è¾“å…¥æ¡†
        setTimeout(() => {
          const input = document.getElementById('target-summon-input');
          if (input) input.focus();
        }, 100);
      }

      function closeTargetSummonInput() {
        const modal = document.getElementById('target-summon-modal');
        if (modal) {
          modal.classList.remove('active');
          setTimeout(() => modal.remove(), 300);
        }
      }

      async function confirmTargetSummon() {
        const input = document.getElementById('target-summon-input');
        const userRequirement = input ? input.value.trim() : '';

        closeTargetSummonInput();

        if (!userRequirement) {
          alert('è¯·è¾“å…¥è§’è‰²è¦æ±‚ï¼');
          return;
        }

        if (gameState.è´§å¸ < 300) {
          alert('è´§å¸ä¸è¶³ï¼éœ€è¦300é‡‘ã€‚');
          return;
        }

        await handleSummon('å®šå‘æŠ½å¡', userRequirement);
      }

      async function handleSummon(type, customRequirement = '') {
        const costs = { å•æŠ½: 100, é—ªå…‰æŠ½å¡: 500, å®šå‘æŠ½å¡: 300 };
        const cost = costs[type];

        if (gameState.è´§å¸ < cost) {
          alert('è´§å¸ä¸è¶³ï¼');
          return;
        }

        // è®°å½•å¾…æ‰£é™¤çš„è´¹ç”¨ï¼Œä½†ä¸ç«‹å³æ‰£é™¤
        pendingSummonCost = cost;

        const resultsContainer = document.getElementById('summon-results');
        const cardDisplay = document.getElementById('character-card-display');

        resultsContainer.innerHTML = '<div class="story-loading">â³ æ­£åœ¨å¬å”¤ï¼Œè¯·ç¨å€™...</div>';
        if (cardDisplay) {
          cardDisplay.style.display = 'none';
          cardDisplay.innerHTML = '';
        }

        // å‘é€æŒ‡ä»¤ï¼Œè¦æ±‚ç”Ÿæˆå¸¦å‰ç«¯çš„è§’è‰²å¡
        let command = '';
        if (type === 'å®šå‘æŠ½å¡' && customRequirement) {
          command = `æ‰§è¡Œå®šå‘æŠ½å¡ã€‚æ ¹æ®ä»¥ä¸‹è¦æ±‚ç”Ÿæˆè§’è‰²ï¼š\n\n${customRequirement}\n\nè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è§„åˆ™ç”Ÿæˆå®Œæ•´çš„è§’è‰²å¡ï¼š`;
        } else {
          command = `æ‰§è¡Œ${type}ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è§„åˆ™ç”Ÿæˆå®Œæ•´çš„è§’è‰²å¡ï¼š`;
        }

        command += `

**è§’è‰²ç”Ÿæˆè§„åˆ™ï¼š**
1. ä½¿ç”¨ä½ æä¾›çš„è§’è‰²ç”Ÿæˆè§„åˆ™ç”Ÿæˆè§’è‰²ä¿¡æ¯ï¼ˆåŒ…æ‹¬ä¸–ç•ŒèƒŒæ™¯ã€å¬å”¤æ–¹å¼ã€è§’è‰²è®¾å®šæ ¸å¿ƒè§„åˆ™ç­‰ï¼‰
2. å¿…é¡»ç”Ÿæˆå®Œæ•´çš„è§’è‰²èµ„æ–™æ ¼å¼ï¼š
   - å…ƒç´ ï¼ˆ3-4ä¸ªç‹¬ç‰¹å…ƒç´ ï¼ŒåŒ…å«è‡³å°‘ä¸€ä¸ªç¨€æœ‰å°ä¼—å…ƒç´ ï¼‰
   - å§“å
   - ç¨€æœ‰åº¦ï¼ˆN/R/SR/SSRï¼Œæ ¹æ®${type}çš„æ¦‚ç‡è§„åˆ™ï¼‰
   - æ€§åˆ«ï¼ˆç”·æ€§/å¥³æ€§/åŒæ€§ç”·æ€§ï¼‰
   - ç§æ—/å‡ºèº«
   - èŒä¸š/èº«ä»½
   - å¤–è²Œç‰¹ç‚¹ï¼ˆè¯¦ç»†æè¿°ï¼‰
   - æ€§æ ¼/å–œå¥½
   - ç®€ä»‹
   - èƒŒæ™¯æ•…äº‹ï¼ˆè‡³å°‘1000å­—ï¼Œä½“è£ä¸é™ï¼‰
   - AIç»˜å›¾æ ‡ç­¾ï¼ˆNovelAIé€‚ç”¨ï¼ŒåŒåˆ†é•œæ ¼å¼ï¼‰

3. **å¿…é¡»ç”Ÿæˆ** image###è§’è‰²æç¤ºè¯### æ ¼å¼çš„å›¾ç‰‡æ ‡ç­¾ï¼Œå¹¶å­˜å‚¨åœ¨è§’è‰².ç»˜å›¾æ ‡ç­¾å­—æ®µä¸­
   - å›¾ç‰‡æ ‡ç­¾å¿…é¡»ä¸¥æ ¼æŒ‰ç…§NovelAIåŒåˆ†é•œæ ¼å¼ç”Ÿæˆ
   - å·¦ä¾§ï¼šSFWäººè®¾å›¾ï¼ˆæ¨¡ä»¿äºŒæ¬¡å…ƒå¡ç‰Œæ¸¸æˆå¡é¢ï¼‰
   - å³ä¾§ï¼šNSFWæ¶©å›¾ï¼ˆä¿æŒç¾è§‚ã€æ·«é¡ã€è‰²æ°”æ°›å›´ï¼‰
   - æ ¼å¼ï¼šimage###masterpiece, best quality, 8k, {{consistent character}},{split image},{two panels}...###

4. **å¿…é¡»ç”Ÿæˆ**ä¸€ä¸ªå¸¦å‰ç«¯çš„HTMLè§’è‰²å¡ï¼Œç›´æ¥è¾“å‡ºåœ¨å›å¤ä¸­ï¼ˆä¸è¦ç”¨markdownä»£ç å—åŒ…è£¹ï¼‰
   - å¿…é¡»åŒ…å«å®Œæ•´çš„<style>æ ‡ç­¾ï¼Œä½¿ç”¨CSSå˜é‡å®šä¹‰ä¸“å±ä¸»é¢˜è‰²
   - å¿…é¡»æ ¹æ®è§’è‰²è®¾å®šåŠ¨æ€è°ƒæ•´UIè®¾è®¡ï¼ˆæè´¨æ„Ÿã€å­—ä½“ã€é¢œè‰²ç­‰ï¼‰
   - å¿…é¡»ä½¿ç”¨CSS @importå¼•å…¥Google Fontsè¿›è¡Œå­—ä½“ç¾åŒ–
   - å¿…é¡»åŒ…å«è§’è‰²çš„æ‰€æœ‰ä¿¡æ¯å±•ç¤º
   - å›¾åƒPromptåŒºåŸŸå¿…é¡»æ˜¯ç‹¬ç«‹çš„divï¼Œdisplay: blockï¼Œmin-height: 50pxï¼Œä¸èƒ½ä½¿ç”¨overflow: hidden
   - Promptæ–‡æœ¬æ ¼å¼ï¼šimage###{Split cues}###
   - éçº¿æ€§æ’ç‰ˆï¼Œæ ¹æ®è®¾è®¡ç¾æ„Ÿè‡ªç”±æ’å¸ƒ
   - è¾ƒé•¿çš„èƒŒæ™¯æ•…äº‹ç­‰æ–‡æœ¬é‡‡ç”¨å¯æ»šåŠ¨å½¢å¼
   - SSRè§’è‰²å¿…é¡»åŒ…å«ç‰¹æ®ŠåŠ¨æ€ç‰¹æ•ˆï¼ˆCSSåŠ¨ç”»æµå…‰ç­‰ï¼‰

5. æ›´æ–°å˜é‡ï¼šå°†æ–°è§’è‰²æ·»åŠ åˆ°è§’è‰²ä»“åº“ï¼Œæ‰£é™¤è´§å¸ï¼Œæ›´æ–°æŠ½å¡è®°å½•ç­‰
   - å¿…é¡»ä½¿ç”¨JSONPatchæ ¼å¼æ›´æ–°æ¸¸æˆçŠ¶æ€
   - æ–°è§’è‰²å¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼šå…ƒç´ ã€å§“åã€ç¨€æœ‰åº¦ã€æ€§åˆ«ã€ç§æ—å‡ºèº«ã€èŒä¸šèº«ä»½ã€å¤–è²Œç‰¹ç‚¹ã€æ€§æ ¼å–œå¥½ã€ç®€ä»‹ã€èƒŒæ™¯æ•…äº‹ã€ç»˜å›¾æ ‡ç­¾ã€å±æ€§ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ï¼Œåˆå§‹å€¼æ ¹æ®ç¨€æœ‰åº¦è®¾å®šï¼‰ã€æƒ…æ„ŸçŠ¶æ€ï¼ˆå¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿã€æƒ…æ„Ÿå¼ºåº¦ã€ç‰¹æ®ŠçŠ¶æ€ï¼‰ã€çŠ¶æ€ï¼ˆåˆå§‹ä¸º"ç©ºé—²"ï¼‰ã€å½“å‰ä½ç½®ï¼ˆåˆå§‹ä¸º"ä»“åº“"ï¼‰ã€ç»éªŒå€¼ï¼ˆåˆå§‹ä¸º0ï¼‰ã€ç­‰çº§ï¼ˆåˆå§‹ä¸º1ï¼‰ã€æ¥å®¢æ¬¡æ•°ï¼ˆåˆå§‹ä¸º0ï¼‰ã€è°ƒæ•™æ¬¡æ•°ï¼ˆåˆå§‹ä¸º0ï¼‰ã€æ”¶å…¥è´¡çŒ®ï¼ˆåˆå§‹ä¸º0ï¼‰ã€æœ€åäº’åŠ¨ï¼ˆå½“å‰æ—¶é—´æˆ³ï¼‰
   - æ›´æ–°æŠ½å¡è®°å½•ï¼šç”Ÿæˆå”¯ä¸€æŠ½å¡IDï¼Œè®°å½•æ—¶é—´æˆ³ã€ç±»å‹ã€æ¶ˆè€—ã€ç»“æœï¼ˆè§’è‰²IDæ•°ç»„ï¼‰
   - æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼šæ€»æŠ½å¡æ¬¡æ•°+1ï¼Œæ€»è·å¾—è§’è‰²+1ï¼Œå¯¹åº”ç¨€æœ‰åº¦+1ï¼Œå¯¹åº”æƒ…æ„Ÿç±»å‹+1

**é‡è¦è¦æ±‚ï¼š**
- å‰ç«¯HTMLå¿…é¡»å®Œæ•´ï¼ŒåŒ…å«ä»<style>å¼€å§‹åˆ°æœ€åä¸€ä¸ªé—­åˆæ ‡ç­¾çš„å®Œæ•´ç»“æ„
- å‰ç«¯HTMLç›´æ¥è¾“å‡ºåœ¨å›å¤ä¸­ï¼Œä¸è¦ç”¨\`\`\`htmlä»£ç å—åŒ…è£¹
- å‰ç«¯HTMLä¼šç”±ç³»ç»Ÿè‡ªåŠ¨ä¿å­˜åˆ°è§’è‰².è‡ªå®šä¹‰å‰ç«¯HTMLå­—æ®µä¸­
- ç¡®ä¿å‰ç«¯HTMLç»“æ„å®Œæ•´ï¼Œèƒ½å¤Ÿç‹¬ç«‹æ¸²æŸ“`;

        await sendCommandToAI(command);
      }

      // ==================== AI äº¤äº’æ¥å£ ====================
      async function sendCommandToAI(command) {
        try {
          if (typeof generate !== 'undefined') {
            const response = await generate({ user_input: command });
            parseAIResponse(response);
            return response;
          } else if (typeof SillyTavern !== 'undefined') {
            SillyTavern.sendMessage(command);
          } else {
            await navigator.clipboard.writeText(command);
            alert(`æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ${command}\nè¯·ç²˜è´´åˆ°èŠå¤©æ¡†å‘é€ç»™ AI`);
          }
        } catch (error) {
          console.error('å‘é€æŒ‡ä»¤å¤±è´¥:', error);
          await navigator.clipboard.writeText(command);
          alert(`æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ${command}\nè¯·ç²˜è´´åˆ°èŠå¤©æ¡†å‘é€ç»™ AI`);
        }
      }

      function parseAIResponse(response) {
        // æ”¹è¿›çš„HTMLæå–é€»è¾‘ï¼šæå–å®Œæ•´çš„HTMLè§’è‰²å¡
        let extractedHtmlCard = '';

        // æŸ¥æ‰¾HTMLå¡ç‰‡
        const styleMatch = response.match(/<style>[\s\S]*?<\/style>/);

        if (styleMatch) {
          const styleStartIndex = styleMatch.index;
          const styleEndIndex = styleMatch.index + styleMatch[0].length;

          // ä» </style> ä¹‹åå¼€å§‹æŸ¥æ‰¾HTMLå†…å®¹
          let htmlStart = styleEndIndex;
          let htmlEnd = -1;

          // è·³è¿‡ç©ºç™½å­—ç¬¦
          while (htmlStart < response.length && /\s/.test(response[htmlStart])) {
            htmlStart++;
          }

          // æŸ¥æ‰¾ç¬¬ä¸€ä¸ª <div æˆ– <section æˆ–å…¶ä»–HTMLæ ‡ç­¾
          const firstTagMatch = response.substring(htmlStart).match(/<(\w+)[\s>]/);
          if (firstTagMatch) {
            const tagName = firstTagMatch[1];
            const tagStart = htmlStart + firstTagMatch.index;

            // æŸ¥æ‰¾åŒ¹é…çš„é—­åˆæ ‡ç­¾
            let tagCount = 0;
            let inTag = false;
            let tagBuffer = '';

            for (let i = tagStart; i < response.length; i++) {
              const char = response[i];

              if (char === '<') {
                inTag = true;
                tagBuffer = '<';
              } else if (char === '>') {
                tagBuffer += '>';
                inTag = false;

                // æ£€æŸ¥æ˜¯å¦æ˜¯å¼€å§‹æ ‡ç­¾
                if (tagBuffer.match(new RegExp(`<${tagName}[\\s>]`))) {
                  tagCount++;
                }
                // æ£€æŸ¥æ˜¯å¦æ˜¯é—­åˆæ ‡ç­¾
                else if (tagBuffer.match(new RegExp(`</${tagName}>`))) {
                  tagCount--;
                  if (tagCount === 0) {
                    htmlEnd = i + 1;
                    break;
                  }
                }

                tagBuffer = '';
              } else if (inTag) {
                tagBuffer += char;
              }
            }

            if (htmlEnd > htmlStart) {
              extractedHtmlCard = response.substring(styleStartIndex, htmlEnd);
            } else {
              // æ–¹æ³•2ï¼šå¦‚æœæ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æå–åˆ°JSONPatch
              const jsonPatchStart = response.indexOf('<JSONPatch>', styleEndIndex);
              const endPos = jsonPatchStart > 0 ? jsonPatchStart : response.length;

              if (endPos > styleStartIndex) {
                extractedHtmlCard = response.substring(styleStartIndex, endPos).trim();
              }
            }

            // æ¸…ç†æå–çš„HTML
            extractedHtmlCard = extractedHtmlCard.replace(/^```html\s*/i, '').replace(/\s*```$/i, '');
            extractedHtmlCard = extractedHtmlCard.replace(/^```\s*/i, '').replace(/\s*```$/i, '');

            if (extractedHtmlCard && extractedHtmlCard.length > 100) {
              console.info('æå–åˆ°å‰ç«¯HTMLï¼Œé•¿åº¦:', extractedHtmlCard.length);

              // åœ¨æŠ½å¡ç•Œé¢æ˜¾ç¤º
              const cardDisplay = document.getElementById('character-card-display');
              if (cardDisplay) {
                cardDisplay.style.display = 'block';
                cardDisplay.innerHTML = `<div style="max-width: 100%; overflow-x: auto; box-sizing: border-box">${extractedHtmlCard}</div>`;

                // æ»šåŠ¨åˆ°å¡ç‰‡æ˜¾ç¤ºåŒºåŸŸ
                setTimeout(() => {
                  cardDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
              }
            }
          }
        }

        // è§£æ JSON Patch
        const jsonPatchMatch = response.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/);
        if (jsonPatchMatch) {
          try {
            const patches = JSON.parse(jsonPatchMatch[1]);

            // å¦‚æœæœ‰æå–çš„HTMLå¡ç‰‡ï¼Œå°†å…¶ä¿å­˜åˆ°æ–°æ·»åŠ çš„è§’è‰²ä¸­
            if (extractedHtmlCard && extractedHtmlCard.length > 100) {
              patches.forEach(patch => {
                if (patch.path.includes('è§’è‰²ä»“åº“') && patch.op === 'add') {
                  const charId = patch.path.split('/').pop();
                  if (patch.value && typeof patch.value === 'object') {
                    patch.value.è‡ªå®šä¹‰å‰ç«¯HTML = extractedHtmlCard;
                    console.info('å·²ä¿å­˜å‰ç«¯HTMLåˆ°è§’è‰²:', charId);
                  }
                }
              });
            }

            // è°ƒè¯•ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ–°è§’è‰²æ·»åŠ 
            patches.forEach(patch => {
              if (patch.path.includes('è§’è‰²ä»“åº“') && patch.op === 'add') {
                console.info('æ–°è§’è‰²æ·»åŠ :', patch.path, patch.value);
                if (patch.value && patch.value.ç»˜å›¾æ ‡ç­¾) {
                  console.info('è§’è‰²ç»˜å›¾æ ‡ç­¾:', patch.value.ç»˜å›¾æ ‡ç­¾.substring(0, 100));
                }
                if (patch.value && patch.value.è‡ªå®šä¹‰å‰ç«¯HTML) {
                  console.info('è§’è‰²å‰ç«¯HTMLå·²ä¿å­˜');
                }
              }
            });

            applyJSONPatches(patches);
          } catch (error) {
            console.error('è§£æ JSON Patch å¤±è´¥:', error);
          }
        }

        refreshAllPages();
      }

      function applyJSONPatches(patches) {
        patches.forEach(patch => {
          try {
            const path = patch.path.replace(/^\//, '').split('/');

            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ­£åœ¨å¤„ç†æŠ½å¡è´¹ç”¨ï¼Œä¸” AI è¿”å›çš„è´§å¸æ›´æ–°ï¼Œéœ€è¦åˆå¹¶å¤„ç†
            if (pendingSummonCost > 0 && path.length === 1 && path[0] === 'è´§å¸' && patch.op === 'replace') {
              // AI è¿”å›çš„è´§å¸å€¼åº”è¯¥å·²ç»æ‰£é™¤äº†è´¹ç”¨ï¼Œç›´æ¥ä½¿ç”¨
              setNestedValue(gameState, path, patch.value);
              pendingSummonCost = 0; // æ¸…é™¤å¾…å¤„ç†è´¹ç”¨
            } else if (pendingSummonCost > 0 && path.length === 1 && path[0] === 'è´§å¸' && patch.op === 'add') {
              // å¦‚æœæ˜¯ add æ“ä½œï¼Œéœ€è¦å…ˆæ‰£é™¤è´¹ç”¨
              const currentMoney = getNestedValue(gameState, path) || gameState.è´§å¸;
              setNestedValue(gameState, path, currentMoney - pendingSummonCost + (patch.value || 0));
              pendingSummonCost = 0;
            } else {
              // æ­£å¸¸å¤„ç†å…¶ä»– patch
              if (patch.op === 'replace') {
                setNestedValue(gameState, path, patch.value);
              } else if (patch.op === 'add') {
                setNestedValue(gameState, path, patch.value);
              } else if (patch.op === 'remove') {
                const parent = getNestedValue(gameState, path.slice(0, -1));
                if (parent) {
                  delete parent[path[path.length - 1]];
                }
              }
            }
          } catch (error) {
            console.error('åº”ç”¨ JSON Patch å¤±è´¥:', patch, error);
          }
        });

        // å¦‚æœè¿˜æœ‰å¾…å¤„ç†çš„è´¹ç”¨ï¼ˆAI æ²¡æœ‰è¿”å›è´§å¸æ›´æ–°ï¼‰ï¼Œæ‰‹åŠ¨æ‰£é™¤
        if (pendingSummonCost > 0) {
          gameState.è´§å¸ -= pendingSummonCost;
          pendingSummonCost = 0;
        }

        // å»¶è¿Ÿåˆ·æ–°ï¼Œé¿å…è¦†ç›–æ­£åœ¨æ¸²æŸ“çš„å›¾ç‰‡
        setTimeout(() => {
          refreshAllPages();
        }, 100);
      }

      function getNestedValue(obj, path) {
        return path.reduce((current, key) => {
          if (Array.isArray(current) && /^\d+$/.test(key)) {
            return current[parseInt(key)];
          }
          return current && current[key];
        }, obj);
      }

      function setNestedValue(obj, path, value) {
        const lastKey = path[path.length - 1];
        const parent = path.slice(0, -1).reduce((current, key) => {
          if (!current[key]) {
            current[key] = {};
          }
          return current[key];
        }, obj);
        parent[lastKey] = value;
      }

      // ==================== MVU å˜é‡é›†æˆ ====================
      async function loadGameStateFromMVU() {
        try {
          if (typeof waitGlobalInitialized !== 'undefined') {
            await waitGlobalInitialized('Mvu');
          }

          if (typeof Mvu !== 'undefined' && typeof getCurrentMessageId !== 'undefined') {
            const messageId = getCurrentMessageId();
            const mvuData = Mvu.getMvuData({ type: 'message', message_id: messageId });
            const statData = typeof _ !== 'undefined' && _.get ? _.get(mvuData, 'stat_data') : mvuData?.stat_data;

            if (statData) {
              Object.assign(gameState, statData);
              refreshAllPages();
            }
          } else if (typeof getVariables !== 'undefined') {
            const variables = getVariables({ type: 'message', message_id: 'latest' });
            const statData = variables?.stat_data;

            if (statData) {
              Object.assign(gameState, statData);
              refreshAllPages();
            }
          }
        } catch (error) {
          console.error('åŠ è½½ MVU å˜é‡å¤±è´¥:', error);
          refreshAllPages();
        }
      }

      async function saveGameStateToMVU() {
        try {
          if (typeof updateVariablesWith !== 'undefined' && typeof getCurrentMessageId !== 'undefined') {
            const messageId = getCurrentMessageId();
            updateVariablesWith(
              variables => {
                if (typeof _ !== 'undefined' && _.set) {
                  _.set(variables, 'stat_data', gameState);
                } else {
                  variables.stat_data = gameState;
                }
                return variables;
              },
              { type: 'message', message_id: messageId },
            );
          }
        } catch (error) {
          console.error('ä¿å­˜ MVU å˜é‡å¤±è´¥:', error);
        }
      }

      // ==================== äº‹ä»¶ç›‘å¬ ====================
      function setupEventListeners() {
        if (typeof eventOn !== 'undefined' && typeof Mvu !== 'undefined') {
          eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, newVariables => {
            const statData =
              typeof _ !== 'undefined' && _.get ? _.get(newVariables, 'stat_data') : newVariables?.stat_data;
            if (statData) {
              Object.assign(gameState, statData);
              refreshAllPages();
            }
          });
        }

        const searchInput = document.getElementById('search-input');
        const filterRarity = document.getElementById('filter-rarity');

        if (searchInput) {
          searchInput.addEventListener('input', () => refreshUnitsPage());
        }
        if (filterRarity) {
          filterRarity.addEventListener('change', () => refreshUnitsPage());
        }
      }

      // ==================== è§’è‰²è¯¦æƒ… ====================
      function showCharacterDetail(id) {
        const char = gameState.è§’è‰²ä»“åº“[id];
        if (!char) return;

        const modal = document.getElementById('character-detail-modal');
        const content = document.getElementById('character-detail-content');

        if (!modal || !content) return;

        // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰çš„å‰ç«¯è§’è‰²å¡HTMLï¼ˆå­˜å‚¨åœ¨å˜é‡ä¸­ï¼‰
        // å°è¯•ä»å¤šä¸ªå¯èƒ½çš„å­—æ®µè·å–
        const customCardHtml = char.è‡ªå®šä¹‰å‰ç«¯HTML || char.å‰ç«¯HTML || char.HTMLå¡ç‰‡ || '';

        if (customCardHtml && (customCardHtml.includes('<style>') || customCardHtml.includes('<div'))) {
          // å¦‚æœæœ‰è‡ªå®šä¹‰å‰ç«¯ï¼Œæ˜¾ç¤ºå®Œæ•´çš„å‰ç«¯è§’è‰²å¡ï¼Œå¹¶æ·»åŠ æ‰€æœ‰æ“ä½œå’Œäº’åŠ¨åŒºåŸŸ
          content.innerHTML = customCardHtml;

          // æ·»åŠ å±æ€§æ˜¾ç¤ºåŒºåŸŸ
          const attrSection = document.createElement('div');
          attrSection.style.cssText =
            'margin-top: 20px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px;';
          attrSection.innerHTML = `
            <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å±æ€§</h3>
            ${['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦']
              .map(
                stat => `
              <div style="margin-bottom: 10px">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px">
                  <span>${stat}</span>
                  <span>${char.å±æ€§?.[stat] || 0}/100</span>
                </div>
                <div class="stat-bar">
                  <div class="stat-fill" style="width: ${char.å±æ€§?.[stat] || 0}%"></div>
                </div>
              </div>
            `,
              )
              .join('')}
          `;
          content.appendChild(attrSection);

          // æ·»åŠ äº’åŠ¨å‰§æƒ…æ˜¾ç¤ºåŒºåŸŸ
          const storySection = document.createElement('div');
          storySection.style.cssText =
            'margin-top: 20px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px;';
          storySection.innerHTML = `
            <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">äº’åŠ¨å‰§æƒ…</h3>
            <div id="character-story-${id}" class="story-container">
              <div class="story-content" id="story-content-${id}" style="min-height: 100px; max-height: 400px; overflow-y: auto; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; line-height: 1.8">
                <div class="story-placeholder">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹äº’åŠ¨ï¼ŒAI ç”Ÿæˆçš„å‰§æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
              </div>
            </div>
          `;
          content.appendChild(storySection);

          // æ·»åŠ æ‰€æœ‰æ“ä½œæŒ‰é’®
          const actionButtons = document.createElement('div');
          actionButtons.style.cssText =
            'margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px;';
          actionButtons.innerHTML = `
            <button class="btn btn-secondary" onclick="showTrainingInput('${id}')">ğŸ” è°ƒæ•™</button>
            <button class="btn btn-secondary" onclick="startInteraction('${id}', 'å¯¹è¯')">ğŸ’¬ å¯¹è¯</button>
            <button class="btn btn-secondary" onclick="startInteraction('${id}', 'ç‰¹æ®Šäº’åŠ¨')">âœ¨ ç‰¹æ®Šäº’åŠ¨</button>
            <button class="btn" onclick="assignCharacterToBrothel('${id}')">ğŸ›ï¸ æ´¾é£æ¥å®¢</button>
            <button class="btn btn-secondary" onclick="decomposeCharacter('${id}')">âš¡ åˆ†è§£</button>
          `;
          content.appendChild(actionButtons);

          modal.classList.add('active');
          modal.scrollTop = 0;
          setTimeout(() => {
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
              modalContent.scrollTop = 0;
            }
          }, 100);
          return;
        }

        // å¦åˆ™æ˜¾ç¤ºæ ‡å‡†è¯¦æƒ…é¡µ
        const imageContainer = document.createElement('div');
        imageContainer.style.width = '100%';
        imageContainer.style.aspectRatio = '1';
        imageContainer.style.marginBottom = '20px';
        imageContainer.style.borderRadius = '12px';
        imageContainer.style.overflow = 'hidden';
        imageContainer.style.border = '1px solid rgba(139, 92, 246, 0.3)';
        imageContainer.className = 'character-image-container';

        if (char.ç»˜å›¾æ ‡ç­¾) {
          imageContainer.innerHTML =
            '<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 48px">â³</div>';
          setTimeout(() => {
            const rendered = renderImageTag(char.ç»˜å›¾æ ‡ç­¾, imageContainer);
            if (!rendered) {
              const prompt = char.ç»˜å›¾æ ‡ç­¾.match(/image###([\s\S]*?)###/)?.[1] || '';
              if (prompt) {
                imageContainer.innerHTML = `
                  <div class="image-placeholder" onclick="copyImagePrompt('${prompt.replace(/'/g, "\\'")}')">
                    <div style="font-size: 48px; margin-bottom: 8px">ğŸ–¼ï¸</div>
                    <div style="font-size: 12px; text-align: center; padding: 0 8px">ç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤</div>
                  </div>
                `;
              } else {
                imageContainer.innerHTML =
                  '<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 64px">ğŸ‘¤</div>';
              }
            }
          }, 100);
        } else {
          imageContainer.innerHTML =
            '<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 64px">ğŸ‘¤</div>';
        }

        content.innerHTML = `
        <h2 style="font-size: 28px; color: var(--primary); margin-bottom: 24px; text-align: center">${char.å§“å}</h2>
        <div id="char-detail-image"></div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px">
          <div>
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">ç¨€æœ‰åº¦</div>
            <div style="font-size: 20px; font-weight: bold" class="rarity-${char.ç¨€æœ‰åº¦}">${char.ç¨€æœ‰åº¦}</div>
          </div>
          <div>
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">èŒä¸š</div>
            <div style="font-size: 18px">${char.èŒä¸šèº«ä»½ || 'æ— '}</div>
          </div>
          <div>
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">ç­‰çº§</div>
            <div style="font-size: 20px; font-weight: bold; color: var(--accent-gold)">Lv.${char.ç­‰çº§ || 1}</div>
            <div style="font-size: 12px; color: var(--text-secondary)">ç»éªŒ: ${char.ç»éªŒå€¼ || 0}/${(char.ç­‰çº§ || 1) * 100}</div>
          </div>
          <div>
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">æƒ…æ„ŸçŠ¶æ€</div>
            <div style="font-size: 16px">${char.æƒ…æ„ŸçŠ¶æ€?.å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ || 'ä¸­ç«‹'}</div>
            <div style="font-size: 12px; color: var(--text-secondary)">å¼ºåº¦: ${char.æƒ…æ„ŸçŠ¶æ€?.æƒ…æ„Ÿå¼ºåº¦ || 0}</div>
            ${char.æƒ…æ„ŸçŠ¶æ€?.ç‰¹æ®ŠçŠ¶æ€?.length > 0 ? `<div style="font-size: 12px; color: var(--primary); margin-top: 4px">${char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.join(', ')}</div>` : ''}
          </div>
          <div>
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">ç»Ÿè®¡æ•°æ®</div>
            <div style="font-size: 12px; color: var(--text-secondary)">æ¥å®¢: ${char.æ¥å®¢æ¬¡æ•° || 0}æ¬¡</div>
            <div style="font-size: 12px; color: var(--text-secondary)">è°ƒæ•™: ${char.è°ƒæ•™æ¬¡æ•° || 0}æ¬¡</div>
            <div style="font-size: 12px; color: var(--accent-gold)">è´¡çŒ®: ${char.æ”¶å…¥è´¡çŒ® || 0}é‡‘</div>
          </div>
        </div>

        <div style="margin-bottom: 24px">
          <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å±æ€§</h3>
          ${['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦']
            .map(
              stat => `
            <div style="margin-bottom: 10px">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px">
                <span>${stat}</span>
                <span>${char.å±æ€§?.[stat] || 0}/100</span>
              </div>
              <div class="stat-bar">
                <div class="stat-fill" style="width: ${char.å±æ€§?.[stat] || 0}%"></div>
              </div>
            </div>
          `,
            )
            .join('')}
        </div>

        <div style="margin-bottom: 24px">
          <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">èƒŒæ™¯æ•…äº‹</h3>
          <div style="max-height: 500px; overflow-y: auto; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word; text-align: left">
            ${(char.èƒŒæ™¯æ•…äº‹ || 'æš‚æ— èƒŒæ™¯æ•…äº‹').replace(/\n/g, '<br>')}
          </div>
        </div>

        <div style="margin-bottom: 24px">
          <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">äº’åŠ¨å‰§æƒ…</h3>
          <div id="character-story-${id}" class="story-container">
            <div class="story-content" id="story-content-${id}" style="min-height: 150px; max-height: 500px; overflow-y: auto; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word">
              <div class="story-placeholder">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹äº’åŠ¨ï¼ŒAI ç”Ÿæˆçš„å‰§æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 24px">
          <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">æ“ä½œ</h3>
          <div style="display: flex; gap: 12px; flex-wrap: wrap">
            <button class="btn btn-secondary" onclick="showTrainingInput('${id}')">ğŸ” è°ƒæ•™</button>
            <button class="btn btn-secondary" onclick="startInteraction('${id}', 'å¯¹è¯')">ğŸ’¬ å¯¹è¯</button>
            <button class="btn btn-secondary" onclick="startInteraction('${id}', 'ç‰¹æ®Šäº’åŠ¨')">âœ¨ ç‰¹æ®Šäº’åŠ¨</button>
            <button class="btn" onclick="assignCharacterToBrothel('${id}')">ğŸ›ï¸ æ´¾é£æ¥å®¢</button>
            <button class="btn btn-secondary" onclick="decomposeCharacter('${id}')">âš¡ åˆ†è§£</button>
          </div>
        </div>
      `;

        const imagePlaceholder = content.querySelector('#char-detail-image');
        if (imagePlaceholder) {
          imagePlaceholder.parentNode.replaceChild(imageContainer, imagePlaceholder);
        }

        modal.classList.add('active');

        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        modal.scrollTop = 0;

        // ç¡®ä¿æ¨¡æ€æ¡†å†…å®¹å¯ä»¥æ­£å¸¸æ»šåŠ¨
        setTimeout(() => {
          const modalContent = modal.querySelector('.modal-content');
          if (modalContent) {
            modalContent.scrollTop = 0;
          }
        }, 100);
      }

      function closeCharacterDetail() {
        const modal = document.getElementById('character-detail-modal');
        if (modal) {
          modal.classList.remove('active');
        }
      }

      // ==================== äº’åŠ¨åŠŸèƒ½ ====================
      function showTrainingInput(characterId) {
        const char = gameState.è§’è‰²ä»“åº“[characterId];
        if (!char) return;

        // åˆ›å»ºè°ƒæ•™è¾“å…¥æ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'training-input-modal';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 600px">
            <button class="modal-close" onclick="closeTrainingInput()">Ã—</button>
            <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">ğŸ” è°ƒæ•™è§’è‰²ï¼š${char.å§“å}</h2>

            <div style="margin-bottom: 16px">
              <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 8px">è°ƒæ•™æŒ‡ä»¤ï¼ˆæè¿°ä½ æƒ³è¦è¿›è¡Œçš„è°ƒæ•™å†…å®¹ï¼‰ï¼š</label>
              <textarea
                id="training-command-input"
                placeholder="ä¾‹å¦‚ï¼šä½¿ç”¨é­å­è¿›è¡Œè½»åº¦è°ƒæ•™ï¼Œé‡ç‚¹æå‡è§’è‰²çš„é¡ºä»åº¦..."
                style="
                  width: 100%;
                  min-height: 150px;
                  padding: 12px;
                  background: rgba(15, 23, 42, 0.6);
                  border: 1px solid rgba(139, 92, 246, 0.3);
                  border-radius: 12px;
                  color: var(--text-primary);
                  font-size: 14px;
                  resize: vertical;
                  font-family: inherit;
                "
              ></textarea>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end">
              <button class="btn btn-secondary" onclick="closeTrainingInput()">å–æ¶ˆ</button>
              <button class="btn" onclick="confirmTraining('${characterId}')">å¼€å§‹è°ƒæ•™</button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
        modal.classList.add('active');

        // èšç„¦è¾“å…¥æ¡†
        setTimeout(() => {
          const input = document.getElementById('training-command-input');
          if (input) input.focus();
        }, 100);
      }

      function closeTrainingInput() {
        const modal = document.getElementById('training-input-modal');
        if (modal) {
          modal.classList.remove('active');
          setTimeout(() => modal.remove(), 300);
        }
      }

      async function confirmTraining(characterId) {
        const input = document.getElementById('training-command-input');
        const userCommand = input ? input.value.trim() : '';

        closeTrainingInput();

        if (!userCommand) {
          alert('è¯·è¾“å…¥è°ƒæ•™æŒ‡ä»¤ï¼');
          return;
        }

        // ç¡®ä¿è§’è‰²è¯¦æƒ…é¡µå·²æ‰“å¼€ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ‰“å¼€
        const modal = document.getElementById('character-detail-modal');
        if (!modal || !modal.classList.contains('active')) {
          showCharacterDetail(characterId);
          // ç­‰å¾…æ¨¡æ€æ¡†æ‰“å¼€åå†æ‰§è¡Œè°ƒæ•™
          setTimeout(() => {
            startInteraction(characterId, 'è°ƒæ•™', userCommand);
          }, 300);
        } else {
          await startInteraction(characterId, 'è°ƒæ•™', userCommand);
        }
      }

      async function startInteraction(characterId, interactionType, customCommand = '') {
        const char = gameState.è§’è‰²ä»“åº“[characterId];
        if (!char) return;

        const storyContent = document.getElementById(`story-content-${characterId}`);
        if (storyContent) {
          storyContent.innerHTML = '<div class="story-loading">â³ AI æ­£åœ¨ç”Ÿæˆå‰§æƒ…ï¼Œè¯·ç¨å€™...</div>';
        }

        let command = '';
        switch (interactionType) {
          case 'è°ƒæ•™':
            if (customCommand) {
              command = `è°ƒæ•™è§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰ã€‚æ ¹æ®ä»¥ä¸‹æŒ‡ä»¤è¿›è¡Œè°ƒæ•™ï¼š\n\n${customCommand}\n\nè¯·ç”Ÿæˆè¯¦ç»†çš„è°ƒæ•™å‰§æƒ…ï¼ŒåŒ…æ‹¬è¿‡ç¨‹ã€è§’è‰²ååº”ã€çŠ¶æ€å˜åŒ–ç­‰ã€‚`;
            } else {
              command = `è°ƒæ•™è§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰ã€‚è¯·ç”Ÿæˆè¯¦ç»†çš„è°ƒæ•™å‰§æƒ…ï¼ŒåŒ…æ‹¬è¿‡ç¨‹ã€è§’è‰²ååº”ã€çŠ¶æ€å˜åŒ–ç­‰ã€‚`;
            }

            command += `\n\nè°ƒæ•™å†…å®¹å¯ä»¥åŒ…æ‹¬ï¼š
- è°ƒæ•™è¿‡ç¨‹æè¿°ï¼ˆå·¥å…·ã€æ–¹æ³•ã€æ­¥éª¤ç­‰ï¼‰
- è§’è‰²çš„èº«ä½“ååº”å’Œå¿ƒç†å˜åŒ–
- è§’è‰²å±æ€§çš„å˜åŒ–ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ç­‰ï¼‰
- è§’è‰²æƒ…æ„ŸçŠ¶æ€çš„å˜åŒ–
- è°ƒæ•™åçš„çŠ¶æ€å’Œæ•ˆæœ

é‡è¦è¦æ±‚ï¼š
- ä¸è¦ç”ŸæˆçŠ¶æ€æ ï¼ˆ/.*/sæ ¼å¼çš„å†…å®¹ï¼‰
- ä¸è¦å—ä¸–ç•Œä¹¦å½±å“ç”Ÿæˆé¢å¤–çš„çŠ¶æ€æ æˆ–æ ¼å¼åŒ–å†…å®¹
- åªç”Ÿæˆçº¯æ–‡æœ¬å‰§æƒ…å†…å®¹
- **å¿…é¡»ä½¿ç”¨JSONPatchæ ¼å¼æ›´æ–°è§’è‰²å±æ€§**ï¼ŒåŒ…æ‹¬ï¼šé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦
- å±æ€§æ›´æ–°è·¯å¾„æ ¼å¼ï¼šè§’è‰²ä»“åº“/${characterId}/å±æ€§/é­…åŠ›ã€è§’è‰²ä»“åº“/${characterId}/å±æ€§/é¡ºä» ç­‰
- è°ƒæ•™å‰§æƒ…åº”è¯¥è¯¦ç»†ã€ç”ŸåŠ¨ï¼Œä½“ç°è°ƒæ•™çš„è¿‡ç¨‹å’Œæ•ˆæœ
- å¦‚æœè°ƒæ•™æ¶‰åŠæå‡æŸä¸ªå±æ€§ï¼Œå¿…é¡»åœ¨JSONPatchä¸­æ˜ç¡®æ›´æ–°è¯¥å±æ€§çš„æ•°å€¼`;
            break;
          case 'å¯¹è¯':
            command = `ä¸è§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰è¿›è¡Œå¯¹è¯äº’åŠ¨ã€‚è¯·ç”Ÿæˆå¯¹è¯å†…å®¹å’Œè§’è‰²ååº”ã€‚

é‡è¦è¦æ±‚ï¼š
- ä¸è¦ç”ŸæˆçŠ¶æ€æ ï¼ˆ/.*/sæ ¼å¼çš„å†…å®¹ï¼‰
- ä¸è¦å—ä¸–ç•Œä¹¦å½±å“ç”Ÿæˆé¢å¤–çš„çŠ¶æ€æ æˆ–æ ¼å¼åŒ–å†…å®¹
- åªç”Ÿæˆçº¯æ–‡æœ¬å¯¹è¯å†…å®¹
- å¦‚æœéœ€è¦æ›´æ–°è§’è‰²çŠ¶æ€ï¼Œè¯·ä½¿ç”¨JSONPatchæ ¼å¼`;
            break;
          case 'ç‰¹æ®Šäº’åŠ¨':
            command = `ä¸è§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰è¿›è¡Œç‰¹æ®Šäº’åŠ¨ã€‚è¯·æ ¹æ®è§’è‰²å½“å‰çŠ¶æ€ç”Ÿæˆåˆé€‚çš„äº’åŠ¨å‰§æƒ…ã€‚

é‡è¦è¦æ±‚ï¼š
- ä¸è¦ç”ŸæˆçŠ¶æ€æ ï¼ˆ/.*/sæ ¼å¼çš„å†…å®¹ï¼‰
- ä¸è¦å—ä¸–ç•Œä¹¦å½±å“ç”Ÿæˆé¢å¤–çš„çŠ¶æ€æ æˆ–æ ¼å¼åŒ–å†…å®¹
- åªç”Ÿæˆçº¯æ–‡æœ¬å‰§æƒ…å†…å®¹
- å¦‚æœéœ€è¦æ›´æ–°è§’è‰²çŠ¶æ€ï¼Œè¯·ä½¿ç”¨JSONPatchæ ¼å¼`;
            break;
          default:
            command = `ä¸è§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰è¿›è¡Œ${interactionType}äº’åŠ¨ã€‚

é‡è¦è¦æ±‚ï¼š
- ä¸è¦ç”ŸæˆçŠ¶æ€æ ï¼ˆ/.*/sæ ¼å¼çš„å†…å®¹ï¼‰
- ä¸è¦å—ä¸–ç•Œä¹¦å½±å“ç”Ÿæˆé¢å¤–çš„çŠ¶æ€æ æˆ–æ ¼å¼åŒ–å†…å®¹
- åªç”Ÿæˆçº¯æ–‡æœ¬å†…å®¹`;
        }

        try {
          const response = await sendCommandToAI(command);

          if (response && storyContent) {
            let storyText = response;
            const jsonPatchMatch = storyText.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/);
            if (jsonPatchMatch) {
              storyText = storyText.replace(/<JSONPatch>[\s\S]*?<\/JSONPatch>/, '').trim();
            }
            storyText = storyText.replace(/<UpdateVariable>[\s\S]*?<\/UpdateVariable>/, '').trim();
            storyText = storyText.replace(/<Analysis>[\s\S]*?<\/Analysis>/, '').trim();

            // ä½¿ç”¨ formatAsDisplayedMessage é¿å…è¢«ç¾åŒ–æ æ­£åˆ™æ›¿æ¢
            if (typeof formatAsDisplayedMessage !== 'undefined') {
              storyText = formatAsDisplayedMessage(storyText);
            }

            storyContent.innerHTML = `<div class="story-content">${storyText}</div>`;
          }
        } catch (error) {
          console.error('ç”Ÿæˆå‰§æƒ…å¤±è´¥:', error);
          if (storyContent) {
            storyContent.innerHTML =
              '<div class="story-placeholder" style="color: var(--danger)">ç”Ÿæˆå‰§æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>';
          }
        }
      }

      function copyImagePrompt(prompt) {
        navigator.clipboard.writeText(prompt).then(() => {
          alert('ç»˜ç”»æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        });
      }

      async function assignCharacterToBrothel(id) {
        const char = gameState.è§’è‰²ä»“åº“[id];
        if (!char) return;

        // æŸ¥æ‰¾ç©ºé—²æˆ¿é—´ï¼ˆæ’é™¤è°ƒæ•™å®¤ï¼‰
        const availableRooms = Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€)
          .filter(([_, room]) => room.çŠ¶æ€ === 'ç©ºé—²' && room.ç±»å‹ !== 'è°ƒæ•™å®¤')
          .map(([roomId, _]) => roomId);

        if (availableRooms.length === 0) {
          alert('æ²¡æœ‰ç©ºé—²æˆ¿é—´ï¼');
          return;
        }

        // è®©ç”¨æˆ·é€‰æ‹©æˆ¿é—´
        const roomId = prompt(`é€‰æ‹©æˆ¿é—´åˆ†é…ç»™ ${char.å§“å}\nå¯ç”¨æˆ¿é—´: ${availableRooms.join(', ')}`, availableRooms[0]);

        if (!roomId || !availableRooms.includes(roomId)) {
          return;
        }

        closeCharacterDetail();

        // ç›´æ¥è°ƒç”¨åˆ†é…å‡½æ•°
        await assignCharacterToRoom(id, roomId);
      }

      function trainCharacter(id) {
        startInteraction(id, 'è°ƒæ•™');
      }

      function decomposeCharacter(id) {
        if (confirm(`ç¡®å®šè¦åˆ†è§£ ${gameState.è§’è‰²ä»“åº“[id].å§“å} å—ï¼Ÿ`)) {
          sendCommandToAI(`åˆ†è§£è§’è‰²${id}`);
          closeCharacterDetail();
        }
      }

      function selectCharacterForRoom(id) {
        const rooms = Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€)
          .filter(([_, room]) => room.çŠ¶æ€ === 'ç©ºé—²' && room.ç±»å‹ !== 'è°ƒæ•™å®¤')
          .map(([roomId, _]) => roomId);

        if (rooms.length === 0) {
          alert('æ²¡æœ‰ç©ºé—²æˆ¿é—´ï¼');
          return;
        }

        const roomId = prompt(`é€‰æ‹©æˆ¿é—´ (${rooms.join(', ')})`, rooms[0]);
        if (roomId && rooms.includes(roomId)) {
          sendCommandToAI(`å°†è§’è‰²${id}æŒ‡æ´¾åˆ°æˆ¿é—´${roomId}`);
        }
      }

      function showRoomAssignment(roomId) {
        // æ˜¾ç¤ºå¯åˆ†é…çš„è§’è‰²åˆ—è¡¨
        const availableChars = Object.entries(gameState.è§’è‰²ä»“åº“)
          .filter(([id, char]) => char.çŠ¶æ€ === 'ç©ºé—²' && char.å½“å‰ä½ç½® === 'ä»“åº“')
          .map(([id, char]) => ({ id, name: char.å§“å }));

        if (availableChars.length === 0) {
          alert('æ²¡æœ‰å¯åˆ†é…çš„è§’è‰²ï¼');
          return;
        }

        const charList = availableChars.map((c, i) => `${i + 1}. ${c.name} (${c.id})`).join('\n');
        const choice = prompt(`é€‰æ‹©è¦åˆ†é…åˆ°æˆ¿é—´ ${roomId} çš„è§’è‰²ï¼š\n\n${charList}\n\nè¯·è¾“å…¥è§’è‰²IDæˆ–åºå·ï¼š`);

        if (!choice) return;

        let selectedId = null;
        const choiceNum = parseInt(choice);
        if (!isNaN(choiceNum) && choiceNum > 0 && choiceNum <= availableChars.length) {
          selectedId = availableChars[choiceNum - 1].id;
        } else {
          selectedId = availableChars.find(c => c.id === choice || c.name === choice)?.id;
        }

        if (selectedId) {
          assignCharacterToRoom(selectedId, roomId);
        } else {
          alert('æ— æ•ˆçš„é€‰æ‹©ï¼');
        }
      }

      async function assignCharacterToRoom(characterId, roomId) {
        const char = gameState.è§’è‰²ä»“åº“[characterId];
        if (!char) return;

        const command = `å°†è§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰æŒ‡æ´¾åˆ°æˆ¿é—´${roomId}å¼€å§‹æ¥å®¢ã€‚è¯·ï¼š
1. æ›´æ–°è§’è‰².${characterId}.çŠ¶æ€ä¸º"æ¥å®¢ä¸­"
2. æ›´æ–°è§’è‰².${characterId}.å½“å‰ä½ç½®ä¸º"å¦“é™¢"
3. æ›´æ–°å¦“é™¢.æˆ¿é—´çŠ¶æ€.${roomId}.çŠ¶æ€ä¸º"ä½¿ç”¨ä¸­"ï¼ˆä¸è¦è®¾ç½®ä¸º"æ¸…æ´ä¸­"ï¼‰
4. æ›´æ–°å¦“é™¢.æˆ¿é—´çŠ¶æ€.${roomId}.å½“å‰è§’è‰²ä¸º"${characterId}"
5. åœ¨å¦“é™¢.å½“å‰æ¥å®¢è§’è‰².${characterId}ä¸­æ·»åŠ æ¥å®¢ä¿¡æ¯ï¼š
   - å¼€å§‹æ—¶é—´ï¼šå½“å‰æ¸¸æˆæ—¶é—´æˆ³
   - é¢„è®¡ç»“æŸï¼šå¼€å§‹æ—¶é—´ + 2å°æ—¶ Â± æœåŠ¡ç±»å‹å¤æ‚åº¦Ã—30åˆ†é’Ÿ
   - å®¢æˆ·ç±»å‹ï¼šæ ¹æ®æ¦‚ç‡ç”Ÿæˆï¼ˆæ™®é€š70%, VIP25%, ç‰¹æ®Šç™–å¥½5%ï¼‰
   - æœåŠ¡ç±»å‹ï¼šæ ¹æ®å®¢æˆ·ç±»å‹å’Œè§’è‰²å±æ€§ç”Ÿæˆï¼ˆæ™®é€šæœåŠ¡ã€è½»åº¦SMã€æŸç¼šæ¸¸æˆç­‰ï¼‰
   - åŸºç¡€æ”¶å…¥ï¼š100~500 Ã— (è§’è‰²é­…åŠ›/50) Ã— (è§’è‰²æŠ€å·§/50) Ã— æ”¶ç›Šå€ç‡
   - é¢å¤–æ”¶å…¥ï¼š0~300 Ã— æœåŠ¡ç±»å‹æ•°é‡ Ã— å®¢æˆ·ç±»å‹å€ç‡ Ã— æ”¶ç›Šå€ç‡
6. æ ¹æ®æ¥å®¢äº‹ä»¶æ›´æ–°è§’è‰²å±æ€§ï¼š
   - æŠ€å·§ï¼š+1~3
   - é¡ºä»ï¼šÂ±2~5ï¼ˆæ ¹æ®è§’è‰²æƒ…æ„ŸçŠ¶æ€ï¼‰
   - è€åŠ›ï¼š-1~2
   - ç»éªŒå€¼ï¼š+5~15 Ã— ç»éªŒå€ç‡
   - æ¥å®¢æ¬¡æ•°ï¼š+1
   - æ”¶å…¥è´¡çŒ®ï¼š+åŸºç¡€æ”¶å…¥+é¢å¤–æ”¶å…¥
   - æœ€åäº’åŠ¨ï¼šå½“å‰æ—¶é—´æˆ³
7. æ ¹æ®æƒ…æ„ŸçŠ¶æ€è®¡ç®—å®é™…æ”¶å…¥ï¼ˆçˆ±Ã—1.5, å–œæ¬¢Ã—1.2, ä¸­ç«‹Ã—1.0, åŒæ¶Ã—0.7, æ†æ¨Ã—0.4ï¼‰
8. æ ¹æ®ç‰¹æ®ŠçŠ¶æ€è°ƒæ•´æ”¶å…¥ï¼ˆéº»æœ¨Ã—0.8, å¿ è¯šÃ—1.3, åæŠ—Ã—0.5, å´©æºƒÃ—0.3ç­‰ï¼‰
9. æ›´æ–°è´§å¸ï¼š+å®é™…æ”¶å…¥
10. æ›´æ–°å¦“é™¢.ä»Šæ—¥æ”¶å…¥ï¼š+å®é™…æ”¶å…¥
11. æ›´æ–°ç»Ÿè®¡æ•°æ®.æ€»æ¥å®¢æ¬¡æ•°ï¼š+1
12. æ›´æ–°ç»Ÿè®¡æ•°æ®.æ€»æ”¶å…¥ï¼š+å®é™…æ”¶å…¥
13. ç”Ÿæˆè¯¦ç»†çš„æ¥å®¢å‰§æƒ…ï¼ŒåŒ…æ‹¬æœåŠ¡è¿‡ç¨‹ã€å®¢æˆ·ååº”ã€è§’è‰²çŠ¶æ€å˜åŒ–ç­‰
14. åœ¨å¦“é™¢.äº‹ä»¶æ—¥å¿—ä¸­æ·»åŠ äº‹ä»¶è®°å½•ï¼ˆæ—¶é—´æˆ³ã€è§’è‰²IDã€äº‹ä»¶ç±»å‹ã€æè¿°ã€æ”¶å…¥å˜åŒ–ï¼‰
15. æ£€æŸ¥è§’è‰²è¿ç»­æ¥å®¢æ¬¡æ•°ï¼Œå¦‚æœâ‰¥3æ¬¡å¯èƒ½è·å¾—"éº»æœ¨"çŠ¶æ€
16. æ£€æŸ¥è§’è‰²è€åŠ›ï¼Œå¦‚æœ<20åˆ™çŠ¶æ€æ”¹ä¸º"ä¼‘æ¯ä¸­"ï¼Œå¦‚æœ<5åˆ™çŠ¶æ€æ”¹ä¸º"åŒ»ç–—å®¤"

é‡è¦ï¼šè§’è‰²ä¸€æ—¦è¿›å…¥æˆ¿é—´æ¥å®¢ï¼ŒçŠ¶æ€åº”ä¿æŒä¸º"æ¥å®¢ä¸­"ï¼Œæˆ¿é—´çŠ¶æ€ä¿æŒä¸º"ä½¿ç”¨ä¸­"ï¼Œç›´åˆ°æˆ‘æ˜ç¡®æŒ‡ä»¤è®©è§’è‰²ç¦»å¼€ã€‚ä¸è¦è‡ªåŠ¨å°†æˆ¿é—´çŠ¶æ€æ”¹ä¸º"æ¸…æ´ä¸­"æˆ–ç§»é™¤è§’è‰²ã€‚`;

        const storyContent = document.getElementById('brothel-story-content');
        if (storyContent) {
          storyContent.innerHTML = '<div class="story-loading">â³ æ­£åœ¨åˆ†é…è§’è‰²å¹¶ç”Ÿæˆæ¥å®¢å‰§æƒ…ï¼Œè¯·ç¨å€™...</div>';
        }

        await sendCommandToAI(command);
      }

      async function showRoomDetail(roomId) {
        const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[roomId];
        const char = room.å½“å‰è§’è‰² ? gameState.è§’è‰²ä»“åº“[room.å½“å‰è§’è‰²] : null;
        const workingInfo = room.å½“å‰è§’è‰² ? gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[room.å½“å‰è§’è‰²] : null;

        if (char) {
          const storyContent = document.getElementById('brothel-story-content');
          if (storyContent) {
            storyContent.innerHTML = '<div class="story-loading">â³ AI æ­£åœ¨ç”Ÿæˆæ¥å®¢å‰§æƒ…ï¼Œè¯·ç¨å€™...</div>';
          }

          // å¦‚æœæœ‰æ¥å®¢ä¿¡æ¯ï¼Œæ˜¾ç¤ºå½“å‰çŠ¶æ€
          let statusInfo = '';
          if (workingInfo) {
            const endTime = new Date(workingInfo.é¢„è®¡ç»“æŸ);
            const now = Date.now();
            if (endTime > now) {
              statusInfo = `é¢„è®¡ç»“æŸæ—¶é—´: ${endTime.toLocaleString()}\nå®¢æˆ·ç±»å‹: ${workingInfo.å®¢æˆ·ç±»å‹}\næœåŠ¡ç±»å‹: ${workingInfo.æœåŠ¡ç±»å‹.join(', ')}\n`;
            }
          }

          const command = `è§’è‰²${room.å½“å‰è§’è‰²}ï¼ˆ${char.å§“å}ï¼‰åœ¨æˆ¿é—´${roomId}ä¸­ç»§ç»­æ¥å®¢ã€‚${statusInfo}è¯·ç”Ÿæˆè¯¦ç»†çš„æ¥å®¢å‰§æƒ…ï¼ŒåŒ…æ‹¬æœåŠ¡è¿‡ç¨‹ã€å®¢æˆ·ååº”ã€è§’è‰²çŠ¶æ€å˜åŒ–ã€æ”¶å…¥ç­‰ã€‚é‡è¦ï¼šä¿æŒè§’è‰²çŠ¶æ€ä¸º"æ¥å®¢ä¸­"ï¼Œæˆ¿é—´çŠ¶æ€ä¸º"ä½¿ç”¨ä¸­"ï¼Œä¸è¦æ”¹ä¸º"æ¸…æ´ä¸­"ã€‚`;

          try {
            const response = await sendCommandToAI(command);

            if (response && storyContent) {
              let storyText = response;
              const jsonPatchMatch = storyText.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/);
              if (jsonPatchMatch) {
                storyText = storyText.replace(/<JSONPatch>[\s\S]*?<\/JSONPatch>/, '').trim();
              }
              storyText = storyText.replace(/<UpdateVariable>[\s\S]*?<\/UpdateVariable>/, '').trim();
              storyText = storyText.replace(/<Analysis>[\s\S]*?<\/Analysis>/, '').trim();

              // ä½¿ç”¨ formatAsDisplayedMessage é¿å…è¢«ç¾åŒ–æ æ­£åˆ™æ›¿æ¢
              if (typeof formatAsDisplayedMessage !== 'undefined') {
                storyText = formatAsDisplayedMessage(storyText);
              }

              storyContent.innerHTML = `<div class="story-content">${storyText}</div>`;
            }
          } catch (error) {
            console.error('ç”Ÿæˆå‰§æƒ…å¤±è´¥:', error);
            if (storyContent) {
              storyContent.innerHTML =
                '<div class="story-placeholder" style="color: var(--danger)">ç”Ÿæˆå‰§æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>';
            }
          }
        } else {
          alert(`æˆ¿é—´ ${roomId}\nçŠ¶æ€: ${room.çŠ¶æ€}\nå½“å‰æ— è§’è‰²`);
        }
      }

      function toggleBrothelStatus() {
        const newStatus = gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€ === 'è¥ä¸šä¸­' ? 'æš‚åœè¥ä¸š' : 'è¥ä¸šä¸­';
        sendCommandToAI(`è®¾ç½®å¦“é™¢è¥ä¸šçŠ¶æ€ä¸º${newStatus}`);
      }

      // ==================== è§’è‰²åˆæˆåŠŸèƒ½ ====================
      function openSynthesis() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'synthesis-modal';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 900px">
            <button class="modal-close" onclick="closeSynthesis()">Ã—</button>
            <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">ğŸ”¬ è§’è‰²åˆæˆ</h2>

            <div style="margin-bottom: 24px; padding: 16px; background: rgba(30, 41, 59, 0.6); border-radius: 12px">
              <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">åˆæˆè§„åˆ™</h3>
              <ul style="line-height: 2; color: var(--text-secondary); font-size: 14px">
                <li>é€‰æ‹©2-5ä¸ªè§’è‰²è¿›è¡Œåˆæˆ</li>
                <li>åˆæˆåçš„è§’è‰²ç¨€æœ‰åº¦ä¼šæ ¹æ®ç´ æè§’è‰²æå‡</li>
                <li>æ–°è§’è‰²çš„å±æ€§ä¼šèåˆç´ æè§’è‰²çš„ç‰¹å¾</li>
                <li>åˆæˆåç´ æè§’è‰²å°†è¢«æ¶ˆè€—</li>
                <li>ç¨€æœ‰åº¦æå‡è§„åˆ™ï¼šN+Nâ†’R, R+Râ†’SR, SR+SRâ†’SSR, SSR+SSRâ†’SSR+</li>
              </ul>
            </div>

            <div style="margin-bottom: 24px">
              <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å·²é€‰æ‹©è§’è‰² (<span id="selected-count">0</span>/5)</h3>
              <div id="selected-characters" style="display: flex; flex-wrap: wrap; gap: 12px; min-height: 80px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; border: 2px dashed rgba(139, 92, 246, 0.3)">
                <div style="width: 100%; text-align: center; color: var(--text-secondary); padding: 20px">ä»ä¸‹æ–¹é€‰æ‹©è§’è‰²è¿›è¡Œåˆæˆ</div>
              </div>
            </div>

            <div style="margin-bottom: 24px">
              <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å¯é€‰è§’è‰²</h3>
              <div id="synthesis-character-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px"></div>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end">
              <button class="btn btn-secondary" onclick="closeSynthesis()">å–æ¶ˆ</button>
              <button class="btn" id="btn-synthesize" onclick="confirmSynthesis()" disabled>å¼€å§‹åˆæˆ</button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
        modal.classList.add('active');

        // åˆå§‹åŒ–åˆæˆç•Œé¢
        if (!window.selectedSynthesisChars) {
          window.selectedSynthesisChars = [];
        }
        refreshSynthesisPage();
      }

      function closeSynthesis() {
        const modal = document.getElementById('synthesis-modal');
        if (modal) {
          modal.classList.remove('active');
          setTimeout(() => modal.remove(), 300);
        }
        if (window.selectedSynthesisChars) {
          window.selectedSynthesisChars = [];
        }
      }

      function refreshSynthesisPage() {
        const charList = document.getElementById('synthesis-character-list');
        if (!charList) {
          console.warn('synthesis-character-list å…ƒç´ ä¸å­˜åœ¨');
          return;
        }

        charList.innerHTML = '';

        // æ£€æŸ¥è§’è‰²ä»“åº“æ˜¯å¦å­˜åœ¨
        if (!gameState.è§’è‰²ä»“åº“ || typeof gameState.è§’è‰²ä»“åº“ !== 'object') {
          console.warn('è§’è‰²ä»“åº“ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯:', gameState.è§’è‰²ä»“åº“);
          charList.innerHTML =
            '<div style="text-align: center; color: var(--text-secondary); padding: 40px">è§’è‰²ä»“åº“æ•°æ®å¼‚å¸¸</div>';
          return;
        }

        const availableChars = Object.entries(gameState.è§’è‰²ä»“åº“)
          .filter(([id, char]) => {
            // æ”¾å®½è¿‡æ»¤æ¡ä»¶ï¼Œåªè¦æœ‰çŠ¶æ€å’Œä½ç½®å­—æ®µå°±æ˜¾ç¤º
            const hasStatus = char && (char.çŠ¶æ€ === 'ç©ºé—²' || !char.çŠ¶æ€);
            const hasLocation = char && (char.å½“å‰ä½ç½® === 'ä»“åº“' || !char.å½“å‰ä½ç½®);
            return hasStatus && hasLocation;
          })
          .map(([id, char]) => ({ id, ...char }));

        console.info('å¯åˆæˆè§’è‰²æ•°é‡:', availableChars.length, 'æ€»è§’è‰²æ•°:', Object.keys(gameState.è§’è‰²ä»“åº“).length);

        if (availableChars.length === 0) {
          charList.innerHTML =
            '<div style="text-align: center; color: var(--text-secondary); padding: 40px">æ²¡æœ‰å¯åˆæˆçš„è§’è‰²ï¼ˆéœ€è¦çŠ¶æ€ä¸º"ç©ºé—²"ä¸”ä½ç½®ä¸º"ä»“åº“"çš„è§’è‰²ï¼‰</div>';
          return;
        }

        availableChars.forEach(({ id, ...char }) => {
          const isSelected = window.selectedSynthesisChars && window.selectedSynthesisChars.includes(id);
          const card = document.createElement('div');
          card.className = `character-list-item rarity-${char.ç¨€æœ‰åº¦}`;
          card.style.cssText = `
            padding: 12px;
            cursor: pointer;
            border: 2px solid ${isSelected ? 'var(--primary)' : 'rgba(139, 92, 246, 0.3)'};
            background: ${isSelected ? 'rgba(139, 92, 246, 0.2)' : 'rgba(30, 41, 59, 0.6)'};
            opacity: ${isSelected ? '1' : '0.8'};
          `;
          card.innerHTML = `
            <div style="font-size: 16px; font-weight: bold; margin-bottom: 4px">${char.å§“å}</div>
            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px">${char.ç¨€æœ‰åº¦} Â· ${char.èŒä¸šèº«ä»½ || 'æ— '}</div>
            <div style="font-size: 11px; color: var(--text-secondary)">
              é­…åŠ›: ${char.å±æ€§?.é­…åŠ› || 0} | é¡ºä»: ${char.å±æ€§?.é¡ºä» || 0}
            </div>
            ${isSelected ? '<div style="margin-top: 8px; font-size: 12px; color: var(--primary)">âœ“ å·²é€‰æ‹©</div>' : ''}
          `;
          card.onclick = () => toggleSynthesisCharacter(id);
          charList.appendChild(card);
        });

        updateSynthesisSelection();
      }

      function toggleSynthesisCharacter(characterId) {
        if (!window.selectedSynthesisChars) {
          window.selectedSynthesisChars = [];
        }
        const index = window.selectedSynthesisChars.indexOf(characterId);
        if (index > -1) {
          window.selectedSynthesisChars.splice(index, 1);
        } else {
          if (window.selectedSynthesisChars.length >= 5) {
            alert('æœ€å¤šåªèƒ½é€‰æ‹©5ä¸ªè§’è‰²ï¼');
            return;
          }
          window.selectedSynthesisChars.push(characterId);
        }
        refreshSynthesisPage();
      }

      function updateSynthesisSelection() {
        const selectedContainer = document.getElementById('selected-characters');
        const countSpan = document.getElementById('selected-count');
        const btnSynthesize = document.getElementById('btn-synthesize');

        if (countSpan) {
          countSpan.textContent = window.selectedSynthesisChars ? window.selectedSynthesisChars.length : 0;
        }

        if (btnSynthesize) {
          btnSynthesize.disabled = !window.selectedSynthesisChars || window.selectedSynthesisChars.length < 2;
        }

        if (selectedContainer) {
          if (!window.selectedSynthesisChars || window.selectedSynthesisChars.length === 0) {
            selectedContainer.innerHTML =
              '<div style="width: 100%; text-align: center; color: var(--text-secondary); padding: 20px">ä»ä¸‹æ–¹é€‰æ‹©è§’è‰²è¿›è¡Œåˆæˆ</div>';
          } else {
            selectedContainer.innerHTML = window.selectedSynthesisChars
              .map(id => {
                const char = gameState.è§’è‰²ä»“åº“[id];
                if (!char) return '';
                return `
                  <div style="padding: 12px; background: rgba(139, 92, 246, 0.2); border-radius: 8px; border: 1px solid var(--primary); position: relative">
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 4px">${char.å§“å}</div>
                    <div style="font-size: 11px; color: var(--text-secondary)">${char.ç¨€æœ‰åº¦}</div>
                    <button onclick="toggleSynthesisCharacter('${id}'); event.stopPropagation();" style="position: absolute; top: 4px; right: 4px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; line-height: 1">Ã—</button>
                  </div>
                `;
              })
              .join('');
          }
        }
      }

      async function confirmSynthesis() {
        if (!window.selectedSynthesisChars || window.selectedSynthesisChars.length < 2) {
          alert('è‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªè§’è‰²ï¼');
          return;
        }

        if (window.selectedSynthesisChars.length > 5) {
          alert('æœ€å¤šåªèƒ½é€‰æ‹©5ä¸ªè§’è‰²ï¼');
          return;
        }

        const charNames = window.selectedSynthesisChars
          .map(id => {
            const char = gameState.è§’è‰²ä»“åº“[id];
            return char ? `${id}ï¼ˆ${char.å§“å}ï¼‰` : id;
          })
          .join('ã€');

        if (!confirm(`ç¡®å®šè¦åˆæˆä»¥ä¸‹è§’è‰²å—ï¼Ÿ\n\n${charNames}\n\nåˆæˆåè¿™äº›è§’è‰²å°†è¢«æ¶ˆè€—ã€‚`)) {
          return;
        }

        const command = `åˆæˆè§’è‰²ã€‚å°†ä»¥ä¸‹è§’è‰²è¿›è¡Œåˆæˆï¼š${window.selectedSynthesisChars.join('ã€')}ã€‚

è¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
1. æ ¹æ®ç´ æè§’è‰²çš„ç¨€æœ‰åº¦è®¡ç®—æ–°è§’è‰²çš„ç¨€æœ‰åº¦ï¼ˆN+Nâ†’R, R+Râ†’SR, SR+SRâ†’SSR, SSR+SSRâ†’SSR+ï¼‰
2. èåˆç´ æè§’è‰²çš„ç‰¹å¾ï¼ˆå§“åã€èŒä¸šã€å¤–è²Œã€æ€§æ ¼ã€èƒŒæ™¯æ•…äº‹ç­‰ï¼‰
3. èåˆç´ æè§’è‰²çš„å±æ€§ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦å–å¹³å‡å€¼æˆ–æ ¹æ®ç¨€æœ‰åº¦æå‡ï¼‰
4. ç”Ÿæˆæ–°è§’è‰²çš„å®Œæ•´èµ„æ–™ï¼ˆåŒ…æ‹¬ç»˜å›¾æ ‡ç­¾å’Œè‡ªå®šä¹‰å‰ç«¯HTMLï¼‰
5. åœ¨è§’è‰²ä»“åº“ä¸­æ·»åŠ æ–°è§’è‰²
6. ä»è§’è‰²ä»“åº“ä¸­ç§»é™¤æ‰€æœ‰ç´ æè§’è‰²
7. åœ¨åˆæˆè®°å½•ä¸­æ·»åŠ è®°å½•

é‡è¦è¦æ±‚ï¼š
- æ–°è§’è‰²å¿…é¡»å…·æœ‰ç‹¬ç‰¹æ€§å’ŒåŸåˆ›æ€§
- å¿…é¡»ç”Ÿæˆå®Œæ•´çš„è§’è‰²èµ„æ–™ï¼ˆåŒ…æ‹¬ç»˜å›¾æ ‡ç­¾å’Œè‡ªå®šä¹‰å‰ç«¯HTMLï¼‰
- å¿…é¡»ä½¿ç”¨JSONPatchæ ¼å¼æ›´æ–°æ¸¸æˆçŠ¶æ€
- æ–°è§’è‰²çš„ç¨€æœ‰åº¦å¿…é¡»é«˜äºæˆ–ç­‰äºç´ æè§’è‰²çš„æœ€é«˜ç¨€æœ‰åº¦`;

        closeSynthesis();

        try {
          await sendCommandToAI(command);
          alert('åˆæˆæŒ‡ä»¤å·²å‘é€ï¼Œè¯·ç­‰å¾…AIç”Ÿæˆæ–°è§’è‰²...');
        } catch (error) {
          console.error('å‘é€åˆæˆæŒ‡ä»¤å¤±è´¥:', error);
          alert('å‘é€åˆæˆæŒ‡ä»¤å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
        }
      }

      function openDecompose() {
        alert('åˆ†è§£åŠŸèƒ½å¼€å‘ä¸­...');
      }

      function openSettings() {
        alert('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...');
      }

      function openGallery() {
        switchPage('units');
      }

      // ==================== è¾…åŠ©å‡½æ•° ====================
      function refreshAllPages() {
        refreshHomePage();
        refreshSummonPage();
        refreshUnitsPage();
        refreshBrothelPage();
      }

      // ==================== åˆå§‹åŒ– ====================
      const init = async () => {
        try {
          await loadGameStateFromMVU();
          setupEventListeners();
          refreshAllPages();

          setInterval(() => {
            saveGameStateToMVU();
          }, 5000);
        } catch (error) {
          console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        }
      };

      if (typeof $ !== 'undefined') {
        $(init);
      } else if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    </script>
  </body>
</html>
