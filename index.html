<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>é»‘æš—å¹»æƒ³æŠ½å¡ç»è¥æ¸¸æˆ</title><script src="https://cdn.tailwindcss.com"></script><style>:root{--primary:#8b5cf6;--primary-dark:#6d28d9;--secondary:#ec4899;--accent:#f59e0b;--accent-gold:#fbbf24;--bg-dark:#0f172a;--bg-card:#1e293b;--bg-hover:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--border:#334155;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--rarity-n:#9ca3af;--rarity-r:#4ade80;--rarity-sr:#60a5fa;--rarity-ssr:#f59e0b}*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Microsoft YaHei',SimHei,sans-serif;background:linear-gradient(135deg,#0f172a 0,#1e1b4b 50%,#312e81 100%);background-attachment:fixed;color:var(--text-primary);min-height:100vh;padding-bottom:80px;line-height:1.6}.card{background:rgba(30,41,59,.8);backdrop-filter:blur(20px);border:1px solid rgba(139,92,246,.2);border-radius:16px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,.3);transition:all .3s cubic-bezier(.4, 0, .2, 1)}.card:hover{border-color:rgba(139,92,246,.4);box-shadow:0 12px 40px rgba(139,92,246,.2);transform:translateY(-2px)}.btn{background:linear-gradient(135deg,var(--primary) 0,var(--secondary) 100%);border:none;color:#fff;padding:12px 24px;border-radius:12px;cursor:pointer;font-weight:600;font-size:14px;transition:all .3s cubic-bezier(.4, 0, .2, 1);box-shadow:0 4px 12px rgba(139,92,246,.3);position:relative;overflow:hidden}.btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,.2);transform:translate(-50%,-50%);transition:width .6s,height .6s}.btn:hover::before{width:300px;height:300px}.btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(139,92,246,.4)}.btn:active{transform:translateY(0)}.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}.btn-secondary{background:rgba(51,65,85,.8);box-shadow:0 4px 12px rgba(0,0,0,.2)}.btn-secondary:hover{background:rgba(71,85,105,.8);box-shadow:0 6px 20px rgba(0,0,0,.3)}.rarity-N{border-color:var(--rarity-n);color:var(--rarity-n);box-shadow:0 0 10px rgba(156,163,175,.3)}.rarity-R{border-color:var(--rarity-r);color:var(--rarity-r);box-shadow:0 0 15px rgba(74,222,128,.4)}.rarity-SR{border-color:var(--rarity-sr);color:var(--rarity-sr);box-shadow:0 0 20px rgba(96,165,250,.5)}.rarity-SSR{border-color:var(--rarity-ssr);color:var(--rarity-ssr);box-shadow:0 0 30px rgba(245,158,11,.7);animation:ssrGlow 2s ease-in-out infinite}@keyframes ssrGlow{0%,100%{box-shadow:0 0 30px rgba(245,158,11,.7)}50%{box-shadow:0 0 50px #f59e0b}}.character-card{position:relative;border:2px solid;border-radius:16px;overflow:visible;transition:all .4s cubic-bezier(.4, 0, .2, 1);background:rgba(30,41,59,.6);backdrop-filter:blur(10px);padding:12px}.character-card:hover{transform:translateY(-8px) scale(1.02);box-shadow:0 20px 40px rgba(0,0,0,.4)}.character-avatar{width:100%;aspect-ratio:1;position:relative;overflow:hidden;background:linear-gradient(135deg,var(--primary) 0,var(--secondary) 100%);border-radius:12px;margin-bottom:12px;cursor:pointer}.character-avatar img{width:100%;height:100%;object-fit:cover;display:block}.character-image-container{width:100%;height:100%;position:relative}.character-info{text-align:center}.character-name{font-weight:700;font-size:15px;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.character-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;justify-content:center}.character-action-btn{padding:6px 12px;font-size:12px;border-radius:8px;border:1px solid rgba(139,92,246,.3);background:rgba(139,92,246,.1);color:var(--primary);cursor:pointer;transition:all .3s}.character-action-btn:hover{background:rgba(139,92,246,.2);transform:translateY(-2px)}.page{display:none;padding:20px;max-width:1400px;margin:0 auto;animation:fadeIn .4s ease-out}.page.active{display:block}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(15,23,42,.95);backdrop-filter:blur(20px);border-top:1px solid rgba(139,92,246,.2);display:flex;justify-content:space-around;padding:12px 0;z-index:1000;box-shadow:0 -4px 20px rgba(0,0,0,.3)}.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 20px;cursor:pointer;color:var(--text-secondary);transition:all .3s;border-radius:12px;min-width:70px}.nav-item.active{color:var(--primary);background:rgba(139,92,246,.15);transform:translateY(-2px)}.nav-item:hover{color:var(--primary);background:rgba(139,92,246,.1)}.nav-item .icon{font-size:24px}.nav-item .label{font-size:11px;font-weight:500}.character-grid{display:flex;flex-direction:column;gap:12px;padding:20px 0}.character-list-item{display:flex;align-items:center;gap:16px;padding:16px;background:rgba(30,41,59,.6);border:2px solid;border-radius:12px;transition:all .3s}#character-card-display{max-width:100%;overflow-x:auto;box-sizing:border-box}#character-card-display>div{max-width:100%;box-sizing:border-box;overflow-x:auto}#character-card-display *{max-width:100%;word-wrap:break-word;overflow-wrap:break-word;box-sizing:border-box}#character-card-display>div>*{max-width:100%!important;box-sizing:border-box!important}#character-detail-content{max-width:100%;overflow-x:auto}#character-detail-content>*{max-width:100%;box-sizing:border-box}#character-detail-content *{max-width:100%;word-wrap:break-word;overflow-wrap:break-word}.character-list-item:hover{background:rgba(30,41,59,.8);transform:translateX(4px)}.character-list-image{width:80px;height:80px;min-width:80px;border-radius:8px;overflow:hidden;background:linear-gradient(135deg,var(--primary) 0,var(--secondary) 100%);display:flex;align-items:center;justify-content:center}.character-list-image img{width:100%;height:100%;object-fit:cover}.character-list-info{flex:1;min-width:0}.character-list-name{font-size:18px;font-weight:700;color:var(--primary);margin-bottom:4px}.character-list-meta{font-size:12px;color:var(--text-secondary);margin-bottom:8px}.character-list-stats{display:flex;gap:12px;flex-wrap:wrap}.character-list-stat-item{display:flex;align-items:center;gap:4px;font-size:11px}.character-list-stat-bar{width:60px;height:4px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden}.character-list-stat-fill{height:100%;background:linear-gradient(90deg,var(--primary) 0,var(--secondary) 100%);transition:width .3s}.character-list-actions{display:flex;gap:8px;flex-shrink:0}.room-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px;padding:20px 0}.room-card{border:2px solid var(--border);border-radius:16px;padding:20px;background:rgba(30,41,59,.6);cursor:pointer;transition:all .3s;backdrop-filter:blur(10px)}.room-card.occupied{border-color:var(--primary);background:rgba(139,92,246,.2)}.room-card:hover{transform:scale(1.05);box-shadow:0 0 25px rgba(139,92,246,.5)}.story-container{background:rgba(15,23,42,.8);border:1px solid rgba(139,92,246,.3);border-radius:16px;padding:24px;margin:20px 0;min-height:300px;max-height:600px;overflow-y:auto;backdrop-filter:blur(10px);box-shadow:inset 0 2px 10px rgba(0,0,0,.3)}.story-content{line-height:2;font-size:15px;color:var(--text-primary);white-space:pre-wrap;word-wrap:break-word}.story-content img{max-width:100%;height:auto;border-radius:12px;margin:15px 0;box-shadow:0 5px 15px rgba(0,0,0,.5)}.story-placeholder{text-align:center;color:var(--text-secondary);font-style:italic;padding:60px 20px;font-size:16px}.story-loading{text-align:center;color:var(--primary);padding:60px 20px;font-size:18px}.log-container{max-height:400px;overflow-y:auto;padding:16px;background:rgba(15,23,42,.6);border-radius:12px;margin-top:20px;border:1px solid rgba(139,92,246,.2)}.log-entry{padding:12px;margin-bottom:12px;border-left:3px solid var(--primary);background:rgba(139,92,246,.1);border-radius:8px;font-size:14px;line-height:1.6;transition:all .3s}.log-entry:hover{background:rgba(139,92,246,.2);transform:translateX(5px)}.stat-bar{height:8px;background:rgba(51,65,85,.5);border-radius:4px;overflow:hidden;margin:6px 0;position:relative}.stat-fill{height:100%;background:linear-gradient(90deg,var(--primary) 0,var(--secondary) 100%);transition:width .6s ease-out;border-radius:4px;box-shadow:0 0 10px rgba(139,92,246,.5)}.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);z-index:2000;overflow-y:auto;padding:20px;backdrop-filter:blur(5px);-webkit-overflow-scrolling:touch}.modal.active{display:block;animation:fadeIn .3s}.modal-content{background:rgba(30,41,59,.98);border:1px solid rgba(139,92,246,.3);border-radius:20px;padding:32px;max-width:900px;width:100%;margin:20px auto;position:relative;box-shadow:0 20px 60px rgba(0,0,0,.8);backdrop-filter:blur(20px);min-height:calc(100vh - 40px)}.modal-close{position:absolute;top:16px;right:16px;background:rgba(139,92,246,.1);border:1px solid rgba(139,92,246,.3);color:var(--primary);width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;transition:all .3s}.modal-close:hover{background:rgba(139,92,246,.2);transform:rotate(90deg)}.page-title{font-size:32px;color:var(--primary);text-align:center;margin-bottom:30px;text-shadow:0 0 10px rgba(139,92,246,.5);font-weight:700;letter-spacing:2px}.section-title{font-size:20px;color:var(--primary);margin:24px 0 16px 0;font-weight:600;text-shadow:0 0 5px rgba(139,92,246,.3)}@media (max-width:768px){.character-list-item{flex-direction:column;align-items:stretch}.character-list-image{width:100%;height:200px;min-width:100%}.character-list-actions{width:100%;flex-direction:column}.character-list-actions .btn{width:100%}.room-grid{grid-template-columns:1fr}.page{padding:10px}.modal-content{padding:20px;margin:10px}}::-webkit-scrollbar{width:10px}::-webkit-scrollbar-track{background:rgba(15,23,42,.5);border-radius:5px}::-webkit-scrollbar-thumb{background:var(--primary);border-radius:5px}::-webkit-scrollbar-thumb:hover{background:var(--primary-dark)}</style><script type="module">$(()=>{console.info('æŠ½å¡ç»è¥æ¸¸æˆç•Œé¢å·²åŠ è½½')});
//# sourceMappingURL=index.js.map</script></head><body><div id="app"><div id="page-home" class="page active"><div class="card"><h1 class="page-title">ğŸ° é»‘æš—å¹»æƒ³ç»è¥æ¸¸æˆ</h1><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-top:30px"><div class="card" style="text-align:center;padding:20px"><div style="font-size:36px;margin-bottom:12px">ğŸ’°</div><div style="font-size:28px;font-weight:700;color:var(--accent-gold)" id="home-currency">1000</div><div style="font-size:14px;color:var(--text-secondary);margin-top:8px">è´§å¸</div></div><div class="card" style="text-align:center;padding:20px"><div style="font-size:36px;margin-bottom:12px">ğŸ‘¥</div><div style="font-size:28px;font-weight:700;color:var(--primary)" id="home-characters">0</div><div style="font-size:14px;color:var(--text-secondary);margin-top:8px">è§’è‰²æ•°é‡</div></div><div class="card" style="text-align:center;padding:20px"><div style="font-size:36px;margin-bottom:12px">ğŸ“Š</div><div style="font-size:28px;font-weight:700;color:var(--accent-gold)" id="home-income">0</div><div style="font-size:14px;color:var(--text-secondary);margin-top:8px">ä»Šæ—¥æ”¶å…¥</div></div></div><div style="margin-top:30px"><h2 class="section-title">å¿«æ·æ“ä½œ</h2><div style="display:flex;gap:16px;flex-wrap:wrap"><button class="btn" onclick='switchPage("summon")'>ğŸ´ ç«‹å³æŠ½å¡</button> <button class="btn" onclick='switchPage("units")'>ğŸ“¦ æŸ¥çœ‹ä»“åº“</button> <button class="btn" onclick='switchPage("brothel")'>ğŸ›ï¸ ç»è¥å¦“é™¢</button></div></div></div></div><div id="page-summon" class="page"><div class="card"><h1 class="page-title">ğŸ´ å¬å”¤ä»ªå¼</h1><div style="text-align:center;margin-bottom:40px"><div style="font-size:56px;margin-bottom:16px">ğŸ’°</div><div style="font-size:40px;font-weight:700;color:var(--accent-gold)" id="summon-currency">1000</div><div style="font-size:16px;color:var(--text-secondary);margin-top:8px">å½“å‰è´§å¸</div></div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:40px"><button class="btn" onclick='handleSummon("å•æŠ½")' id="btn-single" style="padding:24px"><div style="font-size:32px;margin-bottom:12px">âœ¨</div><div style="font-size:18px;margin-bottom:8px">å•æŠ½</div><div style="font-size:14px;opacity:.8">100 é‡‘</div></button> <button class="btn" onclick='handleSummon("é—ªå…‰æŠ½å¡")' id="btn-flash" style="padding:24px"><div style="font-size:32px;margin-bottom:12px">ğŸ’«</div><div style="font-size:18px;margin-bottom:8px">é—ªå…‰æŠ½å¡</div><div style="font-size:14px;opacity:.8">500 é‡‘ (SSR)</div></button> <button class="btn" onclick="showTargetSummonInput()" id="btn-target" style="padding:24px"><div style="font-size:32px;margin-bottom:12px">ğŸ¯</div><div style="font-size:18px;margin-bottom:8px">å®šå‘æŠ½å¡</div><div style="font-size:14px;opacity:.8">300 é‡‘</div></button></div><div id="summon-results" style="min-height:200px"></div><div id="character-card-display" style="display:none;margin-top:30px"></div></div></div><div id="page-units" class="page"><div><h1 class="page-title">ğŸ“¦ è§’è‰²ä»“åº“</h1><div class="card" style="margin-bottom:24px;display:flex;gap:16px;flex-wrap:wrap"><input id="search-input" placeholder="æœç´¢è§’è‰²..." style="flex:1;min-width:200px;padding:12px;background:rgba(15,23,42,.5);border:1px solid rgba(139,92,246,.3);border-radius:12px;color:var(--text-primary);font-size:14px"/> <select id="filter-rarity" style="padding:12px;background:rgba(15,23,42,.5);border:1px solid rgba(139,92,246,.3);border-radius:12px;color:var(--text-primary);font-size:14px;min-width:150px"><option value="">å…¨éƒ¨ç¨€æœ‰åº¦</option><option value="N">N</option><option value="R">R</option><option value="SR">SR</option><option value="SSR">SSR</option></select></div><div id="character-list" class="character-grid"></div></div><div id="character-detail-modal" class="modal"><div class="modal-content"><button class="modal-close" onclick="closeCharacterDetail()">Ã—</button><div id="character-detail-content"></div></div></div></div><div id="page-brothel" class="page"><div><h1 class="page-title">ğŸ›ï¸ å¦“é™¢ç»è¥</h1><div class="card" style="margin-bottom:24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px"><div><div style="font-size:14px;color:var(--text-secondary);margin-bottom:4px">è¥ä¸šçŠ¶æ€</div><div style="font-size:24px;font-weight:700;color:var(--primary)" id="brothel-status">è¥ä¸šä¸­</div></div><div><div style="font-size:14px;color:var(--text-secondary);margin-bottom:4px">ä»Šæ—¥æ”¶å…¥</div><div style="font-size:24px;font-weight:700;color:var(--accent-gold)" id="brothel-income">0</div></div><button class="btn" onclick="toggleBrothelStatus()" id="btn-toggle-status">æš‚åœè¥ä¸š</button></div><h2 class="section-title">æˆ¿é—´ç®¡ç†</h2><div id="room-list" class="room-grid"></div><h2 class="section-title">ç©ºé—²è§’è‰²</h2><div id="available-characters" class="character-grid"></div><h2 class="section-title">å½“å‰äº’åŠ¨å‰§æƒ…</h2><div id="brothel-story" class="story-container"><div id="brothel-story-content" class="story-content"><div class="story-placeholder">ç‚¹å‡»æˆ¿é—´æˆ–è§’è‰²å¼€å§‹äº’åŠ¨ï¼ŒAI ç”Ÿæˆçš„å‰§æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div></div></div><h2 class="section-title">äº‹ä»¶æ—¥å¿—</h2><div id="brothel-logs" class="log-container"></div></div></div><div id="page-more" class="page"><div><h1 class="page-title">âš™ï¸ æ›´å¤šåŠŸèƒ½</h1><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px"><div class="card" style="cursor:pointer;text-align:center" onclick="openSynthesis()"><div style="font-size:48px;margin-bottom:16px">ğŸ”¬</div><h3 style="font-size:20px;color:var(--primary);margin-bottom:8px">è§’è‰²åˆæˆ</h3><p style="font-size:14px;color:var(--text-secondary)">åˆæˆè§’è‰²æå‡ç¨€æœ‰åº¦</p></div><div class="card" style="cursor:pointer;text-align:center" onclick="openDecompose()"><div style="font-size:48px;margin-bottom:16px">âš¡</div><h3 style="font-size:20px;color:var(--primary);margin-bottom:8px">è§’è‰²åˆ†è§£</h3><p style="font-size:14px;color:var(--text-secondary)">åˆ†è§£è§’è‰²è·å¾—èµ„æº</p></div><div class="card" style="cursor:pointer;text-align:center" onclick="openSettings()"><div style="font-size:48px;margin-bottom:16px">âš™ï¸</div><h3 style="font-size:20px;color:var(--primary);margin-bottom:8px">æ¸¸æˆè®¾ç½®</h3><p style="font-size:14px;color:var(--text-secondary)">è°ƒæ•´æ¸¸æˆå‚æ•°</p></div><div class="card" style="cursor:pointer;text-align:center" onclick="openGallery()"><div style="font-size:48px;margin-bottom:16px">ğŸ“š</div><h3 style="font-size:20px;color:var(--primary);margin-bottom:8px">è§’è‰²å›¾é‰´</h3><p style="font-size:14px;color:var(--text-secondary)">æŸ¥çœ‹æ‰€æœ‰è§’è‰²</p></div></div></div></div></div><div class="bottom-nav"><div class="nav-item active" onclick='switchPage("home")'><div class="icon">ğŸ </div><div class="label">é¦–é¡µ</div></div><div class="nav-item" onclick='switchPage("summon")'><div class="icon">ğŸ´</div><div class="label">æŠ½å¡</div></div><div class="nav-item" onclick='switchPage("units")'><div class="icon">ğŸ‘¥</div><div class="label">è§’è‰²</div></div><div class="nav-item" onclick='switchPage("brothel")'><div class="icon">ğŸ›ï¸</div><div class="label">ç»è¥</div></div><div class="nav-item" onclick='switchPage("more")'><div class="icon">âš™ï¸</div><div class="label">æ›´å¤š</div></div></div><script>let gameState={"è´§å¸":1e3,"æŠ½å¡è®°å½•":{},"è§’è‰²ä»“åº“":{},"å¦“é™¢":{"è¥ä¸šçŠ¶æ€":"è¥ä¸šä¸­","å½“å‰æ¥å®¢è§’è‰²":{},"ç­‰å¾…é˜Ÿåˆ—":[],"æˆ¿é—´çŠ¶æ€":{101:{"ç±»å‹":"æ™®é€š","çŠ¶æ€":"ç©ºé—²","è£…é¥°ä¸»é¢˜":"æ ‡å‡†"},102:{"ç±»å‹":"æ™®é€š","çŠ¶æ€":"ç©ºé—²","è£…é¥°ä¸»é¢˜":"æ ‡å‡†"},VIP1:{"ç±»å‹":"VIP","çŠ¶æ€":"ç©ºé—²","è£…é¥°ä¸»é¢˜":"è±ªå"}},"ä»Šæ—¥æ”¶å…¥":0,"å†å²æ€»æ”¶å…¥":0,"äº‹ä»¶æ—¥å¿—":[]},"åˆæˆè®°å½•":{},"åˆ†è§£è®°å½•":{},"è®¾ç½®":{"è‡ªåŠ¨è¥ä¸š":!1,"è‡ªåŠ¨è°ƒæ•™":!1,"å±é™©å†…å®¹è¿‡æ»¤":!1,"è¯­è¨€":"ä¸­æ–‡","åŠ¨ç”»æ•ˆæœ":!0,"æ”¶ç›Šå€ç‡":1,"ç»éªŒå€ç‡":1,"æœ€å¤§è§’è‰²æ•°é‡":100,"è‡ªåŠ¨æ¸…ç†æ—§è§’è‰²":!1,"æ¸…ç†é˜ˆå€¼":20},"ç»Ÿè®¡æ•°æ®":{"æ€»æŠ½å¡æ¬¡æ•°":0,"æ€»è·å¾—è§’è‰²":0,"æ€»æ¥å®¢æ¬¡æ•°":0,"æ€»æ”¶å…¥":0,"æ¸¸æˆæ—¶é—´":0,"è§’è‰²åˆ†å¸ƒ":{N:0,R:0,SR:0,SSR:0},"æƒ…æ„Ÿåˆ†å¸ƒ":{"çˆ±":0,"å–œæ¬¢":0,"ä¸­ç«‹":0,"åŒæ¶":0,"æ†æ¨":0}},"æ¸¸æˆæ—¶é—´":{"å½“å‰æ—¶é—´æˆ³":Date.now(),"ä¸Šæ¬¡æ›´æ–°æ—¶é—´":Date.now(),"æ¸¸æˆå¼€å§‹æ—¶é—´":Date.now(),"ä¸‹æ¬¡ç»“ç®—æ—¶é—´":Date.now()+36e5,"ç»“ç®—é—´éš”":36e5}};function switchPage(e){document.querySelectorAll(".page").forEach(e=>{e.classList.remove("active")});const t=document.getElementById(`page-${e}`);t&&t.classList.add("active"),document.querySelectorAll(".nav-item").forEach((e,t)=>{e.classList.remove("active")});const n={home:0,summon:1,units:2,brothel:3,more:4},a=document.querySelectorAll(".nav-item");void 0!==n[e]&&a[n[e]]&&a[n[e]].classList.add("active"),refreshPageData(e)}function refreshPageData(e){switch(e){case"home":refreshHomePage();break;case"summon":refreshSummonPage();break;case"units":refreshUnitsPage();break;case"brothel":refreshBrothelPage()}}function refreshHomePage(){document.getElementById("home-currency").textContent=gameState.è´§å¸,document.getElementById("home-characters").textContent=Object.keys(gameState.è§’è‰²ä»“åº“).length,document.getElementById("home-income").textContent=gameState.å¦“é™¢.ä»Šæ—¥æ”¶å…¥}function refreshSummonPage(){document.getElementById("summon-currency").textContent=gameState.è´§å¸;const e={"å•æŠ½":100,"é—ªå…‰æŠ½å¡":500,"å®šå‘æŠ½å¡":300};Object.keys(e).forEach(t=>{const n="å•æŠ½"===t?"single":"é—ªå…‰æŠ½å¡"===t?"flash":"target",a=document.getElementById(`btn-${n}`);a&&(a.disabled=gameState.è´§å¸<e[t])})}function refreshUnitsPage(){const e=document.getElementById("character-list");if(e)try{const t=e.scrollTop;e.innerHTML="";const n=(document.getElementById("search-input")?.value||"").toLowerCase(),a=document.getElementById("filter-rarity")?.value||"";if(!gameState.è§’è‰²ä»“åº“||"object"!=typeof gameState.è§’è‰²ä»“åº“)return console.warn("è§’è‰²ä»“åº“ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯:",gameState.è§’è‰²ä»“åº“),void(e.innerHTML='<div style="text-align: center; padding: 40px; color: var(--text-secondary)">æš‚æ— è§’è‰²</div>');const o=Object.entries(gameState.è§’è‰²ä»“åº“);if(console.info(`åˆ·æ–°è§’è‰²ä»“åº“ï¼Œå…± ${o.length} ä¸ªè§’è‰²`),0===o.length)return void(e.innerHTML='<div style="text-align: center; padding: 40px; color: var(--text-secondary)">æš‚æ— è§’è‰²ï¼Œå»æŠ½å¡å§ï¼</div>');o.forEach(([t,o])=>{try{if(!o||"object"!=typeof o)return void console.warn(`è§’è‰² ${t} æ•°æ®æ ¼å¼é”™è¯¯:`,o);if(n&&(!o.å§“å||!o.å§“å.toLowerCase().includes(n)))return;if(a&&o.ç¨€æœ‰åº¦!==a)return;o.ç»˜å›¾æ ‡ç­¾&&console.info(`è§’è‰² ${o.å§“å} çš„ç»˜å›¾æ ‡ç­¾:`,o.ç»˜å›¾æ ‡ç­¾.substring(0,100));const i=createCharacterCard(t,o);i?e.appendChild(i):console.error(`åˆ›å»ºè§’è‰²å¡ç‰‡å¤±è´¥: ${t}`)}catch(e){console.error(`å¤„ç†è§’è‰² ${t} æ—¶å‡ºé”™:`,e)}}),e.scrollTop=t}catch(t){console.error("åˆ·æ–°è§’è‰²ä»“åº“é¡µé¢å¤±è´¥:",t),e.innerHTML='<div style="text-align: center; padding: 40px; color: var(--danger)">åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</div>'}else console.error("è§’è‰²åˆ—è¡¨å®¹å™¨ä¸å­˜åœ¨")}function refreshBrothelPage(){if(!document.getElementById("brothel-status"))return;document.getElementById("brothel-status").textContent=gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€,document.getElementById("brothel-income").textContent=gameState.å¦“é™¢.ä»Šæ—¥æ”¶å…¥,document.getElementById("btn-toggle-status").textContent="è¥ä¸šä¸­"===gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€?"æš‚åœè¥ä¸š":"å¼€å§‹è¥ä¸š";const e=document.getElementById("room-list");e&&(e.innerHTML="",Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).filter(([e,t])=>"è°ƒæ•™å®¤"!==t.ç±»å‹).forEach(([t,n])=>{const a=createRoomCard(t,n);e.appendChild(a)}));const t=document.getElementById("available-characters");t&&(t.innerHTML="",Object.entries(gameState.è§’è‰²ä»“åº“).forEach(([e,n])=>{if("ç©ºé—²"===n.çŠ¶æ€&&"ä»“åº“"===n.å½“å‰ä½ç½®){const a=createCharacterCard(e,n,!0);t.appendChild(a)}}));const n=document.getElementById("brothel-logs");n&&(n.innerHTML="",gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—.slice(-20).reverse().forEach(e=>{const t=document.createElement("div");t.className="log-entry",t.innerHTML=`\n            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">${new Date(e.æ—¶é—´æˆ³).toLocaleString()}</div>\n            <div><strong>${e.è§’è‰²ID}</strong>: ${e.æè¿°}</div>\n            ${e.æ”¶å…¥å˜åŒ–>0?`<div style="color: var(--accent-gold); margin-top: 4px">+${e.æ”¶å…¥å˜åŒ–} é‡‘</div>`:""}\n          `,n.appendChild(t)}))}function renderImageTag(e,t){if(!e)return!1;const n=e.match(/image###([\s\S]*?)###/);if(!n)return console.warn("å›¾ç‰‡æ ‡ç­¾æ ¼å¼ä¸æ­£ç¡®:",e.substring(0,50)),!1;try{if("undefined"!=typeof formatAsDisplayedMessage){const a=formatAsDisplayedMessage(e);return t.parentElement?("undefined"!=typeof $&&$(t).length?$(t).html(a):t.innerHTML=a,setTimeout(()=>{if(!t.parentElement)return void console.warn("å›¾ç‰‡å®¹å™¨åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è¢«ç§»é™¤");const e=t.querySelectorAll("img");if(e.length>0)e.forEach(e=>{e.style.width="100%",e.style.height="100%",e.style.objectFit="cover",e.style.display="block",e.style.borderRadius="0",e.onerror=()=>{const e=n[1];t.parentElement&&(t.innerHTML=`\n                        <div class="image-placeholder" onclick="event.stopPropagation(); copyImagePrompt('${e.replace(/'/g,"\\'")}')">\n                          <div style="font-size: 32px; margin-bottom: 8px">ğŸ–¼ï¸</div>\n                          <div style="font-size: 12px; text-align: center; padding: 0 8px">å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤</div>\n                        </div>\n                      `)},e.onload=()=>{console.info("è§’è‰²å›¾ç‰‡åŠ è½½æˆåŠŸ:",e.src.substring(0,100))}});else{if((t.textContent||t.innerText||"").includes("image###")){const e=n[1];t.parentElement&&(t.innerHTML=`\n                      <div class="image-placeholder" onclick="event.stopPropagation(); copyImagePrompt('${e.replace(/'/g,"\\'")}')">\n                        <div style="font-size: 32px; margin-bottom: 8px">ğŸ–¼ï¸</div>\n                        <div style="font-size: 12px; text-align: center; padding: 0 8px">å›¾ç‰‡æœªæ¸²æŸ“ï¼Œç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤</div>\n                      </div>\n                    `)}}},300),!0):(console.warn("å›¾ç‰‡å®¹å™¨ä¸åœ¨DOMä¸­ï¼Œè·³è¿‡æ¸²æŸ“"),!1)}{const e=n[1];return t.innerHTML=`\n              <div class="image-placeholder" onclick="event.stopPropagation(); copyImagePrompt('${e.replace(/'/g,"\\'")}')">\n                <div style="font-size: 32px; margin-bottom: 8px">ğŸ–¼ï¸</div>\n                <div style="font-size: 12px; text-align: center; padding: 0 8px">ç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤</div>\n              </div>\n            `,!1}}catch(e){console.error("æ¸²æŸ“å›¾ç‰‡å¤±è´¥:",e);const a=n?.[1]||"";return a&&t.parentElement&&(t.innerHTML=`\n              <div class="image-placeholder" onclick="event.stopPropagation(); copyImagePrompt('${a.replace(/'/g,"\\'")}')">\n                <div style="font-size: 32px; margin-bottom: 8px">ğŸ–¼ï¸</div>\n                <div style="font-size: 12px; text-align: center; padding: 0 8px">æ¸²æŸ“å¤±è´¥ï¼Œç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤</div>\n              </div>\n            `),!1}}function createCharacterCard(e,t,n=!1){const a=document.createElement("div");a.className=`character-list-item rarity-${t.ç¨€æœ‰åº¦}`;const o=document.createElement("div");o.className="character-list-info";const i=["é­…åŠ›","é¡ºä»","æŠ€å·§","è€åŠ›","æ•æ„Ÿåº¦"].map(e=>{const n=t.å±æ€§?.[e]||0;return`\n              <div class="character-list-stat-item">\n                <span>${e}:</span>\n                <div class="character-list-stat-bar">\n                  <div class="character-list-stat-fill" style="width: ${n}%"></div>\n                </div>\n                <span>${n}</span>\n              </div>\n            `}).join("");o.innerHTML=`\n          <div class="character-list-name">${t.å§“å||"æœªçŸ¥"}</div>\n          <div class="character-list-meta">${t.ç¨€æœ‰åº¦} Â· ${t.èŒä¸šèº«ä»½||"æ— "} Â· ${t.çŠ¶æ€||"ç©ºé—²"} Â· Lv.${t.ç­‰çº§||1}</div>\n          <div class="character-list-stats">${i}</div>\n          <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px; display: flex; gap: 12px">\n            <span>æ¥å®¢: ${t.æ¥å®¢æ¬¡æ•°||0}æ¬¡</span>\n            <span>è°ƒæ•™: ${t.è°ƒæ•™æ¬¡æ•°||0}æ¬¡</span>\n            <span style="color: var(--accent-gold)">è´¡çŒ®: ${t.æ”¶å…¥è´¡çŒ®||0}é‡‘</span>\n          </div>\n        `;const s=document.createElement("div");return s.className="character-list-actions",s.innerHTML=n?`\n            <button class="btn" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); selectCharacterForRoom('${e}')">åˆ†é…æˆ¿é—´</button>\n          `:`\n            <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); showCharacterDetail('${e}')">æŸ¥çœ‹è¯¦æƒ…</button>\n            <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); showTrainingInput('${e}')">è°ƒæ•™</button>\n            <button class="btn" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); assignCharacterToBrothel('${e}')">æ¥å®¢</button>\n          `,a.appendChild(o),a.appendChild(s),a}function createRoomCard(e,t){const n=document.createElement("div");n.className="room-card "+("ç©ºé—²"!==t.çŠ¶æ€?"occupied":"");const a=t.å½“å‰è§’è‰²?gameState.è§’è‰²ä»“åº“[t.å½“å‰è§’è‰²]:null,o=t.å½“å‰è§’è‰²?gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[t.å½“å‰è§’è‰²]:null;return n.innerHTML=`\n        <div style="font-size: 20px; font-weight: bold; margin-bottom: 12px">æˆ¿é—´ ${e}</div>\n        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 6px">ç±»å‹: ${t.ç±»å‹}</div>\n        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 6px">çŠ¶æ€: ${t.çŠ¶æ€}</div>\n        ${a?`<div style="font-size: 14px; color: var(--primary); margin-top: 12px">å½“å‰: ${a.å§“å}</div>`:""}\n        ${o?`<div style="font-size: 12px; color: var(--accent-gold); margin-top: 4px">æ”¶å…¥: ${o.åŸºç¡€æ”¶å…¥+o.é¢å¤–æ”¶å…¥} é‡‘</div>`:""}\n        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap">\n          ${"ç©ºé—²"===t.çŠ¶æ€?`<button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); showRoomAssignment('${e}')">åˆ†é…è§’è‰²</button>`:""}\n          ${"ç©ºé—²"!==t.çŠ¶æ€?`<button class="btn" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); showRoomDetail('${e}')">æŸ¥çœ‹å‰§æƒ…</button>`:""}\n        </div>\n      `,n}let pendingSummonCost=0;function showTargetSummonInput(){const e=document.createElement("div");e.className="modal",e.id="target-summon-modal",e.innerHTML='\n          <div class="modal-content" style="max-width: 600px">\n            <button class="modal-close" onclick="closeTargetSummonInput()">Ã—</button>\n            <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">ğŸ¯ å®šå‘æŠ½å¡</h2>\n\n            <div style="margin-bottom: 16px; padding: 16px; background: rgba(30, 41, 59, 0.6); border-radius: 12px">\n              <p style="font-size: 14px; color: var(--text-secondary); line-height: 1.8">\n                æè¿°ä½ æƒ³è¦çš„è§’è‰²ç‰¹å¾ï¼Œä¾‹å¦‚ï¼š<br>\n                â€¢ æ€§åˆ«ã€ç§æ—ã€èŒä¸šå€¾å‘<br>\n                â€¢ æ€§æ ¼ç‰¹ç‚¹ã€å¤–è²Œç‰¹å¾<br>\n                â€¢ ç‰¹æ®Šèƒ½åŠ›æˆ–èƒŒæ™¯è®¾å®š<br>\n                â€¢ ä»»ä½•å…¶ä»–è¦æ±‚\n              </p>\n            </div>\n\n            <div style="margin-bottom: 16px">\n              <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 8px">è§’è‰²è¦æ±‚ï¼š</label>\n              <textarea\n                id="target-summon-input"\n                placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³è¦ä¸€ä¸ªæ¸©æŸ”ä½“è´´çš„å¥³æ€§è§’è‰²ï¼ŒèŒä¸šæ˜¯åŒ»ç”Ÿæˆ–æŠ¤å£«ï¼Œæœ‰ç€æ²»æ„ˆç³»çš„å¤–è²Œå’Œæ€§æ ¼..."\n                style="\n                  width: 100%;\n                  min-height: 150px;\n                  padding: 12px;\n                  background: rgba(15, 23, 42, 0.6);\n                  border: 1px solid rgba(139, 92, 246, 0.3);\n                  border-radius: 12px;\n                  color: var(--text-primary);\n                  font-size: 14px;\n                  resize: vertical;\n                  font-family: inherit;\n                "\n              ></textarea>\n            </div>\n\n            <div style="display: flex; gap: 12px; justify-content: flex-end">\n              <button class="btn btn-secondary" onclick="closeTargetSummonInput()">å–æ¶ˆ</button>\n              <button class="btn" onclick="confirmTargetSummon()">å¼€å§‹æŠ½å¡ (300 é‡‘)</button>\n            </div>\n          </div>\n        ',document.body.appendChild(e),e.classList.add("active"),setTimeout(()=>{const e=document.getElementById("target-summon-input");e&&e.focus()},100)}function closeTargetSummonInput(){const e=document.getElementById("target-summon-modal");e&&(e.classList.remove("active"),setTimeout(()=>e.remove(),300))}async function confirmTargetSummon(){const e=document.getElementById("target-summon-input"),t=e?e.value.trim():"";closeTargetSummonInput(),t?gameState.è´§å¸<300?alert("è´§å¸ä¸è¶³ï¼éœ€è¦300é‡‘ã€‚"):await handleSummon("å®šå‘æŠ½å¡",t):alert("è¯·è¾“å…¥è§’è‰²è¦æ±‚ï¼")}async function handleSummon(e,t=""){const n={"å•æŠ½":100,"é—ªå…‰æŠ½å¡":500,"å®šå‘æŠ½å¡":300}[e];if(gameState.è´§å¸<n)return void alert("è´§å¸ä¸è¶³ï¼");pendingSummonCost=n;const a=document.getElementById("summon-results"),o=document.getElementById("character-card-display");a.innerHTML='<div class="story-loading">â³ æ­£åœ¨å¬å”¤ï¼Œè¯·ç¨å€™...</div>',o&&(o.style.display="none",o.innerHTML="");let i="";i="å®šå‘æŠ½å¡"===e&&t?`æ‰§è¡Œå®šå‘æŠ½å¡ã€‚æ ¹æ®ä»¥ä¸‹è¦æ±‚ç”Ÿæˆè§’è‰²ï¼š\n\n${t}\n\nè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è§„åˆ™ç”Ÿæˆå®Œæ•´çš„è§’è‰²å¡ï¼š`:`æ‰§è¡Œ${e}ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è§„åˆ™ç”Ÿæˆå®Œæ•´çš„è§’è‰²å¡ï¼š`,i+=`\n\n**è§’è‰²ç”Ÿæˆè§„åˆ™ï¼š**\n1. ä½¿ç”¨ä½ æä¾›çš„è§’è‰²ç”Ÿæˆè§„åˆ™ç”Ÿæˆè§’è‰²ä¿¡æ¯ï¼ˆåŒ…æ‹¬ä¸–ç•ŒèƒŒæ™¯ã€å¬å”¤æ–¹å¼ã€è§’è‰²è®¾å®šæ ¸å¿ƒè§„åˆ™ç­‰ï¼‰\n2. å¿…é¡»ç”Ÿæˆå®Œæ•´çš„è§’è‰²èµ„æ–™æ ¼å¼ï¼š\n   - å…ƒç´ ï¼ˆ3-4ä¸ªç‹¬ç‰¹å…ƒç´ ï¼ŒåŒ…å«è‡³å°‘ä¸€ä¸ªç¨€æœ‰å°ä¼—å…ƒç´ ï¼‰\n   - å§“å\n   - ç¨€æœ‰åº¦ï¼ˆN/R/SR/SSRï¼Œæ ¹æ®${e}çš„æ¦‚ç‡è§„åˆ™ï¼‰\n   - æ€§åˆ«ï¼ˆç”·æ€§/å¥³æ€§/åŒæ€§ç”·æ€§ï¼‰\n   - ç§æ—/å‡ºèº«\n   - èŒä¸š/èº«ä»½\n   - å¤–è²Œç‰¹ç‚¹ï¼ˆè¯¦ç»†æè¿°ï¼‰\n   - æ€§æ ¼/å–œå¥½\n   - ç®€ä»‹\n   - èƒŒæ™¯æ•…äº‹ï¼ˆè‡³å°‘1000å­—ï¼Œä½“è£ä¸é™ï¼‰\n   - AIç»˜å›¾æ ‡ç­¾ï¼ˆNovelAIé€‚ç”¨ï¼ŒåŒåˆ†é•œæ ¼å¼ï¼‰\n\n3. **å¿…é¡»ç”Ÿæˆ** image###è§’è‰²æç¤ºè¯### æ ¼å¼çš„å›¾ç‰‡æ ‡ç­¾ï¼Œå¹¶å­˜å‚¨åœ¨è§’è‰².ç»˜å›¾æ ‡ç­¾å­—æ®µä¸­\n   - å›¾ç‰‡æ ‡ç­¾å¿…é¡»ä¸¥æ ¼æŒ‰ç…§NovelAIåŒåˆ†é•œæ ¼å¼ç”Ÿæˆ\n   - å·¦ä¾§ï¼šSFWäººè®¾å›¾ï¼ˆæ¨¡ä»¿äºŒæ¬¡å…ƒå¡ç‰Œæ¸¸æˆå¡é¢ï¼‰\n   - å³ä¾§ï¼šNSFWæ¶©å›¾ï¼ˆä¿æŒç¾è§‚ã€æ·«é¡ã€è‰²æ°”æ°›å›´ï¼‰\n   - æ ¼å¼ï¼šimage###masterpiece, best quality, 8k, {{consistent character}},{split image},{two panels}...###\n\n4. **å¿…é¡»ç”Ÿæˆ**ä¸€ä¸ªå¸¦å‰ç«¯çš„HTMLè§’è‰²å¡ï¼Œç›´æ¥è¾“å‡ºåœ¨å›å¤ä¸­ï¼ˆä¸è¦ç”¨markdownä»£ç å—åŒ…è£¹ï¼‰\n   - å¿…é¡»åŒ…å«å®Œæ•´çš„<style>æ ‡ç­¾ï¼Œä½¿ç”¨CSSå˜é‡å®šä¹‰ä¸“å±ä¸»é¢˜è‰²\n   - å¿…é¡»æ ¹æ®è§’è‰²è®¾å®šåŠ¨æ€è°ƒæ•´UIè®¾è®¡ï¼ˆæè´¨æ„Ÿã€å­—ä½“ã€é¢œè‰²ç­‰ï¼‰\n   - å¿…é¡»ä½¿ç”¨CSS @importå¼•å…¥Google Fontsè¿›è¡Œå­—ä½“ç¾åŒ–\n   - å¿…é¡»åŒ…å«è§’è‰²çš„æ‰€æœ‰ä¿¡æ¯å±•ç¤º\n   - å›¾åƒPromptåŒºåŸŸå¿…é¡»æ˜¯ç‹¬ç«‹çš„divï¼Œdisplay: blockï¼Œmin-height: 50pxï¼Œä¸èƒ½ä½¿ç”¨overflow: hidden\n   - Promptæ–‡æœ¬æ ¼å¼ï¼šimage###{Split cues}###\n   - éçº¿æ€§æ’ç‰ˆï¼Œæ ¹æ®è®¾è®¡ç¾æ„Ÿè‡ªç”±æ’å¸ƒ\n   - è¾ƒé•¿çš„èƒŒæ™¯æ•…äº‹ç­‰æ–‡æœ¬é‡‡ç”¨å¯æ»šåŠ¨å½¢å¼\n   - SSRè§’è‰²å¿…é¡»åŒ…å«ç‰¹æ®ŠåŠ¨æ€ç‰¹æ•ˆï¼ˆCSSåŠ¨ç”»æµå…‰ç­‰ï¼‰\n\n5. æ›´æ–°å˜é‡ï¼šå°†æ–°è§’è‰²æ·»åŠ åˆ°è§’è‰²ä»“åº“ï¼Œæ‰£é™¤è´§å¸ï¼Œæ›´æ–°æŠ½å¡è®°å½•ç­‰\n   - å¿…é¡»ä½¿ç”¨JSONPatchæ ¼å¼æ›´æ–°æ¸¸æˆçŠ¶æ€\n   - æ–°è§’è‰²å¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼šå…ƒç´ ã€å§“åã€ç¨€æœ‰åº¦ã€æ€§åˆ«ã€ç§æ—å‡ºèº«ã€èŒä¸šèº«ä»½ã€å¤–è²Œç‰¹ç‚¹ã€æ€§æ ¼å–œå¥½ã€ç®€ä»‹ã€èƒŒæ™¯æ•…äº‹ã€ç»˜å›¾æ ‡ç­¾ã€å±æ€§ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ï¼Œåˆå§‹å€¼æ ¹æ®ç¨€æœ‰åº¦è®¾å®šï¼‰ã€æƒ…æ„ŸçŠ¶æ€ï¼ˆå¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿã€æƒ…æ„Ÿå¼ºåº¦ã€ç‰¹æ®ŠçŠ¶æ€ï¼‰ã€çŠ¶æ€ï¼ˆåˆå§‹ä¸º"ç©ºé—²"ï¼‰ã€å½“å‰ä½ç½®ï¼ˆåˆå§‹ä¸º"ä»“åº“"ï¼‰ã€ç»éªŒå€¼ï¼ˆåˆå§‹ä¸º0ï¼‰ã€ç­‰çº§ï¼ˆåˆå§‹ä¸º1ï¼‰ã€æ¥å®¢æ¬¡æ•°ï¼ˆåˆå§‹ä¸º0ï¼‰ã€è°ƒæ•™æ¬¡æ•°ï¼ˆåˆå§‹ä¸º0ï¼‰ã€æ”¶å…¥è´¡çŒ®ï¼ˆåˆå§‹ä¸º0ï¼‰ã€æœ€åäº’åŠ¨ï¼ˆå½“å‰æ—¶é—´æˆ³ï¼‰\n   - æ›´æ–°æŠ½å¡è®°å½•ï¼šç”Ÿæˆå”¯ä¸€æŠ½å¡IDï¼Œè®°å½•æ—¶é—´æˆ³ã€ç±»å‹ã€æ¶ˆè€—ã€ç»“æœï¼ˆè§’è‰²IDæ•°ç»„ï¼‰\n   - æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼šæ€»æŠ½å¡æ¬¡æ•°+1ï¼Œæ€»è·å¾—è§’è‰²+1ï¼Œå¯¹åº”ç¨€æœ‰åº¦+1ï¼Œå¯¹åº”æƒ…æ„Ÿç±»å‹+1\n\n**é‡è¦è¦æ±‚ï¼š**\n- å‰ç«¯HTMLå¿…é¡»å®Œæ•´ï¼ŒåŒ…å«ä»<style>å¼€å§‹åˆ°æœ€åä¸€ä¸ªé—­åˆæ ‡ç­¾çš„å®Œæ•´ç»“æ„\n- å‰ç«¯HTMLç›´æ¥è¾“å‡ºåœ¨å›å¤ä¸­ï¼Œä¸è¦ç”¨\`\`\`htmlä»£ç å—åŒ…è£¹\n- å‰ç«¯HTMLä¼šç”±ç³»ç»Ÿè‡ªåŠ¨ä¿å­˜åˆ°è§’è‰².è‡ªå®šä¹‰å‰ç«¯HTMLå­—æ®µä¸­\n- ç¡®ä¿å‰ç«¯HTMLç»“æ„å®Œæ•´ï¼Œèƒ½å¤Ÿç‹¬ç«‹æ¸²æŸ“`,await sendCommandToAI(i)}async function sendCommandToAI(e){try{if("undefined"!=typeof generate){const t=await generate({user_input:e});return parseAIResponse(t),t}"undefined"!=typeof SillyTavern?SillyTavern.sendMessage(e):(await navigator.clipboard.writeText(e),alert(`æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ${e}\nè¯·ç²˜è´´åˆ°èŠå¤©æ¡†å‘é€ç»™ AI`))}catch(t){console.error("å‘é€æŒ‡ä»¤å¤±è´¥:",t),await navigator.clipboard.writeText(e),alert(`æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ${e}\nè¯·ç²˜è´´åˆ°èŠå¤©æ¡†å‘é€ç»™ AI`)}}function parseAIResponse(e){let t="";const n=e.match(/<style>[\s\S]*?<\/style>/);if(n){const a=n.index,o=n.index+n[0].length;let i=o,s=-1;for(;i<e.length&&/\s/.test(e[i]);)i++;const r=e.substring(i).match(/<(\w+)[\s>]/);if(r){const n=r[1];let c=0,l=!1,d="";for(let t=i+r.index;t<e.length;t++){const a=e[t];if("<"===a)l=!0,d="<";else if(">"===a){if(d+=">",l=!1,d.match(new RegExp(`<${n}[\\s>]`)))c++;else if(d.match(new RegExp(`</${n}>`))&&(c--,0===c)){s=t+1;break}d=""}else l&&(d+=a)}if(s>i)t=e.substring(a,s);else{const n=e.indexOf("<JSONPatch>",o),i=n>0?n:e.length;i>a&&(t=e.substring(a,i).trim())}if(t=t.replace(/^```html\s*/i,"").replace(/\s*```$/i,""),t=t.replace(/^```\s*/i,"").replace(/\s*```$/i,""),t&&t.length>100){console.info("æå–åˆ°å‰ç«¯HTMLï¼Œé•¿åº¦:",t.length);const e=document.getElementById("character-card-display");e&&(e.style.display="block",e.innerHTML=`<div style="max-width: 100%; overflow-x: auto; box-sizing: border-box">${t}</div>`,setTimeout(()=>{e.scrollIntoView({behavior:"smooth",block:"start"})},100))}}}const a=e.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/);if(a)try{const e=JSON.parse(a[1]);t&&t.length>100&&e.forEach(e=>{if(e.path.includes("è§’è‰²ä»“åº“")&&"add"===e.op){const n=e.path.split("/").pop();e.value&&"object"==typeof e.value&&(e.value.è‡ªå®šä¹‰å‰ç«¯HTML=t,console.info("å·²ä¿å­˜å‰ç«¯HTMLåˆ°è§’è‰²:",n))}}),e.forEach(e=>{e.path.includes("è§’è‰²ä»“åº“")&&"add"===e.op&&(console.info("æ–°è§’è‰²æ·»åŠ :",e.path,e.value),e.value&&e.value.ç»˜å›¾æ ‡ç­¾&&console.info("è§’è‰²ç»˜å›¾æ ‡ç­¾:",e.value.ç»˜å›¾æ ‡ç­¾.substring(0,100)),e.value&&e.value.è‡ªå®šä¹‰å‰ç«¯HTML&&console.info("è§’è‰²å‰ç«¯HTMLå·²ä¿å­˜"))}),applyJSONPatches(e)}catch(e){console.error("è§£æ JSON Patch å¤±è´¥:",e)}refreshAllPages()}function applyJSONPatches(e){e.forEach(e=>{try{const t=e.path.replace(/^\//,"").split("/");if(pendingSummonCost>0&&1===t.length&&"è´§å¸"===t[0]&&"replace"===e.op)setNestedValue(gameState,t,e.value),pendingSummonCost=0;else if(pendingSummonCost>0&&1===t.length&&"è´§å¸"===t[0]&&"add"===e.op){const n=getNestedValue(gameState,t)||gameState.è´§å¸;setNestedValue(gameState,t,n-pendingSummonCost+(e.value||0)),pendingSummonCost=0}else if("replace"===e.op)setNestedValue(gameState,t,e.value);else if("add"===e.op)setNestedValue(gameState,t,e.value);else if("remove"===e.op){const e=getNestedValue(gameState,t.slice(0,-1));e&&delete e[t[t.length-1]]}}catch(t){console.error("åº”ç”¨ JSON Patch å¤±è´¥:",e,t)}}),pendingSummonCost>0&&(gameState.è´§å¸-=pendingSummonCost,pendingSummonCost=0),setTimeout(()=>{refreshAllPages()},100)}function getNestedValue(e,t){return t.reduce((e,t)=>Array.isArray(e)&&/^\d+$/.test(t)?e[parseInt(t)]:e&&e[t],e)}function setNestedValue(e,t,n){const a=t[t.length-1];t.slice(0,-1).reduce((e,t)=>(e[t]||(e[t]={}),e[t]),e)[a]=n}async function loadGameStateFromMVU(){try{if("undefined"!=typeof waitGlobalInitialized&&await waitGlobalInitialized("Mvu"),"undefined"!=typeof Mvu&&"undefined"!=typeof getCurrentMessageId){const e=getCurrentMessageId(),t=Mvu.getMvuData({type:"message",message_id:e}),n="undefined"!=typeof _&&_.get?_.get(t,"stat_data"):t?.stat_data;n&&(Object.assign(gameState,n),refreshAllPages())}else if("undefined"!=typeof getVariables){const e=getVariables({type:"message",message_id:"latest"}),t=e?.stat_data;t&&(Object.assign(gameState,t),refreshAllPages())}}catch(e){console.error("åŠ è½½ MVU å˜é‡å¤±è´¥:",e),refreshAllPages()}}async function saveGameStateToMVU(){try{if("undefined"!=typeof updateVariablesWith&&"undefined"!=typeof getCurrentMessageId){const e=getCurrentMessageId();updateVariablesWith(e=>("undefined"!=typeof _&&_.set?_.set(e,"stat_data",gameState):e.stat_data=gameState,e),{type:"message",message_id:e})}}catch(e){console.error("ä¿å­˜ MVU å˜é‡å¤±è´¥:",e)}}function setupEventListeners(){"undefined"!=typeof eventOn&&"undefined"!=typeof Mvu&&eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,e=>{const t="undefined"!=typeof _&&_.get?_.get(e,"stat_data"):e?.stat_data;t&&(Object.assign(gameState,t),refreshAllPages())});const e=document.getElementById("search-input"),t=document.getElementById("filter-rarity");e&&e.addEventListener("input",()=>refreshUnitsPage()),t&&t.addEventListener("change",()=>refreshUnitsPage())}function showCharacterDetail(e){const t=gameState.è§’è‰²ä»“åº“[e];if(!t)return;const n=document.getElementById("character-detail-modal"),a=document.getElementById("character-detail-content");if(!n||!a)return;const o=t.è‡ªå®šä¹‰å‰ç«¯HTML||t.å‰ç«¯HTML||t.HTMLå¡ç‰‡||"";if(o&&(o.includes("<style>")||o.includes("<div"))){a.innerHTML=o;const i=document.createElement("div");i.style.cssText="margin-top: 20px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px;",i.innerHTML=`\n            <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å±æ€§</h3>\n            ${["é­…åŠ›","é¡ºä»","æŠ€å·§","è€åŠ›","æ•æ„Ÿåº¦"].map(e=>`\n              <div style="margin-bottom: 10px">\n                <div style="display: flex; justify-content: space-between; margin-bottom: 4px">\n                  <span>${e}</span>\n                  <span>${t.å±æ€§?.[e]||0}/100</span>\n                </div>\n                <div class="stat-bar">\n                  <div class="stat-fill" style="width: ${t.å±æ€§?.[e]||0}%"></div>\n                </div>\n              </div>\n            `).join("")}\n          `,a.appendChild(i);const s=document.createElement("div");s.style.cssText="margin-top: 20px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px;",s.innerHTML=`\n            <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">äº’åŠ¨å‰§æƒ…</h3>\n            <div id="character-story-${e}" class="story-container">\n              <div class="story-content" id="story-content-${e}" style="min-height: 100px; max-height: 400px; overflow-y: auto; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; line-height: 1.8">\n                <div class="story-placeholder">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹äº’åŠ¨ï¼ŒAI ç”Ÿæˆçš„å‰§æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>\n              </div>\n            </div>\n          `,a.appendChild(s);const r=document.createElement("div");return r.style.cssText="margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px;",r.innerHTML=`\n            <button class="btn btn-secondary" onclick="showTrainingInput('${e}')">ğŸ” è°ƒæ•™</button>\n            <button class="btn btn-secondary" onclick="startInteraction('${e}', 'å¯¹è¯')">ğŸ’¬ å¯¹è¯</button>\n            <button class="btn btn-secondary" onclick="startInteraction('${e}', 'ç‰¹æ®Šäº’åŠ¨')">âœ¨ ç‰¹æ®Šäº’åŠ¨</button>\n            <button class="btn" onclick="assignCharacterToBrothel('${e}')">ğŸ›ï¸ æ´¾é£æ¥å®¢</button>\n            <button class="btn btn-secondary" onclick="decomposeCharacter('${e}')">âš¡ åˆ†è§£</button>\n          `,a.appendChild(r),n.classList.add("active"),n.scrollTop=0,void setTimeout(()=>{const e=n.querySelector(".modal-content");e&&(e.scrollTop=0)},100)}const i=document.createElement("div");i.style.width="100%",i.style.aspectRatio="1",i.style.marginBottom="20px",i.style.borderRadius="12px",i.style.overflow="hidden",i.style.border="1px solid rgba(139, 92, 246, 0.3)",i.className="character-image-container",t.ç»˜å›¾æ ‡ç­¾?(i.innerHTML='<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 48px">â³</div>',setTimeout(()=>{if(!renderImageTag(t.ç»˜å›¾æ ‡ç­¾,i)){const e=t.ç»˜å›¾æ ‡ç­¾.match(/image###([\s\S]*?)###/)?.[1]||"";i.innerHTML=e?`\n                  <div class="image-placeholder" onclick="copyImagePrompt('${e.replace(/'/g,"\\'")}')">\n                    <div style="font-size: 48px; margin-bottom: 8px">ğŸ–¼ï¸</div>\n                    <div style="font-size: 12px; text-align: center; padding: 0 8px">ç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤</div>\n                  </div>\n                `:'<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 64px">ğŸ‘¤</div>'}},100)):i.innerHTML='<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 64px">ğŸ‘¤</div>',a.innerHTML=`\n        <h2 style="font-size: 28px; color: var(--primary); margin-bottom: 24px; text-align: center">${t.å§“å}</h2>\n        <div id="char-detail-image"></div>\n\n        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px">\n          <div>\n            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">ç¨€æœ‰åº¦</div>\n            <div style="font-size: 20px; font-weight: bold" class="rarity-${t.ç¨€æœ‰åº¦}">${t.ç¨€æœ‰åº¦}</div>\n          </div>\n          <div>\n            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">èŒä¸š</div>\n            <div style="font-size: 18px">${t.èŒä¸šèº«ä»½||"æ— "}</div>\n          </div>\n          <div>\n            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">ç­‰çº§</div>\n            <div style="font-size: 20px; font-weight: bold; color: var(--accent-gold)">Lv.${t.ç­‰çº§||1}</div>\n            <div style="font-size: 12px; color: var(--text-secondary)">ç»éªŒ: ${t.ç»éªŒå€¼||0}/${100*(t.ç­‰çº§||1)}</div>\n          </div>\n          <div>\n            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">æƒ…æ„ŸçŠ¶æ€</div>\n            <div style="font-size: 16px">${t.æƒ…æ„ŸçŠ¶æ€?.å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ||"ä¸­ç«‹"}</div>\n            <div style="font-size: 12px; color: var(--text-secondary)">å¼ºåº¦: ${t.æƒ…æ„ŸçŠ¶æ€?.æƒ…æ„Ÿå¼ºåº¦||0}</div>\n            ${t.æƒ…æ„ŸçŠ¶æ€?.ç‰¹æ®ŠçŠ¶æ€?.length>0?`<div style="font-size: 12px; color: var(--primary); margin-top: 4px">${t.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.join(", ")}</div>`:""}\n          </div>\n          <div>\n            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">ç»Ÿè®¡æ•°æ®</div>\n            <div style="font-size: 12px; color: var(--text-secondary)">æ¥å®¢: ${t.æ¥å®¢æ¬¡æ•°||0}æ¬¡</div>\n            <div style="font-size: 12px; color: var(--text-secondary)">è°ƒæ•™: ${t.è°ƒæ•™æ¬¡æ•°||0}æ¬¡</div>\n            <div style="font-size: 12px; color: var(--accent-gold)">è´¡çŒ®: ${t.æ”¶å…¥è´¡çŒ®||0}é‡‘</div>\n          </div>\n        </div>\n\n        <div style="margin-bottom: 24px">\n          <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å±æ€§</h3>\n          ${["é­…åŠ›","é¡ºä»","æŠ€å·§","è€åŠ›","æ•æ„Ÿåº¦"].map(e=>`\n            <div style="margin-bottom: 10px">\n              <div style="display: flex; justify-content: space-between; margin-bottom: 4px">\n                <span>${e}</span>\n                <span>${t.å±æ€§?.[e]||0}/100</span>\n              </div>\n              <div class="stat-bar">\n                <div class="stat-fill" style="width: ${t.å±æ€§?.[e]||0}%"></div>\n              </div>\n            </div>\n          `).join("")}\n        </div>\n\n        <div style="margin-bottom: 24px">\n          <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">èƒŒæ™¯æ•…äº‹</h3>\n          <div style="max-height: 500px; overflow-y: auto; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word; text-align: left">\n            ${(t.èƒŒæ™¯æ•…äº‹||"æš‚æ— èƒŒæ™¯æ•…äº‹").replace(/\n/g,"<br>")}\n          </div>\n        </div>\n\n        <div style="margin-bottom: 24px">\n          <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">äº’åŠ¨å‰§æƒ…</h3>\n          <div id="character-story-${e}" class="story-container">\n            <div class="story-content" id="story-content-${e}" style="min-height: 150px; max-height: 500px; overflow-y: auto; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word">\n              <div class="story-placeholder">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹äº’åŠ¨ï¼ŒAI ç”Ÿæˆçš„å‰§æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>\n            </div>\n          </div>\n        </div>\n\n        <div style="margin-bottom: 24px">\n          <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">æ“ä½œ</h3>\n          <div style="display: flex; gap: 12px; flex-wrap: wrap">\n            <button class="btn btn-secondary" onclick="showTrainingInput('${e}')">ğŸ” è°ƒæ•™</button>\n            <button class="btn btn-secondary" onclick="startInteraction('${e}', 'å¯¹è¯')">ğŸ’¬ å¯¹è¯</button>\n            <button class="btn btn-secondary" onclick="startInteraction('${e}', 'ç‰¹æ®Šäº’åŠ¨')">âœ¨ ç‰¹æ®Šäº’åŠ¨</button>\n            <button class="btn" onclick="assignCharacterToBrothel('${e}')">ğŸ›ï¸ æ´¾é£æ¥å®¢</button>\n            <button class="btn btn-secondary" onclick="decomposeCharacter('${e}')">âš¡ åˆ†è§£</button>\n          </div>\n        </div>\n      `;const s=a.querySelector("#char-detail-image");s&&s.parentNode.replaceChild(i,s),n.classList.add("active"),n.scrollTop=0,setTimeout(()=>{const e=n.querySelector(".modal-content");e&&(e.scrollTop=0)},100)}function closeCharacterDetail(){const e=document.getElementById("character-detail-modal");e&&e.classList.remove("active")}function showTrainingInput(e){const t=gameState.è§’è‰²ä»“åº“[e];if(!t)return;const n=document.createElement("div");n.className="modal",n.id="training-input-modal",n.innerHTML=`\n          <div class="modal-content" style="max-width: 600px">\n            <button class="modal-close" onclick="closeTrainingInput()">Ã—</button>\n            <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">ğŸ” è°ƒæ•™è§’è‰²ï¼š${t.å§“å}</h2>\n\n            <div style="margin-bottom: 16px">\n              <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 8px">è°ƒæ•™æŒ‡ä»¤ï¼ˆæè¿°ä½ æƒ³è¦è¿›è¡Œçš„è°ƒæ•™å†…å®¹ï¼‰ï¼š</label>\n              <textarea\n                id="training-command-input"\n                placeholder="ä¾‹å¦‚ï¼šä½¿ç”¨é­å­è¿›è¡Œè½»åº¦è°ƒæ•™ï¼Œé‡ç‚¹æå‡è§’è‰²çš„é¡ºä»åº¦..."\n                style="\n                  width: 100%;\n                  min-height: 150px;\n                  padding: 12px;\n                  background: rgba(15, 23, 42, 0.6);\n                  border: 1px solid rgba(139, 92, 246, 0.3);\n                  border-radius: 12px;\n                  color: var(--text-primary);\n                  font-size: 14px;\n                  resize: vertical;\n                  font-family: inherit;\n                "\n              ></textarea>\n            </div>\n\n            <div style="display: flex; gap: 12px; justify-content: flex-end">\n              <button class="btn btn-secondary" onclick="closeTrainingInput()">å–æ¶ˆ</button>\n              <button class="btn" onclick="confirmTraining('${e}')">å¼€å§‹è°ƒæ•™</button>\n            </div>\n          </div>\n        `,document.body.appendChild(n),n.classList.add("active"),setTimeout(()=>{const e=document.getElementById("training-command-input");e&&e.focus()},100)}function closeTrainingInput(){const e=document.getElementById("training-input-modal");e&&(e.classList.remove("active"),setTimeout(()=>e.remove(),300))}async function confirmTraining(e){const t=document.getElementById("training-command-input"),n=t?t.value.trim():"";if(closeTrainingInput(),!n)return void alert("è¯·è¾“å…¥è°ƒæ•™æŒ‡ä»¤ï¼");const a=document.getElementById("character-detail-modal");a&&a.classList.contains("active")?await startInteraction(e,"è°ƒæ•™",n):(showCharacterDetail(e),setTimeout(()=>{startInteraction(e,"è°ƒæ•™",n)},300))}async function startInteraction(e,t,n=""){const a=gameState.è§’è‰²ä»“åº“[e];if(!a)return;const o=document.getElementById(`story-content-${e}`);o&&(o.innerHTML='<div class="story-loading">â³ AI æ­£åœ¨ç”Ÿæˆå‰§æƒ…ï¼Œè¯·ç¨å€™...</div>');let i="";switch(t){case"è°ƒæ•™":i=n?`è°ƒæ•™è§’è‰²${e}ï¼ˆ${a.å§“å}ï¼‰ã€‚æ ¹æ®ä»¥ä¸‹æŒ‡ä»¤è¿›è¡Œè°ƒæ•™ï¼š\n\n${n}\n\nè¯·ç”Ÿæˆè¯¦ç»†çš„è°ƒæ•™å‰§æƒ…ï¼ŒåŒ…æ‹¬è¿‡ç¨‹ã€è§’è‰²ååº”ã€çŠ¶æ€å˜åŒ–ç­‰ã€‚`:`è°ƒæ•™è§’è‰²${e}ï¼ˆ${a.å§“å}ï¼‰ã€‚è¯·ç”Ÿæˆè¯¦ç»†çš„è°ƒæ•™å‰§æƒ…ï¼ŒåŒ…æ‹¬è¿‡ç¨‹ã€è§’è‰²ååº”ã€çŠ¶æ€å˜åŒ–ç­‰ã€‚`,i+=`\n\nè°ƒæ•™å†…å®¹å¯ä»¥åŒ…æ‹¬ï¼š\n- è°ƒæ•™è¿‡ç¨‹æè¿°ï¼ˆå·¥å…·ã€æ–¹æ³•ã€æ­¥éª¤ç­‰ï¼‰\n- è§’è‰²çš„èº«ä½“ååº”å’Œå¿ƒç†å˜åŒ–\n- è§’è‰²å±æ€§çš„å˜åŒ–ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ç­‰ï¼‰\n- è§’è‰²æƒ…æ„ŸçŠ¶æ€çš„å˜åŒ–\n- è°ƒæ•™åçš„çŠ¶æ€å’Œæ•ˆæœ\n\né‡è¦è¦æ±‚ï¼š\n- ä¸è¦ç”ŸæˆçŠ¶æ€æ ï¼ˆ/.*/sæ ¼å¼çš„å†…å®¹ï¼‰\n- ä¸è¦å—ä¸–ç•Œä¹¦å½±å“ç”Ÿæˆé¢å¤–çš„çŠ¶æ€æ æˆ–æ ¼å¼åŒ–å†…å®¹\n- åªç”Ÿæˆçº¯æ–‡æœ¬å‰§æƒ…å†…å®¹\n- **å¿…é¡»ä½¿ç”¨JSONPatchæ ¼å¼æ›´æ–°è§’è‰²å±æ€§**ï¼ŒåŒ…æ‹¬ï¼šé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦\n- å±æ€§æ›´æ–°è·¯å¾„æ ¼å¼ï¼šè§’è‰²ä»“åº“/${e}/å±æ€§/é­…åŠ›ã€è§’è‰²ä»“åº“/${e}/å±æ€§/é¡ºä» ç­‰\n- è°ƒæ•™å‰§æƒ…åº”è¯¥è¯¦ç»†ã€ç”ŸåŠ¨ï¼Œä½“ç°è°ƒæ•™çš„è¿‡ç¨‹å’Œæ•ˆæœ\n- å¦‚æœè°ƒæ•™æ¶‰åŠæå‡æŸä¸ªå±æ€§ï¼Œå¿…é¡»åœ¨JSONPatchä¸­æ˜ç¡®æ›´æ–°è¯¥å±æ€§çš„æ•°å€¼`;break;case"å¯¹è¯":i=`ä¸è§’è‰²${e}ï¼ˆ${a.å§“å}ï¼‰è¿›è¡Œå¯¹è¯äº’åŠ¨ã€‚è¯·ç”Ÿæˆå¯¹è¯å†…å®¹å’Œè§’è‰²ååº”ã€‚\n\né‡è¦è¦æ±‚ï¼š\n- ä¸è¦ç”ŸæˆçŠ¶æ€æ ï¼ˆ/.*/sæ ¼å¼çš„å†…å®¹ï¼‰\n- ä¸è¦å—ä¸–ç•Œä¹¦å½±å“ç”Ÿæˆé¢å¤–çš„çŠ¶æ€æ æˆ–æ ¼å¼åŒ–å†…å®¹\n- åªç”Ÿæˆçº¯æ–‡æœ¬å¯¹è¯å†…å®¹\n- å¦‚æœéœ€è¦æ›´æ–°è§’è‰²çŠ¶æ€ï¼Œè¯·ä½¿ç”¨JSONPatchæ ¼å¼`;break;case"ç‰¹æ®Šäº’åŠ¨":i=`ä¸è§’è‰²${e}ï¼ˆ${a.å§“å}ï¼‰è¿›è¡Œç‰¹æ®Šäº’åŠ¨ã€‚è¯·æ ¹æ®è§’è‰²å½“å‰çŠ¶æ€ç”Ÿæˆåˆé€‚çš„äº’åŠ¨å‰§æƒ…ã€‚\n\né‡è¦è¦æ±‚ï¼š\n- ä¸è¦ç”ŸæˆçŠ¶æ€æ ï¼ˆ/.*/sæ ¼å¼çš„å†…å®¹ï¼‰\n- ä¸è¦å—ä¸–ç•Œä¹¦å½±å“ç”Ÿæˆé¢å¤–çš„çŠ¶æ€æ æˆ–æ ¼å¼åŒ–å†…å®¹\n- åªç”Ÿæˆçº¯æ–‡æœ¬å‰§æƒ…å†…å®¹\n- å¦‚æœéœ€è¦æ›´æ–°è§’è‰²çŠ¶æ€ï¼Œè¯·ä½¿ç”¨JSONPatchæ ¼å¼`;break;default:i=`ä¸è§’è‰²${e}ï¼ˆ${a.å§“å}ï¼‰è¿›è¡Œ${t}äº’åŠ¨ã€‚\n\né‡è¦è¦æ±‚ï¼š\n- ä¸è¦ç”ŸæˆçŠ¶æ€æ ï¼ˆ/.*/sæ ¼å¼çš„å†…å®¹ï¼‰\n- ä¸è¦å—ä¸–ç•Œä¹¦å½±å“ç”Ÿæˆé¢å¤–çš„çŠ¶æ€æ æˆ–æ ¼å¼åŒ–å†…å®¹\n- åªç”Ÿæˆçº¯æ–‡æœ¬å†…å®¹`}try{const e=await sendCommandToAI(i);if(e&&o){let t=e;t.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/)&&(t=t.replace(/<JSONPatch>[\s\S]*?<\/JSONPatch>/,"").trim()),t=t.replace(/<UpdateVariable>[\s\S]*?<\/UpdateVariable>/,"").trim(),t=t.replace(/<Analysis>[\s\S]*?<\/Analysis>/,"").trim(),"undefined"!=typeof formatAsDisplayedMessage&&(t=formatAsDisplayedMessage(t)),o.innerHTML=`<div class="story-content">${t}</div>`}}catch(e){console.error("ç”Ÿæˆå‰§æƒ…å¤±è´¥:",e),o&&(o.innerHTML='<div class="story-placeholder" style="color: var(--danger)">ç”Ÿæˆå‰§æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>')}}function copyImagePrompt(e){navigator.clipboard.writeText(e).then(()=>{alert("ç»˜ç”»æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼")})}async function assignCharacterToBrothel(e){const t=gameState.è§’è‰²ä»“åº“[e];if(!t)return;const n=Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).filter(([e,t])=>"ç©ºé—²"===t.çŠ¶æ€&&"è°ƒæ•™å®¤"!==t.ç±»å‹).map(([e,t])=>e);if(0===n.length)return void alert("æ²¡æœ‰ç©ºé—²æˆ¿é—´ï¼");const a=prompt(`é€‰æ‹©æˆ¿é—´åˆ†é…ç»™ ${t.å§“å}\nå¯ç”¨æˆ¿é—´: ${n.join(", ")}`,n[0]);a&&n.includes(a)&&(closeCharacterDetail(),await assignCharacterToRoom(e,a))}function trainCharacter(e){startInteraction(e,"è°ƒæ•™")}function decomposeCharacter(e){confirm(`ç¡®å®šè¦åˆ†è§£ ${gameState.è§’è‰²ä»“åº“[e].å§“å} å—ï¼Ÿ`)&&(sendCommandToAI(`åˆ†è§£è§’è‰²${e}`),closeCharacterDetail())}function selectCharacterForRoom(e){const t=Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).filter(([e,t])=>"ç©ºé—²"===t.çŠ¶æ€&&"è°ƒæ•™å®¤"!==t.ç±»å‹).map(([e,t])=>e);if(0===t.length)return void alert("æ²¡æœ‰ç©ºé—²æˆ¿é—´ï¼");const n=prompt(`é€‰æ‹©æˆ¿é—´ (${t.join(", ")})`,t[0]);n&&t.includes(n)&&sendCommandToAI(`å°†è§’è‰²${e}æŒ‡æ´¾åˆ°æˆ¿é—´${n}`)}function showRoomAssignment(e){const t=Object.entries(gameState.è§’è‰²ä»“åº“).filter(([e,t])=>"ç©ºé—²"===t.çŠ¶æ€&&"ä»“åº“"===t.å½“å‰ä½ç½®).map(([e,t])=>({id:e,name:t.å§“å}));if(0===t.length)return void alert("æ²¡æœ‰å¯åˆ†é…çš„è§’è‰²ï¼");const n=t.map((e,t)=>`${t+1}. ${e.name} (${e.id})`).join("\n"),a=prompt(`é€‰æ‹©è¦åˆ†é…åˆ°æˆ¿é—´ ${e} çš„è§’è‰²ï¼š\n\n${n}\n\nè¯·è¾“å…¥è§’è‰²IDæˆ–åºå·ï¼š`);if(!a)return;let o=null;const i=parseInt(a);o=!isNaN(i)&&i>0&&i<=t.length?t[i-1].id:t.find(e=>e.id===a||e.name===a)?.id,o?assignCharacterToRoom(o,e):alert("æ— æ•ˆçš„é€‰æ‹©ï¼")}async function assignCharacterToRoom(e,t){const n=gameState.è§’è‰²ä»“åº“[e];if(!n)return;const a=`å°†è§’è‰²${e}ï¼ˆ${n.å§“å}ï¼‰æŒ‡æ´¾åˆ°æˆ¿é—´${t}å¼€å§‹æ¥å®¢ã€‚è¯·ï¼š\n1. æ›´æ–°è§’è‰².${e}.çŠ¶æ€ä¸º"æ¥å®¢ä¸­"\n2. æ›´æ–°è§’è‰².${e}.å½“å‰ä½ç½®ä¸º"å¦“é™¢"\n3. æ›´æ–°å¦“é™¢.æˆ¿é—´çŠ¶æ€.${t}.çŠ¶æ€ä¸º"ä½¿ç”¨ä¸­"ï¼ˆä¸è¦è®¾ç½®ä¸º"æ¸…æ´ä¸­"ï¼‰\n4. æ›´æ–°å¦“é™¢.æˆ¿é—´çŠ¶æ€.${t}.å½“å‰è§’è‰²ä¸º"${e}"\n5. åœ¨å¦“é™¢.å½“å‰æ¥å®¢è§’è‰².${e}ä¸­æ·»åŠ æ¥å®¢ä¿¡æ¯ï¼š\n   - å¼€å§‹æ—¶é—´ï¼šå½“å‰æ¸¸æˆæ—¶é—´æˆ³\n   - é¢„è®¡ç»“æŸï¼šå¼€å§‹æ—¶é—´ + 2å°æ—¶ Â± æœåŠ¡ç±»å‹å¤æ‚åº¦Ã—30åˆ†é’Ÿ\n   - å®¢æˆ·ç±»å‹ï¼šæ ¹æ®æ¦‚ç‡ç”Ÿæˆï¼ˆæ™®é€š70%, VIP25%, ç‰¹æ®Šç™–å¥½5%ï¼‰\n   - æœåŠ¡ç±»å‹ï¼šæ ¹æ®å®¢æˆ·ç±»å‹å’Œè§’è‰²å±æ€§ç”Ÿæˆï¼ˆæ™®é€šæœåŠ¡ã€è½»åº¦SMã€æŸç¼šæ¸¸æˆç­‰ï¼‰\n   - åŸºç¡€æ”¶å…¥ï¼š100~500 Ã— (è§’è‰²é­…åŠ›/50) Ã— (è§’è‰²æŠ€å·§/50) Ã— æ”¶ç›Šå€ç‡\n   - é¢å¤–æ”¶å…¥ï¼š0~300 Ã— æœåŠ¡ç±»å‹æ•°é‡ Ã— å®¢æˆ·ç±»å‹å€ç‡ Ã— æ”¶ç›Šå€ç‡\n6. æ ¹æ®æ¥å®¢äº‹ä»¶æ›´æ–°è§’è‰²å±æ€§ï¼š\n   - æŠ€å·§ï¼š+1~3\n   - é¡ºä»ï¼šÂ±2~5ï¼ˆæ ¹æ®è§’è‰²æƒ…æ„ŸçŠ¶æ€ï¼‰\n   - è€åŠ›ï¼š-1~2\n   - ç»éªŒå€¼ï¼š+5~15 Ã— ç»éªŒå€ç‡\n   - æ¥å®¢æ¬¡æ•°ï¼š+1\n   - æ”¶å…¥è´¡çŒ®ï¼š+åŸºç¡€æ”¶å…¥+é¢å¤–æ”¶å…¥\n   - æœ€åäº’åŠ¨ï¼šå½“å‰æ—¶é—´æˆ³\n7. æ ¹æ®æƒ…æ„ŸçŠ¶æ€è®¡ç®—å®é™…æ”¶å…¥ï¼ˆçˆ±Ã—1.5, å–œæ¬¢Ã—1.2, ä¸­ç«‹Ã—1.0, åŒæ¶Ã—0.7, æ†æ¨Ã—0.4ï¼‰\n8. æ ¹æ®ç‰¹æ®ŠçŠ¶æ€è°ƒæ•´æ”¶å…¥ï¼ˆéº»æœ¨Ã—0.8, å¿ è¯šÃ—1.3, åæŠ—Ã—0.5, å´©æºƒÃ—0.3ç­‰ï¼‰\n9. æ›´æ–°è´§å¸ï¼š+å®é™…æ”¶å…¥\n10. æ›´æ–°å¦“é™¢.ä»Šæ—¥æ”¶å…¥ï¼š+å®é™…æ”¶å…¥\n11. æ›´æ–°ç»Ÿè®¡æ•°æ®.æ€»æ¥å®¢æ¬¡æ•°ï¼š+1\n12. æ›´æ–°ç»Ÿè®¡æ•°æ®.æ€»æ”¶å…¥ï¼š+å®é™…æ”¶å…¥\n13. ç”Ÿæˆè¯¦ç»†çš„æ¥å®¢å‰§æƒ…ï¼ŒåŒ…æ‹¬æœåŠ¡è¿‡ç¨‹ã€å®¢æˆ·ååº”ã€è§’è‰²çŠ¶æ€å˜åŒ–ç­‰\n14. åœ¨å¦“é™¢.äº‹ä»¶æ—¥å¿—ä¸­æ·»åŠ äº‹ä»¶è®°å½•ï¼ˆæ—¶é—´æˆ³ã€è§’è‰²IDã€äº‹ä»¶ç±»å‹ã€æè¿°ã€æ”¶å…¥å˜åŒ–ï¼‰\n15. æ£€æŸ¥è§’è‰²è¿ç»­æ¥å®¢æ¬¡æ•°ï¼Œå¦‚æœâ‰¥3æ¬¡å¯èƒ½è·å¾—"éº»æœ¨"çŠ¶æ€\n16. æ£€æŸ¥è§’è‰²è€åŠ›ï¼Œå¦‚æœ<20åˆ™çŠ¶æ€æ”¹ä¸º"ä¼‘æ¯ä¸­"ï¼Œå¦‚æœ<5åˆ™çŠ¶æ€æ”¹ä¸º"åŒ»ç–—å®¤"\n\né‡è¦ï¼šè§’è‰²ä¸€æ—¦è¿›å…¥æˆ¿é—´æ¥å®¢ï¼ŒçŠ¶æ€åº”ä¿æŒä¸º"æ¥å®¢ä¸­"ï¼Œæˆ¿é—´çŠ¶æ€ä¿æŒä¸º"ä½¿ç”¨ä¸­"ï¼Œç›´åˆ°æˆ‘æ˜ç¡®æŒ‡ä»¤è®©è§’è‰²ç¦»å¼€ã€‚ä¸è¦è‡ªåŠ¨å°†æˆ¿é—´çŠ¶æ€æ”¹ä¸º"æ¸…æ´ä¸­"æˆ–ç§»é™¤è§’è‰²ã€‚`,o=document.getElementById("brothel-story-content");o&&(o.innerHTML='<div class="story-loading">â³ æ­£åœ¨åˆ†é…è§’è‰²å¹¶ç”Ÿæˆæ¥å®¢å‰§æƒ…ï¼Œè¯·ç¨å€™...</div>'),await sendCommandToAI(a)}async function showRoomDetail(e){const t=gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[e],n=t.å½“å‰è§’è‰²?gameState.è§’è‰²ä»“åº“[t.å½“å‰è§’è‰²]:null,a=t.å½“å‰è§’è‰²?gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[t.å½“å‰è§’è‰²]:null;if(n){const o=document.getElementById("brothel-story-content");o&&(o.innerHTML='<div class="story-loading">â³ AI æ­£åœ¨ç”Ÿæˆæ¥å®¢å‰§æƒ…ï¼Œè¯·ç¨å€™...</div>');let i="";if(a){const e=new Date(a.é¢„è®¡ç»“æŸ);e>Date.now()&&(i=`é¢„è®¡ç»“æŸæ—¶é—´: ${e.toLocaleString()}\nå®¢æˆ·ç±»å‹: ${a.å®¢æˆ·ç±»å‹}\næœåŠ¡ç±»å‹: ${a.æœåŠ¡ç±»å‹.join(", ")}\n`)}const s=`è§’è‰²${t.å½“å‰è§’è‰²}ï¼ˆ${n.å§“å}ï¼‰åœ¨æˆ¿é—´${e}ä¸­ç»§ç»­æ¥å®¢ã€‚${i}è¯·ç”Ÿæˆè¯¦ç»†çš„æ¥å®¢å‰§æƒ…ï¼ŒåŒ…æ‹¬æœåŠ¡è¿‡ç¨‹ã€å®¢æˆ·ååº”ã€è§’è‰²çŠ¶æ€å˜åŒ–ã€æ”¶å…¥ç­‰ã€‚é‡è¦ï¼šä¿æŒè§’è‰²çŠ¶æ€ä¸º"æ¥å®¢ä¸­"ï¼Œæˆ¿é—´çŠ¶æ€ä¸º"ä½¿ç”¨ä¸­"ï¼Œä¸è¦æ”¹ä¸º"æ¸…æ´ä¸­"ã€‚`;try{const e=await sendCommandToAI(s);if(e&&o){let t=e;t.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/)&&(t=t.replace(/<JSONPatch>[\s\S]*?<\/JSONPatch>/,"").trim()),t=t.replace(/<UpdateVariable>[\s\S]*?<\/UpdateVariable>/,"").trim(),t=t.replace(/<Analysis>[\s\S]*?<\/Analysis>/,"").trim(),"undefined"!=typeof formatAsDisplayedMessage&&(t=formatAsDisplayedMessage(t)),o.innerHTML=`<div class="story-content">${t}</div>`}}catch(e){console.error("ç”Ÿæˆå‰§æƒ…å¤±è´¥:",e),o&&(o.innerHTML='<div class="story-placeholder" style="color: var(--danger)">ç”Ÿæˆå‰§æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>')}}else alert(`æˆ¿é—´ ${e}\nçŠ¶æ€: ${t.çŠ¶æ€}\nå½“å‰æ— è§’è‰²`)}function toggleBrothelStatus(){sendCommandToAI(`è®¾ç½®å¦“é™¢è¥ä¸šçŠ¶æ€ä¸º${"è¥ä¸šä¸­"===gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€?"æš‚åœè¥ä¸š":"è¥ä¸šä¸­"}`)}function openSynthesis(){const e=document.createElement("div");e.className="modal",e.id="synthesis-modal",e.innerHTML='\n          <div class="modal-content" style="max-width: 900px">\n            <button class="modal-close" onclick="closeSynthesis()">Ã—</button>\n            <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">ğŸ”¬ è§’è‰²åˆæˆ</h2>\n\n            <div style="margin-bottom: 24px; padding: 16px; background: rgba(30, 41, 59, 0.6); border-radius: 12px">\n              <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">åˆæˆè§„åˆ™</h3>\n              <ul style="line-height: 2; color: var(--text-secondary); font-size: 14px">\n                <li>é€‰æ‹©2-5ä¸ªè§’è‰²è¿›è¡Œåˆæˆ</li>\n                <li>åˆæˆåçš„è§’è‰²ç¨€æœ‰åº¦ä¼šæ ¹æ®ç´ æè§’è‰²æå‡</li>\n                <li>æ–°è§’è‰²çš„å±æ€§ä¼šèåˆç´ æè§’è‰²çš„ç‰¹å¾</li>\n                <li>åˆæˆåç´ æè§’è‰²å°†è¢«æ¶ˆè€—</li>\n                <li>ç¨€æœ‰åº¦æå‡è§„åˆ™ï¼šN+Nâ†’R, R+Râ†’SR, SR+SRâ†’SSR, SSR+SSRâ†’SSR+</li>\n              </ul>\n            </div>\n\n            <div style="margin-bottom: 24px">\n              <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å·²é€‰æ‹©è§’è‰² (<span id="selected-count">0</span>/5)</h3>\n              <div id="selected-characters" style="display: flex; flex-wrap: wrap; gap: 12px; min-height: 80px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; border: 2px dashed rgba(139, 92, 246, 0.3)">\n                <div style="width: 100%; text-align: center; color: var(--text-secondary); padding: 20px">ä»ä¸‹æ–¹é€‰æ‹©è§’è‰²è¿›è¡Œåˆæˆ</div>\n              </div>\n            </div>\n\n            <div style="margin-bottom: 24px">\n              <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å¯é€‰è§’è‰²</h3>\n              <div id="synthesis-character-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px"></div>\n            </div>\n\n            <div style="display: flex; gap: 12px; justify-content: flex-end">\n              <button class="btn btn-secondary" onclick="closeSynthesis()">å–æ¶ˆ</button>\n              <button class="btn" id="btn-synthesize" onclick="confirmSynthesis()" disabled>å¼€å§‹åˆæˆ</button>\n            </div>\n          </div>\n        ',document.body.appendChild(e),e.classList.add("active"),window.selectedSynthesisChars||(window.selectedSynthesisChars=[]),refreshSynthesisPage()}function closeSynthesis(){const e=document.getElementById("synthesis-modal");e&&(e.classList.remove("active"),setTimeout(()=>e.remove(),300)),window.selectedSynthesisChars&&(window.selectedSynthesisChars=[])}function refreshSynthesisPage(){const e=document.getElementById("synthesis-character-list");if(!e)return void console.warn("synthesis-character-list å…ƒç´ ä¸å­˜åœ¨");if(e.innerHTML="",!gameState.è§’è‰²ä»“åº“||"object"!=typeof gameState.è§’è‰²ä»“åº“)return console.warn("è§’è‰²ä»“åº“ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯:",gameState.è§’è‰²ä»“åº“),void(e.innerHTML='<div style="text-align: center; color: var(--text-secondary); padding: 40px">è§’è‰²ä»“åº“æ•°æ®å¼‚å¸¸</div>');const t=Object.entries(gameState.è§’è‰²ä»“åº“).filter(([e,t])=>{const n=t&&("ç©ºé—²"===t.çŠ¶æ€||!t.çŠ¶æ€),a=t&&("ä»“åº“"===t.å½“å‰ä½ç½®||!t.å½“å‰ä½ç½®);return n&&a}).map(([e,t])=>({id:e,...t}));console.info("å¯åˆæˆè§’è‰²æ•°é‡:",t.length,"æ€»è§’è‰²æ•°:",Object.keys(gameState.è§’è‰²ä»“åº“).length),0!==t.length?(t.forEach(({id:t,...n})=>{const a=window.selectedSynthesisChars&&window.selectedSynthesisChars.includes(t),o=document.createElement("div");o.className=`character-list-item rarity-${n.ç¨€æœ‰åº¦}`,o.style.cssText=`\n            padding: 12px;\n            cursor: pointer;\n            border: 2px solid ${a?"var(--primary)":"rgba(139, 92, 246, 0.3)"};\n            background: ${a?"rgba(139, 92, 246, 0.2)":"rgba(30, 41, 59, 0.6)"};\n            opacity: ${a?"1":"0.8"};\n          `,o.innerHTML=`\n            <div style="font-size: 16px; font-weight: bold; margin-bottom: 4px">${n.å§“å}</div>\n            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px">${n.ç¨€æœ‰åº¦} Â· ${n.èŒä¸šèº«ä»½||"æ— "}</div>\n            <div style="font-size: 11px; color: var(--text-secondary)">\n              é­…åŠ›: ${n.å±æ€§?.é­…åŠ›||0} | é¡ºä»: ${n.å±æ€§?.é¡ºä»||0}\n            </div>\n            ${a?'<div style="margin-top: 8px; font-size: 12px; color: var(--primary)">âœ“ å·²é€‰æ‹©</div>':""}\n          `,o.onclick=()=>toggleSynthesisCharacter(t),e.appendChild(o)}),updateSynthesisSelection()):e.innerHTML='<div style="text-align: center; color: var(--text-secondary); padding: 40px">æ²¡æœ‰å¯åˆæˆçš„è§’è‰²ï¼ˆéœ€è¦çŠ¶æ€ä¸º"ç©ºé—²"ä¸”ä½ç½®ä¸º"ä»“åº“"çš„è§’è‰²ï¼‰</div>'}function toggleSynthesisCharacter(e){window.selectedSynthesisChars||(window.selectedSynthesisChars=[]);const t=window.selectedSynthesisChars.indexOf(e);if(t>-1)window.selectedSynthesisChars.splice(t,1);else{if(window.selectedSynthesisChars.length>=5)return void alert("æœ€å¤šåªèƒ½é€‰æ‹©5ä¸ªè§’è‰²ï¼");window.selectedSynthesisChars.push(e)}refreshSynthesisPage()}function updateSynthesisSelection(){const e=document.getElementById("selected-characters"),t=document.getElementById("selected-count"),n=document.getElementById("btn-synthesize");t&&(t.textContent=window.selectedSynthesisChars?window.selectedSynthesisChars.length:0),n&&(n.disabled=!window.selectedSynthesisChars||window.selectedSynthesisChars.length<2),e&&(window.selectedSynthesisChars&&0!==window.selectedSynthesisChars.length?e.innerHTML=window.selectedSynthesisChars.map(e=>{const t=gameState.è§’è‰²ä»“åº“[e];return t?`\n                  <div style="padding: 12px; background: rgba(139, 92, 246, 0.2); border-radius: 8px; border: 1px solid var(--primary); position: relative">\n                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 4px">${t.å§“å}</div>\n                    <div style="font-size: 11px; color: var(--text-secondary)">${t.ç¨€æœ‰åº¦}</div>\n                    <button onclick="toggleSynthesisCharacter('${e}'); event.stopPropagation();" style="position: absolute; top: 4px; right: 4px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; line-height: 1">Ã—</button>\n                  </div>\n                `:""}).join(""):e.innerHTML='<div style="width: 100%; text-align: center; color: var(--text-secondary); padding: 20px">ä»ä¸‹æ–¹é€‰æ‹©è§’è‰²è¿›è¡Œåˆæˆ</div>')}async function confirmSynthesis(){if(!window.selectedSynthesisChars||window.selectedSynthesisChars.length<2)return void alert("è‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªè§’è‰²ï¼");if(window.selectedSynthesisChars.length>5)return void alert("æœ€å¤šåªèƒ½é€‰æ‹©5ä¸ªè§’è‰²ï¼");const e=window.selectedSynthesisChars.map(e=>{const t=gameState.è§’è‰²ä»“åº“[e];return t?`${e}ï¼ˆ${t.å§“å}ï¼‰`:e}).join("ã€");if(!confirm(`ç¡®å®šè¦åˆæˆä»¥ä¸‹è§’è‰²å—ï¼Ÿ\n\n${e}\n\nåˆæˆåè¿™äº›è§’è‰²å°†è¢«æ¶ˆè€—ã€‚`))return;const t=`åˆæˆè§’è‰²ã€‚å°†ä»¥ä¸‹è§’è‰²è¿›è¡Œåˆæˆï¼š${window.selectedSynthesisChars.join("ã€")}ã€‚\n\nè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\n1. æ ¹æ®ç´ æè§’è‰²çš„ç¨€æœ‰åº¦è®¡ç®—æ–°è§’è‰²çš„ç¨€æœ‰åº¦ï¼ˆN+Nâ†’R, R+Râ†’SR, SR+SRâ†’SSR, SSR+SSRâ†’SSR+ï¼‰\n2. èåˆç´ æè§’è‰²çš„ç‰¹å¾ï¼ˆå§“åã€èŒä¸šã€å¤–è²Œã€æ€§æ ¼ã€èƒŒæ™¯æ•…äº‹ç­‰ï¼‰\n3. èåˆç´ æè§’è‰²çš„å±æ€§ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦å–å¹³å‡å€¼æˆ–æ ¹æ®ç¨€æœ‰åº¦æå‡ï¼‰\n4. ç”Ÿæˆæ–°è§’è‰²çš„å®Œæ•´èµ„æ–™ï¼ˆåŒ…æ‹¬ç»˜å›¾æ ‡ç­¾å’Œè‡ªå®šä¹‰å‰ç«¯HTMLï¼‰\n5. åœ¨è§’è‰²ä»“åº“ä¸­æ·»åŠ æ–°è§’è‰²\n6. ä»è§’è‰²ä»“åº“ä¸­ç§»é™¤æ‰€æœ‰ç´ æè§’è‰²\n7. åœ¨åˆæˆè®°å½•ä¸­æ·»åŠ è®°å½•\n\né‡è¦è¦æ±‚ï¼š\n- æ–°è§’è‰²å¿…é¡»å…·æœ‰ç‹¬ç‰¹æ€§å’ŒåŸåˆ›æ€§\n- å¿…é¡»ç”Ÿæˆå®Œæ•´çš„è§’è‰²èµ„æ–™ï¼ˆåŒ…æ‹¬ç»˜å›¾æ ‡ç­¾å’Œè‡ªå®šä¹‰å‰ç«¯HTMLï¼‰\n- å¿…é¡»ä½¿ç”¨JSONPatchæ ¼å¼æ›´æ–°æ¸¸æˆçŠ¶æ€\n- æ–°è§’è‰²çš„ç¨€æœ‰åº¦å¿…é¡»é«˜äºæˆ–ç­‰äºç´ æè§’è‰²çš„æœ€é«˜ç¨€æœ‰åº¦`;closeSynthesis();try{await sendCommandToAI(t),alert("åˆæˆæŒ‡ä»¤å·²å‘é€ï¼Œè¯·ç­‰å¾…AIç”Ÿæˆæ–°è§’è‰²...")}catch(e){console.error("å‘é€åˆæˆæŒ‡ä»¤å¤±è´¥:",e),alert("å‘é€åˆæˆæŒ‡ä»¤å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚")}}function openDecompose(){alert("åˆ†è§£åŠŸèƒ½å¼€å‘ä¸­...")}function openSettings(){alert("è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...")}function openGallery(){switchPage("units")}function refreshAllPages(){refreshHomePage(),refreshSummonPage(),refreshUnitsPage(),refreshBrothelPage()}const init=async()=>{try{await loadGameStateFromMVU(),setupEventListeners(),refreshAllPages(),setInterval(()=>{saveGameStateToMVU()},5e3)}catch(e){console.error("åˆå§‹åŒ–å¤±è´¥:",e)}};"undefined"!=typeof $?$(init):"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init()</script></body></html>