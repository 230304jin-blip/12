<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é»‘æš—å¹»æƒ³æŠ½å¡ç»è¥æ¸¸æˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700;900&family=Inter:wght@400;500;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap');

      /* ==================== Nocturne Deluxe UI (Dark Fantasy) ==================== */
      :root {
        /* fonts */
        --font-ui: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', 'SimHei', sans-serif;
        --font-title: 'Cinzel', 'Noto Serif SC', 'Songti SC', 'SimSun', serif;
        --font-serif: 'Noto Serif SC', 'Songti SC', 'SimSun', serif;

        /* core palette */
        --primary: #c084fc; /* amethyst */
        --primary-dark: #7c3aed;
        --secondary: #fb7185; /* rose */
        --accent: #f6c56a; /* gold */
        --accent-gold: #f6d38b;

        /* surfaces */
        --bg-dark: #06040b;
        --bg-card: rgba(18, 16, 30, 0.72);
        --bg-hover: rgba(26, 24, 44, 0.78);
        --border: rgba(255, 255, 255, 0.08);

        /* text */
        --text-primary: rgba(248, 246, 255, 0.96);
        --text-secondary: rgba(226, 223, 255, 0.68);

        /* feedback */
        --success: #34d399;
        --warning: #fbbf24;
        --danger: #fb7185;

        /* rarity */
        --rarity-n: #9ca3af;
        --rarity-r: #4ade80;
        --rarity-sr: #60a5fa;
        --rarity-ssr: #f6c56a;

        /* sizing + fx */
        --radius-xl: 24px;
        --radius-lg: 18px;
        --radius-md: 14px;
        --blur: 22px;
        --shadow-1: 0 10px 30px rgba(0, 0, 0, 0.45);
        --shadow-2: 0 24px 70px rgba(0, 0, 0, 0.6);
        --glow-primary: 0 0 26px rgba(192, 132, 252, 0.28);
        --glow-gold: 0 0 26px rgba(246, 197, 106, 0.22);
      }

      /* Light theme (parchment) */
      :root[data-theme='light'] {
        --bg-dark: #fbf5e6;
        --bg-card: rgba(255, 255, 255, 0.78);
        --bg-hover: rgba(255, 255, 255, 0.92);
        --border: rgba(37, 28, 18, 0.14);
        --text-primary: rgba(20, 16, 12, 0.92);
        --text-secondary: rgba(20, 16, 12, 0.62);
      }

      /* ==================== å¼ºåˆ¶æ‰‹æœºé€‚é…ï¼ˆè®¾ç½®é¡¹ï¼šé€‚é…æ‰‹æœºç•Œé¢ï¼‰ ==================== */
      :root[data-ui='mobile'] body {
        padding-bottom: 160px;
      }

      :root[data-ui='mobile'] .page {
        padding: 98px 12px 160px;
      }

      :root[data-ui='mobile'] .modal-content {
        padding: 20px;
        margin: 10px;
        width: calc(100% - 20px);
        max-width: 760px;
      }

      :root[data-ui='mobile'] .topbar {
        top: 10px;
        padding: 10px 12px;
        width: calc(100% - 20px);
      }

      :root[data-ui='mobile'] .topbar-brand .title {
        font-size: 12px;
      }

      :root[data-ui='mobile'] .topbar-brand .subtitle {
        display: none;
      }

      :root[data-ui='mobile'] .bottom-nav {
        bottom: 10px;
        width: calc(100% - 20px);
      }

      :root[data-ui='mobile'] .character-list-item {
        flex-direction: column;
        align-items: stretch;
      }

      :root[data-ui='mobile'] .character-list-image {
        width: 100%;
        height: 200px;
        min-width: 100%;
      }

      :root[data-ui='mobile'] .character-list-actions {
        width: 100%;
        flex-direction: column;
      }

      :root[data-ui='mobile'] .character-list-actions .btn {
        width: 100%;
      }

      :root[data-ui='mobile'] .room-grid {
        grid-template-columns: 1fr;
      }

      :root[data-ui='mobile'] .btn {
        padding: 14px 18px;
        font-size: 15px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      ::selection {
        background: rgba(246, 211, 139, 0.28);
        color: var(--text-primary);
      }

      :focus-visible {
        outline: 3px solid rgba(246, 211, 139, 0.28);
        outline-offset: 3px;
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
          scroll-behavior: auto !important;
        }
      }

      body {
        font-family: var(--font-ui);
        background:
          radial-gradient(1200px 800px at 20% -10%, rgba(192, 132, 252, 0.22), transparent 60%),
          radial-gradient(900px 700px at 110% 20%, rgba(246, 197, 106, 0.16), transparent 55%),
          radial-gradient(700px 560px at 30% 120%, rgba(251, 113, 133, 0.14), transparent 60%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent 40%), var(--bg-dark);
        background-attachment: fixed;
        color: var(--text-primary);
        min-height: 100vh;
        height: auto;
        padding-bottom: 140px;
        line-height: 1.75;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
      }

      body::before {
        content: '';
        position: fixed;
        inset: 0;
        pointer-events: none;
        background:
          radial-gradient(900px 520px at 50% -10%, rgba(255, 255, 255, 0.08), transparent 60%),
          radial-gradient(1200px 900px at 50% 120%, rgba(0, 0, 0, 0.75), transparent 60%);
        opacity: 0.9;
        z-index: -2;
      }

      body::after {
        content: '';
        position: fixed;
        inset: 0;
        pointer-events: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
        opacity: 0.08;
        mix-blend-mode: overlay;
        z-index: -1;
      }

      :root[data-theme='light'] body::before {
        opacity: 0.25;
      }

      /* ==================== App shell (Topbar + Dock) ==================== */
      #app {
        position: relative;
      }

      .topbar {
        position: fixed;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        width: min(1100px, calc(100% - 24px));
        z-index: 1200;
        border-radius: var(--radius-xl);
        background: linear-gradient(180deg, rgba(18, 16, 30, 0.82), rgba(18, 16, 30, 0.58));
        border: 1px solid rgba(246, 211, 139, 0.18);
        box-shadow: var(--shadow-2);
        backdrop-filter: blur(var(--blur));
        padding: 12px 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        isolation: isolate;
        overflow: hidden;
      }

      .topbar::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        background:
          radial-gradient(520px 260px at 20% 0%, rgba(246, 211, 139, 0.16), transparent 70%),
          radial-gradient(520px 260px at 80% 0%, rgba(192, 132, 252, 0.14), transparent 70%);
        opacity: 0.8;
        mix-blend-mode: screen;
        z-index: -1;
      }

      .topbar-brand {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
      }

      .topbar-brand .title {
        font-family: var(--font-title);
        letter-spacing: 0.18em;
        font-weight: 900;
        font-size: 13px;
        color: rgba(248, 246, 255, 0.95);
        text-transform: uppercase;
        white-space: nowrap;
      }

      .topbar-brand .subtitle {
        font-family: var(--font-serif);
        font-size: 12px;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .topbar-pills {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.14);
        font-size: 12px;
        color: var(--text-secondary);
      }

      .pill strong {
        color: var(--text-primary);
        font-weight: 700;
        letter-spacing: 0.02em;
      }

      .pill .ico {
        filter: drop-shadow(0 0 10px rgba(246, 211, 139, 0.18));
      }

      /* ==================== ç°ä»£å¡ç‰‡è®¾è®¡ ==================== */
      .card {
        position: relative;
        background: var(--bg-card);
        backdrop-filter: blur(var(--blur));
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        padding: 24px;
        box-shadow: var(--shadow-1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .card::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        background:
          linear-gradient(135deg, rgba(246, 211, 139, 0.16), rgba(192, 132, 252, 0.12), rgba(251, 113, 133, 0.08)),
          radial-gradient(600px 260px at 30% 0%, rgba(255, 255, 255, 0.12), transparent 60%);
        opacity: 0.45;
        mix-blend-mode: screen;
      }

      .card:hover {
        border-color: rgba(246, 211, 139, 0.22);
        box-shadow: var(--shadow-2), var(--glow-primary);
        transform: translateY(-3px);
      }

      /* ==================== ç°ä»£æŒ‰é’® ==================== */
      .btn {
        font-family: var(--font-ui);
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 55%, rgba(246, 197, 106, 0.95) 120%);
        border: 1px solid rgba(255, 255, 255, 0.14);
        color: rgba(255, 255, 255, 0.95);
        padding: 12px 22px;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 700;
        font-size: 14px;
        letter-spacing: 0.02em;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow:
          0 16px 34px rgba(192, 132, 252, 0.18),
          0 10px 22px rgba(0, 0, 0, 0.35),
          inset 0 1px 0 rgba(255, 255, 255, 0.25);
        position: relative;
        overflow: hidden;
        isolation: isolate;
      }

      .btn::before {
        content: '';
        position: absolute;
        inset: -2px;
        background: linear-gradient(120deg, transparent 0%, rgba(255, 255, 255, 0.26) 28%, transparent 55%);
        transform: translateX(-130%);
        transition: transform 0.75s cubic-bezier(0.2, 0.9, 0.2, 1);
        mix-blend-mode: screen;
        z-index: 0;
      }

      .btn::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.18);
        z-index: 1;
      }

      .btn:hover::before {
        transform: translateX(130%);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow:
          0 22px 50px rgba(192, 132, 252, 0.22),
          0 14px 28px rgba(0, 0, 0, 0.35),
          var(--glow-gold),
          inset 0 1px 0 rgba(255, 255, 255, 0.28);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        filter: grayscale(0.2);
      }

      .btn-secondary {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: var(--text-primary);
        box-shadow:
          0 12px 26px rgba(0, 0, 0, 0.28),
          inset 0 1px 0 rgba(255, 255, 255, 0.18);
      }

      .btn-secondary:hover {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.11), rgba(255, 255, 255, 0.05));
        box-shadow:
          0 18px 40px rgba(0, 0, 0, 0.3),
          var(--glow-primary),
          inset 0 1px 0 rgba(255, 255, 255, 0.22);
      }

      /* ==================== Form controls ==================== */
      input,
      select,
      textarea {
        font-family: var(--font-ui);
        background: rgba(255, 255, 255, 0.06) !important;
        border: 1px solid rgba(255, 255, 255, 0.14) !important;
        border-radius: var(--radius-md) !important;
        color: var(--text-primary) !important;
        outline: none;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12);
      }

      input::placeholder,
      textarea::placeholder {
        color: rgba(226, 223, 255, 0.55);
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: rgba(246, 211, 139, 0.35) !important;
        box-shadow:
          0 0 0 4px rgba(192, 132, 252, 0.16),
          inset 0 1px 0 rgba(255, 255, 255, 0.16) !important;
      }

      :root[data-theme='light'] input,
      :root[data-theme='light'] select,
      :root[data-theme='light'] textarea {
        background: rgba(15, 10, 5, 0.04) !important;
        border: 1px solid rgba(37, 28, 18, 0.18) !important;
        color: rgba(20, 16, 12, 0.92) !important;
      }

      /* ==================== ç¨€æœ‰åº¦æ ·å¼ ==================== */
      .rarity-N {
        border-color: var(--rarity-n);
        color: var(--rarity-n);
        box-shadow: 0 0 10px rgba(156, 163, 175, 0.3);
        position: relative !important;
        z-index: auto !important;
        transform: none !important;
      }
      .rarity-R {
        border-color: var(--rarity-r);
        color: var(--rarity-r);
        box-shadow: 0 0 15px rgba(74, 222, 128, 0.4);
        position: relative !important;
        z-index: auto !important;
        transform: none !important;
      }
      .rarity-SR {
        border-color: var(--rarity-sr);
        color: var(--rarity-sr);
        box-shadow: 0 0 20px rgba(96, 165, 250, 0.5);
        position: relative !important;
        z-index: auto !important;
        transform: none !important;
      }
      .rarity-SSR {
        border-color: var(--rarity-ssr);
        color: var(--rarity-ssr);
        box-shadow: 0 0 30px rgba(245, 158, 11, 0.7);
        animation: ssrGlow 2s ease-in-out infinite;
        position: relative !important;
        z-index: auto !important;
        transform: none !important;
      }

      @keyframes ssrGlow {
        0%,
        100% {
          box-shadow: 0 0 30px rgba(245, 158, 11, 0.7);
        }
        50% {
          box-shadow: 0 0 50px rgba(245, 158, 11, 1);
        }
      }

      /* ==================== è§’è‰²å¡ç‰‡ï¼ˆæ–°è®¾è®¡ï¼šä»¥å›¾ç‰‡ä¸ºä¸­å¿ƒï¼‰ ==================== */
      .character-card {
        position: relative;
        border: 2px solid;
        border-radius: 16px;
        overflow: visible;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background: rgba(30, 41, 59, 0.6);
        backdrop-filter: blur(10px);
        padding: 12px;
      }

      .character-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      }

      .character-avatar {
        width: 100%;
        aspect-ratio: 1;
        position: relative;
        overflow: hidden;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        border-radius: 12px;
        margin-bottom: 12px;
        cursor: pointer;
      }

      .character-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .character-image-container {
        width: 100%;
        height: 100%;
        position: relative;
      }

      .character-info {
        text-align: center;
      }

      .character-name {
        font-weight: 700;
        font-size: 15px;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .character-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .character-action-btn {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 8px;
        border: 1px solid rgba(139, 92, 246, 0.3);
        background: rgba(139, 92, 246, 0.1);
        color: var(--primary);
        cursor: pointer;
        transition: all 0.3s;
      }

      .character-action-btn:hover {
        background: rgba(139, 92, 246, 0.2);
        transform: translateY(-2px);
      }

      /* ==================== é¡µé¢å¸ƒå±€ ==================== */
      .page {
        display: none;
        padding: 104px 18px 150px;
        max-width: 1200px;
        margin: 0 auto;
        animation: fadeIn 0.45s ease-out;
        min-height: auto;
        height: auto;
      }

      .page.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ==================== åº•éƒ¨å¯¼èˆª ==================== */
      .bottom-nav {
        position: fixed;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        width: min(760px, calc(100% - 24px));
        background: linear-gradient(180deg, rgba(18, 16, 30, 0.86), rgba(18, 16, 30, 0.62));
        backdrop-filter: blur(var(--blur));
        border: 1px solid rgba(246, 211, 139, 0.16);
        border-radius: 26px;
        display: flex;
        justify-content: space-around;
        padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
        z-index: 1000;
        box-shadow: var(--shadow-2);
        isolation: isolate;
        overflow: hidden;
      }

      .bottom-nav::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        background:
          radial-gradient(420px 180px at 15% 0%, rgba(246, 211, 139, 0.14), transparent 70%),
          radial-gradient(420px 180px at 85% 0%, rgba(192, 132, 252, 0.12), transparent 70%);
        opacity: 0.85;
        mix-blend-mode: screen;
        z-index: -1;
      }

      .nav-item {
        position: relative;
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 10px 10px;
        cursor: pointer;
        color: var(--text-secondary);
        transition: all 0.3s;
        border-radius: 18px;
        min-width: 64px;
        user-select: none;
        z-index: 1;
      }

      .nav-item.active {
        color: var(--text-primary);
      }

      .nav-item:hover {
        color: var(--text-primary);
      }

      .nav-item.active::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(
          135deg,
          rgba(246, 211, 139, 0.14),
          rgba(192, 132, 252, 0.18),
          rgba(251, 113, 133, 0.1)
        );
        border: 1px solid rgba(255, 255, 255, 0.14);
        box-shadow: var(--glow-primary);
        z-index: -1;
      }

      .nav-item.active::after {
        content: '';
        position: absolute;
        top: -7px;
        left: 50%;
        width: 10px;
        height: 10px;
        transform: translateX(-50%);
        border-radius: 50%;
        background: radial-gradient(
          circle at 30% 30%,
          rgba(255, 255, 255, 0.9),
          var(--accent) 55%,
          rgba(246, 197, 106, 0.1) 70%
        );
        box-shadow: var(--glow-gold);
      }

      .nav-item .icon {
        font-size: 24px;
        filter: drop-shadow(0 10px 18px rgba(0, 0, 0, 0.35));
      }

      .nav-item .label {
        font-size: 11px;
        font-weight: 650;
        letter-spacing: 0.04em;
      }

      /* ==================== åˆ—è¡¨å¸ƒå±€ ==================== */
      .character-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 20px 0;
      }

      .character-list-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        background: var(--bg-card);
        border: 2px solid rgba(255, 255, 255, 0.08);
        border-radius: var(--radius-xl);
        transition:
          transform 0.25s cubic-bezier(0.2, 0.8, 0.2, 1),
          box-shadow 0.25s cubic-bezier(0.2, 0.8, 0.2, 1),
          background 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
        backdrop-filter: blur(var(--blur));
        box-shadow: 0 16px 34px rgba(0, 0, 0, 0.25);
      }

      /* é™åˆ¶å‰ç«¯è§’è‰²å¡çš„æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢çªç ´UIç•Œé™ */
      #character-card-display {
        max-width: 100%;
        overflow-x: auto;
        box-sizing: border-box;
      }

      #character-card-display > div {
        max-width: 100%;
        box-sizing: border-box;
        overflow-x: auto;
      }

      #character-card-display * {
        max-width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
        box-sizing: border-box;
      }

      /* å¼ºåˆ¶é™åˆ¶å‰ç«¯è§’è‰²å¡å†…çš„æ‰€æœ‰å…ƒç´  */
      #character-card-display > div > * {
        max-width: 100% !important;
        box-sizing: border-box !important;
      }

      #character-detail-content {
        max-width: 100%;
        overflow-x: auto;
      }

      #character-detail-content > * {
        max-width: 100%;
        box-sizing: border-box;
      }

      /* ç¡®ä¿å‰ç«¯è§’è‰²å¡å†…çš„å…ƒç´ ä¸ä¼šæº¢å‡º */
      #character-detail-content * {
        max-width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .character-list-item:hover {
        background: var(--bg-hover);
        transform: translateY(-2px);
        box-shadow: var(--shadow-1), var(--glow-primary);
      }

      .character-list-image {
        width: 80px;
        height: 80px;
        min-width: 80px;
        border-radius: 8px;
        overflow: hidden;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .character-list-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .character-list-info {
        flex: 1;
        min-width: 0;
      }

      .character-list-name {
        font-size: 18px;
        font-weight: bold;
        color: var(--primary);
        margin-bottom: 4px;
      }

      .character-list-meta {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }

      .character-list-stats {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .character-list-stat-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
      }

      .character-list-stat-bar {
        width: 60px;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
      }

      .character-list-stat-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
        transition: width 0.3s;
      }

      .character-list-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }

      .room-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
        padding: 20px 0;
      }

      /* ==================== æˆ¿é—´å¡ç‰‡ ==================== */
      .room-card {
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        padding: 20px;
        background: var(--bg-card);
        cursor: pointer;
        transition:
          transform 0.28s cubic-bezier(0.2, 0.8, 0.2, 1),
          box-shadow 0.28s cubic-bezier(0.2, 0.8, 0.2, 1),
          background 0.28s cubic-bezier(0.2, 0.8, 0.2, 1);
        backdrop-filter: blur(var(--blur));
        box-shadow: 0 16px 34px rgba(0, 0, 0, 0.35);
      }

      .room-card.occupied {
        background: linear-gradient(180deg, rgba(192, 132, 252, 0.14), rgba(18, 16, 30, 0.72));
      }

      .room-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-2), var(--glow-primary);
      }

      /* ==================== å‰§æƒ…æ˜¾ç¤ºåŒºåŸŸ ==================== */
      .story-container {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        padding: 24px;
        margin: 20px 0;
        min-height: 260px;
        max-height: 600px;
        overflow-y: auto;
        backdrop-filter: blur(var(--blur));
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.08),
          0 18px 46px rgba(0, 0, 0, 0.35);
      }

      .story-content {
        font-family: var(--font-serif);
        line-height: 2.05;
        font-size: 15px;
        color: var(--text-primary);
        white-space: pre-wrap;
        word-wrap: break-word;
        user-select: text;
        -webkit-user-select: text;
        isolation: isolate;
        contain: layout style paint;
        position: relative;
        z-index: 1;
      }

      .story-content img {
        max-width: 100%;
        height: auto;
        border-radius: 12px;
        margin: 15px 0;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      }

      .story-content-isolated {
        all: initial;
        display: block;
        font-family: var(--font-serif);
        line-height: 2.05;
        color: var(--text-primary);
        font-size: 16px;
        isolation: isolate;
        contain: layout style paint;
      }

      .story-content-isolated .story-content {
        font-family: var(--font-serif);
        line-height: 2.05;
        font-size: 15px;
        color: var(--text-primary);
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .story-content-isolated img {
        max-width: 100%;
        height: auto;
        border-radius: 12px;
        margin: 15px 0;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      }

      .story-placeholder {
        text-align: center;
        color: var(--text-secondary);
        font-style: italic;
        padding: 60px 20px;
        font-size: 16px;
      }

      .story-loading {
        text-align: center;
        color: var(--accent-gold);
        padding: 60px 20px;
        font-size: 18px;
      }

      /* ==================== æ—¥å¿— ==================== */
      .log-container {
        max-height: 400px;
        overflow-y: auto;
        padding: 16px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
        border-radius: var(--radius-lg);
        margin-top: 20px;
        border: 1px solid var(--border);
        backdrop-filter: blur(var(--blur));
      }

      .log-entry {
        padding: 12px;
        margin-bottom: 12px;
        border-left: 3px solid rgba(246, 211, 139, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.04);
        border-radius: var(--radius-md);
        font-size: 14px;
        line-height: 1.6;
        transition: all 0.3s;
      }

      .log-entry:hover {
        background: rgba(255, 255, 255, 0.06);
        transform: translateX(3px);
        box-shadow: var(--glow-primary);
      }

      /* ==================== å±æ€§è¿›åº¦æ¡ ==================== */
      .stat-bar {
        height: 8px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 4px;
        overflow: hidden;
        margin: 6px 0;
        position: relative;
      }

      .stat-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
        transition: width 0.6s ease-out;
        border-radius: 4px;
        box-shadow: var(--glow-primary);
      }

      /* ==================== æ¨¡æ€æ¡† ==================== */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
          radial-gradient(900px 560px at 50% -10%, rgba(192, 132, 252, 0.16), rgba(0, 0, 0, 0.88) 65%),
          radial-gradient(900px 560px at 50% 120%, rgba(246, 197, 106, 0.12), rgba(0, 0, 0, 0.92) 70%),
          rgba(0, 0, 0, 0.88);
        z-index: 2000;
        overflow-y: auto;
        padding: 20px;
        backdrop-filter: blur(10px);
        -webkit-overflow-scrolling: touch;
      }

      .modal.active {
        display: block;
        animation: fadeIn 0.3s;
      }

      .modal-content {
        background: linear-gradient(180deg, rgba(18, 16, 30, 0.92), rgba(18, 16, 30, 0.78));
        border: 1px solid rgba(246, 211, 139, 0.18);
        border-radius: var(--radius-xl);
        padding: 32px;
        max-width: 900px;
        width: 100%;
        margin: 20px auto;
        position: relative;
        box-shadow: var(--shadow-2);
        backdrop-filter: blur(var(--blur));
      }

      .modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.14);
        color: var(--text-primary);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }

      .modal-close:hover {
        background: rgba(246, 211, 139, 0.12);
        transform: rotate(90deg) scale(1.02);
        box-shadow: var(--glow-gold);
      }

      /* ==================== æ ‡é¢˜æ ·å¼ ==================== */
      .page-title {
        font-family: var(--font-title);
        font-size: clamp(28px, 4.8vw, 40px);
        color: transparent;
        background: linear-gradient(90deg, var(--accent-gold), var(--primary), var(--secondary));
        -webkit-background-clip: text;
        background-clip: text;
        text-align: center;
        margin-bottom: 26px;
        font-weight: 900;
        letter-spacing: 0.18em;
        text-shadow: none;
        filter: drop-shadow(0 18px 30px rgba(0, 0, 0, 0.45));
        position: relative;
      }

      .page-title::after {
        content: '';
        display: block;
        width: min(240px, 60%);
        height: 2px;
        margin: 14px auto 0;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(246, 211, 139, 0.75),
          rgba(192, 132, 252, 0.65),
          transparent
        );
        box-shadow: var(--glow-gold);
      }

      .section-title {
        font-family: var(--font-serif);
        font-size: 18px;
        color: var(--text-primary);
        margin: 26px 0 14px 0;
        font-weight: 700;
        letter-spacing: 0.08em;
        position: relative;
        padding-left: 14px;
      }

      .section-title::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 6px;
        height: 18px;
        border-radius: 999px;
        background: linear-gradient(180deg, var(--accent-gold), var(--primary));
        box-shadow: var(--glow-primary);
      }

      /* ==================== å“åº”å¼è®¾è®¡ ==================== */
      @media (max-width: 768px) {
        .character-list-item {
          flex-direction: column;
          align-items: stretch;
        }

        .character-list-image {
          width: 100%;
          height: 200px;
          min-width: 100%;
        }

        .character-list-actions {
          width: 100%;
          flex-direction: column;
        }

        .character-list-actions .btn {
          width: 100%;
        }

        .room-grid {
          grid-template-columns: 1fr;
        }

        .page {
          padding: 98px 12px 160px;
        }

        .modal-content {
          padding: 20px;
          margin: 10px;
        }

        .topbar {
          top: 10px;
          padding: 10px 12px;
        }

        .topbar-brand .title {
          font-size: 12px;
        }

        .topbar-brand .subtitle {
          display: none;
        }

        .bottom-nav {
          bottom: 10px;
          width: calc(100% - 20px);
        }
      }

      /* ==================== æ»šåŠ¨æ¡ ==================== */
      ::-webkit-scrollbar {
        width: 10px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.06);
        border-radius: 5px;
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, var(--primary), var(--secondary));
        border-radius: 5px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- é¡¶éƒ¨çŠ¶æ€æ ï¼ˆå…¨å±€ HUDï¼‰ -->
      <div class="topbar">
        <div class="topbar-brand">
          <div class="title">é»‘æš—å¹»æƒ³</div>
          <div class="subtitle">Nocturne House Â· æŠ½å¡ç»è¥</div>
        </div>
        <div class="topbar-pills">
          <div class="pill" title="è´§å¸">
            <span class="ico">ğŸ’°</span>
            <strong id="topbar-currency">0</strong>
          </div>
          <div class="pill" title="æ—¶é—´">
            <span class="ico">â³</span>
            <strong id="topbar-time">ç¬¬1å¤© æ—©ä¸Š</strong>
            <span id="topbar-round" style="color: var(--text-secondary)">Â· å›åˆ 1</span>
          </div>
        </div>
      </div>

      <!-- é¦–é¡µ -->
      <div id="page-home" class="page active">
        <div class="card">
          <h1 class="page-title">ğŸ° é»‘æš—å¹»æƒ³ç»è¥æ¸¸æˆ</h1>

          <div
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: 20px;
              margin-top: 30px;
            "
          >
            <div class="card" style="text-align: center; padding: 20px">
              <div style="font-size: 36px; margin-bottom: 12px">ğŸ’°</div>
              <div style="font-size: 28px; font-weight: bold; color: var(--accent-gold)" id="home-currency">1000</div>
              <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px">è´§å¸</div>
            </div>

            <div class="card" style="text-align: center; padding: 20px">
              <div style="font-size: 36px; margin-bottom: 12px">ğŸ‘¥</div>
              <div style="font-size: 28px; font-weight: bold; color: var(--primary)" id="home-characters">0</div>
              <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px">è§’è‰²æ•°é‡</div>
            </div>

            <div class="card" style="text-align: center; padding: 20px">
              <div style="font-size: 36px; margin-bottom: 12px">ğŸ“Š</div>
              <div style="font-size: 28px; font-weight: bold; color: var(--accent-gold)" id="home-income">0</div>
              <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px">ä»Šæ—¥æ”¶å…¥</div>
            </div>

            <div class="card" style="text-align: center; padding: 20px">
              <div style="font-size: 36px; margin-bottom: 12px">â±ï¸</div>
              <div style="font-size: 24px; font-weight: bold; color: var(--primary)" id="home-time">ç¬¬1å¤© æ—©ä¸Š</div>
              <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px" id="home-round">å›åˆ: 1</div>
            </div>
          </div>

          <div style="margin-top: 30px">
            <h2 class="section-title">å¿«æ·æ“ä½œ</h2>
            <div style="display: flex; gap: 16px; flex-wrap: wrap">
              <button class="btn" onclick="switchPage('summon')">ğŸ´ ç«‹å³æŠ½å¡</button>
              <button class="btn" onclick="switchPage('units')">ğŸ“¦ æŸ¥çœ‹ä»“åº“</button>
              <button class="btn" onclick="switchPage('brothel')">ğŸ›ï¸ ç»è¥å¦“é™¢</button>
              <button
                class="btn"
                onclick="advanceRound()"
                style="background: linear-gradient(135deg, var(--accent) 0%, var(--accent-gold) 100%)"
              >
                â­ï¸ ä¸‹ä¸€å›åˆ
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- æŠ½å¡é¡µé¢ -->
      <div id="page-summon" class="page">
        <div class="card">
          <h1 class="page-title">ğŸ´ å¬å”¤ä»ªå¼</h1>

          <div style="text-align: center; margin-bottom: 40px">
            <div style="font-size: 56px; margin-bottom: 16px">ğŸ’°</div>
            <div style="font-size: 40px; font-weight: bold; color: var(--accent-gold)" id="summon-currency">1000</div>
            <div style="font-size: 16px; color: var(--text-secondary); margin-top: 8px">å½“å‰è´§å¸</div>
          </div>

          <!-- é™å®šå¡æ±  Banner -->
          <div
            id="limited-banner"
            style="
              margin: 0 0 24px 0;
              padding: 18px;
              border-radius: 22px;
              border: 1px solid rgba(246, 211, 139, 0.18);
              background: linear-gradient(
                135deg,
                rgba(246, 211, 139, 0.12),
                rgba(192, 132, 252, 0.12),
                rgba(251, 113, 133, 0.08)
              );
              box-shadow: var(--shadow-1);
              backdrop-filter: blur(var(--blur));
            "
          >
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 14px; flex-wrap: wrap">
              <div style="min-width: 220px; flex: 1">
                <div style="font-size: 12px; color: var(--text-secondary); letter-spacing: 0.12em; margin-bottom: 8px">
                  ğŸ•¯ï¸ æœ¬æœŸé™å®šè¯æ¡ï¼ˆæ¯3å¤©åˆ·æ–°ï¼‰
                </div>
                <div id="limited-tags" style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center"></div>
                <div id="limited-refresh" style="margin-top: 10px; font-size: 12px; color: var(--text-secondary)"></div>
              </div>

              <button class="btn" id="btn-limited" onclick="handleSummon('é™å®šå¡æ± ')" style="padding: 14px 18px">
                ğŸ•¯ï¸ é™å®šæŠ½å¡ Â· 250 é‡‘
              </button>
            </div>
          </div>

          <div
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: 20px;
              margin-bottom: 40px;
            "
          >
            <button class="btn" onclick="handleSummon('å•æŠ½')" id="btn-single" style="padding: 24px">
              <div style="font-size: 32px; margin-bottom: 12px">âœ¨</div>
              <div style="font-size: 18px; margin-bottom: 8px">å•æŠ½</div>
              <div style="font-size: 14px; opacity: 0.8">250 é‡‘</div>
            </button>

            <button class="btn" onclick="handleSummon('é—ªå…‰æŠ½å¡')" id="btn-flash" style="padding: 24px">
              <div style="font-size: 32px; margin-bottom: 12px">ğŸ’«</div>
              <div style="font-size: 18px; margin-bottom: 8px">é—ªå…‰æŠ½å¡</div>
              <div style="font-size: 14px; opacity: 0.8">3000 é‡‘ (SSR)</div>
            </button>

            <button class="btn" onclick="showTargetSummonInput()" id="btn-target" style="padding: 24px">
              <div style="font-size: 32px; margin-bottom: 12px">ğŸ¯</div>
              <div style="font-size: 18px; margin-bottom: 8px">å®šå‘æŠ½å¡</div>
              <div style="font-size: 14px; opacity: 0.8">1500 é‡‘</div>
            </button>
          </div>

          <!-- æŠ½å¡ç»“æœå±•ç¤ºåŒº -->
          <div id="summon-results" style="min-height: 200px"></div>

          <!-- è§’è‰²å¡å±•ç¤ºåŒºï¼ˆç”¨äºæ˜¾ç¤ºå¸¦å‰ç«¯çš„è§’è‰²å¡ï¼‰ -->
          <div id="character-card-display" style="display: none; margin-top: 30px"></div>
        </div>
      </div>

      <!-- è§’è‰²ä»“åº“é¡µé¢ -->
      <div id="page-units" class="page">
        <div>
          <h1 class="page-title">ğŸ“¦ è§’è‰²ä»“åº“</h1>

          <div class="card" style="margin-bottom: 24px; display: flex; gap: 16px; flex-wrap: wrap">
            <input
              type="text"
              id="search-input"
              placeholder="æœç´¢è§’è‰²..."
              style="
                flex: 1;
                min-width: 200px;
                padding: 12px;
                background: rgba(15, 23, 42, 0.5);
                border: 1px solid rgba(139, 92, 246, 0.3);
                border-radius: 12px;
                color: var(--text-primary);
                font-size: 14px;
              "
            />
            <select
              id="filter-rarity"
              style="
                padding: 12px;
                background: rgba(15, 23, 42, 0.5);
                border: 1px solid rgba(139, 92, 246, 0.3);
                border-radius: 12px;
                color: var(--text-primary);
                font-size: 14px;
                min-width: 150px;
              "
            >
              <option value="">å…¨éƒ¨ç¨€æœ‰åº¦</option>
              <option value="N">N</option>
              <option value="R">R</option>
              <option value="SR">SR</option>
              <option value="SSR">SSR</option>
              <option value="SSR+">SSR+</option>
              <option value="SSR++">SSR++</option>
              <option value="UR">UR</option>
            </select>
          </div>

          <div id="character-list" class="character-grid"></div>
        </div>

        <!-- è§’è‰²è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div id="character-detail-modal" class="modal">
          <div class="modal-content">
            <button class="modal-close" onclick="closeCharacterDetail()">Ã—</button>
            <div id="character-detail-content"></div>
          </div>
        </div>
      </div>

      <!-- å¦“é™¢ç»è¥é¡µé¢ -->
      <div id="page-brothel" class="page">
        <div>
          <h1 class="page-title">ğŸ›ï¸ å¦“é™¢ç»è¥</h1>

          <div
            class="card"
            style="
              margin-bottom: 24px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              flex-wrap: wrap;
              gap: 16px;
            "
          >
            <div>
              <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">è¥ä¸šçŠ¶æ€</div>
              <div style="font-size: 24px; font-weight: bold; color: var(--primary)" id="brothel-status">è¥ä¸šä¸­</div>
            </div>
            <div>
              <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px">ä»Šæ—¥æ”¶å…¥</div>
              <div style="font-size: 24px; font-weight: bold; color: var(--accent-gold)" id="brothel-income">0</div>
            </div>
            <button class="btn" onclick="toggleBrothelStatus()" id="btn-toggle-status">æš‚åœè¥ä¸š</button>
          </div>

          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px">
            <h2 class="section-title" style="margin: 0">æˆ¿é—´ç®¡ç†</h2>
            <div style="display: flex; gap: 8px">
              <button class="btn btn-secondary" onclick="showRoomShop()" style="padding: 8px 16px; font-size: 14px">
                ğŸ—ï¸ è´­ä¹°æˆ¿é—´
              </button>
            </div>
          </div>
          <div id="room-list" class="room-grid"></div>

          <h2 class="section-title">ç©ºé—²è§’è‰²</h2>
          <div id="available-characters" class="character-grid"></div>

          <h2 class="section-title">å½“å‰äº’åŠ¨å‰§æƒ…</h2>
          <div
            id="brothel-story"
            class="story-container"
            style="isolation: isolate; contain: layout style paint; position: relative; z-index: 1"
          >
            <div
              id="brothel-story-content"
              class="story-content"
              style="
                isolation: isolate;
                contain: layout style paint;
                position: relative;
                z-index: 1;
                user-select: text;
                -webkit-user-select: text;
              "
            >
              <div class="story-placeholder">ç‚¹å‡»æˆ¿é—´æˆ–è§’è‰²å¼€å§‹äº’åŠ¨ï¼ŒAI ç”Ÿæˆçš„å‰§æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
            </div>
          </div>

          <h2 class="section-title">äº‹ä»¶æ—¥å¿—</h2>
          <div id="brothel-logs" class="log-container"></div>
        </div>
      </div>

      <!-- æ›´å¤šé¡µé¢ -->
      <div id="page-more" class="page">
        <div>
          <h1 class="page-title">âš™ï¸ æ›´å¤šåŠŸèƒ½</h1>

          <div
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
              gap: 20px;
              margin-bottom: 32px;
            "
          >
            <div class="card" style="cursor: pointer; text-align: center" onclick="openSynthesis()">
              <div style="font-size: 48px; margin-bottom: 16px">ğŸ”¬</div>
              <h3 style="font-size: 20px; color: var(--primary); margin-bottom: 8px">è§’è‰²åˆæˆ</h3>
              <p style="font-size: 14px; color: var(--text-secondary)">åˆæˆè§’è‰²æå‡ç¨€æœ‰åº¦</p>
            </div>

            <div class="card" style="cursor: pointer; text-align: center" onclick="openDecompose()">
              <div style="font-size: 48px; margin-bottom: 16px">âš¡</div>
              <h3 style="font-size: 20px; color: var(--primary); margin-bottom: 8px">è§’è‰²åˆ†è§£</h3>
              <p style="font-size: 14px; color: var(--text-secondary)">åˆ†è§£è§’è‰²è·å¾—èµ„æº</p>
            </div>

            <div class="card" style="cursor: pointer; text-align: center" onclick="openSettings()">
              <div style="font-size: 48px; margin-bottom: 16px">âš™ï¸</div>
              <h3 style="font-size: 20px; color: var(--primary); margin-bottom: 8px">æ¸¸æˆè®¾ç½®</h3>
              <p style="font-size: 14px; color: var(--text-secondary)">è°ƒæ•´æ¸¸æˆå‚æ•°</p>
            </div>
          </div>

          <!-- å­˜æ¡£ç®¡ç† -->
          <div class="card" style="margin-bottom: 24px">
            <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">ğŸ’¾ å­˜æ¡£ç®¡ç†</h3>
            <div style="display: flex; flex-direction: column; gap: 12px">
              <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px">
                  é˜²æ­¢AIå‡ºbugå¯¼è‡´æ¸¸æˆæ­»æœºï¼Œå¯ä»¥æ‰‹åŠ¨ä¿å­˜å’ŒåŠ è½½å­˜æ¡£
                </div>
                <div id="save-slots" style="display: flex; flex-direction: column; gap: 8px">
                  <!-- å­˜æ¡£æ§½ä½ä¼šåŠ¨æ€ç”Ÿæˆ -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
      <div class="nav-item active" onclick="switchPage('home')">
        <div class="icon">ğŸ </div>
        <div class="label">é¦–é¡µ</div>
      </div>
      <div class="nav-item" onclick="switchPage('summon')">
        <div class="icon">ğŸ´</div>
        <div class="label">æŠ½å¡</div>
      </div>
      <div class="nav-item" onclick="switchPage('units')">
        <div class="icon">ğŸ‘¥</div>
        <div class="label">è§’è‰²</div>
      </div>
      <div class="nav-item" onclick="switchPage('brothel')">
        <div class="icon">ğŸ›ï¸</div>
        <div class="label">ç»è¥</div>
      </div>
      <div class="nav-item" onclick="switchPage('more')">
        <div class="icon">âš™ï¸</div>
        <div class="label">æ›´å¤š</div>
      </div>
    </div>

    <script>
      // ==================== å…¨å±€çŠ¶æ€ç®¡ç† ====================
      let gameState = {
        è´§å¸: 5000,
        è§’è‰²ä»“åº“: {},
        å¦“é™¢: {
          å½“å‰æ¥å®¢è§’è‰²: {},
          å½“å‰è°ƒæ•™è§’è‰²: {},
          è¥ä¸šçŠ¶æ€: 'è¥ä¸šä¸­',
          æˆ¿é—´çŠ¶æ€: {
            101: { ç±»å‹: 'æ™®é€š', çŠ¶æ€: 'ç©ºé—²', ç­‰çº§: 1, æ”¶å…¥å€ç‡: 1.0, è§£é”: true },
            102: { ç±»å‹: 'æ™®é€š', çŠ¶æ€: 'ç©ºé—²', ç­‰çº§: 1, æ”¶å…¥å€ç‡: 1.0, è§£é”: true },
            VIP1: { ç±»å‹: 'VIP', çŠ¶æ€: 'ç©ºé—²', ç­‰çº§: 1, æ”¶å…¥å€ç‡: 1.5, è§£é”: true },
          },
          ä»Šæ—¥æ”¶å…¥: 0,
          å†å²æ€»æ”¶å…¥: 0,
          äº‹ä»¶æ—¥å¿—: [],
        },
        å¡æ± : {
          é™å®š: {
            è¯æ¡: ['â€”', 'â€”'],
            å‘¨æœŸ: -1, // floor((å¤©æ•°-1)/3)
          },
        },
        è®¾ç½®: {
          è‡ªåŠ¨è¥ä¸š: false,
          æ”¶ç›Šå€ç‡: 1,
          ç»éªŒå€ç‡: 1,
          æœ€å¤§è§’è‰²æ•°é‡: 100,
          è‡ªåŠ¨é…å›¾: true,
        },
        ç»Ÿè®¡æ•°æ®: {
          æ€»æŠ½å¡æ¬¡æ•°: 0,
          æ€»è·å¾—è§’è‰²: 0,
          æ€»æ¥å®¢æ¬¡æ•°: 0,
          æ€»æ”¶å…¥: 0,
          æ¸¸æˆæ—¶é—´: 0,
          è§’è‰²åˆ†å¸ƒ: { N: 0, R: 0, SR: 0, SSR: 0, 'SSR+': 0, 'SSR++': 0, UR: 0 },
          æƒ…æ„Ÿåˆ†å¸ƒ: { çˆ±: 0, å–œæ¬¢: 0, ä¸­ç«‹: 0, åŒæ¶: 0, æ†æ¨: 0 },
        },
        æ¸¸æˆæ—¶é—´: {
          å½“å‰å›åˆ: 1,
          å½“å‰æ—¶æ®µ: 'æ—©ä¸Š', // æ—©ä¸Šã€ä¸­åˆã€æ™šä¸Š
          å¤©æ•°: 1,
        },
        å¾…å¤„ç†åˆ†é…: [], // å­˜å‚¨å¾…å¤„ç†çš„è§’è‰²åˆ†é…æ“ä½œ
      };

      // ==================== å…¬å…±å·¥å…·å‡½æ•° ====================
      /**
       * åˆ›å»ºæ¨¡æ€æ¡†ï¼ˆç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ¨¡æ€æ¡†ï¼‰
       * @param {string} id - æ¨¡æ€æ¡†ID
       * @param {string} title - æ ‡é¢˜
       * @param {string} content - HTMLå†…å®¹
       * @param {Function} onClose - å…³é—­å›è°ƒ
       * @param {Object} options - é€‰é¡¹ {maxWidth, zIndex, showCloseButton}
       */
      function createModal(id, title, content, onClose = null, options = {}) {
        // å¦‚æœæ¨¡æ€æ¡†å·²å­˜åœ¨ï¼Œå…ˆç§»é™¤
        const existing = document.getElementById(id);
        if (existing) {
          existing.remove();
        }

        const { maxWidth = '900px', zIndex = 2000, showCloseButton = true } = options;
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = id;
        modal.style.zIndex = zIndex;

        const closeButton = showCloseButton
          ? `<button class="modal-close" onclick="closeModal('${id}')">Ã—</button>`
          : '';

        modal.innerHTML = `
          <div class="modal-content" style="max-width: ${maxWidth}">
            ${closeButton}
            ${title ? `<h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">${title}</h2>` : ''}
            ${content}
          </div>
        `;

        document.body.appendChild(modal);
        // ä½¿ç”¨requestAnimationFrameç¡®ä¿DOMå·²æ›´æ–°
        requestAnimationFrame(() => {
          modal.classList.add('active');
        });

        // å­˜å‚¨å…³é—­å›è°ƒ
        if (onClose) {
          modal._onClose = onClose;
        }

        return modal;
      }

      /**
       * å…³é—­æ¨¡æ€æ¡†ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
       * @param {string} id - æ¨¡æ€æ¡†ID
       */
      function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
          modal.classList.remove('active');
          // æ‰§è¡Œå…³é—­å›è°ƒ
          if (modal._onClose) {
            modal._onClose();
          }
          setTimeout(() => modal.remove(), 300);
        }
      }

      /**
       * å®‰å…¨è·å–è§’è‰²æ•°æ®
       * @param {string} characterId - è§’è‰²ID
       * @returns {Object|null} è§’è‰²å¯¹è±¡æˆ–null
       */
      function getCharacter(characterId) {
        if (!characterId || !gameState.è§’è‰²ä»“åº“) return null;
        const char = gameState.è§’è‰²ä»“åº“[characterId];
        if (char) {
          normalizeCharacter(char);
        }
        return char || null;
      }

      /**
       * å®‰å…¨è·å–æˆ¿é—´æ•°æ®
       * @param {string} roomId - æˆ¿é—´ID
       * @returns {Object|null} æˆ¿é—´å¯¹è±¡æˆ–null
       */
      function getRoom(roomId) {
        if (!roomId || !gameState.å¦“é™¢?.æˆ¿é—´çŠ¶æ€) return null;
        return gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[roomId] || null;
      }

      /**
       * é˜²æŠ–ä¿å­˜å‡½æ•°
       */
      let saveDebounceTimer = null;
      function debouncedSave() {
        if (saveDebounceTimer) {
          clearTimeout(saveDebounceTimer);
        }
        saveDebounceTimer = setTimeout(() => {
          saveGameStateToMVU();
          saveDebounceTimer = null;
        }, 2000); // 2ç§’é˜²æŠ–
      }

      /**
       * ç«‹å³ä¿å­˜ï¼ˆç”¨äºå…³é”®æ“ä½œï¼‰
       */
      function saveImmediately() {
        if (saveDebounceTimer) {
          clearTimeout(saveDebounceTimer);
          saveDebounceTimer = null;
        }
        saveGameStateToMVU();
      }

      /**
       * æ™ºèƒ½åˆ·æ–°é¡µé¢ï¼ˆåªåˆ·æ–°å¯è§é¡µé¢å’Œå¿…è¦é¡µé¢ï¼‰
       * @param {boolean} forceAll - æ˜¯å¦å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰é¡µé¢
       */
      let refreshDebounceTimer = null;
      function smartRefreshPages(forceAll = false) {
        // ç»Ÿä¸€åšæ•°æ®çº é”™/è¡¥å…¨
        updateLimitedPoolIfNeeded();
        normalizeAllCharacters();
        validateDataConsistency();

        // é˜²æŠ–ï¼šé¿å…é¢‘ç¹åˆ·æ–°
        if (refreshDebounceTimer) {
          clearTimeout(refreshDebounceTimer);
        }

        refreshDebounceTimer = setTimeout(() => {
          if (forceAll) {
            // å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰é¡µé¢
            refreshHomePage();
            refreshSummonPage();
            refreshUnitsPage();
            refreshBrothelPage();
          } else {
            // æ™ºèƒ½åˆ·æ–°ï¼šåªåˆ·æ–°å¯è§é¡µé¢
            const activePage = document.querySelector('.page.active');
            if (activePage) {
              const pageId = activePage.id;
              switch (pageId) {
                case 'home-page':
                  refreshHomePage();
                  break;
                case 'summon-page':
                  refreshSummonPage();
                  break;
                case 'units-page':
                  refreshUnitsPage();
                  break;
                case 'brothel-page':
                  refreshBrothelPage();
                  break;
                default:
                  // é»˜è®¤åˆ·æ–°æ‰€æœ‰é¡µé¢
                  refreshHomePage();
                  refreshSummonPage();
                  refreshUnitsPage();
                  refreshBrothelPage();
              }
            } else {
              // æ²¡æœ‰æ´»åŠ¨é¡µé¢ï¼Œåˆ·æ–°æ‰€æœ‰
              refreshHomePage();
              refreshSummonPage();
              refreshUnitsPage();
              refreshBrothelPage();
            }
          }
          refreshDebounceTimer = null;
        }, 50); // 50msé˜²æŠ–ï¼Œç¡®ä¿å¿«é€Ÿå“åº”
      }

      // ==================== é¡µé¢åˆ‡æ¢ ====================
      function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });

        const targetPage = document.getElementById(`page-${pageId}`);
        if (targetPage) {
          targetPage.classList.add('active');
          // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨ï¼Œé¿å…æ˜¾ç¤ºä¹‹å‰é¡µé¢çš„ç©ºç™½åŒºåŸŸ
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.querySelectorAll('.nav-item').forEach((item, index) => {
          item.classList.remove('active');
        });

        const navMap = { home: 0, summon: 1, units: 2, brothel: 3, more: 4 };
        const navItems = document.querySelectorAll('.nav-item');
        if (navMap[pageId] !== undefined && navItems[navMap[pageId]]) {
          navItems[navMap[pageId]].classList.add('active');
        }

        refreshPageData(pageId);

        // å¼ºåˆ¶é‡æ–°è®¡ç®—bodyé«˜åº¦ï¼Œé¿å…ä¿ç•™ä¹‹å‰é•¿é¡µé¢çš„é«˜åº¦
        setTimeout(() => {
          document.body.style.height = 'auto';
          document.body.style.minHeight = '100vh';
        }, 100);
      }

      function refreshPageData(pageId) {
        // HUD ä¸å…³é”®æ•°æ®å§‹ç»ˆåˆ·æ–°ï¼ˆä¸ç®¡å½“å‰é¡µé¢ï¼‰
        updateLimitedPoolIfNeeded();
        normalizeAllCharacters();
        refreshHomePage();
        switch (pageId) {
          case 'home':
            break;
          case 'summon':
            refreshSummonPage();
            break;
          case 'units':
            refreshUnitsPage();
            break;
          case 'brothel':
            refreshBrothelPage();
            break;
          case 'more':
            refreshMorePage();
            break;
        }
      }

      // ==================== æ•°æ®åˆ·æ–° ====================
      function refreshHomePage() {
        document.getElementById('home-currency').textContent = gameState.è´§å¸;
        document.getElementById('home-characters').textContent = Object.keys(gameState.è§’è‰²ä»“åº“).length;
        document.getElementById('home-income').textContent = gameState.å¦“é™¢.ä»Šæ—¥æ”¶å…¥;
        const gameTime = getGameTime();
        const timeText = `ç¬¬${gameTime.å¤©æ•° || 1}å¤© ${gameTime.å½“å‰æ—¶æ®µ || 'æ—©ä¸Š'}`;
        const roundText = `å›åˆ: ${gameTime.å½“å‰å›åˆ || 1}`;
        document.getElementById('home-time').textContent = timeText;
        document.getElementById('home-round').textContent = roundText;

        // é¡¶éƒ¨ HUD
        const topCurrency = document.getElementById('topbar-currency');
        if (topCurrency) topCurrency.textContent = String(gameState.è´§å¸ ?? 0);
        const topTime = document.getElementById('topbar-time');
        if (topTime) topTime.textContent = timeText;
        const topRound = document.getElementById('topbar-round');
        if (topRound) topRound.textContent = `Â· å›åˆ ${gameTime.å½“å‰å›åˆ || 1}`;
      }

      function refreshSummonPage() {
        document.getElementById('summon-currency').textContent = gameState.è´§å¸;

        // é™å®šå¡æ± å±•ç¤º/åˆ·æ–°
        const limited = updateLimitedPoolIfNeeded();
        const tagsEl = document.getElementById('limited-tags');
        const refreshEl = document.getElementById('limited-refresh');
        if (tagsEl) {
          tagsEl.innerHTML = (limited?.è¯æ¡ || ['â€”', 'â€”'])
            .map(
              t => `
                    <span style="
                      display: inline-flex;
                      align-items: center;
                      padding: 8px 12px;
                      border-radius: 999px;
                      border: 1px solid rgba(255,255,255,0.14);
                      background: rgba(255,255,255,0.06);
                      color: var(--text-primary);
                      font-family: var(--font-serif);
                      font-weight: 700;
                      letter-spacing: 0.04em;
                    ">${t}</span>
                  `,
            )
            .join('');
        }
        if (refreshEl) {
          const day = getGameTime().å¤©æ•° || 1;
          const daysLeft = 3 - ((day - 1) % 3);
          refreshEl.textContent = `ç¬¬${day}å¤© Â· è·ç¦»ä¸‹æ¬¡åˆ·æ–°è¿˜æœ‰ ${daysLeft} å¤©ï¼ˆç¬¬${day + daysLeft}å¤©åˆ·æ–°ï¼‰`;
        }

        const costs = { å•æŠ½: 250, é™å®šå¡æ± : 250, é—ªå…‰æŠ½å¡: 3000, å®šå‘æŠ½å¡: 1500 };
        Object.keys(costs).forEach(type => {
          let btnId;
          if (type === 'å•æŠ½') btnId = 'single';
          else if (type === 'é—ªå…‰æŠ½å¡') btnId = 'flash';
          else if (type === 'é™å®šå¡æ± ') btnId = 'limited';
          else btnId = 'target';

          const btn = document.getElementById(`btn-${btnId}`);
          if (btn) {
            btn.disabled = gameState.è´§å¸ < costs[type];
          }
        });
      }

      function refreshUnitsPage() {
        const container = document.getElementById('character-list');
        if (!container) {
          console.error('è§’è‰²åˆ—è¡¨å®¹å™¨ä¸å­˜åœ¨');
          return;
        }

        try {
          // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
          const scrollTop = container.scrollTop;

          // æ¸…ç©ºå®¹å™¨
          container.innerHTML = '';

          const searchTerm = (document.getElementById('search-input')?.value || '').toLowerCase();
          const filterRarity = document.getElementById('filter-rarity')?.value || '';

          // æ£€æŸ¥è§’è‰²ä»“åº“æ˜¯å¦å­˜åœ¨
          if (!gameState.è§’è‰²ä»“åº“ || typeof gameState.è§’è‰²ä»“åº“ !== 'object') {
            console.warn('è§’è‰²ä»“åº“ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯:', gameState.è§’è‰²ä»“åº“);
            container.innerHTML =
              '<div style="text-align: center; padding: 40px; color: var(--text-secondary)">æš‚æ— è§’è‰²</div>';
            return;
          }

          const characters = Object.entries(gameState.è§’è‰²ä»“åº“);
          console.info(`åˆ·æ–°è§’è‰²ä»“åº“ï¼Œå…± ${characters.length} ä¸ªè§’è‰²`);

          if (characters.length === 0) {
            container.innerHTML =
              '<div style="text-align: center; padding: 40px; color: var(--text-secondary)">æš‚æ— è§’è‰²ï¼Œå»æŠ½å¡å§ï¼</div>';
            return;
          }

          characters.forEach(([id, char]) => {
            try {
              if (!char || typeof char !== 'object') {
                console.warn(`è§’è‰² ${id} æ•°æ®æ ¼å¼é”™è¯¯:`, char);
                return;
              }

              if (searchTerm && (!char.å§“å || !char.å§“å.toLowerCase().includes(searchTerm))) return;
              if (filterRarity && char.ç¨€æœ‰åº¦ !== filterRarity) return;

              // è°ƒè¯•ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ç»˜å›¾æ ‡ç­¾
              if (char.ç»˜å›¾æ ‡ç­¾) {
                console.info(`è§’è‰² ${char.å§“å} çš„ç»˜å›¾æ ‡ç­¾:`, char.ç»˜å›¾æ ‡ç­¾.substring(0, 100));
              }

              const card = createCharacterCard(id, char);
              if (card) {
                container.appendChild(card);
              } else {
                console.error(`åˆ›å»ºè§’è‰²å¡ç‰‡å¤±è´¥: ${id}`);
              }
            } catch (error) {
              console.error(`å¤„ç†è§’è‰² ${id} æ—¶å‡ºé”™:`, error);
            }
          });

          // æ¢å¤æ»šåŠ¨ä½ç½®
          container.scrollTop = scrollTop;
        } catch (error) {
          console.error('åˆ·æ–°è§’è‰²ä»“åº“é¡µé¢å¤±è´¥:', error);
          container.innerHTML =
            '<div style="text-align: center; padding: 40px; color: var(--danger)">åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</div>';
        }
      }

      function refreshMorePage() {
        // åˆ·æ–°å­˜æ¡£æ§½ä½æ˜¾ç¤º
        refreshSaveSlots();
      }

      function refreshBrothelPage() {
        if (!document.getElementById('brothel-status')) return;

        if (!gameState.å¦“é™¢) gameState.å¦“é™¢ = {};
        if (!gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€) gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€ = 'è¥ä¸šä¸­';
        document.getElementById('brothel-status').textContent = gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€;
        document.getElementById('brothel-income').textContent = gameState.å¦“é™¢.ä»Šæ—¥æ”¶å…¥;
        document.getElementById('btn-toggle-status').textContent =
          gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€ === 'è¥ä¸šä¸­' ? 'æš‚åœè¥ä¸š' : 'å¼€å§‹è¥ä¸š';

        const roomContainer = document.getElementById('room-list');
        if (roomContainer) {
          roomContainer.innerHTML = '';
          Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).forEach(([roomId, room]) => {
            const roomCard = createRoomCard(roomId, room);
            roomContainer.appendChild(roomCard);
          });
        }

        const charContainer = document.getElementById('available-characters');
        if (charContainer) {
          charContainer.innerHTML = '';
          Object.entries(gameState.è§’è‰²ä»“åº“).forEach(([id, char]) => {
            if (char.çŠ¶æ€ === 'ç©ºé—²' && char.å½“å‰ä½ç½® === 'ä»“åº“') {
              const card = createCharacterCard(id, char, true);
              charContainer.appendChild(card);
            }
          });
        }

        const logContainer = document.getElementById('brothel-logs');
        if (logContainer) {
          logContainer.innerHTML = '';
          gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—
            .slice(-20)
            .reverse()
            .forEach(log => {
              const entry = document.createElement('div');
              entry.className = 'log-entry';
              const timeLabel =
                typeof log.æ—¶é—´æˆ³ === 'number' && log.æ—¶é—´æˆ³ < 1000000000000
                  ? `ç¬¬${log.æ—¶é—´æˆ³}å›åˆ`
                  : new Date(log.æ—¶é—´æˆ³).toLocaleString();
              entry.innerHTML = `
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">${timeLabel}</div>
                  <div><strong>${log.è§’è‰²ID}</strong>: ${log.æè¿°}</div>
                  ${log.æ”¶å…¥å˜åŒ– > 0 ? `<div style="color: var(--accent-gold); margin-top: 4px">+${log.æ”¶å…¥å˜åŒ–} é‡‘</div>` : ''}
                `;
              logContainer.appendChild(entry);
            });
        }
      }

      // ==================== JSON å­—ç¬¦ä¸²æ¸…ç†ï¼ˆç§»é™¤ Markdown ä»£ç å—æ ‡è®°ç­‰ï¼‰====================
      function cleanJsonString(str) {
        if (!str) return str;
        // ç§»é™¤ Markdown ä»£ç å—æ ‡è®°
        let cleaned = str.replace(/```json\s*/gi, '');
        cleaned = cleaned.replace(/```\s*/g, '');
        // ç§»é™¤å¼€å¤´çš„ç©ºç™½
        cleaned = cleaned.trim();
        // å¦‚æœä¸æ˜¯ä»¥ [ æˆ– { å¼€å¤´ï¼Œå°è¯•æ‰¾åˆ°ç¬¬ä¸€ä¸ª [ æˆ– {
        if (!cleaned.startsWith('[') && !cleaned.startsWith('{')) {
          const firstBracket = Math.min(
            cleaned.indexOf('[') >= 0 ? cleaned.indexOf('[') : Infinity,
            cleaned.indexOf('{') >= 0 ? cleaned.indexOf('{') : Infinity,
          );
          if (firstBracket !== Infinity) {
            cleaned = cleaned.substring(firstBracket);
          }
        }
        // ç§»é™¤å°¾éƒ¨çš„æ— æ•ˆå­—ç¬¦
        if (cleaned.endsWith(']') || cleaned.endsWith('}')) {
          return cleaned;
        }
        const lastBracket = Math.max(cleaned.lastIndexOf(']'), cleaned.lastIndexOf('}'));
        if (lastBracket >= 0) {
          cleaned = cleaned.substring(0, lastBracket + 1);
        }
        return cleaned;
      }

      // ==================== å›¾ç‰‡æ¸²æŸ“ï¼ˆä½¿ç”¨å’Œå‰§æƒ…æ˜¾ç¤ºç›¸åŒçš„æ–¹æ³•ï¼‰ ====================
      function renderImageTag(imageTag, container) {
        if (!imageTag || !container) {
          console.warn('renderImageTag: å›¾ç‰‡æ ‡ç­¾æˆ–å®¹å™¨ä¸ºç©º');
          return false;
        }

        // å…¼å®¹ï¼šæœ‰äº›è¾“å‡ºä¼šæ¼æ‰ç»“å°¾ ###ï¼Œè¿™é‡Œè‡ªåŠ¨è¡¥é½
        let normalized = String(imageTag);
        if (normalized.includes('image###') && !/image###([\s\S]*?)###/.test(normalized)) {
          normalized = normalized.trim();
          if (!normalized.endsWith('###')) normalized += '###';
        }

        const imageMatch = normalized.match(/image###([\s\S]*?)###/);
        if (!imageMatch) {
          console.warn('å›¾ç‰‡æ ‡ç­¾æ ¼å¼ä¸æ­£ç¡®:', normalized.substring(0, 120));
          return false;
        }

        const prompt = (imageMatch[1] || '').trim();
        console.info('renderImageTag: æç¤ºè¯ç‰‡æ®µ:', prompt.substring(0, 80));

        try {
          if (typeof formatAsDisplayedMessage !== 'undefined') {
            // å…³é”®ä¿®å¤ï¼šä¸è¦å¼ºè¡Œç­‰å¾… <img> å‡ºç°ï¼Œæ›´ä¸è¦ç”¨å ä½ç¬¦è¦†ç›–
            // SillyTavern çš„ image### é€šå¸¸å…ˆæ¸²æŸ“â€œç”Ÿæˆå›¾ç‰‡UIâ€ï¼Œå¹¶ä¸ä¸€å®šç«‹å³äº§å‡º <img>
            const html = formatAsDisplayedMessage(normalized);

            if (!container.parentElement) {
              console.warn('å›¾ç‰‡å®¹å™¨ä¸åœ¨DOMä¸­ï¼Œè·³è¿‡æ¸²æŸ“');
              return false;
            }

            if (typeof $ !== 'undefined' && $(container).length) $(container).html(html);
            else container.innerHTML = html;

            // è‹¥å­˜åœ¨å›¾ç‰‡åˆ™è¡¥å……æ ·å¼ï¼›æ²¡æœ‰å›¾ç‰‡ä¹Ÿè§†ä¸ºâ€œæˆåŠŸæ¸²æŸ“â€ï¼ˆå¯èƒ½æ˜¯ç”ŸæˆUIï¼‰
            setTimeout(() => {
              const imgs = container.querySelectorAll('img');
              imgs.forEach(img => {
                img.style.width = '100%';
                img.style.height = 'auto';
                img.style.maxHeight = '420px';
                img.style.objectFit = 'contain';
                img.style.display = 'block';
                img.style.borderRadius = '10px';
                img.style.margin = '0 auto';
              });
            }, 0);

            return true;
          }
        } catch (error) {
          console.error('renderImageTag: æ¸²æŸ“å¤±è´¥ï¼Œå°†å›é€€ä¸ºå¤åˆ¶æç¤ºè¯:', error);
        }

        // é™çº§ï¼šè‡³å°‘ä¿è¯æç¤ºè¯å¯å¤åˆ¶
        if (container.parentElement) {
          container.innerHTML = `
            <div class="image-placeholder" onclick='event.stopPropagation(); copyImagePrompt(${JSON.stringify(prompt)})'>
              <div style="font-size: 32px; margin-bottom: 8px">ğŸ–¼ï¸</div>
              <div style="font-size: 12px; text-align: center; padding: 0 8px">ç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤</div>
            </div>
          `;
        }
        return false;
      }

      // ==================== è‡ªåŠ¨é…å›¾ï¼šä¼˜å…ˆèµ° image### åŸç”Ÿæ¸²æŸ“ï¼Œå¤±è´¥/è¶…æ—¶å† /imagine å¼ºåˆ¶ç”Ÿå›¾ ====================
      function extractPromptFromImageTag(imageTag) {
        if (!imageTag) return '';
        let normalized = String(imageTag);
        if (normalized.includes('image###') && !/image###([\s\S]*?)###/.test(normalized)) {
          normalized = normalized.trim();
          if (!normalized.endsWith('###')) normalized += '###';
        }
        const m = normalized.match(/image###([\s\S]*?)###/);
        return (m?.[1] || '').trim();
      }

      function extractFirstUrl(text) {
        const s = String(text || '').trim();
        // å…¼å®¹ï¼šè¿”å›å¯èƒ½åŒ…å«å¤šä½™æ–‡æœ¬/å¼•å·/æ¢è¡Œ
        const m = s.match(
          /(https?:\/\/[^\s"'<>]+|\/?user\/images\/[^\s"'<>]+|\/?img\/[^\s"'<>]+|data:image\/[a-zA-Z0-9.+-]+;base64,[A-Za-z0-9+/=]+)/i,
        );
        return m ? m[1] : '';
      }

      function normalizePromptForImagine(prompt, maxChars = 1100) {
        const tags = String(prompt || '')
          .replace(/\s+/g, ' ')
          .split(',')
          .map(t => t.trim())
          .filter(Boolean);

        // å»é‡ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
        const seen = new Set();
        const uniq = [];
        for (const tag of tags) {
          const key = tag.toLowerCase();
          if (seen.has(key)) continue;
          // è¿‡é•¿çš„å•ä¸ªtagå¾€å¾€æ˜¯å™ªå£°/æ¨¡å‹è¾“å‡ºé”™è¯¯ï¼Œç›´æ¥ä¸¢å¼ƒ
          if (tag.length > 160) continue;
          seen.add(key);
          uniq.push(tag);
        }

        // æ—¢ä¿ç•™å¤´éƒ¨ï¼ˆè´¨é‡+è§’è‰²å¤–è²Œï¼‰ä¹Ÿä¿ç•™å°¾éƒ¨ï¼ˆåœºæ™¯å…‰çº¿ç­‰ï¼‰
        const headCount = Math.min(60, uniq.length);
        const tailCount = uniq.length > 90 ? 20 : Math.max(0, uniq.length - headCount);
        const merged = uniq.slice(0, headCount).concat(tailCount > 0 ? uniq.slice(-tailCount) : []);

        // æ§åˆ¶æœ€ç»ˆé•¿åº¦
        const out = merged.join(', ').replace(/\s+/g, ' ').trim();
        if (out.length <= maxChars) return out;
        // è¶…é•¿å°±æŒ‰tagç´¯åŠ æˆªæ–­ï¼Œé¿å…æˆªæ–­åˆ°ä¸€åŠäº§ç”Ÿå¥‡æ€ªtoken
        const result = [];
        let len = 0;
        for (const t of merged) {
          const add = (result.length ? ', ' : '') + t;
          if (len + add.length > maxChars) break;
          result.push(t);
          len += add.length;
        }
        return result.join(', ').trim();
      }

      function makeSafePromptForImagine(prompt) {
        // å…œåº•ï¼šå½“ image ç”Ÿæˆå› æ•æ„Ÿ/æç«¯è¯å¤±è´¥æ—¶ï¼Œé™çº§ä¸ºâ€œåäººè®¾/æš§æ˜§â€çš„å®‰å…¨æç¤ºè¯
        const banned = [
          'rape',
          'forced',
          'guro',
          'blood',
          'gore',
          'necrophilia',
          'insect',
          'worm',
          'scat',
          'bestiality',
          'tentacle',
          'cum',
          'semen',
          'ejaculation',
          'pussy',
          'penis',
          'cock',
          'vulva',
          'labia',
          'clitoris',
          'explicit',
        ];
        const tags = String(prompt || '')
          .replace(/\s+/g, ' ')
          .split(',')
          .map(t => t.trim())
          .filter(Boolean)
          .filter(t => {
            const lower = t.toLowerCase();
            if (banned.some(b => lower.includes(b))) return false;
            if (lower === 'nsfw') return false;
            return true;
          });

        // åŠ ä¸€ä¸ªè½»åº¦â€œå®‰å…¨æ°›å›´â€å…œåº•ï¼Œé¿å…å®Œå…¨è·‘å
        tags.push('safe', 'sensual', 'aesthetic', 'beautiful lighting');
        return normalizePromptForImagine(tags.join(', '), 900);
      }

      async function renderImageTagAuto(imageTag, container, { preferImagine = true, safeRetry = true } = {}) {
        if (!container) return false;
        const prompt = extractPromptFromImageTag(imageTag);
        if (!prompt) return false;

        // ç”Ÿæˆè¯·æ±‚IDï¼Œé¿å…å¹¶å‘æŠŠæ—§å›¾å¡å›æ–°å‰§æƒ…
        const reqId = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
        container.dataset.autoImageReq = reqId;

        // å…ˆæ˜¾ç¤ºåŠ è½½æ€
        container.innerHTML = `
          <div class="story-loading" style="display:flex; align-items:center; gap:10px; padding: 8px 6px">
            <span style="font-size: 18px">ğŸ–¼ï¸</span>
            <span style="font-size: 12px; color: var(--text-secondary)">æ­£åœ¨ç”Ÿæˆé…å›¾â€¦</span>
          </div>
        `;

        // ä¼˜å…ˆç”¨ /imagine ç›´æ¥ç”Ÿå›¾ï¼ˆæ›´ç¨³å®šï¼Œä¸ä¾èµ– image### åœ¨è‡ªåˆ¶DOMé‡Œè¢«è§£æï¼‰
        if (preferImagine && typeof triggerSlash === 'function') {
          const p1 = normalizePromptForImagine(prompt);
          try {
            const res = await triggerSlash(`/imagine quiet=true ${p1}`);
            const url = extractFirstUrl(res);
            if (container.dataset.autoImageReq !== reqId) return false;
            if (url) {
              const img = document.createElement('img');
              img.src = url;
              img.alt = 'auto image';
              img.style.width = '100%';
              img.style.height = 'auto';
              img.style.maxHeight = '420px';
              img.style.objectFit = 'contain';
              img.style.display = 'block';
              img.style.borderRadius = '10px';
              img.style.margin = '0 auto';

              const actions = document.createElement('div');
              actions.style.cssText =
                'display:flex; gap:8px; justify-content:flex-end; margin-top: 10px; flex-wrap: wrap;';
              actions.innerHTML = `
                <button class="btn btn-secondary" style="padding: 8px 10px; font-size: 12px" onclick='event.stopPropagation(); copyImagePrompt(${JSON.stringify(p1)})'>å¤åˆ¶æç¤ºè¯</button>
                <a class="btn btn-secondary" style="padding: 8px 10px; font-size: 12px; text-decoration:none" href="${url}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">æ‰“å¼€åŸå›¾</a>
              `;

              container.innerHTML = '';
              container.appendChild(img);
              container.appendChild(actions);
              return true;
            }
          } catch (e) {
            console.warn('renderImageTagAuto: /imagine ç”Ÿå›¾å¤±è´¥ï¼Œå°†å°è¯•é™çº§é‡è¯•æˆ–å›é€€:', e);
            if (safeRetry) {
              try {
                const p2 = makeSafePromptForImagine(prompt);
                const res2 = await triggerSlash(`/imagine quiet=true ${p2}`);
                const url2 = extractFirstUrl(res2);
                if (container.dataset.autoImageReq !== reqId) return false;
                if (url2) {
                  const img2 = document.createElement('img');
                  img2.src = url2;
                  img2.alt = 'auto image';
                  img2.style.width = '100%';
                  img2.style.height = 'auto';
                  img2.style.maxHeight = '420px';
                  img2.style.objectFit = 'contain';
                  img2.style.display = 'block';
                  img2.style.borderRadius = '10px';
                  img2.style.margin = '0 auto';

                  const actions2 = document.createElement('div');
                  actions2.style.cssText =
                    'display:flex; gap:8px; justify-content:flex-end; margin-top: 10px; flex-wrap: wrap;';
                  actions2.innerHTML = `
                    <button class="btn btn-secondary" style="padding: 8px 10px; font-size: 12px" onclick='event.stopPropagation(); copyImagePrompt(${JSON.stringify(p2)})'>å¤åˆ¶æç¤ºè¯</button>
                    <a class="btn btn-secondary" style="padding: 8px 10px; font-size: 12px; text-decoration:none" href="${url2}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">æ‰“å¼€åŸå›¾</a>
                  `;

                  container.innerHTML = '';
                  container.appendChild(img2);
                  container.appendChild(actions2);
                  return true;
                }
              } catch (e2) {
                console.warn('renderImageTagAuto: /imagine å®‰å…¨é™çº§é‡è¯•ä»å¤±è´¥ï¼Œå›é€€åˆ° image### æ¸²æŸ“:', e2);
              }
            }
          }
        }

        // å›é€€ï¼šä¿ç•™åŸ image### æ¸²æŸ“ï¼ˆè‡³å°‘èƒ½çœ‹åˆ°æç¤ºè¯/ç”ŸæˆUIï¼‰
        if (container.dataset.autoImageReq === reqId) {
          const ok = renderImageTag(imageTag, container);
          if (!ok) {
            // renderImageTag å·²ç»å†™å…¥â€œç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤â€çš„å ä½ç¬¦ï¼Œè¿™é‡Œä¸å†é¢å¤–å¤„ç†
            return false;
          }
          return true;
        }
        return false;
      }

      async function renderImageTagNativeFirst(imageTag, container, { fallbackAfterMs = 20000 } = {}) {
        if (!container) return false;
        const prompt = extractPromptFromImageTag(imageTag);
        if (!prompt) return false;

        // æ ‡è®°æœ¬æ¬¡è¯·æ±‚ï¼Œé¿å…å¹¶å‘è¦†ç›–
        const reqId = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
        container.dataset.autoImageReq = reqId;

        // 1) å…ˆèµ°åŸç”Ÿ image### æ¸²æŸ“
        const okNative = renderImageTag(imageTag, container);

        // è¿½åŠ æ‰‹åŠ¨å…œåº•æŒ‰é’®ï¼ˆä¸å½±å“åŸç”ŸUIï¼‰
        try {
          const btnRow = document.createElement('div');
          btnRow.style.cssText = 'display:flex; justify-content:flex-end; gap:8px; margin-top: 10px; flex-wrap: wrap;';
          const btn = document.createElement('button');
          btn.className = 'btn btn-secondary';
          btn.style.cssText = 'padding: 8px 10px; font-size: 12px';
          btn.textContent = 'å¼ºåˆ¶ç”Ÿå›¾';
          btn.onclick = e => {
            e.stopPropagation();
            void renderImageTagAuto(imageTag, container, { preferImagine: true, safeRetry: true });
          };
          btnRow.appendChild(btn);
          // é¿å…é‡å¤æ’å…¥
          if (!container.querySelector('[data-autoimage-fallback="1"]')) {
            btnRow.setAttribute('data-autoimage-fallback', '1');
            container.appendChild(btnRow);
          }
        } catch (e) {
          console.warn('renderImageTagNativeFirst: æ’å…¥å¼ºåˆ¶ç”Ÿå›¾æŒ‰é’®å¤±è´¥:', e);
        }

        if (!okNative) {
          // åŸç”Ÿæ¸²æŸ“å¤±è´¥ï¼šç«‹åˆ»å¼ºåˆ¶ç”Ÿå›¾
          return await renderImageTagAuto(imageTag, container, { preferImagine: true, safeRetry: true });
        }

        // 2) è‹¥åŸç”Ÿæ¸²æŸ“æˆåŠŸä½†â€œè¿Ÿè¿Ÿä¸å¼€å§‹ç”Ÿæˆ/ä¸å‡ºå›¾â€ï¼Œåˆ™è¶…æ—¶åè‡ªåŠ¨æ”¹ç”¨ /imagine
        // é€šè¿‡ SD_PROMPT_PROCESSING äº‹ä»¶åˆ¤æ–­â€œç¡®å®å¼€å§‹ç”Ÿæˆäº†â€ï¼Œé¿å…é‡å¤ç”Ÿå›¾
        let sdStarted = false;
        const sig = prompt.toLowerCase().replace(/\s+/g, ' ').trim().slice(0, 40);
        if (typeof eventOnce === 'function' && typeof tavern_events !== 'undefined') {
          try {
            eventOnce(tavern_events.SD_PROMPT_PROCESSING, event_data => {
              try {
                const p = String(event_data?.prompt || '').toLowerCase();
                if (sig && p.includes(sig)) {
                  sdStarted = true;
                }
              } catch {}
            });
          } catch (e) {
            console.warn('renderImageTagNativeFirst: ç›‘å¬ SD_PROMPT_PROCESSING å¤±è´¥:', e);
          }
        }

        setTimeout(
          () => {
            try {
              if (!container || container.dataset.autoImageReq !== reqId) return;
              if (container.querySelector('img')) return; // å·²ç»å‡ºå›¾
              if (sdStarted) return; // å·²å¼€å§‹ç”Ÿæˆï¼Œäº¤ç»™åŸç”Ÿæµç¨‹ç»§ç»­
              // ä»æœªå¼€å§‹/æœªå‡ºå›¾ï¼šæ”¹ç”¨å¼ºåˆ¶ç”Ÿå›¾å…œåº•
              void renderImageTagAuto(imageTag, container, { preferImagine: true, safeRetry: true });
            } catch (e) {
              console.warn('renderImageTagNativeFirst: è¶…æ—¶å…œåº•å¤±è´¥:', e);
            }
          },
          Math.max(3000, Number(fallbackAfterMs) || 20000),
        );

        return true;
      }

      // ==================== UI ç»„ä»¶åˆ›å»ºï¼ˆåˆ—è¡¨å½¢å¼ï¼Œç®€åŒ–ç‰ˆï¼‰ ====================
      function createCharacterCard(id, char, isSelectable = false) {
        const item = document.createElement('div');
        item.className = `character-list-item rarity-${char.ç¨€æœ‰åº¦}`;
        // å¼ºåˆ¶é‡ç½®å®šä½å±æ€§ï¼Œé˜²æ­¢AIç”Ÿæˆçš„å‰ç«¯å¡å½±å“å¸ƒå±€
        item.style.cssText = 'position: relative !important; z-index: auto !important; transform: none !important;';

        // åˆ›å»ºä¿¡æ¯åŒºåŸŸï¼ˆä¸å†åŒ…å«å›¾ç‰‡å ä½ç¬¦ï¼‰
        const infoContainer = document.createElement('div');
        infoContainer.className = 'character-list-info';

        // ç”Ÿæˆå±æ€§æ¡ï¼ˆç¡®ä¿å±æ€§å€¼ä¸ºæ•°å­—ç±»å‹ï¼‰
        const statsHtml = ['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦']
          .map(stat => {
            const rawValue = char.å±æ€§?.[stat];
            const value = typeof rawValue === 'number' ? Math.floor(rawValue) : 0;
            const width = Math.max(0, Math.min(100, value));
            return `
                    <div class="character-list-stat-item">
                      <span>${stat}:</span>
                      <div class="character-list-stat-bar">
                        <div class="character-list-stat-fill" style="width: ${width}%"></div>
                      </div>
                      <span>${value}</span>
                    </div>
                  `;
          })
          .join('');

        // ä½“åŠ›å€¼æ˜¾ç¤ºï¼ˆç®€æ´ç‰ˆï¼‰
        const staminaValue = typeof char.ä½“åŠ›å€¼ === 'number' ? Math.floor(char.ä½“åŠ›å€¼) : 100;
        const staminaIcon = staminaValue <= 20 ? 'ğŸ”´' : staminaValue <= 50 ? 'ğŸŸ¡' : 'ğŸŸ¢';

        infoContainer.innerHTML = `
                <div class="character-list-name">${char.å§“å || 'æœªçŸ¥'}</div>
                <div class="character-list-meta">${char.ç¨€æœ‰åº¦} Â· ${char.èŒä¸šèº«ä»½ || 'æ— '} Â· ${char.çŠ¶æ€ || 'ç©ºé—²'} Â· Lv.${char.ç­‰çº§ || 1}</div>
                <div class="character-list-stats">${statsHtml}</div>
                <div style="margin-top: 6px; display: flex; align-items: center; gap: 8px; font-size: 11px">
                  <span style="color: var(--text-secondary)">${staminaIcon} ä½“åŠ› ${staminaValue}%</span>
                  <span style="color: var(--text-secondary)">Â·</span>
                  <span style="color: var(--text-secondary)">æ¥å®¢ ${char.æ¥å®¢æ¬¡æ•° || 0}</span>
                  <span style="color: var(--text-secondary)">Â·</span>
                  <span style="color: var(--text-secondary)">è°ƒæ•™ ${char.è°ƒæ•™æ¬¡æ•° || 0}</span>
                  <span style="color: var(--text-secondary)">Â·</span>
                  <span style="color: var(--accent-gold)">ğŸ’°${char.æ”¶å…¥è´¡çŒ® || 0}</span>
                </div>
              `;

        // åˆ›å»ºæ“ä½œæŒ‰é’®åŒºåŸŸ
        const actionsContainer = document.createElement('div');
        actionsContainer.className = 'character-list-actions';

        if (isSelectable) {
          actionsContainer.innerHTML = `
                  <button class="btn" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); selectCharacterForRoom('${id}')">åˆ†é…æˆ¿é—´</button>
                `;
        } else {
          actionsContainer.innerHTML = `
                  <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); showCharacterDetail('${id}')">æŸ¥çœ‹è¯¦æƒ…</button>
                  <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); showTrainingInput('${id}')">è°ƒæ•™</button>
                  <button class="btn" style="padding: 8px 16px; font-size: 12px" onclick="event.stopPropagation(); assignCharacterToBrothel('${id}')">æ¥å®¢</button>
                `;
        }

        // ç»„è£…åˆ—è¡¨é¡¹ï¼ˆä¸å†åŒ…å«å›¾ç‰‡å ä½ç¬¦ï¼‰
        item.appendChild(infoContainer);
        item.appendChild(actionsContainer);

        return item;
      }

      // æˆ¿é—´ç±»å‹é…ç½®ï¼ˆå…¨å±€ï¼‰
      const roomTypes = {
        æ™®é€š: {
          icon: 'ğŸ ',
          color: '#94a3b8',
          baseIncome: 1.0,
          description: 'åŸºç¡€æˆ¿é—´ï¼Œé€‚åˆæ–°æ‰‹è§’è‰²',
          unlockCost: 0,
          upgradeCost: level => level * 500,
        },
        VIP: {
          icon: 'ğŸ‘‘',
          color: '#fbbf24',
          baseIncome: 1.5,
          description: 'VIPä¸“ç”¨ï¼Œé«˜æ”¶å…¥ä½†éœ€è¦é«˜å±æ€§è§’è‰²',
          unlockCost: 2000,
          upgradeCost: level => level * 1000,
        },
        è°ƒæ•™å®¤: {
          icon: 'ğŸ”',
          color: '#ec4899',
          baseIncome: 0.8,
          description: 'è°ƒæ•™ä¸“ç”¨ï¼Œæå‡è§’è‰²å±æ€§',
          unlockCost: 1500,
          upgradeCost: level => level * 800,
        },
        å±•ç¤ºå®¤: {
          icon: 'ğŸ­',
          color: '#8b5cf6',
          baseIncome: 1.2,
          description: 'å±•ç¤ºè§’è‰²é­…åŠ›ï¼Œå¸å¼•ç‰¹æ®Šå®¢æˆ·',
          unlockCost: 3000,
          upgradeCost: level => level * 1200,
        },
        æƒ…è¶£æˆ¿: {
          icon: 'ğŸ’‹',
          color: '#f59e0b',
          baseIncome: 1.8,
          description: 'ç‰¹æ®ŠæœåŠ¡ï¼Œé«˜æ”¶å…¥ä½†æ¶ˆè€—è§’è‰²è€åŠ›',
          unlockCost: 5000,
          upgradeCost: level => level * 2000,
        },
      };

      // è°ƒæ•™å®¤è¯¾ç¨‹ï¼ˆæè‡´è‰²æƒ…åŒ–ï¼Œå„ç§playå’Œå°ä¼—æ€§ç™–å…¨è¦†ç›–ï¼‰
      const trainingPrograms = [
        {
          key: 'å£èˆŒæœä¾åŸºç¡€',
          icon: 'ğŸ‘…',
          desc: 'å£äº¤ã€æ·±å–‰ã€èˆŒæŠ€è°ƒæ•™ã€‚æå‡æŠ€å·§ä¸é¡ºä»åº¦ã€‚',
          focus: { æŠ€å·§: [3, 8], é¡ºä»: [2, 6] },
          like: [1, 4],
          hate: [0, 2],
          staminaCost: [4, 10],
        },
        {
          key: 'BDSMæŸç¼šè°ƒæ•™',
          icon: 'ğŸ”—',
          desc: 'ç»³ç¼šã€é­æ‰“ã€èœ¡çƒ›ã€é’ˆåˆºç­‰é‡åº¦playã€‚æå¤§æå‡é¡ºä»ä¸æ•æ„Ÿåº¦ã€‚',
          focus: { é¡ºä»: [4, 10], æ•æ„Ÿåº¦: [3, 8] },
          like: [0, 3],
          hate: [1, 5],
          staminaCost: [8, 18],
        },
        {
          key: 'SMå¥³ç‹å…»æˆ',
          icon: 'ğŸ‘‘',
          desc: 'é­ç¬ã€è¸©è¸ã€è¨€è¯­ç¾è¾±ã€‚åŸ¹å…»æ”¯é…æ¬²ä¸æŠ€å·§ã€‚',
          focus: { é­…åŠ›: [3, 8], æŠ€å·§: [2, 6] },
          like: [1, 3],
          hate: [1, 4],
          staminaCost: [6, 14],
        },
        {
          key: 'å¼ºå¥¸æŠµæŠ—è®­ç»ƒ',
          icon: 'âš”ï¸',
          desc: 'æ¨¡æ‹Ÿå¼ºå¥¸åœºæ™¯ï¼Œé”»ç‚¼æŠ—å‹ä¸é€‚åº”èƒ½åŠ›ã€‚é«˜é£é™©é«˜æ”¶ç›Šã€‚',
          focus: { è€åŠ›: [4, 10], æ•æ„Ÿåº¦: [2, 7] },
          like: [0, 1],
          hate: [3, 8],
          staminaCost: [12, 24],
        },
        {
          key: 'ç¾¤äº¤è€ä¹…è€ƒéªŒ',
          icon: 'ğŸ‘¥',
          desc: 'å¤šäººè½®ç•ªplayï¼Œæµ‹è¯•æé™è€å—ã€‚æåº¦æ¶ˆè€—ä½“åŠ›ä½†å±æ€§æå‡å·¨å¤§ã€‚',
          focus: { è€åŠ›: [3, 9], æŠ€å·§: [3, 8] },
          like: [0, 2],
          hate: [2, 6],
          staminaCost: [15, 30],
        },
        {
          key: 'æ€§ç©å…·å¼€å‘',
          icon: 'ğŸ§¸',
          desc: 'æŒ¯åŠ¨æ£’ã€è‚›å¡ã€æ‰©å¼ å™¨ç­‰é“å…·è°ƒæ•™ã€‚é‡ç‚¹æå‡æ•æ„Ÿåº¦ã€‚',
          focus: { æ•æ„Ÿåº¦: [4, 10], é¡ºä»: [1, 5] },
          like: [1, 4],
          hate: [0, 2],
          staminaCost: [5, 12],
        },
        {
          key: 'å°¿é“playè°ƒæ•™',
          icon: 'ğŸ’§',
          desc: 'å°¿é“æ‰©å¼ ã€çŒå°¿ã€å°¿å°¿playç­‰å°ä¼—æ€§ç™–å¼€å‘ã€‚',
          focus: { æ•æ„Ÿåº¦: [5, 12], è€åŠ›: [1, 4] },
          like: [0, 1],
          hate: [2, 5],
          staminaCost: [8, 16],
        },
        {
          key: 'å…½äº¤æ¨¡æ‹Ÿ',
          icon: 'ğŸ•',
          desc: 'æ¨¡æ‹Ÿå…½äº¤å§¿åŠ¿ã€çŠ¬ç±»playã€åŠ¨ç‰©è§’è‰²æ‰®æ¼”ã€‚',
          focus: { æŠ€å·§: [2, 6], é¡ºä»: [3, 8] },
          like: [1, 3],
          hate: [1, 4],
          staminaCost: [7, 15],
        },
        {
          key: 'è§¦æ‰‹play',
          icon: 'ğŸ¦‘',
          desc: 'è§¦æ‰‹æ’å…¥ã€ç¼ ç»•ã€å¸å®ç­‰å¹»æƒ³playã€‚',
          focus: { æ•æ„Ÿåº¦: [3, 9], è€åŠ›: [2, 6] },
          like: [1, 4],
          hate: [0, 2],
          staminaCost: [6, 14],
        },
        {
          key: 'å­•å¦‡play',
          icon: 'ğŸ¤°',
          desc: 'å­•å¦‡è£…æ‰®ã€ä¹³æ±playã€æ¯æ€§è°ƒæ•™ã€‚',
          focus: { é­…åŠ›: [2, 6], æ•æ„Ÿåº¦: [2, 6] },
          like: [1, 3],
          hate: [0, 2],
          staminaCost: [5, 12],
        },
        {
          key: 'æš´åŠ›å¼ºå¥¸è®­ç»ƒ',
          icon: 'ğŸ”ª',
          desc: 'æš´åŠ›å¼ºå¥¸ã€æ®´æ‰“ã€æ’•è£‚ç­‰è¿‡æ¿€playã€‚æé«˜é£é™©ã€‚',
          focus: { è€åŠ›: [5, 12], é¡ºä»: [3, 9] },
          like: [0, 1],
          hate: [5, 12],
          staminaCost: [18, 36],
        },
        {
          key: 'è¡€è…¥Guroè°ƒæ•™',
          icon: 'ğŸ©¸',
          desc: 'å‡ºè¡€playã€åˆ‡å‰²ã€è‚¢ä½“ä¼¤å®³ç­‰è¡€è…¥è°ƒæ•™ã€‚',
          focus: { æ•æ„Ÿåº¦: [4, 12], è€åŠ›: [2, 8] },
          like: [0, 1],
          hate: [4, 10],
          staminaCost: [12, 25],
        },
        {
          key: 'è™«åµplay',
          icon: 'ğŸ¥š',
          desc: 'è™«åµæ³¨å…¥ã€äº§åµã€è™«åµå­µåŒ–ç­‰è™«åµplayï¼ˆä¸æ¶‰åŠæ´»ä½“æ˜†è™«ï¼‰ã€‚',
          focus: { æ•æ„Ÿåº¦: [5, 12], é¡ºä»: [2, 7] },
          like: [0, 1],
          hate: [2, 7],
          staminaCost: [8, 18],
        },
        {
          key: 'è‡ªå®šä¹‰è°ƒæ•™',
          icon: 'ğŸ­',
          desc: 'è‡ªå®šä¹‰playå†…å®¹ï¼Œç”±ç”¨æˆ·è¾“å…¥å…·ä½“è°ƒæ•™æ–¹å¼ã€‚',
          focus: { é¡ºä»: [1, 5], æŠ€å·§: [1, 5], æ•æ„Ÿåº¦: [1, 5] },
          like: [0, 3],
          hate: [0, 3],
          staminaCost: [5, 15],
          custom: true,
        },
      ];

      function createRoomCard(roomId, room) {
        const card = document.createElement('div');
        card.className = `room-card ${room.çŠ¶æ€ !== 'ç©ºé—²' ? 'occupied' : ''}`;

        const roomType = roomTypes[room.ç±»å‹] || roomTypes.æ™®é€š;
        const char = room.å½“å‰è§’è‰² ? gameState.è§’è‰²ä»“åº“[room.å½“å‰è§’è‰²] : null;
        const workingChar = room.å½“å‰è§’è‰² ? gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[room.å½“å‰è§’è‰²] : null;
        const trainingInfo = room.å½“å‰è§’è‰² ? gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[room.å½“å‰è§’è‰²] : null;
        const totalIncomeMultiplier = room.æ”¶å…¥å€ç‡ || 1.0;
        const nowRound = getGameTime().å½“å‰å›åˆ || 1;

        // è®¡ç®—æ¥å®¢å‰©ä½™å›åˆå’Œé¢„è®¡ç»“æŸå›åˆ
        let serviceRemain = 0;
        let serviceEndRound = 0;
        if (workingChar) {
          const startRound = workingChar.å¼€å§‹å›åˆ || nowRound;
          serviceEndRound = workingChar.é¢„è®¡ç»“æŸå›åˆ || startRound + 2;
          serviceRemain = Math.max(0, serviceEndRound - nowRound);
        }

        // è®¡ç®—è°ƒæ•™å‰©ä½™å›åˆå’Œé¢„è®¡ç»“æŸå›åˆ
        let trainingRemain = 0;
        let trainingEndRound = 0;
        if (trainingInfo) {
          const startRound = trainingInfo.å¼€å§‹å›åˆ || nowRound;
          trainingEndRound = trainingInfo.é¢„è®¡ç»“æŸå›åˆ || startRound + 2;
          trainingRemain = Math.max(0, trainingEndRound - nowRound);
        }

        card.innerHTML = `
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px">
                <div style="font-size: 32px">${roomType.icon}</div>
                <div style="flex: 1">
                  <div style="font-size: 18px; font-weight: bold; color: ${roomType.color}">æˆ¿é—´ ${roomId}</div>
                  <div style="font-size: 12px; color: var(--text-secondary)">${roomType.description}</div>
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; font-size: 12px">
                <div style="padding: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 8px">
                  <div style="color: var(--text-secondary); margin-bottom: 4px">ç±»å‹</div>
                  <div style="color: ${roomType.color}; font-weight: 600">${room.ç±»å‹}</div>
                </div>
                <div style="padding: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 8px">
                  <div style="color: var(--text-secondary); margin-bottom: 4px">ç­‰çº§</div>
                  <div style="color: var(--accent-gold); font-weight: 600">Lv.${room.ç­‰çº§ || 1}</div>
                </div>
                <div style="padding: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 8px">
                  <div style="color: var(--text-secondary); margin-bottom: 4px">çŠ¶æ€</div>
                  <div style="color: ${room.çŠ¶æ€ === 'ç©ºé—²' ? 'var(--success)' : 'var(--primary)'}; font-weight: 600">${room.çŠ¶æ€}</div>
                </div>
                <div style="padding: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 8px">
                  <div style="color: var(--text-secondary); margin-bottom: 4px">æ”¶å…¥å€ç‡</div>
                  <div style="color: var(--accent-gold); font-weight: 600">${(totalIncomeMultiplier * 100).toFixed(0)}%</div>
                </div>
              </div>

              ${
                char
                  ? `
                <div style="padding: 8px; background: rgba(139, 92, 246, 0.2); border-radius: 8px; margin-bottom: 12px">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">å½“å‰è§’è‰²</div>
                  <div style="font-size: 14px; color: var(--primary); font-weight: 600">${char.å§“å}</div>
                  ${
                    room.ç±»å‹ === 'è°ƒæ•™å®¤' && trainingInfo
                      ? `<div style="font-size: 11px; color: var(--accent-gold); margin-top: 4px">è¯¾ç¨‹: ${trainingInfo.è¯¾ç¨‹}</div>
                         <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px">å‰©ä½™ ${trainingRemain} å›åˆï¼Œé¢„è®¡ç¬¬ ${trainingEndRound} å›åˆç»“æŸ</div>`
                      : workingChar
                        ? `<div style="font-size: 11px; color: var(--accent-gold); margin-top: 4px">é¢„è®¡æ”¶å…¥: ${Math.floor((workingChar.åŸºç¡€æ”¶å…¥ + workingChar.é¢å¤–æ”¶å…¥) * totalIncomeMultiplier)} é‡‘</div>
                           <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px">å‰©ä½™ ${serviceRemain} å›åˆï¼Œé¢„è®¡ç¬¬ ${serviceEndRound} å›åˆç»“æŸ</div>
                           <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px">${(() => {
                             const stamina = typeof char.ä½“åŠ›å€¼ === 'number' ? Math.floor(char.ä½“åŠ›å€¼) : 100;
                             const staminaIcon = stamina <= 20 ? 'ğŸ”´' : stamina <= 50 ? 'ğŸŸ¡' : 'ğŸŸ¢';
                             return `${staminaIcon} ä½“åŠ› ${stamina}%`;
                           })()}</div>`
                        : ''
                  }
                </div>
              `
                  : ''
              }

              <div style="display: flex; gap: 8px; flex-wrap: wrap">
                ${
                  room.ç±»å‹ === 'è°ƒæ•™å®¤'
                    ? room.çŠ¶æ€ === 'ç©ºé—²'
                      ? `
                  <button class="btn" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); openTrainingAssignment('${roomId}')">å¼€å§‹è¯¾ç¨‹</button>
                  <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); showRoomManagement('${roomId}')">ç®¡ç†</button>
                `
                      : `
                  <button class="btn" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); showTrainingRoomDetail('${roomId}')">æŸ¥çœ‹è¯¾ç¨‹</button>
                  <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); stopTrainingInRoom('${roomId}')">ç»ˆæ­¢è®­ç»ƒ</button>
                `
                    : room.çŠ¶æ€ === 'ç©ºé—²'
                      ? `
                  <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); showRoomAssignment('${roomId}')">åˆ†é…è§’è‰²</button>
                  <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); showRoomManagement('${roomId}')">ç®¡ç†</button>
                `
                      : `
                  <button class="btn" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); showRoomDetail('${roomId}')">æŸ¥çœ‹å‰§æƒ…</button>
                  <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 12px" onclick="event.stopPropagation(); cancelCharacterFromRoom('${roomId}')">å–æ¶ˆæ¥å®¢</button>
                `
                }
              </div>
            `;

        // æ ¹æ®æˆ¿é—´ç±»å‹è®¾ç½®è¾¹æ¡†é¢œè‰²
        card.style.borderColor = roomType.color;
        card.style.borderWidth = '2px';

        return card;
      }

      // ==================== æŠ½å¡åŠŸèƒ½ ====================
      let pendingSummonCost = 0; // è®°å½•å¾…å¤„ç†çš„æŠ½å¡è´¹ç”¨

      // ==================== å®šå‘æŠ½å¡è¾“å…¥ ====================
      function showTargetSummonInput() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'target-summon-modal';
        modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px">
                  <button class="modal-close" onclick="closeTargetSummonInput()">Ã—</button>
                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">ğŸ¯ å®šå‘æŠ½å¡</h2>

                  <div style="margin-bottom: 16px; padding: 16px; background: rgba(30, 41, 59, 0.6); border-radius: 12px">
                    <p style="font-size: 14px; color: var(--text-secondary); line-height: 1.8">
                      æè¿°ä½ æƒ³è¦çš„è§’è‰²ç‰¹å¾ï¼Œä¾‹å¦‚ï¼š<br>
                      â€¢ æ€§åˆ«ã€ç§æ—ã€èŒä¸šå€¾å‘<br>
                      â€¢ æ€§æ ¼ç‰¹ç‚¹ã€å¤–è²Œç‰¹å¾<br>
                      â€¢ ç‰¹æ®Šèƒ½åŠ›æˆ–èƒŒæ™¯è®¾å®š<br>
                      â€¢ ä»»ä½•å…¶ä»–è¦æ±‚
                    </p>
                  </div>

                  <div style="margin-bottom: 16px">
                    <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 8px">è§’è‰²è¦æ±‚ï¼š</label>
                    <textarea
                      id="target-summon-input"
                      placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³è¦ä¸€ä¸ªæ¸©æŸ”ä½“è´´çš„å¥³æ€§è§’è‰²ï¼ŒèŒä¸šæ˜¯åŒ»ç”Ÿæˆ–æŠ¤å£«ï¼Œæœ‰ç€æ²»æ„ˆç³»çš„å¤–è²Œå’Œæ€§æ ¼..."
                      style="
                        width: 100%;
                        min-height: 150px;
                        padding: 12px;
                        background: rgba(15, 23, 42, 0.6);
                        border: 1px solid rgba(139, 92, 246, 0.3);
                        border-radius: 12px;
                        color: var(--text-primary);
                        font-size: 14px;
                        resize: vertical;
                        font-family: inherit;
                      "
                    ></textarea>
                  </div>

                  <div style="display: flex; gap: 12px; justify-content: flex-end">
                    <button class="btn btn-secondary" onclick="closeTargetSummonInput()">å–æ¶ˆ</button>
                    <button class="btn" onclick="confirmTargetSummon()">å¼€å§‹æŠ½å¡ (1500 é‡‘)</button>
                  </div>
                </div>
              `;

        document.body.appendChild(modal);
        modal.classList.add('active');

        // èšç„¦è¾“å…¥æ¡†
        setTimeout(() => {
          const input = document.getElementById('target-summon-input');
          if (input) input.focus();
        }, 100);
      }

      function closeTargetSummonInput() {
        closeModal('target-summon-modal');
      }

      async function confirmTargetSummon() {
        const input = document.getElementById('target-summon-input');
        const userRequirement = input ? input.value.trim() : '';

        closeTargetSummonInput();

        if (!userRequirement) {
          alert('è¯·è¾“å…¥è§’è‰²è¦æ±‚ï¼');
          return;
        }

        if (gameState.è´§å¸ < 1500) {
          alert('è´§å¸ä¸è¶³ï¼éœ€è¦1500é‡‘ã€‚');
          return;
        }

        await handleSummon('å®šå‘æŠ½å¡', userRequirement);
      }

      // ==================== çœŸéšæœºæ¦‚ç‡ç”Ÿæˆ ====================
      function generateRarity(type) {
        if (type === 'é—ªå…‰æŠ½å¡') {
          return 'SSR'; // é—ªå…‰æŠ½å¡100% SSR
        }

        // çœŸéšæœºï¼šä½¿ç”¨ crypto.getRandomValues æˆ– Math.random
        let random;
        if (typeof crypto !== 'undefined' && crypto.getRandomValues) {
          const array = new Uint32Array(1);
          crypto.getRandomValues(array);
          random = array[0] / (0xffffffff + 1); // è½¬æ¢ä¸º 0-1 ä¹‹é—´çš„æµ®ç‚¹æ•°
        } else {
          random = Math.random();
        }

        // å•æŠ½æ¦‚ç‡ï¼šN (50%), R (30%), SR (15%), SSR (5%)
        if (random < 0.5) return 'N';
        if (random < 0.8) return 'R';
        if (random < 0.95) return 'SR';
        return 'SSR';
      }

      // ==================== æ€§åˆ«å¤šæ ·æ€§ï¼ˆå…¨æ€§å‘ï¼‰ ====================
      function normalizeGenderLabel(raw) {
        const s = String(raw || '').trim();
        if (!s) return '';
        if (/(åŒæ€§|ä¸¤æ€§|æ‰¶å¥¹)/.test(s)) return 'åŒæ€§ç”·æ€§';
        if (/ç”·/.test(s)) return 'ç”·æ€§';
        if (/å¥³/.test(s)) return 'å¥³æ€§';
        return '';
      }

      function detectGenderInText(text) {
        const s = String(text || '');
        if (!s.trim()) return '';

        // åªåœ¨â€œæ˜ç¡®å†™äº†æ€§åˆ«è¦æ±‚â€æ—¶æ‰è§£æï¼Œé¿å…æŠŠâ€œå¥³ç‹/å¥³ä»†â€ç­‰è¯è¯¯åˆ¤æˆæ€§åˆ«
        const explicit = s.match(
          /(?:^|[\sï¼Œ,;ï¼›\n])(?:æ€§åˆ«|gender)\s*[:ï¼š]?\s*(åŒæ€§ç”·æ€§|åŒæ€§|ä¸¤æ€§|æ‰¶å¥¹(?:ç”·)?|ç”·æ€§|ç”·|å¥³æ€§|å¥³)(?:$|[\sï¼Œ,;ï¼›\n])/i,
        );
        if (explicit?.[1]) return normalizeGenderLabel(explicit[1]);

        // å¸¸è§è‡ªç„¶è¯­è¨€å†™æ³•
        if (/(åŒæ€§ç”·æ€§|åŒæ€§|ä¸¤æ€§|æ‰¶å¥¹)/.test(s)) return 'åŒæ€§ç”·æ€§';
        if (/(ç”·è§’è‰²|ç”·æ€§è§’è‰²|ç”·å­©å­|ç”·ç”Ÿ|å°‘å¹´|é’å¹´|ç‹å­|å°‘çˆ·|å…¬å­)/.test(s)) return 'ç”·æ€§';
        if (/(å¥³è§’è‰²|å¥³æ€§è§’è‰²|å¥³å­©å­|å¥³ç”Ÿ|å°‘å¥³|å…¬ä¸»|å°å§|å¤«äºº)/.test(s)) return 'å¥³æ€§';

        return '';
      }

      function countRosterGenders() {
        const counts = { ç”·æ€§: 0, å¥³æ€§: 0, åŒæ€§ç”·æ€§: 0 };
        const roster =
          gameState.è§’è‰²ä»“åº“ && typeof gameState.è§’è‰²ä»“åº“ === 'object' ? Object.values(gameState.è§’è‰²ä»“åº“) : [];
        roster.forEach(c => {
          const g = normalizeGenderLabel(c?.æ€§åˆ«);
          if (g && counts[g] !== undefined) counts[g] += 1;
        });
        return counts;
      }

      function pickBalancedGender(customRequirement = '') {
        // å¦‚æœç”¨æˆ·åœ¨å®šå‘è¦æ±‚é‡Œå†™äº†æ€§åˆ«ï¼Œå°Šé‡ç”¨æˆ·
        const specified = detectGenderInText(customRequirement);
        if (specified) return specified;

        const { ç”·æ€§, å¥³æ€§, åŒæ€§ç”·æ€§ } = countRosterGenders();
        const total = ç”·æ€§ + å¥³æ€§ + åŒæ€§ç”·æ€§;

        // åŸºç¡€æƒé‡ï¼šç”·å¥³ä¸ºä¸»ï¼ŒåŒæ€§å°‘é‡ç‚¹ç¼€
        let wMale = 1;
        let wFemale = 1;
        let wBi = 0.18;

        // è®©æ€§åˆ«åˆ†å¸ƒæ›´å‡è¡¡ï¼šå“ªè¾¹å°‘å°±æé«˜æƒé‡
        if (total >= 6) {
          const maleRatio = total ? ç”·æ€§ / total : 0;
          const femaleRatio = total ? å¥³æ€§ / total : 0;
          const biRatio = total ? åŒæ€§ç”·æ€§ / total : 0;

          if (maleRatio < 0.4) wMale += 2.2;
          if (femaleRatio < 0.4) wFemale += 2.2;
          if (biRatio < 0.08) wBi += 0.25;
        }

        return pickWeighted([
          ['ç”·æ€§', wMale],
          ['å¥³æ€§', wFemale],
          ['åŒæ€§ç”·æ€§', wBi],
        ]);
      }

      async function handleSummon(type, customRequirement = '') {
        const costs = { å•æŠ½: 250, é™å®šå¡æ± : 250, é—ªå…‰æŠ½å¡: 3000, å®šå‘æŠ½å¡: 1500 };
        const cost = costs[type] || 250;

        if (gameState.è´§å¸ < cost) {
          alert('è´§å¸ä¸è¶³ï¼');
          return;
        }

        // è®°å½•å¾…æ‰£é™¤çš„è´¹ç”¨ï¼Œä½†ä¸ç«‹å³æ‰£é™¤
        pendingSummonCost = cost;

        const resultsContainer = document.getElementById('summon-results');
        const cardDisplay = document.getElementById('character-card-display');

        resultsContainer.innerHTML = '<div class="story-loading">â³ æ­£åœ¨å¬å”¤ï¼Œè¯·ç¨å€™...</div>';
        if (cardDisplay) {
          cardDisplay.style.display = 'none';
          cardDisplay.innerHTML = '';
        }

        // ç”Ÿæˆç¨€æœ‰åº¦ï¼ˆçœŸéšæœºï¼‰
        const targetRarity = generateRarity(type);
        const summonCount = 1;
        const forcedGender = pickBalancedGender(customRequirement);
        const gameTime = getGameTime();

        // æ„å»ºå®Œæ•´çš„ç³»ç»ŸæŒ‡ä»¤
        let command = '';

        if (type === 'é™å®šå¡æ± ') {
          const limited = updateLimitedPoolIfNeeded();
          const t1 = limited?.è¯æ¡?.[0] || 'â€”';
          const t2 = limited?.è¯æ¡?.[1] || 'â€”';
          command = `æ‰§è¡Œé™å®šå¡æ± æŠ½å¡ã€‚\n\næœ¬æœŸé™å®šè¯æ¡ï¼ˆä¸‡ç‰©çµæ„Ÿç§å­ï¼‰ï¼š\n- ${t1}\n- ${t2}\n\nã€è¯æ¡ä½¿ç”¨è§„åˆ™ï¼šèªæ˜åœ°"è§’è‰²åŒ–è½åœ°"ã€‘ã€é‡è¦ã€‘\n- è¿™ä¸¤æ¡è¯æ¡æ˜¯"çµæ„Ÿç§å­"ï¼Œå…è®¸éšå–»/è±¡å¾/æè´¨/é…è‰²/çº¹æ ·/é“å…·åŒ–è½¬è¯‘ï¼›ä¸è¦å­—é¢ç¡¬å¥—å¯¼è‡´æŠ½è±¡ã€ä¸‘æ€ªã€çŒå¥‡ã€‚\n- ä½ å¿…é¡»è®©æ¯æ¡è¯æ¡è‡³å°‘è½åˆ° 2 å¤„å¯ç”»è¦ç´ ï¼ˆä¾‹å¦‚ï¼šé…è‰²/æè´¨/çº¹æ ·/é¥°å“/é“å…·/ç¯å¢ƒ/å£ç™–/èƒŒæ™¯æ„è±¡/èƒ½åŠ›è®¾å®šï¼‰ã€‚\n- å®¡ç¾ä¼˜å…ˆï¼šè§’è‰²å¿…é¡»ç¾å‹ã€è¡€è‚‰ã€æœ‰ä½“æ¸©ï¼›è‹¥è¯æ¡å«"æœºæ¢°/æ€ªç‰©/éäºº"å€¾å‘ï¼Œåªèƒ½ä½œä¸ºé£æ ¼ç¬¦å·æˆ–é“å…·æ„è±¡ï¼Œç»ä¸èƒ½å˜æˆæœºå™¨äºº/æ€ªç‰©èº¯ä½“ã€‚\n- å£å‘³é™åˆ¶ï¼šä¸€èˆ¬ä¸å‡ºç°è¿‡äºæ¶å¿ƒçŒå¥‡çš„å†…å®¹ï¼›æœ€æ¶å¿ƒä¸Šé™åªåˆ°ã€å°¿æ¶²/å­•è‚šã€‘ã€‚ç¦æ­¢ç²ªä¾¿/æœˆç»/è…çƒ‚/è™«/å°¸/è¡€è…¥è‚¢è§£ç­‰ã€‚\n- å…¨æ€§å‘ï¼šä¸è¦æ€»æ˜¯å¥³æ€§ã€‚æœ¬æ¬¡è§’è‰²æ€§åˆ«å¿…é¡»ä¸ºã€${forcedGender}ã€‘ã€‚\n\n`;
        } else if (type === 'å®šå‘æŠ½å¡' && customRequirement) {
          command = `æ‰§è¡Œå®šå‘æŠ½å¡ã€‚æ ¹æ®ä»¥ä¸‹è¦æ±‚ç”Ÿæˆè§’è‰²ï¼š\n\n${customRequirement}\n\næœ¬æ¬¡è§’è‰²æ€§åˆ«å¿…é¡»ä¸ºã€${forcedGender}ã€‘ã€‚\n\n`;
        } else {
          command = `æ‰§è¡Œ${type}ã€‚\n\næœ¬æ¬¡è§’è‰²æ€§åˆ«å¿…é¡»ä¸ºã€${forcedGender}ã€‘ã€‚\n\n`;
        }

        command += `**ã€æ€ç»´é“¾ï¼šè§’è‰²ç”Ÿæˆå‰çš„å®Œæ•´è§„åˆ’ã€‘**

åœ¨å¼€å§‹ç”Ÿæˆè§’è‰²å¡ä¹‹å‰ï¼Œä½ å¿…é¡»å…ˆå®Œæˆä»¥ä¸‹æ€ç»´é“¾ï¼Œç¡®ä¿æ‰€æœ‰ä¿¡æ¯éƒ½å·²é¢„å…ˆè€ƒè™‘ï¼š

**ç¬¬ä¸€æ­¥ï¼šå½“å‰æŠ½å¡æƒ…å†µåˆ†æ**
- æŠ½å¡ç±»å‹ï¼š${type}
- ç›®æ ‡ç¨€æœ‰åº¦ï¼š${targetRarity}ï¼ˆå·²é€šè¿‡çœŸéšæœºç”Ÿæˆï¼‰
${customRequirement ? `- ç”¨æˆ·ç‰¹æ®Šè¦æ±‚ï¼š${customRequirement}` : ''}
- å½“å‰æ¸¸æˆå›åˆï¼š${gameTime.å½“å‰å›åˆ || 1}
- å½“å‰æ¸¸æˆçŠ¶æ€ï¼šè´§å¸${gameState.è´§å¸ || 0}é‡‘ï¼Œå·²æœ‰è§’è‰²${Object.keys(gameState.è§’è‰²ä»“åº“ || {}).length}ä¸ª

**ç¬¬äºŒæ­¥ï¼šå¿…é¡»ç”Ÿæˆçš„æ‰€æœ‰è§’è‰²ä¿¡æ¯æ¸…å•ï¼ˆé€ä¸€ç¡®è®¤ï¼‰**
åœ¨ç”Ÿæˆä»»ä½•å†…å®¹ä¹‹å‰ï¼Œä½ å¿…é¡»å…ˆè§„åˆ’ä»¥ä¸‹æ‰€æœ‰å­—æ®µï¼Œç¡®ä¿æ¯ä¸ªå­—æ®µéƒ½æœ‰å…·ä½“å†…å®¹ï¼Œä¸èƒ½ç•™ç©ºï¼š

1. **å…ƒç´ **ï¼ˆ3-4ä¸ªç‹¬ç‰¹å…ƒç´ ï¼Œå¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªç¨€æœ‰å°ä¼—å…ƒç´ ï¼‰ï¼šéœ€è¦ç¡®å®šå“ªäº›å…ƒç´ ï¼Ÿå¦‚ä½•ä¸è§’è‰²è®¾è®¡èåˆï¼Ÿ
2. **å§“å**ï¼šéœ€è¦ä»€ä¹ˆæ ·çš„åå­—ï¼Ÿç¬¦åˆè§’è‰²çš„ç§æ—/èƒŒæ™¯å—ï¼Ÿ
3. **ç¨€æœ‰åº¦**ï¼š${targetRarity}ï¼ˆå·²ç¡®å®šï¼‰
4. **æ€§åˆ«**ï¼šç”·æ€§/å¥³æ€§/åŒæ€§ç”·æ€§ï¼Ÿéœ€è¦æ ¹æ®ç”¨æˆ·è¦æ±‚æˆ–éšæœºå†³å®š
5. **ç§æ—/å‡ºèº«**ï¼šä»…é™äººç±»æˆ–é«˜åº¦æ‹ŸäººåŒ–ç¾å‹ç§æ—ï¼Œç¦æ­¢æœºå™¨äºº/äººå¶ç­‰ã€‚å…·ä½“æ˜¯ä»€ä¹ˆç§æ—ï¼Ÿå‡ºèº«èƒŒæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ
6. **èŒä¸š/èº«ä»½**ï¼šè§’è‰²çš„èŒä¸šæˆ–èº«ä»½æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•ä¸èƒŒæ™¯æ•…äº‹å…³è”ï¼Ÿ
7. **å¤–è²Œç‰¹ç‚¹**ï¼ˆä¸­æ–‡è¯¦ç»†æè¿°ï¼‰ï¼šéœ€è¦è¯¦ç»†æè¿°å“ªäº›æ–¹é¢ï¼Ÿå¤´å‘ã€çœ¼ç›ã€èº«æã€ç‰¹æ®Šæ ‡è®°ç­‰
8. **æ€§æ ¼/å–œå¥½**ï¼šè§’è‰²çš„æ€§æ ¼ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆå–œå¥½ï¼Ÿå¿…é¡»çœŸå®ã€ç«‹ä½“
9. **ç®€ä»‹**ï¼šå¦‚ä½•ç”¨ç®€æ´çš„è¯­è¨€æ¦‚æ‹¬è§’è‰²ï¼Ÿ
10. **èƒŒæ™¯æ•…äº‹**ï¼ˆè‡³å°‘1000å­—ï¼‰ï¼šæ•…äº‹çš„æ ¸å¿ƒæ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•ä½“ç°è§’è‰²ç‰¹ç‚¹ï¼ˆèŒç‚¹ï¼‰ï¼Ÿä½“è£æ˜¯ä»€ä¹ˆï¼Ÿ
11. **å¤–è²Œæç¤ºè¯**ï¼ˆçº¯è‹±æ–‡ï¼Œæå…¶è¯¦ç»†ï¼‰ï¼šéœ€è¦è¦†ç›–13ä¸ªç»´åº¦ï¼Œæ¯ä¸ªç»´åº¦éƒ½è¦æœ‰å…·ä½“æ ‡ç­¾
12. **å±æ€§åˆå§‹å€¼è®¡ç®—**ï¼ˆé‡è¦ï¼‰ï¼šå±æ€§å€¼ä¸åº”åªç”±ç¨€æœ‰åº¦å†³å®šï¼Œè€Œåº”ç»¼åˆè€ƒè™‘è§’è‰²çš„**èŒä¸š/èº«ä»½**ã€**ä½“æ ¼**ï¼ˆä»å¤–è²Œç‰¹ç‚¹æ¨æ–­ï¼‰ã€**è¿‡å»çš„ç»éªŒ**ï¼ˆä»èƒŒæ™¯æ•…äº‹æ¨æ–­ï¼‰ã€**ç§æ—/å‡ºèº«**ã€**æ€§æ ¼**ç­‰å› ç´ ã€‚
   - **ä¸€èˆ¬æƒ…å†µ**ï¼šåˆå§‹å€¼åº”åœ¨ **0-25** èŒƒå›´å†…
   - **ç‰¹æ®Šæƒ…å†µ**ï¼šå¦‚æœè§’è‰²æ˜¯é­…é­”ã€æ·«é­”ã€å¦“å¥³ã€å¨¼å¦‡ã€æ€§å¥´ç­‰å…·æœ‰æ€§ç»éªŒæˆ–æ€§å·¥ä½œèƒŒæ™¯çš„è§’è‰²ï¼Œåˆå§‹å€¼å¯ä»¥åœ¨ **25-50** èŒƒå›´å†…
   - **å±æ€§åˆ†é…é€»è¾‘**ï¼š
     * **é­…åŠ›**ï¼šå—èŒä¸šï¼ˆå¦‚èˆè€…ã€æ­Œæ‰‹ã€è‰ºäººã€è´µæ—ï¼‰ã€ç§æ—ï¼ˆå¦‚é­…é­”ã€ç²¾çµã€å¤©ä½¿ï¼‰ã€å¤–è²Œç‰¹ç‚¹ï¼ˆå¦‚æ€§æ„Ÿã€ä¸°æ»¡ï¼‰å½±å“
     * **é¡ºä»**ï¼šå—èŒä¸šï¼ˆå¦‚å¥´éš¶ã€ä¿˜è™ä¼šé«˜ï¼Œè´µæ—ä¼šä½ï¼‰ã€æ€§æ ¼ï¼ˆå¦‚æ¸©æŸ”ã€é¡ºä»ä¼šé«˜ï¼Œå¼ºåŠ¿ã€é«˜å‚²ä¼šä½ï¼‰ã€èƒŒæ™¯æ•…äº‹ï¼ˆå¦‚æœä»è®­ç»ƒä¼šé«˜ï¼ŒåæŠ—ç»å†ä¼šä½ï¼‰å½±å“
     * **æŠ€å·§**ï¼šå—èŒä¸šï¼ˆå¦‚æˆ˜å£«ã€ç›—è´¼ã€åˆºå®¢ã€å¦“å¥³ã€è°ƒæ•™å¸ˆï¼‰ã€èƒŒæ™¯æ•…äº‹ï¼ˆå¦‚è®­ç»ƒã€æˆ˜æ–—ã€æ€§å·¥ä½œç»éªŒï¼‰å½±å“
     * **è€åŠ›**ï¼šå—èŒä¸šï¼ˆå¦‚æˆ˜å£«ã€éª‘å£«ï¼‰ã€ç§æ—ï¼ˆå¦‚å…½äººï¼‰ã€ä½“æ ¼ï¼ˆå¦‚å¼ºå£®ï¼‰ã€èƒŒæ™¯æ•…äº‹ï¼ˆå¦‚æˆ˜æ–—ã€è®­ç»ƒï¼‰å½±å“
     * **æ•æ„Ÿåº¦**ï¼šå—èŒä¸šï¼ˆå¦‚æ³•å¸ˆã€èˆè€…ï¼‰ã€ç§æ—ï¼ˆå¦‚ç²¾çµã€é­…é­”ï¼‰ã€æ€§æ ¼ï¼ˆå¦‚æ•æ„Ÿï¼‰ã€èƒŒæ™¯æ•…äº‹ï¼ˆå¦‚æ€§ç»éªŒï¼‰å½±å“
   - **ç¨€æœ‰åº¦å½±å“**ï¼šç¨€æœ‰åº¦åªä½œä¸ºå¾®è°ƒï¼ˆN: +0, R: +2, SR: +4, SSR: +6ï¼‰ï¼Œä¸åº”æ˜¯ä¸»è¦å†³å®šå› ç´ 
   - éœ€è¦ä¸ºæ¯ä¸ªå±æ€§ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ï¼‰æ ¹æ®ä¸Šè¿°é€»è¾‘ç¡®å®šå…·ä½“æ•°å€¼
13. **æƒ…æ„ŸçŠ¶æ€**ï¼šå¯¹ç®¡ç†è€…çš„åˆå§‹æƒ…æ„Ÿã€æƒ…æ„Ÿå¼ºåº¦ã€ç‰¹æ®ŠçŠ¶æ€ï¼ˆåˆå§‹ä¸ºç©ºæ•°ç»„ï¼‰
14. **å‰ç«¯HTMLè®¾è®¡**ï¼šéœ€è¦ä»€ä¹ˆæ ·çš„è§†è§‰é£æ ¼ï¼Ÿå¦‚ä½•ä½“ç°è§’è‰²å…ƒç´ ï¼Ÿä½¿ç”¨å“ªäº›åˆ›æ„è®¾è®¡å…ƒç´ ï¼Ÿ

**ç¬¬ä¸‰æ­¥ï¼šè§’è‰²ä¿¡æ¯çš„å†…åœ¨é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥**
- å…ƒç´ çš„è§†è§‰åŒ–ï¼šå¦‚ä½•å°†å…ƒç´ ï¼ˆå¦‚é•œã€æ°´ã€ç¡è²ï¼‰èå…¥UIè®¾è®¡å’Œè§’è‰²å¤–è§‚ï¼Ÿ
- èƒŒæ™¯æ•…äº‹ä¸æ€§æ ¼çš„åŒ¹é…ï¼šèƒŒæ™¯æ•…äº‹æ˜¯å¦åˆç†æ”¯æ’‘äº†è§’è‰²çš„æ€§æ ¼ç‰¹ç‚¹ï¼Ÿ
- å¤–è²Œä¸ç§æ—çš„åŒ¹é…ï¼šå¤–è²Œæè¿°æ˜¯å¦ç¬¦åˆç§æ—è®¾å®šï¼Ÿ
- èŒä¸šä¸èƒŒæ™¯çš„å…³è”ï¼šèŒä¸šèº«ä»½æ˜¯å¦ä¸èƒŒæ™¯æ•…äº‹æœ‰é€»è¾‘å…³è”ï¼Ÿ
- ç¨€æœ‰åº¦ä¸å±æ€§çš„å¹³è¡¡ï¼šå±æ€§åˆå§‹å€¼æ˜¯å¦ç¬¦åˆç¨€æœ‰åº¦è¦æ±‚ï¼Ÿ

**ç¬¬å››æ­¥ï¼šå‰ç«¯HTMLè®¾è®¡çš„å®Œæ•´è§„åˆ’**
- è§†è§‰é£æ ¼ï¼šæ ¹æ®è§’è‰²å…ƒç´ ï¼Œé€‰æ‹©å“ªäº›è®¾è®¡çµæ„Ÿï¼ˆæè´¨æ„Ÿ/è‰ºæœ¯æµæ´¾/æ–‡åŒ–å…ƒç´ /æ¸¸æˆUIå‚è€ƒï¼‰ï¼Ÿ
- åˆ›æ„å…ƒç´ ï¼šè‡³å°‘ä½¿ç”¨5ç§ï¼ˆè£…é¥°è¾¹æ¡†/èƒŒæ™¯å±‚æ¬¡/åŠ¨æ€è£…é¥°/ä¸»é¢˜å›¾æ ‡/ä¿¡æ¯å¡ç‰‡å·®å¼‚åŒ–/å­—ä½“è‰ºæœ¯/è‰²å½©ç­–ç•¥ï¼‰
- ä¿¡æ¯æ¨¡å—å®Œæ•´æ€§ï¼šå¿…é¡»åŒ…å«æ‰€æœ‰æ¨¡å—ï¼ˆ**å…ƒç´ **ï¼ˆ3-4ä¸ªç‹¬ç‰¹å…ƒç´ ï¼Œå¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªç¨€æœ‰å°ä¼—å…ƒç´ ï¼‰/å§“å/ç¨€æœ‰åº¦/æ€§åˆ«/**ç§æ—/å‡ºèº«**/**èŒä¸š/èº«ä»½**/**å¤–è²Œç‰¹ç‚¹**ï¼ˆè¯¦ç»†æè¿°å‘å‹ã€å‘è‰²ã€ç³è‰²ã€èº«æç‰¹å¾ç­‰ï¼‰/**æ€§æ ¼/å–œå¥½**/ç®€ä»‹/**èƒŒæ™¯æ•…äº‹**ï¼ˆè‡³å°‘1000å­—ï¼‰/å±æ€§æ¡5ä¸ª/å¥½æ„Ÿåº¦/æ¨æ„/ä½“åŠ›å€¼ç­‰ï¼‰ï¼Œ**ç»å¯¹ä¸èƒ½çœç•¥ä»»ä½•æ¨¡å—ï¼**
- æŠ€æœ¯å®ç°ï¼šä½¿ç”¨ä»€ä¹ˆå­—ä½“ï¼Ÿå¦‚ä½•å®ç°åŠ¨æ€æ•ˆæœï¼Ÿå¦‚ä½•ç¡®ä¿æ ·å¼éš”ç¦»ï¼Ÿ

**ç¬¬äº”æ­¥ï¼šç”Ÿæˆé¡ºåºä¸å®Œæ•´æ€§ç¡®è®¤**
åœ¨å¼€å§‹è¾“å‡ºä¹‹å‰ï¼Œå†æ¬¡ç¡®è®¤ï¼š
- æ‰€æœ‰14ä¸ªæ ¸å¿ƒä¿¡æ¯å­—æ®µéƒ½å·²è§„åˆ’å®Œæˆï¼Œæ²¡æœ‰é—æ¼
- å¤–è²Œæç¤ºè¯è¦†ç›–äº†æ‰€æœ‰13ä¸ªç»´åº¦
- èƒŒæ™¯æ•…äº‹è‡³å°‘1000å­—ï¼Œæœ‰å®Œæ•´çš„æƒ…èŠ‚
- å‰ç«¯HTMLåŒ…å«äº†æ‰€æœ‰å¿…éœ€çš„ä¿¡æ¯æ¨¡å—
- å±æ€§æ¡ä½¿ç”¨åŠ¨æ€æ•°æ®ç»‘å®šï¼Œä¸æ˜¯ç¡¬ç¼–ç 
- JSONPatchåŒ…å«äº†æ‰€æœ‰å¿…éœ€å­—æ®µ

**ç¡®è®¤å®Œæˆæ€ç»´é“¾åï¼Œå¼€å§‹ç”Ÿæˆè§’è‰²å¡ã€‚**

---

**ç³»ç»ŸæŒ‡ä»¤ï¼šåŠ¨æ€UI & è§’è‰²ç”Ÿæˆåè®®**

      å½“éœ€è¦ç”Ÿæˆè§’è‰²å¡ã€ç‰©å“å¡æˆ–ä»»ä½•å‰ç«¯äº¤äº’ç•Œé¢æ—¶ï¼Œä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰§è¡Œé€»è¾‘ï¼š

      æ¯ä¸€å¼ å¡ç‰‡ï¼Œéƒ½å°†æ˜¯ä¸€ä»¶ç‹¬ç«‹çš„è‰ºæœ¯å“ã€‚è¿½æ±‚çš„æ˜¯**æè‡´çš„è§†è§‰åŒ¹é…åº¦**å’Œ**å®Œå…¨çš„ç»“æ„è‡ªç”±**ï¼Œä»ç°åœ¨èµ·ï¼Œä½ ä¸å†å¥—ç”¨ä»»ä½•å›ºå®šæ¨¡æ¿ã€‚

      1. **æ ¸å¿ƒæ¸²æŸ“æ¨¡å¼ (Raw HTML Injection)ï¼š**
         - **ç¦æ­¢**ä½¿ç”¨Markdownä»£ç å—ï¼ˆ\`\`\`htmlï¼‰åŒ…è£¹"ç”Ÿå›¾tag"éƒ¨åˆ†çš„ä»£ç ã€‚å…¶ä»–éƒ¨åˆ†å¯ä»¥é…Œæƒ…ä½¿ç”¨ã€‚
         - ç›´æ¥è¾“å‡ºåŸç”ŸHTMLä»£ç ï¼Œä½¿å…¶èå…¥èŠå¤©æµã€‚ä»£ç è¿è¡Œç»“æœéœ€é€‚é…æ‰‹æœºç§»åŠ¨ç«¯çš„é•¿ç‰ˆä¸­æ–‡ç•Œé¢ã€‚
         - HTMLç»“æ„å¿…é¡»åŒ…å«\`<style>\`æ ‡ç­¾ï¼Œåˆ©ç”¨CSSå˜é‡ï¼ˆ:rootï¼‰å®šä¹‰å½“æ¬¡ç”Ÿæˆçš„ä¸“å±ä¸»é¢˜è‰²ã€‚

      2. **è‡ªé€‚åº”ç¾å­¦å¼•æ“ (Aesthetic Engine) - æ‹’ç»å¹³åº¸è®¾è®¡ï¼š**
         - **ç¦æ­¢é€šç”¨æ¨¡æ¿ã€ç¦æ­¢å·æ‡’ï¼š** æ¯å¼ å¡ç‰‡éƒ½æ˜¯ç‹¬ç«‹è‰ºæœ¯å“ï¼Œå¿…é¡»æ ¹æ®è§’è‰²çš„å…ƒç´ ã€ç§æ—ã€èŒä¸šã€é˜µè¥ã€æ—¶ä»£èƒŒæ™¯ã€æ€§æ ¼å³æ—¶è®¾è®¡ä¸€å¥—**å‰æ‰€æœªè§**çš„UIè¯­è¨€ã€‚
         - **è®¾è®¡çµæ„Ÿæ¥æºå¤šå…ƒåŒ–ï¼ˆå¿…é¡»éšæœºé€‰æ‹©è‡³å°‘3ç§èåˆï¼Œä»¥ä¸‹æ˜¯ç¤ºä¾‹ï¼Œä»…ä½œå‚è€ƒï¼Œä½ ä¹Ÿå¯ä»¥è‡ªè¡Œè®¾è®¡ï¼‰ï¼š**
           Â· æè´¨æ„Ÿï¼šç¾Šçš®çº¸/ç»ç’ƒæ‹Ÿæ€/é‡‘å±è´¨æ„Ÿ/æ°´å¢¨é£/éœ“è™¹èµ›åš/å®çŸ³åˆ‡é¢/å†°æ™¶æŠ˜å°„/æœ¨çº¹/ä¸ç»¸/çš®é©/å¤§ç†çŸ³çº¹ç†
           Â· è‰ºæœ¯æµæ´¾ï¼šArt Nouveauæ–°è‰ºæœ¯/Art Decoè£…é¥°è‰ºæœ¯/Baroqueå·´æ´›å…‹/æç®€ä¸»ä¹‰/è’¸æ±½æœ‹å…‹/æ´›å¯å¯/æµ®ä¸–ç»˜/æ³¢æ™®è‰ºæœ¯
           Â· æ–‡åŒ–å…ƒç´ ï¼šä¸­å¼çª—æ£‚/æ—¥å¼å’Œé£/å“¥ç‰¹å¼/åŒ—æ¬§ç¥è¯/é˜¿æ‹‰ä¼¯å‡ ä½•/ä¸œæ¬§æ°‘ä¿—/ç›é›…å›¾è…¾/å‡¯å°”ç‰¹ç»“
           Â· æ¸¸æˆUIå‚è€ƒï¼šåŸç¥/å´©åæ˜Ÿç©¹é“é“/æ˜æ—¥æ–¹èˆŸ/é˜´é˜³å¸ˆ/FGO/ç¢§è“æ¡£æ¡ˆç­‰çŸ¥åæ¸¸æˆçš„UIç¾å­¦
         - **ç¦æ­¢ä»¥ä¸‹å¹³åº¸è®¾è®¡ï¼š**
           Â· çº¯é»‘/çº¯ç™½/çº¯ç°èƒŒæ™¯
           Â· ç®€å•çš„åœ†è§’çŸ©å½¢å¡ç‰‡
           Â· æ™®é€šçš„çº¿æ€§æ¸å˜
           Â· æ— è£…é¥°çš„æ ‡å‡†åˆ—è¡¨å¸ƒå±€

      #### UI/UX è®¾è®¡ï¼šæ¯ä¸ªè§’è‰²å¡éƒ½å¿…é¡»æ˜¯ç‹¬ä¸€æ— äºŒçš„è‰ºæœ¯å“
      **å¼ºåˆ¶åˆ›æ„è¦æ±‚ï¼ˆè‡³å°‘ä½¿ç”¨5ç§ï¼‰ï¼š**
      - **è£…é¥°è¾¹æ¡†**ï¼šä½¿ç”¨SVG/border-image/ä¼ªå…ƒç´ åˆ›é€ ç‹¬ç‰¹è¾¹æ¡†ï¼ˆè—¤è”“ç¼ ç»•/é”é“¾/ç«ç„°/æ°´æµ/äº‘çº¹/å‡ ä½•å›¾æ¡ˆç­‰ï¼‰
      - **èƒŒæ™¯å±‚æ¬¡**ï¼šå¤šå±‚å åŠ æ•ˆæœï¼ˆæ¸å˜+çº¹ç†+åŠé€æ˜è£…é¥°å…ƒç´ +åŠ¨æ€ç²’å­ï¼‰
      - **ç‰¹æ®Šå½¢çŠ¶**ï¼šå¯ä»¥ä½¿ç”¨åœ†è§’ã€è¾¹æ¡†è£…é¥°ï¼Œä½†**ç¦æ­¢ä½¿ç”¨clip-pathåˆ‡å‰²è®¾è®¡**ï¼ˆç¦æ­¢å…­è¾¹å½¢/ä¸è§„åˆ™å¤šè¾¹å½¢/æ³¢æµªè¾¹ç¼˜/æ’•è£‚æ•ˆæœç­‰åˆ‡å‰²è®¾è®¡ï¼Œè¿™äº›è®¾è®¡å¾ˆä¸‘ï¼‰
      - **åŠ¨æ€è£…é¥°**ï¼šCSSåŠ¨ç”»ï¼ˆæµ®åŠ¨å…‰ç‚¹/è„‰å†²å…‰ç¯/é—ªçƒæ˜Ÿæ˜Ÿ/æµåŠ¨çº¿æ¡/å‘¼å¸æ•ˆæœï¼‰
      - **ä¸»é¢˜å›¾æ ‡**ï¼šæ ¹æ®è§’è‰²å…ƒç´ è®¾è®¡ä¸“å±å›¾æ ‡è£…é¥°ï¼ˆç”¨CSS/SVG/emojiç»„åˆåˆ›é€ ï¼‰
      - **ä¿¡æ¯å¡ç‰‡å·®å¼‚åŒ–**ï¼šä¸åŒä¿¡æ¯æ¨¡å—ä½¿ç”¨ä¸åŒçš„å®¹å™¨æ ·å¼ï¼ˆæ ‡ç­¾é¡µ/æŠ˜å å¡/æ‚¬æµ®æç¤º/ä¾§è¾¹æ ç­‰ï¼‰
      - **å­—ä½“è‰ºæœ¯**ï¼šæ ‡é¢˜ä½¿ç”¨è£…é¥°æ€§å­—ä½“+text-shadow/strokeæ•ˆæœï¼Œæ­£æ–‡ä¿æŒå¯è¯»æ€§
      - **è‰²å½©ç­–ç•¥**ï¼šåŸºäºè§’è‰²å…ƒç´ æå–ä¸»é¢˜è‰²ï¼ˆå¦‚ç«å…ƒç´ ç”¨æ©™çº¢æ¸å˜ã€æ°´å…ƒç´ ç”¨è“ç»¿ç»ç’ƒè´¨æ„Ÿã€æš—å…ƒç´ ç”¨æ·±ç´«é…é‡‘è¾¹ç­‰ï¼‰
      - é€šè¿‡ CSS @import å¼•å…¥ Google Fonts å­—ä½“ã€‚**ç¦æ­¢ä½¿ç”¨ Inter/Roboto/Arial ç­‰é€šç”¨å­—ä½“**ï¼Œå¿…é¡»é€‰æ‹©æœ‰ç‰¹è‰²çš„å­—ä½“ï¼ˆCinzel/Playfair Display/Ma Shan Zheng/ZCOOL XiaoWei/Noto Serif SCç­‰ï¼‰
      - å­—ä½“é¢œè‰²å’ŒèƒŒæ™¯é¢œè‰²å¯¹æ¯”ä¸€å®šè¦é«˜ï¼Œé¿å…çœ‹ä¸æ¸…å­—çš„æƒ…å†µã€‚

      **SSRä¸“å±è¦æ±‚ï¼š**
      - å¿…é¡»æœ‰è‡³å°‘2ç§CSSåŠ¨ç”»æ•ˆæœï¼ˆå…‰èŠ’æµåŠ¨/ç²’å­é£˜æ•£/è¾¹æ¡†è„‰å†²/èƒŒæ™¯æ¸å˜å¾ªç¯ç­‰ï¼‰
      - å¿…é¡»æœ‰é‡‘è‰²/å½©è™¹è‰²çš„é«˜å…‰è£…é¥°
      - å¿…é¡»æœ‰"SSR"ä¸“å±å¾½ç« è®¾è®¡

      3. **æ’ä»¶å…¼å®¹æ€§ä¿éšœ (Plugin Safe-Zone)ï¼š**
         - å›¾åƒPromptåŒºåŸŸå¿…é¡»æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„\`div\`ï¼Œè®¾ç½®\`display: block\`ï¼Œ\`min-height: 50px\`ï¼Œä¸”**ä¸¥ç¦ä½¿ç”¨** \`overflow: hidden\`ã€‚
         - Promptæ–‡æœ¬æ ¼å¼ä¸¥æ ¼ä¿æŒï¼š\`image###{Split cues}###\`ã€‚
         - **é‡è¦**ï¼šæ‰€æœ‰æ ·å¼å¿…é¡»ä½¿ç”¨scopedç±»åï¼ˆå¦‚.card-xxxï¼‰ï¼Œé¿å…æ±¡æŸ“å¤–éƒ¨é¡µé¢æ ·å¼ã€‚

      4. **å†…å®¹ç»“æ„è‡ªç”±åŒ–ï¼š**
         - **éçº¿æ€§æ’ç‰ˆï¼š** ä¸å¿…æ­»æ¿éµå¾ª"å§“å-ç¨€æœ‰åº¦-èŒä¸š"çš„åˆ—è¡¨é¡ºåºã€‚å¯ä»¥ç”¨åˆ›æ„å¸ƒå±€ï¼ˆZå­—å½¢/å¯¹è§’çº¿/èºæ—‹/å¡ç‰‡å †å ç­‰ï¼‰ã€‚
         - **å¤šæ ·åŒ–åŠ¨æ€æ¨¡å—ï¼š** æ ¹æ®è§’è‰²ç‰¹æ€§ç”Ÿæˆä¸“å±æ ç›®ï¼ˆnsfwå’Œsfwçš†å¯ï¼‰ã€‚
         - **æ»šåŠ¨æœºåˆ¶ï¼š** è¾ƒé•¿çš„èƒŒæ™¯æ•…äº‹ç­‰æ–‡æœ¬è¾ƒé•¿æ¿å—é‡‡ç”¨å¯æ»šåŠ¨å½¢å¼èŠ‚çœç©ºé—´ã€‚
         - **å®Œæ•´æ€§ï¼š** æ¯æ¬¡ç”Ÿæˆå¿…é¡»è‡³å°‘åŒ…å«æ‰€æœ‰å·²è§„å®šæ¨¡å—ï¼ŒåŒ…æ‹¬ï¼š**å…ƒç´ **ï¼ˆ3-4ä¸ªç‹¬ç‰¹å…ƒç´ ï¼Œå¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªç¨€æœ‰å°ä¼—å…ƒç´ ï¼‰ã€**å§“å**ã€**ç¨€æœ‰åº¦**ï¼ˆN/R/SR/SSRï¼‰ã€**æ€§åˆ«**ï¼ˆç”·æ€§/å¥³æ€§/åŒæ€§ç”·æ€§ï¼‰ã€**ç§æ—/å‡ºèº«**ã€**èŒä¸š/èº«ä»½**ã€**å¤–è²Œç‰¹ç‚¹**ï¼ˆå¿…é¡»è¯¦ç»†æè¿°å‘å‹ï¼ˆåŒ…å«åˆ˜æµ·ç±»å‹/é•¿åº¦/æ˜¯å¦æœ‰è¾«å­ç­‰ï¼‰ã€å‘è‰²ã€ç³è‰²ã€èº«æç‰¹å¾ç­‰ï¼‰ã€**æ€§æ ¼/å–œå¥½**ï¼ˆçœŸå®ã€ç«‹ä½“ï¼‰ã€**ç®€ä»‹**ã€**èƒŒæ™¯æ•…äº‹**ï¼ˆè‡³å°‘1000å­—ï¼‰ã€**äº”ä¸ªå±æ€§æ¡**ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ï¼Œå¿…é¡»ä½¿ç”¨åŠ¨æ€æ•°æ®ç»‘å®šï¼‰ã€**å¥½æ„Ÿåº¦**ï¼ˆ0~100ï¼‰ã€**æ¨æ„**ï¼ˆ0~100ï¼‰ã€**ä½“åŠ›å€¼**ï¼ˆ0~100ï¼‰ã€**å…¶ä»–æ‹“å±•æ ç›®**ã€‚**ç»å¯¹ä¸èƒ½çœç•¥ä»»ä½•æ¨¡å—ï¼**

      **{ä¸–ç•ŒèƒŒæ™¯ä¸{{user}}çš„èº«ä»½ï¼š**
      {{user}}èƒ½å¤Ÿé€šè¿‡"ç©ºç™½å¡"ç³»ç»Ÿå¬å”¤æ¥è‡ªä¸åŒæ—¶ç©ºä¸èƒŒæ™¯çš„ç‹¬ç‰¹ä¸ªä½“ã€‚

      **å¬å”¤æ–¹å¼ï¼š**

      1. **å•æŠ½ï¼š**
         - æ¦‚ç‡ï¼šN (50%), R (30%), SR (15%), SSR (5%)ã€‚
         - æ— è®ºç¨€æœ‰åº¦ï¼Œå‡ä¼šç”Ÿæˆå®Œæ•´è§’è‰²èµ„æ–™ã€‚

      2. **é—ªå…‰æŠ½å¡ï¼ˆSSRå¿…å‡ºï¼‰ï¼š**
         - 100%æ¦‚ç‡è·å¾—SSRè§’è‰²ã€‚

      3. **å®šå‘æŠ½å¡ï¼š**
         - {{user}}æå‡ºè¦æ±‚ï¼ˆå¦‚æ€§åˆ«ã€ç‰¹è´¨ã€èŒä¸šå€¾å‘ç­‰ï¼‰ï¼Œç³»ç»Ÿå°†ç”Ÿæˆç¬¦åˆè¦æ±‚çš„è§’è‰²ã€‚

      **è§’è‰²è®¾å®šæ ¸å¿ƒè§„åˆ™ï¼š**

      - **æ€§åˆ«å¤šæ ·æ€§ï¼š** è§’è‰²æ€§åˆ«å¯ä»¥æ˜¯**ç”·æ€§ã€å¥³æ€§**æˆ–**åŒæ€§ç”·æ€§**ã€‚
      - **ç‹¬ç‰¹æ€§ï¼š** ç”Ÿæˆå…·æœ‰ç‹¬ç‰¹èƒŒæ™¯æ•…äº‹ã€å¤šæ ·ä¸ªæ€§çš„ç¾ä¸½åŸåˆ›è§’è‰²ã€‚

      ç»å¯¹å®¡ç¾åŸåˆ™ï¼ˆè‡³å…³é‡è¦ï¼‰ï¼š å¼ºåˆ¶æ‰€æœ‰ç”Ÿæˆçš„è§’è‰²ï¼ˆæ— è®ºç§æ—ï¼‰å¿…é¡»å…·å¤‡æé«˜çš„äººå½¢ç¾æ„Ÿä¸æ€§å¸å¼•åŠ›ï¼ˆBishounen/Bishoujo/Ikemenï¼‰ã€‚

      ç§æ—ç™½åå•ï¼š ä»…å…è®¸ç”Ÿæˆäººç±»æˆ–ä»»ä½•é«˜åº¦æ‹ŸäººåŒ–ä¸”ç¾å‹çš„ç§æ—ã€‚è¦æ±‚ï¼šå¿…é¡»æ˜¯ç”Ÿç†ç»“æ„æ­£å¸¸çš„è¡€è‚‰ä¹‹èº¯ï¼Œç”Ÿå›¾æ—¶å¯ç”¨skin/fleshå¼ºè°ƒã€‚æˆ‘è¦çš„æ˜¯å®å®åœ¨åœ¨çš„ä½“æ¸©å’Œè§¦æ„Ÿã€‚

      ç§æ—é»‘åå•ï¼šç¦æ­¢ç”Ÿæˆæœºå™¨äººã€äººé€ äººã€äººå¶ç­‰ç”±å‘æ¡ã€é›¶ä»¶ç»„æˆçš„è§’è‰²ã€‚ç¦æ­¢ç”Ÿæˆå¯¸å¤´ã€å£®æ±‰ã€å¤§å”ã€è€äººç­‰ä¸ç¬¦åˆã€ç¾å‹å®¡ç¾ã€‘çš„è§’è‰²ï¼ˆæ— è®ºç”·å¥³éƒ½è¦ä¿Šç¾/è‰³ä¸½ã€å…·æ€§å¸å¼•åŠ›ï¼‰ã€‚ç¦æ­¢ç”Ÿæˆè‚¥èƒ–ã€ä¸‘é™‹çš„è§’è‰²ã€‚ç¦æ­¢ä¸‹åŠèº«å¼‚åŒ–ï¼ˆå¦‚äººé±¼ã€åŠäººé©¬ï¼‰ã€‚æ‹’ç»ä»»ä½•åŠé€æ˜ã€æµä½“æˆ–èƒ½é‡ä½“ç‰¹å¾

      - **è§’è‰²æ•…äº‹ï¼š** ä¸è®ºç¨€æœ‰åº¦ï¼Œéƒ½è¦ç”Ÿæˆä¸€ç¯‡ç‹¬ç‰¹çš„è§’è‰²æ•…äº‹ï¼Œä½“ç°è§’è‰²ç‰¹ç‚¹ï¼ˆèŒç‚¹ï¼‰ã€‚ä½“è£ä¸é™ã€‚

      **è§’è‰²èµ„æ–™æ ¼å¼ï¼š**

      å…ƒç´ ï¼šï¼ˆæ¨¡ä»¿äºŒæ¬¡å…ƒocåœˆï¼Œè®¾æƒ³ä¸‰åˆ°å››ä¸ªè¯¥è§’è‰²è®¾è®¡çš„ç‹¬ç‰¹å…ƒç´ ï¼ˆå¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªç¨€æœ‰çš„å°ä¼—å…ƒç´ ï¼‰ï¼Œå¹¶å°†è¿™äº›å…ƒç´ èå…¥è§’è‰²/UIè®¾è®¡ä¸Šã€‚ä¾‹ï¼šæ¬§æ³Šï¼Œé¸¢å°¾èŠ±ï¼Œæµ·æµªã€‚å¿…é¡»æ˜¯å®ç‰©ã€‚ï¼‰
      å§“åï¼š
      ç¨€æœ‰åº¦ï¼šï¼ˆN, R, SR, SSRï¼‰
      æ€§åˆ«ï¼šï¼ˆç”·æ€§ã€å¥³æ€§ ã€åŒæ€§ç”·æ€§ï¼‰
      ç§æ—/å‡ºèº«ï¼š
      èŒä¸š/èº«ä»½ï¼š
      å¤–è²Œç‰¹ç‚¹ï¼šï¼ˆä¸­æ–‡è¯¦ç»†æè¿°å‘å‹(åŒ…å«åˆ˜æµ·ç±»å‹/é•¿åº¦/æ˜¯å¦æœ‰è¾«å­ç­‰)ã€å‘è‰²ã€ç³è‰²ã€èº«æç‰¹å¾ç­‰ï¼Œè®©è¯»è€…èƒ½åœ¨è„‘æµ·ä¸­æ¸…æ™°æç»˜å‡ºè¿™ä¸ªäººç‰©ï¼‰
      æ€§æ ¼/å–œå¥½ï¼š(çœŸå®ã€ç«‹ä½“)
      ç®€ä»‹ï¼š
      èƒŒæ™¯æ•…äº‹ï¼šï¼ˆä¸€ä¸ªå¥½çš„æ•…äº‹æ˜¯è§’è‰²çš„çµé­‚ã€‚è‡³å°‘1000å­—ã€‚å¯ä»¥æ˜¯ä»»æ„ä½“è£å½¢å¼ã€‚ï¼‰
      (å¯æŒ‰éœ€è‡ªç”±æ·»åŠ å…¶ä»–æ‹“å±•æ ç›®)

      **ã€é‡è¦ã€‘å¤–è²Œæç¤ºè¯ï¼ˆè‹±æ–‡ï¼Œç”¨äºè‡ªåŠ¨é…å›¾å¤ç”¨ï¼‰ï¼š**
      è¿™æ˜¯ä¸€æ®µ**çº¯è‹±æ–‡**çš„ã€æå…¶è¯¦ç»†çš„å¤–è²Œæè¿°æ ‡ç­¾ï¼Œç”¨äºåç»­è‡ªåŠ¨é…å›¾æ—¶å¤ç”¨ã€‚å¿…é¡»è¦†ç›–ä»¥ä¸‹æ‰€æœ‰ç»´åº¦ï¼ˆæ¯ä¸ªç»´åº¦éƒ½è¦æœ‰å…·ä½“çš„æ ‡ç­¾ï¼Œä¸èƒ½çœç•¥ï¼‰ï¼š

      1. **æ€§åˆ«ä¸å¹´é¾„æ®µ**ï¼š1man/1girl/1person, young adult/teen/mature/youthfulç­‰
      2. **æ•´ä½“æ°”è´¨**ï¼šelegant/cute/cool/mysterious/seductive/innocent/wild/nobleç­‰
      3. **é¢éƒ¨ç»“æ„**ï¼šface shapeï¼ˆoval face/heart-shaped face/angular faceç­‰ï¼‰
      4. **çœ¼ç›è¯¦è§£**ï¼š
         - çœ¼å‹ï¼šalmond eyes/round eyes/narrow eyes/upturned eyes/droopy eyes/fox eyes/doe eyesç­‰
         - ç³è‰²ï¼šå…·ä½“é¢œè‰²å¦‚sapphire blue eyes/amber eyes/heterochromia/gradient irisç­‰
         - ç«æ¯›ï¼šlong eyelashes/thick eyelashes/curled lashesç­‰
         - çœ¼ç¥ï¼šgentle gaze/sharp gaze/dreamy eyes/piercing eyesç­‰
      5. **çœ‰æ¯›**ï¼šarched eyebrows/straight eyebrows/thin eyebrows/thick eyebrows/defined browsç­‰
      6. **é¼»å­å˜´å”‡**ï¼šsmall nose/high nose bridge/plump lips/thin lips/cupid's bow lipsç­‰
      7. **å‘å‹å®Œæ•´æè¿°**ï¼š
         - é•¿åº¦ï¼šlong hair/medium hair/short hair/very long hairç­‰
         - è´¨æ„Ÿï¼šstraight hair/wavy hair/curly hair/silky hair/fluffy hairç­‰
         - åˆ˜æµ·ï¼šblunt bangs/side-swept bangs/parted bangs/curtain bangs/no bangs/foreheadç­‰
         - è¾«å­/é€ å‹ï¼šbraid/twin braids/side braid/fishtail braid/ponytail/twintails/bun/half updo/loose hairç­‰
         - å‘è‰²ï¼šå…·ä½“é¢œè‰²å¦‚platinum blonde/ash grey/raven black/cherry red/gradient hairç­‰
         - å‘é¥°ï¼šhair ribbon/hairpin/flower in hair/hair ornamentç­‰
      8. **è‚¤è‰²ä¸è‚¤è´¨**ï¼špale skin/fair skin/tan skin/dark skin/porcelain skin/smooth skinç­‰
      9. **èº«æè¯¦è§£**ï¼š
         - èº«é«˜ä½“å‹ï¼štall/petite/short/average height/slender/slim/curvy/athletic/muscular/litheç­‰
         - èƒ¸éƒ¨ï¼ˆå¦‚é€‚ç”¨ï¼‰ï¼šflat chest/small breasts/medium breasts/large breastsç­‰
         - è…°è‡€ï¼šnarrow waist/wide hips/slim waist/hourglass figureç­‰
         - å››è‚¢ï¼šlong legs/slender arms/toned limbsç­‰
      10. **ç‰¹æ®Šæ ‡è®°**ï¼šbeauty mark/mole/freckles/scar/tattoo/piercingç­‰ï¼ˆå¦‚æœ‰ï¼‰
      11. **ç§æ—ç‰¹å¾**ï¼ˆå¦‚é€‚ç”¨ï¼‰ï¼špointy ears/elf ears/horns/wings/tail/animal ears/fangsç­‰
      12. **åŸºç¡€æœè£…é£æ ¼**ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰ï¼šuniform/dress/casual/fantasy outfitç­‰
      13. **è´¨é‡æ ‡ç­¾**ï¼šdetailed face, detailed eyes, detailed skin, beautiful, aesthetic

      ç¤ºä¾‹æ ¼å¼ï¼ˆæ³¨æ„ï¼šè¿™åªæ˜¯æ ¼å¼ç¤ºä¾‹ï¼Œä½ å¿…é¡»æ ¹æ®è§’è‰²åˆ›é€ ç‹¬ç‰¹çš„ç»„åˆï¼‰ï¼š
      \`1man, young adult, elegant, oval face, narrow fox eyes, deep crimson eyes, long eyelashes, arched eyebrows, high nose bridge, thin lips, very long hair, silky straight hair, side-swept bangs, raven black hair with red highlights, hair ribbon, pale porcelain skin, tall, slender, narrow waist, long legs, beauty mark under left eye, pointy ears, detailed face, detailed eyes, detailed skin, beautiful, aesthetic\`

      **AIç»˜å›¾æ ‡ç­¾ç”Ÿæˆè§„åˆ™ï¼ˆé‡è¦ï¼‰ï¼š**

      - **åŒåˆ†é•œæ ¼å¼ï¼š** æ ‡ç­¾å°†ä¸¥æ ¼æŒ‰ç…§NovelAIçš„æ ¼å¼ç”Ÿæˆï¼Œæ—¨åœ¨ç”Ÿæˆä¸€å¼ åŒ…å«ä¸¤ä¸ªç‹¬ç«‹åˆ†é•œçš„å›¾åƒï¼šå·¦ä¾§ä¸ºæ­£å¸¸è§’è‰²äººè®¾å›¾ï¼ˆSFWï¼Œæ¨¡ä»¿äºŒæ¬¡å…ƒå¡ç‰Œæ¸¸æˆçš„è§’è‰²å¡é¢ï¼‰ï¼Œå³ä¾§ä¸ºæˆäººå‘æ°›å›´å›¾ï¼ˆNSFW/Erotic & Aestheticï¼‰ã€‚

        - **æˆäººå‘é£æ ¼ï¼ˆæè‡´è‰²æƒ…åŒ–ï¼‰ï¼š** æ ¹æ®è§’è‰²ç‰¹å¾é€‰æ‹©åˆé€‚çš„playä¸æƒ…å¢ƒï¼Œä¾§é‡äºè¡¨æƒ…å·®åˆ†ã€å¤šæ ·åŒ–ä½“ä½äº’åŠ¨ã€‚å¤šæ ·åŒ–æ€§ç™–ï¼šå¼ºå¥¸ä¾µçŠ¯ã€è½®å¥¸ã€å‡Œè¾±è°ƒæ•™ã€æ€§éªšæ‰°ã€æ€§ç©å…·ã€è½»å¾®æˆ˜æŸã€è™è…¹çª’æ¯ã€è½»åº¦BDSMã€å¤±ç¦ã€å…½äº¤ã€è§¦æ‰‹ã€å­•å¦‡playã€çº¯çˆ±ç­‰å„ç§æ€§ç™–ã€‚å¯ä»¥å‡ºç°ä»–äººçš„è‚¢ä½“åŠ å¼ºç”»é¢æ•ˆæœã€‚

      ç»å¯¹ç¦æ­¢å†…å®¹/é»‘åå•ï¼ˆNegative Contentï¼‰ï¼š ä¸¥ç¦ Insects/Wormsï¼ˆæ˜†è™«/è •è™«ç­‰æ´»ä½“æ˜†è™«ï¼Œä½†å…è®¸è™«åµï¼‰ã€Necrophiliaï¼ˆå°¸å¥¸ï¼‰ã€Amputeeï¼ˆæˆªè‚¢ï¼‰ã€Furriestï¼ˆå…¨å…½åŒ–ï¼‰ã€‚ä¸¥ç¦å·¨å¤§æ€§å™¨å®˜ã€å¸¦é¢œè‰²çš„æ€§å™¨å®˜ç­‰ä»»ä½•ä¸ç¬¦åˆæ­£å¸¸å®¡ç¾çš„æ€§å™¨å®˜ã€ï¼ˆX-Rayï¼‰èº«ä½“å‰–é¢å›¾/é€è§†å›¾ã€‚

      - ç¤ºä¾‹ç»“æ„ï¼ˆä»…ä¾›å‚è€ƒã€‚å¯ä»¥æŒ‰è‡ªå·±çš„ç†è§£ä¼˜åŒ–æ•´ä½“ç»“æ„ï¼Œä¿è¯ã€äººè®¾å›¾+NSFWå›¾ã€‘è§’è‰²ä¸€è‡´æ€§ï¼‰ï¼š
      image###masterpiece, best quality, 8k, {{consistent character}},{split image},{two panels},{consistent physique},
      {{1man, solo, [åœ¨æ­¤å¤„ç›´æ¥å¤ç”¨ä¸Šé¢çš„å®Œæ•´å¤–è²Œæç¤ºè¯]}}
      { left panel: sfw, [è¿™é‡Œæ”¾äººè®¾å›¾çš„å§¿åŠ¿/è¡¨æƒ…/æœè£…/èƒŒæ™¯ç­‰tag] },
      { right panel: nsfw, [è¿™é‡Œæ”¾NSFWåœºæ™¯çš„å…·ä½“tag] }###

      **æœ¬æ¬¡æŠ½å¡è¦æ±‚ï¼š**
      - æŠ½å¡ç±»å‹ï¼š${type}
      - ç›®æ ‡ç¨€æœ‰åº¦ï¼š${targetRarity}ï¼ˆå·²é€šè¿‡çœŸéšæœºç”Ÿæˆï¼‰
      ${customRequirement ? `- ç”¨æˆ·è¦æ±‚ï¼š${customRequirement}` : ''}

      **å¿…é¡»æ‰§è¡Œçš„æ“ä½œï¼š**

      1. **ç”Ÿæˆè§’è‰²ä¿¡æ¯ï¼š**
         - å…ƒç´ ï¼ˆ3-4ä¸ªç‹¬ç‰¹å…ƒç´ ï¼ŒåŒ…å«è‡³å°‘ä¸€ä¸ªç¨€æœ‰å°ä¼—å…ƒç´ ï¼‰
         - å§“å
         - ç¨€æœ‰åº¦ï¼š${targetRarity}
         - æ€§åˆ«ï¼ˆç”·æ€§/å¥³æ€§/åŒæ€§ç”·æ€§ï¼‰
         - ç§æ—/å‡ºèº«ï¼ˆä»…é™äººç±»æˆ–é«˜åº¦æ‹ŸäººåŒ–ç¾å‹ç§æ—ï¼Œç¦æ­¢æœºå™¨äººã€äººå¶ç­‰ï¼‰
         - èŒä¸š/èº«ä»½
         - å¤–è²Œç‰¹ç‚¹ï¼ˆä¸­æ–‡è¯¦ç»†æè¿°ï¼Œå¿…é¡»ç¬¦åˆå®¡ç¾åŸåˆ™ï¼Œè®©è¯»è€…èƒ½åœ¨è„‘æµ·ä¸­æ¸…æ™°æç»˜å‡ºè¿™ä¸ªäººç‰©ï¼‰
         - æ€§æ ¼/å–œå¥½ï¼ˆçœŸå®ã€ç«‹ä½“ï¼‰
         - ç®€ä»‹
         - èƒŒæ™¯æ•…äº‹ï¼ˆè‡³å°‘1000å­—ï¼Œä½“è£ä¸é™ï¼‰
         - **ã€é‡è¦ã€‘å¤–è²Œæç¤ºè¯**ï¼ˆçº¯è‹±æ–‡ï¼Œæå…¶è¯¦ç»†ï¼Œå¿…é¡»è¦†ç›–ä¸Šè¿°è§„å®šçš„æ‰€æœ‰13ä¸ªç»´åº¦ï¼Œè¿™æ˜¯åç»­è‡ªåŠ¨é…å›¾çš„æ ¸å¿ƒä¾èµ–ï¼‰

      2. **ç”ŸæˆAIç»˜å›¾æ ‡ç­¾ï¼š**
         - å¿…é¡»ç”Ÿæˆ image###...### æ ¼å¼çš„æ ‡ç­¾
         - ä¸¥æ ¼æŒ‰ç…§NovelAIåŒåˆ†é•œæ ¼å¼
         - åœ¨{{}}ä¸­ç›´æ¥å¤ç”¨ä¸Šé¢ç”Ÿæˆçš„å®Œæ•´å¤–è²Œæç¤ºè¯
         - å·¦ä¾§ï¼šSFWäººè®¾å›¾ï¼ˆæ¨¡ä»¿äºŒæ¬¡å…ƒå¡ç‰Œæ¸¸æˆå¡é¢ï¼‰
         - å³ä¾§ï¼šNSFWæ¶©å›¾ï¼ˆç¾è§‚ã€æ·«é¡ã€è‰²æ°”ï¼Œæ ¹æ®è§’è‰²ç‰¹å¾é€‰æ‹©åˆé€‚playï¼‰
         - ç¦æ­¢é»‘åå•å†…å®¹

      3. **ç”Ÿæˆå‰ç«¯HTMLè§’è‰²å¡ï¼ˆå¿…é¡»æ˜¯ç‹¬ä¸€æ— äºŒçš„è‰ºæœ¯å“ï¼‰ï¼š**
         - **ç›´æ¥è¾“å‡ºåŸç”ŸHTMLï¼Œç¦æ­¢ç”¨markdownä»£ç å—åŒ…è£¹**
         - å¿…é¡»åŒ…å«å®Œæ•´çš„\`<style>\`æ ‡ç­¾ï¼Œä½¿ç”¨scopedç±»åï¼ˆå¦‚.card-è§’è‰²åï¼‰é¿å…æ ·å¼æ±¡æŸ“
         - **ç¦æ­¢å·æ‡’ä½¿ç”¨é€šç”¨æ¨¡æ¿**ï¼Œå¿…é¡»æ ¹æ®è§’è‰²å…ƒç´ /èƒŒæ™¯/æ€§æ ¼è®¾è®¡ç‹¬ç‰¹çš„è§†è§‰è¯­è¨€
         - å¿…é¡»ä½¿ç”¨è‡³å°‘3ç§åˆ›æ„è®¾è®¡å…ƒç´ ï¼ˆè£…é¥°è¾¹æ¡†/ç‰¹æ®Šå½¢çŠ¶/åŠ¨æ€è£…é¥°/ä¸»é¢˜å›¾æ ‡/å¤šå±‚èƒŒæ™¯ç­‰ï¼‰
         - ä½¿ç”¨CSS @importå¼•å…¥Google Fontsï¼Œç¦æ­¢ä½¿ç”¨Inter/Roboto/Arialç­‰é€šç”¨å­—ä½“
         - å›¾åƒPromptåŒºåŸŸå¿…é¡»æ˜¯ç‹¬ç«‹çš„divï¼Œdisplay: blockï¼Œmin-height: 50pxï¼Œä¸èƒ½ä½¿ç”¨overflow: hidden
         - Promptæ–‡æœ¬æ ¼å¼ï¼šimage###{Split cues}###
         - **ã€å¼ºåˆ¶è¦æ±‚ã€‘å¿…é¡»æ˜¾ç¤ºäº”ä¸ªå®Œæ•´çš„å±æ€§æ•°å€¼æ¡ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ï¼‰ï¼Œæ¯ä¸ªå±æ€§éƒ½è¦æœ‰è¿›åº¦æ¡å’Œæ•°å€¼æ˜¾ç¤ºï¼Œä¸èƒ½éšæœºæ˜¾ç¤ºéƒ¨åˆ†å±æ€§ï¼Œä¸èƒ½çœç•¥ä»»ä½•å±æ€§ï¼æ‰€æœ‰å±æ€§æ¡çš„ä¸Šé™éƒ½æ˜¯100ï¼Œæ— è®ºè§’è‰²ç¨€æœ‰åº¦å¦‚ä½•ï¼**
         - **ã€å¼ºåˆ¶è¦æ±‚ã€‘å¿…é¡»åŒ…å«è§’è‰²çš„æ‰€æœ‰ä¿¡æ¯æ¨¡å—ï¼Œä¸èƒ½å·æ‡’çœç•¥ä»»ä½•æ¨¡å—ï¼å¿…é¡»åŒ…å«ä»¥ä¸‹æ‰€æœ‰å†…å®¹ï¼š**
           * **å…ƒç´ **ï¼ˆ3-4ä¸ªç‹¬ç‰¹å…ƒç´ ï¼Œå¿…é¡»æ˜¾ç¤ºï¼Œå¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªç¨€æœ‰å°ä¼—å…ƒç´ ï¼‰
           * **å§“å**ï¼ˆå¿…é¡»æ˜¾ç¤ºï¼‰
           * **ç¨€æœ‰åº¦**ï¼ˆN/R/SR/SSRï¼Œå¿…é¡»æ˜¾ç¤ºï¼‰
           * **æ€§åˆ«**ï¼ˆç”·æ€§/å¥³æ€§/åŒæ€§ç”·æ€§ï¼Œå¿…é¡»æ˜¾ç¤ºï¼‰
           * **ç§æ—/å‡ºèº«**ï¼ˆå¿…é¡»æ˜¾ç¤ºï¼‰
           * **èŒä¸š/èº«ä»½**ï¼ˆå¿…é¡»æ˜¾ç¤ºï¼‰
           * **å¤–è²Œç‰¹ç‚¹**ï¼ˆå¿…é¡»è¯¦ç»†æ˜¾ç¤ºï¼ŒåŒ…æ‹¬ï¼šå‘å‹ï¼ˆåŒ…å«åˆ˜æµ·ç±»å‹/é•¿åº¦/æ˜¯å¦æœ‰è¾«å­ç­‰ï¼‰ã€å‘è‰²ã€ç³è‰²ã€èº«æç‰¹å¾ç­‰æ‰€æœ‰å¤–è²Œç»†èŠ‚ï¼Œè®©è¯»è€…èƒ½åœ¨è„‘æµ·ä¸­æ¸…æ™°æç»˜å‡ºè¿™ä¸ªäººç‰©ï¼‰
           * **æ€§æ ¼/å–œå¥½**ï¼ˆå¿…é¡»æ˜¾ç¤ºï¼ŒçœŸå®ã€ç«‹ä½“çš„æè¿°ï¼‰
           * **ç®€ä»‹**ï¼ˆå¿…é¡»æ˜¾ç¤ºï¼‰
           * **èƒŒæ™¯æ•…äº‹**ï¼ˆè‡³å°‘1000å­—ï¼Œå¿…é¡»å®Œæ•´æ˜¾ç¤ºï¼Œå¯ä»¥é‡‡ç”¨å¯æ»šåŠ¨å½¢å¼ï¼‰
           * **å±æ€§**ï¼ˆ5ä¸ªå®Œæ•´æ•°å€¼æ¡ï¼šé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ï¼Œå¿…é¡»ä½¿ç”¨åŠ¨æ€æ•°æ®ç»‘å®šï¼‰
           * **å¥½æ„Ÿåº¦**ï¼ˆ0~100ï¼Œå¿…é¡»æ˜¾ç¤ºï¼‰
           * **æ¨æ„**ï¼ˆ0~100ï¼Œå¿…é¡»æ˜¾ç¤ºï¼‰
           * **ä½“åŠ›å€¼**ï¼ˆ0~100ï¼Œå¿…é¡»æ˜¾ç¤ºï¼‰
           * **å…¶ä»–æ‹“å±•æ ç›®**ï¼ˆå¯æ ¹æ®è§’è‰²ç‰¹æ€§æ·»åŠ ï¼‰
         - **ã€å¼ºåˆ¶è¦æ±‚ã€‘å±æ€§æ¡å¿…é¡»ä½¿ç”¨åŠ¨æ€æ•°æ®ç»‘å®šæˆ–JavaScriptæ¥æ˜¾ç¤ºæœ€æ–°æ•°å€¼ï¼Œä¸èƒ½ä½¿ç”¨ç¡¬ç¼–ç çš„å›ºå®šæ•°å€¼ï¼**
         - **ã€å¼ºåˆ¶è¦æ±‚ã€‘å¤–è²Œç‰¹ç‚¹å¿…é¡»è¯¦ç»†æè¿°ï¼ŒåŒ…æ‹¬å‘å‹ï¼ˆåˆ˜æµ·ç±»å‹/é•¿åº¦/æ˜¯å¦æœ‰è¾«å­ç­‰ï¼‰ã€å‘è‰²ã€ç³è‰²ã€èº«æç‰¹å¾ç­‰ï¼Œä¸èƒ½çœç•¥ä»»ä½•ç»†èŠ‚ï¼**
         - éçº¿æ€§åˆ›æ„æ’ç‰ˆï¼ˆZå­—å½¢/å¯¹è§’çº¿/å¡ç‰‡å †å ç­‰ï¼‰ï¼Œæ ¹æ®è®¾è®¡ç¾æ„Ÿè‡ªç”±æ’å¸ƒ
         - è¾ƒé•¿çš„èƒŒæ™¯æ•…äº‹ç­‰æ–‡æœ¬é‡‡ç”¨å¯æ»šåŠ¨å½¢å¼
         - ${targetRarity === 'SSR' ? '**SSRè§’è‰²å¿…é¡»åŒ…å«è‡³å°‘2ç§CSSåŠ¨ç”»æ•ˆæœï¼ˆå…‰èŠ’æµåŠ¨/ç²’å­é£˜æ•£/è¾¹æ¡†è„‰å†²ç­‰ï¼‰+ é‡‘è‰²/å½©è™¹é«˜å…‰è£…é¥° + SSRä¸“å±å¾½ç« **' : targetRarity === 'SR' ? 'SRè§’è‰²å»ºè®®åŒ…å«1ç§CSSåŠ¨ç”»æ•ˆæœ' : ''}
         - é€‚é…æ‰‹æœºç§»åŠ¨ç«¯é•¿ç‰ˆä¸­æ–‡ç•Œé¢

      4. **æ›´æ–°æ¸¸æˆçŠ¶æ€ï¼ˆä½¿ç”¨JSONPatchæ ¼å¼ï¼‰ï¼š**
         - å°†æ–°è§’è‰²æ·»åŠ åˆ°è§’è‰²ä»“åº“
         - æ–°è§’è‰²å¿…é¡»åŒ…å«å­—æ®µï¼šå…ƒç´ ã€å§“åã€ç¨€æœ‰åº¦ã€æ€§åˆ«ã€ç§æ—å‡ºèº«ã€èŒä¸šèº«ä»½ã€å¤–è²Œç‰¹ç‚¹ã€æ€§æ ¼å–œå¥½ã€ç®€ä»‹ã€èƒŒæ™¯æ•…äº‹ã€ç»˜å›¾æ ‡ç­¾ã€è‡ªå®šä¹‰å‰ç«¯HTMLã€**å¤–è²Œæç¤ºè¯ï¼ˆå¿…é¡»æ˜¯ä¸Šé¢ç”Ÿæˆçš„å®Œæ•´è‹±æ–‡å¤–è²Œæè¿°ï¼Œä¸æ˜¯ä»ç»˜å›¾æ ‡ç­¾æå–ï¼Œè€Œæ˜¯ç‹¬ç«‹çš„è¯¦ç»†å¤–è²Œpromptï¼‰**ã€å¥½æ„Ÿåº¦ï¼ˆ0~100ï¼‰ã€æ¨æ„ï¼ˆ0~100ï¼‰ã€å±æ€§ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ï¼Œåˆå§‹å€¼åº”æ ¹æ®è§’è‰²çš„èŒä¸š/èº«ä»½ã€ä½“æ ¼ã€è¿‡å»çš„ç»éªŒã€ç§æ—/å‡ºèº«ã€æ€§æ ¼ç­‰å› ç´ ç»¼åˆè®¡ç®—ï¼Œä¸€èˆ¬æƒ…å†µ0-25ï¼Œç‰¹æ®Šæƒ…å†µå¦‚é­…é­”ã€å¦“å¥³ç­‰25-50ï¼Œè¯¦è§ç¬¬12ç‚¹è¯´æ˜ï¼‰ã€æƒ…æ„ŸçŠ¶æ€ï¼ˆå¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿã€æƒ…æ„Ÿå¼ºåº¦ã€ç‰¹æ®ŠçŠ¶æ€ï¼‰ã€çŠ¶æ€ï¼ˆåˆå§‹ä¸º"ç©ºé—²"ï¼‰ã€å½“å‰ä½ç½®ï¼ˆåˆå§‹ä¸º"ä»“åº“"ï¼‰ã€ç»éªŒå€¼ï¼ˆåˆå§‹ä¸º0ï¼‰ã€ç­‰çº§ï¼ˆåˆå§‹ä¸º1ï¼‰ã€æ¥å®¢æ¬¡æ•°ï¼ˆåˆå§‹ä¸º0ï¼‰ã€è°ƒæ•™æ¬¡æ•°ï¼ˆåˆå§‹ä¸º0ï¼‰ã€æ”¶å…¥è´¡çŒ®ï¼ˆåˆå§‹ä¸º0ï¼‰ã€æœ€åäº’åŠ¨ï¼ˆå½“å‰å›åˆæ•°ï¼‰ã€ä½“åŠ›å€¼ï¼ˆåˆå§‹ä¸º100ï¼‰
         - æ‰£é™¤è´§å¸ï¼š${cost}é‡‘
         - æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼šæ€»æŠ½å¡æ¬¡æ•°+1ï¼Œæ€»è·å¾—è§’è‰²+1ï¼Œå¯¹åº”ç¨€æœ‰åº¦è®¡æ•°+1ï¼Œå¯¹åº”æƒ…æ„Ÿç±»å‹è®¡æ•°+1

      **é‡è¦æé†’ï¼š**
      - å‰ç«¯HTMLå¿…é¡»å®Œæ•´ï¼ŒåŒ…å«ä»\`<style>\`å¼€å§‹åˆ°æœ€åä¸€ä¸ªé—­åˆæ ‡ç­¾çš„å®Œæ•´ç»“æ„
      - å‰ç«¯HTMLç›´æ¥è¾“å‡ºåœ¨å›å¤ä¸­ï¼Œ**ç»å¯¹ä¸è¦ç”¨\`\`\`htmlä»£ç å—åŒ…è£¹**
      - å‰ç«¯HTMLä¼šç”±ç³»ç»Ÿè‡ªåŠ¨ä¿å­˜åˆ°è§’è‰².è‡ªå®šä¹‰å‰ç«¯HTMLå­—æ®µä¸­
      - ç¡®ä¿å‰ç«¯HTMLç»“æ„å®Œæ•´ï¼Œèƒ½å¤Ÿç‹¬ç«‹æ¸²æŸ“
      - ä½¿ç”¨çœŸéšæœºæ¦‚ç‡ï¼Œä¸è¦äººä¸ºè°ƒæ•´ç¨€æœ‰åº¦åˆ†å¸ƒ`;

        await sendCommandToAI(command);
      }

      // ==================== AI äº¤äº’æ¥å£ ====================
      async function sendCommandToAI(command, skipAutoRound = false) {
        try {
          if (typeof generate !== 'undefined') {
            const response = await generate({ user_input: command });
            // å¦‚æœskipAutoRoundä¸ºtrueï¼Œè¯´æ˜è°ƒç”¨è€…ä¼šè‡ªå·±å¤„ç†å“åº”å’Œæ¨è¿›å›åˆ
            if (!skipAutoRound) {
              parseAIResponse(response);
            }
            return response;
          } else if (typeof SillyTavern !== 'undefined') {
            SillyTavern.sendMessage(command);
            return null; // SillyTavernä¸ä¼šç«‹å³è¿”å›å“åº”
          } else {
            await navigator.clipboard.writeText(command);
            if (typeof toastr !== 'undefined') {
              toastr.info('æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·ç²˜è´´åˆ°èŠå¤©æ¡†å‘é€ç»™ AI');
            } else {
              alert(`æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ${command}\nè¯·ç²˜è´´åˆ°èŠå¤©æ¡†å‘é€ç»™ AI`);
            }
            return null;
          }
        } catch (error) {
          console.error('å‘é€æŒ‡ä»¤å¤±è´¥:', error);
          try {
            await navigator.clipboard.writeText(command);
            if (typeof toastr !== 'undefined') {
              toastr.warning('å‘é€æŒ‡ä»¤å¤±è´¥ï¼Œå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´');
            } else {
              alert(`å‘é€æŒ‡ä»¤å¤±è´¥ï¼Œå·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ${command}\nè¯·ç²˜è´´åˆ°èŠå¤©æ¡†å‘é€ç»™ AI`);
            }
          } catch (clipboardError) {
            console.error('å¤åˆ¶åˆ°å‰ªè´´æ¿å¤±è´¥:', clipboardError);
            if (typeof toastr !== 'undefined') {
              toastr.error('å‘é€æŒ‡ä»¤å¤±è´¥ï¼Œä¸”æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } else {
              alert('å‘é€æŒ‡ä»¤å¤±è´¥ï¼Œä¸”æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }
          }
          return null;
        }
      }

      function parseAIResponse(response) {
        // æ”¹è¿›çš„HTMLæå–é€»è¾‘ï¼šæå–å®Œæ•´çš„HTMLè§’è‰²å¡
        let extractedHtmlCard = '';

        // æŸ¥æ‰¾HTMLå¡ç‰‡
        const styleMatch = response.match(/<style>[\s\S]*?<\/style>/);

        if (styleMatch) {
          const styleStartIndex = styleMatch.index;
          const styleEndIndex = styleMatch.index + styleMatch[0].length;

          // ä» </style> ä¹‹åå¼€å§‹æŸ¥æ‰¾HTMLå†…å®¹
          let htmlStart = styleEndIndex;
          let htmlEnd = -1;

          // è·³è¿‡ç©ºç™½å­—ç¬¦
          while (htmlStart < response.length && /\s/.test(response[htmlStart])) {
            htmlStart++;
          }

          // æŸ¥æ‰¾ç¬¬ä¸€ä¸ª <div æˆ– <section æˆ–å…¶ä»–HTMLæ ‡ç­¾
          const firstTagMatch = response.substring(htmlStart).match(/<(\w+)[\s>]/);
          if (firstTagMatch) {
            const tagName = firstTagMatch[1];
            const tagStart = htmlStart + firstTagMatch.index;

            // æŸ¥æ‰¾åŒ¹é…çš„é—­åˆæ ‡ç­¾
            let tagCount = 0;
            let inTag = false;
            let tagBuffer = '';

            for (let i = tagStart; i < response.length; i++) {
              const char = response[i];

              if (char === '<') {
                inTag = true;
                tagBuffer = '<';
              } else if (char === '>') {
                tagBuffer += '>';
                inTag = false;

                // æ£€æŸ¥æ˜¯å¦æ˜¯å¼€å§‹æ ‡ç­¾
                if (tagBuffer.match(new RegExp(`<${tagName}[\\s>]`))) {
                  tagCount++;
                }
                // æ£€æŸ¥æ˜¯å¦æ˜¯é—­åˆæ ‡ç­¾
                else if (tagBuffer.match(new RegExp(`</${tagName}>`))) {
                  tagCount--;
                  if (tagCount === 0) {
                    htmlEnd = i + 1;
                    break;
                  }
                }

                tagBuffer = '';
              } else if (inTag) {
                tagBuffer += char;
              }
            }

            if (htmlEnd > htmlStart) {
              extractedHtmlCard = response.substring(styleStartIndex, htmlEnd);
            } else {
              // æ–¹æ³•2ï¼šå¦‚æœæ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æå–åˆ°JSONPatch
              const jsonPatchStart = response.indexOf('<JSONPatch>', styleEndIndex);
              const endPos = jsonPatchStart > 0 ? jsonPatchStart : response.length;

              if (endPos > styleStartIndex) {
                extractedHtmlCard = response.substring(styleStartIndex, endPos).trim();
              }
            }

            // æ¸…ç†æå–çš„HTML
            extractedHtmlCard = extractedHtmlCard.replace(/^```html\s*/i, '').replace(/\s*```$/i, '');
            extractedHtmlCard = extractedHtmlCard.replace(/^```\s*/i, '').replace(/\s*```$/i, '');

            if (extractedHtmlCard && extractedHtmlCard.length > 100) {
              console.info('æå–åˆ°å‰ç«¯HTMLï¼Œé•¿åº¦:', extractedHtmlCard.length);

              // åœ¨æŠ½å¡ç•Œé¢æ˜¾ç¤º
              const cardDisplay = document.getElementById('character-card-display');
              if (cardDisplay) {
                cardDisplay.style.display = 'block';
                cardDisplay.innerHTML = `<div style="max-width: 100%; overflow-x: auto; box-sizing: border-box">${extractedHtmlCard}</div>`;

                // æ»šåŠ¨åˆ°å¡ç‰‡æ˜¾ç¤ºåŒºåŸŸ
                setTimeout(() => {
                  cardDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
              }
            }
          }
        }

        // è§£æ JSON Patchï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
        let jsonPatchMatch = response.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/);
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ ‡å‡†æ ¼å¼ï¼Œå°è¯•å…¶ä»–æ ¼å¼
        if (!jsonPatchMatch) {
          jsonPatchMatch = response.match(/```json\s*([\s\S]*?)\s*```/);
          if (jsonPatchMatch) {
            console.warn('âš ï¸ ä½¿ç”¨å¤‡ç”¨æ ¼å¼è§£æJSON Patchï¼ˆä»£ç å—æ ¼å¼ï¼‰');
          }
        }
        // å†å°è¯•ç›´æ¥æ‰¾JSONæ•°ç»„
        if (!jsonPatchMatch) {
          const jsonArrayMatch = response.match(/\[\s*\{[\s\S]*?\}\s*\]/);
          if (jsonArrayMatch) {
            console.warn('âš ï¸ ä½¿ç”¨å¤‡ç”¨æ ¼å¼è§£æJSON Patchï¼ˆç›´æ¥JSONæ•°ç»„ï¼‰');
            jsonPatchMatch = { 1: jsonArrayMatch[0] };
          }
        }

        let patchesApplied = false;
        let hasNewCharacter = false;

        if (jsonPatchMatch) {
          try {
            const jsonContent = cleanJsonString(jsonPatchMatch[1]);
            console.info('ğŸ“„ JSON Patch åŸå§‹å†…å®¹é•¿åº¦:', jsonContent.length);
            console.info('ğŸ“„ JSON Patch åŸå§‹å†…å®¹é¢„è§ˆ:', jsonContent.substring(0, 500));

            const patches = JSON.parse(jsonContent);
            console.info('âœ… æˆåŠŸè§£æ JSON Patchï¼Œå…±', patches.length, 'ä¸ªæ“ä½œ');

            // éªŒè¯patchesæ ¼å¼
            if (!Array.isArray(patches)) {
              console.error('âŒ JSON Patch ä¸æ˜¯æ•°ç»„æ ¼å¼ï¼', typeof patches);
              throw new Error('JSON Patch å¿…é¡»æ˜¯æ•°ç»„æ ¼å¼');
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰æ–°è§’è‰²æ·»åŠ ï¼ˆæ”¯æŒä¸¤ç§è·¯å¾„æ ¼å¼ï¼šè§’è‰²ä»“åº“ æˆ– ä»“åº“ï¼‰
            const characterPatches = patches.filter(
              patch => (patch.path.includes('è§’è‰²ä»“åº“') || patch.path.includes('/ä»“åº“/')) && patch.op === 'add',
            );
            if (characterPatches.length > 0) {
              hasNewCharacter = true;
              console.info('âœ… æ£€æµ‹åˆ°', characterPatches.length, 'ä¸ªæ–°è§’è‰²å¾…æ·»åŠ ');
            }

            // å¦‚æœæœ‰æå–çš„HTMLå¡ç‰‡ï¼Œå°†å…¶ä¿å­˜åˆ°æ–°æ·»åŠ çš„è§’è‰²ä¸­
            if (extractedHtmlCard && extractedHtmlCard.length > 100) {
              characterPatches.forEach(patch => {
                const charId = patch.path.split('/').pop();
                if (patch.value && typeof patch.value === 'object') {
                  patch.value.è‡ªå®šä¹‰å‰ç«¯HTML = extractedHtmlCard;
                  console.info('âœ… å·²ä¿å­˜å‰ç«¯HTMLåˆ°è§’è‰²:', charId);
                }
              });
            }

            // è°ƒè¯•ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ–°è§’è‰²æ·»åŠ 
            characterPatches.forEach(patch => {
              console.info('ğŸ“ æ–°è§’è‰²æ·»åŠ :', patch.path);
              if (patch.value) {
                console.info('  - å§“å:', patch.value.å§“å || 'æœªçŸ¥');
                console.info('  - ç¨€æœ‰åº¦:', patch.value.ç¨€æœ‰åº¦ || 'æœªçŸ¥');
                if (patch.value.ç»˜å›¾æ ‡ç­¾) {
                  console.info('  - ç»˜å›¾æ ‡ç­¾:', patch.value.ç»˜å›¾æ ‡ç­¾.substring(0, 100));
                }
                if (patch.value.è‡ªå®šä¹‰å‰ç«¯HTML) {
                  console.info('  - å‰ç«¯HTMLå·²ä¿å­˜');
                }
              }
            });

            applyJSONPatches(patches);
            patchesApplied = true;

            // éªŒè¯è§’è‰²æ˜¯å¦çœŸçš„è¢«æ·»åŠ äº†
            if (hasNewCharacter) {
              setTimeout(() => {
                const addedChars = characterPatches.map(patch => {
                  const charId = patch.path.split('/').pop();
                  return { id: charId, char: gameState.è§’è‰²ä»“åº“?.[charId] };
                });
                const successfullyAdded = addedChars.filter(({ char }) => char).length;
                if (successfullyAdded < characterPatches.length) {
                  console.warn(`âš ï¸ è­¦å‘Šï¼šåªæœ‰ ${successfullyAdded}/${characterPatches.length} ä¸ªè§’è‰²æˆåŠŸæ·»åŠ åˆ°ä»“åº“`);
                  addedChars.forEach(({ id, char }) => {
                    if (!char) {
                      console.error(`âŒ è§’è‰² ${id} æœªèƒ½æ·»åŠ åˆ°ä»“åº“`);
                    }
                  });
                } else {
                  console.info(`âœ… æ‰€æœ‰ ${successfullyAdded} ä¸ªè§’è‰²å·²æˆåŠŸæ·»åŠ åˆ°ä»“åº“`);
                }
              }, 100);
            }
          } catch (error) {
            console.error('âŒ è§£æ JSON Patch å¤±è´¥:', error);
            console.error('JSON Patch å†…å®¹:', jsonPatchMatch[1].substring(0, 500));
            // å³ä½¿è§£æå¤±è´¥ï¼Œä¹Ÿå°è¯•ç»§ç»­å¤„ç†
          }
        } else {
          console.warn('âš ï¸ AIå“åº”ä¸­æ²¡æœ‰æ‰¾åˆ° <JSONPatch> æ ‡ç­¾');
          console.warn('å“åº”å†…å®¹é¢„è§ˆ:', response.substring(0, 500));

          // å›é€€æœºåˆ¶ï¼šå¦‚æœAIåªè¿”å›äº†HTMLä½†æ²¡æœ‰JSONPatchï¼Œå°è¯•ä»HTMLä¸­æå–è§’è‰²ä¿¡æ¯å¹¶æ‰‹åŠ¨åˆ›å»º
          if (extractedHtmlCard && extractedHtmlCard.length > 100) {
            console.warn('âš ï¸ æ£€æµ‹åˆ°å‰ç«¯HTMLä½†æ— JSONPatchï¼Œå°è¯•ä»HTMLä¸­æå–è§’è‰²ä¿¡æ¯å¹¶æ‰‹åŠ¨åˆ›å»º...');

            try {
              // å°è¯•ä»HTMLä¸­æå–è§’è‰²ä¿¡æ¯
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = extractedHtmlCard;

              // æŸ¥æ‰¾è§’è‰²ä¿¡æ¯ï¼ˆå°è¯•å¤šç§å¯èƒ½çš„æ ¼å¼ï¼‰
              const nameMatch =
                extractedHtmlCard.match(/å§“å[ï¼š:]\s*([^<\n]+)/i) ||
                extractedHtmlCard.match(/<[^>]*>([^<]*?å§“å[ï¼š:][^<]+)/i) ||
                extractedHtmlCard.match(/(?:å§“å|name)[ï¼š:\s]*([^<\n]{1,20})/i);
              const rarityMatch =
                extractedHtmlCard.match(/ç¨€æœ‰åº¦[ï¼š:]\s*([NSR\+\s]+)/i) ||
                extractedHtmlCard.match(/(N|R|SR|SSR|SSR\+|SSR\+\+|UR)/);

              if (nameMatch || rarityMatch) {
                const extractedName = nameMatch
                  ? nameMatch[1].trim().replace(/[<>]/g, '').substring(0, 50)
                  : 'æœªçŸ¥è§’è‰²';
                const extractedRarity = rarityMatch ? rarityMatch[1].trim() : 'SSR';

                // ç”Ÿæˆå”¯ä¸€ID
                const timestamp = Date.now();
                const random = Math.floor(Math.random() * 10000);
                const charId = `char_${timestamp}_${random}`;

                // åˆ›å»ºåŸºç¡€è§’è‰²æ•°æ®
                const newChar = {
                  å…ƒç´ : [],
                  å§“å: extractedName,
                  ç¨€æœ‰åº¦: extractedRarity,
                  æ€§åˆ«: 'æœªçŸ¥',
                  ç§æ—å‡ºèº«: 'æœªçŸ¥',
                  èŒä¸šèº«ä»½: 'æœªçŸ¥',
                  å¤–è²Œç‰¹ç‚¹: 'è¯¦è§å‰ç«¯HTML',
                  æ€§æ ¼å–œå¥½: 'æœªçŸ¥',
                  ç®€ä»‹: 'ä»HTMLæå–çš„è§’è‰²',
                  èƒŒæ™¯æ•…äº‹: 'è¯¦è§å‰ç«¯HTML',
                  ç»˜å›¾æ ‡ç­¾: '',
                  è‡ªå®šä¹‰å‰ç«¯HTML: extractedHtmlCard,
                  å¤–è²Œæç¤ºè¯: '',
                  å¥½æ„Ÿåº¦: 0,
                  æ¨æ„: 0,
                  å±æ€§: calculateInitialAttributes({ èŒä¸šèº«ä»½: 'æœªçŸ¥', ç§æ—å‡ºèº«: 'æœªçŸ¥' }),
                  æƒ…æ„ŸçŠ¶æ€: {
                    å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ: 'ä¸­ç«‹',
                    æƒ…æ„Ÿå¼ºåº¦: 0,
                    ç‰¹æ®ŠçŠ¶æ€: [],
                  },
                  çŠ¶æ€: 'ç©ºé—²',
                  å½“å‰ä½ç½®: 'ä»“åº“',
                  ç»éªŒå€¼: 0,
                  ç­‰çº§: 1,
                  æ¥å®¢æ¬¡æ•°: 0,
                  è°ƒæ•™æ¬¡æ•°: 0,
                  æ”¶å…¥è´¡çŒ®: 0,
                  æœ€åäº’åŠ¨: getGameTime().å½“å‰å›åˆ || 1,
                  ä½“åŠ›å€¼: 100,
                };

                // æ·»åŠ åˆ°è§’è‰²ä»“åº“
                if (!gameState.è§’è‰²ä»“åº“) gameState.è§’è‰²ä»“åº“ = {};
                gameState.è§’è‰²ä»“åº“[charId] = newChar;

                console.info(`âœ… ä»HTMLæ‰‹åŠ¨åˆ›å»ºè§’è‰²: ${charId}ï¼ˆ${extractedName}ï¼Œç¨€æœ‰åº¦ï¼š${extractedRarity}ï¼‰`);

                // ç«‹å³ä¿å­˜åˆ°MVU
                saveImmediately();

                // åˆ·æ–°é¡µé¢
                setTimeout(() => {
                  smartRefreshPages(true);
                }, 100);

                if (typeof toastr !== 'undefined') {
                  toastr.warning(`AIæœªè¿”å›JSONPatchï¼Œå·²ä»HTMLæ‰‹åŠ¨åˆ›å»ºè§’è‰²ï¼š${extractedName}`);
                }
              } else {
                console.warn('âš ï¸ æ— æ³•ä»HTMLä¸­æå–è§’è‰²ä¿¡æ¯ï¼Œéœ€è¦AIè¿”å›JSONPatch');
              }
            } catch (error) {
              console.error('âŒ ä»HTMLæå–è§’è‰²ä¿¡æ¯å¤±è´¥:', error);
            }
          }
        }

        // å¦‚æœæ²¡æœ‰ä»»ä½•patchè¢«åº”ç”¨ï¼Œä¸”æ²¡æœ‰æ–°è§’è‰²ï¼Œè®°å½•ä¸¥é‡è­¦å‘Š
        if (!patchesApplied && !hasNewCharacter) {
          console.error('âŒ ä¸¥é‡é”™è¯¯ï¼šæŠ½å¡å“åº”ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„è§’è‰²æ·»åŠ æ“ä½œï¼');
          console.error('å“åº”å†…å®¹:', response.substring(0, 1000));
          if (typeof toastr !== 'undefined') {
            toastr.error('æŠ½å¡å¤±è´¥ï¼šAIæœªè¿”å›æœ‰æ•ˆçš„è§’è‰²æ•°æ®ï¼Œè¯·é‡è¯•');
          } else {
            alert('æŠ½å¡å¤±è´¥ï¼šAIæœªè¿”å›æœ‰æ•ˆçš„è§’è‰²æ•°æ®ï¼Œè¯·é‡è¯•');
          }
        }

        // AIç”Ÿæˆå†…å®¹å®Œæˆåï¼Œç«‹å³åˆ·æ–°æ‰€æœ‰é¡µé¢ï¼ˆç¡®ä¿æ•°æ®åŒæ­¥ï¼‰
        // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿DOMæ›´æ–°å®Œæˆåå†åˆ·æ–°
        requestAnimationFrame(() => {
          smartRefreshPages(true);
        });
        // AIç”Ÿæˆå†…å®¹å®Œæˆåï¼Œè‡ªåŠ¨æ¨è¿›ä¸€å›åˆ
        advanceRound();
        // AIè¾“å‡ºåç«‹å³ä¿å­˜ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±
        saveImmediately();
      }

      function applyJSONPatches(patches) {
        console.info('ğŸ”§ å¼€å§‹åº”ç”¨ JSON Patchesï¼Œå…±', patches.length, 'ä¸ª');
        patches.forEach((patch, index) => {
          try {
            // æ›´å®½æ¾çš„è·¯å¾„è§£æï¼šæ”¯æŒå¤šç§æ ¼å¼
            let pathStr = patch.path || '';
            // ç§»é™¤å‰å¯¼æ–œæ 
            if (pathStr.startsWith('/')) {
              pathStr = pathStr.substring(1);
            }
            // ç§»é™¤å°¾éšæ–œæ 
            if (pathStr.endsWith('/')) {
              pathStr = pathStr.substring(0, pathStr.length - 1);
            }
            const path = pathStr.split('/').filter(p => p.length > 0);

            console.info(
              `ğŸ“ Patch ${index + 1}/${patches.length}: op=${patch.op}, path=${patch.path}, pathArray=[${path.join(', ')}]`,
            );

            // ä¿æŠ¤ï¼šé˜²æ­¢AIé”™è¯¯åœ°å°†æ­£åœ¨ä½¿ç”¨ä¸­çš„æˆ¿é—´çŠ¶æ€æ”¹ä¸º"ç©ºé—²"
            if (
              path.length >= 3 &&
              path[0] === 'å¦“é™¢' &&
              path[1] === 'æˆ¿é—´çŠ¶æ€' &&
              path[2] &&
              path[3] === 'çŠ¶æ€' &&
              patch.op === 'replace' &&
              patch.value === 'ç©ºé—²'
            ) {
              const roomId = path[2];
              const room = gameState.å¦“é™¢?.æˆ¿é—´çŠ¶æ€?.[roomId];
              if (room && room.å½“å‰è§’è‰²) {
                console.warn(`é˜»æ­¢AIé”™è¯¯åœ°å°†æˆ¿é—´ ${roomId} çŠ¶æ€æ”¹ä¸º"ç©ºé—²"ï¼ˆæˆ¿é—´æœ‰è§’è‰² ${room.å½“å‰è§’è‰²}ï¼‰`);
                return; // è·³è¿‡è¿™ä¸ªpatch
              }
            }

            // ä¿æŠ¤ï¼šé˜²æ­¢AIé”™è¯¯åœ°ä¿®æ”¹è§’è‰²çŠ¶æ€ï¼ˆä»æ¥å®¢ä¸­/è°ƒæ•™ä¸­æ”¹ä¸ºå…¶ä»–çŠ¶æ€ï¼‰
            if (path.length >= 3 && path[0] === 'è§’è‰²ä»“åº“' && path[2] === 'çŠ¶æ€' && patch.op === 'replace') {
              const charId = path[1];
              const char = gameState.è§’è‰²ä»“åº“?.[charId];
              const newStatus = patch.value;
              // å¦‚æœè§’è‰²æ­£åœ¨æ¥å®¢æˆ–è°ƒæ•™ä¸­ï¼Œä¸”AIè¯•å›¾æ”¹ä¸ºå…¶ä»–çŠ¶æ€ï¼Œé˜»æ­¢
              if (char && (char.çŠ¶æ€ === 'æ¥å®¢ä¸­' || char.çŠ¶æ€ === 'è°ƒæ•™ä¸­')) {
                if (newStatus !== 'æ¥å®¢ä¸­' && newStatus !== 'è°ƒæ•™ä¸­' && newStatus !== 'ç©ºé—²') {
                  console.warn(`é˜»æ­¢AIé”™è¯¯åœ°å°†è§’è‰² ${charId}ï¼ˆ${char.å§“å}ï¼‰çŠ¶æ€ä»"${char.çŠ¶æ€}"æ”¹ä¸º"${newStatus}"`);
                  return; // è·³è¿‡è¿™ä¸ªpatch
                }
              }
            }

            // ä¿æŠ¤ï¼šé˜²æ­¢AIé”™è¯¯åœ°æ¸…ç©ºæˆ¿é—´çš„å½“å‰è§’è‰²
            if (
              path.length >= 3 &&
              path[0] === 'å¦“é™¢' &&
              path[1] === 'æˆ¿é—´çŠ¶æ€' &&
              path[2] &&
              path[3] === 'å½“å‰è§’è‰²' &&
              (patch.op === 'remove' || (patch.op === 'replace' && (patch.value === null || patch.value === undefined)))
            ) {
              const roomId = path[2];
              const room = gameState.å¦“é™¢?.æˆ¿é—´çŠ¶æ€?.[roomId];
              if (room && room.å½“å‰è§’è‰² && room.çŠ¶æ€ === 'ä½¿ç”¨ä¸­') {
                console.warn(`é˜»æ­¢AIé”™è¯¯åœ°æ¸…ç©ºæˆ¿é—´ ${roomId} çš„å½“å‰è§’è‰²ï¼ˆæˆ¿é—´æ­£åœ¨ä½¿ç”¨ä¸­ï¼‰`);
                return; // è·³è¿‡è¿™ä¸ªpatch
              }
            }

            // ä¿æŠ¤ï¼šé˜²æ­¢AIé”™è¯¯åœ°ä¿®æ”¹è§’è‰²çš„å½“å‰ä½ç½®ï¼ˆä»å¦“é™¢æ”¹ä¸ºå…¶ä»–ä½ç½®ï¼‰
            if (path.length >= 3 && path[0] === 'è§’è‰²ä»“åº“' && path[2] === 'å½“å‰ä½ç½®' && patch.op === 'replace') {
              const charId = path[1];
              const char = gameState.è§’è‰²ä»“åº“?.[charId];
              const newLocation = patch.value;
              // å¦‚æœè§’è‰²æ­£åœ¨æ¥å®¢æˆ–è°ƒæ•™ä¸­ï¼Œä¸”AIè¯•å›¾æ”¹ä¸ºå…¶ä»–ä½ç½®ï¼Œé˜»æ­¢
              if (char && (char.çŠ¶æ€ === 'æ¥å®¢ä¸­' || char.çŠ¶æ€ === 'è°ƒæ•™ä¸­')) {
                if (newLocation !== 'å¦“é™¢' && newLocation !== 'è°ƒæ•™å®¤') {
                  console.warn(
                    `é˜»æ­¢AIé”™è¯¯åœ°å°†è§’è‰² ${charId}ï¼ˆ${char.å§“å}ï¼‰ä½ç½®ä»"${char.å½“å‰ä½ç½®}"æ”¹ä¸º"${newLocation}"ï¼ˆè§’è‰²æ­£åœ¨${char.çŠ¶æ€}ï¼‰`,
                  );
                  return; // è·³è¿‡è¿™ä¸ªpatch
                }
              }
            }

            // ==================== å…³é”®ä¿æŠ¤ï¼šé˜²æ­¢AIä¿®æ”¹æ¥å®¢/è°ƒæ•™çš„å…³é”®æ—¶é—´å­—æ®µ ====================
            // ä¿æŠ¤ï¼šé˜²æ­¢AIé”™è¯¯åœ°ä¿®æ”¹æ¥å®¢ä¿¡æ¯çš„å¼€å§‹å›åˆæˆ–é¢„è®¡ç»“æŸå›åˆ
            if (
              path.length >= 3 &&
              path[0] === 'å¦“é™¢' &&
              path[1] === 'å½“å‰æ¥å®¢è§’è‰²' &&
              path[2] &&
              (path[3] === 'å¼€å§‹å›åˆ' || path[3] === 'é¢„è®¡ç»“æŸå›åˆ')
            ) {
              const charId = path[2];
              console.warn(
                `é˜»æ­¢AIé”™è¯¯åœ°ä¿®æ”¹è§’è‰² ${charId} çš„æ¥å®¢æ—¶é—´å­—æ®µï¼ˆ${path[3]}ï¼‰ï¼Œè¿™äº›å­—æ®µç”±ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ï¼Œä¸å…è®¸AIä¿®æ”¹`,
              );
              return; // è·³è¿‡è¿™ä¸ªpatch
            }

            // ä¿æŠ¤ï¼šé˜²æ­¢AIé”™è¯¯åœ°ä¿®æ”¹è°ƒæ•™ä¿¡æ¯çš„å¼€å§‹å›åˆæˆ–é¢„è®¡ç»“æŸå›åˆ
            if (
              path.length >= 3 &&
              path[0] === 'å¦“é™¢' &&
              path[1] === 'å½“å‰è°ƒæ•™è§’è‰²' &&
              path[2] &&
              (path[3] === 'å¼€å§‹å›åˆ' || path[3] === 'é¢„è®¡ç»“æŸå›åˆ')
            ) {
              const charId = path[2];
              console.warn(
                `é˜»æ­¢AIé”™è¯¯åœ°ä¿®æ”¹è§’è‰² ${charId} çš„è°ƒæ•™æ—¶é—´å­—æ®µï¼ˆ${path[3]}ï¼‰ï¼Œè¿™äº›å­—æ®µç”±ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ï¼Œä¸å…è®¸AIä¿®æ”¹`,
              );
              return; // è·³è¿‡è¿™ä¸ªpatch
            }

            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ­£åœ¨å¤„ç†æŠ½å¡è´¹ç”¨ï¼Œä¸” AI è¿”å›çš„è´§å¸æ›´æ–°ï¼Œéœ€è¦åˆå¹¶å¤„ç†
            if (pendingSummonCost > 0 && path.length === 1 && path[0] === 'è´§å¸' && patch.op === 'replace') {
              // AI è¿”å›çš„è´§å¸å€¼åº”è¯¥å·²ç»æ‰£é™¤äº†è´¹ç”¨ï¼Œç›´æ¥ä½¿ç”¨
              setNestedValue(gameState, path, patch.value);
              pendingSummonCost = 0; // æ¸…é™¤å¾…å¤„ç†è´¹ç”¨
            } else if (pendingSummonCost > 0 && path.length === 1 && path[0] === 'è´§å¸' && patch.op === 'add') {
              // å¦‚æœæ˜¯ add æ“ä½œï¼Œéœ€è¦å…ˆæ‰£é™¤è´¹ç”¨
              const currentMoney = getNestedValue(gameState, path) || gameState.è´§å¸;
              setNestedValue(gameState, path, currentMoney - pendingSummonCost + (patch.value || 0));
              pendingSummonCost = 0;
            } else {
              // æ­£å¸¸å¤„ç†å…¶ä»– patch
              if (patch.op === 'replace') {
                setNestedValue(gameState, path, patch.value);
              } else if (patch.op === 'add') {
                // ç‰¹æ®Šå¤„ç†ï¼šç¡®ä¿è§’è‰²ä»“åº“åˆå§‹åŒ–å¹¶æ­£ç¡®æ·»åŠ è§’è‰²
                // æ”¯æŒä¸¤ç§è·¯å¾„æ ¼å¼ï¼š/è§’è‰²ä»“åº“/xxx æˆ– /ä»“åº“/xxx
                const isCharacterPath = path.length >= 2 && (path[0] === 'è§’è‰²ä»“åº“' || path[0] === 'ä»“åº“');
                if (isCharacterPath) {
                  if (!gameState.è§’è‰²ä»“åº“) {
                    gameState.è§’è‰²ä»“åº“ = {};
                    console.info('âœ… åˆå§‹åŒ–è§’è‰²ä»“åº“');
                  }

                  // å¤„ç†è§’è‰²IDï¼šå¦‚æœAIä½¿ç”¨ `-`ï¼ˆJSON Patchæ•°ç»„è¿½åŠ è¯­æ³•ï¼‰ï¼Œè‡ªåŠ¨ç”Ÿæˆå”¯ä¸€ID
                  let charId = path[1];
                  if (!charId || charId === '-' || charId === '') {
                    // è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€IDï¼šchar_æ—¶é—´æˆ³_éšæœºæ•°
                    const timestamp = Date.now();
                    const random = Math.floor(Math.random() * 10000);
                    charId = `char_${timestamp}_${random}`;
                    console.warn(`âš ï¸ AIä½¿ç”¨äº†æ•°ç»„è¿½åŠ è¯­æ³•ï¼ˆ-ï¼‰æˆ–ç©ºIDï¼Œè‡ªåŠ¨ç”Ÿæˆè§’è‰²ID: ${charId}`);
                  }

                  console.info(
                    `ğŸ¯ å¤„ç†è§’è‰²æ·»åŠ : charId=${charId}, valueç±»å‹=${typeof patch.value}, æ˜¯å¦ä¸ºå¯¹è±¡=${patch.value && typeof patch.value === 'object'}`,
                  );

                  if (!charId || charId === '-') {
                    console.error(`âŒ è§’è‰²IDæ— æ•ˆï¼path=${patch.path}, charId=${charId}`);
                    // å³ä½¿IDæ— æ•ˆï¼Œä¹Ÿå°è¯•ç”Ÿæˆä¸€ä¸ª
                    const timestamp = Date.now();
                    const random = Math.floor(Math.random() * 10000);
                    charId = `char_${timestamp}_${random}`;
                    console.warn(`âš ï¸ å¼ºåˆ¶ç”Ÿæˆè§’è‰²ID: ${charId}`);
                  }

                  if (!patch.value) {
                    console.error(`âŒ è§’è‰² ${charId} çš„valueä¸ºç©ºï¼`);
                    return;
                  }

                  if (typeof patch.value !== 'object') {
                    console.error(`âŒ è§’è‰² ${charId} çš„valueä¸æ˜¯å¯¹è±¡ï¼ç±»å‹=${typeof patch.value}, å€¼=`, patch.value);
                    return;
                  }

                  if (charId && patch.value && typeof patch.value === 'object') {
                    // ç¡®ä¿è§’è‰²æ•°æ®å®Œæ•´
                    if (!patch.value.å§“å) {
                      console.warn(`âš ï¸ è§’è‰² ${charId} ç¼ºå°‘å§“åå­—æ®µ`);
                    }
                    if (!patch.value.ç¨€æœ‰åº¦) {
                      console.warn(`âš ï¸ è§’è‰² ${charId} ç¼ºå°‘ç¨€æœ‰åº¦å­—æ®µ`);
                    } else {
                      // éªŒè¯ç¨€æœ‰åº¦æ˜¯å¦æœ‰æ•ˆ
                      const validRarities = ['N', 'R', 'SR', 'SSR', 'SSR+', 'SSR++', 'UR'];
                      if (!validRarities.includes(patch.value.ç¨€æœ‰åº¦)) {
                        console.warn(`âš ï¸ è§’è‰² ${charId} ç¨€æœ‰åº¦ "${patch.value.ç¨€æœ‰åº¦}" æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼ SSR`);
                        patch.value.ç¨€æœ‰åº¦ = 'SSR';
                      }
                    }
                    if (!patch.value.å±æ€§) {
                      console.warn(`âš ï¸ è§’è‰² ${charId} ç¼ºå°‘å±æ€§å­—æ®µï¼Œæ ¹æ®è§’è‰²ä¿¡æ¯è®¡ç®—`);
                      patch.value.å±æ€§ = calculateInitialAttributes(patch.value);
                    } else {
                      // éªŒè¯å±æ€§æ˜¯å¦åˆç†ï¼ˆå¦‚æœéƒ½æ˜¯30è¿™æ ·çš„é»˜è®¤å€¼ï¼Œé‡æ–°è®¡ç®—ï¼‰
                      const attrs = patch.value.å±æ€§;
                      const isDefault = ['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦'].every(
                        k => attrs[k] === 30 || !Number.isFinite(attrs[k]),
                      );
                      if (isDefault) {
                        console.info(`âš ï¸ è§’è‰² ${charId} å±æ€§ä¸ºé»˜è®¤å€¼ï¼Œæ ¹æ®è§’è‰²ä¿¡æ¯é‡æ–°è®¡ç®—`);
                        patch.value.å±æ€§ = calculateInitialAttributes(patch.value);
                      }
                    }
                    // è®¾ç½®é»˜è®¤å€¼
                    if (!patch.value.çŠ¶æ€) patch.value.çŠ¶æ€ = 'ç©ºé—²';
                    if (!patch.value.å½“å‰ä½ç½®) patch.value.å½“å‰ä½ç½® = 'ä»“åº“';
                    if (typeof patch.value.ç»éªŒå€¼ !== 'number') patch.value.ç»éªŒå€¼ = 0;
                    if (typeof patch.value.ç­‰çº§ !== 'number') patch.value.ç­‰çº§ = 1;
                    if (typeof patch.value.æ¥å®¢æ¬¡æ•° !== 'number') patch.value.æ¥å®¢æ¬¡æ•° = 0;
                    if (typeof patch.value.è°ƒæ•™æ¬¡æ•° !== 'number') patch.value.è°ƒæ•™æ¬¡æ•° = 0;
                    if (typeof patch.value.æ”¶å…¥è´¡çŒ® !== 'number') patch.value.æ”¶å…¥è´¡çŒ® = 0;
                    if (typeof patch.value.ä½“åŠ›å€¼ !== 'number') patch.value.ä½“åŠ›å€¼ = 100;
                    if (!patch.value.æƒ…æ„ŸçŠ¶æ€) {
                      patch.value.æƒ…æ„ŸçŠ¶æ€ = {
                        å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ: 'ä¸­ç«‹',
                        æƒ…æ„Ÿå¼ºåº¦: 0,
                        ç‰¹æ®ŠçŠ¶æ€: [],
                      };
                    }

                    // æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿è§’è‰²æ•°æ®å®Œæ•´
                    if (!patch.value.å§“å) {
                      console.error(`âŒ è§’è‰² ${charId} ç¼ºå°‘å§“åå­—æ®µï¼Œæ‹’ç»æ·»åŠ ï¼`);
                      console.error('è§’è‰²æ•°æ®:', JSON.stringify(patch.value, null, 2));
                      return;
                    }

                    // æ·»åŠ åˆ°è§’è‰²ä»“åº“
                    gameState.è§’è‰²ä»“åº“[charId] = patch.value;
                    console.info(
                      `âœ… è§’è‰²å·²æˆåŠŸæ·»åŠ åˆ°è§’è‰²ä»“åº“: ${charId}ï¼ˆ${patch.value.å§“å || 'æœªçŸ¥'}ï¼Œç¨€æœ‰åº¦ï¼š${patch.value.ç¨€æœ‰åº¦ || 'æœªçŸ¥'}ï¼‰`,
                    );

                    // ç«‹å³éªŒè¯æ˜¯å¦çœŸçš„æ·»åŠ æˆåŠŸ
                    if (!gameState.è§’è‰²ä»“åº“[charId]) {
                      console.error(`âŒ ä¸¥é‡é”™è¯¯ï¼šè§’è‰² ${charId} æ·»åŠ åç«‹å³éªŒè¯å¤±è´¥ï¼`);
                    } else {
                      console.info(
                        `âœ… éªŒè¯æˆåŠŸï¼šè§’è‰² ${charId} å·²å­˜åœ¨äºè§’è‰²ä»“åº“ä¸­ï¼Œå½“å‰ä»“åº“è§’è‰²æ•°: ${Object.keys(gameState.è§’è‰²ä»“åº“).length}`,
                      );
                      // ç«‹å³ä¿å­˜åˆ°MVUï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±
                      saveImmediately();
                    }
                  } else {
                    console.warn(`âš ï¸ è§’è‰² ${charId} æ•°æ®æ ¼å¼é”™è¯¯:`, patch.value);
                    console.warn(
                      `âš ï¸ charIdå­˜åœ¨=${!!charId}, valueå­˜åœ¨=${!!patch.value}, æ˜¯å¦ä¸ºå¯¹è±¡=${patch.value && typeof patch.value === 'object'}`,
                    );
                    // å³ä½¿æ ¼å¼æœ‰é—®é¢˜ï¼Œä¹Ÿå°è¯•æ·»åŠ ï¼ˆå®¹é”™å¤„ç†ï¼‰
                    if (charId && patch.value) {
                      try {
                        setNestedValue(gameState, path, patch.value);
                        console.info(`âš ï¸ ä½¿ç”¨é€šç”¨æ–¹æ³•æ·»åŠ è§’è‰² ${charId}`);
                      } catch (err) {
                        console.error(`âŒ æ·»åŠ è§’è‰² ${charId} å¤±è´¥:`, err);
                      }
                    }
                  }
                } else {
                  setNestedValue(gameState, path, patch.value);
                }
              } else if (patch.op === 'remove') {
                const parent = getNestedValue(gameState, path.slice(0, -1));
                if (parent) {
                  delete parent[path[path.length - 1]];
                }
              }
            }
          } catch (error) {
            console.error(`âŒ åº”ç”¨ JSON Patch å¤±è´¥ (Patch ${index + 1}/${patches.length}):`, error);
            console.error('å¤±è´¥çš„Patch:', JSON.stringify(patch, null, 2));
            console.error('é”™è¯¯å †æ ˆ:', error.stack);
          }
        });

        // æœ€ç»ˆéªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è§’è‰²è¢«æˆåŠŸæ·»åŠ 
        console.info('ğŸ” æœ€ç»ˆéªŒè¯ï¼šè§’è‰²ä»“åº“ä¸­ç°æœ‰è§’è‰²æ•°é‡:', Object.keys(gameState.è§’è‰²ä»“åº“ || {}).length);
        const characterPatches = patches.filter(p => {
          const pathStr = (p.path || '').replace(/^\//, '');
          return (pathStr.startsWith('è§’è‰²ä»“åº“/') || pathStr.startsWith('ä»“åº“/')) && p.op === 'add';
        });
        if (characterPatches.length > 0) {
          console.info(`ğŸ” æ£€æµ‹åˆ° ${characterPatches.length} ä¸ªè§’è‰²æ·»åŠ æ“ä½œ`);
          characterPatches.forEach(p => {
            const pathStr = (p.path || '').replace(/^\//, '');
            const charId = pathStr.split('/')[1];
            if (charId && gameState.è§’è‰²ä»“åº“?.[charId]) {
              console.info(`âœ… è§’è‰² ${charId}ï¼ˆ${gameState.è§’è‰²ä»“åº“[charId].å§“å || 'æœªçŸ¥'}ï¼‰å·²æˆåŠŸæ·»åŠ åˆ°ä»“åº“`);
            } else {
              console.error(`âŒ è§’è‰² ${charId} æœªèƒ½æ·»åŠ åˆ°ä»“åº“ï¼`);
            }
          });
        }

        // å¦‚æœè¿˜æœ‰å¾…å¤„ç†çš„è´¹ç”¨ï¼ˆAI æ²¡æœ‰è¿”å›è´§å¸æ›´æ–°ï¼‰ï¼Œæ‰‹åŠ¨æ‰£é™¤
        if (pendingSummonCost > 0) {
          gameState.è´§å¸ -= pendingSummonCost;
          pendingSummonCost = 0;
        }

        // ä¿æŠ¤ï¼šç¡®ä¿æ‰€æœ‰æœ‰è§’è‰²çš„æˆ¿é—´çŠ¶æ€éƒ½æ˜¯"ä½¿ç”¨ä¸­"
        if (gameState.å¦“é™¢?.æˆ¿é—´çŠ¶æ€) {
          Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).forEach(([roomId, room]) => {
            if (room.å½“å‰è§’è‰² && room.çŠ¶æ€ !== 'ä½¿ç”¨ä¸­') {
              console.warn(`ä¿®å¤æˆ¿é—´ ${roomId} çŠ¶æ€ï¼šä»"${room.çŠ¶æ€}"æ”¹ä¸º"ä½¿ç”¨ä¸­"`);
              room.çŠ¶æ€ = 'ä½¿ç”¨ä¸­';
            }
          });
        }

        // ç¡®ä¿æ–°æ·»åŠ çš„è§’è‰²æå–å¤–è²Œæç¤ºè¯ï¼ˆä»ç»˜å›¾æ ‡ç­¾ä¸­æå–çº¯å¤–è²Œéƒ¨åˆ†ï¼‰
        if (gameState.è§’è‰²ä»“åº“) {
          patches.forEach(patch => {
            if (patch.path.includes('è§’è‰²ä»“åº“') && (patch.op === 'add' || patch.op === 'replace')) {
              const pathParts = patch.path.replace(/^\//, '').split('/');
              if (pathParts.length >= 2 && pathParts[0] === 'è§’è‰²ä»“åº“') {
                const charId = pathParts[1];
                const char = gameState.è§’è‰²ä»“åº“[charId];
                if (char && typeof char === 'object') {
                  // å¦‚æœè§’è‰²æœ‰ç»˜å›¾æ ‡ç­¾ä½†æ²¡æœ‰å¤–è²Œæç¤ºè¯ï¼Œæˆ–è€…å¤–è²Œæç¤ºè¯å¤ªçŸ­ï¼Œé‡æ–°æå–
                  if (char.ç»˜å›¾æ ‡ç­¾ && (!char.å¤–è²Œæç¤ºè¯ || char.å¤–è²Œæç¤ºè¯.length < 20)) {
                    ensureCharacterPrompts(char);
                    console.info(`å·²ä¸ºè§’è‰² ${charId} æå–å¤–è²Œæç¤ºè¯:`, char.å¤–è²Œæç¤ºè¯?.substring(0, 50));
                  }
                }
              }
            }
          });
        }

        // å»¶è¿Ÿåˆ·æ–°ï¼Œé¿å…è¦†ç›–æ­£åœ¨æ¸²æŸ“çš„å›¾ç‰‡
        setTimeout(() => {
          refreshAllPages();
        }, 100);
      }

      function getNestedValue(obj, path) {
        return path.reduce((current, key) => {
          if (Array.isArray(current) && /^\d+$/.test(key)) {
            return current[parseInt(key)];
          }
          return current && current[key];
        }, obj);
      }

      function setNestedValue(obj, path, value) {
        const lastKey = path[path.length - 1];
        const parent = path.slice(0, -1).reduce((current, key) => {
          if (!current[key]) {
            current[key] = {};
          }
          return current[key];
        }, obj);
        parent[lastKey] = value;
      }

      // ==================== MVU å˜é‡é›†æˆ ====================
      async function loadGameStateFromMVU() {
        try {
          if (typeof waitGlobalInitialized !== 'undefined') {
            await waitGlobalInitialized('Mvu');
          }

          if (typeof Mvu !== 'undefined' && typeof getCurrentMessageId !== 'undefined') {
            const messageId = getCurrentMessageId();
            const mvuData = Mvu.getMvuData({ type: 'message', message_id: messageId });
            const statData = typeof _ !== 'undefined' && _.get ? _.get(mvuData, 'stat_data') : mvuData?.stat_data;

            if (statData) {
              Object.assign(gameState, statData);
              refreshAllPages();
            }
          } else if (typeof getVariables !== 'undefined') {
            const variables = getVariables({ type: 'message', message_id: 'latest' });
            const statData = variables?.stat_data;

            if (statData) {
              Object.assign(gameState, statData);
              refreshAllPages();
            }
          }
        } catch (error) {
          console.error('åŠ è½½ MVU å˜é‡å¤±è´¥:', error);
          refreshAllPages();
        }
      }

      async function saveGameStateToMVU() {
        try {
          if (typeof updateVariablesWith !== 'undefined' && typeof getCurrentMessageId !== 'undefined') {
            const messageId = getCurrentMessageId();
            updateVariablesWith(
              variables => {
                if (typeof _ !== 'undefined' && _.set) {
                  _.set(variables, 'stat_data', gameState);
                } else {
                  variables.stat_data = gameState;
                }
                return variables;
              },
              { type: 'message', message_id: messageId },
            );
          }
        } catch (error) {
          console.error('ä¿å­˜ MVU å˜é‡å¤±è´¥:', error);
        }
      }

      // ==================== äº‹ä»¶ç›‘å¬ ====================
      function setupEventListeners() {
        if (typeof eventOn !== 'undefined' && typeof Mvu !== 'undefined') {
          eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, newVariables => {
            const statData =
              typeof _ !== 'undefined' && _.get ? _.get(newVariables, 'stat_data') : newVariables?.stat_data;
            if (statData) {
              Object.assign(gameState, statData);
              refreshAllPages();
            }
          });
        }

        const searchInput = document.getElementById('search-input');
        const filterRarity = document.getElementById('filter-rarity');

        if (searchInput) {
          searchInput.addEventListener('input', () => refreshUnitsPage());
        }
        if (filterRarity) {
          filterRarity.addEventListener('change', () => refreshUnitsPage());
        }
      }

      // ==================== è§’è‰²è¯¦æƒ… ====================
      function showCharacterDetail(id) {
        const char = gameState.è§’è‰²ä»“åº“[id];
        if (!char) return;
        normalizeCharacter(char);

        const modal = document.getElementById('character-detail-modal');
        const content = document.getElementById('character-detail-content');

        if (!modal || !content) return;

        // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰çš„å‰ç«¯è§’è‰²å¡HTMLï¼ˆå­˜å‚¨åœ¨å˜é‡ä¸­ï¼‰
        // å°è¯•ä»å¤šä¸ªå¯èƒ½çš„å­—æ®µè·å–
        const customCardHtml = char.è‡ªå®šä¹‰å‰ç«¯HTML || char.å‰ç«¯HTML || char.HTMLå¡ç‰‡ || '';

        if (customCardHtml && (customCardHtml.includes('<style>') || customCardHtml.includes('<div'))) {
          // å¦‚æœæœ‰è‡ªå®šä¹‰å‰ç«¯ï¼Œä½¿ç”¨éš”ç¦»å®¹å™¨é˜²æ­¢è§’è‰²å¡æ ·å¼æ±¡æŸ“æ•´ä¸ªé¡µé¢
          // ç”Ÿæˆå”¯ä¸€IDç¡®ä¿æ ·å¼å®Œå…¨éš”ç¦»
          const sandboxId = `char-sandbox-${id}-${Date.now()}`;
          content.innerHTML = `
            <div id="${sandboxId}" class="character-card-sandbox" style="
              all: initial;
              display: block;
              font-family: inherit;
              color: inherit;
              position: relative;
              border-radius: 16px;
              isolation: isolate;
              contain: layout style paint;
              transform: none !important;
              rotate: none !important;
              transform-origin: initial !important;
            ">
              <style>
                /* å¼ºåˆ¶éš”ç¦»ï¼šè§’è‰²å¡æ²™ç®±å†…çš„æ‰€æœ‰æ ·å¼éƒ½ä¸ä¼šå½±å“å¤–éƒ¨ */
                #${sandboxId} {
                  all: initial;
                  display: block;
                  isolation: isolate;
                  contain: layout style paint;
                  position: relative !important;
                  z-index: auto !important;
                  transform: none !important;
                  rotate: none !important;
                  overflow: visible;
                }

                /* è§’è‰²å¡å†…çš„æ‰€æœ‰å…ƒç´ æ ·å¼éƒ½é™åˆ¶åœ¨æ²™ç®±å†… */
                #${sandboxId} * {
                  box-sizing: border-box;
                }

                #${sandboxId} img {
                  max-width: 100%;
                  height: auto;
                }

                /* é‡ç½®è§’è‰²å¡å†…çš„body/htmlæ ·å¼ï¼Œé˜²æ­¢æ±¡æŸ“ */
                #${sandboxId} body,
                #${sandboxId} html {
                  all: unset;
                  display: block;
                }

                /* å…³é”®ï¼šç¡®ä¿è§’è‰²å¡å†…çš„æ ·å¼é€‰æ‹©å™¨ä¸ä¼šåŒ¹é…åˆ°å¤–éƒ¨å…ƒç´  */
                /* è§’è‰²å¡å†…çš„ .stat-bar, .stat-fill ç­‰ç±»åä¸ä¼šå½±å“å¤–éƒ¨ */
                /* å› ä¸ºå¤–éƒ¨å…ƒç´ ä¸åœ¨ #${sandboxId} å†… */

                /* å¼ºåˆ¶é™åˆ¶ï¼šè§’è‰²å¡å†…çš„æ‰€æœ‰ç±»é€‰æ‹©å™¨éƒ½å¿…é¡»ä»¥æ²™ç®±IDä¸ºå‰ç¼€ */
                /* è¿™ç¡®ä¿è§’è‰²å¡å†…çš„æ ·å¼ï¼ˆå¦‚ .story-content, .stat-bar ç­‰ï¼‰ä¸ä¼šå½±å“å¤–éƒ¨ */
              </style>

              <style id="char-card-style-rewriter-${sandboxId}">
                /* è¿™ä¸ªæ ·å¼å—ä¼šåœ¨è§’è‰²å¡HTMLæ’å…¥åï¼Œé‡å†™å…¶ä¸­çš„æ ·å¼é€‰æ‹©å™¨ */
                /* ç¡®ä¿æ‰€æœ‰æ ·å¼éƒ½é™åˆ¶åœ¨ #${sandboxId} å†… */
              </style>
              <div style="background: var(--bg-card); border-radius: 16px; position: relative; z-index: 0; transform: none !important;">
                ${customCardHtml}
              </div>
            </div>
          `;

          // é‡å†™è§’è‰²å¡HTMLä¸­çš„æ ·å¼ï¼Œç¡®ä¿æ‰€æœ‰é€‰æ‹©å™¨éƒ½é™åˆ¶åœ¨æ²™ç®±å†…
          setTimeout(() => {
            const sandbox = document.getElementById(sandboxId);
            if (sandbox) {
              // æŸ¥æ‰¾è§’è‰²å¡å†…çš„æ‰€æœ‰styleæ ‡ç­¾
              const styleTags = sandbox.querySelectorAll('style');
              styleTags.forEach(styleTag => {
                let cssText = styleTag.textContent || styleTag.innerHTML;

                // å¦‚æœæ ·å¼å·²ç»åŒ…å«æ²™ç®±IDï¼Œè·³è¿‡
                if (cssText.includes(`#${sandboxId}`)) return;

                // é‡å†™CSSé€‰æ‹©å™¨ï¼šå°†æ‰€æœ‰å…¨å±€é€‰æ‹©å™¨ï¼ˆå¦‚ .story-content, .stat-barï¼‰éƒ½é™åˆ¶åœ¨æ²™ç®±å†…
                // åŒ¹é…å„ç§é€‰æ‹©å™¨æ¨¡å¼ï¼š.class, #id, element, element.class ç­‰
                cssText = cssText.replace(
                  /(^|\n|\{|\s|,)(\.story-content|\.stat-bar|\.stat-fill|\.chat|\.message|\.story-placeholder|\.story-loading|\.story-container|\.log-container|\.chat-messages-container|\.chat-input|textarea|input|button|\.btn|\.modal|\.modal-content)([^{]*\{)/g,
                  (match, prefix, selector, suffix) => {
                    // å¦‚æœé€‰æ‹©å™¨å·²ç»åœ¨æ²™ç®±å†…ï¼Œä¸å¤„ç†
                    if (match.includes(`#${sandboxId}`)) return match;
                    // å¦åˆ™æ·»åŠ æ²™ç®±IDå‰ç¼€
                    return `${prefix}#${sandboxId} ${selector}${suffix}`;
                  },
                );

                // æ›´æ–°æ ·å¼å†…å®¹
                styleTag.textContent = cssText;
              });
            }
          }, 0);

          // è‡ªå®šä¹‰å¡ç‰‡é€šå¸¸ç¼ºå°‘"ç³»ç»Ÿå­—æ®µ"å±•ç¤ºï¼Œè¿™é‡Œè¡¥ä¸€ä¸ªç®¡ç†ä¿¡æ¯é¢æ¿
          const infoSectionId = `char-info-${id}-${Date.now()}`;
          const infoSection = document.createElement('div');
          infoSection.id = infoSectionId;
          infoSection.style.cssText =
            'margin-top: 20px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; position: relative; z-index: 1; isolation: isolate; contain: layout style paint;';

          // æ·»åŠ ä¿æŠ¤æ ·å¼
          const infoProtectStyle = document.createElement('style');
          infoProtectStyle.textContent = `
            /* ä¿æŠ¤è§’è‰²ä¿¡æ¯é¢æ¿ï¼Œé˜²æ­¢è¢«è§’è‰²å¡æ ·å¼å½±å“ */
            #${infoSectionId} {
              position: relative !important;
              z-index: 1 !important;
              isolation: isolate !important;
              contain: layout style paint !important;
              all: revert !important;
            }
          `;
          document.head.appendChild(infoProtectStyle);
          infoSection.innerHTML = `
                  <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">è§’è‰²ä¿¡æ¯</h3>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 16px">
                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">
                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">å…ƒç´ </div>
                      <div style="font-size: 14px; color: var(--primary)">${(char.å…ƒç´  || []).join('ã€') || 'æ— '}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">
                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">æ€§åˆ«</div>
                      <div style="font-size: 14px">${char.æ€§åˆ« || 'æœªçŸ¥'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">
                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">ç§æ—/å‡ºèº«</div>
                      <div style="font-size: 14px">${char.ç§æ—å‡ºèº« || 'æœªçŸ¥'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">
                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">èŒä¸š/èº«ä»½</div>
                      <div style="font-size: 14px">${char.èŒä¸šèº«ä»½ || 'æœªçŸ¥'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">
                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">çŠ¶æ€</div>
                      <div style="font-size: 14px; color: ${char.çŠ¶æ€ === 'ç©ºé—²' ? 'var(--success)' : char.çŠ¶æ€ === 'æ¥å®¢ä¸­' ? 'var(--primary)' : 'var(--warning)'}">${char.çŠ¶æ€ || 'ç©ºé—²'}</div>
                      ${
                        char.çŠ¶æ€ === 'æ¥å®¢ä¸­'
                          ? (() => {
                              const workingInfo = gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[id];
                              if (workingInfo) {
                                const gameTime = getGameTime();
                                const nowRound = gameTime.å½“å‰å›åˆ || 1;
                                const startRound = workingInfo.å¼€å§‹å›åˆ || nowRound;
                                const endRound = workingInfo.é¢„è®¡ç»“æŸå›åˆ || startRound + 2;
                                const remain = Math.max(0, endRound - nowRound);
                                return `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px">å‰©ä½™ ${remain} å›åˆï¼Œé¢„è®¡ç¬¬ ${endRound} å›åˆç»“æŸ</div>`;
                              }
                              return '';
                            })()
                          : char.çŠ¶æ€ === 'è°ƒæ•™ä¸­'
                            ? (() => {
                                const trainingInfo = gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[id];
                                if (trainingInfo) {
                                  const gameTime = getGameTime();
                                  const nowRound = gameTime.å½“å‰å›åˆ || 1;
                                  const startRound = trainingInfo.å¼€å§‹å›åˆ || nowRound;
                                  const endRound = trainingInfo.é¢„è®¡ç»“æŸå›åˆ || startRound + 2;
                                  const remain = Math.max(0, endRound - nowRound);
                                  return `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px">å‰©ä½™ ${remain} å›åˆï¼Œé¢„è®¡ç¬¬ ${endRound} å›åˆç»“æŸ</div>`;
                                }
                                return '';
                              })()
                            : ''
                      }
                    </div>
                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">
                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">å½“å‰ä½ç½®</div>
                      <div style="font-size: 14px">${char.å½“å‰ä½ç½® || 'ä»“åº“'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">
                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">å…³ç³»é˜¶æ®µ</div>
                      <div style="font-size: 14px; font-weight: 700; color: var(--accent-gold)">${char.å…³ç³»é˜¶æ®µ || 'ä¸­ç«‹'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">
                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px">å¥½æ„Ÿåº¦</div>
                      <div style="display:flex; justify-content: space-between; align-items:center; gap: 10px">
                        <div style="font-size: 14px; font-weight: 700; color: var(--accent-gold)">${char.å¥½æ„Ÿåº¦ || 0}/100</div>
                        <div style="flex:1" class="stat-bar"><div class="stat-fill" style="width:${char.å¥½æ„Ÿåº¦ || 0}%; background: linear-gradient(90deg, var(--accent-gold), var(--primary))"></div></div>
                      </div>
                    </div>
                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px">
                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px">æ¨æ„</div>
                      <div style="display:flex; justify-content: space-between; align-items:center; gap: 10px">
                        <div style="font-size: 14px; font-weight: 700; color: var(--danger)">${char.æ¨æ„ || 0}/100</div>
                        <div style="flex:1" class="stat-bar"><div class="stat-fill" style="width:${char.æ¨æ„ || 0}%; background: linear-gradient(90deg, rgba(251,113,133,0.9), rgba(192,132,252,0.9))"></div></div>
                      </div>
                    </div>
                  </div>

                  <div style="margin-bottom: 12px">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px">å¤–è²Œç‰¹ç‚¹</div>
                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px; font-size: 13px; line-height: 1.7">${char.å¤–è²Œç‰¹ç‚¹ || 'æš‚æ— æè¿°'}</div>
                  </div>

                  <div style="margin-bottom: 12px">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px">æ€§æ ¼/å–œå¥½</div>
                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px; font-size: 13px; line-height: 1.7">${char.æ€§æ ¼å–œå¥½ || 'æš‚æ— æè¿°'}</div>
                  </div>

                  <div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px">ç®€ä»‹</div>
                    <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 10px; font-size: 13px; line-height: 1.7">${char.ç®€ä»‹ || 'æš‚æ— ç®€ä»‹'}</div>
                  </div>

                  <div style="margin-top: 16px">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px">å¤–è²Œç»˜ç”»æç¤ºè¯ï¼ˆè‡ªåŠ¨é…å›¾ä¼šå¤ç”¨ï¼‰</div>
                    <div style="padding: 12px; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; font-size: 12px; line-height: 1.8; white-space: pre-wrap; word-break: break-word">
                      ${char.å¤–è²Œæç¤ºè¯ || 'æš‚æ— ï¼ˆå¯é€šè¿‡æŠ½å¡ç”Ÿæˆçš„ç»˜å›¾æ ‡ç­¾è‡ªåŠ¨æå–ï¼‰'}
                    </div>
                    <div style="display:flex; justify-content:flex-end; margin-top: 10px">
                      <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px" onclick='copyImagePrompt(${JSON.stringify(char.å¤–è²Œæç¤ºè¯ || '')})' ${
                        char.å¤–è²Œæç¤ºè¯ ? '' : 'disabled'
                      }>å¤åˆ¶æç¤ºè¯</button>
                    </div>
                  </div>

                `;
          content.appendChild(infoSection);

          // æ·»åŠ å±æ€§æ˜¾ç¤ºåŒºåŸŸï¼ˆä½¿ç”¨å”¯ä¸€IDå’Œå¼ºä¿æŠ¤æ ·å¼ï¼Œé˜²æ­¢è¢«è§’è‰²å¡æ ·å¼å½±å“ï¼‰
          const attrSectionId = `char-attr-${id}-${Date.now()}`;
          const attrSection = document.createElement('div');
          attrSection.id = attrSectionId;
          attrSection.style.cssText =
            'margin-top: 20px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; position: relative; z-index: 1; isolation: isolate; contain: layout style paint;';

          // æ·»åŠ ä¿æŠ¤æ ·å¼
          const protectStyle = document.createElement('style');
          protectStyle.textContent = `
            /* ä¿æŠ¤å±æ€§æ˜¾ç¤ºåŒºåŸŸï¼Œé˜²æ­¢è¢«è§’è‰²å¡æ ·å¼å½±å“ */
            #${attrSectionId} {
              position: relative !important;
              z-index: 1 !important;
              isolation: isolate !important;
              contain: layout style paint !important;
              all: revert !important;
            }

            /* å¼ºåˆ¶å±æ€§æ¡çš„æ ·å¼ï¼Œä¼˜å…ˆçº§æœ€é«˜ */
            #${attrSectionId} .stat-bar {
              height: 8px !important;
              background: rgba(255, 255, 255, 0.08) !important;
              border-radius: 4px !important;
              overflow: hidden !important;
              margin: 6px 0 !important;
              position: relative !important;
              transform: none !important;
              rotate: none !important;
            }

            #${attrSectionId} .stat-fill {
              height: 100% !important;
              background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%) !important;
              transition: width 0.6s ease-out !important;
              border-radius: 4px !important;
              box-shadow: var(--glow-primary) !important;
              position: relative !important;
              transform: none !important;
              rotate: none !important;
            }
          `;
          document.head.appendChild(protectStyle);

          const staminaVal = typeof char.ä½“åŠ›å€¼ === 'number' ? Math.floor(char.ä½“åŠ›å€¼) : 100;
          const staminaIcon = staminaVal <= 20 ? 'ğŸ”´' : staminaVal <= 50 ? 'ğŸŸ¡' : 'ğŸŸ¢';

          attrSection.innerHTML = `
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px">
                    <h3 style="font-size: 18px; color: var(--primary); margin: 0">å±æ€§</h3>
                    <div style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(0,0,0,0.3); border-radius: 20px">
                      <span style="font-size: 14px">${staminaIcon}</span>
                      <span style="font-size: 13px; color: var(--text-secondary)">ä½“åŠ›</span>
                      <span style="font-size: 14px; font-weight: 600; color: var(--text-primary)">${staminaVal}%</span>
                    </div>
                  </div>
                  ${['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦']
                    .map(stat => {
                      const rawVal = char.å±æ€§?.[stat];
                      const val = typeof rawVal === 'number' ? Math.floor(rawVal) : 0;
                      const w = Math.max(0, Math.min(100, val));
                      return `
                    <div style="margin-bottom: 10px">
                      <div style="display: flex; justify-content: space-between; margin-bottom: 4px">
                        <span>${stat}</span>
                        <span>${val}/100</span>
                      </div>
                      <div class="stat-bar">
                        <div class="stat-fill" style="width: ${w}%"></div>
                      </div>
                    </div>
                  `;
                    })
                    .join('')}
                  <div style="font-size: 12px; color: var(--text-secondary); margin-top: 12px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px">
                    ğŸ’¡ æ¥å®¢æ—¶æ¶ˆè€—ä½“åŠ›ï¼Œç©ºé—²æ—¶è‡ªåŠ¨æ¢å¤ã€‚è€åŠ›è¶Šé«˜æ¶ˆè€—è¶Šæ…¢ã€‚
                  </div>
                `;
          content.appendChild(attrSection);

          // æ·»åŠ äº’åŠ¨å‰§æƒ…æ˜¾ç¤ºåŒºåŸŸï¼ˆæ·»åŠ ä¿æŠ¤æ ·å¼ï¼Œé˜²æ­¢è¢«è§’è‰²å¡æ ·å¼å½±å“ï¼‰
          const storySectionId = `char-story-${id}-${Date.now()}`;
          const storySection = document.createElement('div');
          storySection.id = storySectionId;
          storySection.style.cssText =
            'margin-top: 20px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; position: relative; z-index: 1; isolation: isolate; contain: layout style paint;';

          // æ·»åŠ ä¿æŠ¤æ ·å¼
          const storyProtectStyle = document.createElement('style');
          storyProtectStyle.textContent = `
            /* ä¿æŠ¤äº’åŠ¨å‰§æƒ…åŒºåŸŸï¼Œé˜²æ­¢è¢«è§’è‰²å¡æ ·å¼å½±å“ */
            #${storySectionId} {
              position: relative !important;
              z-index: 1 !important;
              isolation: isolate !important;
              contain: layout style paint !important;
              all: revert !important;
            }

            /* ä¿æŠ¤å‰§æƒ…å†…å®¹å®¹å™¨ */
            #${storySectionId} #story-content-${id} {
              position: relative !important;
              z-index: 1 !important;
              isolation: isolate !important;
              contain: layout style paint !important;
              all: revert !important;
            }

            /* ä¿æŠ¤å‰§æƒ…å†…å®¹æ ·å¼ */
            #${storySectionId} .story-content-isolated {
              all: initial !important;
              display: block !important;
              font-family: var(--font-serif) !important;
              line-height: 2.05 !important;
              color: var(--text-primary) !important;
              font-size: 16px !important;
              isolation: isolate !important;
              contain: layout style paint !important;
            }

            #${storySectionId} .story-content {
              font-family: var(--font-serif) !important;
              line-height: 2.05 !important;
              font-size: 15px !important;
              color: var(--text-primary) !important;
              white-space: pre-wrap !important;
              word-wrap: break-word !important;
            }

            #${storySectionId} .story-content img {
              max-width: 100% !important;
              height: auto !important;
              border-radius: 12px !important;
              margin: 15px 0 !important;
              box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5) !important;
            }

            #${storySectionId} .story-loading,
            #${storySectionId} .story-placeholder {
              text-align: center !important;
              color: var(--text-secondary) !important;
              padding: 40px !important;
            }
          `;
          document.head.appendChild(storyProtectStyle);

          storySection.innerHTML = `
                  <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">äº’åŠ¨å‰§æƒ…</h3>
                  <div id="story-content-${id}" class="story-content">
                  </div>
                `;
          content.appendChild(storySection);

          // æ·»åŠ æ‰€æœ‰æ“ä½œæŒ‰é’®ï¼ˆæ·»åŠ ä¿æŠ¤æ ·å¼ï¼‰
          const actionButtonsId = `char-actions-${id}-${Date.now()}`;
          const actionButtons = document.createElement('div');
          actionButtons.id = actionButtonsId;
          actionButtons.style.cssText =
            'margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; position: relative; z-index: 1; isolation: isolate; contain: layout style paint;';

          // æ·»åŠ ä¿æŠ¤æ ·å¼
          const actionProtectStyle = document.createElement('style');
          actionProtectStyle.textContent = `
            /* ä¿æŠ¤æ“ä½œæŒ‰é’®åŒºåŸŸï¼Œé˜²æ­¢è¢«è§’è‰²å¡æ ·å¼å½±å“ */
            #${actionButtonsId} {
              position: relative !important;
              z-index: 1 !important;
              isolation: isolate !important;
              contain: layout style paint !important;
              all: revert !important;
            }
          `;
          document.head.appendChild(actionProtectStyle);
          actionButtons.innerHTML = `
                  <button class="btn" onclick="openChatInterface('${id}')">ğŸ’¬ èŠå¤©äº’åŠ¨</button>
                  <button class="btn" onclick="assignCharacterToBrothel('${id}')">ğŸ›ï¸ æ´¾é£æ¥å®¢</button>
                  <button class="btn btn-secondary" onclick="showCharacterUpgrade('${id}')">â¬†ï¸ æå‡å±æ€§</button>
                  <button class="btn btn-secondary" onclick="decomposeCharacter('${id}')">âš¡ åˆ†è§£</button>
                `;
          content.appendChild(actionButtons);

          modal.classList.add('active');
          modal.scrollTop = 0;
          setTimeout(() => {
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
              modalContent.scrollTop = 0;
            }
          }, 100);
          return;
        }

        // å¦åˆ™æ˜¾ç¤ºæ ‡å‡†è¯¦æƒ…é¡µ
        const imageContainer = document.createElement('div');
        imageContainer.style.width = '100%';
        imageContainer.style.aspectRatio = '1';
        imageContainer.style.marginBottom = '20px';
        imageContainer.style.borderRadius = '12px';
        imageContainer.style.overflow = 'hidden';
        imageContainer.style.border = '1px solid rgba(139, 92, 246, 0.3)';
        imageContainer.className = 'character-image-container';

        if (char.ç»˜å›¾æ ‡ç­¾) {
          imageContainer.innerHTML =
            '<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 48px">â³</div>';
          setTimeout(() => {
            const rendered = renderImageTag(char.ç»˜å›¾æ ‡ç­¾, imageContainer);
            if (!rendered) {
              const prompt = char.ç»˜å›¾æ ‡ç­¾.match(/image###([\s\S]*?)###/)?.[1] || '';
              if (prompt) {
                imageContainer.innerHTML = `
                        <div class="image-placeholder" onclick="copyImagePrompt('${prompt.replace(/'/g, "\\'")}')">
                          <div style="font-size: 48px; margin-bottom: 8px">ğŸ–¼ï¸</div>
                          <div style="font-size: 12px; text-align: center; padding: 0 8px">ç‚¹å‡»å¤åˆ¶ç»˜ç”»æŒ‡ä»¤</div>
                        </div>
                      `;
              } else {
                imageContainer.innerHTML =
                  '<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 64px">ğŸ‘¤</div>';
              }
            }
          }, 100);
        } else {
          imageContainer.innerHTML =
            '<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 64px">ğŸ‘¤</div>';
        }

        content.innerHTML = `
              <h2 style="font-size: 28px; color: var(--primary); margin-bottom: 24px; text-align: center">${char.å§“å}</h2>
              <div id="char-detail-image"></div>

              <div style="margin-bottom: 24px">
                <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å¤–è²Œç»˜ç”»æç¤ºè¯ï¼ˆè‡ªåŠ¨é…å›¾ä¼šå¤ç”¨ï¼‰</h3>
                <div style="padding: 12px; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; font-size: 12px; line-height: 1.8; white-space: pre-wrap; word-break: break-word">
                  ${char.å¤–è²Œæç¤ºè¯ || 'æš‚æ— ï¼ˆå¯é€šè¿‡æŠ½å¡ç”Ÿæˆçš„ç»˜å›¾æ ‡ç­¾è‡ªåŠ¨æå–ï¼‰'}
                </div>
                <div style="display:flex; justify-content:flex-end; margin-top: 10px">
                  <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px" onclick='copyImagePrompt(${JSON.stringify(char.å¤–è²Œæç¤ºè¯ || '')})' ${
                    char.å¤–è²Œæç¤ºè¯ ? '' : 'disabled'
                  }>å¤åˆ¶æç¤ºè¯</button>
                </div>
              </div>

              <div style="margin-bottom: 24px">
                <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">äº’åŠ¨å‰§æƒ…</h3>
                <div id="story-content-${id}" class="story-content" style="padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; min-height: 100px; position: relative; z-index: 1; isolation: isolate; contain: layout style paint;">
                </div>
              </div>

              <div style="margin-bottom: 24px">
                <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">æ“ä½œ</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px">
                  <button class="btn" onclick="openChatInterface('${id}')">ğŸ’¬ èŠå¤©äº’åŠ¨</button>
                  <button class="btn" onclick="assignCharacterToBrothel('${id}')">ğŸ›ï¸ æ´¾é£æ¥å®¢</button>
                  <button class="btn btn-secondary" onclick="showCharacterUpgrade('${id}')">â¬†ï¸ æå‡å±æ€§</button>
                  <button class="btn btn-secondary" onclick="decomposeCharacter('${id}')">âš¡ åˆ†è§£</button>
                </div>
              </div>
            `;

        const imagePlaceholder = content.querySelector('#char-detail-image');
        if (imagePlaceholder) {
          imagePlaceholder.parentNode.replaceChild(imageContainer, imagePlaceholder);
        }

        modal.classList.add('active');

        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        modal.scrollTop = 0;

        // ç¡®ä¿æ¨¡æ€æ¡†å†…å®¹å¯ä»¥æ­£å¸¸æ»šåŠ¨
        setTimeout(() => {
          const modalContent = modal.querySelector('.modal-content');
          if (modalContent) {
            modalContent.scrollTop = 0;
          }
        }, 100);
      }

      function closeCharacterDetail() {
        const modal = document.getElementById('character-detail-modal');
        if (modal) {
          modal.classList.remove('active');
        }
      }

      // ==================== äº’åŠ¨åŠŸèƒ½ ====================
      function showTrainingInput(characterId) {
        const char = gameState.è§’è‰²ä»“åº“[characterId];
        if (!char) return;

        // åˆ›å»ºè°ƒæ•™è¾“å…¥æ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'training-input-modal';
        modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px">
                  <button class="modal-close" onclick="closeTrainingInput()">Ã—</button>
                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">ğŸ” è°ƒæ•™è§’è‰²ï¼š${char.å§“å}</h2>

                  <div style="margin-bottom: 16px">
                    <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 8px">è°ƒæ•™æŒ‡ä»¤ï¼ˆæè¿°ä½ æƒ³è¦è¿›è¡Œçš„è°ƒæ•™å†…å®¹ï¼‰ï¼š</label>
                    <textarea
                      id="training-command-input"
                      placeholder="ä¾‹å¦‚ï¼šä½¿ç”¨é­å­è¿›è¡Œè½»åº¦è°ƒæ•™ï¼Œé‡ç‚¹æå‡è§’è‰²çš„é¡ºä»åº¦..."
                      style="
                        width: 100%;
                        min-height: 150px;
                        padding: 12px;
                        background: rgba(15, 23, 42, 0.6);
                        border: 1px solid rgba(139, 92, 246, 0.3);
                        border-radius: 12px;
                        color: var(--text-primary);
                        font-size: 14px;
                        resize: vertical;
                        font-family: inherit;
                      "
                    ></textarea>
                  </div>

                  <div style="display: flex; gap: 12px; justify-content: flex-end">
                    <button class="btn btn-secondary" onclick="closeTrainingInput()">å–æ¶ˆ</button>
                    <button class="btn" onclick="confirmTraining('${characterId}')">å¼€å§‹è°ƒæ•™</button>
                  </div>
                </div>
              `;

        document.body.appendChild(modal);
        modal.classList.add('active');

        // èšç„¦è¾“å…¥æ¡†
        setTimeout(() => {
          const input = document.getElementById('training-command-input');
          if (input) input.focus();
        }, 100);
      }

      function closeTrainingInput() {
        closeModal('training-input-modal');
      }

      async function confirmTraining(characterId) {
        const input = document.getElementById('training-command-input');
        const userCommand = input ? input.value.trim() : '';

        closeTrainingInput();

        if (!userCommand) {
          alert('è¯·è¾“å…¥è°ƒæ•™æŒ‡ä»¤ï¼');
          return;
        }

        // ç¡®ä¿è§’è‰²è¯¦æƒ…é¡µå·²æ‰“å¼€ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ‰“å¼€
        const modal = document.getElementById('character-detail-modal');
        if (!modal || !modal.classList.contains('active')) {
          showCharacterDetail(characterId);
          // ç­‰å¾…æ¨¡æ€æ¡†æ‰“å¼€åå†æ‰§è¡Œè°ƒæ•™
          setTimeout(() => {
            startInteraction(characterId, 'è°ƒæ•™', userCommand);
          }, 300);
        } else {
          await startInteraction(characterId, 'è°ƒæ•™', userCommand);
        }
      }

      // ==================== èŠå¤©äº’åŠ¨ç³»ç»Ÿ ====================
      function openChatInterface(characterId) {
        const char = gameState.è§’è‰²ä»“åº“[characterId];
        if (!char) return;
        normalizeCharacter(char);

        // åˆå§‹åŒ–èŠå¤©è®°å½•
        if (!char.èŠå¤©è®°å½•) char.èŠå¤©è®°å½• = [];
        if (!char.èŠå¤©æ‘˜è¦) char.èŠå¤©æ‘˜è¦ = '';

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'chat-interface-modal';
        modal.style.cssText = 'z-index: 10000;';
        modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; height: 85vh; display: flex; flex-direction: column">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-shrink: 0">
                    <h2 style="font-size: 24px; color: var(--primary); margin: 0">ğŸ’¬ ä¸ ${char.å§“å} èŠå¤©</h2>
                    <button class="modal-close" onclick="closeChatInterface()">Ã—</button>
                  </div>

                  <div style="flex: 1; overflow-y: auto; padding: 16px; background: rgba(15, 23, 42, 0.4); border-radius: 12px; margin-bottom: 16px; display: flex; flex-direction: column; gap: 12px; isolation: isolate; contain: layout style paint; position: relative; z-index: 1; user-select: text; -webkit-user-select: text;" id="chat-messages-container">
                    ${char.èŠå¤©è®°å½•.length === 0 ? '<div style="text-align: center; color: var(--text-secondary); padding: 40px">å¼€å§‹ä¸è§’è‰²èŠå¤©å§ï¼</div>' : ''}
                    ${char.èŠå¤©è®°å½•
                      .map(
                        msg => `
                      <div style="padding: 12px; background: ${msg.role === 'user' ? 'rgba(139, 92, 246, 0.2)' : 'rgba(255,255,255,0.05)'}; border-radius: 8px; border-left: 3px solid ${msg.role === 'user' ? 'var(--primary)' : 'var(--accent-gold)'}; isolation: isolate; contain: layout style paint; position: relative; z-index: 1; user-select: text; -webkit-user-select: text;">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px">${msg.role === 'user' ? 'ä½ ' : char.å§“å}</div>
                        <div style="white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; user-select: text; -webkit-user-select: text;">${msg.content}</div>
                        ${msg.attrChanges ? `<div style="margin-top: 8px; font-size: 11px; color: var(--accent-gold)">ã€å±æ€§å˜åŒ–ã€‘${msg.attrChanges}</div>` : ''}
                      </div>
                    `,
                      )
                      .join('')}
                  </div>

                  <div style="flex-shrink: 0; display: flex; flex-direction: column; gap: 12px">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px">
                      <button class="btn btn-secondary" style="padding: 8px; font-size: 12px" onclick="sendChatAction('${characterId}', 'è°ƒæ•™')">ğŸ” è°ƒæ•™</button>
                      <button class="btn btn-secondary" style="padding: 8px; font-size: 12px" onclick="sendChatAction('${characterId}', 'ç‰¹æ®Šäº’åŠ¨')">âœ¨ ç‰¹æ®Šäº’åŠ¨</button>
                      <button class="btn btn-secondary" style="padding: 8px; font-size: 12px" onclick="sendChatAction('${characterId}', 'å¥–åŠ±')">ğŸ å¥–åŠ±</button>
                      <button class="btn btn-secondary" style="padding: 8px; font-size: 12px" onclick="sendChatAction('${characterId}', 'æƒ©ç½š')">âš”ï¸ æƒ©ç½š</button>
                    </div>
                    <div style="display: flex; gap: 8px">
                      <textarea
                        id="chat-input"
                        placeholder="è¾“å…¥æ¶ˆæ¯ä¸è§’è‰²èŠå¤©..."
                        style="
                          flex: 1;
                          min-height: 60px;
                          max-height: 120px;
                          padding: 12px;
                          background: rgba(15, 23, 42, 0.6);
                          border: 1px solid rgba(255,255,255,0.12);
                          border-radius: 8px;
                          color: var(--text-primary);
                          font-size: 14px;
                          isolation: isolate;
                          contain: layout style paint;
                          position: relative;
                          z-index: 1;
                          user-select: text;
                          -webkit-user-select: text;
                          resize: vertical;
                          font-family: inherit;
                        "
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendChatMessage('${characterId}'); }"
                      ></textarea>
                      <button class="btn" style="padding: 12px 24px; align-self: flex-end" onclick="sendChatMessage('${characterId}')">å‘é€</button>
                    </div>
                    <div style="font-size: 11px; color: var(--text-secondary); text-align: center">
                      èŠå¤©æ¬¡æ•°ï¼š${char.èŠå¤©æ¬¡æ•° || 0}/5ï¼ˆ5æ¬¡èŠå¤©=1å›åˆï¼‰
                    </div>
                  </div>
                </div>
              `;

        document.body.appendChild(modal);
        modal.classList.add('active');

        // æ»šåŠ¨åˆ°åº•éƒ¨
        setTimeout(() => {
          const container = document.getElementById('chat-messages-container');
          if (container) container.scrollTop = container.scrollHeight;
          const input = document.getElementById('chat-input');
          if (input) input.focus();
        }, 100);
      }

      function closeChatInterface() {
        closeModal('chat-interface-modal');
      }

      async function sendChatMessage(characterId) {
        const input = document.getElementById('chat-input');
        const message = input ? input.value.trim() : '';
        if (!message) return;

        const char = gameState.è§’è‰²ä»“åº“[characterId];
        if (!char) return;
        normalizeCharacter(char);

        // å…ˆæ¸…ç©ºè¾“å…¥æ¡†ï¼ˆä½†ä¸ä¿å­˜æ¶ˆæ¯ï¼Œç­‰AIå›å¤æˆåŠŸåå†ä¿å­˜ï¼‰
        input.value = '';

        // æ„å»ºä¸Šä¸‹æ–‡ï¼šåŒ…å«èŠå¤©å†å²å’Œè§’è‰²çŠ¶æ€ï¼ˆä½¿ç”¨å½“å‰çš„èŠå¤©è®°å½•ï¼Œä¸åŒ…æ‹¬æœ¬æ¬¡æ¶ˆæ¯ï¼‰
        if (!char.èŠå¤©è®°å½• || !Array.isArray(char.èŠå¤©è®°å½•)) char.èŠå¤©è®°å½• = [];
        const chatHistory = char.èŠå¤©è®°å½•
          .slice(-10)
          .filter(msg => msg && msg.role && msg.content) // è¿‡æ»¤æ— æ•ˆæ¶ˆæ¯
          .map(msg => `${msg.role === 'user' ? 'ä½ ' : char.å§“å}: ${msg.content}`)
          .join('\n');

        // ==================== å…³é”®ä¿®å¤ï¼šæ·»åŠ å®Œæ•´çš„è§’è‰²ä¿¡æ¯ ====================
        const characterInfo = `è§’è‰²å®Œæ•´ä¿¡æ¯ï¼š
- å§“åï¼š${char.å§“å || 'æœªçŸ¥'}
- æ€§åˆ«ï¼š${char.æ€§åˆ« || 'æœªçŸ¥'}ï¼ˆ**é‡è¦ï¼šå¿…é¡»ä½¿ç”¨æ­£ç¡®çš„æ€§åˆ«ä»£è¯ï¼Œç”·æ€§ç”¨"ä»–"ï¼Œå¥³æ€§ç”¨"å¥¹"ï¼ŒåŒæ€§ç”·æ€§ç”¨"ä»–"**ï¼‰
- ç¨€æœ‰åº¦ï¼š${char.ç¨€æœ‰åº¦ || 'N'}
- ç§æ—/å‡ºèº«ï¼š${char.ç§æ—å‡ºèº« || 'æœªçŸ¥'}
- èŒä¸š/èº«ä»½ï¼š${char.èŒä¸šèº«ä»½ || 'æœªçŸ¥'}
- å…ƒç´ ï¼š${(char.å…ƒç´  || []).join('ã€') || 'æ— '}
- å¤–è²Œç‰¹ç‚¹ï¼š${char.å¤–è²Œç‰¹ç‚¹ || 'æš‚æ— æè¿°'}
- æ€§æ ¼/å–œå¥½ï¼š${char.æ€§æ ¼å–œå¥½ || 'æš‚æ— æè¿°'}
- ç®€ä»‹ï¼š${char.ç®€ä»‹ || 'æš‚æ— ç®€ä»‹'}
- èƒŒæ™¯æ•…äº‹ï¼š${(char.èƒŒæ™¯æ•…äº‹ || 'æš‚æ— èƒŒæ™¯æ•…äº‹').substring(0, 500)}${(char.èƒŒæ™¯æ•…äº‹ || '').length > 500 ? '...' : ''}
- å±æ€§ï¼šé­…åŠ›${char.å±æ€§?.é­…åŠ› || 0}ã€é¡ºä»${char.å±æ€§?.é¡ºä» || 0}ã€æŠ€å·§${char.å±æ€§?.æŠ€å·§ || 0}ã€è€åŠ›${char.å±æ€§?.è€åŠ› || 0}ã€æ•æ„Ÿåº¦${char.å±æ€§?.æ•æ„Ÿåº¦ || 0}
- æƒ…æ„ŸçŠ¶æ€ï¼š${char.æƒ…æ„ŸçŠ¶æ€?.å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ || 'ä¸­ç«‹'}ï¼ˆå¼ºåº¦ï¼š${char.æƒ…æ„ŸçŠ¶æ€?.æƒ…æ„Ÿå¼ºåº¦ || 0}ï¼‰
${char.æƒ…æ„ŸçŠ¶æ€?.ç‰¹æ®ŠçŠ¶æ€ && Array.isArray(char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€) && char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.length > 0 ? `- ç‰¹æ®ŠçŠ¶æ€ï¼š${char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.join('ã€')}` : ''}
- å½“å‰çŠ¶æ€ï¼š${char.çŠ¶æ€ || 'ç©ºé—²'}
- å½“å‰ä½ç½®ï¼š${char.å½“å‰ä½ç½® || 'ä»“åº“'}
- å¥½æ„Ÿåº¦ï¼š${char.å¥½æ„Ÿåº¦ || 0}/100
- æ¨æ„ï¼š${char.æ¨æ„ || 0}/100
- å…³ç³»é˜¶æ®µï¼š${char.å…³ç³»é˜¶æ®µ || 'ä¸­ç«‹'}`;

        const summaryInfo = char.èŠå¤©æ‘˜è¦ ? `\n\nä¹‹å‰çš„èŠå¤©æ‘˜è¦ï¼š${char.èŠå¤©æ‘˜è¦}` : '';

        const command = `ã€æŒç»­èŠå¤©æ¨¡å¼ã€‘è¿™æ˜¯ä¸è§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰çš„æŒç»­èŠå¤©äº’åŠ¨ã€‚
è§’è‰²æ˜ç™½è‡ªå·±ç°åœ¨å¤„äºä¸€ä¸ªå¦“é™¢ç»è¥çš„ç¯å¢ƒä¸­ï¼Œä½ æ˜¯ç®¡ç†è€…ã€‚è§’è‰²çŸ¥é“è‡ªå·±çš„å½“å‰çŠ¶æ€å’Œæƒ…å†µã€‚

${characterInfo}

${summaryInfo}

æœ€è¿‘çš„èŠå¤©è®°å½•ï¼š
${chatHistory}

ä½ åˆšæ‰è¯´ï¼š${message}

è¯·ä»¥${char.å§“å}çš„èº«ä»½å›å¤ï¼Œå›å¤åº”è¯¥ï¼š
- **å¿…é¡»ä½¿ç”¨æ­£ç¡®çš„æ€§åˆ«ä»£è¯**ï¼š${char.æ€§åˆ« === 'ç”·æ€§' || char.æ€§åˆ« === 'åŒæ€§ç”·æ€§' ? 'ä½¿ç”¨"ä»–"ï¼ˆä¸æ˜¯"å¥¹"ï¼‰' : char.æ€§åˆ« === 'å¥³æ€§' ? 'ä½¿ç”¨"å¥¹"ï¼ˆä¸æ˜¯"ä»–"ï¼‰' : 'æ ¹æ®è§’è‰²æ€§åˆ«ä½¿ç”¨æ­£ç¡®çš„ä»£è¯'}
- ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€å¤–è²Œã€èƒŒæ™¯æ•…äº‹å’Œå½“å‰çŠ¶æ€
- è‡ªç„¶ã€çœŸå®ã€æœ‰äº’åŠ¨æ„Ÿ
- å¯ä»¥æ™®é€šäº¤æµï¼Œä¹Ÿå¯ä»¥å›åº”è°ƒæ•™/å¥–åŠ±/æƒ©ç½šç­‰ç‰¹æ®Šäº’åŠ¨
- å¦‚æœæ¶‰åŠå±æ€§å˜åŒ–ï¼Œä½¿ç”¨<JSONPatch>æ›´æ–°

åªè¾“å‡ºï¼šè§’è‰²å›å¤ + <JSONPatch>æ›´æ–°ï¼ˆå¦‚æœ‰ï¼‰`;

        try {
          const response = await sendCommandToAI(command, true);
          if (response && response.trim()) {
            // åªæœ‰åœ¨æˆåŠŸè·å¾—å›å¤åï¼Œæ‰ä¿å­˜ç”¨æˆ·æ¶ˆæ¯å’Œå¢åŠ èŠå¤©æ¬¡æ•°
            if (!char.èŠå¤©è®°å½• || !Array.isArray(char.èŠå¤©è®°å½•)) char.èŠå¤©è®°å½• = [];
            char.èŠå¤©è®°å½•.push({ role: 'user', content: message, timestamp: Date.now() });
            char.èŠå¤©æ¬¡æ•° = (char.èŠå¤©æ¬¡æ•° || 0) + 1;

            let replyText = response;
            const jsonPatchMatch = replyText.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/);
            let attrChanges = '';
            if (jsonPatchMatch) {
              try {
                // è®°å½•åº”ç”¨patchå‰çš„å±æ€§å€¼
                normalizeCharacter(char);
                const prevAttrs = {
                  é­…åŠ›: char.å±æ€§?.é­…åŠ› || 0,
                  é¡ºä»: char.å±æ€§?.é¡ºä» || 0,
                  æŠ€å·§: char.å±æ€§?.æŠ€å·§ || 0,
                  è€åŠ›: char.å±æ€§?.è€åŠ› || 0,
                  æ•æ„Ÿåº¦: char.å±æ€§?.æ•æ„Ÿåº¦ || 0,
                };
                const prevLike = char.å¥½æ„Ÿåº¦ || 0;
                const prevHate = char.æ¨æ„ || 0;

                const patches = JSON.parse(cleanJsonString(jsonPatchMatch[1]));
                applyJSONPatches(patches);

                // è®¡ç®—å±æ€§å˜åŒ–ï¼ˆåº”ç”¨patchåï¼‰
                normalizeCharacter(char);
                const changes = [];
                ['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦'].forEach(stat => {
                  const delta = (char.å±æ€§?.[stat] || 0) - prevAttrs[stat];
                  if (delta !== 0) changes.push(`${stat} ${delta > 0 ? '+' : ''}${delta}`);
                });
                const likeDelta = (char.å¥½æ„Ÿåº¦ || 0) - prevLike;
                const hateDelta = (char.æ¨æ„ || 0) - prevHate;
                if (likeDelta !== 0) changes.push(`å¥½æ„Ÿåº¦ ${likeDelta > 0 ? '+' : ''}${likeDelta}`);
                if (hateDelta !== 0) changes.push(`æ¨æ„ ${hateDelta > 0 ? '+' : ''}${hateDelta}`);
                if (changes.length > 0) attrChanges = changes.join('ï¼Œ');
              } catch (error) {
                console.error('è§£æ JSON Patch å¤±è´¥:', error);
              }
              replyText = replyText.replace(/<JSONPatch>[\s\S]*?<\/JSONPatch>/, '').trim();
            }
            replyText = filterHtmlFromStory(replyText);

            // æ·»åŠ è§’è‰²å›å¤åˆ°èŠå¤©è®°å½•
            if (!char.èŠå¤©è®°å½• || !Array.isArray(char.èŠå¤©è®°å½•)) char.èŠå¤©è®°å½• = [];
            char.èŠå¤©è®°å½•.push({ role: 'assistant', content: replyText, attrChanges, timestamp: Date.now() });

            // æ¯5æ¬¡èŠå¤©ç”Ÿæˆä¸€æ¬¡æ‘˜è¦å¹¶æ¨è¿›å›åˆ
            if (char.èŠå¤©æ¬¡æ•° >= 5) {
              char.èŠå¤©æ¬¡æ•° = 0;
              // ç”ŸæˆèŠå¤©æ‘˜è¦
              const summaryCommand = `ä¸ºä»¥ä¸‹èŠå¤©è®°å½•ç”Ÿæˆä¸€ä¸ªç®€æ´çš„æ‘˜è¦ï¼ˆ50å­—ä»¥å†…ï¼‰ï¼Œç”¨äºåç»­å¯¹è¯çš„ä¸Šä¸‹æ–‡ï¼š
${(char.èŠå¤©è®°å½• || [])
  .filter(msg => msg && msg.role && msg.content)
  .slice(-10)
  .map(msg => `${msg.role === 'user' ? 'ä½ ' : char.å§“å}: ${msg.content}`)
  .join('\n')}

åªè¾“å‡ºæ‘˜è¦ï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚`;
              try {
                const summaryResponse = await sendCommandToAI(summaryCommand, true);
                if (summaryResponse) {
                  char.èŠå¤©æ‘˜è¦ = filterHtmlFromStory(summaryResponse).trim();
                }
              } catch (e) {
                console.warn('ç”ŸæˆèŠå¤©æ‘˜è¦å¤±è´¥:', e);
              }
              advanceRound();
            }

            saveGameStateToMVU();
            updateChatUI(characterId);
          } else {
            // AIæ²¡æœ‰è¿”å›æœ‰æ•ˆå›å¤ï¼Œæ¢å¤è¾“å…¥æ¡†å†…å®¹
            input.value = message;
            if (typeof toastr !== 'undefined') {
              toastr.error('AIæœªè¿”å›æœ‰æ•ˆå›å¤ï¼Œè¯·é‡è¯•');
            } else {
              alert('AIæœªè¿”å›æœ‰æ•ˆå›å¤ï¼Œè¯·é‡è¯•');
            }
          }
        } catch (error) {
          console.error('å‘é€èŠå¤©æ¶ˆæ¯å¤±è´¥:', error);
          // å‘ç”Ÿé”™è¯¯ï¼Œæ¢å¤è¾“å…¥æ¡†å†…å®¹
          input.value = message;
          if (typeof toastr !== 'undefined') {
            toastr.error(`å‘é€å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
          } else {
            alert(`å‘é€å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
          }
        }
      }

      async function sendChatAction(characterId, actionType) {
        const char = gameState.è§’è‰²ä»“åº“[characterId];
        if (!char) return;
        normalizeCharacter(char);

        // æ ¹æ®åŠ¨ä½œç±»å‹æ„å»ºæ¶ˆæ¯
        let message = '';
        switch (actionType) {
          case 'è°ƒæ•™':
            message = 'ã€è°ƒæ•™ã€‘æˆ‘æƒ³å¯¹ä½ è¿›è¡Œè°ƒæ•™ã€‚';
            break;
          case 'ç‰¹æ®Šäº’åŠ¨':
            message = 'ã€ç‰¹æ®Šäº’åŠ¨ã€‘æˆ‘æƒ³å’Œä½ è¿›è¡Œä¸€äº›ç‰¹æ®Šçš„äº’åŠ¨ã€‚';
            break;
          case 'å¥–åŠ±':
            message = 'ã€å¥–åŠ±ã€‘æˆ‘æƒ³ç»™ä½ ä¸€äº›å¥–åŠ±ã€‚';
            break;
          case 'æƒ©ç½š':
            message = 'ã€æƒ©ç½šã€‘æˆ‘è¦æƒ©ç½šä½ ã€‚';
            break;
        }

        // å…ˆæ›´æ–°UIæ˜¾ç¤ºï¼ˆä½†ä¸ä¿å­˜æ¶ˆæ¯ï¼Œç­‰AIå›å¤æˆåŠŸåå†ä¿å­˜ï¼‰
        updateChatUI(characterId);

        // æ„å»ºå‘½ä»¤ï¼ˆä½¿ç”¨å½“å‰çš„èŠå¤©è®°å½•ï¼Œä¸åŒ…æ‹¬æœ¬æ¬¡æ¶ˆæ¯ï¼‰
        if (!char.èŠå¤©è®°å½• || !Array.isArray(char.èŠå¤©è®°å½•)) char.èŠå¤©è®°å½• = [];
        const chatHistory = char.èŠå¤©è®°å½•
          .filter(msg => msg && msg.role && msg.content) // è¿‡æ»¤æ— æ•ˆæ¶ˆæ¯
          .slice(-10)
          .map(msg => `${msg.role === 'user' ? 'ä½ ' : char.å§“å}: ${msg.content}`)
          .join('\n');

        // ==================== å…³é”®ä¿®å¤ï¼šæ·»åŠ å®Œæ•´çš„è§’è‰²ä¿¡æ¯ ====================
        const characterInfo = `è§’è‰²å®Œæ•´ä¿¡æ¯ï¼š
- å§“åï¼š${char.å§“å || 'æœªçŸ¥'}
- æ€§åˆ«ï¼š${char.æ€§åˆ« || 'æœªçŸ¥'}ï¼ˆ**é‡è¦ï¼šå¿…é¡»ä½¿ç”¨æ­£ç¡®çš„æ€§åˆ«ä»£è¯ï¼Œç”·æ€§ç”¨"ä»–"ï¼Œå¥³æ€§ç”¨"å¥¹"ï¼ŒåŒæ€§ç”·æ€§ç”¨"ä»–"**ï¼‰
- ç¨€æœ‰åº¦ï¼š${char.ç¨€æœ‰åº¦ || 'N'}
- ç§æ—/å‡ºèº«ï¼š${char.ç§æ—å‡ºèº« || 'æœªçŸ¥'}
- èŒä¸š/èº«ä»½ï¼š${char.èŒä¸šèº«ä»½ || 'æœªçŸ¥'}
- å…ƒç´ ï¼š${(char.å…ƒç´  || []).join('ã€') || 'æ— '}
- å¤–è²Œç‰¹ç‚¹ï¼š${char.å¤–è²Œç‰¹ç‚¹ || 'æš‚æ— æè¿°'}
- æ€§æ ¼/å–œå¥½ï¼š${char.æ€§æ ¼å–œå¥½ || 'æš‚æ— æè¿°'}
- ç®€ä»‹ï¼š${char.ç®€ä»‹ || 'æš‚æ— ç®€ä»‹'}
- èƒŒæ™¯æ•…äº‹ï¼š${(char.èƒŒæ™¯æ•…äº‹ || 'æš‚æ— èƒŒæ™¯æ•…äº‹').substring(0, 500)}${(char.èƒŒæ™¯æ•…äº‹ || '').length > 500 ? '...' : ''}
- å±æ€§ï¼šé­…åŠ›${char.å±æ€§?.é­…åŠ› || 0}ã€é¡ºä»${char.å±æ€§?.é¡ºä» || 0}ã€æŠ€å·§${char.å±æ€§?.æŠ€å·§ || 0}ã€è€åŠ›${char.å±æ€§?.è€åŠ› || 0}ã€æ•æ„Ÿåº¦${char.å±æ€§?.æ•æ„Ÿåº¦ || 0}
- æƒ…æ„ŸçŠ¶æ€ï¼š${char.æƒ…æ„ŸçŠ¶æ€?.å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ || 'ä¸­ç«‹'}ï¼ˆå¼ºåº¦ï¼š${char.æƒ…æ„ŸçŠ¶æ€?.æƒ…æ„Ÿå¼ºåº¦ || 0}ï¼‰
${char.æƒ…æ„ŸçŠ¶æ€?.ç‰¹æ®ŠçŠ¶æ€ && Array.isArray(char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€) && char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.length > 0 ? `- ç‰¹æ®ŠçŠ¶æ€ï¼š${char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.join('ã€')}` : ''}
- å½“å‰çŠ¶æ€ï¼š${char.çŠ¶æ€ || 'ç©ºé—²'}
- å½“å‰ä½ç½®ï¼š${char.å½“å‰ä½ç½® || 'ä»“åº“'}
- å¥½æ„Ÿåº¦ï¼š${char.å¥½æ„Ÿåº¦ || 0}/100
- æ¨æ„ï¼š${char.æ¨æ„ || 0}/100
- å…³ç³»é˜¶æ®µï¼š${char.å…³ç³»é˜¶æ®µ || 'ä¸­ç«‹'}`;

        const summaryInfo = char.èŠå¤©æ‘˜è¦ ? `\n\nä¹‹å‰çš„èŠå¤©æ‘˜è¦ï¼š${char.èŠå¤©æ‘˜è¦}` : '';

        const command = `ã€æŒç»­èŠå¤©æ¨¡å¼ - ${actionType}ã€‘è¿™æ˜¯ä¸è§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰çš„æŒç»­èŠå¤©äº’åŠ¨ã€‚

${characterInfo}

${summaryInfo}

æœ€è¿‘çš„èŠå¤©è®°å½•ï¼š
${chatHistory}

ä½ åˆšæ‰è¯´ï¼š${message}

è¯·ç”Ÿæˆ${actionType}ç›¸å…³çš„å‰§æƒ…å’Œè§’è‰²ååº”ã€‚
- **å¿…é¡»ä½¿ç”¨æ­£ç¡®çš„æ€§åˆ«ä»£è¯**ï¼š${char.æ€§åˆ« === 'ç”·æ€§' || char.æ€§åˆ« === 'åŒæ€§ç”·æ€§' ? 'ä½¿ç”¨"ä»–"ï¼ˆä¸æ˜¯"å¥¹"ï¼‰' : char.æ€§åˆ« === 'å¥³æ€§' ? 'ä½¿ç”¨"å¥¹"ï¼ˆä¸æ˜¯"ä»–"ï¼‰' : 'æ ¹æ®è§’è‰²æ€§åˆ«ä½¿ç”¨æ­£ç¡®çš„ä»£è¯'}
- ç¬¦åˆè§’è‰²çš„æ€§æ ¼ã€å¤–è²Œã€èƒŒæ™¯æ•…äº‹å’Œå½“å‰çŠ¶æ€
- å¿…é¡»ä½¿ç”¨<JSONPatch>æ›´æ–°è§’è‰²å±æ€§

åªè¾“å‡ºï¼šå‰§æƒ…æè¿° + <JSONPatch>æ›´æ–°`;

        try {
          const response = await sendCommandToAI(command, true);
          if (response && response.trim()) {
            // åªæœ‰åœ¨æˆåŠŸè·å¾—å›å¤åï¼Œæ‰ä¿å­˜ç”¨æˆ·æ¶ˆæ¯å’Œå¢åŠ èŠå¤©æ¬¡æ•°
            if (!char.èŠå¤©è®°å½• || !Array.isArray(char.èŠå¤©è®°å½•)) char.èŠå¤©è®°å½• = [];
            char.èŠå¤©è®°å½•.push({ role: 'user', content: message, timestamp: Date.now() });
            char.èŠå¤©æ¬¡æ•° = (char.èŠå¤©æ¬¡æ•° || 0) + 1;

            let replyText = response;
            const jsonPatchMatch = replyText.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/);
            let attrChanges = '';
            if (jsonPatchMatch) {
              try {
                // è®°å½•åº”ç”¨patchå‰çš„å±æ€§å€¼
                normalizeCharacter(char);
                const prevAttrs = {
                  é­…åŠ›: char.å±æ€§?.é­…åŠ› || 0,
                  é¡ºä»: char.å±æ€§?.é¡ºä» || 0,
                  æŠ€å·§: char.å±æ€§?.æŠ€å·§ || 0,
                  è€åŠ›: char.å±æ€§?.è€åŠ› || 0,
                  æ•æ„Ÿåº¦: char.å±æ€§?.æ•æ„Ÿåº¦ || 0,
                };
                const prevLike = char.å¥½æ„Ÿåº¦ || 0;
                const prevHate = char.æ¨æ„ || 0;

                const patches = JSON.parse(cleanJsonString(jsonPatchMatch[1]));
                applyJSONPatches(patches);

                // è®¡ç®—å±æ€§å˜åŒ–ï¼ˆåº”ç”¨patchåï¼‰
                normalizeCharacter(char);
                const changes = [];
                ['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦'].forEach(stat => {
                  const delta = (char.å±æ€§?.[stat] || 0) - prevAttrs[stat];
                  if (delta !== 0) changes.push(`${stat} ${delta > 0 ? '+' : ''}${delta}`);
                });
                const likeDelta = (char.å¥½æ„Ÿåº¦ || 0) - prevLike;
                const hateDelta = (char.æ¨æ„ || 0) - prevHate;
                if (likeDelta !== 0) changes.push(`å¥½æ„Ÿåº¦ ${likeDelta > 0 ? '+' : ''}${likeDelta}`);
                if (hateDelta !== 0) changes.push(`æ¨æ„ ${hateDelta > 0 ? '+' : ''}${hateDelta}`);
                if (changes.length > 0) attrChanges = changes.join('ï¼Œ');
              } catch (error) {
                console.error('è§£æ JSON Patch å¤±è´¥:', error);
              }
              replyText = replyText.replace(/<JSONPatch>[\s\S]*?<\/JSONPatch>/, '').trim();
            }
            replyText = filterHtmlFromStory(replyText);

            // æ·»åŠ è§’è‰²å›å¤åˆ°èŠå¤©è®°å½•
            if (!char.èŠå¤©è®°å½• || !Array.isArray(char.èŠå¤©è®°å½•)) char.èŠå¤©è®°å½• = [];
            char.èŠå¤©è®°å½•.push({ role: 'assistant', content: replyText, attrChanges, timestamp: Date.now() });

            // æ¯5æ¬¡èŠå¤©æ¨è¿›å›åˆ
            if (char.èŠå¤©æ¬¡æ•° >= 5) {
              char.èŠå¤©æ¬¡æ•° = 0;
              const summaryCommand = `ä¸ºä»¥ä¸‹èŠå¤©è®°å½•ç”Ÿæˆä¸€ä¸ªç®€æ´çš„æ‘˜è¦ï¼ˆ50å­—ä»¥å†…ï¼‰ï¼š
${(char.èŠå¤©è®°å½• || [])
  .filter(msg => msg && msg.role && msg.content)
  .slice(-10)
  .map(msg => `${msg.role === 'user' ? 'ä½ ' : char.å§“å}: ${msg.content}`)
  .join('\n')}

åªè¾“å‡ºæ‘˜è¦ã€‚`;
              try {
                const summaryResponse = await sendCommandToAI(summaryCommand, true);
                if (summaryResponse) {
                  char.èŠå¤©æ‘˜è¦ = filterHtmlFromStory(summaryResponse).trim();
                }
              } catch (e) {
                console.warn('ç”ŸæˆèŠå¤©æ‘˜è¦å¤±è´¥:', e);
              }
              advanceRound();
            }

            saveGameStateToMVU();
            updateChatUI(characterId);
          } else {
            // AIæ²¡æœ‰è¿”å›æœ‰æ•ˆå›å¤
            if (typeof toastr !== 'undefined') {
              toastr.error('AIæœªè¿”å›æœ‰æ•ˆå›å¤ï¼Œè¯·é‡è¯•');
            } else {
              alert('AIæœªè¿”å›æœ‰æ•ˆå›å¤ï¼Œè¯·é‡è¯•');
            }
          }
        } catch (error) {
          console.error('å‘é€èŠå¤©åŠ¨ä½œå¤±è´¥:', error);
          if (typeof toastr !== 'undefined') {
            toastr.error(`å‘é€å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
          } else {
            alert(`å‘é€å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
          }
        }
      }

      function updateChatUI(characterId) {
        const char = gameState.è§’è‰²ä»“åº“[characterId];
        if (!char) return;

        const container = document.getElementById('chat-messages-container');
        const counter = document.querySelector('#chat-interface-modal [style*="èŠå¤©æ¬¡æ•°"]');

        if (container) {
          container.innerHTML =
            char.èŠå¤©è®°å½•.length === 0
              ? '<div style="text-align: center; color: var(--text-secondary); padding: 40px">å¼€å§‹ä¸è§’è‰²èŠå¤©å§ï¼</div>'
              : char.èŠå¤©è®°å½•
                  .map(
                    msg => `
                <div style="padding: 12px; background: ${msg.role === 'user' ? 'rgba(139, 92, 246, 0.2)' : 'rgba(255,255,255,0.05)'}; border-radius: 8px; border-left: 3px solid ${msg.role === 'user' ? 'var(--primary)' : 'var(--accent-gold)'}">
                  <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px">${msg.role === 'user' ? 'ä½ ' : char.å§“å}</div>
                  <div style="white-space: pre-wrap; word-wrap: break-word; line-height: 1.6">${msg.content}</div>
                  ${msg.attrChanges ? `<div style="margin-top: 8px; font-size: 11px; color: var(--accent-gold)">ã€å±æ€§å˜åŒ–ã€‘${msg.attrChanges}</div>` : ''}
                </div>
              `,
                  )
                  .join('');
          container.scrollTop = container.scrollHeight;
        }

        if (counter) {
          counter.textContent = `èŠå¤©æ¬¡æ•°ï¼š${char.èŠå¤©æ¬¡æ•° || 0}/5ï¼ˆ5æ¬¡èŠå¤©=1å›åˆï¼‰`;
        }
      }

      async function startInteraction(characterId, interactionType, customCommand = '') {
        const char = gameState.è§’è‰²ä»“åº“[characterId];
        if (!char) return;
        normalizeCharacter(char);
        const prevLike = char.å¥½æ„Ÿåº¦ || 0;
        const prevHate = char.æ¨æ„ || 0;
        // è®°å½•å±æ€§åˆå§‹å€¼
        const prevAttrs = {
          é­…åŠ›: char.å±æ€§?.é­…åŠ› || 0,
          é¡ºä»: char.å±æ€§?.é¡ºä» || 0,
          æŠ€å·§: char.å±æ€§?.æŠ€å·§ || 0,
          è€åŠ›: char.å±æ€§?.è€åŠ› || 0,
          æ•æ„Ÿåº¦: char.å±æ€§?.æ•æ„Ÿåº¦ || 0,
        };

        const storyContent = document.getElementById(`story-content-${characterId}`);
        if (storyContent) {
          storyContent.innerHTML = '<div class="story-loading">â³ AI æ­£åœ¨ç”Ÿæˆå‰§æƒ…ï¼Œè¯·ç¨å€™...</div>';
        }

        // å‰§æƒ…ç”Ÿæˆé€šç”¨å‰ç¼€ï¼ˆå¼ºè°ƒä¸è¦ç”ŸæˆHTML/ä»£ç ï¼›æ€ç»´é“¾ä¸€å¾‹ä¸è¾“å‡ºï¼‰
        const storyPrefix = `ã€å‰§æƒ…ç”Ÿæˆæ¨¡å¼ã€‘è¿™æ˜¯çº¯æ–‡æœ¬å‰§æƒ…ç”Ÿæˆï¼Œä¸æ˜¯è§’è‰²å¡ç”Ÿæˆã€‚
ç»å¯¹ç¦æ­¢ï¼š
- ä¸è¦è¾“å‡ºä»»ä½•HTMLä»£ç ï¼ˆä¸è¦<style>ã€<div>ã€<script>ç­‰æ ‡ç­¾ï¼‰
- ä¸è¦è¾“å‡ºä»£ç å—ï¼ˆä¸è¦\`\`\`ï¼‰
- ä¸è¦è¾“å‡ºè§’è‰²å¡ç•Œé¢
- ä¸è¦è¾“å‡º<think>...</think>æˆ–<analysis>...</analysis>ï¼ˆæ€ç»´é“¾ä¸€å¾‹ä¸è¾“å‡ºï¼‰

åªè¾“å‡ºï¼šçº¯æ–‡æœ¬å‰§æƒ… + <JSONPatch>æ›´æ–°</JSONPatch>

`;
        let command = '';
        switch (interactionType) {
          case 'è°ƒæ•™':
            if (customCommand) {
              command =
                storyPrefix +
                `è°ƒæ•™è§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰ã€‚æ ¹æ®ä»¥ä¸‹æŒ‡ä»¤è¿›è¡Œè°ƒæ•™ï¼š\n\n${customCommand}\n\nè¯·ç”Ÿæˆè¯¦ç»†çš„è°ƒæ•™å‰§æƒ…ï¼ŒåŒ…æ‹¬è¿‡ç¨‹ã€è§’è‰²ååº”ã€çŠ¶æ€å˜åŒ–ç­‰ã€‚`;
            } else {
              command =
                storyPrefix +
                `è°ƒæ•™è§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰ã€‚è¯·ç”Ÿæˆè¯¦ç»†çš„è°ƒæ•™å‰§æƒ…ï¼ŒåŒ…æ‹¬è¿‡ç¨‹ã€è§’è‰²ååº”ã€çŠ¶æ€å˜åŒ–ç­‰ã€‚`;
            }

            command += `\n\nè°ƒæ•™å†…å®¹å¯ä»¥åŒ…æ‹¬ï¼š
- è°ƒæ•™è¿‡ç¨‹æè¿°ï¼ˆå·¥å…·ã€æ–¹æ³•ã€æ­¥éª¤ç­‰ï¼‰
- è§’è‰²çš„èº«ä½“ååº”å’Œå¿ƒç†å˜åŒ–
- è§’è‰²å±æ€§çš„å˜åŒ–ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ç­‰ï¼‰
- è§’è‰²æƒ…æ„ŸçŠ¶æ€çš„å˜åŒ–
- è°ƒæ•™åçš„çŠ¶æ€å’Œæ•ˆæœ

å¿…é¡»ä½¿ç”¨JSONPatchæ ¼å¼æ›´æ–°è§’è‰²å±æ€§ï¼Œè·¯å¾„æ ¼å¼ï¼šè§’è‰²ä»“åº“/${characterId}/å±æ€§/é­…åŠ› ç­‰`;
            break;
          case 'å¯¹è¯':
            command =
              storyPrefix +
              `ä¸è§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰è¿›è¡Œå¯¹è¯äº’åŠ¨ã€‚è¯·ç”Ÿæˆå¯¹è¯å†…å®¹å’Œè§’è‰²ååº”ã€‚

å¦‚æœéœ€è¦æ›´æ–°è§’è‰²çŠ¶æ€ï¼Œè¯·ä½¿ç”¨JSONPatchæ ¼å¼ã€‚`;
            break;
          case 'ç‰¹æ®Šäº’åŠ¨':
            command =
              storyPrefix +
              `ä¸è§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰è¿›è¡Œç‰¹æ®Šäº’åŠ¨ã€‚è¯·æ ¹æ®è§’è‰²å½“å‰çŠ¶æ€ç”Ÿæˆåˆé€‚çš„äº’åŠ¨å‰§æƒ…ã€‚

å¦‚æœéœ€è¦æ›´æ–°è§’è‰²çŠ¶æ€ï¼Œè¯·ä½¿ç”¨JSONPatchæ ¼å¼ã€‚`;
            break;
          case 'æƒ©ç½š':
            command =
              storyPrefix +
              `æƒ©ç½šè§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰ã€‚è¯·ç”Ÿæˆè¯¦ç»†çš„æƒ©ç½šå‰§æƒ…ï¼ŒåŒ…æ‹¬ï¼š
- æƒ©ç½šè¿‡ç¨‹æè¿°ï¼ˆæ–¹æ³•ã€å·¥å…·ã€å¼ºåº¦ç­‰ï¼‰
- è§’è‰²çš„èº«ä½“ååº”å’Œå¿ƒç†å˜åŒ–
- è§’è‰²å±æ€§çš„å˜åŒ–ï¼ˆè€åŠ›-3~10, é¡ºä»Â±5~15å–å†³äºåæŠ—ç¨‹åº¦ï¼‰
- è§’è‰²æƒ…æ„ŸçŠ¶æ€çš„å˜åŒ–

å¿…é¡»ä½¿ç”¨JSONPatchæ ¼å¼æ›´æ–°è§’è‰²å±æ€§ï¼Œè·¯å¾„æ ¼å¼ï¼šè§’è‰²ä»“åº“/${characterId}/å±æ€§/è€åŠ› ç­‰`;
            break;
          case 'å¥–åŠ±':
            command =
              storyPrefix +
              `å¥–åŠ±è§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰ã€‚è¯·ç”Ÿæˆè¯¦ç»†çš„å¥–åŠ±å‰§æƒ…ï¼ŒåŒ…æ‹¬ï¼š
- å¥–åŠ±å†…å®¹æè¿°ï¼ˆç¤¼ç‰©ã€ç‰¹æƒã€å…³æ€€ç­‰ï¼‰
- è§’è‰²çš„ååº”å’Œæƒ…ç»ªå˜åŒ–
- è§’è‰²å±æ€§çš„å˜åŒ–

å¿…é¡»ä½¿ç”¨JSONPatchæ ¼å¼æ›´æ–°è§’è‰²å±æ€§ï¼Œè·¯å¾„æ ¼å¼ï¼šè§’è‰²ä»“åº“/${characterId}/å±æ€§/é­…åŠ› ç­‰`;
            break;
          default:
            command = storyPrefix + `ä¸è§’è‰²${characterId}ï¼ˆ${char.å§“å}ï¼‰è¿›è¡Œ${interactionType}äº’åŠ¨ã€‚`;
        }

        // éâ€œè°ƒæ•™â€ä¹Ÿå…è®¸é™„åŠ æŒ‡ä»¤ï¼ˆç”¨äºç‰¹æ®Šå‰§æƒ…ç­‰ï¼‰
        if (customCommand && interactionType !== 'è°ƒæ•™') {
          command += `\n\né™„åŠ æŒ‡ä»¤ï¼š\n${customCommand}`;
        }

        try {
          // skipAutoRound=trueï¼Œå› ä¸ºæˆ‘ä»¬ä¼šè‡ªå·±å¤„ç†å“åº”å’Œæ¨è¿›å›åˆ
          const response = await sendCommandToAI(command, true);

          if (response && storyContent) {
            let storyText = response;
            const jsonPatchMatch = storyText.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/);
            if (jsonPatchMatch) {
              try {
                const patches = JSON.parse(cleanJsonString(jsonPatchMatch[1]));
                applyJSONPatches(patches);
              } catch (error) {
                console.error('è§£æ JSON Patch å¤±è´¥:', error);
              }
              storyText = storyText.replace(/<JSONPatch>[\s\S]*?<\/JSONPatch>/, '').trim();
            }
            storyText = storyText.replace(/<UpdateVariable>[\s\S]*?<\/UpdateVariable>/, '').trim();
            storyText = storyText.replace(/<Analysis>[\s\S]*?<\/Analysis>/, '').trim();

            // è¿‡æ»¤æ‰AIé”™è¯¯è¾“å‡ºçš„HTMLä»£ç 
            storyText = filterHtmlFromStory(storyText);

            // è‹¥AIæœªæ›´æ–°å¥½æ„Ÿ/æ¨æ„ï¼šæŒ‰äº’åŠ¨ç±»å‹ç»™ä¸€ä¸ªå¾ˆå°çš„"ä¿åº•æ³¢åŠ¨"ï¼Œè®©å…³ç³»ç³»ç»Ÿæœ‰æŒç»­è¿›å±•
            normalizeCharacter(char);
            if ((char.å¥½æ„Ÿåº¦ || 0) === prevLike && (char.æ¨æ„ || 0) === prevHate) {
              if (interactionType === 'å¥–åŠ±') char.å¥½æ„Ÿåº¦ = clampNumber((char.å¥½æ„Ÿåº¦ || 0) + randInt(2, 4), 0, 100);
              else if (interactionType === 'æƒ©ç½š') char.æ¨æ„ = clampNumber((char.æ¨æ„ || 0) + randInt(2, 4), 0, 100);
              else if (interactionType === 'å¯¹è¯') char.å¥½æ„Ÿåº¦ = clampNumber((char.å¥½æ„Ÿåº¦ || 0) + 1, 0, 100);
              else if (interactionType === 'è°ƒæ•™') {
                // è°ƒæ•™ï¼šå¯èƒ½æ›´æš§æ˜§ä¹Ÿå¯èƒ½æ›´å¯¹æŠ—ï¼Œç»™ä¸€ä¸ªæ¸©å’Œéšæœº
                if (rand01() < 0.55) char.å¥½æ„Ÿåº¦ = clampNumber((char.å¥½æ„Ÿåº¦ || 0) + 1, 0, 100);
                else char.æ¨æ„ = clampNumber((char.æ¨æ„ || 0) + 1, 0, 100);
              }
              char.å…³ç³»é˜¶æ®µ = computeRelationshipStage(char.å¥½æ„Ÿåº¦, char.æ¨æ„);
              saveGameStateToMVU();
            }

            // ä½¿ç”¨ formatAsDisplayedMessage é¿å…è¢«ç¾åŒ–æ æ­£åˆ™æ›¿æ¢
            if (typeof formatAsDisplayedMessage !== 'undefined') {
              storyText = formatAsDisplayedMessage(storyText);
            }

            // å¦‚æœæ˜¯ç‰¹æ®Šå‰§æƒ…ï¼šä¿å­˜åˆ°æ¡£æ¡ˆ
            if (window._lastSpecialScene && window._lastSpecialScene.characterId === characterId) {
              const key = window._lastSpecialScene.sceneKey;
              char.å‰§æƒ…æ¡£æ¡ˆ = char.å‰§æƒ…æ¡£æ¡ˆ || {};
              char.å‰§æƒ…æ¡£æ¡ˆ[key] = storyText;
              window._lastSpecialScene = null;
              saveGameStateToMVU();
            }

            // è®¡ç®—å±æ€§å˜åŒ–å¹¶æ˜¾ç¤º
            normalizeCharacter(char);
            const attrChanges = [];
            const newAttrs = {
              é­…åŠ›: char.å±æ€§?.é­…åŠ› || 0,
              é¡ºä»: char.å±æ€§?.é¡ºä» || 0,
              æŠ€å·§: char.å±æ€§?.æŠ€å·§ || 0,
              è€åŠ›: char.å±æ€§?.è€åŠ› || 0,
              æ•æ„Ÿåº¦: char.å±æ€§?.æ•æ„Ÿåº¦ || 0,
            };
            ['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦'].forEach(stat => {
              const delta = newAttrs[stat] - prevAttrs[stat];
              if (delta !== 0) {
                attrChanges.push(`${stat} ${delta > 0 ? '+' : ''}${delta}`);
              }
            });
            const likeDelta = (char.å¥½æ„Ÿåº¦ || 0) - prevLike;
            const hateDelta = (char.æ¨æ„ || 0) - prevHate;
            if (likeDelta !== 0) attrChanges.push(`å¥½æ„Ÿåº¦ ${likeDelta > 0 ? '+' : ''}${likeDelta}`);
            if (hateDelta !== 0) attrChanges.push(`æ¨æ„ ${hateDelta > 0 ? '+' : ''}${hateDelta}`);

            // å¦‚æœæœ‰å±æ€§å˜åŒ–ï¼Œè¿½åŠ åˆ°å‰§æƒ…æ–‡æœ¬æœ«å°¾
            if (attrChanges.length > 0) {
              storyText += `\n\nã€å±æ€§å˜åŒ–ã€‘${attrChanges.join('ï¼Œ')}`;
            }

            // è‡ªåŠ¨é…å›¾ + æ˜¾ç¤º
            renderStoryWithAutoImage(storyContent, storyText, characterId, {
              scene: interactionType,
              roomType: 'äº’åŠ¨',
            });

            // å…³ç³»è§¦å‘æ£€æµ‹
            checkRelationshipTriggers(characterId, interactionType);

            // AIç”Ÿæˆå†…å®¹å®Œæˆåï¼Œè‡ªåŠ¨æ¨è¿›ä¸€å›åˆ
            advanceRound();
          }
        } catch (error) {
          console.error('ç”Ÿæˆå‰§æƒ…å¤±è´¥:', error);
          if (storyContent) {
            storyContent.innerHTML =
              '<div class="story-placeholder" style="color: var(--danger)">ç”Ÿæˆå‰§æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>';
          }
        }
      }

      function copyImagePrompt(prompt) {
        navigator.clipboard.writeText(prompt).then(() => {
          alert('ç»˜ç”»æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        });
      }

      // ==================== å‰§æƒ…æ–‡æœ¬è¿‡æ»¤ ====================
      // å½»åº•è¿‡æ»¤AIé”™è¯¯è¾“å‡ºçš„HTMLä»£ç ï¼Œåªä¿ç•™çº¯æ–‡æœ¬å‰§æƒ…
      function filterHtmlFromStory(text) {
        if (!text || typeof text !== 'string') return '';

        let cleaned = text;

        // 0.0 ä¼˜å…ˆæå– <æ­£æ–‡>ï¼ˆæŸäº›é¢„è®¾ä¼šå¼ºåˆ¶è¦æ±‚è¿™ä¸ªæ ‡ç­¾ï¼‰
        const zhengwenMatchAny = cleaned.match(/<æ­£æ–‡>([\s\S]*?)<\/æ­£æ–‡>/);
        if (zhengwenMatchAny && zhengwenMatchAny[1].trim().length > 0) {
          cleaned = zhengwenMatchAny[1].trim();
        }

        // 0.1 ç§»é™¤æ€ç»´é“¾ï¼ˆä¸å¯¹ç”¨æˆ·å±•ç¤ºï¼‰
        cleaned = cleaned.replace(/<think[^>]*>[\s\S]*?<\/think>/gi, '');
        cleaned = cleaned.replace(/<analysis[^>]*>[\s\S]*?<\/analysis>/gi, '');
        // å…¼å®¹ï¼šæœªé—­åˆçš„ think/analysis
        cleaned = cleaned.replace(/<think[^>]*>[\s\S]*$/gi, '');
        cleaned = cleaned.replace(/<analysis[^>]*>[\s\S]*$/gi, '');

        // 0.2 ç§»é™¤æ‘˜è¦å—
        cleaned = cleaned.replace(/<summary[^>]*>[\s\S]*?<\/summary>/gi, '');

        // 0. é¦–å…ˆæ£€æµ‹æ˜¯å¦æ˜¯å®Œæ•´çš„HTMLæ–‡æ¡£ï¼ˆAIé”™è¯¯è¾“å‡ºï¼‰
        if (cleaned.includes('<!DOCTYPE') || cleaned.includes('<html') || cleaned.includes('<head>')) {
          // å°è¯•ä»HTMLä¸­æå–çº¯æ–‡æœ¬å†…å®¹
          // æ–¹æ³•1: å¦‚æœæœ‰<æ­£æ–‡>æ ‡ç­¾ï¼Œä¼˜å…ˆæå–
          const zhengwenMatch = cleaned.match(/<æ­£æ–‡>([\s\S]*?)<\/æ­£æ–‡>/);
          if (zhengwenMatch && zhengwenMatch[1].trim().length > 50) {
            cleaned = zhengwenMatch[1].trim();
          } else {
            // æ–¹æ³•2: ç§»é™¤æ‰€æœ‰HTMLæ ‡ç­¾ï¼Œåªä¿ç•™æ–‡æœ¬
            cleaned = cleaned.replace(/<script[\s\S]*?<\/script>/gi, '');
            cleaned = cleaned.replace(/<style[\s\S]*?<\/style>/gi, '');
            cleaned = cleaned.replace(/<head[\s\S]*?<\/head>/gi, '');
            // ç§»é™¤æ‰€æœ‰HTMLæ ‡ç­¾ä½†ä¿ç•™å†…å®¹
            cleaned = cleaned.replace(/<[^>]+>/g, '');
            // è§£ç HTMLå®ä½“
            cleaned = cleaned.replace(/&nbsp;/gi, ' ');
            cleaned = cleaned.replace(/&lt;/gi, '<');
            cleaned = cleaned.replace(/&gt;/gi, '>');
            cleaned = cleaned.replace(/&amp;/gi, '&');
            cleaned = cleaned.replace(/&quot;/gi, '"');
          }
        }

        // 1. ç§»é™¤æ®‹ç•™çš„HTMLæ ‡ç­¾
        cleaned = cleaned.replace(/<!DOCTYPE[^>]*>/gi, '');
        cleaned = cleaned.replace(/<\/?html[^>]*>/gi, '');
        cleaned = cleaned.replace(/<\/?head[^>]*>/gi, '');
        cleaned = cleaned.replace(/<\/?body[^>]*>/gi, '');
        cleaned = cleaned.replace(/<meta[^>]*\/?>/gi, '');
        cleaned = cleaned.replace(/<link[^>]*\/?>/gi, '');
        cleaned = cleaned.replace(/<title[^>]*>[\s\S]*?<\/title>/gi, '');

        // 2. ç§»é™¤scriptå’Œstyleæ ‡ç­¾åŠå…¶å†…å®¹
        cleaned = cleaned.replace(/<script[\s\S]*?<\/script>/gi, '');
        cleaned = cleaned.replace(/<style[\s\S]*?<\/style>/gi, '');

        // 3. ç§»é™¤å¤æ‚çš„div/sectionç»“æ„
        // å¤šæ¬¡æ‰§è¡Œä»¥å¤„ç†åµŒå¥—ç»“æ„
        for (let i = 0; i < 5; i++) {
          cleaned = cleaned.replace(/<div[^>]*>|<\/div>/gi, '');
          cleaned = cleaned.replace(/<section[^>]*>|<\/section>/gi, '');
          cleaned = cleaned.replace(/<span[^>]*>|<\/span>/gi, '');
          cleaned = cleaned.replace(/<p[^>]*>|<\/p>/gi, '\n');
          cleaned = cleaned.replace(/<br\s*\/?>/gi, '\n');
        }

        // 4. ç§»é™¤ä»£ç å—
        cleaned = cleaned.replace(/```[\s\S]*?```/g, '');

        // 5. ç§»é™¤çŠ¶æ€æ æ ¼å¼ï¼ˆ/.*/s æ ¼å¼ï¼‰ä½†ä¿ç•™é…’é¦†å¯èƒ½ç”¨äºéšè—æ€ç»´é“¾çš„æ ‡ç­¾
        // æ³¨æ„ï¼šä¸ç§»é™¤ <Analysis>...</Analysis> ç­‰æ ‡ç­¾ï¼Œè®©é…’é¦†è‡ªå·±å¤„ç†

        // 6. æ¸…ç†å¤šä½™ç©ºç™½
        cleaned = cleaned.replace(/\n{4,}/g, '\n\n');
        cleaned = cleaned.replace(/[ \t]{2,}/g, ' ');
        cleaned = cleaned.trim();

        // 6.1 äºŒæ¬¡é˜²çº¿ï¼šè‹¥ä»åƒâ€œæºç /è„šæœ¬â€ï¼Œåˆ æ‰æ˜æ˜¾çš„ä»£ç è¡Œï¼ˆé¿å…æŠŠæ•´é¡µè„šæœ¬å½“å‰§æƒ…æ˜¾ç¤ºï¼‰
        if (/(<!DOCTYPE|<html|<head|<\/script>|<\/style>|\bfunction\b|\bconst\b|\blet\b|\bvar\b|=>)/i.test(cleaned)) {
          cleaned = cleaned
            .replace(/^\s*(const|let|var)\b.*$/gm, '')
            .replace(/^\s*function\b.*$/gm, '')
            .replace(/^\s*(if|for|while|switch)\s*\(.*$/gm, '')
            .replace(/^\s*[{}();]+\s*$/gm, '')
            .replace(/^\s*<\/?[a-z][^>]*>\s*$/gim, '')
            .trim();
        }

        // 7. å¦‚æœæ¸…ç†åæ–‡æœ¬å¤ªçŸ­ï¼Œè¿”å›æç¤º
        if (cleaned.length < 20 && text.length > 100) {
          console.warn('filterHtmlFromStory: è¿‡æ»¤åæ–‡æœ¬å¤ªçŸ­ï¼Œå¯èƒ½AIè¾“å‡ºäº†çº¯HTML');
          // æœ€åå°è¯•ï¼šç§»é™¤æ‰€æœ‰æ ‡ç­¾
          let fallback = text.replace(/<[^>]+>/g, ' ');
          fallback = fallback.replace(/\s+/g, ' ').trim();
          if (fallback.length > cleaned.length) {
            cleaned = fallback;
          }
        }

        return cleaned;
      }

      // ==================== è§’è‰²å¤–è²Œæç¤ºè¯ / è‡ªåŠ¨é…å›¾ / å…³ç³»ç³»ç»Ÿ ====================
      function clampNumber(n, min, max) {
        const v = Number.isFinite(n) ? n : min;
        return Math.max(min, Math.min(max, v));
      }

      function extractAllImagePrompts(text) {
        if (!text || typeof text !== 'string') return [];
        const matches = [...text.matchAll(/image###([\s\S]*?)###/g)];
        return matches.map(m => (m?.[1] || '').trim()).filter(Boolean);
      }

      function normalizePromptText(prompt) {
        if (!prompt) return '';
        return prompt
          .replace(/\s+/g, ' ')
          .replace(/\s*,\s*/g, ', ')
          .trim();
      }

      // ä»åŒåˆ†é•œæç¤ºè¯ä¸­æå–çº¯å¤–è²Œéƒ¨åˆ†ï¼ˆå»é™¤åœºæ™¯ã€åŠ¨ä½œã€å§¿åŠ¿ç­‰å˜é‡ï¼‰
      function extractAppearanceOnly(prompt) {
        if (!prompt || typeof prompt !== 'string') return '';

        // å»é™¤åˆ†é•œç›¸å…³æ ‡ç­¾
        let cleaned = prompt
          .replace(/\{split image\}/gi, '')
          .replace(/\{two panels\}/gi, '')
          .replace(/\{consistent character\}/gi, '')
          .replace(/\{consistent physique\}/gi, '')
          .replace(/\{1man[^}]*\}/gi, '')
          .replace(/\{1girl[^}]*\}/gi, '')
          .replace(/\{2girls[^}]*\}/gi, '')
          .replace(/\{solo[^}]*\}/gi, '');

        // éœ€è¦ä¿ç•™çš„å¤–è²Œæ ‡ç­¾ï¼ˆä¸å˜é‡ï¼‰
        const appearanceKeywords = [
          // ä½“å‹èº«æ
          'tall',
          'short',
          'petite',
          'slim',
          'curvy',
          'athletic',
          'muscular',
          'plump',
          'thin',
          'hourglass',
          'flat chest',
          'small breasts',
          'medium breasts',
          'large breasts',
          'huge breasts',
          'wide hips',
          'narrow waist',
          'long legs',
          'short legs',
          // è‚¤è‰²
          'pale skin',
          'tan skin',
          'dark skin',
          'fair skin',
          'olive skin',
          'white skin',
          // å‘è‰²å‘å‹
          'hair',
          'long hair',
          'short hair',
          'medium hair',
          'curly hair',
          'straight hair',
          'wavy hair',
          'blonde',
          'brunette',
          'black hair',
          'brown hair',
          'red hair',
          'silver hair',
          'white hair',
          'blue hair',
          'green hair',
          'pink hair',
          'purple hair',
          'orange hair',
          'gray hair',
          'ponytail',
          'twintails',
          'braid',
          'bob cut',
          'bangs',
          'sidecut',
          // çœ¼ç›
          'eyes',
          'eye color',
          'blue eyes',
          'green eyes',
          'brown eyes',
          'black eyes',
          'red eyes',
          'purple eyes',
          'golden eyes',
          'heterochromia',
          'large eyes',
          'small eyes',
          // é¢éƒ¨ç‰¹å¾
          'face',
          'round face',
          'oval face',
          'sharp features',
          'soft features',
          'pointed chin',
          'small nose',
          'button nose',
          'high cheekbones',
          'dimples',
          'freckles',
          // æœè£…åŸºç¡€ï¼ˆé£æ ¼ã€é¢œè‰²ã€æè´¨ï¼Œä½†ä¸åŒ…æ‹¬å…·ä½“åŠ¨ä½œï¼‰
          'dress',
          'skirt',
          'shirt',
          'pants',
          'jacket',
          'coat',
          'uniform',
          'kimono',
          'robe',
          'silk',
          'cotton',
          'leather',
          'lace',
          'velvet',
          'satin',
          'red',
          'blue',
          'green',
          'black',
          'white',
          'purple',
          'pink',
          'yellow',
          'orange',
          // ç§æ—ç‰¹å¾
          'elf',
          'human',
          'demon',
          'angel',
          'vampire',
          'werewolf',
          'fairy',
          'dragon',
          'pointed ears',
          'horns',
          'wings',
          'tail',
          'fangs',
          'claws',
          // ç‰¹æ®Šæ ‡è®°
          'tattoo',
          'scar',
          'birthmark',
          'mole',
          'piercing',
          // åŸºç¡€è´¨é‡æ ‡ç­¾
          'masterpiece',
          'best quality',
          'high quality',
          'detailed',
          '8k',
          '4k',
        ];

        // æå–åŒ…å«å¤–è²Œå…³é”®è¯çš„æ ‡ç­¾
        const tags = cleaned
          .split(',')
          .map(t => t.trim())
          .filter(Boolean);
        const appearanceTags = tags.filter(tag => {
          const lowerTag = tag.toLowerCase();
          // ä¿ç•™åŒ…å«å¤–è²Œå…³é”®è¯çš„æ ‡ç­¾
          if (appearanceKeywords.some(keyword => lowerTag.includes(keyword))) {
            return true;
          }
          // ä¿ç•™çœ‹èµ·æ¥åƒå¤–è²Œæè¿°çš„æ ‡ç­¾ï¼ˆä¸åŒ…å«åŠ¨ä½œã€è¡¨æƒ…ã€åœºæ™¯è¯ï¼‰
          const excludeWords = [
            'smile',
            'cry',
            'laugh',
            'angry',
            'sad',
            'happy',
            'expression',
            'sitting',
            'standing',
            'lying',
            'kneeling',
            'pose',
            'action',
            'background',
            'indoor',
            'outdoor',
            'room',
            'bed',
            'chair',
            'table',
            'lighting',
            'sunlight',
            'moonlight',
            'candlelight',
            'dark',
            'bright',
            'nude',
            'naked',
            'clothed',
            'undressing',
            'sex',
            'nsfw',
            'erotic',
            'rape',
            'bondage',
            'bdsm',
            'tied',
            'gag',
            'whip',
            'toy',
          ];
          if (excludeWords.some(word => lowerTag.includes(word))) {
            return false;
          }
          // å¦‚æœæ ‡ç­¾å¾ˆçŸ­ä¸”ä¸åŒ…å«å¸¸è§åŠ¨ä½œè¯ï¼Œå¯èƒ½æ˜¯å¤–è²Œæè¿°
          if (tag.length < 30 && !/[(){}]/.test(tag)) {
            return true;
          }
          return false;
        });

        return normalizePromptText(appearanceTags.join(', '));
      }

      function ensureCharacterPrompts(char) {
        if (!char || typeof char !== 'object') return;

        // å¦‚æœå·²ç»æœ‰è¶³å¤Ÿè¯¦ç»†çš„å¤–è²Œæç¤ºè¯ï¼ˆAIç›´æ¥ç”Ÿæˆçš„ï¼‰ï¼Œç›´æ¥ä½¿ç”¨
        if (typeof char.å¤–è²Œæç¤ºè¯ === 'string' && char.å¤–è²Œæç¤ºè¯.trim().length > 50) {
          const prompt = char.å¤–è²Œæç¤ºè¯.trim();
          // æ£€æŸ¥æ˜¯å¦åŒ…å«å¸¸è§è‹±æ–‡å…³é”®è¯
          if (/\b(hair|eyes|skin|face|tall|petite|slim|man|girl|person)\b/i.test(prompt)) {
            if (!char.å¤–è²Œæç¤ºè¯_NSFW) char.å¤–è²Œæç¤ºè¯_NSFW = char.å¤–è²Œæç¤ºè¯;
            return;
          }
        }

        // å°è¯•ä»ç»˜å›¾æ ‡ç­¾ä¸­æå–
        const fromTags = extractAllImagePrompts(char.ç»˜å›¾æ ‡ç­¾ || '');
        if (fromTags.length > 0) {
          const fullPrompt = fromTags.join(', ');
          char.å¤–è²Œæç¤ºè¯ = extractAppearanceOnly(fullPrompt);

          if (fromTags.length > 1) {
            const nsfwAppearance = extractAppearanceOnly(fromTags[fromTags.length - 1]);
            if (nsfwAppearance && nsfwAppearance !== char.å¤–è²Œæç¤ºè¯) {
              const combined = `${char.å¤–è²Œæç¤ºè¯}, ${nsfwAppearance}`;
              const uniqueTags = [...new Set(combined.split(',').map(t => t.trim()))];
              char.å¤–è²Œæç¤ºè¯_NSFW = normalizePromptText(uniqueTags.join(', '));
            } else {
              char.å¤–è²Œæç¤ºè¯_NSFW = char.å¤–è²Œæç¤ºè¯;
            }
          } else {
            char.å¤–è²Œæç¤ºè¯_NSFW = char.å¤–è²Œæç¤ºè¯;
          }

          if (char.å¤–è²Œæç¤ºè¯ && char.å¤–è²Œæç¤ºè¯.length > 50) return;
        }

        // fallbackï¼šä»ä¸­æ–‡å¤–è²Œç‰¹ç‚¹ç”Ÿæˆè¯¦ç»†çš„è‹±æ–‡æ ‡ç­¾
        const promptParts = [];
        const gender = char.æ€§åˆ« || '';
        const appearance = char.å¤–è²Œç‰¹ç‚¹ || '';

        // 1. æ€§åˆ«ä¸æ°”è´¨
        if (gender.includes('ç”·') || gender.toLowerCase().includes('male')) {
          promptParts.push('1man', 'male', 'masculine');
        } else if (gender.includes('å¥³') || gender.toLowerCase().includes('female')) {
          promptParts.push('1girl', 'female', 'feminine');
        } else if (gender.includes('åŒæ€§')) {
          promptParts.push('1man', 'androgynous', 'femboy', 'feminine male');
        } else {
          promptParts.push('1person');
        }

        // 2. å¹´é¾„æ®µ
        if (
          appearance.includes('å¹´è½»') ||
          appearance.includes('é’å¹´') ||
          appearance.includes('å°‘å¹´') ||
          appearance.includes('å°‘å¥³')
        ) {
          promptParts.push('young adult', 'youthful');
        } else if (appearance.includes('æˆç†Ÿ') || appearance.includes('å¦©åªš')) {
          promptParts.push('mature', 'adult');
        } else {
          promptParts.push('young adult');
        }

        // 3. æ•´ä½“æ°”è´¨
        if (appearance.includes('ä¼˜é›…') || appearance.includes('é«˜è´µ')) promptParts.push('elegant', 'noble');
        else if (appearance.includes('å¯çˆ±') || appearance.includes('èŒ')) promptParts.push('cute', 'adorable');
        else if (appearance.includes('å†·è‰³') || appearance.includes('é«˜å†·')) promptParts.push('cool', 'aloof');
        else if (appearance.includes('å¦–è‰³') || appearance.includes('é­…æƒ‘')) promptParts.push('seductive', 'alluring');
        else if (appearance.includes('æ¸…çº¯') || appearance.includes('çº¯çœŸ')) promptParts.push('innocent', 'pure');
        else if (appearance.includes('é‡æ€§') || appearance.includes('ç‹‚é‡')) promptParts.push('wild', 'fierce');
        else if (appearance.includes('ç¥ç§˜')) promptParts.push('mysterious');
        else promptParts.push('beautiful', 'attractive');

        // 4. é¢éƒ¨ç»“æ„
        if (appearance.includes('ç“œå­è„¸') || appearance.includes('å°–ä¸‹å·´'))
          promptParts.push('oval face', 'pointed chin');
        else if (appearance.includes('åœ†è„¸')) promptParts.push('round face');
        else if (appearance.includes('æ–¹è„¸') || appearance.includes('æ£±è§’'))
          promptParts.push('angular face', 'defined jawline');
        else promptParts.push('delicate face');

        // 5. çœ¼å‹ä¸ç³è‰²
        if (appearance.includes('ç‹ç‹¸çœ¼') || appearance.includes('å‡¤çœ¼')) promptParts.push('fox eyes', 'upturned eyes');
        else if (appearance.includes('æçœ¼')) promptParts.push('almond eyes');
        else if (appearance.includes('åœ†çœ¼') || appearance.includes('å¤§çœ¼'))
          promptParts.push('round eyes', 'large eyes');
        else if (appearance.includes('ç»†é•¿') || appearance.includes('ç‹­é•¿')) promptParts.push('narrow eyes');
        else if (appearance.includes('ä¸‹å‚çœ¼')) promptParts.push('droopy eyes');
        else promptParts.push('beautiful eyes');

        if (appearance.includes('è“çœ¼') || appearance.includes('è“è‰²çœ¼') || appearance.includes('ç¢§çœ¼'))
          promptParts.push('sapphire blue eyes');
        else if (appearance.includes('çº¢çœ¼') || appearance.includes('èµ¤ç³')) promptParts.push('crimson red eyes');
        else if (appearance.includes('é‡‘çœ¼') || appearance.includes('ç¥ç€')) promptParts.push('golden amber eyes');
        else if (appearance.includes('ç»¿çœ¼') || appearance.includes('ç¿ ç»¿')) promptParts.push('emerald green eyes');
        else if (appearance.includes('ç´«çœ¼') || appearance.includes('ç´«ç³')) promptParts.push('violet purple eyes');
        else if (appearance.includes('é»‘çœ¼')) promptParts.push('dark black eyes');
        else if (appearance.includes('é“¶çœ¼')) promptParts.push('silver grey eyes');
        else if (appearance.includes('å¼‚è‰²ç³')) promptParts.push('heterochromia');

        promptParts.push('long eyelashes');

        // 6. çœ‰æ¯›ä¸å˜´å”‡
        if (appearance.includes('æŸ³çœ‰') || appearance.includes('å¼¯çœ‰')) promptParts.push('arched eyebrows');
        else if (appearance.includes('å‰‘çœ‰') || appearance.includes('æµ“çœ‰')) promptParts.push('thick eyebrows');
        else if (appearance.includes('ç»†çœ‰')) promptParts.push('thin eyebrows');

        if (appearance.includes('é«˜é¼»') || appearance.includes('æŒºé¼»')) promptParts.push('high nose bridge');
        if (appearance.includes('ä¸°å”‡') || appearance.includes('åšå”‡')) promptParts.push('plump lips');
        else if (appearance.includes('è–„å”‡') || appearance.includes('æ¨±å”‡'))
          promptParts.push('thin lips', 'cherry lips');

        // 7. å‘å‹å®Œæ•´æè¿°
        if (appearance.includes('åŠè…°') || appearance.includes('è¿‡è…°')) promptParts.push('very long hair');
        else if (appearance.includes('é•¿å‘') || appearance.includes('è¿‡è‚©')) promptParts.push('long hair');
        else if (appearance.includes('çŸ­å‘')) promptParts.push('short hair');
        else if (appearance.includes('ä¸­é•¿') || appearance.includes('é½è‚©')) promptParts.push('medium hair');

        if (appearance.includes('ç›´å‘') || appearance.includes('å‚é¡º')) promptParts.push('straight hair', 'silky hair');
        else if (appearance.includes('å·å‘') || appearance.includes('æ³¢æµª')) promptParts.push('wavy hair');
        else if (appearance.includes('è“¬æ¾')) promptParts.push('fluffy hair');

        if (appearance.includes('é½åˆ˜æµ·') || appearance.includes('å¹³åˆ˜æµ·')) promptParts.push('blunt bangs');
        else if (appearance.includes('æ–œåˆ˜æµ·') || appearance.includes('ä¾§åˆ†')) promptParts.push('side-swept bangs');
        else if (appearance.includes('ä¸­åˆ†')) promptParts.push('parted bangs');
        else if (appearance.includes('ç©ºæ°”åˆ˜æµ·')) promptParts.push('curtain bangs');
        else if (appearance.includes('éœ²é¢') || appearance.includes('æ— åˆ˜æµ·')) promptParts.push('forehead', 'no bangs');
        else if (appearance.includes('åˆ˜æµ·')) promptParts.push('bangs');

        if (appearance.includes('åŒé©¬å°¾')) promptParts.push('twintails');
        else if (appearance.includes('é©¬å°¾')) promptParts.push('ponytail');
        if (appearance.includes('åŒè¾«') || appearance.includes('éº»èŠ±è¾«')) promptParts.push('twin braids');
        else if (appearance.includes('ä¾§è¾«')) promptParts.push('side braid');
        else if (appearance.includes('è¾«å­') || appearance.includes('ç¼–å‘')) promptParts.push('braid');
        if (appearance.includes('ä¸¸å­å¤´') || appearance.includes('å‘é«»')) promptParts.push('bun');
        if (appearance.includes('å…¬ä¸»åˆ‡')) promptParts.push('hime cut');
        if (appearance.includes('åŠæ‰')) promptParts.push('half updo');

        // å‘è‰²
        if (appearance.includes('é»‘å‘') || appearance.includes('ä¹Œé»‘') || appearance.includes('å¢¨å‘'))
          promptParts.push('raven black hair');
        else if (appearance.includes('ç™½å‘') || appearance.includes('é“¶å‘') || appearance.includes('é“¶ç™½'))
          promptParts.push('white hair', 'silver hair');
        else if (appearance.includes('é‡‘å‘') || appearance.includes('æ·¡é‡‘'))
          promptParts.push('blonde hair', 'golden hair');
        else if (appearance.includes('çº¢å‘') || appearance.includes('èµ¤å‘')) promptParts.push('red hair');
        else if (appearance.includes('è“å‘') || appearance.includes('é›è“')) promptParts.push('blue hair');
        else if (appearance.includes('ç´«å‘') || appearance.includes('è–°è¡£è‰'))
          promptParts.push('purple hair', 'lavender hair');
        else if (appearance.includes('ç»¿å‘')) promptParts.push('green hair');
        else if (appearance.includes('ç²‰å‘') || appearance.includes('æ¨±ç²‰')) promptParts.push('pink hair');
        else if (appearance.includes('æ£•å‘') || appearance.includes('æ —è‰²'))
          promptParts.push('brown hair', 'chestnut hair');
        else if (appearance.includes('ç°å‘') || appearance.includes('çƒŸç°'))
          promptParts.push('grey hair', 'ash grey hair');
        if (appearance.includes('æ¸å˜') || appearance.includes('æŒ‘æŸ“'))
          promptParts.push('gradient hair', 'colored tips');

        // å‘é¥°
        if (appearance.includes('å‘å¸¦') || appearance.includes('ä¸å¸¦')) promptParts.push('hair ribbon');
        if (appearance.includes('å‘ç°ª') || appearance.includes('å‘é’—')) promptParts.push('hairpin', 'hair ornament');
        if (appearance.includes('å¤´èŠ±') || appearance.includes('èŠ±é¥°')) promptParts.push('flower in hair');
        if (appearance.includes('å‘å† ') || appearance.includes('å¤´å† ')) promptParts.push('tiara');

        // 8. è‚¤è‰²
        if (appearance.includes('ç™½çš™') || appearance.includes('è‹ç™½') || appearance.includes('é›ªç™½'))
          promptParts.push('pale skin', 'porcelain skin');
        else if (appearance.includes('å°éº¦è‰²') || appearance.includes('å¤é“œ')) promptParts.push('tan skin');
        else if (appearance.includes('é»é»‘')) promptParts.push('dark skin');
        else promptParts.push('fair skin', 'smooth skin');

        // 9. èº«æ
        if (appearance.includes('é«˜æŒ‘') || appearance.includes('é«˜å¤§') || appearance.includes('ä¿®é•¿'))
          promptParts.push('tall', 'long legs');
        else if (appearance.includes('çŸ®å°') || appearance.includes('å¨‡å°') || appearance.includes('å°å·§'))
          promptParts.push('petite', 'short');
        else promptParts.push('average height');

        if (appearance.includes('çº¤ç»†') || appearance.includes('è‹—æ¡') || appearance.includes('çªˆçª•'))
          promptParts.push('slim', 'slender');
        else if (appearance.includes('ä¸°æ»¡') || appearance.includes('ä¸°è…´') || appearance.includes('æ›²çº¿'))
          promptParts.push('curvy', 'hourglass figure');
        else if (appearance.includes('è‚Œè‚‰') || appearance.includes('å¥å£®') || appearance.includes('å¥ç¾'))
          promptParts.push('muscular', 'athletic');
        else if (appearance.includes('çº¤å¼±') || appearance.includes('æŸ”å¼±')) promptParts.push('lithe', 'delicate');

        if (appearance.includes('ç»†è…°') || appearance.includes('çº¤è…°')) promptParts.push('narrow waist', 'slim waist');

        // èƒ¸éƒ¨ï¼ˆå¦‚æœæ˜¯å¥³æ€§æˆ–åŒæ€§ï¼‰
        if (gender.includes('å¥³') || gender.includes('åŒæ€§')) {
          if (appearance.includes('å¹³èƒ¸') || appearance.includes('è´«ä¹³')) promptParts.push('flat chest');
          else if (appearance.includes('å¤§èƒ¸') || appearance.includes('å·¨ä¹³')) promptParts.push('large breasts');
          else if (appearance.includes('å°èƒ¸') || appearance.includes('å¾®ä¹³')) promptParts.push('small breasts');
          else if (appearance.includes('ä¸­ç­‰')) promptParts.push('medium breasts');
        }

        // 10. ç‰¹æ®Šæ ‡è®°
        if (appearance.includes('ç¾äººç—£') || appearance.includes('æ³ªç—£'))
          promptParts.push('beauty mark', 'mole under eye');
        if (appearance.includes('é›€æ–‘')) promptParts.push('freckles');
        if (appearance.includes('ä¼¤ç–¤') || appearance.includes('ç–¤ç—•')) promptParts.push('scar');
        if (appearance.includes('çº¹èº«') || appearance.includes('åˆºé’')) promptParts.push('tattoo');
        if (appearance.includes('è€³ç¯') || appearance.includes('è€³é¥°')) promptParts.push('earrings');

        // 11. ç§æ—ç‰¹å¾
        if (appearance.includes('ç²¾çµè€³') || appearance.includes('å°–è€³')) promptParts.push('pointy ears', 'elf ears');
        if (appearance.includes('è§’') && !appearance.includes('è§¦è§’')) promptParts.push('horns');
        if (appearance.includes('ç¿…è†€') || appearance.includes('ç¾½ç¿¼')) promptParts.push('wings');
        if (appearance.includes('å°¾å·´')) promptParts.push('tail');
        if (
          appearance.includes('å…½è€³') ||
          appearance.includes('çŒ«è€³') ||
          appearance.includes('ç‹¼è€³') ||
          appearance.includes('ç‹è€³')
        )
          promptParts.push('animal ears');
        if (appearance.includes('ç ç‰™') || appearance.includes('å°–ç‰™')) promptParts.push('fangs');
        if (appearance.includes('çœ¼é•œ')) promptParts.push('glasses');

        // 12. è´¨é‡æ ‡ç­¾
        promptParts.push('detailed face', 'detailed eyes', 'detailed skin', 'beautiful', 'aesthetic');

        // å»é‡å¹¶ç”Ÿæˆæœ€ç»ˆæç¤ºè¯
        const uniqueParts = [...new Set(promptParts)].filter(Boolean);
        char.å¤–è²Œæç¤ºè¯ = uniqueParts.join(', ');
        char.å¤–è²Œæç¤ºè¯_NSFW = char.å¤–è²Œæç¤ºè¯;

        console.info(`ä¸ºè§’è‰² ${char.å§“å} æ„å»ºå¤–è²Œæç¤ºè¯:`, char.å¤–è²Œæç¤ºè¯);
      }

      function ensureCharacterRelationship(char) {
        if (!char || typeof char !== 'object') return;

        // åˆå§‹åŒ–æ•°å€¼
        if (!Number.isFinite(char.å¥½æ„Ÿåº¦) || !Number.isFinite(char.æ¨æ„)) {
          const emotion = char.æƒ…æ„ŸçŠ¶æ€?.å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ || 'ä¸­ç«‹';
          const intensity = clampNumber(char.æƒ…æ„ŸçŠ¶æ€?.æƒ…æ„Ÿå¼ºåº¦ ?? 0, 0, 100);
          let baseLike = 20;
          let baseHate = 0;
          if (emotion === 'çˆ±') baseLike = 65;
          else if (emotion === 'å–œæ¬¢') baseLike = 45;
          else if (emotion === 'ä¸­ç«‹') baseLike = 25;
          else if (emotion === 'åŒæ¶') baseHate = 45;
          else if (emotion === 'æ†æ¨') baseHate = 65;
          char.å¥½æ„Ÿåº¦ = clampNumber(Math.round(baseLike + intensity * 0.2), 0, 100);
          char.æ¨æ„ = clampNumber(Math.round(baseHate + intensity * 0.2), 0, 100);
        }

        char.å¥½æ„Ÿåº¦ = clampNumber(char.å¥½æ„Ÿåº¦, 0, 100);
        char.æ¨æ„ = clampNumber(char.æ¨æ„, 0, 100);

        if (!char.å·²è§£é”å‰§æƒ… || typeof char.å·²è§£é”å‰§æƒ… !== 'object') {
          char.å·²è§£é”å‰§æƒ… = {};
        }
        if (!char.å‰§æƒ…æ¡£æ¡ˆ || typeof char.å‰§æƒ…æ¡£æ¡ˆ !== 'object') {
          char.å‰§æƒ…æ¡£æ¡ˆ = {};
        }

        char.å…³ç³»é˜¶æ®µ = computeRelationshipStage(char.å¥½æ„Ÿåº¦, char.æ¨æ„);
      }

      function computeRelationshipStage(like, hate) {
        const a = clampNumber(like, 0, 100);
        const h = clampNumber(hate, 0, 100);
        if (h >= 90) return 'æ·±ä»‡';
        if (h >= 70) return 'æ•Œè§†';
        if (h >= 50) return 'åŒæ¶';
        if (a >= 90) return 'æ²‰æºº';
        if (a >= 70) return 'äº²è¿‘';
        if (a >= 50) return 'å¥½æ„Ÿ';
        return 'ä¸­ç«‹';
      }

      /**
       * æ ¹æ®è§’è‰²ä¿¡æ¯è®¡ç®—å±æ€§åˆå§‹å€¼
       * ç»¼åˆè€ƒè™‘ï¼šèŒä¸šã€ä½“æ ¼ã€ç»éªŒã€èƒŒæ™¯æ•…äº‹ã€ç§æ—ç­‰
       * ä¸€èˆ¬æƒ…å†µï¼š0-25ï¼Œç‰¹æ®Šæƒ…å†µï¼ˆå¦‚é­…é­”ã€è¡å¦‡ç­‰ï¼‰ï¼š25-50
       */
      function calculateInitialAttributes(char) {
        if (!char || typeof char !== 'object') {
          return { é­…åŠ›: 15, é¡ºä»: 15, æŠ€å·§: 15, è€åŠ›: 15, æ•æ„Ÿåº¦: 15 };
        }

        const baseMin = 0;
        const baseMax = 25;
        const specialMin = 25;
        const specialMax = 50;

        // æå–è§’è‰²ä¿¡æ¯
        const èŒä¸š = (char.èŒä¸š || char['èŒä¸š/èº«ä»½'] || '').toLowerCase();
        const ç§æ— = (char.ç§æ— || char['ç§æ—/å‡ºèº«'] || '').toLowerCase();
        const èƒŒæ™¯æ•…äº‹ = (char.èƒŒæ™¯æ•…äº‹ || '').toLowerCase();
        const æ€§æ ¼ = (char.æ€§æ ¼ || char['æ€§æ ¼/å–œå¥½'] || '').toLowerCase();
        const å¤–è²Œ = (char.å¤–è²Œç‰¹ç‚¹ || '').toLowerCase();
        const ç¨€æœ‰åº¦ = char.ç¨€æœ‰åº¦ || 'N';

        // åˆ¤æ–­æ˜¯å¦ä¸ºç‰¹æ®Šæƒ…å†µï¼ˆé­…é­”ã€è¡å¦‡ç­‰ï¼‰
        const isSpecial =
          ç§æ—.includes('é­…é­”') ||
          ç§æ—.includes('succubus') ||
          ç§æ—.includes('æ·«é­”') ||
          ç§æ—.includes('incubus') ||
          èŒä¸š.includes('å¦“å¥³') ||
          èŒä¸š.includes('å¨¼å¦‡') ||
          èŒä¸š.includes('æ€§å¥´') ||
          èŒä¸š.includes('prostitute') ||
          èŒä¸š.includes('whore') ||
          èƒŒæ™¯æ•…äº‹.includes('æ€§ç»éªŒ') ||
          èƒŒæ™¯æ•…äº‹.includes('æ€§å·¥ä½œ') ||
          èƒŒæ™¯æ•…äº‹.includes('sex work') ||
          èƒŒæ™¯æ•…äº‹.includes('prostitution') ||
          æ€§æ ¼.includes('æ”¾è¡') ||
          æ€§æ ¼.includes('æ·«è¡') ||
          æ€§æ ¼.includes('è¡å¦‡') ||
          æ€§æ ¼.includes('slut') ||
          æ€§æ ¼.includes('whore') ||
          å¤–è²Œ.includes('æ€§æ„Ÿ') ||
          å¤–è²Œ.includes('é­…æƒ‘');

        const min = isSpecial ? specialMin : baseMin;
        const max = isSpecial ? specialMax : baseMax;

        // åˆå§‹åŒ–å±æ€§
        const attrs = {
          é­…åŠ›: 0,
          é¡ºä»: 0,
          æŠ€å·§: 0,
          è€åŠ›: 0,
          æ•æ„Ÿåº¦: 0,
        };

        // æ ¹æ®èŒä¸šå½±å“å±æ€§
        if (èŒä¸š.includes('æˆ˜å£«') || èŒä¸š.includes('warrior') || èŒä¸š.includes('éª‘å£«') || èŒä¸š.includes('knight')) {
          attrs.è€åŠ› += 8;
          attrs.æŠ€å·§ += 3;
        } else if (
          èŒä¸š.includes('æ³•å¸ˆ') ||
          èŒä¸š.includes('mage') ||
          èŒä¸š.includes('é­”æ³•å¸ˆ') ||
          èŒä¸š.includes('wizard')
        ) {
          attrs.é­…åŠ› += 5;
          attrs.æ•æ„Ÿåº¦ += 4;
        } else if (
          èŒä¸š.includes('ç›—è´¼') ||
          èŒä¸š.includes('thief') ||
          èŒä¸š.includes('åˆºå®¢') ||
          èŒä¸š.includes('assassin')
        ) {
          attrs.æŠ€å·§ += 8;
          attrs.è€åŠ› += 2;
        } else if (èŒä¸š.includes('èˆè€…') || èŒä¸š.includes('dancer') || èŒä¸š.includes('èˆå¥³')) {
          attrs.é­…åŠ› += 6;
          attrs.æŠ€å·§ += 5;
          attrs.æ•æ„Ÿåº¦ += 3;
        } else if (èŒä¸š.includes('æ­Œæ‰‹') || èŒä¸š.includes('singer') || èŒä¸š.includes('è‰ºäºº') || èŒä¸š.includes('idol')) {
          attrs.é­…åŠ› += 7;
          attrs.æŠ€å·§ += 2;
        } else if (èŒä¸š.includes('åŒ»ç”Ÿ') || èŒä¸š.includes('doctor') || èŒä¸š.includes('åŒ»å¸ˆ')) {
          attrs.æŠ€å·§ += 6;
          attrs.æ•æ„Ÿåº¦ += 2;
        } else if (èŒä¸š.includes('å­¦è€…') || èŒä¸š.includes('scholar') || èŒä¸š.includes('ç ”ç©¶å‘˜')) {
          attrs.æŠ€å·§ += 4;
          attrs.æ•æ„Ÿåº¦ += 3;
        } else if (
          èŒä¸š.includes('è´µæ—') ||
          èŒä¸š.includes('noble') ||
          èŒä¸š.includes('å…¬ä¸»') ||
          èŒä¸š.includes('princess')
        ) {
          attrs.é­…åŠ› += 5;
          attrs.é¡ºä» -= 3; // è´µæ—å¯èƒ½æ›´ä¸å¬è¯
        } else if (èŒä¸š.includes('å¥´éš¶') || èŒä¸š.includes('slave') || èŒä¸š.includes('ä¿˜è™')) {
          attrs.é¡ºä» += 8;
          attrs.è€åŠ› += 3;
        } else if (
          èŒä¸š.includes('å¦“å¥³') ||
          èŒä¸š.includes('prostitute') ||
          èŒä¸š.includes('å¨¼å¦‡') ||
          èŒä¸š.includes('æ€§å¥´')
        ) {
          attrs.æŠ€å·§ += 10;
          attrs.é¡ºä» += 5;
          attrs.æ•æ„Ÿåº¦ += 4;
        } else if (èŒä¸š.includes('è°ƒæ•™å¸ˆ') || èŒä¸š.includes('dominator')) {
          attrs.æŠ€å·§ += 7;
          attrs.é­…åŠ› += 3;
        }

        // æ ¹æ®ç§æ—å½±å“å±æ€§
        if (ç§æ—.includes('é­…é­”') || ç§æ—.includes('succubus') || ç§æ—.includes('æ·«é­”') || ç§æ—.includes('incubus')) {
          attrs.é­…åŠ› += 12;
          attrs.æŠ€å·§ += 8;
          attrs.æ•æ„Ÿåº¦ += 6;
        } else if (ç§æ—.includes('ç²¾çµ') || ç§æ—.includes('elf')) {
          attrs.é­…åŠ› += 5;
          attrs.æ•æ„Ÿåº¦ += 4;
        } else if (ç§æ—.includes('å…½äºº') || ç§æ—.includes('orc')) {
          attrs.è€åŠ› += 8;
          attrs.æŠ€å·§ -= 2;
        } else if (ç§æ—.includes('é¾™') || ç§æ—.includes('dragon')) {
          attrs.é­…åŠ› += 6;
          attrs.è€åŠ› += 5;
        } else if (ç§æ—.includes('å¤©ä½¿') || ç§æ—.includes('angel')) {
          attrs.é­…åŠ› += 7;
          attrs.é¡ºä» += 3;
        } else if (ç§æ—.includes('æ¶é­”') || ç§æ—.includes('demon')) {
          attrs.æŠ€å·§ += 5;
          attrs.é¡ºä» -= 2;
        }

        // æ ¹æ®ä½“æ ¼ï¼ˆä»å¤–è²Œç‰¹ç‚¹æ¨æ–­ï¼‰
        if (å¤–è²Œ.includes('å¼ºå£®') || å¤–è²Œ.includes('muscular') || å¤–è²Œ.includes('å¥å£®')) {
          attrs.è€åŠ› += 6;
        } else if (å¤–è²Œ.includes('çº¤ç»†') || å¤–è²Œ.includes('slim') || å¤–è²Œ.includes('ç˜¦å¼±')) {
          attrs.è€åŠ› -= 2;
          attrs.æ•æ„Ÿåº¦ += 3;
        } else if (å¤–è²Œ.includes('ä¸°æ»¡') || å¤–è²Œ.includes('curvy') || å¤–è²Œ.includes('æ€§æ„Ÿ')) {
          attrs.é­…åŠ› += 4;
        }

        // æ ¹æ®èƒŒæ™¯æ•…äº‹ä¸­çš„ç»éªŒæè¿°
        if (èƒŒæ™¯æ•…äº‹.includes('è®­ç»ƒ') || èƒŒæ™¯æ•…äº‹.includes('training') || èƒŒæ™¯æ•…äº‹.includes('ç»ƒä¹ ')) {
          attrs.æŠ€å·§ += 3;
          attrs.è€åŠ› += 2;
        }
        if (èƒŒæ™¯æ•…äº‹.includes('æˆ˜æ–—') || èƒŒæ™¯æ•…äº‹.includes('battle') || èƒŒæ™¯æ•…äº‹.includes('æˆ˜äº‰')) {
          attrs.è€åŠ› += 4;
          attrs.æŠ€å·§ += 2;
        }
        if (èƒŒæ™¯æ•…äº‹.includes('æ€§ç»éªŒ') || èƒŒæ™¯æ•…äº‹.includes('æ€§å·¥ä½œ') || èƒŒæ™¯æ•…äº‹.includes('prostitution')) {
          attrs.æŠ€å·§ += 6;
          attrs.æ•æ„Ÿåº¦ += 3;
        }
        if (èƒŒæ™¯æ•…äº‹.includes('æœä»') || èƒŒæ™¯æ•…äº‹.includes('obedience') || èƒŒæ™¯æ•…äº‹.includes('å¥´éš¶')) {
          attrs.é¡ºä» += 5;
        }
        if (èƒŒæ™¯æ•…äº‹.includes('åæŠ—') || èƒŒæ™¯æ•…äº‹.includes('rebellion') || èƒŒæ™¯æ•…äº‹.includes('è‡ªç”±')) {
          attrs.é¡ºä» -= 4;
          attrs.è€åŠ› += 2;
        }

        // æ ¹æ®æ€§æ ¼å½±å“
        if (æ€§æ ¼.includes('æ¸©æŸ”') || æ€§æ ¼.includes('gentle') || æ€§æ ¼.includes('é¡ºä»')) {
          attrs.é¡ºä» += 4;
          attrs.é­…åŠ› += 2;
        } else if (æ€§æ ¼.includes('å¼ºåŠ¿') || æ€§æ ¼.includes('dominant') || æ€§æ ¼.includes('é«˜å‚²')) {
          attrs.é¡ºä» -= 3;
          attrs.é­…åŠ› += 3;
        } else if (æ€§æ ¼.includes('æ•æ„Ÿ') || æ€§æ ¼.includes('sensitive')) {
          attrs.æ•æ„Ÿåº¦ += 5;
        } else if (æ€§æ ¼.includes('åšéŸ§') || æ€§æ ¼.includes('tough') || æ€§æ ¼.includes('åšå¼º')) {
          attrs.è€åŠ› += 4;
        }

        // ç¨€æœ‰åº¦å½±å“ï¼ˆè¾ƒå°ï¼Œä¸»è¦ä½œä¸ºå¾®è°ƒï¼‰
        const rarityBonus = { N: 0, R: 2, SR: 4, SSR: 6 }[ç¨€æœ‰åº¦] || 0;
        Object.keys(attrs).forEach(key => {
          attrs[key] += rarityBonus;
        });

        // ç”Ÿæˆæœ€ç»ˆå±æ€§å€¼ï¼ˆåœ¨min-maxèŒƒå›´å†…ï¼ŒåŠ ä¸ŠèŒä¸šç­‰åŠ æˆï¼‰
        const finalAttrs = {};
        Object.keys(attrs).forEach(key => {
          // åŸºç¡€å€¼ï¼šéšæœºåœ¨min-maxèŒƒå›´å†…
          const baseValue = Math.floor(Math.random() * (max - min + 1)) + min;
          // åŠ ä¸ŠèŒä¸šç­‰åŠ æˆ
          const finalValue = baseValue + attrs[key];
          // é™åˆ¶åœ¨0-100èŒƒå›´å†…
          finalAttrs[key] = clampNumber(finalValue, 0, 100);
        });

        return finalAttrs;
      }

      function normalizeCharacter(char) {
        if (!char || typeof char !== 'object') return char;
        if (!char.å±æ€§ || typeof char.å±æ€§ !== 'object') char.å±æ€§ = {};
        // å…¼å®¹è€æ•°æ®ï¼šå¦‚æœå±æ€§ä¸å­˜åœ¨æˆ–ä¸ºé»˜è®¤å€¼ï¼Œé‡æ–°è®¡ç®—
        const hasValidAttrs = ['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦'].every(
          k => Number.isFinite(char.å±æ€§[k]) && char.å±æ€§[k] !== 30,
        );
        if (!hasValidAttrs) {
          // å¦‚æœå±æ€§ä¸å­˜åœ¨æˆ–éƒ½æ˜¯é»˜è®¤å€¼30ï¼Œé‡æ–°è®¡ç®—
          const calculatedAttrs = calculateInitialAttributes(char);
          ['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦'].forEach(k => {
            if (!Number.isFinite(char.å±æ€§[k]) || char.å±æ€§[k] === 30) {
              char.å±æ€§[k] = calculatedAttrs[k];
            }
            char.å±æ€§[k] = clampNumber(char.å±æ€§[k], 0, 100);
          });
        } else {
          // å·²æœ‰æœ‰æ•ˆå±æ€§ï¼ŒåªåšèŒƒå›´é™åˆ¶
          ['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦'].forEach(k => {
            char.å±æ€§[k] = clampNumber(char.å±æ€§[k], 0, 100);
          });
        }
        if (!char.æƒ…æ„ŸçŠ¶æ€ || typeof char.æƒ…æ„ŸçŠ¶æ€ !== 'object') {
          char.æƒ…æ„ŸçŠ¶æ€ = { å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ: 'ä¸­ç«‹', æƒ…æ„Ÿå¼ºåº¦: 0, ç‰¹æ®ŠçŠ¶æ€: [] };
        }
        if (!Array.isArray(char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€)) char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€ = [];
        // ç¡®ä¿èŠå¤©ç›¸å…³å­—æ®µå­˜åœ¨
        if (!Array.isArray(char.èŠå¤©è®°å½•)) char.èŠå¤©è®°å½• = [];
        if (typeof char.èŠå¤©æ‘˜è¦ !== 'string') char.èŠå¤©æ‘˜è¦ = '';
        if (typeof char.èŠå¤©æ¬¡æ•° !== 'number') char.èŠå¤©æ¬¡æ•° = 0;
        ensureCharacterPrompts(char);
        ensureCharacterRelationship(char);
        return char;
      }

      function normalizeAllCharacters() {
        if (!gameState.è§’è‰²ä»“åº“ || typeof gameState.è§’è‰²ä»“åº“ !== 'object') return;
        Object.values(gameState.è§’è‰²ä»“åº“).forEach(char => normalizeCharacter(char));
      }

      function checkRelationshipTriggers(characterId, cause = '') {
        const char = gameState.è§’è‰²ä»“åº“?.[characterId];
        if (!char) return;
        normalizeCharacter(char);

        const triggers = [
          { key: 'aff_70', type: 'å¥½æ„Ÿ', threshold: 70, title: 'ç§å¯†é‚€çº¦', desc: 'å¥½æ„Ÿè¾¾åˆ°70ï¼šè§£é”ä¸€æ¬¡ç§å¯†é‚€çº¦' },
          { key: 'aff_90', type: 'å¥½æ„Ÿ', threshold: 90, title: 'èª“çº¦æ—¶åˆ»', desc: 'å¥½æ„Ÿè¾¾åˆ°90ï¼šè§£é”èª“çº¦æ—¶åˆ»' },
          { key: 'hate_70', type: 'æ¨æ„', threshold: 70, title: 'æš—æ½®åå™¬', desc: 'æ¨æ„è¾¾åˆ°70ï¼šè§£é”æš—æ½®åå™¬' },
          { key: 'hate_90', type: 'æ¨æ„', threshold: 90, title: 'è£‚éš™é€ƒäº¡', desc: 'æ¨æ„è¾¾åˆ°90ï¼šè§£é”è£‚éš™é€ƒäº¡' },
        ];

        let unlockedAny = false;
        triggers.forEach(t => {
          if (char.å·²è§£é”å‰§æƒ…[t.key]) return;
          const val = t.type === 'å¥½æ„Ÿ' ? char.å¥½æ„Ÿåº¦ : char.æ¨æ„;
          if (val >= t.threshold) {
            char.å·²è§£é”å‰§æƒ…[t.key] = true;
            unlockedAny = true;
            pushBrothelLog({
              æ—¶é—´æˆ³: getGameTime().å½“å‰å›åˆ || 1,
              è§’è‰²ID: characterId,
              äº‹ä»¶ç±»å‹: 'è§£é”å‰§æƒ…',
              æè¿°: `${char.å§“å} è§£é”å‰§æƒ…ã€${t.title}ã€‘${cause ? `ï¼ˆå› ï¼š${cause}ï¼‰` : ''}`,
              æ”¶å…¥å˜åŒ–: 0,
            });
          }
        });

        if (unlockedAny) {
          saveGameStateToMVU();
        }
      }

      // ç”Ÿæˆç»˜å›¾æç¤ºè¯ï¼ˆè¯¦ç»†ã€å…¨é¢çš„è§’è‰²å¤–è²Œ + æ ¹æ®å‰§æƒ…å†…å®¹åŠ¨æ€ç”Ÿæˆåœºæ™¯/åŠ¨ä½œ/èº«ä½“éƒ¨ä½æ ‡ç­¾ï¼‰
      // æ ¼å¼ï¼šimage###è¯¦ç»†å¤–è²Œæè¿°, åœºæ™¯æ ‡ç­¾###
      // ã€é‡è¦ã€‘ç”Ÿæˆçš„å›¾ç‰‡å¿…é¡»ä¸å½“å‰å‰§æƒ…é«˜åº¦ç›¸å…³ï¼Œå¹¶æ­£ç¡®å¼•ç”¨å·²ç»æå–å¥½çš„è§’è‰²å¤–è²Œæç¤ºè¯
      function buildAutoImageTag(characterId, context = {}) {
        const char = gameState.è§’è‰²ä»“åº“?.[characterId];
        if (!char) return '';
        normalizeCharacter(char);

        // åˆ¤æ–­æ˜¯å¦ä¸ºNSFWåœºæ™¯
        const isNSFWScene =
          context?.scene && ['æ¥å®¢', 'è°ƒæ•™', 'è®­ç»ƒ', 'ç‰¹æ®Šäº’åŠ¨'].some(k => String(context.scene).includes(k));

        // è·å–è§’è‰²çš„åŸºç¡€å¤–è²Œæç¤ºè¯ï¼ˆåªåŒ…å«å¤–è²Œä¸å˜é‡ï¼‰
        // ã€é‡è¦ã€‘å¿…é¡»æ­£ç¡®å¼•ç”¨å·²ç»æå–å¥½çš„è§’è‰²å¤–è²Œæç¤ºè¯ï¼Œç¡®ä¿è§’è‰²å¤–è²Œä¸€è‡´æ€§
        let base = (isNSFWScene ? char.å¤–è²Œæç¤ºè¯_NSFW || char.å¤–è²Œæç¤ºè¯ : char.å¤–è²Œæç¤ºè¯ || '').trim();

        // å¦‚æœå¤–è²Œæç¤ºè¯ä¸ºç©ºæˆ–å¤ªçŸ­ï¼Œå°è¯•ä»ç»˜å›¾æ ‡ç­¾é‡æ–°æå–
        if (!base || base.length < 20) {
          const fromTags = extractAllImagePrompts(char.ç»˜å›¾æ ‡ç­¾ || '');
          if (fromTags.length > 0) {
            // ä»åŒåˆ†é•œæ ‡ç­¾ä¸­æå–çº¯å¤–è²Œéƒ¨åˆ†ï¼ˆå»é™¤åœºæ™¯ã€åŠ¨ä½œã€å§¿åŠ¿ç­‰å˜é‡ï¼‰
            base = extractAppearanceOnly(fromTags[0]);
            if (base && base.length > 10) {
              char.å¤–è²Œæç¤ºè¯ = base;
              if (fromTags.length > 1) {
                char.å¤–è²Œæç¤ºè¯_NSFW = extractAppearanceOnly(fromTags[fromTags.length - 1]);
              }
            }
          }
        }

        // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œä½¿ç”¨åŸºç¡€è‹±æ–‡æè¿°ï¼ˆä¸ä½¿ç”¨ä¸­æ–‡å¤–è²Œç‰¹ç‚¹ï¼‰
        if (!base) {
          base = `1person, ${char.å§“å || 'character'}, portrait`;
        }

        // ==================== å¼ºè°ƒæ€§åˆ«å’Œå¤–è²Œï¼ˆç”¨[[]]åŒ…è£¹å¢å¼ºæƒé‡ï¼‰ ====================
        // æ ¹æ®è§’è‰²æ€§åˆ«ç¡®å®šå¼ºè°ƒæ ‡ç­¾
        let genderTag = '';
        let genderFocus = '';
        const gender = char.æ€§åˆ« || '';
        const isMale = gender.includes('ç”·æ€§') || gender.includes('ç”·');
        const isFemale = gender.includes('å¥³æ€§') || gender.includes('å¥³');
        const isIntersex = gender.includes('åŒæ€§');

        if (isMale) {
          genderTag = '[[1man]], [[solo male]]';
          genderFocus = '[[man focus]], [[male focus]], [[male body]], [[flat chest]], [[no breasts]]';
        } else if (isFemale) {
          genderTag = '[[1girl]], [[solo female]]';
          genderFocus = '[[woman focus]], [[female focus]], [[female body]]';
        } else if (isIntersex) {
          genderTag = '[[1man]]';
          genderFocus = '[[man focus]], [[femboy focus]], [[androgynous]]';
        } else {
          // é»˜è®¤å°è¯•ä»å¤–è²Œæç¤ºè¯ä¸­æ¨æ–­
          const baseLower = base.toLowerCase();
          if (baseLower.includes('man') || baseLower.includes('male') || baseLower.includes('boy')) {
            genderTag = '[[1man]], [[solo male]]';
            genderFocus = '[[man focus]], [[male focus]], [[male body]], [[flat chest]], [[no breasts]]';
          } else if (baseLower.includes('girl') || baseLower.includes('female') || baseLower.includes('woman')) {
            genderTag = '[[1girl]], [[solo female]]';
            genderFocus = '[[woman focus]], [[female focus]], [[female body]]';
          } else {
            genderTag = '[[1person]], [[solo]]';
            genderFocus = '[[character focus]]';
          }
        }

        // å°†å¤–è²Œæç¤ºè¯ä¸­çš„å…³é”®ç‰¹å¾ç”¨[[]]å¼ºè°ƒ
        // ã€é‡è¦ã€‘æ­£ç¡®å¼•ç”¨å·²ç»æå–å¥½çš„è§’è‰²å¤–è²Œæç¤ºè¯ï¼Œç¡®ä¿è§’è‰²å¤–è²Œä¸€è‡´æ€§
        const baseParts = base
          .split(',')
          .map(p => p.trim())
          .filter(p => p && p.length > 2);
        const emphasizedBase = baseParts
          .map((part, idx) => {
            // å¯¹å‰5ä¸ªå…³é”®å¤–è²Œç‰¹å¾è¿›è¡Œå¼ºè°ƒï¼ˆè·³è¿‡person/soloç­‰é€šç”¨è¯ï¼‰
            const lowerPart = part.toLowerCase();
            if (lowerPart.includes('person') || lowerPart.includes('solo') || lowerPart.includes('portrait')) {
              return part;
            }
            if (idx < 5) {
              return `[[${part}]]`;
            }
            return part;
          })
          .join(', ');

        // ==================== æ ¹æ®å‰§æƒ…å†…å®¹åŠ¨æ€åˆ†ææç¤ºè¯ ====================
        // ã€é‡è¦ã€‘ç”Ÿæˆçš„å›¾ç‰‡å¿…é¡»ä¸å½“å‰å‰§æƒ…é«˜åº¦ç›¸å…³ï¼Œæ ¹æ®å‰§æƒ…å†…å®¹åŠ¨æ€è°ƒæ•´åœºæ™¯ã€åŠ¨ä½œã€è¡¨æƒ…ç­‰æ ‡ç­¾
        const storyText = context.storyText || '';
        const dynamicTags = analyzeStoryForImageTags(storyText, isNSFWScene);

        // åŸºç¡€è´¨é‡æ ‡ç­¾
        const qualityTags = [
          'masterpiece',
          'best quality',
          'highly detailed',
          '8k',
          '[[detailed face]]',
          '[[detailed eyes]]',
        ];

        // NSFWæ ‡ç­¾ï¼ˆå¦‚æœæ˜¯æˆäººåœºæ™¯ï¼‰
        const nsfwTags = [];
        if (isNSFWScene || dynamicTags.isNSFW) {
          nsfwTags.push('nsfw', 'explicit');
          qualityTags.push('[[detailed body]]', '[[detailed skin]]');
        }

        // åœºæ™¯ç›¸å…³æ ‡ç­¾ï¼ˆæ ¹æ®å‰§æƒ…å’Œæˆ¿é—´ç±»å‹åŠ¨æ€ç”Ÿæˆï¼‰
        const gameTime = getGameTime();
        const sceneTags = ['dark fantasy'];

        // æˆ¿é—´ç±»å‹
        if (context.roomType) {
          const roomTypeMap = {
            æ™®é€š: 'bedroom, bed',
            VIP: 'luxury bedroom, silk sheets, chandelier',
            è°ƒæ•™å®¤: 'dungeon, chains, leather, dim red light',
            å±•ç¤ºå®¤: 'display room, stage, spotlight',
            æƒ…è¶£æˆ¿: 'erotic room, love hotel, pink lighting',
          };
          sceneTags.push(roomTypeMap[context.roomType] || context.roomType);
        }

        // æ—¶æ®µå…‰çº¿
        sceneTags.push(
          gameTime.å½“å‰æ—¶æ®µ === 'æ™šä¸Š'
            ? 'candlelight, dim lighting, night, warm glow'
            : gameTime.å½“å‰æ—¶æ®µ === 'ä¸­åˆ'
              ? 'soft daylight, bright, noon'
              : 'morning light, soft, dawn',
        );

        // åˆå¹¶æ‰€æœ‰æ ‡ç­¾ï¼šæ€§åˆ«å¼ºè°ƒ + NSFW + è´¨é‡ + è§’è‰²å¤–è²Œï¼ˆå·²å¼ºè°ƒï¼Œæ­£ç¡®å¼•ç”¨ï¼‰ + æ€§åˆ«ç„¦ç‚¹ + åŠ¨æ€åˆ†æçš„æ ‡ç­¾ï¼ˆä¸å‰§æƒ…ç›¸å…³ï¼‰ + åœºæ™¯
        // æ³¨æ„ï¼šå¤šåˆ†é•œå¯ä»¥å‡ºç°ï¼Œä½†ä¸éœ€è¦ç‰¹åœ°å¼ºè°ƒå•åˆ†é•œæˆ–åŒåˆ†é•œ
        const allTags = [
          genderTag,
          ...nsfwTags,
          ...qualityTags,
          emphasizedBase, // æ­£ç¡®å¼•ç”¨å·²ç»æå–å¥½çš„è§’è‰²å¤–è²Œæç¤ºè¯
          genderFocus,
          ...dynamicTags.bodyParts, // æ ¹æ®å‰§æƒ…åŠ¨æ€ç”Ÿæˆ
          ...dynamicTags.actions, // æ ¹æ®å‰§æƒ…åŠ¨æ€ç”Ÿæˆ
          ...dynamicTags.expressions, // æ ¹æ®å‰§æƒ…åŠ¨æ€ç”Ÿæˆ
          ...dynamicTags.clothing, // æ ¹æ®å‰§æƒ…åŠ¨æ€ç”Ÿæˆ
          ...dynamicTags.extras, // æ ¹æ®å‰§æƒ…åŠ¨æ€ç”Ÿæˆ
          ...sceneTags, // æ ¹æ®æˆ¿é—´ç±»å‹å’Œæ—¶æ®µåŠ¨æ€ç”Ÿæˆ
        ];

        const merged = normalizePromptText(allTags.join(', '));
        // ã€é‡è¦ã€‘åªä½¿ç”¨æ­£é¢æç¤ºè¯ï¼Œä¸è¦ä½¿ç”¨è´Ÿé¢æç¤ºè¯ï¼ˆå› ä¸ºAIä¼šæŠŠè´Ÿé¢æç¤ºè¯ä¹Ÿå½“æ­£é¢æç¤ºè¯ç”¨ï¼‰
        const finalPrompt = merged;
        console.info('åŠ¨æ€å›¾ç‰‡æç¤ºè¯ï¼ˆä¸å‰§æƒ…ç›¸å…³ï¼‰:', finalPrompt.substring(0, 200) + '...');
        return `image###${finalPrompt}###`;
      }

      // åˆ†æå‰§æƒ…æ–‡æœ¬ï¼Œæå–å›¾åƒç›¸å…³æ ‡ç­¾
      function analyzeStoryForImageTags(storyText, isNSFWScene = false) {
        const result = {
          isNSFW: false,
          bodyParts: [],
          actions: [],
          expressions: [],
          clothing: [],
          extras: [],
        };

        if (!storyText) return result;
        const text = storyText.toLowerCase();

        // ==================== èº«ä½“éƒ¨ä½æ£€æµ‹ ====================
        const bodyPartKeywords = {
          // èƒ¸éƒ¨
          'èƒ¸|ä¹³|å¥¶|èƒ¸éƒ¨|ä¹³æˆ¿|é…¥èƒ¸|åŒå³°|ä¹³å°–|ä¹³æ™•|ä¹³å¤´|å·¨ä¹³|è´«ä¹³|ç¾ä¹³': 'breasts, chest',
          'å¤§èƒ¸|ä¸°æ»¡çš„èƒ¸|é¥±æ»¡çš„èƒ¸|å·¨ä¹³': 'large breasts, cleavage',
          'å°èƒ¸|è´«ä¹³|å¹³èƒ¸': 'small breasts, flat chest',
          'ä¹³æ²Ÿ|äº‹ä¸šçº¿': 'cleavage',
          'ä¹³å¤´|ä¹³å°–|ä¹³æ™•': 'nipples, areola',
          // è‡€éƒ¨
          'è‡€|å±è‚¡|ç¿˜è‡€|ç¾è‡€|è‡€éƒ¨|èœœæ¡ƒè‡€': 'ass, buttocks',
          'ç¿˜è‡€|ç¾è‡€|èœœæ¡ƒè‡€': 'round ass, beautiful buttocks',
          // è…¿éƒ¨
          'è…¿|å¤§è…¿|å°è…¿|ç¾è…¿|é•¿è…¿|ç‰è…¿': 'legs, thighs',
          'å¤§è…¿|ç²—è…¿|è‚‰è…¿': 'thick thighs',
          'ä¿®é•¿çš„è…¿|é•¿è…¿|ç¾è…¿': 'long legs, slender legs',
          // ç§å¯†éƒ¨ä½
          'ç§å¤„|ä¸‹ä½“|ç§˜å¤„|èŠ±ç©´|èœœç©´|é˜´|å°ç©´|è‚‰ç©´': 'pussy, vulva, labia',
          'é˜´è’‚|èŠ±æ ¸|è‚‰è’‚': 'clitoris',
          'é˜´å”‡|è‚‰å”‡': 'labia',
          'è‚‰æ£’|é˜³å…·|èŒ|é¾Ÿå¤´|ç¾ä¸¸|è›‹è›‹': 'penis, cock, balls, glans',
          'èŠç©´|åç©´|è‚›|ååº­': 'anus, asshole',
          // å…¶ä»–èº«ä½“éƒ¨ä½
          'è…°|ç»†è…°|çº¤è…°|è…°è‚¢': 'waist, slim waist',
          'è‚š|å°è…¹|è…¹éƒ¨': 'belly, abdomen',
          'è‚šè„|è„': 'navel',
          'è„–|é¢ˆ|è„–å­|é¢ˆéƒ¨': 'neck',
          'è‚©|é¦™è‚©|è‚©è†€': 'shoulders',
          'èƒŒ|åèƒŒ|è„ŠèƒŒ': 'back',
          'æ‰‹|æ‰‹æŒ‡|ç‰æ‰‹|çº¤æ‰‹': 'hands, fingers',
          'è„š|ç‰è¶³|è¶³|è„šè¶¾': 'feet, toes',
          'èˆŒ|èˆŒå¤´|é¦™èˆŒ': 'tongue',
          'å”‡|å˜´å”‡|çº¢å”‡|æ¨±å”‡': 'lips',
          'è„¸|é¢|é¢åº|è„¸é¢Š': 'face',
          'çœ¼|çœ¼ç›|ç¾çœ¸|çœ¼çœ¸': 'eyes',
        };

        for (const [keywords, tags] of Object.entries(bodyPartKeywords)) {
          const regex = new RegExp(keywords, 'i');
          if (regex.test(text)) {
            result.bodyParts.push(tags);
            if (['ç§å¤„', 'ä¸‹ä½“', 'é˜´', 'ç©´', 'è‚‰æ£’', 'é˜³å…·', 'èŒ', 'èŠç©´', 'åç©´', 'è‚›'].some(k => text.includes(k))) {
              result.isNSFW = true;
            }
          }
        }

        // ==================== åŠ¨ä½œ/å§¿åŠ¿æ£€æµ‹ ====================
        const actionKeywords = {
          // æ€§è¡Œä¸º
          'æ’å…¥|è¿›å…¥|æŠ½æ’|å†²åˆº|å¾‹åŠ¨|æŠ½é€|é¡¶å¼„|è´¯ç©¿': 'penetration, sex, fucking',
          'éª‘ä¹˜|éª‘åœ¨|ååœ¨.*ä¸Š': 'cowgirl position, riding',
          'åå…¥|ä»å|èƒŒå': 'doggy style, from behind',
          'æ­£å¸¸ä½|ä¼ æ•™å£«|é¢å¯¹é¢': 'missionary position',
          'ä¾§å…¥|ä¾§å§': 'side position, spooning',
          'å£äº¤|å«ä½|åå|èˆ”å¼„|èˆ”èˆ': 'oral sex, blowjob, licking',
          'æ·±å–‰|å–‰å’™': 'deepthroat',
          'èˆ”|å®å¸|å®': 'licking, sucking',
          'æ‰‹æ·«|æ’¸|è‡ªæ…°|æ‰‹æŒ‡.*æ’': 'masturbation, fingering',
          'è¶³äº¤|ç”¨è„š': 'footjob',
          'ä¹³äº¤|èƒ¸æ¨|å¤¹': 'paizuri, titfuck',
          'é¢œå°„|å°„åœ¨è„¸ä¸Š': 'facial',
          'å†…å°„|å°„è¿›|å°„åœ¨é‡Œé¢': 'creampie',
          'æ½®å¹|å–·|é«˜æ½®': 'squirting, orgasm',
          'å¤šäºº|è½®|ç¾¤': 'group sex, gangbang',
          // ä¸€èˆ¬åŠ¨ä½œ
          'èºº|å¹³èºº|ä»°å§': 'lying down, on back',
          'è¶´|ä¿¯å§|è¶´ç€': 'lying face down, prone',
          'è·ª|è·ªç€|è·ªä¸‹': 'kneeling',
          'ç«™|ç«™ç«‹|ç«™ç€': 'standing',
          'å|åç€': 'sitting',
          'å¼¯è…°|ä¿¯èº«': 'bending over',
          'æŠ¬è…¿|å¼ å¼€è…¿|åˆ†å¼€è…¿|Må­—å¼€è…¿': 'spread legs, legs apart',
          'æŠ±|æ‹¥æŠ±|æ‚': 'embrace, hugging',
          'å»|äº²å»|æ¥å»': 'kissing',
          'æŠšæ‘¸|è§¦æ‘¸|çˆ±æŠš|æ‰|æ': 'touching, caressing, groping',
          'ç»‘|æ†|æŸç¼š|ç»‘ä½': 'bondage, tied up, bound',
          'è’™çœ¼|çœ¼ç½©': 'blindfolded',
          'é­æ‰“|æŠ½æ‰“|æ‰“å±è‚¡': 'spanking, whipping',
          'å¤¹|ä¹³å¤¹|é˜´å¤¹': 'clamps, nipple clamps',
          'å¡|è‚›å¡|è·³è›‹': 'plug, vibrator, sex toy',
          'é¡¹åœˆ|é¢ˆåœˆ|ç‰µå¼•': 'collar, leash',
          'æ‰‹é“|è„šé“|é•£é“': 'handcuffs, shackles',
          'åŠ|æ‚¬åŠ': 'suspension',
        };

        for (const [keywords, tags] of Object.entries(actionKeywords)) {
          const regex = new RegExp(keywords, 'i');
          if (regex.test(text)) {
            result.actions.push(tags);
            if (
              [
                'æ’å…¥',
                'æŠ½æ’',
                'éª‘ä¹˜',
                'åå…¥',
                'å£äº¤',
                'æ·±å–‰',
                'æ‰‹æ·«',
                'è¶³äº¤',
                'ä¹³äº¤',
                'é¢œå°„',
                'å†…å°„',
                'æ½®å¹',
                'é«˜æ½®',
                'è½®',
                'ç¾¤',
              ].some(k => text.includes(k))
            ) {
              result.isNSFW = true;
            }
          }
        }

        // ==================== è¡¨æƒ…æ£€æµ‹ ====================
        const expressionKeywords = {
          'ç¾|å®³ç¾|ç¾æ¶©|è„¸çº¢|ç¾çº¢': 'blush, embarrassed, shy',
          'åªš|å¦©åªš|å‹¾äºº|åªšçœ¼': 'seductive, alluring, bedroom eyes',
          'å“­|æ³ª|æµæ³ª|å“­æ³£|æ³ªæµ': 'crying, tears',
          'ç¬‘|å¾®ç¬‘|å‚»ç¬‘|æ·«ç¬‘': 'smiling',
          'å‘»åŸ|å–˜|å–˜æ¯|å¨‡å–˜': 'moaning, panting, ahegao',
          'ç—›|ç—›è‹¦|ç–¼ç—›': 'pain, painful expression',
          'çˆ½|å¿«æ„Ÿ|èˆ’æœ|äº«å—': 'pleasure, enjoying, ecstasy',
          'ææƒ§|å®³æ€•|æƒŠæ': 'fear, scared',
          'æ„¤æ€’|ç”Ÿæ°”|æ€’': 'angry',
          'èŒ«ç„¶|è¿·ç¦»|å¤±ç¥|ææƒš': 'dazed, unfocused eyes, trance',
          'ç¿»ç™½çœ¼|ç™½çœ¼|å¤±ç¥': 'rolling eyes, ahegao',
          'å¼ å˜´|å¼ å¼€å˜´|Oå‹å˜´|å£å‹': 'open mouth, o-face',
          'å’¬å”‡|å’¬å˜´å”‡': 'biting lip',
          'åèˆŒ|ä¼¸èˆŒ': 'tongue out',
        };

        for (const [keywords, tags] of Object.entries(expressionKeywords)) {
          const regex = new RegExp(keywords, 'i');
          if (regex.test(text)) {
            result.expressions.push(tags);
          }
        }

        // ==================== æœè£…çŠ¶æ€æ£€æµ‹ ====================
        const clothingKeywords = {
          'è£¸|å…¨è£¸|èµ¤è£¸|ä¸€ä¸ä¸æŒ‚|å…‰ç€': 'nude, naked, fully nude',
          'åŠè£¸|è¢’èƒ¸|éœ²å‡º': 'partially nude, exposed',
          'å†…è¡£|èƒ¸ç½©|bra|æ–‡èƒ¸': 'bra, lingerie',
          'å†…è£¤|å°å†…å†…|ä¸å­—è£¤': 'panties, underwear, thong',
          'æƒ…è¶£å†…è¡£|æ€§æ„Ÿå†…è¡£': 'sexy lingerie, erotic underwear',
          'ä¸è¢œ|é»‘ä¸|ç™½ä¸|åŠå¸¦è¢œ': 'stockings, thigh highs, garter belt',
          'é«˜è·Ÿ|é«˜è·Ÿé‹': 'high heels',
          'åˆ¶æœ|å¥³ä»†|æŠ¤å£«|å­¦ç”Ÿ': 'uniform, maid outfit, nurse outfit, school uniform',
          'æ——è¢|å’Œæœ|æ±‰æœ': 'qipao, kimono, hanfu',
          'çš®è¡£|çš®é©|latex|ä¹³èƒ¶': 'leather, latex',
          'å›´è£™|åªç©¿å›´è£™': 'apron, naked apron',
          'æ•å¼€|è§£å¼€|æ‹‰å¼€': 'clothes pulled aside, unbuttoned',
          'æ’©èµ·|æ€èµ·|æ‹‰èµ·': 'lifted skirt, pulled up',
          'è„±|è¤ªä¸‹|æ‰¯ä¸‹': 'undressing, clothes removed',
          'æ¹¿é€|æµ¸æ¹¿|é€æ˜': 'wet clothes, see-through',
          'ç ´æŸ|æ’•è£‚|è¡£è¡«ä¸æ•´': 'torn clothes, disheveled',
        };

        for (const [keywords, tags] of Object.entries(clothingKeywords)) {
          const regex = new RegExp(keywords, 'i');
          if (regex.test(text)) {
            result.clothing.push(tags);
            if (['è£¸', 'å…¨è£¸', 'åŠè£¸', 'è¢’èƒ¸', 'éœ²å‡º'].some(k => text.includes(k))) {
              result.isNSFW = true;
            }
          }
        }

        // ==================== é¢å¤–å…ƒç´ æ£€æµ‹ ====================
        const extraKeywords = {
          'ç²¾æ¶²|ç™½æµŠ|æµ“ç¨ |å°„|æº…': 'cum, semen, ejaculation',
          'çˆ±æ¶²|æ·«æ°´|èœœæ¶²|æ¹¿æ¶¦|æ¿¡æ¹¿': 'love juice, wet, dripping',
          'æ±—|æ±—æ°´|æ±—ç |é¦™æ±—': 'sweat, sweaty',
          'å£æ°´|å”¾æ¶²|æ¶': 'saliva, drool',
          'çº¢ç—•|å»ç—•|å’¬ç—•|æŠ“ç—•': 'marks, hickey, bite marks',
          'ç»³|ç»³å­|éº»ç»³|çº¢ç»³': 'rope, shibari',
          'èœ¡çƒ›|èœ¡æ²¹|æ»´èœ¡': 'candle, wax play',
          'å†°å—|å†°': 'ice',
          'çš®é­|é­å­': 'whip',
          'éœ‡åŠ¨æ£’|æŒ‰æ‘©æ£’|è·³è›‹|é“å…·': 'vibrator, dildo, sex toy',
          'é•œå­|ç…§é•œå­': 'mirror',
          'çª—|çª—æˆ·|çª—è¾¹': 'window',
          'æµ´å®¤|æµ´ç¼¸|æ·‹æµ´': 'bathroom, bathtub, shower',
        };

        for (const [keywords, tags] of Object.entries(extraKeywords)) {
          const regex = new RegExp(keywords, 'i');
          if (regex.test(text)) {
            result.extras.push(tags);
            if (['ç²¾æ¶²', 'ç™½æµŠ', 'å°„', 'çˆ±æ¶²', 'æ·«æ°´'].some(k => text.includes(k))) {
              result.isNSFW = true;
            }
          }
        }

        // å»é‡
        result.bodyParts = [...new Set(result.bodyParts)];
        result.actions = [...new Set(result.actions)];
        result.expressions = [...new Set(result.expressions)];
        result.clothing = [...new Set(result.clothing)];
        result.extras = [...new Set(result.extras)];

        // å¦‚æœæ˜¯NSFWåœºæ™¯ä½†æ²¡æ£€æµ‹åˆ°ä»»ä½•NSFWå…ƒç´ ï¼Œæ·»åŠ é»˜è®¤æ ‡ç­¾
        if (isNSFWScene && !result.isNSFW) {
          result.isNSFW = true;
        }

        return result;
      }

      function renderStoryWithAutoImage(storyContainerEl, storyText, characterId, context = {}) {
        if (!storyContainerEl) {
          console.warn('renderStoryWithAutoImage: å®¹å™¨ä¸ºç©º');
          return;
        }
        // è‡ªåŠ¨é…å›¾å§‹ç»ˆå¯ç”¨ï¼ˆå·²ç§»é™¤è®¾ç½®é€‰é¡¹ï¼‰
        const enable = true;

        // ç¡®ä¿è§’è‰²å­˜åœ¨
        if (!characterId || !gameState.è§’è‰²ä»“åº“?.[characterId]) {
          console.warn('renderStoryWithAutoImage: è§’è‰²ä¸å­˜åœ¨:', characterId);
          // ä½¿ç”¨éš”ç¦»å®¹å™¨é˜²æ­¢è§’è‰²å¡æ ·å¼æ±¡æŸ“æ•…äº‹å†…å®¹
          storyContainerEl.innerHTML = `<div class="story-content-isolated" style="
            all: initial;
            display: block;
            font-family: var(--font-serif);
            line-height: 2.05;
            color: var(--text-primary);
            font-size: 16px;
            isolation: isolate;
            contain: layout style paint;
          "><div class="story-content">${storyText}</div></div>`;
          return;
        }

        // æŠŠå‰§æƒ…æ–‡æœ¬ä¼ é€’ç»™ buildAutoImageTagï¼Œç”¨äºåŠ¨æ€åˆ†æç”Ÿæˆç²¾å‡†çš„å›¾ç‰‡æç¤ºè¯
        const contextWithStory = { ...context, storyText: storyText };
        const imageTag = enable ? buildAutoImageTag(characterId, contextWithStory) : '';

        console.info(
          'è‡ªåŠ¨é…å›¾:',
          enable ? 'å¯ç”¨' : 'ç¦ç”¨',
          '| è§’è‰²:',
          characterId,
          '| å›¾ç‰‡æ ‡ç­¾:',
          imageTag ? imageTag.substring(0, 120) + '...' : '(æ— )',
        );

        // æ£€æŸ¥ formatAsDisplayedMessage æ˜¯å¦å¯ç”¨
        if (!imageTag) {
          console.warn('renderStoryWithAutoImage: æ— æ³•ç”Ÿæˆå›¾ç‰‡æ ‡ç­¾');
        } else if (typeof formatAsDisplayedMessage === 'undefined') {
          console.warn('renderStoryWithAutoImage: formatAsDisplayedMessage æœªå®šä¹‰ï¼Œå°†å›é€€åˆ°å ä½ç¬¦æ¨¡å¼');
        }

        const imgBlock = imageTag
          ? `
                  <div
                    class="image-prompt-area"
                    style="
                      display: block;
                      min-height: 50px;
                      margin: 0 0 14px 0;
                      padding: 10px;
                      border-radius: 16px;
                      border: 1px solid rgba(255,255,255,0.12);
                      background: rgba(255,255,255,0.04);
                      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
                    "
                  ></div>
                `
          : '';

        // ä½¿ç”¨éš”ç¦»å®¹å™¨é˜²æ­¢è§’è‰²å¡æ ·å¼æ±¡æŸ“æ•…äº‹å†…å®¹
        storyContainerEl.innerHTML = `${imgBlock}<div class="story-content-isolated" style="
          all: initial;
          display: block;
          font-family: var(--font-serif);
          line-height: 2.05;
          color: var(--text-primary);
          font-size: 16px;
          isolation: isolate;
          contain: layout style paint;
        "><div class="story-content">${storyText}</div></div>`;

        if (imageTag) {
          const imgEl = storyContainerEl.querySelector('.image-prompt-area');
          if (imgEl) {
            // å¿…é¡»ï¼šdisplay:block, min-height:50px, ä¸¥ç¦ overflow:hiddenï¼ˆè¿™é‡Œä¸è®¾ç½®overflowï¼‰
            // å…ˆèµ° image### åŸç”Ÿæ¸²æŸ“ï¼›å¤±è´¥/è¶…æ—¶å† /imagine å¼ºåˆ¶ç”Ÿå›¾
            void renderImageTagNativeFirst(imageTag, imgEl, { fallbackAfterMs: 20000 });
          } else {
            console.warn('renderStoryWithAutoImage: æ‰¾ä¸åˆ° .image-prompt-area å…ƒç´ ');
          }
        }
      }

      const specialSceneDefs = [
        { key: 'aff_70', title: 'ç§å¯†é‚€çº¦', req: 'å¥½æ„Ÿâ‰¥70', flavor: 'ä½è¯­ã€çƒ›å…‰ã€è¿‘è·ç¦»çš„è¯•æ¢ã€‚' },
        { key: 'aff_90', title: 'èª“çº¦æ—¶åˆ»', req: 'å¥½æ„Ÿâ‰¥90', flavor: 'äº¤æ¢èª“è¨€ä¸ç§˜å¯†ï¼Œå…³ç³»è¿›å…¥æ›´æ·±å±‚ã€‚' },
        { key: 'hate_70', title: 'æš—æ½®åå™¬', req: 'æ¨æ„â‰¥70', flavor: 'æ²‰é»˜çš„åå™¬ä¸å±é™©çš„æ‹‰æ‰¯ã€‚' },
        { key: 'hate_90', title: 'è£‚éš™é€ƒäº¡', req: 'æ¨æ„â‰¥90', flavor: 'å…³ç³»æ¿’ä¸´å´©åï¼Œå¿…é¡»åšå‡ºé€‰æ‹©ã€‚' },
      ];

      function playSpecialScene(characterId, sceneKey) {
        const char = gameState.è§’è‰²ä»“åº“?.[characterId];
        if (!char) return;
        normalizeCharacter(char);
        if (!char.å·²è§£é”å‰§æƒ…?.[sceneKey]) {
          alert('è¯¥å‰§æƒ…å°šæœªè§£é”ã€‚');
          return;
        }
        const def = specialSceneDefs.find(s => s.key === sceneKey);
        if (!def) return;

        window._lastSpecialScene = { characterId, sceneKey, title: def.title, atRound: getGameTime().å½“å‰å›åˆ || 1 };

        const extra = `ã€ç‰¹æ®Šå‰§æƒ…ï¼š${def.title}ã€‘\nè§¦å‘æ¡ä»¶ï¼š${def.req}\næ°›å›´æç¤ºï¼š${def.flavor}\n\nè¦æ±‚ï¼šæˆäººå‘æ°›å›´ä½†å¿…é¡»ä¸ºã€æˆå¹´äººåˆæ„ã€‘ä¸”ä¸åŒ…å«å¼ºè¿«/æ€§ä¾µ/æœªæˆå¹´/è¡€è…¥çŒå¥‡ç­‰ã€‚å¿…è¦æ—¶å¯ç”¨JSONPatchå¾®è°ƒå¥½æ„Ÿåº¦/æ¨æ„ï¼ˆ0~100ï¼‰ã€‚`;
        // å¤ç”¨â€œç‰¹æ®Šäº’åŠ¨â€ï¼Œå¹¶é™„åŠ æŒ‡ä»¤ï¼ˆstartInteraction ä¼šè¿½åŠ  customCommandï¼‰
        startInteraction(characterId, 'ç‰¹æ®Šäº’åŠ¨', extra);
      }

      async function assignCharacterToBrothel(id) {
        const char = gameState.è§’è‰²ä»“åº“[id];
        if (!char) return;

        // æŸ¥æ‰¾ç©ºé—²æˆ¿é—´ï¼ˆæ’é™¤è°ƒæ•™å®¤ï¼‰
        const availableRooms = Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€)
          .filter(([_, room]) => room.çŠ¶æ€ === 'ç©ºé—²' && room.ç±»å‹ !== 'è°ƒæ•™å®¤')
          .map(([roomId, _]) => roomId);

        if (availableRooms.length === 0) {
          alert('æ²¡æœ‰ç©ºé—²æˆ¿é—´ï¼');
          return;
        }

        // è®©ç”¨æˆ·é€‰æ‹©æˆ¿é—´
        const roomId = prompt(`é€‰æ‹©æˆ¿é—´åˆ†é…ç»™ ${char.å§“å}\nå¯ç”¨æˆ¿é—´: ${availableRooms.join(', ')}`, availableRooms[0]);

        if (!roomId || !availableRooms.includes(roomId)) {
          return;
        }

        closeCharacterDetail();

        // ç›´æ¥è°ƒç”¨åˆ†é…å‡½æ•°
        await assignCharacterToRoom(id, roomId);
      }

      function trainCharacter(id) {
        startInteraction(id, 'è°ƒæ•™');
      }

      function decomposeCharacter(id) {
        const char = gameState.è§’è‰²ä»“åº“[id];
        if (!char) return;

        // æ£€æŸ¥è§’è‰²æ˜¯å¦æ­£åœ¨ä½¿ç”¨ä¸­
        if (char.çŠ¶æ€ === 'æ¥å®¢ä¸­' || char.çŠ¶æ€ === 'è°ƒæ•™ä¸­') {
          alert(`è§’è‰² ${char.å§“å} æ­£åœ¨${char.çŠ¶æ€ === 'æ¥å®¢ä¸­' ? 'æ¥å®¢' : 'è°ƒæ•™'}ä¸­ï¼Œæ— æ³•åˆ†è§£`);
          return;
        }

        if (confirm(`ç¡®å®šè¦åˆ†è§£ ${char.å§“å} å—ï¼Ÿå°†è·å¾—è´§å¸å¥–åŠ±ã€‚`)) {
          // è®¡ç®—åˆ†è§£å¥–åŠ±ï¼ˆæ ¹æ®ç¨€æœ‰åº¦å’Œç­‰çº§ï¼‰
          const rarityValue = { N: 50, R: 100, SR: 250, SSR: 500 };
          const baseReward = rarityValue[char.ç¨€æœ‰åº¦] || 50;
          const levelBonus = (char.ç­‰çº§ || 1) * 10;
          const reward = baseReward + levelBonus;

          // æ·»åŠ è´§å¸
          gameState.è´§å¸ += reward;

          // åˆ é™¤è§’è‰²
          delete gameState.è§’è‰²ä»“åº“[id];

          // æ¸…ç†ç›¸å…³æ•°æ®
          if (gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[id]) {
            delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[id];
          }
          if (gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[id]) {
            delete gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²[id];
          }

          // æ¸…ç†æˆ¿é—´ä¸­çš„è§’è‰²
          Object.values(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€ || {}).forEach(room => {
            if (room.å½“å‰è§’è‰² === id) {
              room.å½“å‰è§’è‰² = undefined;
              room.çŠ¶æ€ = 'ç©ºé—²';
            }
          });

          // æ›´æ–°ç»Ÿè®¡æ•°æ®
          if (gameState.ç»Ÿè®¡æ•°æ®) {
            gameState.ç»Ÿè®¡æ•°æ®.è§’è‰²åˆ†å¸ƒ[char.ç¨€æœ‰åº¦] = Math.max(0, (gameState.ç»Ÿè®¡æ•°æ®.è§’è‰²åˆ†å¸ƒ[char.ç¨€æœ‰åº¦] || 0) - 1);
          }

          saveImmediately(); // åˆ†è§£è§’è‰²æ˜¯å…³é”®æ“ä½œï¼Œç«‹å³ä¿å­˜
          refreshAllPages();
          closeCharacterDetail();

          if (typeof toastr !== 'undefined') {
            toastr.success(`åˆ†è§£ ${char.å§“å} æˆåŠŸï¼Œè·å¾— ${reward} é‡‘`);
          } else {
            alert(`åˆ†è§£ ${char.å§“å} æˆåŠŸï¼Œè·å¾— ${reward} é‡‘`);
          }
        }
      }

      function selectCharacterForRoom(id) {
        const rooms = Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€)
          .filter(([_, room]) => room.çŠ¶æ€ === 'ç©ºé—²' && room.ç±»å‹ !== 'è°ƒæ•™å®¤')
          .map(([roomId, _]) => roomId);

        if (rooms.length === 0) {
          alert('æ²¡æœ‰ç©ºé—²æˆ¿é—´ï¼');
          return;
        }

        const roomId = prompt(`é€‰æ‹©æˆ¿é—´ (${rooms.join(', ')})`, rooms[0]);
        if (roomId && rooms.includes(roomId)) {
          assignCharacterToRoom(id, roomId);
        }
      }

      function showRoomAssignment(roomId) {
        const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[roomId];
        if (!room) return;
        if (room.ç±»å‹ === 'è°ƒæ•™å®¤') {
          openTrainingAssignment(roomId);
          return;
        }
        if (room.çŠ¶æ€ !== 'ç©ºé—²') {
          alert('æˆ¿é—´æ­£åœ¨ä½¿ç”¨ä¸­ã€‚');
          return;
        }
        // æ˜¾ç¤ºå¯åˆ†é…çš„è§’è‰²åˆ—è¡¨
        const availableChars = Object.entries(gameState.è§’è‰²ä»“åº“)
          .filter(([id, char]) => char.çŠ¶æ€ === 'ç©ºé—²' && char.å½“å‰ä½ç½® === 'ä»“åº“')
          .map(([id, char]) => ({ id, name: char.å§“å }));

        if (availableChars.length === 0) {
          alert('æ²¡æœ‰å¯åˆ†é…çš„è§’è‰²ï¼');
          return;
        }

        const charList = availableChars.map((c, i) => `${i + 1}. ${c.name} (${c.id})`).join('\n');
        const choice = prompt(`é€‰æ‹©è¦åˆ†é…åˆ°æˆ¿é—´ ${roomId} çš„è§’è‰²ï¼š\n\n${charList}\n\nè¯·è¾“å…¥è§’è‰²IDæˆ–åºå·ï¼š`);

        if (!choice) return;

        let selectedId = null;
        const choiceNum = parseInt(choice);
        if (!isNaN(choiceNum) && choiceNum > 0 && choiceNum <= availableChars.length) {
          selectedId = availableChars[choiceNum - 1].id;
        } else {
          selectedId = availableChars.find(c => c.id === choice || c.name === choice)?.id;
        }

        if (selectedId) {
          assignCharacterToRoom(selectedId, roomId);
        } else {
          alert('æ— æ•ˆçš„é€‰æ‹©ï¼');
        }
      }

      function assignCharacterToRoom(characterId, roomId) {
        const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[roomId];
        const char = gameState.è§’è‰²ä»“åº“?.[characterId];
        if (!room || !char) return;

        if (room.ç±»å‹ === 'è°ƒæ•™å®¤') {
          // è°ƒæ•™å®¤èµ°ä¸“ç”¨æµç¨‹ï¼ˆéœ€è¦é€‰è¯¾ç¨‹ï¼‰
          openTrainingAssignment(roomId);
          return;
        }

        if (room.çŠ¶æ€ !== 'ç©ºé—²') {
          alert('æˆ¿é—´æ­£åœ¨ä½¿ç”¨ä¸­ï¼Œæ— æ³•åˆ†é…ã€‚');
          return;
        }

        const gameTime = getGameTime();
        // ä½¿ç”¨æœ¬åœ°è§„åˆ™åˆ†é…ï¼ˆä¸è°ƒç”¨ AIï¼‰ï¼Œå¹¶ç”±ä¸‹ä¸€å›åˆç»“ç®—
        batchAssignLocal(roomId, characterId, gameTime.å½“å‰å›åˆ || 1);

        const storyContent = document.getElementById('brothel-story-content');
        if (storyContent) {
          let msg = `âœ… å·²åˆ†é…ï¼š${char.å§“å} â†’ æˆ¿é—´ ${roomId}ï¼ˆ${room.ç±»å‹}ï¼‰ã€‚\n\næç¤ºï¼šç‚¹å‡»â€œæŸ¥çœ‹å‰§æƒ…â€å°†è°ƒç”¨ AI ç”Ÿæˆæœ¬æ¬¡å‰§æƒ…ï¼Œå¹¶è®¡ä¸º 1 å›åˆã€‚`;
          if (typeof formatAsDisplayedMessage !== 'undefined') msg = formatAsDisplayedMessage(msg);
          renderStoryWithAutoImage(storyContent, msg, characterId, { scene: 'å¼€å§‹', roomType: room.ç±»å‹ });
        }

        saveImmediately(); // åˆ†é…è§’è‰²æ˜¯å…³é”®æ“ä½œï¼Œç«‹å³ä¿å­˜
        refreshAllPages();
      }

      async function showRoomDetail(roomId) {
        const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[roomId];
        if (!room) {
          alert(`æˆ¿é—´ ${roomId} ä¸å­˜åœ¨`);
          return;
        }

        // ==================== å…³é”®ä¿®å¤ï¼šå…ˆæ£€æŸ¥å¹¶å®Œæˆæ‰€æœ‰åˆ°æœŸçš„æ¥å®¢ ====================
        // æ— è®ºæ˜¯å¦æ¨è¿›å›åˆï¼Œéƒ½è¦å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ¥å®¢åˆ°æœŸï¼Œç¡®ä¿æ¥å®¢èƒ½åŠæ—¶å®Œæˆ
        processGameSettlement();

        // é™é»˜ä¿®å¤çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜
        let needRefresh = false;

        // æƒ…å†µ1ï¼šæˆ¿é—´çŠ¶æ€æ˜¾ç¤ºå ç”¨ä½†å®é™…æ²¡æœ‰è§’è‰²
        if (room.çŠ¶æ€ === 'ä½¿ç”¨ä¸­' && !room.å½“å‰è§’è‰²) {
          console.warn(`é™é»˜ä¿®å¤æˆ¿é—´ ${roomId}ï¼šçŠ¶æ€ä¸º"ä½¿ç”¨ä¸­"ä½†æ— è§’è‰²ï¼Œé‡ç½®ä¸ºç©ºé—²`);
          room.çŠ¶æ€ = 'ç©ºé—²';
          needRefresh = true;
        }

        // æƒ…å†µ2ï¼šæˆ¿é—´æœ‰è§’è‰²ä½†è§’è‰²ä¸å­˜åœ¨
        if (room.å½“å‰è§’è‰² && !gameState.è§’è‰²ä»“åº“?.[room.å½“å‰è§’è‰²]) {
          console.warn(`é™é»˜ä¿®å¤æˆ¿é—´ ${roomId}ï¼šè§’è‰² ${room.å½“å‰è§’è‰²} ä¸å­˜åœ¨ï¼Œæ¸…ç†æˆ¿é—´`);
          room.çŠ¶æ€ = 'ç©ºé—²';
          room.å½“å‰è§’è‰² = undefined;
          delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[room.å½“å‰è§’è‰²];
          needRefresh = true;
        }

        // æƒ…å†µ3ï¼šæ£€æŸ¥æˆ¿é—´ä¸­çš„è§’è‰²æ˜¯å¦åº”è¯¥å®Œæˆæ¥å®¢ï¼ˆå…³é”®ä¿®å¤ï¼‰
        if (room.å½“å‰è§’è‰² && gameState.è§’è‰²ä»“åº“?.[room.å½“å‰è§’è‰²]) {
          const char = gameState.è§’è‰²ä»“åº“[room.å½“å‰è§’è‰²];
          const workingInfo = gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[room.å½“å‰è§’è‰²];
          if (workingInfo) {
            const gameTime = getGameTime();
            const startRound = workingInfo.å¼€å§‹å›åˆ || gameTime.å½“å‰å›åˆ - 1;
            const endRound = workingInfo.é¢„è®¡ç»“æŸå›åˆ || startRound + 2;
            // å¦‚æœå·²ç»è¿‡äº†é¢„è®¡ç»“æŸå›åˆï¼Œç«‹å³å®Œæˆæ¥å®¢
            if (gameTime.å½“å‰å›åˆ >= endRound) {
              console.info(
                `æ£€æµ‹åˆ°è§’è‰² ${char.å§“å} æ¥å®¢å·²åˆ°æœŸï¼ˆå¼€å§‹å›åˆ: ${startRound}, é¢„è®¡ç»“æŸå›åˆ: ${endRound}, å½“å‰å›åˆ: ${gameTime.å½“å‰å›åˆ}ï¼‰ï¼Œç«‹å³å®Œæˆ`,
              );
              completeWorkingService(room.å½“å‰è§’è‰²);
              needRefresh = true;
            }
          }
        }

        if (needRefresh) {
          saveGameStateToMVU();
          refreshAllPages();
          // å¦‚æœæ¥å®¢å·²å®Œæˆï¼Œç›´æ¥è¿”å›ï¼Œä¸ç”Ÿæˆå‰§æƒ…
          if (!room.å½“å‰è§’è‰² || room.çŠ¶æ€ === 'ç©ºé—²') {
            return;
          }
        }

        // é‡æ–°è·å–ï¼ˆå¯èƒ½å·²è¢«ä¿®å¤æˆ–å®Œæˆï¼‰
        const char = room.å½“å‰è§’è‰² ? gameState.è§’è‰²ä»“åº“[room.å½“å‰è§’è‰²] : null;
        let workingInfo = room.å½“å‰è§’è‰² ? gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[room.å½“å‰è§’è‰²] : null;

        // è°ƒæ•™å®¤ï¼šæŸ¥çœ‹è®­ç»ƒå‰§æƒ…
        if (room?.ç±»å‹ === 'è°ƒæ•™å®¤') {
          return showTrainingRoomDetail(roomId);
        }

        if (char) {
          // é™é»˜ç¡®ä¿è§’è‰²çŠ¶æ€æ­£ç¡®
          if (char.çŠ¶æ€ !== 'æ¥å®¢ä¸­' && char.çŠ¶æ€ !== 'è°ƒæ•™ä¸­') {
            char.çŠ¶æ€ = 'æ¥å®¢ä¸­';
          }
          if (char.å½“å‰ä½ç½® !== 'å¦“é™¢') {
            char.å½“å‰ä½ç½® = 'å¦“é™¢';
          }

          // å¦‚æœè§’è‰²åœ¨æˆ¿é—´ä¸­ä½†æ²¡æœ‰workingInfoï¼Œåˆ›å»ºå®ƒï¼ˆé˜²æ­¢çŠ¶æ€ä¸ä¸€è‡´ï¼‰
          // æˆ–è€…å¦‚æœworkingInfoå­˜åœ¨ä½†å·²è¿‡æœŸï¼Œé‡æ–°åˆ›å»ºï¼ˆé˜²æ­¢ä½¿ç”¨æ—§çš„è¿‡æœŸä¿¡æ¯ï¼‰
          const gameTime = getGameTime();
          const currentRound = gameTime.å½“å‰å›åˆ || 1;
          if (!workingInfo && room.çŠ¶æ€ === 'ä½¿ç”¨ä¸­') {
            workingInfo = createWorkingInfoLocal(char, room, currentRound);
            gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[room.å½“å‰è§’è‰²] = workingInfo;
            console.info(`ä¸ºè§’è‰² ${char.å§“å} åˆ›å»ºæ¥å®¢ä¿¡æ¯ï¼ˆæˆ¿é—´ ${roomId}ï¼Œå¼€å§‹å›åˆ: ${currentRound}ï¼‰`);
          } else if (workingInfo) {
            // æ£€æŸ¥workingInfoæ˜¯å¦å·²è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™é‡æ–°åˆ›å»º
            const startRound = workingInfo.å¼€å§‹å›åˆ || currentRound - 1;
            const endRound = workingInfo.é¢„è®¡ç»“æŸå›åˆ || startRound + 2;
            if (currentRound >= endRound) {
              console.warn(
                `æ£€æµ‹åˆ°è§’è‰² ${char.å§“å} çš„æ¥å®¢ä¿¡æ¯å·²è¿‡æœŸï¼ˆå¼€å§‹å›åˆ: ${startRound}, é¢„è®¡ç»“æŸå›åˆ: ${endRound}, å½“å‰å›åˆ: ${currentRound}ï¼‰ï¼Œé‡æ–°åˆ›å»º`,
              );
              // å…ˆå®Œæˆæ—§çš„æ¥å®¢ï¼ˆå¦‚æœæœ‰ï¼‰
              if (gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[room.å½“å‰è§’è‰²]) {
                completeWorkingService(room.å½“å‰è§’è‰²);
              }
              // é‡æ–°åˆ›å»ºæ¥å®¢ä¿¡æ¯
              workingInfo = createWorkingInfoLocal(char, room, currentRound);
              gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[room.å½“å‰è§’è‰²] = workingInfo;
              console.info(`ä¸ºè§’è‰² ${char.å§“å} é‡æ–°åˆ›å»ºæ¥å®¢ä¿¡æ¯ï¼ˆæˆ¿é—´ ${roomId}ï¼Œå¼€å§‹å›åˆ: ${currentRound}ï¼‰`);
            }
          }
          const storyContent = document.getElementById('brothel-story-content');
          if (storyContent) {
            storyContent.innerHTML = '<div class="story-loading">â³ AI æ­£åœ¨ç”Ÿæˆæ¥å®¢å‰§æƒ…ï¼Œè¯·ç¨å€™...</div>';
          }

          // è®°å½•å±æ€§åˆå§‹å€¼ï¼ˆç”¨äºæ˜¾ç¤ºå˜åŒ–ï¼‰
          normalizeCharacter(char);
          const prevAttrs = {
            é­…åŠ›: char.å±æ€§?.é­…åŠ› || 0,
            é¡ºä»: char.å±æ€§?.é¡ºä» || 0,
            æŠ€å·§: char.å±æ€§?.æŠ€å·§ || 0,
            è€åŠ›: char.å±æ€§?.è€åŠ› || 0,
            æ•æ„Ÿåº¦: char.å±æ€§?.æ•æ„Ÿåº¦ || 0,
          };
          const prevLike = char.å¥½æ„Ÿåº¦ || 0;
          const prevHate = char.æ¨æ„ || 0;

          // å¦‚æœæœ‰æ¥å®¢ä¿¡æ¯ï¼Œæ˜¾ç¤ºå½“å‰çŠ¶æ€
          let statusInfo = '';
          let roomSpecialInfo = '';
          if (workingInfo) {
            const startRound = workingInfo.å¼€å§‹å›åˆ || getGameTime().å½“å‰å›åˆ;
            const endRound = workingInfo.é¢„è®¡ç»“æŸå›åˆ || startRound + 2;
            const remain = Math.max(0, endRound - (getGameTime().å½“å‰å›åˆ || 1));
            statusInfo = `å¼€å§‹å›åˆ: ${startRound}\né¢„è®¡ç»“æŸå›åˆ: ${endRound}\nå‰©ä½™å›åˆ: ${remain}\nå®¢æˆ·ç±»å‹: ${workingInfo.å®¢æˆ·ç±»å‹}\nå®¢æˆ·æ•°é‡: ${workingInfo.å®¢æˆ·æ•°é‡ || 1}\næœåŠ¡ç±»å‹: ${workingInfo.æœåŠ¡ç±»å‹.join(', ')}\n`;

            // æ ¹æ®æˆ¿é—´ç±»å‹æ·»åŠ ç‰¹æ®Šè¯´æ˜
            const specialEffects = workingInfo.ç‰¹æ®Šæ•ˆæœ || {};
            if (room.ç±»å‹ === 'æ™®é€š') {
              roomSpecialInfo = `\nã€æˆ¿é—´ç‰¹è‰²ï¼šå¿«é€ŸæœåŠ¡ã€‘è¿™æ˜¯æ™®é€šæˆ¿é—´ï¼ŒæœåŠ¡æ—¶é—´çŸ­ï¼ˆ1å›åˆå®Œæˆï¼‰ï¼Œé€‚åˆå¿«é€Ÿå‘¨è½¬ã€‚å‰§æƒ…åº”ä½“ç°é«˜æ•ˆã€ç®€æ´çš„æœåŠ¡è¿‡ç¨‹ã€‚`;
            } else if (room.ç±»å‹ === 'VIP') {
              roomSpecialInfo = `\nã€æˆ¿é—´ç‰¹è‰²ï¼šé•¿æœŸåŒ…æˆ¿ã€‘è¿™æ˜¯VIPæˆ¿é—´ï¼Œå®¢æˆ·ä¼šè¿ç»­${endRound - startRound}å›åˆæ¶ˆè´¹ï¼Œå±äºé•¿æœŸåŒ…æˆ¿æœåŠ¡ã€‚å‰§æƒ…åº”ä½“ç°VIPå®¢æˆ·çš„å°Šè´µèº«ä»½ã€å®šåˆ¶åŒ–æœåŠ¡ã€æŒç»­æ€§çš„æ·±åº¦äº’åŠ¨ã€‚æ¯å›åˆå‰§æƒ…åº”æœ‰å…³è”æ€§ï¼Œå±•ç°æœåŠ¡è¿‡ç¨‹çš„é€’è¿›ã€‚`;
            } else if (room.ç±»å‹ === 'å±•ç¤ºå®¤') {
              roomSpecialInfo = `\nã€æˆ¿é—´ç‰¹è‰²ï¼šå…¬å¼€è¡¨æ¼”ã€‘è¿™æ˜¯å±•ç¤ºå®¤ï¼Œä¸€æ¬¡æœåŠ¡${workingInfo.å®¢æˆ·æ•°é‡ || 1}ä¸ªå®¢æˆ·ï¼Œå±äºå…¬å¼€è¡¨æ¼”æ€§è´¨ã€‚å‰§æƒ…åº”ä½“ç°èˆå°æ„Ÿã€è¡¨æ¼”æ€§ã€å¤šå®¢æˆ·äº’åŠ¨ã€è§’è‰²é­…åŠ›çš„å±•ç¤ºã€‚å¯ä»¥æè¿°è§‚ä¼—çš„åé¦ˆã€èˆå°æ°›å›´ã€è¡¨æ¼”æŠ€å·§ç­‰ã€‚`;
            } else if (room.ç±»å‹ === 'æƒ…è¶£æˆ¿') {
              roomSpecialInfo = `\nã€æˆ¿é—´ç‰¹è‰²ï¼šæé™æŒ‘æˆ˜ã€‘è¿™æ˜¯æƒ…è¶£æˆ¿ï¼Œæä¾›æé™æŒ‘æˆ˜æœåŠ¡ã€‚å‰§æƒ…åº”ä½“ç°é«˜å¼ºåº¦ã€ç‰¹æ®Šç©æ³•ã€æé™ä½“éªŒã€‚å¯ä»¥åŒ…å«æ›´åˆºæ¿€ã€æ›´æ·±å…¥çš„ç©æ³•æè¿°ï¼Œä½†å¿…é¡»ç¬¦åˆæˆäººå‘å®¡ç¾ï¼Œä¸èƒ½å‡ºç°é»‘åå•å†…å®¹ã€‚`;
            }
          }

          // æ„å»ºèŠå¤©ä¸Šä¸‹æ–‡
          const chatContext =
            char.èŠå¤©è®°å½• && Array.isArray(char.èŠå¤©è®°å½•) && char.èŠå¤©è®°å½•.length > 0
              ? `\n\nè§’è‰²ä¸ä½ çš„èŠå¤©è®°å½•ï¼ˆè§’è‰²ä¼šè®°å¾—è¿™äº›ï¼‰ï¼š\n${char.èŠå¤©è®°å½•
                  .filter(msg => msg && msg.role && msg.content)
                  .slice(-5)
                  .map(msg => `${msg.role === 'user' ? 'ä½ ' : char.å§“å}: ${msg.content}`)
                  .join('\n')}`
              : '';
          const summaryContext = char.èŠå¤©æ‘˜è¦ ? `\n\nä¹‹å‰çš„èŠå¤©æ‘˜è¦ï¼š${char.èŠå¤©æ‘˜è¦}` : '';

          const command = `ã€å‰§æƒ…ç”Ÿæˆæ¨¡å¼ã€‘è¿™æ˜¯çº¯æ–‡æœ¬å‰§æƒ…ç”Ÿæˆï¼Œä¸æ˜¯è§’è‰²å¡ç”Ÿæˆã€‚
ç»å¯¹ç¦æ­¢ï¼šä¸è¦è¾“å‡ºä»»ä½•HTMLä»£ç ã€ä¸è¦è¾“å‡ºä»£ç å—ã€ä¸è¦è¾“å‡º<think>/<analysis>æ€ç»´é“¾ã€‚
åªè¾“å‡ºï¼šçº¯æ–‡æœ¬å‰§æƒ… + <JSONPatch>æ›´æ–°</JSONPatch>

è§’è‰²${room.å½“å‰è§’è‰²}ï¼ˆ${char.å§“å}ï¼‰åœ¨æˆ¿é—´${roomId}ï¼ˆ${room.ç±»å‹}ï¼‰ä¸­ç»§ç»­æ¥å®¢ã€‚${statusInfo}${roomSpecialInfo}${chatContext}${summaryContext}

è¯·ç”Ÿæˆè¯¦ç»†çš„æ¥å®¢å‰§æƒ…ï¼ŒåŒ…æ‹¬æœåŠ¡è¿‡ç¨‹ã€å®¢æˆ·ååº”ã€è§’è‰²çŠ¶æ€å˜åŒ–ã€æ”¶å…¥ç­‰ã€‚å‰§æƒ…åº”ä½“ç°${room.ç±»å‹}æˆ¿é—´çš„ç‰¹è‰²å’Œç©æ³•ã€‚è§’è‰²ä¼šè®°å¾—ä¸ä½ çš„èŠå¤©å†…å®¹ã€‚

ã€é‡è¦é™åˆ¶ã€‘åœ¨JSONPatchä¸­ï¼š
- ä¿æŒè§’è‰²çŠ¶æ€ä¸º"æ¥å®¢ä¸­"ï¼Œæˆ¿é—´çŠ¶æ€ä¸º"ä½¿ç”¨ä¸­"
- **ç»å¯¹ç¦æ­¢ä¿®æ”¹**ä»¥ä¸‹å­—æ®µï¼ˆè¿™äº›å­—æ®µç”±ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ï¼‰ï¼š
  * å¦“é™¢.å½“å‰æ¥å®¢è§’è‰².${room.å½“å‰è§’è‰²}.å¼€å§‹å›åˆ
  * å¦“é™¢.å½“å‰æ¥å®¢è§’è‰².${room.å½“å‰è§’è‰²}.é¢„è®¡ç»“æŸå›åˆ
  * å¦“é™¢.æˆ¿é—´çŠ¶æ€.${roomId}.çŠ¶æ€ï¼ˆå¿…é¡»ä¿æŒ"ä½¿ç”¨ä¸­"ï¼‰
  * å¦“é™¢.æˆ¿é—´çŠ¶æ€.${roomId}.å½“å‰è§’è‰²ï¼ˆä¸èƒ½æ¸…ç©ºï¼‰
- åªèƒ½æ›´æ–°è§’è‰²çš„å±æ€§ã€æƒ…æ„ŸçŠ¶æ€ç­‰ï¼Œä¸èƒ½ä¿®æ”¹æ¥å®¢æ—¶é—´ç›¸å…³å­—æ®µ`;

          try {
            // skipAutoRound=trueï¼Œå› ä¸ºæˆ‘ä»¬ä¼šè‡ªå·±å¤„ç†å“åº”å’Œæ¨è¿›å›åˆ
            const response = await sendCommandToAI(command, true);

            if (response && storyContent) {
              let storyText = response;
              const jsonPatchMatch = storyText.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/);
              if (jsonPatchMatch) {
                try {
                  const patches = JSON.parse(cleanJsonString(jsonPatchMatch[1]));
                  applyJSONPatches(patches);
                } catch (error) {
                  console.error('è§£æ JSON Patch å¤±è´¥:', error);
                }
                storyText = storyText.replace(/<JSONPatch>[\s\S]*?<\/JSONPatch>/, '').trim();
              }
              storyText = storyText.replace(/<UpdateVariable>[\s\S]*?<\/UpdateVariable>/, '').trim();
              storyText = storyText.replace(/<Analysis>[\s\S]*?<\/Analysis>/, '').trim();

              // è¿‡æ»¤æ‰AIé”™è¯¯è¾“å‡ºçš„HTMLä»£ç 
              storyText = filterHtmlFromStory(storyText);

              // ==================== å…³é”®ä¿®å¤ï¼šç¡®ä¿æ¥å®¢æ—¶é—´å­—æ®µæ²¡æœ‰è¢«AIé”™è¯¯ä¿®æ”¹ ====================
              // åœ¨åº”ç”¨JSONPatchåï¼Œç«‹å³æ£€æŸ¥å¹¶ä¿®å¤æ¥å®¢æ—¶é—´å­—æ®µ
              const currentWorkingInfo = gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[room.å½“å‰è§’è‰²];
              if (currentWorkingInfo && workingInfo) {
                // å¦‚æœAIé”™è¯¯ä¿®æ”¹äº†å¼€å§‹å›åˆæˆ–é¢„è®¡ç»“æŸå›åˆï¼Œæ¢å¤åŸå§‹å€¼
                const originalStartRound = workingInfo.å¼€å§‹å›åˆ;
                const originalEndRound = workingInfo.é¢„è®¡ç»“æŸå›åˆ;

                if (currentWorkingInfo.å¼€å§‹å›åˆ !== originalStartRound) {
                  console.warn(
                    `ä¿®å¤ï¼šAIé”™è¯¯ä¿®æ”¹äº†è§’è‰² ${char.å§“å} çš„å¼€å§‹å›åˆï¼ˆ${currentWorkingInfo.å¼€å§‹å›åˆ} -> ${originalStartRound}ï¼‰ï¼Œå·²æ¢å¤`,
                  );
                  currentWorkingInfo.å¼€å§‹å›åˆ = originalStartRound;
                }

                if (currentWorkingInfo.é¢„è®¡ç»“æŸå›åˆ !== originalEndRound) {
                  console.warn(
                    `ä¿®å¤ï¼šAIé”™è¯¯ä¿®æ”¹äº†è§’è‰² ${char.å§“å} çš„é¢„è®¡ç»“æŸå›åˆï¼ˆ${currentWorkingInfo.é¢„è®¡ç»“æŸå›åˆ} -> ${originalEndRound}ï¼‰ï¼Œå·²æ¢å¤`,
                  );
                  currentWorkingInfo.é¢„è®¡ç»“æŸå›åˆ = originalEndRound;
                }
              }

              // ä¿æŠ¤ï¼šç¡®ä¿æˆ¿é—´çŠ¶æ€æ­£ç¡®ï¼ˆå¦‚æœæˆ¿é—´æœ‰è§’è‰²ï¼ŒçŠ¶æ€å¿…é¡»æ˜¯"ä½¿ç”¨ä¸­"ï¼‰
              const currentRoom = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[roomId];
              if (currentRoom && currentRoom.å½“å‰è§’è‰²) {
                if (currentRoom.çŠ¶æ€ !== 'ä½¿ç”¨ä¸­') {
                  console.warn(`ä¿®å¤æˆ¿é—´ ${roomId} çŠ¶æ€ï¼šä»"${currentRoom.çŠ¶æ€}"æ”¹ä¸º"ä½¿ç”¨ä¸­"`);
                  currentRoom.çŠ¶æ€ = 'ä½¿ç”¨ä¸­';
                }
                const currentChar = gameState.è§’è‰²ä»“åº“[currentRoom.å½“å‰è§’è‰²];
                if (currentChar && currentChar.çŠ¶æ€ !== 'æ¥å®¢ä¸­' && currentChar.çŠ¶æ€ !== 'è°ƒæ•™ä¸­') {
                  // æ ¹æ®æˆ¿é—´ç±»å‹è®¾ç½®è§’è‰²çŠ¶æ€
                  if (currentRoom.ç±»å‹ === 'è°ƒæ•™å®¤') {
                    currentChar.çŠ¶æ€ = 'è°ƒæ•™ä¸­';
                  } else {
                    currentChar.çŠ¶æ€ = 'æ¥å®¢ä¸­';
                  }
                }
                saveGameStateToMVU();
              }

              // è®¡ç®—å±æ€§å˜åŒ–å¹¶æ˜¾ç¤º
              normalizeCharacter(char);
              const attrChanges = [];
              const newAttrs = {
                é­…åŠ›: char.å±æ€§?.é­…åŠ› || 0,
                é¡ºä»: char.å±æ€§?.é¡ºä» || 0,
                æŠ€å·§: char.å±æ€§?.æŠ€å·§ || 0,
                è€åŠ›: char.å±æ€§?.è€åŠ› || 0,
                æ•æ„Ÿåº¦: char.å±æ€§?.æ•æ„Ÿåº¦ || 0,
              };
              ['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦'].forEach(stat => {
                const delta = newAttrs[stat] - prevAttrs[stat];
                if (delta !== 0) {
                  attrChanges.push(`${stat} ${delta > 0 ? '+' : ''}${delta}`);
                }
              });
              const likeDelta = (char.å¥½æ„Ÿåº¦ || 0) - prevLike;
              const hateDelta = (char.æ¨æ„ || 0) - prevHate;
              if (likeDelta !== 0) attrChanges.push(`å¥½æ„Ÿåº¦ ${likeDelta > 0 ? '+' : ''}${likeDelta}`);
              if (hateDelta !== 0) attrChanges.push(`æ¨æ„ ${hateDelta > 0 ? '+' : ''}${hateDelta}`);

              // å¦‚æœæœ‰å±æ€§å˜åŒ–ï¼Œè¿½åŠ åˆ°å‰§æƒ…æ–‡æœ¬æœ«å°¾
              if (attrChanges.length > 0) {
                storyText += `\n\nã€å±æ€§å˜åŒ–ã€‘${attrChanges.join('ï¼Œ')}`;
              }

              // ä½¿ç”¨ formatAsDisplayedMessage é¿å…è¢«ç¾åŒ–æ æ­£åˆ™æ›¿æ¢
              if (typeof formatAsDisplayedMessage !== 'undefined') {
                storyText = formatAsDisplayedMessage(storyText);
              }

              // è‡ªåŠ¨é…å›¾ + æ˜¾ç¤º
              renderStoryWithAutoImage(storyContent, storyText, room.å½“å‰è§’è‰², { scene: 'æ¥å®¢', roomType: room.ç±»å‹ });

              // å…³ç³»è§¦å‘æ£€æµ‹ï¼ˆæ¥å®¢å‰§æƒ…ï¼‰
              checkRelationshipTriggers(room.å½“å‰è§’è‰², 'æ¥å®¢å‰§æƒ…');

              // æ£€æŸ¥è§’è‰²æ˜¯å¦è¿˜åœ¨æ¥å®¢ä¸­ï¼ˆå¯èƒ½åœ¨processGameSettlementä¸­å·²è¢«å®Œæˆï¼‰
              const updatedChar = gameState.è§’è‰²ä»“åº“[room.å½“å‰è§’è‰²];
              const updatedWorkingInfo = gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[room.å½“å‰è§’è‰²];
              const updatedRoom = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[roomId];

              // å¦‚æœè§’è‰²å·²ç»è¢«ç§»å‡ºæˆ¿é—´ï¼ˆæ¥å®¢å®Œæˆï¼‰ï¼Œåˆ·æ–°é¡µé¢å¹¶è¿”å›
              if (!updatedChar || !updatedWorkingInfo || !updatedRoom.å½“å‰è§’è‰² || updatedRoom.çŠ¶æ€ === 'ç©ºé—²') {
                console.info(`è§’è‰² ${char.å§“å} æ¥å®¢å·²å®Œæˆï¼Œåˆ·æ–°é¡µé¢`);
                saveGameStateToMVU();
                refreshAllPages();
                return;
              }

              // ==================== å…³é”®ä¿®å¤ï¼šç”Ÿæˆå‰§æƒ…åç«‹å³æ£€æŸ¥å¹¶å¤„ç†åˆ°æœŸæ¥å®¢ ====================
              // å…ˆæ¨è¿›å›åˆï¼Œç„¶åç«‹å³æ£€æŸ¥æ˜¯å¦åˆ°æœŸ
              advanceRound();

              // æ¨è¿›å›åˆåï¼Œå†æ¬¡æ£€æŸ¥æ˜¯å¦åˆ°æœŸï¼ˆå› ä¸ºadvanceRoundä¼šè°ƒç”¨processGameSettlementï¼‰
              const finalRound = getGameTime().å½“å‰å›åˆ || 1;
              const finalWorkingInfo = gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[room.å½“å‰è§’è‰²];
              const finalRoom = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[roomId];
              const finalChar = gameState.è§’è‰²ä»“åº“?.[room.å½“å‰è§’è‰²];

              // ==================== ä¸¥æ ¼æŒ‰ç…§å˜é‡æ›´æ–°è§„åˆ™æ£€æŸ¥ ====================
              // è§„åˆ™ï¼šå½“ æ¸¸æˆæ—¶é—´.å½“å‰å›åˆ >= é¢„è®¡ç»“æŸå›åˆ æ—¶ï¼Œè§¦å‘ç»“ç®—äº‹ä»¶ï¼Œç§»é™¤è¯¥è®°å½•
              if (finalWorkingInfo && finalWorkingInfo.é¢„è®¡ç»“æŸå›åˆ !== undefined) {
                const endRound = finalWorkingInfo.é¢„è®¡ç»“æŸå›åˆ;
                // ä¸¥æ ¼æŒ‰ç…§è§„åˆ™ï¼šå½“å‰å›åˆ >= é¢„è®¡ç»“æŸå›åˆ æ—¶ï¼Œå¿…é¡»å®Œæˆæ¥å®¢
                if (finalRound >= endRound) {
                  // å¦‚æœæ¥å®¢ä¿¡æ¯è¿˜å­˜åœ¨ï¼Œè¯´æ˜processGameSettlementå¯èƒ½æ²¡æœ‰æ­£ç¡®å¤„ç†ï¼Œå¼ºåˆ¶å®Œæˆ
                  console.warn(
                    `ä¸¥æ ¼æŒ‰ç…§è§„åˆ™ï¼šè§’è‰² ${char.å§“å} æ¥å®¢å·²åˆ°æœŸï¼ˆé¢„è®¡ç»“æŸå›åˆ: ${endRound}, å½“å‰å›åˆ: ${finalRound}ï¼‰ï¼Œå¼ºåˆ¶å®Œæˆ`,
                  );
                  if (finalChar) {
                    completeWorkingService(room.å½“å‰è§’è‰²);
                    // åŒé‡ä¿é™©ï¼šç¡®ä¿çŠ¶æ€å·²æ›´æ–°
                    if (finalRoom) {
                      finalRoom.çŠ¶æ€ = 'ç©ºé—²';
                      finalRoom.å½“å‰è§’è‰² = undefined;
                    }
                    if (finalChar) {
                      finalChar.çŠ¶æ€ = 'ç©ºé—²';
                      finalChar.å½“å‰ä½ç½® = 'ä»“åº“';
                    }
                    if (gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[room.å½“å‰è§’è‰²]) {
                      delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[room.å½“å‰è§’è‰²];
                    }
                  }
                  saveGameStateToMVU();
                  refreshAllPages();
                  return;
                }
              }

              // å¦‚æœæ¥å®¢å·²å®Œæˆï¼ˆåœ¨advanceRoundçš„processGameSettlementä¸­å®Œæˆï¼‰ï¼Œåˆ·æ–°é¡µé¢
              if (!finalWorkingInfo || !finalRoom.å½“å‰è§’è‰² || finalRoom.çŠ¶æ€ === 'ç©ºé—²') {
                console.info(`è§’è‰² ${char.å§“å} æ¥å®¢å·²å®Œæˆï¼ˆåœ¨å›åˆæ¨è¿›åï¼‰ï¼Œåˆ·æ–°é¡µé¢`);
                saveGameStateToMVU();
                refreshAllPages();
                return;
              }

              // åˆ·æ–°æˆ¿é—´ç®¡ç†é¡µé¢ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°çš„å›åˆä¿¡æ¯
              saveGameStateToMVU();
              refreshAllPages();
            }
          } catch (error) {
            console.error('ç”Ÿæˆå‰§æƒ…å¤±è´¥:', error);
            if (storyContent) {
              storyContent.innerHTML =
                '<div class="story-placeholder" style="color: var(--danger)">ç”Ÿæˆå‰§æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>';
            }
          }
        } else {
          alert(`æˆ¿é—´ ${roomId}\nçŠ¶æ€: ${room.çŠ¶æ€}\nå½“å‰æ— è§’è‰²`);
        }
      }

      // ==================== è°ƒæ•™å®¤ç©æ³•ï¼ˆæœ¬åœ°ç»“ç®— + AIå‰§æƒ…ï¼‰ ====================
      function openTrainingAssignment(roomId) {
        const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[roomId];
        if (!room) return;
        if (room.ç±»å‹ !== 'è°ƒæ•™å®¤') return;
        if (room.çŠ¶æ€ !== 'ç©ºé—²') {
          alert('è¯¥è°ƒæ•™å®¤æ­£åœ¨ä½¿ç”¨ä¸­ã€‚');
          return;
        }

        const availableChars = Object.entries(gameState.è§’è‰²ä»“åº“ || {})
          .filter(([, char]) => char?.çŠ¶æ€ === 'ç©ºé—²' && char?.å½“å‰ä½ç½® === 'ä»“åº“')
          .map(([id, char]) => ({ id, name: char.å§“å }));

        if (availableChars.length === 0) {
          alert('æ²¡æœ‰å¯ç”¨è§’è‰²ï¼ˆéœ€è¦ç©ºé—²ä¸”åœ¨ä»“åº“ï¼‰ã€‚');
          return;
        }

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'training-assign-modal';
        modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px">
                  <button class="modal-close" onclick="closeTrainingAssignment()">Ã—</button>
                  <h2 style="font-size: 24px; color: var(--text-primary); margin-bottom: 10px; text-align: center; font-family: var(--font-title); letter-spacing: 0.12em">
                    â›“ï¸ è°ƒæ•™å®¤ Â· è¯¾ç¨‹å®‰æ’
                  </h2>
                  <div style="text-align: center; font-size: 12px; color: var(--text-secondary); margin-bottom: 18px">
                    æˆ¿é—´ï¼š${roomId} Â· æœ¬æ“ä½œä¸ä¼šè°ƒç”¨AIï¼Œç‚¹â€œå¼€å§‹è®­ç»ƒâ€åç­‰å¾…å›åˆæ¨è¿›ç»“ç®—ã€‚
                  </div>

                  <div style="display: grid; grid-template-columns: 1fr; gap: 14px; margin-bottom: 18px">
                    <div style="padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px">
                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.12em">é€‰æ‹©è§’è‰²</div>
                      <select id="training-char-select" style="width: 100%; padding: 12px">
                        ${availableChars.map(c => `<option value="${c.id}">${c.name}ï¼ˆ${c.id}ï¼‰</option>`).join('')}
                      </select>
                    </div>

                    <div style="padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px">
                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.12em">é€‰æ‹©è¯¾ç¨‹</div>
                      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 12px">
                        ${trainingPrograms
                          .map(
                            p => `
                          <label style="display:block; cursor:pointer; padding: 12px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.18)">
                            <div style="display:flex; gap:10px; align-items:flex-start">
                              <input type="radio" name="training-program" value="${p.key}" style="margin-top: 4px" ${p.key === trainingPrograms[0].key ? 'checked' : ''} onchange="toggleCustomTraining(false)" />
                              <div style="flex:1">
                                <div style="font-weight:800; color: var(--text-primary); margin-bottom: 4px">${p.icon} ${p.key}</div>
                                <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6">${p.desc}</div>
                              </div>
                            </div>
                          </label>
                        `,
                          )
                          .join('')}
                      </div>
                    </div>

                    <div style="padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px">
                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.12em">
                        <label style="cursor:pointer">
                          <input type="radio" name="training-program" value="è‡ªå®šä¹‰è°ƒæ•™" style="margin-right: 8px" onchange="toggleCustomTraining(true)" />
                          ğŸ­ è‡ªå®šä¹‰è°ƒæ•™ï¼ˆæè¿°ä½ æƒ³è¦çš„playï¼Œè¶Šè¯¦ç»†è¶Šå¥½ï¼‰
                        </label>
                      </div>
                      <textarea id="custom-training-desc" placeholder="ä¾‹ï¼šç”¨çƒ­èœ¡æ»´åœ¨ä¹³å¤´ä¸Šï¼Œç„¶åç”¨é­å­æŠ½æ‰“å±è‚¡ï¼Œæœ€åå¼ºåˆ¶å£äº¤... æè¿°è¶Šè‰²æƒ…è¯¦ç»†ï¼ŒAIç”Ÿæˆå‰§æƒ…è¶Šåˆºæ¿€" style="width: 100%; min-height: 80px; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; color: var(--text-primary); font-size: 14px; resize: vertical; display: none" oninput="updateCustomTraining()"></textarea>
                      <div id="custom-training-preview" style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 12px; color: var(--text-secondary); display: none">é¢„è§ˆï¼šè‡ªå®šä¹‰è°ƒæ•™</div>
                    </div>

                    <div style="padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px">
                      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.12em">å¼ºåº¦ï¼ˆå½±å“å›åˆæ•°/æ”¶ç›Š/é£é™©ï¼‰</div>
                      <div style="display:flex; gap: 12px; align-items:center">
                        <input type="range" id="training-intensity" min="1" max="3" step="1" value="2" style="flex:1" />
                        <div style="min-width: 64px; text-align:right; font-weight:800; color: var(--accent-gold)"><span id="training-intensity-val">2</span>/3</div>
                      </div>
                      <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary)">é¢„è®¡è€—æ—¶ï¼š<span id="training-duration">2</span> å›åˆ</div>
                    </div>
                  </div>

                  <div style="display: flex; gap: 12px; justify-content: flex-end">
                    <button class="btn btn-secondary" onclick="closeTrainingAssignment()">å–æ¶ˆ</button>
                    <button class="btn" onclick="confirmTrainingAssignment('${roomId}')">å¼€å§‹è®­ç»ƒ</button>
                  </div>
                </div>
              `;
        document.body.appendChild(modal);
        modal.classList.add('active');

        // ä¿®å¤æ»šåŠ¨ä½ç½®ï¼šæ‰“å¼€åç«‹å³æ»šåŠ¨åˆ°é¡¶éƒ¨
        setTimeout(() => {
          const modalContent = modal.querySelector('.modal-content');
          if (modalContent) {
            modalContent.scrollTop = 0;
            modal.scrollTop = 0;
          }
          // å¦‚æœæ¨¡æ€æ¡†åœ¨è§†å£å¤–ï¼Œæ»šåŠ¨åˆ°æ¨¡æ€æ¡†ä½ç½®
          modal.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 50);

        const slider = modal.querySelector('#training-intensity');
        const val = modal.querySelector('#training-intensity-val');
        const dur = modal.querySelector('#training-duration');
        if (slider && val && dur) {
          slider.addEventListener('input', () => {
            val.textContent = slider.value;
            dur.textContent = slider.value;
          });
        }

        // åˆå§‹åŒ–è‡ªå®šä¹‰è°ƒæ•™
        toggleCustomTraining(false);
      }

      function closeTrainingAssignment() {
        closeModal('training-assign-modal');
      }

      function confirmTrainingAssignment(roomId) {
        const charId = document.getElementById('training-char-select')?.value;
        const program = document.querySelector('input[name="training-program"]:checked')?.value;
        const intensity = parseInt(document.getElementById('training-intensity')?.value || '2');
        if (!charId || !program) return;

        let finalProgram = program;
        let customDesc = '';

        if (program === 'è‡ªå®šä¹‰è°ƒæ•™') {
          customDesc = document.getElementById('custom-training-desc')?.value?.trim() || '';
          if (!customDesc) {
            alert('è¯·è¾“å…¥è‡ªå®šä¹‰è°ƒæ•™å†…å®¹ï¼');
            return;
          }
          finalProgram = `è‡ªå®šä¹‰è°ƒæ•™ï¼š${customDesc}`;
        }

        startTrainingLocal(roomId, charId, finalProgram, clampNumber(intensity, 1, 3), customDesc);
        closeTrainingAssignment();
      }

      function startTrainingLocal(roomId, characterId, programKey, intensity, customDesc = '') {
        const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[roomId];
        const char = gameState.è§’è‰²ä»“åº“?.[characterId];
        if (!room || !char) return;
        if (room.ç±»å‹ !== 'è°ƒæ•™å®¤') return;
        if (room.çŠ¶æ€ !== 'ç©ºé—²') {
          alert('æˆ¿é—´ä¸å¯ç”¨ã€‚');
          return;
        }
        normalizeCharacter(char);

        const p = trainingPrograms.find(x => x.key === programKey) || trainingPrograms[0];
        const gameTime = getGameTime();
        const duration = intensity; // 1~3 å›åˆ
        const endRound = (gameTime.å½“å‰å›åˆ || 1) + duration;

        room.çŠ¶æ€ = 'ä½¿ç”¨ä¸­';
        room.å½“å‰è§’è‰² = characterId;
        char.çŠ¶æ€ = 'è°ƒæ•™ä¸­';
        char.å½“å‰ä½ç½® = 'è°ƒæ•™å®¤';

        if (!gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²) gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰² = {};
        gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²[characterId] = {
          å¼€å§‹å›åˆ: gameTime.å½“å‰å›åˆ || 1,
          é¢„è®¡ç»“æŸå›åˆ: endRound,
          è¯¾ç¨‹: programKey,
          å¼ºåº¦: intensity,
          æˆ¿é—´å·: roomId,
          è‡ªå®šä¹‰æè¿°: customDesc,
        };

        // ç«‹å³æ‰£ä¸€ç‚¹è€åŠ›ä½œä¸ºæˆæœ¬
        const staminaCost = randInt(p.staminaCost[0], p.staminaCost[1]) + (intensity - 1) * 2;
        char.å±æ€§.è€åŠ› = clampNumber((char.å±æ€§.è€åŠ› || 0) - staminaCost, 0, 100);

        char.è°ƒæ•™æ¬¡æ•° = (char.è°ƒæ•™æ¬¡æ•° || 0) + 1;
        char.æœ€åäº’åŠ¨ = gameTime.å½“å‰å›åˆ || 1;

        pushBrothelLog({
          æ—¶é—´æˆ³: gameTime.å½“å‰å›åˆ || 1,
          è§’è‰²ID: characterId,
          äº‹ä»¶ç±»å‹: 'å¼€å§‹è®­ç»ƒ',
          æè¿°: `${char.å§“å}åœ¨è°ƒæ•™å®¤${roomId}å¼€å§‹è¯¾ç¨‹ã€${p.key}ã€‘ï¼ˆå¼ºåº¦${intensity}ï¼Œé¢„è®¡${duration}å›åˆï¼‰`,
          æ”¶å…¥å˜åŒ–: 0,
        });

        saveImmediately(); // å¼€å§‹è®­ç»ƒæ˜¯å…³é”®æ“ä½œï¼Œç«‹å³ä¿å­˜
        refreshAllPages();
      }

      function stopTrainingInRoom(roomId) {
        const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[roomId];
        if (!room || room.ç±»å‹ !== 'è°ƒæ•™å®¤') return;
        const charId = room.å½“å‰è§’è‰²;
        if (!charId) {
          alert('è¯¥æˆ¿é—´æ²¡æœ‰è§’è‰²ã€‚');
          return;
        }
        const char = gameState.è§’è‰²ä»“åº“?.[charId];
        if (!char) return;
        if (!confirm(`ç¡®å®šè¦ç»ˆæ­¢ ${char.å§“å} çš„è®­ç»ƒå—ï¼Ÿï¼ˆä¸ä¼šè·å¾—æœ¬æ¬¡è¯¾ç¨‹æ”¶ç›Šï¼‰`)) return;

        delete gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[charId];
        room.çŠ¶æ€ = 'ç©ºé—²';
        room.å½“å‰è§’è‰² = undefined;
        char.çŠ¶æ€ = 'ç©ºé—²';
        char.å½“å‰ä½ç½® = 'ä»“åº“';

        pushBrothelLog({
          æ—¶é—´æˆ³: getGameTime().å½“å‰å›åˆ || 1,
          è§’è‰²ID: charId,
          äº‹ä»¶ç±»å‹: 'ç»ˆæ­¢è®­ç»ƒ',
          æè¿°: `${char.å§“å}çš„è®­ç»ƒè¢«ç»ˆæ­¢ï¼Œç¦»å¼€è°ƒæ•™å®¤${roomId}`,
          æ”¶å…¥å˜åŒ–: 0,
        });

        saveImmediately(); // ç»ˆæ­¢è®­ç»ƒæ˜¯å…³é”®æ“ä½œï¼Œç«‹å³ä¿å­˜
        refreshAllPages();
      }

      async function showTrainingRoomDetail(roomId) {
        const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[roomId];
        const charId = room?.å½“å‰è§’è‰²;
        const char = charId ? gameState.è§’è‰²ä»“åº“?.[charId] : null;
        const trainingInfo = charId ? gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[charId] : null;

        if (!charId || !char) {
          alert(`æˆ¿é—´ ${roomId}\nçŠ¶æ€: ${room?.çŠ¶æ€}\nå½“å‰æ— è§’è‰²`);
          return;
        }

        const storyContent = document.getElementById('brothel-story-content');
        if (storyContent) {
          storyContent.innerHTML = '<div class="story-loading">â³ AI æ­£åœ¨ç”Ÿæˆè®­ç»ƒå‰§æƒ…ï¼Œè¯·ç¨å€™...</div>';
        }

        // è®°å½•å±æ€§åˆå§‹å€¼ï¼ˆç”¨äºæ˜¾ç¤ºå˜åŒ–ï¼‰
        normalizeCharacter(char);
        const prevAttrs = {
          é­…åŠ›: char.å±æ€§?.é­…åŠ› || 0,
          é¡ºä»: char.å±æ€§?.é¡ºä» || 0,
          æŠ€å·§: char.å±æ€§?.æŠ€å·§ || 0,
          è€åŠ›: char.å±æ€§?.è€åŠ› || 0,
          æ•æ„Ÿåº¦: char.å±æ€§?.æ•æ„Ÿåº¦ || 0,
        };
        const prevLike = char.å¥½æ„Ÿåº¦ || 0;
        const prevHate = char.æ¨æ„ || 0;

        const gameTime = getGameTime();
        const remain = trainingInfo ? Math.max(0, trainingInfo.é¢„è®¡ç»“æŸå›åˆ - (gameTime.å½“å‰å›åˆ || 1)) : 0;
        const course = trainingInfo?.è¯¾ç¨‹ || 'æœªçŸ¥è¯¾ç¨‹';
        const intensity = trainingInfo?.å¼ºåº¦ || 2;

        // æ„å»ºèŠå¤©ä¸Šä¸‹æ–‡
        const chatContext =
          char.èŠå¤©è®°å½• && char.èŠå¤©è®°å½•.length > 0
            ? `\n\nè§’è‰²ä¸ä½ çš„èŠå¤©è®°å½•ï¼ˆè§’è‰²ä¼šè®°å¾—è¿™äº›ï¼‰ï¼š\n${char.èŠå¤©è®°å½•
                .slice(-5)
                .map(msg => `${msg.role === 'user' ? 'ä½ ' : char.å§“å}: ${msg.content}`)
                .join('\n')}`
            : '';
        const summaryContext = char.èŠå¤©æ‘˜è¦ ? `\n\nä¹‹å‰çš„èŠå¤©æ‘˜è¦ï¼š${char.èŠå¤©æ‘˜è¦}` : '';

        const command = `ã€å‰§æƒ…ç”Ÿæˆæ¨¡å¼ã€‘è¿™æ˜¯çº¯æ–‡æœ¬å‰§æƒ…ç”Ÿæˆï¼Œä¸æ˜¯è§’è‰²å¡ç”Ÿæˆã€‚
ç»å¯¹ç¦æ­¢ï¼šä¸è¦è¾“å‡ºä»»ä½•HTMLä»£ç ã€ä¸è¦è¾“å‡ºä»£ç å—ã€ä¸è¦è¾“å‡º<think>/<analysis>æ€ç»´é“¾ã€‚
åªè¾“å‡ºï¼šçº¯æ–‡æœ¬å‰§æƒ… + <JSONPatch>æ›´æ–°</JSONPatch>

ä¸ºè§’è‰²${charId}ï¼ˆ${char.å§“å}ï¼‰ç”Ÿæˆä¸€æ®µã€è°ƒæ•™å®¤è®­ç»ƒå‰§æƒ…ã€‘ã€‚

è®­ç»ƒä¿¡æ¯ï¼šæˆ¿é—´${roomId}ï¼Œè¯¾ç¨‹${course}ï¼Œå¼ºåº¦${intensity}/3ï¼Œå½“å‰ç¬¬${gameTime.å¤©æ•°}å¤©${gameTime.å½“å‰æ—¶æ®µ}ï¼ˆå›åˆ${gameTime.å½“å‰å›åˆ}ï¼‰ï¼Œå‰©ä½™${remain}å›åˆã€‚${chatContext}${summaryContext}

å¿…é¡»ä½¿ç”¨ <JSONPatch> æ›´æ–°ï¼šè§’è‰²ä»“åº“/${charId}/å±æ€§ï¼ˆæŒ‰è¯¾ç¨‹æ–¹å‘å°å¹…æå‡ï¼‰ã€è§’è‰²ä»“åº“/${charId}/å¥½æ„Ÿåº¦ æˆ– æ¨æ„ï¼ˆ0~100ï¼‰ã€‚`;

        try {
          const response = await sendCommandToAI(command, true);
          if (response && storyContent) {
            let storyText = response;
            const jsonPatchMatch = storyText.match(/<JSONPatch>([\s\S]*?)<\/JSONPatch>/);
            if (jsonPatchMatch) {
              try {
                const patches = JSON.parse(cleanJsonString(jsonPatchMatch[1]));
                applyJSONPatches(patches);
              } catch (error) {
                console.error('è§£æ JSON Patch å¤±è´¥:', error);
              }
              storyText = storyText.replace(/<JSONPatch>[\s\S]*?<\/JSONPatch>/, '').trim();
            }
            storyText = storyText.replace(/<UpdateVariable>[\s\S]*?<\/UpdateVariable>/, '').trim();
            storyText = storyText.replace(/<Analysis>[\s\S]*?<\/Analysis>/, '').trim();

            // è¿‡æ»¤æ‰AIé”™è¯¯è¾“å‡ºçš„HTMLä»£ç 
            storyText = filterHtmlFromStory(storyText);

            // ä¿æŠ¤ï¼šç¡®ä¿è°ƒæ•™å®¤çŠ¶æ€æ­£ç¡®ï¼ˆå¦‚æœæˆ¿é—´æœ‰è§’è‰²ï¼ŒçŠ¶æ€å¿…é¡»æ˜¯"ä½¿ç”¨ä¸­"ï¼‰
            const currentRoom = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[roomId];
            if (currentRoom && currentRoom.å½“å‰è§’è‰²) {
              if (currentRoom.çŠ¶æ€ !== 'ä½¿ç”¨ä¸­') {
                console.warn(`ä¿®å¤è°ƒæ•™å®¤ ${roomId} çŠ¶æ€ï¼šä»"${currentRoom.çŠ¶æ€}"æ”¹ä¸º"ä½¿ç”¨ä¸­"`);
                currentRoom.çŠ¶æ€ = 'ä½¿ç”¨ä¸­';
              }
              const currentChar = gameState.è§’è‰²ä»“åº“[currentRoom.å½“å‰è§’è‰²];
              if (currentChar && currentChar.çŠ¶æ€ !== 'è°ƒæ•™ä¸­') {
                currentChar.çŠ¶æ€ = 'è°ƒæ•™ä¸­';
              }
              saveGameStateToMVU();
            }

            // è®¡ç®—å±æ€§å˜åŒ–å¹¶æ˜¾ç¤º
            normalizeCharacter(char);
            const attrChanges = [];
            const newAttrs = {
              é­…åŠ›: char.å±æ€§?.é­…åŠ› || 0,
              é¡ºä»: char.å±æ€§?.é¡ºä» || 0,
              æŠ€å·§: char.å±æ€§?.æŠ€å·§ || 0,
              è€åŠ›: char.å±æ€§?.è€åŠ› || 0,
              æ•æ„Ÿåº¦: char.å±æ€§?.æ•æ„Ÿåº¦ || 0,
            };
            ['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦'].forEach(stat => {
              const delta = newAttrs[stat] - prevAttrs[stat];
              if (delta !== 0) {
                attrChanges.push(`${stat} ${delta > 0 ? '+' : ''}${delta}`);
              }
            });
            const likeDelta = (char.å¥½æ„Ÿåº¦ || 0) - prevLike;
            const hateDelta = (char.æ¨æ„ || 0) - prevHate;
            if (likeDelta !== 0) attrChanges.push(`å¥½æ„Ÿåº¦ ${likeDelta > 0 ? '+' : ''}${likeDelta}`);
            if (hateDelta !== 0) attrChanges.push(`æ¨æ„ ${hateDelta > 0 ? '+' : ''}${hateDelta}`);

            // å¦‚æœæœ‰å±æ€§å˜åŒ–ï¼Œè¿½åŠ åˆ°å‰§æƒ…æ–‡æœ¬æœ«å°¾
            if (attrChanges.length > 0) {
              storyText += `\n\nã€å±æ€§å˜åŒ–ã€‘${attrChanges.join('ï¼Œ')}`;
            }

            if (typeof formatAsDisplayedMessage !== 'undefined') {
              storyText = formatAsDisplayedMessage(storyText);
            }

            renderStoryWithAutoImage(storyContent, storyText, charId, { scene: 'è®­ç»ƒ', roomType: 'è°ƒæ•™å®¤' });
            checkRelationshipTriggers(charId, 'è®­ç»ƒå‰§æƒ…');
            advanceRound();
          }
        } catch (error) {
          console.error('ç”Ÿæˆè®­ç»ƒå‰§æƒ…å¤±è´¥:', error);
          if (storyContent) {
            storyContent.innerHTML =
              '<div class="story-placeholder" style="color: var(--danger)">ç”Ÿæˆè®­ç»ƒå‰§æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>';
          }
        }
      }

      function toggleBrothelStatus() {
        if (!gameState.å¦“é™¢) gameState.å¦“é™¢ = {};
        if (!gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€) gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€ = 'è¥ä¸šä¸­';
        gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€ = gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€ === 'è¥ä¸šä¸­' ? 'æš‚åœè¥ä¸š' : 'è¥ä¸šä¸­';

        pushBrothelLog({
          æ—¶é—´æˆ³: getGameTime().å½“å‰å›åˆ || 1,
          è§’è‰²ID: 'SYSTEM',
          äº‹ä»¶ç±»å‹: 'è¥ä¸šçŠ¶æ€',
          æè¿°: `å¦“é™¢è¥ä¸šçŠ¶æ€åˆ‡æ¢ä¸ºï¼š${gameState.å¦“é™¢.è¥ä¸šçŠ¶æ€}`,
          æ”¶å…¥å˜åŒ–: 0,
        });

        saveGameStateToMVU();
        refreshAllPages();
      }

      function batchAssignLocal(roomId, characterId, startRound) {
        const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[roomId];
        const char = gameState.è§’è‰²ä»“åº“?.[characterId];
        if (!room || !char) return;

        // å¦‚æœæˆ¿é—´ä»å ç”¨ï¼ˆå¯èƒ½æœªæ’åœ¨removeé‡Œï¼Œä½†ç”¨æˆ·æ‰‹åŠ¨æ¸…äº†ï¼‰ï¼Œç›´æ¥ä¸­æ­¢
        if (room.çŠ¶æ€ !== 'ç©ºé—²') return;

        // è°ƒæ•™å®¤æš‚ä¸æ”¯æŒæ‰¹é‡æ´¾é£
        if (room.ç±»å‹ === 'è°ƒæ•™å®¤') {
          return;
        }

        // ==================== é¢„é˜²æ€§æ¸…ç†ï¼šç¡®ä¿è§’è‰²ä¸åœ¨å…¶ä»–æˆ¿é—´ ====================
        // 1. å¦‚æœè§’è‰²å½“å‰åœ¨å…¶ä»–æˆ¿é—´ï¼Œå…ˆæ¸…ç†è¯¥æˆ¿é—´
        Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€ || {}).forEach(([rid, r]) => {
          if (rid !== roomId && r.å½“å‰è§’è‰² === characterId) {
            console.warn(`é¢„é˜²æ€§æ¸…ç†ï¼šè§’è‰² ${char.å§“å} ä»æˆ¿é—´ ${rid} ç§»å‡º`);
            r.çŠ¶æ€ = 'ç©ºé—²';
            r.å½“å‰è§’è‰² = undefined;
          }
        });

        // 2. æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§æ¥å®¢ä¿¡æ¯
        if (gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[characterId]) {
          delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[characterId];
        }

        // 3. å¦‚æœæˆ¿é—´æœ‰æ—§è§’è‰²ï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼Œä½†ä½œä¸ºå®‰å…¨æªæ–½ï¼‰
        if (room.å½“å‰è§’è‰² && room.å½“å‰è§’è‰² !== characterId) {
          const oldChar = gameState.è§’è‰²ä»“åº“?.[room.å½“å‰è§’è‰²];
          if (oldChar) {
            oldChar.çŠ¶æ€ = 'ç©ºé—²';
            oldChar.å½“å‰ä½ç½® = 'ä»“åº“';
            delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[room.å½“å‰è§’è‰²];
          }
        }

        // ==================== è®¾ç½®æ–°çŠ¶æ€ ====================
        room.çŠ¶æ€ = 'ä½¿ç”¨ä¸­';
        room.å½“å‰è§’è‰² = characterId;
        char.çŠ¶æ€ = 'æ¥å®¢ä¸­';
        char.å½“å‰ä½ç½® = 'å¦“é™¢';

        // åˆå§‹åŒ–è§’è‰²ä½“åŠ›å€¼ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼Œåˆå§‹ä¸ºæ»¡å€¼100ï¼‰
        if (!char.å±æ€§) char.å±æ€§ = {};
        if (typeof char.ä½“åŠ›å€¼ !== 'number') char.ä½“åŠ›å€¼ = 100;

        const workingInfo = createWorkingInfoLocal(char, room, startRound);
        gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[characterId] = workingInfo;
        pushBrothelLog({
          æ—¶é—´æˆ³: startRound,
          è§’è‰²ID: characterId,
          äº‹ä»¶ç±»å‹: 'åˆ†é…æ¥å®¢',
          æè¿°: `${char.å§“å}è¢«åˆ†é…åˆ°æˆ¿é—´${roomId}å¼€å§‹æ¥å®¢ï¼ˆ${workingInfo.å®¢æˆ·ç±»å‹}ï¼‰`,
          æ”¶å…¥å˜åŒ–: 0,
        });
      }

      function batchRemoveLocal(roomId, characterId, round) {
        const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[roomId];
        if (!room) return;
        const realCharId = room.å½“å‰è§’è‰² || characterId;
        const char = gameState.è§’è‰²ä»“åº“?.[realCharId];

        // å³ä½¿çŠ¶æ€ä¸å®Œå…¨åŒ¹é…ä¹Ÿè¦å°è¯•æ¸…ç†ï¼ˆé˜²æ­¢çŠ¶æ€ä¸ä¸€è‡´ï¼‰
        if (!realCharId) {
          // æˆ¿é—´æ²¡æœ‰è§’è‰²ï¼Œç›´æ¥é‡ç½®æˆ¿é—´çŠ¶æ€
          room.çŠ¶æ€ = 'ç©ºé—²';
          room.å½“å‰è§’è‰² = undefined;
          return;
        }

        // ç§»é™¤æ¥å®¢ä¿¡æ¯ï¼ˆå¦‚æœ‰ï¼‰
        if (gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[realCharId]) {
          delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[realCharId];
        }

        // ä¹Ÿæ£€æŸ¥è°ƒæ•™ä¿¡æ¯
        if (gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[realCharId]) {
          delete gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²[realCharId];
        }

        room.çŠ¶æ€ = 'ç©ºé—²';
        room.å½“å‰è§’è‰² = undefined;

        // è§’è‰²å›åˆ°ä»“åº“ï¼ˆæ— æ”¶å…¥ï¼‰
        char.çŠ¶æ€ = 'ç©ºé—²';
        char.å½“å‰ä½ç½® = 'ä»“åº“';

        pushBrothelLog({
          æ—¶é—´æˆ³: round,
          è§’è‰²ID: realCharId,
          äº‹ä»¶ç±»å‹: 'å–æ¶ˆæ¥å®¢',
          æè¿°: `${char.å§“å}è¢«ä»æˆ¿é—´${roomId}ä¸­å¬å›`,
          æ”¶å…¥å˜åŒ–: 0,
        });
      }

      function createWorkingInfoLocal(char, room, startRound) {
        const rnd = () => {
          if (typeof crypto !== 'undefined' && crypto.getRandomValues) {
            const arr = new Uint32Array(1);
            crypto.getRandomValues(arr);
            return arr[0] / (0xffffffff + 1);
          }
          return Math.random();
        };
        const randInt = (min, max) => Math.floor(rnd() * (max - min + 1)) + min;
        const pickWeighted = entries => {
          const total = entries.reduce((s, e) => s + e.w, 0);
          let r = rnd() * total;
          for (const e of entries) {
            r -= e.w;
            if (r <= 0) return e.v;
          }
          return entries[entries.length - 1].v;
        };

        // å®¢æˆ·ç±»å‹ï¼šé»˜è®¤ 70/25/5ï¼ŒVIPæˆ¿é—´ç•¥æé«˜VIPæ¦‚ç‡
        const isVipRoom = room.ç±»å‹ === 'VIP';
        const clientType = pickWeighted([
          { v: 'æ™®é€š', w: isVipRoom ? 55 : 70 },
          { v: 'VIP', w: isVipRoom ? 40 : 25 },
          { v: 'ç‰¹æ®Šç™–å¥½', w: 5 },
        ]);

        const baseServicePool = ['æ™®é€šæœåŠ¡', 'è§’è‰²æ‰®æ¼”', 'è½»åº¦SM', 'æŸç¼šæ¸¸æˆ', 'å£èˆŒæœä¾', 'æ„Ÿå®˜æ¸¸æˆ', 'æ€§ç©å…·'];
        const roomBonusPool =
          room.ç±»å‹ === 'å±•ç¤ºå®¤'
            ? ['èˆå°å±•ç¤º', 'æŒ‘é€—è¡¨æ¼”']
            : room.ç±»å‹ === 'æƒ…è¶£æˆ¿'
              ? ['æ·±åº¦ç©å…·', 'ç¾è€»ç©æ³•']
              : room.ç±»å‹ === 'VIP'
                ? ['VIPä¸“å±', 'å®šåˆ¶æœåŠ¡']
                : [];

        const serviceCount =
          clientType === 'ç‰¹æ®Šç™–å¥½' ? randInt(3, 4) : clientType === 'VIP' ? randInt(2, 3) : randInt(1, 2);
        const pool = [...new Set([...roomBonusPool, ...baseServicePool])];
        const services = [];
        while (services.length < serviceCount && pool.length > 0) {
          const idx = randInt(0, pool.length - 1);
          services.push(pool.splice(idx, 1)[0]);
        }

        const charm = char.å±æ€§?.é­…åŠ› || 0;
        const skill = char.å±æ€§?.æŠ€å·§ || 0;
        const stamina = char.å±æ€§?.è€åŠ› || 50;

        // æ”¶å…¥åŸºæ•°ï¼šæŒ‰æˆ¿é—´ç±»å‹/å®¢æˆ·ç±»å‹å¾®è°ƒï¼ˆä¸å«æˆ¿é—´å€ç‡/æƒ…æ„Ÿå€ç‡/æ”¶ç›Šå€ç‡ï¼Œç»Ÿä¸€åœ¨ç»“ç®—æ—¶å¤„ç†ï¼‰
        const roomBase =
          room.ç±»å‹ === 'æƒ…è¶£æˆ¿'
            ? [220, 650]
            : room.ç±»å‹ === 'å±•ç¤ºå®¤'
              ? [160, 480]
              : room.ç±»å‹ === 'VIP'
                ? [200, 600]
                : [120, 420];
        const clientMul = clientType === 'ç‰¹æ®Šç™–å¥½' ? 1.4 : clientType === 'VIP' ? 1.2 : 1.0;
        const staminaMul = Math.max(0.6, Math.min(1.1, stamina / 100 + 0.3));

        let baseIncome = Math.floor(
          randInt(roomBase[0], roomBase[1]) * (charm / 50) * (skill / 50) * clientMul * staminaMul,
        );
        let extraIncome = Math.floor(randInt(0, 180) * services.length * clientMul);

        // ==================== æ ¹æ®æˆ¿é—´ç±»å‹è®¾ç½®ç‹¬ç‰¹åŠŸèƒ½ ====================
        let serviceDuration = 2; // é»˜è®¤2å›åˆ
        let clientCount = 1; // é»˜è®¤1ä¸ªå®¢æˆ·
        let specialEffects = {}; // ç‰¹æ®Šæ•ˆæœ

        if (room.ç±»å‹ === 'æ™®é€š') {
          // æ™®é€šæˆ¿é—´ï¼šå¿«é€ŸæœåŠ¡ï¼Œ1å›åˆå®Œæˆ
          serviceDuration = 1;
          specialEffects.å¿«é€ŸæœåŠ¡ = true;
          specialEffects.ç»éªŒåŠ æˆ = 0.2; // ç»éªŒå€¼+20%
        } else if (room.ç±»å‹ === 'VIP') {
          // VIPæˆ¿é—´ï¼šé•¿æœŸåŒ…æˆ¿ï¼Œ2-3å›åˆ
          serviceDuration = randInt(2, 3);
          specialEffects.é•¿æœŸåŒ…æˆ¿ = true;
          specialEffects.æ€»æ”¶å…¥åŠ æˆ = 0.5; // æ€»æ”¶å…¥+50%
        } else if (room.ç±»å‹ === 'å±•ç¤ºå®¤') {
          // å±•ç¤ºå®¤ï¼šå…¬å¼€è¡¨æ¼”ï¼Œä¸€æ¬¡æœåŠ¡å¤šä¸ªå®¢æˆ·
          serviceDuration = 2;
          clientCount = randInt(2, 4); // 2-4ä¸ªå®¢æˆ·
          specialEffects.å…¬å¼€è¡¨æ¼” = true;
          specialEffects.å®¢æˆ·æ•°é‡ = clientCount;
          // æ”¶å…¥æŒ‰å®¢æˆ·æ•°é‡è®¡ç®—
          baseIncome = Math.floor(baseIncome * clientCount);
          extraIncome = Math.floor(extraIncome * clientCount);
        } else if (room.ç±»å‹ === 'æƒ…è¶£æˆ¿') {
          // æƒ…è¶£æˆ¿ï¼šæé™æŒ‘æˆ˜ï¼Œæ¶ˆè€—æ›´å¤šä½“åŠ›ä½†æ”¶å…¥æ›´é«˜
          serviceDuration = 2;
          specialEffects.æé™æŒ‘æˆ˜ = true;
          specialEffects.ä½“åŠ›æ¶ˆè€—å€ç‡ = 1.5; // ä½“åŠ›æ¶ˆè€—Ã—1.5
          specialEffects.æ”¶å…¥å€ç‡ = 2.0; // æ”¶å…¥Ã—2.0
          baseIncome = Math.floor(baseIncome * 2.0);
          extraIncome = Math.floor(extraIncome * 2.0);
        }

        return {
          å¼€å§‹å›åˆ: startRound,
          é¢„è®¡ç»“æŸå›åˆ: startRound + serviceDuration, // ä¿®å¤ï¼šæ™®é€šæˆ¿é—´1å›åˆåº”è¯¥åœ¨ä¸‹ä¸€å›åˆå®Œæˆ
          å®¢æˆ·ç±»å‹: clientType,
          å®¢æˆ·æ•°é‡: clientCount,
          æœåŠ¡ç±»å‹: services,
          åŸºç¡€æ”¶å…¥: Math.max(0, baseIncome),
          é¢å¤–æ”¶å…¥: Math.max(0, extraIncome),
          ç‰¹æ®Šæ•ˆæœ: specialEffects,
          __local: true,
        };
      }

      function pushBrothelLog(log) {
        if (!gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—) gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿— = [];
        gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—.push({
          æ—¶é—´æˆ³: log.æ—¶é—´æˆ³,
          è§’è‰²ID: log.è§’è‰²ID,
          äº‹ä»¶ç±»å‹: log.äº‹ä»¶ç±»å‹,
          æè¿°: log.æè¿°,
          æ”¶å…¥å˜åŒ–: log.æ”¶å…¥å˜åŒ– ?? 0,
        });
        // æœ€å¤šä¿ç•™100æ¡
        if (gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—.length > 100) {
          gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—.splice(0, gameState.å¦“é™¢.äº‹ä»¶æ—¥å¿—.length - 100);
        }
      }

      // ==================== è§’è‰²è¯¦æƒ…å¢å¼ºåŠŸèƒ½ ====================

      function showCharacterUpgrade(characterId) {
        const char = gameState.è§’è‰²ä»“åº“[characterId];
        if (!char) return;

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'character-upgrade-modal';
        modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px">
                  <button class="modal-close" onclick="closeCharacterUpgrade()">Ã—</button>
                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">â¬†ï¸ æå‡è§’è‰²å±æ€§</h2>

                  <div style="margin-bottom: 24px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px">${char.å§“å}</div>
                    <div style="font-size: 12px; color: var(--text-secondary)">æ¯æ¬¡æå‡éœ€è¦æ¶ˆè€—è´§å¸ï¼Œå±æ€§è¶Šé«˜æ¶ˆè€—è¶Šå¤š</div>
                  </div>

                  <div style="display: flex; flex-direction: column; gap: 12px">
                    ${['é­…åŠ›', 'é¡ºä»', 'æŠ€å·§', 'è€åŠ›', 'æ•æ„Ÿåº¦']
                      .map(stat => {
                        const currentValue = char.å±æ€§?.[stat] || 0;
                        const upgradeCost = Math.floor((currentValue + 1) * 10);
                        return `
                        <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">
                          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px">
                            <div>
                              <div style="font-weight: 600; margin-bottom: 4px">${stat}</div>
                              <div style="font-size: 12px; color: var(--text-secondary)">å½“å‰: ${currentValue}/100</div>
                            </div>
                            <div style="text-align: right">
                              <div style="font-size: 18px; font-weight: bold; color: var(--accent-gold); margin-bottom: 8px">${upgradeCost} é‡‘</div>
                              <button class="btn" style="padding: 6px 16px; font-size: 12px" onclick="upgradeCharacterAttribute('${characterId}', '${stat}')" ${currentValue >= 100 || gameState.è´§å¸ < upgradeCost ? 'disabled' : ''}>æå‡</button>
                            </div>
                          </div>
                          <div class="stat-bar">
                            <div class="stat-fill" style="width: ${currentValue}%"></div>
                          </div>
                        </div>
                      `;
                      })
                      .join('')}
                  </div>

                  <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px">
                    <button class="btn btn-secondary" onclick="closeCharacterUpgrade()">å…³é—­</button>
                  </div>
                </div>
              `;

        document.body.appendChild(modal);
        modal.classList.add('active');
      }

      function closeCharacterUpgrade() {
        closeModal('character-upgrade-modal');
      }

      function upgradeCharacterAttribute(characterId, attributeName) {
        const char = gameState.è§’è‰²ä»“åº“[characterId];
        if (!char) return;

        const currentValue = char.å±æ€§?.[attributeName] || 0;
        if (currentValue >= 100) {
          alert('å±æ€§å·²è¾¾åˆ°æœ€å¤§å€¼ï¼');
          return;
        }

        const upgradeCost = Math.floor((currentValue + 1) * 10);
        if (gameState.è´§å¸ < upgradeCost) {
          alert('è´§å¸ä¸è¶³ï¼');
          return;
        }

        if (!confirm(`ç¡®å®šè¦èŠ±è´¹ ${upgradeCost} é‡‘æå‡ ${char.å§“å} çš„${attributeName}å—ï¼Ÿ`)) {
          return;
        }

        gameState.è´§å¸ -= upgradeCost;
        if (!char.å±æ€§) char.å±æ€§ = {};
        char.å±æ€§[attributeName] = Math.min(100, currentValue + 1);

        saveImmediately(); // è§’è‰²å‡çº§æ˜¯å…³é”®æ“ä½œï¼Œç«‹å³ä¿å­˜
        refreshAllPages();
        closeCharacterUpgrade();
        showCharacterUpgrade(characterId); // åˆ·æ–°ç•Œé¢
        alert(`${char.å§“å} çš„${attributeName}å·²æå‡åˆ° ${char.å±æ€§[attributeName]}ï¼`);
      }

      // ==================== æˆ¿é—´ç®¡ç†åŠŸèƒ½ ====================
      function showRoomManagement(roomId) {
        const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[roomId];
        if (!room) return;

        const roomType = roomTypes[room.ç±»å‹] || roomTypes.æ™®é€š;
        const currentLevel = room.ç­‰çº§ || 1;
        const upgradeCost = roomType.upgradeCost(currentLevel);

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'room-management-modal';
        modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px">
                  <button class="modal-close" onclick="closeRoomManagement()">Ã—</button>
                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">
                    ${roomType.icon} æˆ¿é—´ ${roomId} ç®¡ç†
                  </h2>

                  <div style="margin-bottom: 24px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px">
                      <div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">æˆ¿é—´ç±»å‹</div>
                        <div style="font-size: 16px; font-weight: 600; color: ${roomType.color}">${room.ç±»å‹}</div>
                      </div>
                      <div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">å½“å‰ç­‰çº§</div>
                        <div style="font-size: 16px; font-weight: 600; color: var(--accent-gold)">Lv.${currentLevel}</div>
                      </div>
                      <div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px">åŸºç¡€æ”¶å…¥å€ç‡</div>
                        <div style="font-size: 16px; font-weight: 600; color: var(--accent-gold)">${((room.æ”¶å…¥å€ç‡ || 1.0) * 100).toFixed(0)}%</div>
                      </div>
                    </div>
                  </div>

                  <div style="margin-bottom: 24px">
                    <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å‡çº§æˆ¿é—´</h3>
                    <div style="padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px">
                        <div>
                          <div style="font-weight: 600; margin-bottom: 4px">å‡çº§åˆ° Lv.${currentLevel + 1}</div>
                          <div style="font-size: 12px; color: var(--text-secondary)">æ”¶å…¥å€ç‡æå‡ ${(0.1 * currentLevel * 100).toFixed(0)}%</div>
                        </div>
                        <div style="text-align: right">
                          <div style="font-size: 20px; font-weight: bold; color: var(--accent-gold)">${upgradeCost} é‡‘</div>
                          <button class="btn" style="margin-top: 8px; padding: 8px 16px; font-size: 12px" onclick="upgradeRoom('${roomId}')" ${gameState.è´§å¸ < upgradeCost ? 'disabled' : ''}>å‡çº§</button>
                        </div>
                      </div>
                    </div>
                  </div>


                  <div style="display: flex; gap: 12px; justify-content: flex-end">
                    <button class="btn btn-secondary" onclick="closeRoomManagement()">å…³é—­</button>
                  </div>
                </div>
              `;

        document.body.appendChild(modal);
        modal.classList.add('active');
      }

      function closeRoomManagement() {
        closeModal('room-management-modal');
      }

      function upgradeRoom(targetRoomId) {
        const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[targetRoomId];
        if (!room) return;

        const roomType = roomTypes[room.ç±»å‹] || roomTypes.æ™®é€š;
        const currentLevel = room.ç­‰çº§ || 1;
        const upgradeCost = roomType.upgradeCost(currentLevel);

        if (gameState.è´§å¸ < upgradeCost) {
          alert('è´§å¸ä¸è¶³ï¼');
          return;
        }

        if (!confirm(`ç¡®å®šè¦èŠ±è´¹ ${upgradeCost} é‡‘å‡çº§æˆ¿é—´ ${targetRoomId} åˆ° Lv.${currentLevel + 1} å—ï¼Ÿ`)) {
          return;
        }

        gameState.è´§å¸ -= upgradeCost;
        room.ç­‰çº§ = currentLevel + 1;
        room.æ”¶å…¥å€ç‡ = roomType.baseIncome * (1 + (room.ç­‰çº§ - 1) * 0.1);

        saveImmediately(); // æˆ¿é—´å‡çº§æ˜¯å…³é”®æ“ä½œï¼Œç«‹å³ä¿å­˜
        refreshAllPages();
        closeRoomManagement();
        alert(`æˆ¿é—´ ${targetRoomId} å·²å‡çº§åˆ° Lv.${room.ç­‰çº§}ï¼`);
      }

      function showRoomShop() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'room-shop-modal';
        modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px">
                  <button class="modal-close" onclick="closeRoomShop()">Ã—</button>
                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">ğŸ—ï¸ æˆ¿é—´å•†åº—</h2>

                  <div style="margin-bottom: 24px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px">å½“å‰è´§å¸</div>
                    <div style="font-size: 32px; font-weight: bold; color: var(--accent-gold)">${gameState.è´§å¸} é‡‘</div>
                  </div>

                  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px">
                    ${Object.entries(roomTypes)
                      .map(([typeName, typeInfo]) => {
                        const existingRooms = Object.values(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€ || {}).filter(
                          r => r.ç±»å‹ === typeName,
                        ).length;
                        const canAfford = gameState.è´§å¸ >= typeInfo.unlockCost;
                        const roomId = typeName + (existingRooms + 1);

                        return `
                        <div style="padding: 16px; background: rgba(15, 23, 42, 0.6); border: 2px solid ${typeInfo.color}; border-radius: 12px">
                          <div style="font-size: 32px; text-align: center; margin-bottom: 8px">${typeInfo.icon}</div>
                          <div style="font-size: 18px; font-weight: 600; color: ${typeInfo.color}; text-align: center; margin-bottom: 8px">${typeName}</div>
                          <div style="font-size: 12px; color: var(--text-secondary); text-align: center; margin-bottom: 12px; min-height: 40px">${typeInfo.description}</div>
                          <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px">
                            <div>åŸºç¡€æ”¶å…¥: ${(typeInfo.baseIncome * 100).toFixed(0)}%</div>
                            <div>å·²æ‹¥æœ‰: ${existingRooms} é—´</div>
                          </div>
                          <div style="text-align: center; margin-top: 12px">
                            <div style="font-size: 20px; font-weight: bold; color: var(--accent-gold); margin-bottom: 8px">${typeInfo.unlockCost} é‡‘</div>
                            <button class="btn" style="width: 100%; padding: 8px; font-size: 12px" onclick="purchaseRoom('${typeName}')" ${!canAfford ? 'disabled' : ''}>è´­ä¹°</button>
                          </div>
                        </div>
                      `;
                      })
                      .join('')}
                  </div>

                  <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px">
                    <button class="btn btn-secondary" onclick="closeRoomShop()">å…³é—­</button>
                  </div>
                </div>
              `;

        document.body.appendChild(modal);
        modal.classList.add('active');
      }

      function closeRoomShop() {
        closeModal('room-shop-modal');
      }

      function purchaseRoom(typeName) {
        const typeInfo = roomTypes[typeName];
        if (!typeInfo) return;

        if (gameState.è´§å¸ < typeInfo.unlockCost) {
          alert('è´§å¸ä¸è¶³ï¼');
          return;
        }

        const existingRooms = Object.values(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€ || {}).filter(r => r.ç±»å‹ === typeName).length;
        const newRoomId = typeName + (existingRooms + 1);

        if (!confirm(`ç¡®å®šè¦èŠ±è´¹ ${typeInfo.unlockCost} é‡‘è´­ä¹°ä¸€é—´${typeName}æˆ¿é—´ï¼ˆ${newRoomId}ï¼‰å—ï¼Ÿ`)) {
          return;
        }

        gameState.è´§å¸ -= typeInfo.unlockCost;
        gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[newRoomId] = {
          ç±»å‹: typeName,
          çŠ¶æ€: 'ç©ºé—²',
          ç­‰çº§: 1,
          æ”¶å…¥å€ç‡: typeInfo.baseIncome,
          è§£é”: true,
        };

        saveGameStateToMVU();
        refreshAllPages();
        closeRoomShop();
        alert(`æˆåŠŸè´­ä¹°${typeName}æˆ¿é—´ ${newRoomId}ï¼`);
      }

      // ==================== å–æ¶ˆæ¥å®¢åŠŸèƒ½ï¼ˆæœ¬åœ°æ‰§è¡Œï¼Œä¸è°ƒç”¨AIï¼‰ ====================
      function cancelCharacterFromRoom(roomId) {
        const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[roomId];
        const characterId = room?.å½“å‰è§’è‰²;

        if (!room || !characterId) {
          alert('è¯¥æˆ¿é—´æ²¡æœ‰è§’è‰²ï¼');
          return;
        }

        const char = gameState.è§’è‰²ä»“åº“?.[characterId];
        if (!char) {
          alert('è§’è‰²ä¸å­˜åœ¨ï¼');
          return;
        }

        if (!confirm(`ç¡®å®šè¦è®© ${char.å§“å} ç¦»å¼€æˆ¿é—´ ${roomId} å—ï¼Ÿ\n\nè¿™å°†å–æ¶ˆå½“å‰çŠ¶æ€ï¼ˆä¸ä¼šäº§ç”Ÿæœ¬æ¬¡æ”¶å…¥ï¼‰ã€‚`)) {
          return;
        }

        // è°ƒæ•™å®¤èµ°ä¸“ç”¨ç»ˆæ­¢
        if (room.ç±»å‹ === 'è°ƒæ•™å®¤') {
          stopTrainingInRoom(roomId);
          return;
        }

        // æœ¬åœ°ç§»å‡ºï¼ˆä¸äº§ç”Ÿæ”¶å…¥ï¼‰
        batchRemoveLocal(roomId, characterId, getGameTime().å½“å‰å›åˆ || 1);

        saveGameStateToMVU();
        refreshAllPages();
      }

      // ==================== å›åˆåˆ¶ç³»ç»Ÿ ====================
      function normalizeGameTime(gameTime) {
        const round = Math.max(1, parseInt(gameTime?.å½“å‰å›åˆ || 1));
        gameTime.å½“å‰å›åˆ = round;
        gameTime.å¤©æ•° = Math.floor((round - 1) / 3) + 1;
        const roundInDay = ((round - 1) % 3) + 1;
        gameTime.å½“å‰æ—¶æ®µ = roundInDay === 1 ? 'æ—©ä¸Š' : roundInDay === 2 ? 'ä¸­åˆ' : 'æ™šä¸Š';
        return gameTime;
      }

      function getGameTime() {
        if (!gameState.æ¸¸æˆæ—¶é—´) {
          gameState.æ¸¸æˆæ—¶é—´ = {
            å½“å‰å›åˆ: 1,
          };
        }
        return normalizeGameTime(gameState.æ¸¸æˆæ—¶é—´);
      }

      // ==================== éšæœºå·¥å…· & é™å®šå¡æ±  ====================
      function rand01() {
        if (typeof crypto !== 'undefined' && crypto.getRandomValues) {
          const arr = new Uint32Array(1);
          crypto.getRandomValues(arr);
          return arr[0] / (0xffffffff + 1);
        }
        return Math.random();
      }

      function randInt(min, max) {
        return Math.floor(rand01() * (max - min + 1)) + min;
      }

      function pickTwoDistinct(arr) {
        if (!arr || arr.length < 2) return [arr?.[0] || 'â€”', 'â€”'];
        const i = randInt(0, arr.length - 1);
        let j = randInt(0, arr.length - 1);
        while (j === i) j = randInt(0, arr.length - 1);
        return [arr[i], arr[j]];
      }

      // ==================== é™å®šå¡æ± è¯æ¡ç³»ç»Ÿï¼ˆä¸‡ç‰©è¯æ¡ + å®¡ç¾å®‰å…¨ç½‘ï¼‰ ====================
      // ç›®æ ‡ï¼šè¯æ¡ä¿æŒâ€œä¸‡ç‰©çš†å¯â€çš„éšæœºæ€§ï¼ˆå•å­—/è¯è¯­/çŸ­è¯­/å¥å­éƒ½å¯èƒ½ï¼‰ï¼ŒåŒæ—¶é€šè¿‡è¿‡æ»¤ + è¯„åˆ†æŒ‘é€‰ï¼Œ
      //      è®©ç»„åˆé€šå¸¸ä¸èµ°å‘è¿‡äºçŒå¥‡/æ¶å¿ƒï¼Œå¹¶æ›´å®¹æ˜“è¢«AIâ€œè§’è‰²åŒ–è½åœ°â€ï¼ˆæœè£…/é…è‰²/çº¹æ ·/é“å…·/èƒŒæ™¯æ„è±¡ç­‰ï¼‰ã€‚
      //
      // é‡è¦çº¦æŸï¼ˆæŒ‰ä½ çš„å£å‘³ï¼‰ï¼šä¸€èˆ¬ä¸å‡ºç°è¿‡äºæ¶å¿ƒçŒå¥‡ï¼›æœ€æ¶å¿ƒä¸Šé™åªåˆ°ã€å°¿æ¶²/å­•è‚šã€‘ã€‚

      const LIMITED_TAG_SOURCES = {
        // å•å­—ï¼šç”¨äºâ€œæŠ½è±¡ä½†æœ‰å‘³é“â€çš„ç§å­
        chars: [
          'å½±',
          'å…‰',
          'æ¢¦',
          'ç½ª',
          'å»',
          'é›¾',
          'æœˆ',
          'æ˜Ÿ',
          'ç«',
          'å°˜',
          'ç ‚',
          'å¼¦',
          'é“ƒ',
          'é—¨',
          'é’¥',
          'é•œ',
          'å¢¨',
          'é›¨',
          'é›ª',
          'é£',
          'æ˜¥',
          'å¤',
          'ç§‹',
          'å†¬',
          'ç¦',
          'ç¥ˆ',
          'æ¸´',
          'æ½®',
          'ç—•',
          'ç›',
          'åˆƒ',
          'ç± ',
          'å¥‘',
          'è°',
          'èª“',
          'å¤œ',
          'æ˜¼',
          'ç©º',
          'é›¶',
          'ä¸ƒ',
          'ä¹',
          'ç¢‘',
          'çƒ›',
          'ç»¸',
          'ç»',
          'æ™¶',
          'çº±',
          'ç»’',
          'é”',
          'é“¾',
          'ç´',
          'é…’',
          'ç³–',
          'é’ˆ',
          'çº¸',
          'ç¾½',
          'æ½®',
        ],
        // å®ç‰©/ç°è±¡/æè´¨/æ—¥å¸¸ï¼šæ›´â€œä¸‡ç‰©â€
        nouns: [
          'æ¤…å­',
          'æ±¤åŒ™',
          'è‚¥çš‚æ³¡',
          'éœ“è™¹ç¯',
          'é£é“ƒ',
          'æ²™æ¼',
          'é’¥åŒ™',
          'é•œå­',
          'èœ¡çƒ›',
          'ç¾½æ¯›',
          'ç»ç’ƒçƒ',
          'é“é’‰',
          'ä¸ç»¸',
          'ç›',
          'ç«ç„°',
          'å†°å—',
          'å½±å­',
          'å›éŸ³',
          'å°˜åŸƒ',
          'è†æ£˜',
          'æ³‰æ°´',
          'é™¨çŸ³',
          'é›ªèŠ±',
          'é›·ç”µ',
          'å½©è™¹',
          'è¿·é›¾',
          'æ¼©æ¶¡',
          'è—¤è”“',
          'æ°´æ™¶',
          'é’Ÿè¡¨',
          'æ€€è¡¨',
          'å”±ç‰‡',
          'ç•™å£°æœº',
          'é“¶å¸',
          'é‡‘ç²‰',
          'çƒŸç°',
          'é¦™æ°´',
          'é¦™è–°',
          'è¯ç“¶',
          'è¯•ç®¡',
          'ä¹¦é¡µ',
          'ä¹¦ç­¾',
          'ä¿¡å°',
          'å°èœ¡',
          'èŠ±æŸ',
          'å¹²èŠ±',
          'ç«ç‘°åˆº',
          'çŒ«çœ¼çŸ³',
          'é»‘æ›œçŸ³',
          'çç ',
          'çº¢ç»³',
          'é¢å…·',
          'æ‰‹å¥—',
          'é¡¹åœˆ',
          'é“ƒé“›',
          'ä¸å¸¦',
          'é”é“¾',
          'ç¾½æ‰‡',
          'çº¸ä¼',
          'æ²¹çº¸',
          'é›¨å··',
          'ç”µæ¢¯',
          'åœ°é“',
          'å¤©çº¿',
          'è€³æœº',
          'å±å¹•',
          'åƒç´ ',
          '404',
          'å¤‡å¿˜å½•',
          'æ”¶æ®',
          'è½¦ç¥¨',
          'è½¦çª—',
          'åè§†é•œ',
          'ç©ºç“¶',
          'å†·å’–å•¡',
          'é»‘ç³–',
          'è–„è·',
          'è‹¦è‰¾é…’',
          'é¦™æ§Ÿ',
          'å¨å£«å¿Œ',
          'é»‘èƒ¶',
          'å™ªéŸ³',
          'å›å£°å®¤',
          'æœˆå…‰',
          'é˜´å½±',
          'çƒ›å…‰',
          'é›¾æ°”',
        ],
        // æ¦‚å¿µ/æŠ½è±¡ï¼šå…è®¸æ›´â€œæ€ªâ€ä½†ä»å¯è½¬è¯‘
        concepts: [
          'ç›¸å¯¹è®º',
          'é‡å­',
          'æ‚–è®º',
          'å®¿å‘½',
          'æ•‘èµ',
          'èƒŒå›',
          'çœŸç†',
          'è°è¨€',
          'è¾¹ç•Œ',
          'è™šæ— ',
          'é‡åŠ›',
          'å›å£°',
          'å™©æ¢¦',
          'ç«¥è¯',
          'ç¥ˆç¥·',
          'è¯…å’’',
          'å¥‘çº¦',
          'ç¦å¿Œ',
          'è§„åˆ™',
          'åè§',
          'èµç½ª',
          'è½®å›',
          'å€’å¸¦',
          'é‡å¯',
          'ç©ºç™½',
          'åŒ¿å',
          'æœªå¯„å‡ºçš„ä¿¡',
          'æœªè¯»æ¶ˆæ¯',
          'å‡Œæ™¨ä¸‰ç‚¹',
          'æ˜ŸæœŸä¸‰',
          'ç¬¬ä¸ƒæ¬¡',
          'ç¬¬äºŒäººæ ¼',
          'å®Œç¾ä¸»ä¹‰',
          'å¤±æ§',
          'æ¸©æŸ”',
          'æ®‹é…·',
          'æµªæ¼«',
          'è’è¯',
          'å¯‚é™',
          'å–§åš£',
          'ä½è¯­',
          'å‡è§†',
          'åçˆ±',
          'è¯¯è§£',
        ],
        // å½¢å®¹è¯/çŠ¶æ€ï¼šç”¨äºç»„åˆæˆçŸ­è¯­
        adjs: [
          'æ½®æ¹¿çš„',
          'å¹²ç‡¥çš„',
          'å†°å†·çš„',
          'ç¼çƒ­çš„',
          'é€æ˜çš„',
          'å‘å…‰çš„',
          'è„†å¼±çš„',
          'é”‹åˆ©çš„',
          'æ¸©æŸ”çš„',
          'æš´èºçš„',
          'æ— å£°çš„',
          'å–§åš£çš„',
          'ç ´ç¢çš„',
          'å®Œæ•´çš„',
          'å‡‹é›¶çš„',
          'æ–°ç”Ÿçš„',
          'è¿Ÿåˆ°çš„',
          'è¿‡æœŸçš„',
          'ç©ºç™½çš„',
          'åŒ¿åçš„',
          'æœ€åçš„',
          'ç¬¬ä¸€çš„',
          'æœªå‘½åçš„',
          'ç¦å¿Œçš„',
          'è’è¯çš„',
          'ç¥ç§˜çš„',
          'ä¼˜é›…çš„',
          'å±é™©çš„',
          'ç”œçš„',
          'è‹¦çš„',
          'å’¸çš„',
          'å¾®é†ºçš„',
          'é»¯æ·¡çš„',
          'é—ªçƒçš„',
          'ç»†ç¢çš„',
          'é»ç€çš„',
        ],
        // åŠ¨è¯ï¼šç»„åˆæˆâ€œåè¯+åŠ¨è¯+åè¯â€
        verbs: [
          'å·èµ°',
          'é—å¿˜',
          'æ”¶è—',
          'æŠ˜å ',
          'ç¿»è¯‘',
          'ç‚¹ç‡ƒ',
          'å†»ç»“',
          'å´©å¡Œ',
          'è‹é†’',
          'æ²‰ç¡',
          'å›æ”¶',
          'é‡å¯',
          'æ½œå…¥',
          'ç¼ ç»•',
          'æ¼‚æµ',
          'å€’å¸¦',
          'æŠ•å½±',
          'çƒ™å°',
          'ç­¾å­—',
          'å€Ÿèµ°',
          'å½’è¿˜',
          'äº¤æ¢',
          'å°å­˜',
          'èµå›',
          'è¿½é€',
          'å‡è§†',
        ],
        // å¾®å¥å­/çŸ­è¯­ï¼šæ›´â€œæœ‰è¶£ä½†ä¸ä¿—å¥—â€
        phrases: [
          'åˆ«å›å¤´',
          'è¯·ç­¾å­—',
          'ä»Šæ™šæ— çœ ',
          'æŠŠç«ç•™ç»™æˆ‘',
          'åˆ«æŠŠåå­—è¯´å‡ºæ¥',
          'æŠŠé’¥åŒ™äº¤å‡ºæ¥',
          'åœ¨é›¨é‡Œç­‰ä½ ',
          'ä½ å¬è§äº†å—',
          'åˆ«è£…ä½œæ— äº‹å‘ç”Ÿ',
          'æ„¿æœ›è¦ä»˜å‡ºä»£ä»·',
          'åªè®¸ä¸€æ¬¡',
          'æˆ‘ä¸æ¬ ä½ ',
          'ä½ æ¬ æˆ‘ä¸€ä¸ªè§£é‡Š',
          'æŠŠå…‰å…³æ‰',
          'æŠŠé—¨é”ä¸Š',
          'åˆ«è®©å®ƒé†’æ¥',
          'åˆ«æŠŠæˆ‘å¿˜äº†',
          'æŠŠèª“è¨€çƒ§æ‰',
          'æŠŠè°è¨€åä¸‹',
        ],
        // å°‘é‡ç¬¦å·/è‹±æ–‡ï¼šå¢åŠ â€œä¸‡ç‰©â€è§¦æ„Ÿ
        symbols: ['âˆ', '0', '1', '7', '13', '404', 'NULL', 'NO SIGNAL', 'DEAD END', '#tag', '???'],
        // æœ€æ¶å¿ƒä¸Šé™ï¼šæä½æ¦‚ç‡å‡ºç°
        edge: ['å°¿æ¶²', 'å­•è‚š'],
      };

      function sanitizeLimitedTag(tag) {
        if (tag === null || tag === undefined) return 'â€”';
        let t = String(tag)
          .replace(/[\r\n\t]+/g, ' ')
          .replace(/\s{2,}/g, ' ')
          .trim();
        t = t.replace(/^["â€œâ€'ã€Œã€ã€ã€ã€Šã€‹ã€ã€‘ï¼ˆï¼‰()]+/, '').replace(/["â€œâ€'ã€Œã€ã€ã€ã€Šã€‹ã€ã€‘ï¼ˆï¼‰()]+$/, '');
        t = t.replace(/\s{2,}/g, ' ').trim();
        if (!t) return 'â€”';
        const maxLen = 26;
        if (t.length > maxLen) t = t.slice(0, maxLen) + 'â€¦';
        return t;
      }

      function isLimitedTagBanned(tag) {
        const t = String(tag || '');
        if (!t.trim()) return true;

        // å…è®¸çš„â€œæœ€æ¶å¿ƒä¸Šé™â€ï¼šå°¿æ¶²/å­•è‚šï¼ˆä»ç„¶ä¼šè¢«è¯„åˆ†æœºåˆ¶é™ä½å‡ºç°æ¦‚ç‡ï¼‰
        // ä½†ç¦æ­¢æ¯”è¿™æ›´æ¶å¿ƒçš„ï¼šç²ªä¾¿/æœˆç»/è…çƒ‚/è™«/å°¸/é‡å£è¡€è…¥ç­‰
        const bannedPatterns = [
          /(å±|ç²ª|å¤§ä¾¿|ä¾¿ä¾¿|ç²ªä¾¿|é©¬æ¡¶|å•æ‰€|ç²ªå‘|æ’æ³„)/i,
          /(æœˆç»|ç»è¡€|è¡€å—|ç»æœŸ)/i,
          /(å‘•å|å‘•|å|å‘•åç‰©)/i,
          /(è…çƒ‚|è…è´¥|è…è‡­|è„“|åŒ–è„“|çƒ‚è‚‰|è›†)/i,
          /(å°¸å¥¸|æ­»å°¸|å°¸ä½“|è…å°¸|é£Ÿå°¸|åƒµå°¸|é£Ÿå°¸é¬¼|æœ¨ä¹ƒä¼Š)/i,
          /(æ–­è‚¢|æˆªè‚¢|æ®‹è‚¢|å¼€è†›|å†…è„|è‚ å­|è„‘æµ†|å‰–è…¹|ç¢å°¸|è¡€è…¥)/i,
          /(æ˜†è™«|è •è™«|è™«å­|å¯„ç”Ÿè™«|èŸ‘è‚|èœ˜è››|èå­|èœˆèš£|è›†è™«)/i,
          /(å…¨å…½|å…½åŒ–|å…½äºº|ç‹—äºº|çŒ«äºº|ç‹¼äºº|ç‹äºº)/i,
          /(è‚¥èƒ–|èƒ–å­|ä¸‘|ä¸‘é™‹|çŒ¥ç|ç§ƒå¤´|å…‰å¤´|æ²¹è…»|è€äºº|å¤§å”)/i,
        ];
        if (bannedPatterns.some(re => re.test(t))) return true;
        return false;
      }

      function limitedTagKind(tag) {
        const t = String(tag || '').trim();
        if (!t) return 'empty';
        if (t.length === 1) return 'char';
        if (/^[0-9]+$/.test(t)) return 'symbol';
        if (/[ã€Œã€ã€ã€ã€Šã€‹ã€ã€‘]/.test(t)) return 'quote';
        if (/[ï¼Œã€‚ï¼ï¼Ÿâ€¦]/.test(t)) return 'sentence';
        if (/[çš„ä¸åœ¨æŠŠåˆ«è¯·]/.test(t)) return 'phrase';
        return 'word';
      }

      function pickOne(arr) {
        return arr[randInt(0, arr.length - 1)];
      }

      function pickWeighted(pairs) {
        // pairs: [ [value, weight], ... ]
        const total = pairs.reduce((s, p) => s + (p?.[1] || 0), 0);
        if (total <= 0) return pairs?.[0]?.[0];
        let r = rand01() * total;
        for (const [val, w] of pairs) {
          r -= w;
          if (r <= 0) return val;
        }
        return pairs[pairs.length - 1][0];
      }

      function generateRawLimitedTag() {
        const mode = pickWeighted([
          ['char', 0.12],
          ['word', 0.34],
          ['adjNoun', 0.18],
          ['nounOfNoun', 0.12],
          ['nounVerbNoun', 0.1],
          ['quote', 0.06],
          ['sentence', 0.05],
          ['symbolMix', 0.02],
          ['edge', 0.01],
        ]);

        const noun = () => pickOne(LIMITED_TAG_SOURCES.nouns);
        const concept = () => pickOne(LIMITED_TAG_SOURCES.concepts);
        const adj = () => pickOne(LIMITED_TAG_SOURCES.adjs);
        const verb = () => pickOne(LIMITED_TAG_SOURCES.verbs);
        const phrase = () => pickOne(LIMITED_TAG_SOURCES.phrases);
        const symbol = () => pickOne(LIMITED_TAG_SOURCES.symbols);

        switch (mode) {
          case 'char':
            return pickOne(LIMITED_TAG_SOURCES.chars);
          case 'word': {
            // è¯è¯­ï¼šå®ç‰©/æ¦‚å¿µæ··åˆ
            return rand01() < 0.6 ? noun() : concept();
          }
          case 'adjNoun':
            return adj() + (rand01() < 0.65 ? noun() : concept());
          case 'nounOfNoun':
            return (rand01() < 0.6 ? noun() : concept()) + 'çš„' + (rand01() < 0.7 ? noun() : concept());
          case 'nounVerbNoun':
            return (rand01() < 0.55 ? noun() : concept()) + verb() + (rand01() < 0.7 ? noun() : concept());
          case 'quote':
            return rand01() < 0.5 ? `ã€Œ${phrase()}ã€` : `ã€Š${phrase()}ã€‹`;
          case 'sentence': {
            const t = pickWeighted([
              [`${phrase()}ã€‚`, 0.4],
              [`${phrase()}ï¼Œ${phrase()}ã€‚`, 0.25],
              [`${adj()}${noun()}ï¼Œ${phrase()}ã€‚`, 0.2],
              [`${concept()}ï¼Œ${noun()}ã€‚`, 0.15],
            ]);
            return t;
          }
          case 'symbolMix':
            return `${symbol()} ${rand01() < 0.6 ? noun() : concept()}`;
          case 'edge':
            return pickOne(LIMITED_TAG_SOURCES.edge);
          default:
            return noun();
        }
      }

      function scoreLimitedTagPair(t1, t2) {
        if (!t1 || !t2) return -999;
        if (t1 === 'â€”' || t2 === 'â€”') return -999;
        if (t1 === t2) return -999;
        if (isLimitedTagBanned(t1) || isLimitedTagBanned(t2)) return -999;

        const edgeRe = /(å°¿æ¶²|å­•è‚š|æ€€å­•)/i;
        const tropeRe = /(å¥³ä»†|æŠ¤å£«|ä¿®å¥³|é­…é­”|çŒ«å¨˜|å…”å¥³éƒ|ç§˜ä¹¦|å¶åƒ|å…¬ä¸»|å¥³ç‹)/;

        const k1 = limitedTagKind(t1);
        const k2 = limitedTagKind(t2);
        let score = 0;

        // å½¢æ€å¤šæ ·æ€§ï¼šä¸åŒâ€œè¯æ€§/ç»“æ„â€æ›´æœ‰è¶£
        if (k1 !== k2) score += 2;

        // é•¿åº¦åå¥½ï¼š2~14 æ›´å®¹æ˜“â€œè½¬è¯‘è½åœ°â€
        const lenScore = t => {
          const l = String(t).length;
          if (l === 1) return 0;
          if (l >= 2 && l <= 10) return 2;
          if (l <= 14) return 1;
          if (l <= 20) return 0;
          return -1;
        };
        score += lenScore(t1) + lenScore(t2);

        // æœ‰å¼•å·/å¥å­/ç¬¦å·ï¼šåŠ â€œä¸‡ç‰©æ„Ÿâ€
        if (/[ã€Œã€ã€ã€ã€Šã€‹ã€ã€‘]/.test(t1)) score += 2;
        if (/[ã€Œã€ã€ã€ã€Šã€‹ã€ã€‘]/.test(t2)) score += 2;
        if (/[ï¼Œã€‚ï¼ï¼Ÿâ€¦]/.test(t1)) score += 1;
        if (/[ï¼Œã€‚ï¼ï¼Ÿâ€¦]/.test(t2)) score += 1;
        if (/[âˆ#?]/.test(t1)) score += 0.5;
        if (/[âˆ#?]/.test(t2)) score += 0.5;

        // â€œä¿—å¥—â€æƒ©ç½šï¼šä¸æ˜¯ç¦æ­¢ï¼Œåªæ˜¯é™ä½å‡ºç°é¢‘ç‡
        if (tropeRe.test(t1)) score -= 2;
        if (tropeRe.test(t2)) score -= 2;

        // æ¶å¿ƒä¸Šé™æƒ©ç½šï¼šå…è®¸ï¼Œä½†å°½é‡å°‘å‡ºç°
        if (edgeRe.test(t1)) score -= 4;
        if (edgeRe.test(t2)) score -= 4;
        if (edgeRe.test(t1) && edgeRe.test(t2)) score -= 50;

        // ä¸¤ä¸ªéƒ½åªæœ‰å•å­— -> å¤ªé£˜
        if (String(t1).length === 1 && String(t2).length === 1) score -= 3;

        // å¾®éšæœºæ‰“æ•£
        score += rand01() * 0.01;
        return score;
      }

      function generateLimitedTags() {
        // é‡‡æ · + è¯„åˆ†ï¼šå…ˆç”Ÿæˆå¾ˆå¤šå€™é€‰ç»„åˆï¼Œå†æŒ‘â€œæœ€åƒä¸‡ç‰©ä½†ä¸æ¶å¿ƒä¸”å¯è½¬è¯‘â€çš„
        let best = null;
        let bestScore = -999;

        const tryCount = 80;
        for (let i = 0; i < tryCount; i++) {
          let t1 = sanitizeLimitedTag(generateRawLimitedTag());
          let t2 = sanitizeLimitedTag(generateRawLimitedTag());

          // è½»åº¦å»é‡ä¸è¿‡æ»¤
          if (t1 === t2) continue;
          if (isLimitedTagBanned(t1) || isLimitedTagBanned(t2)) continue;

          const s = scoreLimitedTagPair(t1, t2);
          if (s > bestScore) {
            bestScore = s;
            best = [t1, t2];
          }
        }

        return best || ['â€”', 'â€”'];
      }

      function getLimitedPoolState() {
        if (!gameState.å¡æ± ) gameState.å¡æ±  = {};
        if (!gameState.å¡æ± .é™å®š) {
          gameState.å¡æ± .é™å®š = { è¯æ¡: ['â€”', 'â€”'], å‘¨æœŸ: -1 };
        }
        return gameState.å¡æ± .é™å®š;
      }

      function updateLimitedPoolIfNeeded() {
        const gameTime = getGameTime();
        const period = Math.floor(((gameTime.å¤©æ•° || 1) - 1) / 3);
        const state = getLimitedPoolState();
        if (state.å‘¨æœŸ !== period || !state.è¯æ¡ || state.è¯æ¡.length !== 2) {
          // ä½¿ç”¨â€œä¸‡ç‰©è¯æ¡ + å®¡ç¾å®‰å…¨ç½‘â€ç”Ÿæˆè¯æ¡
          const [t1, t2] = generateLimitedTags();
          state.è¯æ¡ = [t1, t2];
          state.å‘¨æœŸ = period;
          console.info('é™å®šå¡æ± æ›´æ–°:', state.è¯æ¡, 'ï¼ˆä¸‡ç‰©è¯æ¡ + å®¡ç¾å®‰å…¨ç½‘ï¼‰', 'å‘¨æœŸ', state.å‘¨æœŸ);
        }
        return state;
      }

      // è·å–å½“å‰æ—¶æ®µ
      function getCurrentTimePeriod() {
        const gameTime = getGameTime();
        return gameTime.å½“å‰æ—¶æ®µ || 'æ—©ä¸Š';
      }

      // æ¨è¿›å›åˆï¼ˆæ‰‹åŠ¨è§¦å‘æˆ–è‡ªåŠ¨è§¦å‘ï¼‰
      function advanceRound() {
        const gameTime = getGameTime();
        const prevRound = gameTime.å½“å‰å›åˆ;
        const prevRoundInDay = ((prevRound - 1) % 3) + 1;

        gameTime.å½“å‰å›åˆ = prevRound + 1;
        normalizeGameTime(gameTime);
        // å¯èƒ½è·¨å¤©/è·¨å‘¨æœŸï¼šæ›´æ–°é™å®šå¡æ± è¯æ¡
        updateLimitedPoolIfNeeded();

        // å¤„ç†æ¥å®¢å®Œæˆäº‹ä»¶ï¼ˆæ¯å›åˆæ£€æŸ¥ï¼‰
        processGameSettlement();

        // ä¸€å¤©åˆ†ä¸ºæ—©/ä¸­/æ™šï¼ˆ3å›åˆï¼‰ã€‚å½“â€œå¤œæ™šâ†’æ¬¡æ—¥æ—©ä¸Šâ€ï¼ˆ3â†’1ï¼‰æ—¶ï¼Œç»“ç®—ä¸Šä¸€å¤©ã€‚
        const newRoundInDay = ((gameTime.å½“å‰å›åˆ - 1) % 3) + 1;
        if (prevRoundInDay === 3 && newRoundInDay === 1) {
          processDailySettlement();
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        if (gameState.ç»Ÿè®¡æ•°æ®) {
          gameState.ç»Ÿè®¡æ•°æ®.æ¸¸æˆæ—¶é—´ = gameTime.å½“å‰å›åˆ;
        }

        // ä¿æŠ¤ï¼šç¡®ä¿æ‰€æœ‰æœ‰è§’è‰²çš„æˆ¿é—´çŠ¶æ€éƒ½æ˜¯"ä½¿ç”¨ä¸­"ï¼ˆé˜²æ­¢AIæˆ–é€»è¾‘é”™è¯¯å¯¼è‡´çŠ¶æ€è¢«é‡ç½®ï¼‰
        // åŒæ—¶ç¡®ä¿è‡ªåŠ¨è¥ä¸šåˆ†é…çš„è§’è‰²æœ‰æ­£ç¡®çš„workingInfo
        if (gameState.å¦“é™¢?.æˆ¿é—´çŠ¶æ€) {
          Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).forEach(([roomId, room]) => {
            if (room.å½“å‰è§’è‰²) {
              if (room.çŠ¶æ€ !== 'ä½¿ç”¨ä¸­') {
                console.warn(`ä¿®å¤æˆ¿é—´ ${roomId} çŠ¶æ€ï¼šä»"${room.çŠ¶æ€}"æ”¹ä¸º"ä½¿ç”¨ä¸­"ï¼ˆå›åˆæ¨è¿›åæ£€æŸ¥ï¼‰`);
                room.çŠ¶æ€ = 'ä½¿ç”¨ä¸­';
              }
              const char = gameState.è§’è‰²ä»“åº“?.[room.å½“å‰è§’è‰²];
              if (char) {
                // æ ¹æ®æˆ¿é—´ç±»å‹ç¡®ä¿è§’è‰²çŠ¶æ€æ­£ç¡®
                if (room.ç±»å‹ === 'è°ƒæ•™å®¤' && char.çŠ¶æ€ !== 'è°ƒæ•™ä¸­') {
                  char.çŠ¶æ€ = 'è°ƒæ•™ä¸­';
                } else if (room.ç±»å‹ !== 'è°ƒæ•™å®¤' && char.çŠ¶æ€ !== 'æ¥å®¢ä¸­') {
                  char.çŠ¶æ€ = 'æ¥å®¢ä¸­';
                  // ç¡®ä¿æœ‰workingInfoï¼ˆè‡ªåŠ¨è¥ä¸šåˆ†é…çš„è§’è‰²å¯èƒ½ç¼ºå°‘ï¼‰
                  if (!gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[room.å½“å‰è§’è‰²]) {
                    console.warn(`ä¿®å¤ï¼šæˆ¿é—´ ${roomId} çš„è§’è‰² ${room.å½“å‰è§’è‰²} ç¼ºå°‘æ¥å®¢ä¿¡æ¯ï¼Œé‡æ–°åˆ›å»º`);
                    const workingInfo = createWorkingInfoLocal(char, room, gameTime.å½“å‰å›åˆ);
                    if (!gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²) gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰² = {};
                    gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[room.å½“å‰è§’è‰²] = workingInfo;
                  }
                }
              }
            }
          });
        }

        // ==================== å…³é”®ä¿®å¤ï¼šè‡ªåŠ¨è¥ä¸šåº”è¯¥åœ¨æ‰€æœ‰ç»“ç®—å®Œæˆåè°ƒç”¨ ====================
        // ç¡®ä¿ä¸ä¼šåˆ†é…åˆšåˆšå®Œæˆæ¥å®¢çš„è§’è‰²
        if (gameState.è®¾ç½®?.è‡ªåŠ¨è¥ä¸š && gameState.å¦“é™¢?.è¥ä¸šçŠ¶æ€ !== 'æš‚åœè¥ä¸š') {
          processAutoBusiness();
        }

        refreshAllPages();
        saveImmediately(); // å›åˆæ¨è¿›æ˜¯å…³é”®æ“ä½œï¼Œç«‹å³ä¿å­˜
        console.info(`æ¨è¿›åˆ°ç¬¬${gameTime.å¤©æ•°}å¤© ${gameTime.å½“å‰æ—¶æ®µ}ï¼ˆå›åˆ ${gameTime.å½“å‰å›åˆ}ï¼‰`);
      }

      function processGameSettlement() {
        const gameTime = getGameTime();
        console.info('æ‰§è¡Œæ¸¸æˆç»“ç®—...');

        // ==================== å…³é”®ä¿®å¤ï¼šå…ˆæ”¶é›†æ‰€æœ‰åˆ°æœŸçš„æ¥å®¢ï¼Œå†ç»Ÿä¸€å¤„ç† ====================
        // é¿å…åœ¨éå†è¿‡ç¨‹ä¸­ä¿®æ”¹å¯¹è±¡å¯¼è‡´é—æ¼
        const allWorkingChars = Object.entries(gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰² || {});
        const completedServices = [];
        const staminaExhausted = [];

        // 1. å…ˆæ”¶é›†æ‰€æœ‰åˆ°æœŸçš„æ¥å®¢ï¼ˆåœ¨ä½“åŠ›æ¶ˆè€—ä¹‹å‰ï¼Œé¿å…ä½“åŠ›æ¶ˆè€—æ—¶åˆ é™¤å¯¼è‡´é—æ¼ï¼‰
        // ==================== å…³é”®ä¿®å¤ï¼šä¸¥æ ¼æŒ‰ç…§å˜é‡æ›´æ–°è§„åˆ™æ£€æŸ¥ ====================
        // è§„åˆ™ï¼šå½“ æ¸¸æˆæ—¶é—´.å½“å‰å›åˆ >= é¢„è®¡ç»“æŸå›åˆ æ—¶ï¼Œè§¦å‘ç»“ç®—äº‹ä»¶ï¼Œç§»é™¤è¯¥è®°å½•
        allWorkingChars.forEach(([characterId, workingInfo]) => {
          if (!workingInfo) return;
          // å¿…é¡»ä½¿ç”¨ workingInfo.é¢„è®¡ç»“æŸå›åˆï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¯´æ˜æ•°æ®å¼‚å¸¸ï¼Œåº”è¯¥å®Œæˆæ¥å®¢
          const endRound = workingInfo.é¢„è®¡ç»“æŸå›åˆ;
          if (endRound === undefined || endRound === null) {
            // æ•°æ®å¼‚å¸¸ï¼šæ²¡æœ‰é¢„è®¡ç»“æŸå›åˆï¼Œå¼ºåˆ¶å®Œæˆæ¥å®¢
            console.warn(`è§’è‰² ${characterId} çš„æ¥å®¢ä¿¡æ¯ç¼ºå°‘é¢„è®¡ç»“æŸå›åˆï¼Œå¼ºåˆ¶å®Œæˆæ¥å®¢`);
            completedServices.push(characterId);
            return;
          }
          // ä¸¥æ ¼æŒ‰ç…§è§„åˆ™ï¼šå½“å‰å›åˆ >= é¢„è®¡ç»“æŸå›åˆ æ—¶ï¼Œå¿…é¡»å®Œæˆæ¥å®¢
          if (gameTime.å½“å‰å›åˆ >= endRound) {
            completedServices.push(characterId);
            const startRound = workingInfo.å¼€å§‹å›åˆ || gameTime.å½“å‰å›åˆ - 1;
            console.info(
              `æ£€æµ‹åˆ°è§’è‰² ${characterId} æ¥å®¢å·²åˆ°æœŸï¼ˆå¼€å§‹å›åˆ: ${startRound}, é¢„è®¡ç»“æŸå›åˆ: ${endRound}, å½“å‰å›åˆ: ${gameTime.å½“å‰å›åˆ}ï¼‰ï¼Œç«‹å³å®Œæˆ`,
            );
          }
        });

        // 2. å¤„ç†æ¥å®¢ä¸­çš„è§’è‰²ï¼šæ¶ˆè€—ä½“åŠ›ï¼ˆåœ¨å®Œæˆæ£€æŸ¥ä¹‹å‰ï¼Œç¡®ä¿å®Œæˆæ—¶ä½“åŠ›å·²æ¶ˆè€—ï¼‰
        // ==================== å…³é”®ä¿®å¤ï¼šä¸ä»…å¤„ç†å½“å‰æ¥å®¢è§’è‰²ä¸­çš„è§’è‰²ï¼Œè¿˜è¦å¤„ç†æ‰€æœ‰åœ¨æˆ¿é—´ä¸­æ¥å®¢çš„è§’è‰² ====================
        // æ”¶é›†æ‰€æœ‰éœ€è¦æ¶ˆè€—ä½“åŠ›çš„è§’è‰²ï¼ˆåŒ…æ‹¬åœ¨æˆ¿é—´ä¸­æ¥å®¢ä½†å¯èƒ½æ²¡æœ‰workingInfoçš„è§’è‰²ï¼‰
        const charsToConsumeStamina = new Set();

        // ä»å½“å‰æ¥å®¢è§’è‰²ä¸­æ”¶é›†
        allWorkingChars.forEach(([characterId]) => {
          if (!completedServices.includes(characterId)) {
            charsToConsumeStamina.add(characterId);
          }
        });

        // ä»æˆ¿é—´ä¸­æ”¶é›†æ‰€æœ‰æ¥å®¢ä¸­çš„è§’è‰²ï¼ˆç¡®ä¿ä¸ä¼šé—æ¼ï¼‰
        if (gameState.å¦“é™¢?.æˆ¿é—´çŠ¶æ€) {
          Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).forEach(([roomId, room]) => {
            if (room.å½“å‰è§’è‰² && room.ç±»å‹ !== 'è°ƒæ•™å®¤') {
              const char = gameState.è§’è‰²ä»“åº“?.[room.å½“å‰è§’è‰²];
              if (char && char.çŠ¶æ€ === 'æ¥å®¢ä¸­' && !completedServices.includes(room.å½“å‰è§’è‰²)) {
                charsToConsumeStamina.add(room.å½“å‰è§’è‰²);
                // å¦‚æœè§’è‰²åœ¨æˆ¿é—´ä¸­æ¥å®¢ä½†æ²¡æœ‰workingInfoï¼Œåˆ›å»ºå®ƒï¼ˆä¿®å¤æ•°æ®ä¸ä¸€è‡´ï¼‰
                if (!gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[room.å½“å‰è§’è‰²]) {
                  console.warn(`ä¿®å¤ï¼šè§’è‰² ${room.å½“å‰è§’è‰²} åœ¨æˆ¿é—´ ${roomId} ä¸­æ¥å®¢ä½†ç¼ºå°‘æ¥å®¢ä¿¡æ¯ï¼Œé‡æ–°åˆ›å»º`);
                  const workingInfo = createWorkingInfoLocal(char, room, gameTime.å½“å‰å›åˆ);
                  if (!gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²) gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰² = {};
                  gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[room.å½“å‰è§’è‰²] = workingInfo;
                }
              }
            }
          });
        }

        // å¯¹æ‰€æœ‰éœ€è¦æ¶ˆè€—ä½“åŠ›çš„è§’è‰²è¿›è¡Œä½“åŠ›æ‰£é™¤
        charsToConsumeStamina.forEach(characterId => {
          const char = gameState.è§’è‰²ä»“åº“?.[characterId];
          if (!char) return;

          const workingInfo = gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[characterId];

          // åˆå§‹åŒ–ä½“åŠ›å€¼
          if (typeof char.ä½“åŠ›å€¼ !== 'number') char.ä½“åŠ›å€¼ = 100;
          if (!char.å±æ€§) char.å±æ€§ = {};
          if (typeof char.å±æ€§.è€åŠ› !== 'number') char.å±æ€§.è€åŠ› = 50;

          // æ ¹æ®è€åŠ›å€¼è®¡ç®—ä½“åŠ›æ¶ˆè€—é€Ÿåº¦ï¼ˆè€åŠ›è¶Šé«˜ï¼Œæ¶ˆè€—è¶Šæ…¢ï¼‰
          // åŸºç¡€æ¶ˆè€—ï¼šæ¯å›åˆ5-10ç‚¹ï¼Œè€åŠ›å€¼å½±å“ï¼šè€åŠ›50ä¸ºåŸºå‡†ï¼Œæ¯10ç‚¹è€åŠ›å‡å°‘10%æ¶ˆè€—
          // ä¿®å¤ï¼šç¡®ä¿ä½“åŠ›æ¶ˆè€—æ˜¯åˆç†çš„ï¼Œä¸ä¼šè¿‡å¿«æˆ–è¿‡æ…¢
          const baseConsume = randInt(5, 10);
          // è€åŠ›å€¼è¶Šé«˜ï¼Œæ¶ˆè€—è¶Šæ…¢ï¼ˆ50ä¸ºåŸºå‡†ï¼Œæ¯10ç‚¹å‡å°‘10%ï¼Œæœ€ä½30%ï¼‰
          const enduranceValue = char.å±æ€§.è€åŠ› || 50;
          const staminaFactor = Math.max(0.3, 1.0 - (enduranceValue - 50) / 100);
          let consume = Math.max(1, Math.floor(baseConsume * staminaFactor));

          // ç¡®ä¿æ¶ˆè€—ä¸ä¼šä¸º0æˆ–è´Ÿæ•°
          if (consume <= 0) consume = 1;

          // ==================== æˆ¿é—´ç±»å‹ç‰¹æ®Šæ•ˆæœï¼šä½“åŠ›æ¶ˆè€—å€ç‡ ====================
          const targetRoomId = Object.keys(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€ || {}).find(
            id => gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[id].å½“å‰è§’è‰² === characterId,
          );
          if (targetRoomId) {
            const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[targetRoomId];
            const specialEffects = workingInfo?.ç‰¹æ®Šæ•ˆæœ || {};
            // æƒ…è¶£æˆ¿ï¼šæé™æŒ‘æˆ˜ï¼Œä½“åŠ›æ¶ˆè€—Ã—1.5
            if (room.ç±»å‹ === 'æƒ…è¶£æˆ¿' && specialEffects.æé™æŒ‘æˆ˜ && specialEffects.ä½“åŠ›æ¶ˆè€—å€ç‡) {
              consume = Math.floor(consume * specialEffects.ä½“åŠ›æ¶ˆè€—å€ç‡);
            }
          }

          const prevStamina = char.ä½“åŠ›å€¼;
          char.ä½“åŠ›å€¼ = Math.max(0, char.ä½“åŠ›å€¼ - consume);
          console.info(`è§’è‰² ${char.å§“å} ä½“åŠ›æ¶ˆè€—: ${prevStamina} -> ${char.ä½“åŠ›å€¼} (æ¶ˆè€—${consume}ç‚¹)`);

          // è®°å½•ä½“åŠ›æ¶ˆè€—åˆ°äº‹ä»¶æ—¥å¿—
          const roomInfo = targetRoomId ? `ï¼ˆæˆ¿é—´${targetRoomId}ï¼‰` : '';
          pushBrothelLog({
            æ—¶é—´æˆ³: gameTime.å½“å‰å›åˆ,
            è§’è‰²ID: characterId,
            äº‹ä»¶ç±»å‹: 'ä½“åŠ›æ¶ˆè€—',
            æè¿°: `${char.å§“å}${roomInfo}æ¥å®¢ä¸­æ¶ˆè€—ä½“åŠ›${consume}ç‚¹ï¼ˆ${prevStamina} â†’ ${char.ä½“åŠ›å€¼}ï¼‰`,
            æ”¶å…¥å˜åŒ–: 0,
          });

          // ä½“åŠ›è§åº•ï¼šæ ‡è®°ä¸ºéœ€è¦ç§»å‡ºï¼ˆä¸ç«‹å³åˆ é™¤ï¼Œç­‰å®Œæˆæ¥å®¢åå†å¤„ç†ï¼‰
          if (char.ä½“åŠ›å€¼ <= 0) {
            staminaExhausted.push(characterId);
          }
        });

        // 3. å¤„ç†æ‰€æœ‰åˆ°æœŸçš„æ¥å®¢ï¼ˆå…ˆå®Œæˆæ¥å®¢ï¼Œå†å¤„ç†ä½“åŠ›è€—å°½ï¼‰
        // ==================== å…³é”®ä¿®å¤ï¼šç¡®ä¿åˆ°æœŸæ¥å®¢å¿…é¡»å®Œæˆ ====================
        completedServices.forEach(characterId => {
          // å†æ¬¡æ£€æŸ¥è§’è‰²æ˜¯å¦è¿˜åœ¨æ¥å®¢ä¸­ï¼ˆé˜²æ­¢åœ¨å¤„ç†è¿‡ç¨‹ä¸­è¢«å…¶ä»–é€»è¾‘ä¿®æ”¹ï¼‰
          if (gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[characterId]) {
            const char = gameState.è§’è‰²ä»“åº“?.[characterId];
            if (char) {
              console.info(`å®Œæˆæ¥å®¢: è§’è‰² ${characterId}ï¼ˆ${char.å§“å}ï¼Œé¢„è®¡ç»“æŸå›åˆå·²åˆ°ï¼‰`);
              completeWorkingService(characterId);

              // åŒé‡ä¿é™©ï¼šç¡®ä¿æˆ¿é—´çŠ¶æ€å·²æ›´æ–°
              const targetRoomId = Object.keys(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€ || {}).find(
                id => gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[id].å½“å‰è§’è‰² === characterId,
              );
              if (targetRoomId) {
                const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[targetRoomId];
                if (room.çŠ¶æ€ !== 'ç©ºé—²' || room.å½“å‰è§’è‰² !== undefined) {
                  console.warn(`å¼ºåˆ¶ä¿®å¤æˆ¿é—´ ${targetRoomId} çŠ¶æ€ï¼šåº”ä¸ºç©ºé—²`);
                  room.çŠ¶æ€ = 'ç©ºé—²';
                  room.å½“å‰è§’è‰² = undefined;
                }
              }

              // åŒé‡ä¿é™©ï¼šç¡®ä¿è§’è‰²çŠ¶æ€å·²æ›´æ–°
              if (char.çŠ¶æ€ !== 'ç©ºé—²' || char.å½“å‰ä½ç½® !== 'ä»“åº“') {
                console.warn(`å¼ºåˆ¶ä¿®å¤è§’è‰² ${characterId} çŠ¶æ€ï¼šåº”ä¸ºç©ºé—²`);
                char.çŠ¶æ€ = 'ç©ºé—²';
                char.å½“å‰ä½ç½® = 'ä»“åº“';
              }

              // åŒé‡ä¿é™©ï¼šç¡®ä¿æ¥å®¢ä¿¡æ¯å·²åˆ é™¤
              if (gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[characterId]) {
                console.warn(`å¼ºåˆ¶åˆ é™¤è§’è‰² ${characterId} çš„æ¥å®¢ä¿¡æ¯`);
                delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[characterId];
              }
            } else {
              // è§’è‰²ä¸å­˜åœ¨ï¼Œç›´æ¥æ¸…ç†æ¥å®¢ä¿¡æ¯
              console.warn(`è§’è‰² ${characterId} ä¸å­˜åœ¨ï¼Œæ¸…ç†æ¥å®¢ä¿¡æ¯`);
              delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[characterId];
            }
          }
        });

        // 4. å¤„ç†ä½“åŠ›è€—å°½çš„è§’è‰²ï¼ˆå¦‚æœè¿˜æ²¡å®Œæˆæ¥å®¢ï¼‰
        staminaExhausted.forEach(characterId => {
          // å¦‚æœå·²ç»åœ¨completedServicesä¸­ï¼Œè¯´æ˜å·²ç»å®Œæˆæ¥å®¢ï¼Œè·³è¿‡
          if (completedServices.includes(characterId)) return;

          // å†æ¬¡æ£€æŸ¥è§’è‰²æ˜¯å¦è¿˜åœ¨æ¥å®¢ä¸­
          if (!gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[characterId]) return;

          const char = gameState.è§’è‰²ä»“åº“?.[characterId];
          if (!char) return;

          const targetRoomId = Object.keys(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).find(
            id => gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[id].å½“å‰è§’è‰² === characterId,
          );
          if (targetRoomId) {
            const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[targetRoomId];
            room.çŠ¶æ€ = 'ç©ºé—²';
            room.å½“å‰è§’è‰² = undefined;
          }
          char.çŠ¶æ€ = 'ç©ºé—²';
          char.å½“å‰ä½ç½® = 'ä»“åº“';
          delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[characterId];
          pushBrothelLog({
            æ—¶é—´æˆ³: gameTime.å½“å‰å›åˆ,
            è§’è‰²ID: characterId,
            äº‹ä»¶ç±»å‹: 'ä½“åŠ›è€—å°½',
            æè¿°: `${char.å§“å}ä½“åŠ›è€—å°½ï¼Œè‡ªåŠ¨ç§»å‡ºæˆ¿é—´`,
            æ”¶å…¥å˜åŒ–: 0,
          });
          console.info(`è§’è‰² ${char.å§“å} ä½“åŠ›è€—å°½ï¼Œå·²ç§»å‡ºæˆ¿é—´`);
        });

        // 3. å¤„ç†è°ƒæ•™å®¤è®­ç»ƒå®Œæˆï¼ˆæŒ‰è¯¾ç¨‹å¼ºåº¦ 1~3 å›åˆï¼‰
        const completedTrainings = [];
        Object.entries(gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰² || {}).forEach(([characterId, info]) => {
          const startRound = info.å¼€å§‹å›åˆ || gameTime.å½“å‰å›åˆ - 1;
          const endRound = info.é¢„è®¡ç»“æŸå›åˆ || startRound + 2;
          if (gameTime.å½“å‰å›åˆ >= endRound) {
            completedTrainings.push(characterId);
          }
        });
        completedTrainings.forEach(characterId => {
          completeTrainingSession(characterId);
        });

        // 4. å¤„ç†æ‰€æœ‰ç©ºé—²è§’è‰²ï¼šè‡ªç„¶æ¢å¤ä½“åŠ›
        Object.entries(gameState.è§’è‰²ä»“åº“ || {}).forEach(([characterId, char]) => {
          if (char.çŠ¶æ€ !== 'ç©ºé—²' || char.å½“å‰ä½ç½® !== 'ä»“åº“') return;

          // åˆå§‹åŒ–ä½“åŠ›å€¼
          if (typeof char.ä½“åŠ›å€¼ !== 'number') char.ä½“åŠ›å€¼ = 100;
          if (!char.å±æ€§) char.å±æ€§ = {};
          if (typeof char.å±æ€§.è€åŠ› !== 'number') char.å±æ€§.è€åŠ› = 50;

          // æ ¹æ®è€åŠ›å€¼è®¡ç®—æ¢å¤é€Ÿåº¦ï¼ˆè€åŠ›è¶Šé«˜ï¼Œæ¢å¤è¶Šå¿«ï¼‰
          // åŸºç¡€æ¢å¤ï¼šæ¯å›åˆ3-6ç‚¹ï¼Œè€åŠ›å€¼å½±å“ï¼šè€åŠ›50ä¸ºåŸºå‡†ï¼Œæ¯10ç‚¹è€åŠ›å¢åŠ 10%æ¢å¤
          const baseRecover = randInt(3, 6);
          const staminaFactor = Math.max(0.5, 1.0 + (char.å±æ€§.è€åŠ› - 50) / 100);
          const recover = Math.floor(baseRecover * staminaFactor);

          const prevStamina = char.ä½“åŠ›å€¼;
          char.ä½“åŠ›å€¼ = Math.min(100, char.ä½“åŠ›å€¼ + recover);
          if (prevStamina < 100 && recover > 0) {
            console.info(`è§’è‰² ${char.å§“å} ä½“åŠ›æ¢å¤: ${prevStamina} -> ${char.ä½“åŠ›å€¼} (æ¢å¤${recover}ç‚¹)`);
            // è®°å½•ä½“åŠ›æ¢å¤åˆ°äº‹ä»¶æ—¥å¿—ï¼ˆåªåœ¨æœ‰æ¢å¤æ—¶è®°å½•ï¼‰
            pushBrothelLog({
              æ—¶é—´æˆ³: gameTime.å½“å‰å›åˆ,
              è§’è‰²ID: characterId,
              äº‹ä»¶ç±»å‹: 'ä½“åŠ›æ¢å¤',
              æè¿°: `${char.å§“å}åœ¨ä»“åº“ä¼‘æ¯ï¼Œä½“åŠ›æ¢å¤${recover}ç‚¹ï¼ˆ${prevStamina} â†’ ${char.ä½“åŠ›å€¼}ï¼‰`,
              æ”¶å…¥å˜åŒ–: 0,
            });
          }
        });

        // æ³¨æ„ï¼šè¯¥å‡½æ•°åªåš"è§„åˆ™ç»“ç®—"ï¼Œä¸è´Ÿè´£ä¿å­˜/åˆ·æ–°ï¼ˆç”±advanceRoundç»Ÿä¸€å¤„ç†ï¼‰
        // è‡ªåŠ¨è¥ä¸šåº”è¯¥åœ¨advanceRoundçš„æœ€åè°ƒç”¨ï¼Œç¡®ä¿æ‰€æœ‰ç»“ç®—éƒ½å®Œæˆåå†åˆ†é…
      }

      function completeWorkingService(characterId) {
        const char = gameState.è§’è‰²ä»“åº“[characterId];
        const workingInfo = gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[characterId];

        if (!char || !workingInfo) {
          console.warn(`completeWorkingService: è§’è‰² ${characterId} æˆ–æ¥å®¢ä¿¡æ¯ä¸å­˜åœ¨`);
          return;
        }
        normalizeCharacter(char);

        // å…ˆæ‰¾åˆ°æˆ¿é—´ï¼ˆç¡®ä¿æˆ¿é—´å­˜åœ¨ä¸”è§’è‰²åŒ¹é…ï¼‰
        const targetRoomId = Object.keys(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€).find(
          id => gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[id].å½“å‰è§’è‰² === characterId,
        );

        // è®¡ç®—å®é™…æ”¶å…¥
        let actualIncome = workingInfo.åŸºç¡€æ”¶å…¥ + workingInfo.é¢å¤–æ”¶å…¥;

        // æˆ¿é—´æ”¶å…¥å€ç‡å’Œç‰¹æ®Šæ•ˆæœ
        const specialEffects = workingInfo.ç‰¹æ®Šæ•ˆæœ || {};
        if (targetRoomId) {
          const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[targetRoomId];
          const roomType = roomTypes[room.ç±»å‹] || roomTypes.æ™®é€š;
          const roomMultiplier = room.æ”¶å…¥å€ç‡ || 1.0;
          actualIncome *= roomMultiplier;

          // ==================== æˆ¿é—´ç±»å‹ç‹¬ç‰¹åŠŸèƒ½å¤„ç† ====================
          // VIPæˆ¿é—´ï¼šé•¿æœŸåŒ…æˆ¿ï¼Œæ€»æ”¶å…¥åŠ æˆ
          if (specialEffects.é•¿æœŸåŒ…æˆ¿ && specialEffects.æ€»æ”¶å…¥åŠ æˆ) {
            actualIncome = Math.floor(actualIncome * (1 + specialEffects.æ€»æ”¶å…¥åŠ æˆ));
          }

          // å±•ç¤ºå®¤ï¼šå…¬å¼€è¡¨æ¼”ï¼Œé­…åŠ›æå‡
          if (specialEffects.å…¬å¼€è¡¨æ¼”) {
            const charmGain = randInt(1, 3);
            if (!char.å±æ€§) char.å±æ€§ = {};
            char.å±æ€§.é­…åŠ› = clampNumber((char.å±æ€§.é­…åŠ› || 0) + charmGain, 0, 100);
            console.info(`å±•ç¤ºå®¤è¡¨æ¼”ï¼š${char.å§“å} é­…åŠ› +${charmGain}`);
          }

          // æ™®é€šæˆ¿é—´ï¼šå¿«é€ŸæœåŠ¡ï¼Œç»éªŒå€¼åŠ æˆï¼ˆä½“ç°åœ¨æ¥å®¢æ¬¡æ•°å’Œç»éªŒå€¼ä¸Šï¼‰
          if (specialEffects.å¿«é€ŸæœåŠ¡ && specialEffects.ç»éªŒåŠ æˆ) {
            // ç»éªŒå€¼åŠ æˆé€šè¿‡å¢åŠ æ¥å®¢æ¬¡æ•°ä½“ç°ï¼ˆç»éªŒå€¼ = æ¥å®¢æ¬¡æ•° + è°ƒæ•™æ¬¡æ•°ï¼‰
            char.æ¥å®¢æ¬¡æ•° = (char.æ¥å®¢æ¬¡æ•° || 0) + 1; // é¢å¤–å¢åŠ ä¸€æ¬¡æ¥å®¢æ¬¡æ•°ä½œä¸ºç»éªŒåŠ æˆ
          }
        }

        // æƒ…æ„ŸçŠ¶æ€å½±å“
        const emotionMultiplier = {
          çˆ±: 1.5,
          å–œæ¬¢: 1.2,
          ä¸­ç«‹: 1.0,
          åŒæ¶: 0.7,
          æ†æ¨: 0.4,
        };
        const emotion = char.æƒ…æ„ŸçŠ¶æ€?.å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ || 'ä¸­ç«‹';
        actualIncome *= emotionMultiplier[emotion] || 1.0;

        // ç‰¹æ®ŠçŠ¶æ€å½±å“
        const specialStatus = char.æƒ…æ„ŸçŠ¶æ€?.ç‰¹æ®ŠçŠ¶æ€ || [];
        if (specialStatus.includes('éº»æœ¨')) actualIncome *= 0.8;
        if (specialStatus.includes('å¿ è¯š')) actualIncome *= 1.3;
        if (specialStatus.includes('åæŠ—')) actualIncome *= 0.5;
        if (specialStatus.includes('å´©æºƒ')) actualIncome *= 0.3;

        // åº”ç”¨æ”¶ç›Šå€ç‡ï¼ˆæ•´ä½“éš¾åº¦æå‡ï¼šåŸºç¡€æ”¶ç›Šé™ä½10%ï¼‰
        const baseDifficultyMultiplier = 0.9; // æ•´ä½“éš¾åº¦æå‡ï¼šæ”¶ç›Šé™ä½10%
        actualIncome *= (gameState.è®¾ç½®?.æ”¶ç›Šå€ç‡ || 1) * baseDifficultyMultiplier;

        // æ›´æ–°è´§å¸å’Œæ”¶å…¥
        gameState.è´§å¸ += Math.floor(actualIncome);
        gameState.å¦“é™¢.ä»Šæ—¥æ”¶å…¥ += Math.floor(actualIncome);
        gameState.ç»Ÿè®¡æ•°æ®.æ€»æ”¶å…¥ += Math.floor(actualIncome);
        gameState.ç»Ÿè®¡æ•°æ®.æ€»æ¥å®¢æ¬¡æ•° += 1;

        // æ›´æ–°æˆ¿é—´çŠ¶æ€ï¼ˆå…ˆæ›´æ–°æˆ¿é—´ï¼Œå†æ›´æ–°è§’è‰²ï¼Œç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§ï¼‰
        if (targetRoomId) {
          const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[targetRoomId];
          room.çŠ¶æ€ = 'ç©ºé—²';
          room.å½“å‰è§’è‰² = undefined;
          console.info(`æˆ¿é—´ ${targetRoomId} å·²æ¸…ç©º`);
        }

        // æ›´æ–°è§’è‰²çŠ¶æ€ï¼ˆä½“åŠ›å€¼ç³»ç»Ÿï¼šä¸å†æ ¹æ®è€åŠ›å€¼è®¾ç½®çŠ¶æ€ï¼‰
        char.çŠ¶æ€ = 'ç©ºé—²';
        char.å½“å‰ä½ç½® = 'ä»“åº“';

        // åˆå§‹åŒ–ä½“åŠ›å€¼ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if (typeof char.ä½“åŠ›å€¼ !== 'number') char.ä½“åŠ›å€¼ = 100;

        // ç§»é™¤æ¥å®¢ä¿¡æ¯ï¼ˆæœ€åç§»é™¤ï¼Œç¡®ä¿å‰é¢çš„é€»è¾‘éƒ½èƒ½è®¿é—®åˆ°ï¼‰
        delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[characterId];
        console.info(`è§’è‰² ${char.å§“å} æ¥å®¢å®Œæˆï¼Œæ”¶å…¥ ${Math.floor(actualIncome)} é‡‘`);

        // å…³ç³»å˜åŒ–ï¼šæ¥å®¢é€šå¸¸ä¼šå¸¦æ¥å°‘é‡å¥½æ„Ÿ/æ¨æ„æ³¢åŠ¨ï¼ˆä¸é AIï¼Œä¿è¯æœ‰è¿›å±•ï¼‰
        const mood = char.æƒ…æ„ŸçŠ¶æ€?.å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ || 'ä¸­ç«‹';
        if (mood === 'çˆ±' || mood === 'å–œæ¬¢') {
          char.å¥½æ„Ÿåº¦ = clampNumber((char.å¥½æ„Ÿåº¦ || 0) + randInt(1, 3), 0, 100);
        } else if (mood === 'åŒæ¶' || mood === 'æ†æ¨') {
          char.æ¨æ„ = clampNumber((char.æ¨æ„ || 0) + randInt(1, 3), 0, 100);
        } else {
          // ä¸­ç«‹ï¼šå°å¹…éšæœº
          if (rand01() < 0.5) char.å¥½æ„Ÿåº¦ = clampNumber((char.å¥½æ„Ÿåº¦ || 0) + 1, 0, 100);
        }
        char.å…³ç³»é˜¶æ®µ = computeRelationshipStage(char.å¥½æ„Ÿåº¦, char.æ¨æ„);
        checkRelationshipTriggers(characterId, 'æ¥å®¢ç»“ç®—');

        pushBrothelLog({
          æ—¶é—´æˆ³: getGameTime().å½“å‰å›åˆ || 1,
          è§’è‰²ID: characterId,
          äº‹ä»¶ç±»å‹: 'æ¥å®¢å®Œæˆ',
          æè¿°: `${char.å§“å}å®Œæˆæ¥å®¢ï¼Œè·å¾—æ”¶å…¥ ${Math.floor(actualIncome)} é‡‘`,
          æ”¶å…¥å˜åŒ–: Math.floor(actualIncome),
        });

        console.info(`è§’è‰² ${char.å§“å} å®Œæˆæ¥å®¢ï¼Œè·å¾—æ”¶å…¥ ${Math.floor(actualIncome)} é‡‘`);
      }

      function completeTrainingSession(characterId) {
        const char = gameState.è§’è‰²ä»“åº“?.[characterId];
        const info = gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[characterId];
        if (!char || !info) return;
        normalizeCharacter(char);

        const intensity = clampNumber(info.å¼ºåº¦ ?? 2, 1, 3);
        const program = trainingPrograms.find(p => p.key === info.è¯¾ç¨‹);
        const gameTime = getGameTime();

        let deltas = [];
        let likeDelta, hateDelta;

        if (program) {
          // é¢„å®šä¹‰è¯¾ç¨‹
          Object.entries(program.focus || {}).forEach(([stat, range]) => {
            const min = range?.[0] ?? 1;
            const max = range?.[1] ?? 3;
            const gain = randInt(min, max) + (intensity - 1);
            char.å±æ€§[stat] = clampNumber((char.å±æ€§?.[stat] || 0) + gain, 0, 100);
            deltas.push(`${stat}+${gain}`);
          });

          // å…³ç³»å˜åŒ–
          likeDelta = randInt(program.like[0], program.like[1]) + (intensity === 3 ? 1 : 0);
          hateDelta = randInt(program.hate[0], program.hate[1]) + (intensity === 3 ? 1 : 0);

          // é«˜é£é™©è¯¾ç¨‹å¯èƒ½è¿½åŠ ç‰¹æ®ŠçŠ¶æ€
          if (program.key === 'æé™ç ´é™' && intensity >= 2) {
            if (rand01() < 0.35) {
              if (!char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.includes('éº»æœ¨')) char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.push('éº»æœ¨');
            }
            if (rand01() < 0.25) {
              if (!char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.includes('åæŠ—')) char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.push('åæŠ—');
            }
          }
        } else {
          // è‡ªå®šä¹‰è°ƒæ•™ï¼šæ ¹æ®è¯¾ç¨‹åç§°åˆ¤æ–­å±æ€§æå‡æ–¹å‘
          const courseName = info.è¯¾ç¨‹ || '';
          const isExtreme =
            courseName.includes('å¼ºå¥¸') ||
            courseName.includes('æš´åŠ›') ||
            courseName.includes('è¡€è…¥') ||
            (courseName.includes('è™«') && !courseName.includes('è™«åµ'));
          const isSexual =
            courseName.includes('å£') ||
            courseName.includes('æ€§') ||
            courseName.includes('BDSM') ||
            courseName.includes('SM') ||
            courseName.includes('å…½äº¤') ||
            courseName.includes('è§¦æ‰‹');
          const isHumiliation =
            courseName.includes('ç¾è€»') ||
            courseName.includes('å‡Œè¾±') ||
            courseName.includes('è°ƒæ•™') ||
            courseName.includes('å¥³ç‹');

          // æ ¹æ®playç±»å‹éšæœºæå‡å±æ€§
          const possibleStats = ['æŠ€å·§', 'é¡ºä»', 'æ•æ„Ÿåº¦', 'è€åŠ›', 'é­…åŠ›'];
          const selectedStats = [];
          const statCount = randInt(2, 4);

          while (selectedStats.length < statCount) {
            const stat = possibleStats[randInt(0, possibleStats.length - 1)];
            if (!selectedStats.includes(stat)) {
              selectedStats.push(stat);
            }
          }

          selectedStats.forEach(stat => {
            const baseGain = randInt(3, 8) + (intensity - 1) * 2;
            const multiplier = isExtreme ? 1.5 : isSexual ? 1.3 : isHumiliation ? 1.2 : 1.0;
            const gain = Math.floor(baseGain * multiplier);
            char.å±æ€§[stat] = clampNumber((char.å±æ€§?.[stat] || 0) + gain, 0, 100);
            deltas.push(`${stat}+${gain}`);
          });

          // è‡ªå®šä¹‰è°ƒæ•™çš„å…³ç³»å˜åŒ–æ›´éšæœº
          const baseLike = randInt(-2, 5);
          const baseHate = randInt(-1, 4);

          likeDelta = baseLike + (isHumiliation ? randInt(0, 3) : 0) + (intensity === 3 ? randInt(0, 2) : 0);
          hateDelta = baseHate + (isExtreme ? randInt(1, 4) : 0) + (intensity === 3 ? randInt(0, 3) : 0);

          // æç«¯playå¯èƒ½è¿½åŠ ç‰¹æ®ŠçŠ¶æ€
          if (isExtreme && intensity >= 2) {
            if (rand01() < 0.4) {
              if (!char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.includes('éº»æœ¨')) char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.push('éº»æœ¨');
            }
            if (rand01() < 0.3) {
              if (!char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.includes('åæŠ—')) char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.push('åæŠ—');
            }
            if (rand01() < 0.2) {
              if (!char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.includes('å´©æºƒ')) char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.push('å´©æºƒ');
            }
          }
        }

        char.å¥½æ„Ÿåº¦ = clampNumber((char.å¥½æ„Ÿåº¦ || 0) + likeDelta, 0, 100);
        char.æ¨æ„ = clampNumber((char.æ¨æ„ || 0) + hateDelta, 0, 100);
        char.å…³ç³»é˜¶æ®µ = computeRelationshipStage(char.å¥½æ„Ÿåº¦, char.æ¨æ„);

        // æ”¶å°¾ï¼šé‡Šæ”¾æˆ¿é—´
        const roomId =
          info.æˆ¿é—´å· ||
          Object.keys(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€ || {}).find(
            rid => gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[rid]?.å½“å‰è§’è‰² === characterId,
          );
        if (roomId) {
          const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€[roomId];
          room.çŠ¶æ€ = 'ç©ºé—²';
          room.å½“å‰è§’è‰² = undefined;
        }

        delete gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²[characterId];

        // çŠ¶æ€å›å½’ï¼ˆè€åŠ›ä¸è¶³åˆ™éœ€è¦ä¼‘æ¯/åŒ»ç–—ï¼‰
        const stamina = char.å±æ€§?.è€åŠ› || 0;
        char.çŠ¶æ€ = 'ç©ºé—²';
        char.å½“å‰ä½ç½® = 'ä»“åº“';

        pushBrothelLog({
          æ—¶é—´æˆ³: gameTime.å½“å‰å›åˆ || 1,
          è§’è‰²ID: characterId,
          äº‹ä»¶ç±»å‹: 'è®­ç»ƒå®Œæˆ',
          æè¿°: `${char.å§“å}å®Œæˆè¯¾ç¨‹ã€${program.key}ã€‘ï¼ˆå¼ºåº¦${intensity}ï¼‰ Â· ${deltas.join('ï¼Œ')} Â· å¥½æ„Ÿ+${likeDelta} / æ¨æ„+${hateDelta}`,
          æ”¶å…¥å˜åŒ–: 0,
        });

        checkRelationshipTriggers(characterId, 'è®­ç»ƒç»“ç®—');
      }

      function processDailySettlement() {
        console.info('æ‰§è¡Œæ¯æ—¥ç»“ç®—...');

        // å°†ä»Šæ—¥æ”¶å…¥ç´¯åŠ åˆ°å†å²æ€»æ”¶å…¥
        gameState.å¦“é™¢.å†å²æ€»æ”¶å…¥ += gameState.å¦“é™¢.ä»Šæ—¥æ”¶å…¥;

        // å°†ä»Šæ—¥æ”¶å…¥å½’é›¶
        gameState.å¦“é™¢.ä»Šæ—¥æ”¶å…¥ = 0;

        // å¤„ç†è§’è‰²çŠ¶æ€æ¢å¤
        Object.values(gameState.è§’è‰²ä»“åº“ || {}).forEach(char => {
          if (char.çŠ¶æ€ === 'ä¼‘æ¯ä¸­' && char.å±æ€§?.è€åŠ› < 100) {
            // ä¼‘æ¯æ¢å¤è€åŠ›
            char.å±æ€§.è€åŠ› = Math.min(100, (char.å±æ€§.è€åŠ› || 0) + 10);
          }
        });

        console.info('æ¯æ—¥ç»“ç®—å®Œæˆ');
      }

      function processAutoBusiness() {
        // è‡ªåŠ¨åˆ†é…ç©ºé—²è§’è‰²ï¼ˆæœ¬åœ°ï¼Œä¸è°ƒç”¨AIï¼Œä¸æ¨è¿›å›åˆï¼‰
        // ä¼˜åŒ–ç­–ç•¥ï¼šæŒ‰ä½“åŠ›å€¼å’Œå±æ€§ç»¼åˆè¯„ä¼°ï¼Œä¼˜å…ˆåˆ†é…çŠ¶æ€å¥½çš„è§’è‰²
        const gameTime = getGameTime();

        // è·å–å¯ç”¨è§’è‰²å¹¶æŒ‰è¯„åˆ†æ’åº
        const availableChars = Object.entries(gameState.è§’è‰²ä»“åº“ || {})
          .filter(([id, char]) => {
            // å…³é”®æ£€æŸ¥ï¼šç¡®ä¿è§’è‰²çœŸæ­£ç©ºé—²ä¸”ä¸åœ¨ä»»ä½•æˆ¿é—´ä¸­
            if (char.çŠ¶æ€ !== 'ç©ºé—²' || char.å½“å‰ä½ç½® !== 'ä»“åº“') return false;
            // é¢å¤–æ£€æŸ¥ï¼šç¡®ä¿è§’è‰²ä¸åœ¨å½“å‰æ¥å®¢è§’è‰²åˆ—è¡¨ä¸­ï¼ˆé˜²æ­¢åˆ†é…åˆšåˆšå®Œæˆæ¥å®¢çš„è§’è‰²ï¼‰
            if (gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[id] || gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[id]) {
              return false;
            }
            // æ£€æŸ¥è§’è‰²æ˜¯å¦åœ¨ä»»ä½•æˆ¿é—´ä¸­ï¼ˆåŒé‡ä¿é™©ï¼‰
            const isInAnyRoom = Object.values(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€ || {}).some(room => room.å½“å‰è§’è‰² === id);
            if (isInAnyRoom) return false;
            // ä½“åŠ›å€¼å¤ªä½çš„ä¸åˆ†é…ï¼ˆä½äº30%è·³è¿‡ï¼‰
            const stamina = typeof char.ä½“åŠ›å€¼ === 'number' ? char.ä½“åŠ›å€¼ : 100;
            return stamina >= 30;
          })
          .map(([id, char]) => {
            // è®¡ç®—ç»¼åˆè¯„åˆ†ï¼šä½“åŠ› * 0.4 + é­…åŠ› * 0.3 + æŠ€å·§ * 0.2 + è€åŠ› * 0.1
            const stamina = typeof char.ä½“åŠ›å€¼ === 'number' ? char.ä½“åŠ›å€¼ : 100;
            const charm = char.å±æ€§?.é­…åŠ› || 30;
            const skill = char.å±æ€§?.æŠ€å·§ || 30;
            const endurance = char.å±æ€§?.è€åŠ› || 30;
            const score = stamina * 0.4 + charm * 0.3 + skill * 0.2 + endurance * 0.1;
            return { id, char, score };
          })
          .sort((a, b) => b.score - a.score) // æŒ‰è¯„åˆ†ä»é«˜åˆ°ä½
          .map(item => item.id)
          .filter(id => {
            // æœ€ç»ˆæ£€æŸ¥ï¼šç¡®ä¿è§’è‰²ç¡®å®ç©ºé—²ä¸”ä¸åœ¨ä»»ä½•æˆ¿é—´ä¸­ï¼ˆé˜²æ­¢åœ¨æ’åºè¿‡ç¨‹ä¸­çŠ¶æ€å˜åŒ–ï¼‰
            const char = gameState.è§’è‰²ä»“åº“?.[id];
            if (!char || char.çŠ¶æ€ !== 'ç©ºé—²' || char.å½“å‰ä½ç½® !== 'ä»“åº“') return false;
            if (gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[id] || gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[id]) return false;
            const isInAnyRoom = Object.values(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€ || {}).some(room => room.å½“å‰è§’è‰² === id);
            return !isInAnyRoom;
          });

        const availableRooms = Object.entries(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€ || {})
          .filter(([, room]) => {
            if (room.çŠ¶æ€ !== 'ç©ºé—²') return false;
            if (room.è§£é” === false) return false;
            // ä»…æ¥å®¢æˆ¿é—´å‚ä¸è‡ªåŠ¨è¥ä¸š
            return room.ç±»å‹ !== 'è°ƒæ•™å®¤';
          })
          .map(([id]) => id);

        const count = Math.min(availableChars.length, availableRooms.length);
        if (count > 0) {
          let actualAssigned = 0;
          for (let i = 0; i < count; i++) {
            const charId = availableChars[i];
            const roomId = availableRooms[i];
            // åˆ†é…å‰æœ€åä¸€æ¬¡æ£€æŸ¥ï¼šç¡®ä¿è§’è‰²å’Œæˆ¿é—´çŠ¶æ€éƒ½æ­£ç¡®
            const char = gameState.è§’è‰²ä»“åº“?.[charId];
            const room = gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€?.[roomId];
            if (
              char &&
              char.çŠ¶æ€ === 'ç©ºé—²' &&
              char.å½“å‰ä½ç½® === 'ä»“åº“' &&
              !gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[charId] &&
              !gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[charId] &&
              room &&
              room.çŠ¶æ€ === 'ç©ºé—²' &&
              !room.å½“å‰è§’è‰²
            ) {
              batchAssignLocal(roomId, charId, gameTime.å½“å‰å›åˆ || 1);
              actualAssigned++;
            } else {
              console.warn(`è‡ªåŠ¨è¥ä¸šï¼šè·³è¿‡åˆ†é… ${charId} åˆ° ${roomId}ï¼ˆçŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼‰`);
            }
          }
          if (actualAssigned > 0) {
            console.info(`è‡ªåŠ¨è¥ä¸šï¼šå·²åˆ†é… ${actualAssigned} ä¸ªè§’è‰²åˆ°ç©ºé—²æˆ¿é—´ï¼ˆæŒ‰ç»¼åˆè¯„åˆ†æ’åºï¼‰`);
          }
          // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œåˆ·æ–°ï¼Œç”±advanceRoundç»Ÿä¸€åˆ·æ–°
        }
      }

      // ==================== è§’è‰²åˆæˆåŠŸèƒ½ ====================
      function openSynthesis() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'synthesis-modal';
        modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px">
                  <button class="modal-close" onclick="closeSynthesis()">Ã—</button>
                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">ğŸ”¬ è§’è‰²åˆæˆ</h2>

                  <div style="margin-bottom: 24px; padding: 16px; background: rgba(30, 41, 59, 0.6); border-radius: 12px">
                    <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">åˆæˆè§„åˆ™</h3>
                    <ul style="line-height: 2; color: var(--text-secondary); font-size: 14px">
                      <li>é€‰æ‹©2-5ä¸ªè§’è‰²è¿›è¡Œåˆæˆ</li>
                      <li>åˆæˆåçš„è§’è‰²ç¨€æœ‰åº¦ä¼šæ ¹æ®ç´ æè§’è‰²æå‡</li>
                      <li>æ–°è§’è‰²çš„å±æ€§ä¼šèåˆç´ æè§’è‰²çš„ç‰¹å¾</li>
                      <li>åˆæˆåç´ æè§’è‰²å°†è¢«æ¶ˆè€—</li>
                      <li>ç¨€æœ‰åº¦æå‡è§„åˆ™ï¼ˆè¯¦ç»†ï¼‰ï¼š</li>
                      <ul style="margin-left: 20px; margin-top: 8px; line-height: 1.8">
                        <li>2ä¸ªN â†’ Rï¼ˆæˆåŠŸç‡100%ï¼‰</li>
                        <li>3ä¸ªN â†’ Rï¼ˆæˆåŠŸç‡100%ï¼Œå±æ€§+5%ï¼‰</li>
                        <li>2ä¸ªR â†’ SRï¼ˆæˆåŠŸç‡100%ï¼‰</li>
                        <li>3ä¸ªR â†’ SRï¼ˆæˆåŠŸç‡100%ï¼Œå±æ€§+5%ï¼‰</li>
                        <li>2ä¸ªSR â†’ SSRï¼ˆæˆåŠŸç‡100%ï¼‰</li>
                        <li>3ä¸ªSR â†’ SSRï¼ˆæˆåŠŸç‡100%ï¼Œå±æ€§+5%ï¼‰</li>
                        <li>2ä¸ªSSR â†’ SSR+ï¼ˆæˆåŠŸç‡80%ï¼Œå¤±è´¥åˆ™ä¿æŒSSRï¼‰</li>
                        <li>3ä¸ªSSR â†’ SSR+ï¼ˆæˆåŠŸç‡100%ï¼Œå±æ€§+5%ï¼‰</li>
                        <li>2ä¸ªSSR+ â†’ SSR++ï¼ˆæˆåŠŸç‡70%ï¼Œå¤±è´¥åˆ™ä¿æŒSSR+ï¼‰</li>
                        <li>3ä¸ªSSR+ â†’ SSR++ï¼ˆæˆåŠŸç‡100%ï¼Œå±æ€§+5%ï¼‰</li>
                        <li>2ä¸ªSSR++ â†’ URï¼ˆæˆåŠŸç‡60%ï¼Œå¤±è´¥åˆ™ä¿æŒSSR++ï¼‰</li>
                        <li>3ä¸ªSSR++ â†’ URï¼ˆæˆåŠŸç‡90%ï¼Œå±æ€§+5%ï¼‰</li>
                        <li>4ä¸ªSSR++ â†’ URï¼ˆæˆåŠŸç‡100%ï¼Œå±æ€§+10%ï¼‰</li>
                        <li>æ··åˆåˆæˆï¼šæŒ‰æœ€é«˜ç¨€æœ‰åº¦è®¡ç®—ï¼Œä½†æˆåŠŸç‡é™ä½10-20%</li>
                      </ul>
                    </ul>
                  </div>

                  <div style="margin-bottom: 24px">
                    <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å·²é€‰æ‹©è§’è‰² (<span id="selected-count">0</span>/5)</h3>
                    <div id="selected-characters" style="display: flex; flex-wrap: wrap; gap: 12px; min-height: 80px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; border: 2px dashed rgba(139, 92, 246, 0.3)">
                      <div style="width: 100%; text-align: center; color: var(--text-secondary); padding: 20px">ä»ä¸‹æ–¹é€‰æ‹©è§’è‰²è¿›è¡Œåˆæˆ</div>
                    </div>
                  </div>

                  <div style="margin-bottom: 24px">
                    <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å¯é€‰è§’è‰²</h3>
                    <div id="synthesis-character-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px"></div>
                  </div>

                  <div style="display: flex; gap: 12px; justify-content: flex-end">
                    <button class="btn btn-secondary" onclick="closeSynthesis()">å–æ¶ˆ</button>
                    <button class="btn" id="btn-synthesize" onclick="confirmSynthesis()" disabled>å¼€å§‹åˆæˆ</button>
                  </div>
                </div>
              `;

        document.body.appendChild(modal);
        modal.classList.add('active');

        // åˆå§‹åŒ–åˆæˆç•Œé¢
        if (!window.selectedSynthesisChars) {
          window.selectedSynthesisChars = [];
        }
        refreshSynthesisPage();
      }

      function closeSynthesis() {
        closeModal('synthesis-modal');
        if (window.selectedSynthesisChars) {
          window.selectedSynthesisChars = [];
        }
      }

      function refreshSynthesisPage() {
        const charList = document.getElementById('synthesis-character-list');
        if (!charList) {
          console.warn('synthesis-character-list å…ƒç´ ä¸å­˜åœ¨');
          return;
        }

        charList.innerHTML = '';

        // æ£€æŸ¥è§’è‰²ä»“åº“æ˜¯å¦å­˜åœ¨
        if (!gameState.è§’è‰²ä»“åº“ || typeof gameState.è§’è‰²ä»“åº“ !== 'object') {
          console.warn('è§’è‰²ä»“åº“ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯:', gameState.è§’è‰²ä»“åº“);
          charList.innerHTML =
            '<div style="text-align: center; color: var(--text-secondary); padding: 40px">è§’è‰²ä»“åº“æ•°æ®å¼‚å¸¸</div>';
          return;
        }

        const availableChars = Object.entries(gameState.è§’è‰²ä»“åº“)
          .filter(([id, char]) => {
            // æ”¾å®½è¿‡æ»¤æ¡ä»¶ï¼Œåªè¦æœ‰çŠ¶æ€å’Œä½ç½®å­—æ®µå°±æ˜¾ç¤º
            const hasStatus = char && (char.çŠ¶æ€ === 'ç©ºé—²' || !char.çŠ¶æ€);
            const hasLocation = char && (char.å½“å‰ä½ç½® === 'ä»“åº“' || !char.å½“å‰ä½ç½®);
            return hasStatus && hasLocation;
          })
          .map(([id, char]) => ({ id, ...char }));

        console.info('å¯åˆæˆè§’è‰²æ•°é‡:', availableChars.length, 'æ€»è§’è‰²æ•°:', Object.keys(gameState.è§’è‰²ä»“åº“).length);

        if (availableChars.length === 0) {
          charList.innerHTML =
            '<div style="text-align: center; color: var(--text-secondary); padding: 40px">æ²¡æœ‰å¯åˆæˆçš„è§’è‰²ï¼ˆéœ€è¦çŠ¶æ€ä¸º"ç©ºé—²"ä¸”ä½ç½®ä¸º"ä»“åº“"çš„è§’è‰²ï¼‰</div>';
          return;
        }

        availableChars.forEach(({ id, ...char }) => {
          const isSelected = window.selectedSynthesisChars && window.selectedSynthesisChars.includes(id);
          const card = document.createElement('div');
          card.className = `character-list-item rarity-${char.ç¨€æœ‰åº¦}`;
          card.style.cssText = `
                  padding: 12px;
                  cursor: pointer;
                  border: 2px solid ${isSelected ? 'var(--primary)' : 'rgba(139, 92, 246, 0.3)'};
                  background: ${isSelected ? 'rgba(139, 92, 246, 0.2)' : 'rgba(30, 41, 59, 0.6)'};
                  opacity: ${isSelected ? '1' : '0.8'};
                `;
          card.innerHTML = `
                  <div style="font-size: 16px; font-weight: bold; margin-bottom: 4px">${char.å§“å}</div>
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px">${char.ç¨€æœ‰åº¦} Â· ${char.èŒä¸šèº«ä»½ || 'æ— '}</div>
                  <div style="font-size: 11px; color: var(--text-secondary)">
                    é­…åŠ›: ${char.å±æ€§?.é­…åŠ› || 0} | é¡ºä»: ${char.å±æ€§?.é¡ºä» || 0}
                  </div>
                  ${isSelected ? '<div style="margin-top: 8px; font-size: 12px; color: var(--primary)">âœ“ å·²é€‰æ‹©</div>' : ''}
                `;
          card.onclick = () => toggleSynthesisCharacter(id);
          charList.appendChild(card);
        });

        updateSynthesisSelection();
      }

      function toggleSynthesisCharacter(characterId) {
        if (!window.selectedSynthesisChars) {
          window.selectedSynthesisChars = [];
        }
        const index = window.selectedSynthesisChars.indexOf(characterId);
        if (index > -1) {
          window.selectedSynthesisChars.splice(index, 1);
        } else {
          if (window.selectedSynthesisChars.length >= 5) {
            alert('æœ€å¤šåªèƒ½é€‰æ‹©5ä¸ªè§’è‰²ï¼');
            return;
          }
          window.selectedSynthesisChars.push(characterId);
        }
        refreshSynthesisPage();
      }

      function updateSynthesisSelection() {
        const selectedContainer = document.getElementById('selected-characters');
        const countSpan = document.getElementById('selected-count');
        const btnSynthesize = document.getElementById('btn-synthesize');

        if (countSpan) {
          countSpan.textContent = window.selectedSynthesisChars ? window.selectedSynthesisChars.length : 0;
        }

        if (btnSynthesize) {
          btnSynthesize.disabled = !window.selectedSynthesisChars || window.selectedSynthesisChars.length < 2;
        }

        if (selectedContainer) {
          if (!window.selectedSynthesisChars || window.selectedSynthesisChars.length === 0) {
            selectedContainer.innerHTML =
              '<div style="width: 100%; text-align: center; color: var(--text-secondary); padding: 20px">ä»ä¸‹æ–¹é€‰æ‹©è§’è‰²è¿›è¡Œåˆæˆ</div>';
          } else {
            selectedContainer.innerHTML = window.selectedSynthesisChars
              .map(id => {
                const char = gameState.è§’è‰²ä»“åº“[id];
                if (!char) return '';
                return `
                        <div style="padding: 12px; background: rgba(139, 92, 246, 0.2); border-radius: 8px; border: 1px solid var(--primary); position: relative">
                          <div style="font-size: 14px; font-weight: bold; margin-bottom: 4px">${char.å§“å}</div>
                          <div style="font-size: 11px; color: var(--text-secondary)">${char.ç¨€æœ‰åº¦}</div>
                          <button onclick="toggleSynthesisCharacter('${id}'); event.stopPropagation();" style="position: absolute; top: 4px; right: 4px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; line-height: 1">Ã—</button>
                        </div>
                      `;
              })
              .join('');
          }
        }
      }

      async function confirmSynthesis() {
        if (!window.selectedSynthesisChars || window.selectedSynthesisChars.length < 2) {
          alert('è‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªè§’è‰²ï¼');
          return;
        }

        if (window.selectedSynthesisChars.length > 5) {
          alert('æœ€å¤šåªèƒ½é€‰æ‹©5ä¸ªè§’è‰²ï¼');
          return;
        }

        // æ£€æŸ¥ç´ æè§’è‰²æ˜¯å¦æ­£åœ¨ä½¿ç”¨ä¸­
        const busyChars = window.selectedSynthesisChars.filter(id => {
          const char = gameState.è§’è‰²ä»“åº“[id];
          return char && (char.çŠ¶æ€ === 'æ¥å®¢ä¸­' || char.çŠ¶æ€ === 'è°ƒæ•™ä¸­');
        });
        if (busyChars.length > 0) {
          const busyNames = busyChars.map(id => gameState.è§’è‰²ä»“åº“[id]?.å§“å || id).join('ã€');
          alert(`ä»¥ä¸‹è§’è‰²æ­£åœ¨ä½¿ç”¨ä¸­ï¼Œæ— æ³•åˆæˆï¼š\n${busyNames}`);
          return;
        }

        const charNames = window.selectedSynthesisChars
          .map(id => {
            const char = gameState.è§’è‰²ä»“åº“[id];
            return char ? `${id}ï¼ˆ${char.å§“å}ï¼‰` : id;
          })
          .join('ã€');

        if (!confirm(`ç¡®å®šè¦åˆæˆä»¥ä¸‹è§’è‰²å—ï¼Ÿ\n\n${charNames}\n\nåˆæˆåè¿™äº›è§’è‰²å°†è¢«æ¶ˆè€—ã€‚`)) {
          return;
        }

        // ä¿å­˜ç´ æè§’è‰²IDï¼ˆç”¨äºåç»­åˆ é™¤ï¼‰
        const materialCharIds = [...window.selectedSynthesisChars];
        const materialChars = materialCharIds.map(id => gameState.è§’è‰²ä»“åº“[id]).filter(Boolean);

        // ==================== æ•´åˆåˆ°æŠ½å¡æµç¨‹ ====================
        // å…ˆåˆ é™¤ç´ æè§’è‰²ï¼ˆåœ¨AIç”Ÿæˆä¹‹å‰ï¼Œé¿å…AIçœ‹åˆ°è¿™äº›è§’è‰²ï¼‰
        materialCharIds.forEach(id => {
          const char = gameState.è§’è‰²ä»“åº“[id];
          if (char) {
            // åˆ é™¤è§’è‰²
            delete gameState.è§’è‰²ä»“åº“[id];

            // æ¸…ç†ç›¸å…³æ•°æ®
            if (gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[id]) {
              delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[id];
            }
            if (gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[id]) {
              delete gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²[id];
            }

            // æ¸…ç†æˆ¿é—´ä¸­çš„è§’è‰²
            Object.values(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€ || {}).forEach(room => {
              if (room.å½“å‰è§’è‰² === id) {
                room.å½“å‰è§’è‰² = undefined;
                room.çŠ¶æ€ = 'ç©ºé—²';
              }
            });

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            if (gameState.ç»Ÿè®¡æ•°æ®) {
              gameState.ç»Ÿè®¡æ•°æ®.è§’è‰²åˆ†å¸ƒ[char.ç¨€æœ‰åº¦] = Math.max(
                0,
                (gameState.ç»Ÿè®¡æ•°æ®.è§’è‰²åˆ†å¸ƒ[char.ç¨€æœ‰åº¦] || 0) - 1,
              );
            }
          }
        });

        // åˆ‡æ¢åˆ°æŠ½å¡é¡µé¢ï¼Œå¤ç”¨æŠ½å¡é€»è¾‘
        closeSynthesis();
        switchPage('summon');

        // è®¡ç®—ç›®æ ‡ç¨€æœ‰åº¦å’ŒæˆåŠŸç‡ï¼ˆæ ¹æ®ç´ æè§’è‰²å’Œè¯¦ç»†è§„åˆ™ï¼‰
        const rarityOrder = { N: 0, R: 1, SR: 2, SSR: 3, 'SSR+': 4, 'SSR++': 5, UR: 6 };

        // ç»Ÿè®¡å„ç¨€æœ‰åº¦æ•°é‡
        const rarityCount = {};
        materialChars.forEach(char => {
          const rarity = char.ç¨€æœ‰åº¦ || 'N';
          rarityCount[rarity] = (rarityCount[rarity] || 0) + 1;
        });

        // è®¡ç®—æœ€é«˜ç¨€æœ‰åº¦
        const maxRarity = materialChars.reduce((max, char) => {
          const current = rarityOrder[char.ç¨€æœ‰åº¦] || 0;
          const maxOrder = rarityOrder[max] || 0;
          return current > maxOrder ? char.ç¨€æœ‰åº¦ : max;
        }, 'N');
        const maxRarityOrder = rarityOrder[maxRarity] || 0;

        // åˆ¤æ–­æ˜¯å¦ä¸ºæ··åˆåˆæˆï¼ˆæœ‰å¤šä¸ªä¸åŒç¨€æœ‰åº¦ï¼‰
        const uniqueRarities = Object.keys(rarityCount).length;
        const isMixed = uniqueRarities > 1;

        // æ ¹æ®è¯¦ç»†è§„åˆ™è®¡ç®—ç›®æ ‡ç¨€æœ‰åº¦å’ŒæˆåŠŸç‡
        let targetRarity = 'R';
        let successRate = 100;
        let attributeBonus = 0;

        const count = materialCharIds.length;

        if (maxRarityOrder === 0) {
          // Nçº§åˆæˆ
          if (count === 2) {
            targetRarity = 'R';
            successRate = 100;
          } else if (count >= 3) {
            targetRarity = 'R';
            successRate = 100;
            attributeBonus = 5;
          }
        } else if (maxRarityOrder === 1) {
          // Rçº§åˆæˆ
          if (count === 2 && rarityCount['R'] === 2) {
            targetRarity = 'SR';
            successRate = 100;
          } else if (count >= 3 && rarityCount['R'] >= 3) {
            targetRarity = 'SR';
            successRate = 100;
            attributeBonus = 5;
          } else if (isMixed) {
            targetRarity = 'SR';
            successRate = 90; // æ··åˆåˆæˆé™ä½10%
          }
        } else if (maxRarityOrder === 2) {
          // SRçº§åˆæˆ
          if (count === 2 && rarityCount['SR'] === 2) {
            targetRarity = 'SSR';
            successRate = 100;
          } else if (count >= 3 && rarityCount['SR'] >= 3) {
            targetRarity = 'SSR';
            successRate = 100;
            attributeBonus = 5;
          } else if (isMixed) {
            targetRarity = 'SSR';
            successRate = 85; // æ··åˆåˆæˆé™ä½15%
          }
        } else if (maxRarityOrder === 3) {
          // SSRçº§åˆæˆ
          if (count === 2 && rarityCount['SSR'] === 2) {
            targetRarity = 'SSR+';
            successRate = 80;
          } else if (count >= 3 && rarityCount['SSR'] >= 3) {
            targetRarity = 'SSR+';
            successRate = 100;
            attributeBonus = 5;
          } else if (isMixed) {
            targetRarity = 'SSR+';
            successRate = 70; // æ··åˆåˆæˆé™ä½20%
          }
        } else if (maxRarityOrder === 4) {
          // SSR+çº§åˆæˆ
          if (count === 2 && rarityCount['SSR+'] === 2) {
            targetRarity = 'SSR++';
            successRate = 70;
          } else if (count >= 3 && rarityCount['SSR+'] >= 3) {
            targetRarity = 'SSR++';
            successRate = 100;
            attributeBonus = 5;
          } else if (isMixed) {
            targetRarity = 'SSR++';
            successRate = 60; // æ··åˆåˆæˆé™ä½20%
          }
        } else if (maxRarityOrder === 5) {
          // SSR++çº§åˆæˆ
          if (count === 2 && rarityCount['SSR++'] === 2) {
            targetRarity = 'UR';
            successRate = 60;
          } else if (count === 3 && rarityCount['SSR++'] >= 3) {
            targetRarity = 'UR';
            successRate = 90;
            attributeBonus = 5;
          } else if (count >= 4 && rarityCount['SSR++'] >= 4) {
            targetRarity = 'UR';
            successRate = 100;
            attributeBonus = 10;
          } else if (isMixed) {
            targetRarity = 'UR';
            successRate = 50; // æ··åˆåˆæˆé™ä½20%
          }
        } else if (maxRarityOrder === 6) {
          // URçº§ï¼ˆå·²ç»æ˜¯æœ€é«˜ï¼Œä¸èƒ½å†åˆæˆï¼‰
          targetRarity = 'UR';
          successRate = 0; // URä¸èƒ½å†åˆæˆ
        }

        // æ£€æŸ¥æˆåŠŸç‡ï¼Œå¦‚æœå¤±è´¥åˆ™ä¿æŒåŸç¨€æœ‰åº¦
        const actualSuccess = Math.random() * 100 < successRate;
        if (!actualSuccess) {
          // åˆæˆå¤±è´¥ï¼Œç›®æ ‡ç¨€æœ‰åº¦é™ä¸€çº§ï¼ˆä½†ä¸èƒ½ä½äºNï¼‰
          const currentOrder = rarityOrder[targetRarity] || 0;
          if (currentOrder > 0) {
            const newOrder = currentOrder - 1;
            targetRarity = Object.keys(rarityOrder).find(k => rarityOrder[k] === newOrder) || 'N';
          } else {
            targetRarity = maxRarity; // å¦‚æœå·²ç»æ˜¯æœ€ä½ï¼Œä¿æŒåŸç¨€æœ‰åº¦
          }
          console.warn(
            `âš ï¸ åˆæˆå¤±è´¥ï¼ç›®æ ‡ç¨€æœ‰åº¦ä» ${Object.keys(rarityOrder).find(k => rarityOrder[k] === rarityOrder[targetRarity] + 1)} é™ä¸º ${targetRarity}`,
          );
        }

        const gameTime = getGameTime();

        // æ„å»ºå®Œæ•´çš„ç´ æè§’è‰²ä¿¡æ¯ï¼ˆåŒ…å«æ‰€æœ‰å…³é”®ç‰¹å¾ï¼Œé¿å…oocï¼‰
        const materialCharsInfo = materialChars
          .map((char, idx) => {
            const info = [
              `${idx + 1}. ${char.å§“å}ï¼ˆ${char.ç¨€æœ‰åº¦}ï¼‰`,
              `   å…ƒç´ ï¼š${(char.å…ƒç´  || []).join('ã€') || 'æ— '}`,
              `   æ€§åˆ«ï¼š${char.æ€§åˆ« || 'æœªçŸ¥'}`,
              `   ç§æ—/å‡ºèº«ï¼š${char.ç§æ—å‡ºèº« || 'æœªçŸ¥'}`,
              `   èŒä¸š/èº«ä»½ï¼š${char.èŒä¸šèº«ä»½ || 'æ— '}`,
              `   å¤–è²Œç‰¹ç‚¹ï¼š${char.å¤–è²Œç‰¹ç‚¹ || 'æ— æè¿°'}`,
              `   æ€§æ ¼/å–œå¥½ï¼š${char.æ€§æ ¼å–œå¥½ || 'æ— æè¿°'}`,
              `   ç®€ä»‹ï¼š${char.ç®€ä»‹ || 'æ— ç®€ä»‹'}`,
              `   èƒŒæ™¯æ•…äº‹ï¼š${(char.èƒŒæ™¯æ•…äº‹ || '').substring(0, 500)}${(char.èƒŒæ™¯æ•…äº‹ || '').length > 500 ? '...' : ''}`,
              `   å±æ€§ï¼šé­…åŠ›${char.å±æ€§?.é­…åŠ› || 0}ã€é¡ºä»${char.å±æ€§?.é¡ºä» || 0}ã€æŠ€å·§${char.å±æ€§?.æŠ€å·§ || 0}ã€è€åŠ›${char.å±æ€§?.è€åŠ› || 0}ã€æ•æ„Ÿåº¦${char.å±æ€§?.æ•æ„Ÿåº¦ || 0}`,
              `   æƒ…æ„ŸçŠ¶æ€ï¼š${char.æƒ…æ„ŸçŠ¶æ€?.å¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿ || 'ä¸­ç«‹'}ï¼ˆå¼ºåº¦ï¼š${char.æƒ…æ„ŸçŠ¶æ€?.æƒ…æ„Ÿå¼ºåº¦ || 0}ï¼‰`,
              char.æƒ…æ„ŸçŠ¶æ€?.ç‰¹æ®ŠçŠ¶æ€ && Array.isArray(char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€) && char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.length > 0
                ? `   ç‰¹æ®ŠçŠ¶æ€ï¼š${char.æƒ…æ„ŸçŠ¶æ€.ç‰¹æ®ŠçŠ¶æ€.join('ã€')}`
                : '',
              char.èŠå¤©æ‘˜è¦
                ? `   èŠå¤©æ‘˜è¦ï¼š${char.èŠå¤©æ‘˜è¦.substring(0, 200)}${char.èŠå¤©æ‘˜è¦.length > 200 ? '...' : ''}`
                : '',
            ]
              .filter(Boolean)
              .join('\n');
            return info;
          })
          .join('\n\n');

        // è®¾ç½®æ˜¾ç¤ºåŒºåŸŸ
        const resultsContainer = document.getElementById('summon-results');
        const cardDisplay = document.getElementById('character-card-display');
        if (resultsContainer) {
          resultsContainer.innerHTML = '<div class="story-loading">â³ æ­£åœ¨åˆæˆè§’è‰²ï¼Œè¯·ç¨å€™...</div>';
        }
        if (cardDisplay) {
          cardDisplay.style.display = 'none';
          cardDisplay.innerHTML = '';
        }

        // æ„å»ºåˆæˆå‘½ä»¤ï¼ˆå¤ç”¨æŠ½å¡çš„å®Œæ•´å‘½ä»¤æ ¼å¼ï¼‰
        let command = `æ‰§è¡Œè§’è‰²åˆæˆã€‚å°†ä»¥ä¸‹è§’è‰²è¿›è¡Œèåˆåˆæˆï¼š${materialCharIds.join('ã€')}ã€‚

ç´ æè§’è‰²å®Œæ•´ä¿¡æ¯ï¼š
${materialCharsInfo}

ã€é‡è¦ã€‘è¿™æ˜¯è§’è‰²åˆæˆï¼Œä¸æ˜¯æ™®é€šæŠ½å¡ã€‚ä½ å¿…é¡»ï¼š
1. èåˆç´ æè§’è‰²çš„æ‰€æœ‰ç‰¹å¾ï¼ˆå…ƒç´ ã€å¤–è²Œã€æ€§æ ¼ã€èƒŒæ™¯æ•…äº‹ç­‰ï¼‰ï¼Œåˆ›é€ ç‹¬ç‰¹çš„æ–°è§’è‰²
2. ä¸èƒ½ç®€å•æ‹¼æ¥ï¼Œè¦æœ‰æœºèåˆï¼Œè®©æ–°è§’è‰²å…·æœ‰ç‹¬ç‰¹æ€§å’ŒåŸåˆ›æ€§
3. æ–°è§’è‰²çš„ç¨€æœ‰åº¦å¿…é¡»ä¸ºï¼š${targetRarity}ï¼ˆåŸºäºç´ æè§’è‰²è®¡ç®—å¾—å‡ºï¼‰
4. èåˆç´ æè§’è‰²çš„å±æ€§ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ï¼Œå–å¹³å‡å€¼æˆ–æ ¹æ®ç¨€æœ‰åº¦æå‡ï¼‰

**ã€æ€ç»´é“¾ï¼šè§’è‰²åˆæˆå‰çš„å®Œæ•´è§„åˆ’ã€‘**

åœ¨å¼€å§‹ç”Ÿæˆåˆæˆè§’è‰²å¡ä¹‹å‰ï¼Œä½ å¿…é¡»å…ˆå®Œæˆä»¥ä¸‹æ€ç»´é“¾ï¼Œç¡®ä¿æ‰€æœ‰ä¿¡æ¯éƒ½å·²é¢„å…ˆè€ƒè™‘ï¼š

**ç¬¬ä¸€æ­¥ï¼šå½“å‰åˆæˆæƒ…å†µåˆ†æ**
- åˆæˆç±»å‹ï¼šè§’è‰²èåˆåˆæˆ
- ç´ æè§’è‰²æ•°é‡ï¼š${materialCharIds.length}ä¸ª
- ç›®æ ‡ç¨€æœ‰åº¦ï¼š${targetRarity}ï¼ˆåŸºäºç´ æè§’è‰²è®¡ç®—å¾—å‡ºï¼‰
- å½“å‰æ¸¸æˆå›åˆï¼š${gameTime.å½“å‰å›åˆ || 1}
- å½“å‰æ¸¸æˆçŠ¶æ€ï¼šè´§å¸${gameState.è´§å¸ || 0}é‡‘ï¼Œå·²æœ‰è§’è‰²${Object.keys(gameState.è§’è‰²ä»“åº“ || {}).length}ä¸ª

**ç¬¬äºŒæ­¥ï¼šç´ æè§’è‰²ç‰¹å¾æå–ä¸èåˆè§„åˆ’**
åœ¨ç”Ÿæˆä»»ä½•å†…å®¹ä¹‹å‰ï¼Œä½ å¿…é¡»å…ˆåˆ†æç´ æè§’è‰²çš„æ‰€æœ‰ç‰¹å¾ï¼Œå¹¶è§„åˆ’å¦‚ä½•èåˆï¼š

1. **å…ƒç´ èåˆ**ï¼šç´ æè§’è‰²çš„å…ƒç´ æœ‰å“ªäº›ï¼Ÿå¦‚ä½•èåˆæˆ3-4ä¸ªæ–°å…ƒç´ ï¼ˆå¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªç¨€æœ‰å°ä¼—å…ƒç´ ï¼‰ï¼Ÿæ–°å…ƒç´ å¦‚ä½•ä½“ç°èåˆç‰¹å¾ï¼Ÿ
2. **å§“åç”Ÿæˆ**ï¼šå¦‚ä½•ä»ç´ æè§’è‰²çš„å§“åä¸­æå–çµæ„Ÿï¼Œåˆ›é€ èåˆåçš„æ–°åå­—ï¼Ÿ
3. **ç¨€æœ‰åº¦**ï¼š${targetRarity}ï¼ˆå·²ç¡®å®šï¼‰
4. **æ€§åˆ«ç¡®å®š**ï¼šç´ æè§’è‰²çš„æ€§åˆ«æ˜¯ä»€ä¹ˆï¼Ÿèåˆåçš„æ€§åˆ«å¦‚ä½•ç¡®å®šï¼Ÿå¿…é¡»ç¬¦åˆæ¸¸æˆè§„åˆ™ï¼ˆç”·æ€§/å¥³æ€§/åŒæ€§ç”·æ€§ï¼‰
5. **ç§æ—/å‡ºèº«èåˆ**ï¼šç´ æè§’è‰²çš„ç§æ—/å‡ºèº«æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•èåˆæˆæ–°çš„ç§æ—/å‡ºèº«èƒŒæ™¯ï¼Ÿ
6. **èŒä¸š/èº«ä»½èåˆ**ï¼šç´ æè§’è‰²çš„èŒä¸š/èº«ä»½æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•åˆ›é€ èåˆåçš„æ–°èŒä¸š/èº«ä»½ï¼Ÿ
7. **å¤–è²Œç‰¹ç‚¹èåˆ**ï¼šç´ æè§’è‰²çš„å¤–è²Œç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•èåˆæˆæ–°çš„å¤–è²Œæè¿°ï¼Ÿå¿…é¡»è¯¦ç»†ã€ç¬¦åˆå®¡ç¾åŸåˆ™
8. **æ€§æ ¼/å–œå¥½èåˆ**ï¼šç´ æè§’è‰²çš„æ€§æ ¼/å–œå¥½æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•èåˆæˆçœŸå®ã€ç«‹ä½“çš„æ–°æ€§æ ¼ï¼Ÿ
9. **ç®€ä»‹ç”Ÿæˆ**ï¼šå¦‚ä½•ç”¨ç®€æ´çš„è¯­è¨€æ¦‚æ‹¬èåˆåçš„æ–°è§’è‰²ï¼Ÿ
10. **èƒŒæ™¯æ•…äº‹èåˆ**ï¼ˆè‡³å°‘1000å­—ï¼‰ï¼šç´ æè§’è‰²çš„èƒŒæ™¯æ•…äº‹æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•æœ‰æœºèåˆæˆæ–°çš„èƒŒæ™¯æ•…äº‹ï¼Ÿå¿…é¡»ä½“ç°è§’è‰²ç‰¹ç‚¹ï¼ˆèŒç‚¹ï¼‰ï¼Œä½“è£ä¸é™
11. **å¤–è²Œæç¤ºè¯ç”Ÿæˆ**ï¼ˆçº¯è‹±æ–‡ï¼Œæå…¶è¯¦ç»†ï¼‰ï¼šå¦‚ä½•èåˆç´ æè§’è‰²çš„å¤–è²Œç‰¹å¾ï¼Œç”Ÿæˆè¦†ç›–13ä¸ªç»´åº¦çš„æ–°å¤–è²Œæç¤ºè¯ï¼Ÿ
12. **å±æ€§åˆå§‹å€¼è®¡ç®—**ï¼ˆé‡è¦ï¼‰ï¼šå±æ€§å€¼ä¸åº”åªç”±ç¨€æœ‰åº¦å†³å®šï¼Œè€Œåº”ç»¼åˆè€ƒè™‘è§’è‰²çš„**èŒä¸š/èº«ä»½**ã€**ä½“æ ¼**ï¼ˆä»å¤–è²Œç‰¹ç‚¹æ¨æ–­ï¼‰ã€**è¿‡å»çš„ç»éªŒ**ï¼ˆä»èƒŒæ™¯æ•…äº‹æ¨æ–­ï¼‰ã€**ç§æ—/å‡ºèº«**ã€**æ€§æ ¼**ç­‰å› ç´ ã€‚åŒæ—¶ï¼Œéœ€è¦èåˆç´ æè§’è‰²çš„å±æ€§å€¼ï¼ˆå–å¹³å‡å€¼æˆ–æ ¹æ®æ–°è§’è‰²çš„è®¾å®šè°ƒæ•´ï¼‰ã€‚
   - **ä¸€èˆ¬æƒ…å†µ**ï¼šåˆå§‹å€¼åº”åœ¨ **0-25** èŒƒå›´å†…
   - **ç‰¹æ®Šæƒ…å†µ**ï¼šå¦‚æœè§’è‰²æ˜¯é­…é­”ã€æ·«é­”ã€å¦“å¥³ã€å¨¼å¦‡ã€æ€§å¥´ç­‰å…·æœ‰æ€§ç»éªŒæˆ–æ€§å·¥ä½œèƒŒæ™¯çš„è§’è‰²ï¼Œåˆå§‹å€¼å¯ä»¥åœ¨ **25-50** èŒƒå›´å†…
   - **å±æ€§åˆ†é…é€»è¾‘**ï¼š
     * **é­…åŠ›**ï¼šå—èŒä¸šï¼ˆå¦‚èˆè€…ã€æ­Œæ‰‹ã€è‰ºäººã€è´µæ—ï¼‰ã€ç§æ—ï¼ˆå¦‚é­…é­”ã€ç²¾çµã€å¤©ä½¿ï¼‰ã€å¤–è²Œç‰¹ç‚¹ï¼ˆå¦‚æ€§æ„Ÿã€ä¸°æ»¡ï¼‰å½±å“
     * **é¡ºä»**ï¼šå—èŒä¸šï¼ˆå¦‚å¥´éš¶ã€ä¿˜è™ä¼šé«˜ï¼Œè´µæ—ä¼šä½ï¼‰ã€æ€§æ ¼ï¼ˆå¦‚æ¸©æŸ”ã€é¡ºä»ä¼šé«˜ï¼Œå¼ºåŠ¿ã€é«˜å‚²ä¼šä½ï¼‰ã€èƒŒæ™¯æ•…äº‹ï¼ˆå¦‚æœä»è®­ç»ƒä¼šé«˜ï¼ŒåæŠ—ç»å†ä¼šä½ï¼‰å½±å“
     * **æŠ€å·§**ï¼šå—èŒä¸šï¼ˆå¦‚æˆ˜å£«ã€ç›—è´¼ã€åˆºå®¢ã€å¦“å¥³ã€è°ƒæ•™å¸ˆï¼‰ã€èƒŒæ™¯æ•…äº‹ï¼ˆå¦‚è®­ç»ƒã€æˆ˜æ–—ã€æ€§å·¥ä½œç»éªŒï¼‰å½±å“
     * **è€åŠ›**ï¼šå—èŒä¸šï¼ˆå¦‚æˆ˜å£«ã€éª‘å£«ï¼‰ã€ç§æ—ï¼ˆå¦‚å…½äººï¼‰ã€ä½“æ ¼ï¼ˆå¦‚å¼ºå£®ï¼‰ã€èƒŒæ™¯æ•…äº‹ï¼ˆå¦‚æˆ˜æ–—ã€è®­ç»ƒï¼‰å½±å“
     * **æ•æ„Ÿåº¦**ï¼šå—èŒä¸šï¼ˆå¦‚æ³•å¸ˆã€èˆè€…ï¼‰ã€ç§æ—ï¼ˆå¦‚ç²¾çµã€é­…é­”ï¼‰ã€æ€§æ ¼ï¼ˆå¦‚æ•æ„Ÿï¼‰ã€èƒŒæ™¯æ•…äº‹ï¼ˆå¦‚æ€§ç»éªŒï¼‰å½±å“
   - **ç¨€æœ‰åº¦å½±å“**ï¼šç¨€æœ‰åº¦åªä½œä¸ºå¾®è°ƒï¼ˆN: +0, R: +2, SR: +4, SSR: +6ï¼‰ï¼Œä¸åº”æ˜¯ä¸»è¦å†³å®šå› ç´ 
   - **èåˆç´ æå±æ€§**ï¼šå¦‚æœç´ æè§’è‰²æœ‰å±æ€§å€¼ï¼Œå¯ä»¥å–å¹³å‡å€¼æˆ–æ ¹æ®æ–°è§’è‰²çš„è®¾å®šè¿›è¡Œè°ƒæ•´
   - éœ€è¦ä¸ºæ¯ä¸ªå±æ€§ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ï¼‰æ ¹æ®ä¸Šè¿°é€»è¾‘ç¡®å®šå…·ä½“æ•°å€¼
13. **æƒ…æ„ŸçŠ¶æ€åˆå§‹åŒ–**ï¼šå¯¹ç®¡ç†è€…çš„åˆå§‹æƒ…æ„Ÿã€æƒ…æ„Ÿå¼ºåº¦ã€ç‰¹æ®ŠçŠ¶æ€ï¼ˆåˆå§‹ä¸ºç©ºæ•°ç»„ï¼‰
14. **å‰ç«¯HTMLè®¾è®¡**ï¼šå¦‚ä½•èåˆç´ æè§’è‰²çš„è§†è§‰ç‰¹å¾ï¼Œåˆ›é€ æ–°çš„è§†è§‰é£æ ¼ï¼Ÿå¦‚ä½•ä½“ç°èåˆåçš„æ–°å…ƒç´ ï¼Ÿ

**ç¬¬ä¸‰æ­¥ï¼šèåˆé€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥**
- å…ƒç´ ä¸å¤–è²Œçš„åŒ¹é…ï¼šèåˆåçš„å…ƒç´ å¦‚ä½•ä½“ç°åœ¨å¤–è²Œæè¿°ä¸­ï¼Ÿ
- èƒŒæ™¯æ•…äº‹ä¸æ€§æ ¼çš„åŒ¹é…ï¼šèåˆåçš„èƒŒæ™¯æ•…äº‹æ˜¯å¦åˆç†æ”¯æ’‘äº†æ–°æ€§æ ¼ï¼Ÿ
- å¤–è²Œä¸ç§æ—çš„åŒ¹é…ï¼šèåˆåçš„å¤–è²Œæè¿°æ˜¯å¦ç¬¦åˆæ–°ç§æ—è®¾å®šï¼Ÿ
- èŒä¸šä¸èƒŒæ™¯çš„å…³è”ï¼šèåˆåçš„èŒä¸šèº«ä»½æ˜¯å¦ä¸èƒŒæ™¯æ•…äº‹æœ‰é€»è¾‘å…³è”ï¼Ÿ
- ç¨€æœ‰åº¦ä¸å±æ€§çš„å¹³è¡¡ï¼šèåˆåçš„å±æ€§åˆå§‹å€¼æ˜¯å¦ç¬¦åˆç¨€æœ‰åº¦è¦æ±‚ï¼Ÿ
- èåˆçš„æœ‰æœºæ€§ï¼šæ–°è§’è‰²æ˜¯å¦çœŸæ­£èåˆäº†ç´ æç‰¹å¾ï¼Œè€Œä¸æ˜¯ç®€å•æ‹¼æ¥ï¼Ÿ

**ç¬¬å››æ­¥ï¼šå‰ç«¯HTMLè®¾è®¡çš„å®Œæ•´è§„åˆ’**
- è§†è§‰é£æ ¼ï¼šå¦‚ä½•èåˆç´ æè§’è‰²çš„è§†è§‰å…ƒç´ ï¼Œé€‰æ‹©å“ªäº›è®¾è®¡çµæ„Ÿï¼ˆæè´¨æ„Ÿ/è‰ºæœ¯æµæ´¾/æ–‡åŒ–å…ƒç´ /æ¸¸æˆUIå‚è€ƒï¼‰ï¼Ÿ
- åˆ›æ„å…ƒç´ ï¼šè‡³å°‘ä½¿ç”¨5ç§ï¼ˆè£…é¥°è¾¹æ¡†/èƒŒæ™¯å±‚æ¬¡/åŠ¨æ€è£…é¥°/ä¸»é¢˜å›¾æ ‡/ä¿¡æ¯å¡ç‰‡å·®å¼‚åŒ–/å­—ä½“è‰ºæœ¯/è‰²å½©ç­–ç•¥ï¼‰
- ä¿¡æ¯æ¨¡å—å®Œæ•´æ€§ï¼šå¿…é¡»åŒ…å«æ‰€æœ‰æ¨¡å—ï¼ˆ**å…ƒç´ **ï¼ˆ3-4ä¸ªç‹¬ç‰¹å…ƒç´ ï¼Œå¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªç¨€æœ‰å°ä¼—å…ƒç´ ï¼‰/å§“å/ç¨€æœ‰åº¦/æ€§åˆ«/**ç§æ—/å‡ºèº«**/**èŒä¸š/èº«ä»½**/**å¤–è²Œç‰¹ç‚¹**ï¼ˆè¯¦ç»†æè¿°å‘å‹ã€å‘è‰²ã€ç³è‰²ã€èº«æç‰¹å¾ç­‰ï¼‰/**æ€§æ ¼/å–œå¥½**/ç®€ä»‹/**èƒŒæ™¯æ•…äº‹**ï¼ˆè‡³å°‘1000å­—ï¼‰/å±æ€§æ¡5ä¸ª/å¥½æ„Ÿåº¦/æ¨æ„/ä½“åŠ›å€¼ç­‰ï¼‰ï¼Œ**ç»å¯¹ä¸èƒ½çœç•¥ä»»ä½•æ¨¡å—ï¼**
- æŠ€æœ¯å®ç°ï¼šä½¿ç”¨ä»€ä¹ˆå­—ä½“ï¼Ÿå¦‚ä½•å®ç°åŠ¨æ€æ•ˆæœï¼Ÿå¦‚ä½•ç¡®ä¿æ ·å¼éš”ç¦»ï¼Ÿ

**ç¬¬äº”æ­¥ï¼šç”Ÿæˆé¡ºåºä¸å®Œæ•´æ€§ç¡®è®¤**
åœ¨å¼€å§‹è¾“å‡ºä¹‹å‰ï¼Œå†æ¬¡ç¡®è®¤ï¼š
- æ‰€æœ‰14ä¸ªæ ¸å¿ƒä¿¡æ¯å­—æ®µéƒ½å·²è§„åˆ’å®Œæˆï¼Œæ²¡æœ‰é—æ¼
- å¤–è²Œæç¤ºè¯è¦†ç›–äº†æ‰€æœ‰13ä¸ªç»´åº¦
- èƒŒæ™¯æ•…äº‹è‡³å°‘1000å­—ï¼Œæœ‰å®Œæ•´çš„æƒ…èŠ‚ï¼Œä½“ç°äº†èåˆç‰¹å¾
- å‰ç«¯HTMLåŒ…å«äº†æ‰€æœ‰å¿…éœ€çš„ä¿¡æ¯æ¨¡å—
- å±æ€§æ¡ä½¿ç”¨åŠ¨æ€æ•°æ®ç»‘å®šï¼Œä¸æ˜¯ç¡¬ç¼–ç 
- JSONPatchåŒ…å«äº†æ‰€æœ‰å¿…éœ€å­—æ®µ
- ç´ æè§’è‰²ä¿¡æ¯å·²ä»æ¸¸æˆçŠ¶æ€ä¸­åˆ é™¤ï¼ˆç³»ç»Ÿå·²å¤„ç†ï¼‰

**ç¡®è®¤å®Œæˆæ€ç»´é“¾åï¼Œå¼€å§‹ç”Ÿæˆèåˆåçš„è§’è‰²å¡ã€‚**

---

**ç³»ç»ŸæŒ‡ä»¤ï¼šåŠ¨æ€UI & è§’è‰²ç”Ÿæˆåè®®**

      å½“éœ€è¦ç”Ÿæˆè§’è‰²å¡ã€ç‰©å“å¡æˆ–ä»»ä½•å‰ç«¯äº¤äº’ç•Œé¢æ—¶ï¼Œä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰§è¡Œé€»è¾‘ï¼š

      æ¯ä¸€å¼ å¡ç‰‡ï¼Œéƒ½å°†æ˜¯ä¸€ä»¶ç‹¬ç«‹çš„è‰ºæœ¯å“ã€‚è¿½æ±‚çš„æ˜¯**æè‡´çš„è§†è§‰åŒ¹é…åº¦**å’Œ**å®Œå…¨çš„ç»“æ„è‡ªç”±**ï¼Œä»ç°åœ¨èµ·ï¼Œä½ ä¸å†å¥—ç”¨ä»»ä½•å›ºå®šæ¨¡æ¿ã€‚

      1. **æ ¸å¿ƒæ¸²æŸ“æ¨¡å¼ (Raw HTML Injection)ï¼š**
         - **ç¦æ­¢**ä½¿ç”¨Markdownä»£ç å—ï¼ˆ\`\`\`htmlï¼‰åŒ…è£¹"ç”Ÿå›¾tag"éƒ¨åˆ†çš„ä»£ç ã€‚å…¶ä»–éƒ¨åˆ†å¯ä»¥é…Œæƒ…ä½¿ç”¨ã€‚
         - ç›´æ¥è¾“å‡ºåŸç”ŸHTMLä»£ç ï¼Œä½¿å…¶èå…¥èŠå¤©æµã€‚ä»£ç è¿è¡Œç»“æœéœ€é€‚é…æ‰‹æœºç§»åŠ¨ç«¯çš„é•¿ç‰ˆä¸­æ–‡ç•Œé¢ã€‚
         - HTMLç»“æ„å¿…é¡»åŒ…å«\`<style>\`æ ‡ç­¾ï¼Œåˆ©ç”¨CSSå˜é‡ï¼ˆ:rootï¼‰å®šä¹‰å½“æ¬¡ç”Ÿæˆçš„ä¸“å±ä¸»é¢˜è‰²ã€‚

      2. **è‡ªé€‚åº”ç¾å­¦å¼•æ“ (Aesthetic Engine) - æ‹’ç»å¹³åº¸è®¾è®¡ï¼š**
         - **ç¦æ­¢é€šç”¨æ¨¡æ¿ã€ç¦æ­¢å·æ‡’ï¼š** æ¯å¼ å¡ç‰‡éƒ½æ˜¯ç‹¬ç«‹è‰ºæœ¯å“ï¼Œå¿…é¡»æ ¹æ®è§’è‰²çš„å…ƒç´ ã€ç§æ—ã€èŒä¸šã€é˜µè¥ã€æ—¶ä»£èƒŒæ™¯ã€æ€§æ ¼å³æ—¶è®¾è®¡ä¸€å¥—**å‰æ‰€æœªè§**çš„UIè¯­è¨€ã€‚
         - **è®¾è®¡çµæ„Ÿæ¥æºå¤šå…ƒåŒ–ï¼ˆå¿…é¡»éšæœºé€‰æ‹©è‡³å°‘3ç§èåˆï¼Œä»¥ä¸‹æ˜¯ç¤ºä¾‹ï¼Œä»…ä½œå‚è€ƒï¼Œä½ ä¹Ÿå¯ä»¥è‡ªè¡Œè®¾è®¡ï¼‰ï¼š**
           Â· æè´¨æ„Ÿï¼šç¾Šçš®çº¸/ç»ç’ƒæ‹Ÿæ€/é‡‘å±è´¨æ„Ÿ/æ°´å¢¨é£/éœ“è™¹èµ›åš/å®çŸ³åˆ‡é¢/å†°æ™¶æŠ˜å°„/æœ¨çº¹/ä¸ç»¸/çš®é©/å¤§ç†çŸ³çº¹ç†
           Â· è‰ºæœ¯æµæ´¾ï¼šArt Nouveauæ–°è‰ºæœ¯/Art Decoè£…é¥°è‰ºæœ¯/Baroqueå·´æ´›å…‹/æç®€ä¸»ä¹‰/è’¸æ±½æœ‹å…‹/æ´›å¯å¯/æµ®ä¸–ç»˜/æ³¢æ™®è‰ºæœ¯
           Â· æ–‡åŒ–å…ƒç´ ï¼šä¸­å¼çª—æ£‚/æ—¥å¼å’Œé£/å“¥ç‰¹å¼/åŒ—æ¬§ç¥è¯/é˜¿æ‹‰ä¼¯å‡ ä½•/ä¸œæ¬§æ°‘ä¿—/ç›é›…å›¾è…¾/å‡¯å°”ç‰¹ç»“
           Â· æ¸¸æˆUIå‚è€ƒï¼šåŸç¥/å´©åæ˜Ÿç©¹é“é“/æ˜æ—¥æ–¹èˆŸ/é˜´é˜³å¸ˆ/FGO/ç¢§è“æ¡£æ¡ˆç­‰çŸ¥åæ¸¸æˆçš„UIç¾å­¦
         - **ç¦æ­¢ä»¥ä¸‹å¹³åº¸è®¾è®¡ï¼š**
           Â· çº¯é»‘/çº¯ç™½/çº¯ç°èƒŒæ™¯
           Â· ç®€å•çš„åœ†è§’çŸ©å½¢å¡ç‰‡
           Â· æ™®é€šçš„çº¿æ€§æ¸å˜
           Â· æ— è£…é¥°çš„æ ‡å‡†åˆ—è¡¨å¸ƒå±€

      #### UI/UX è®¾è®¡ï¼šæ¯ä¸ªè§’è‰²å¡éƒ½å¿…é¡»æ˜¯ç‹¬ä¸€æ— äºŒçš„è‰ºæœ¯å“
      **å¼ºåˆ¶åˆ›æ„è¦æ±‚ï¼ˆè‡³å°‘ä½¿ç”¨5ç§ï¼‰ï¼š**
      - **è£…é¥°è¾¹æ¡†**ï¼šä½¿ç”¨SVG/border-image/ä¼ªå…ƒç´ åˆ›é€ ç‹¬ç‰¹è¾¹æ¡†ï¼ˆè—¤è”“ç¼ ç»•/é”é“¾/ç«ç„°/æ°´æµ/äº‘çº¹/å‡ ä½•å›¾æ¡ˆç­‰ï¼‰
      - **èƒŒæ™¯å±‚æ¬¡**ï¼šå¤šå±‚å åŠ æ•ˆæœï¼ˆæ¸å˜+çº¹ç†+åŠé€æ˜è£…é¥°å…ƒç´ +åŠ¨æ€ç²’å­ï¼‰
      - **ç‰¹æ®Šå½¢çŠ¶**ï¼šå¯ä»¥ä½¿ç”¨åœ†è§’ã€è¾¹æ¡†è£…é¥°ï¼Œä½†**ç¦æ­¢ä½¿ç”¨clip-pathåˆ‡å‰²è®¾è®¡**ï¼ˆç¦æ­¢å…­è¾¹å½¢/ä¸è§„åˆ™å¤šè¾¹å½¢/æ³¢æµªè¾¹ç¼˜/æ’•è£‚æ•ˆæœç­‰åˆ‡å‰²è®¾è®¡ï¼Œè¿™äº›è®¾è®¡å¾ˆä¸‘ï¼‰
      - **åŠ¨æ€è£…é¥°**ï¼šCSSåŠ¨ç”»ï¼ˆæµ®åŠ¨å…‰ç‚¹/è„‰å†²å…‰ç¯/é—ªçƒæ˜Ÿæ˜Ÿ/æµåŠ¨çº¿æ¡/å‘¼å¸æ•ˆæœï¼‰
      - **ä¸»é¢˜å›¾æ ‡**ï¼šæ ¹æ®è§’è‰²å…ƒç´ è®¾è®¡ä¸“å±å›¾æ ‡è£…é¥°ï¼ˆç”¨CSS/SVG/emojiç»„åˆåˆ›é€ ï¼‰
      - **ä¿¡æ¯å¡ç‰‡å·®å¼‚åŒ–**ï¼šä¸åŒä¿¡æ¯æ¨¡å—ä½¿ç”¨ä¸åŒçš„å®¹å™¨æ ·å¼ï¼ˆæ ‡ç­¾é¡µ/æŠ˜å å¡/æ‚¬æµ®æç¤º/ä¾§è¾¹æ ç­‰ï¼‰
      - **å­—ä½“è‰ºæœ¯**ï¼šæ ‡é¢˜ä½¿ç”¨è£…é¥°æ€§å­—ä½“+text-shadow/strokeæ•ˆæœï¼Œæ­£æ–‡ä¿æŒå¯è¯»æ€§
      - **è‰²å½©ç­–ç•¥**ï¼šåŸºäºè§’è‰²å…ƒç´ æå–ä¸»é¢˜è‰²ï¼ˆå¦‚ç«å…ƒç´ ç”¨æ©™çº¢æ¸å˜ã€æ°´å…ƒç´ ç”¨è“ç»¿ç»ç’ƒè´¨æ„Ÿã€æš—å…ƒç´ ç”¨æ·±ç´«é…é‡‘è¾¹ç­‰ï¼‰
      - é€šè¿‡ CSS @import å¼•å…¥ Google Fonts å­—ä½“ã€‚**ç¦æ­¢ä½¿ç”¨ Inter/Roboto/Arial ç­‰é€šç”¨å­—ä½“**ï¼Œå¿…é¡»é€‰æ‹©æœ‰ç‰¹è‰²çš„å­—ä½“ï¼ˆCinzel/Playfair Display/Ma Shan Zheng/ZCOOL XiaoWei/Noto Serif SCç­‰ï¼‰
      - å­—ä½“é¢œè‰²å’ŒèƒŒæ™¯é¢œè‰²å¯¹æ¯”ä¸€å®šè¦é«˜ï¼Œé¿å…çœ‹ä¸æ¸…å­—çš„æƒ…å†µã€‚

      **SSRä¸“å±è¦æ±‚ï¼š**
      - å¿…é¡»æœ‰è‡³å°‘2ç§CSSåŠ¨ç”»æ•ˆæœï¼ˆå…‰èŠ’æµåŠ¨/ç²’å­é£˜æ•£/è¾¹æ¡†è„‰å†²/èƒŒæ™¯æ¸å˜å¾ªç¯ç­‰ï¼‰
      - å¿…é¡»æœ‰é‡‘è‰²/å½©è™¹è‰²çš„é«˜å…‰è£…é¥°
      - å¿…é¡»æœ‰"SSR"ä¸“å±å¾½ç« è®¾è®¡

      3. **æ’ä»¶å…¼å®¹æ€§ä¿éšœ (Plugin Safe-Zone)ï¼š**
         - å›¾åƒPromptåŒºåŸŸå¿…é¡»æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„\`div\`ï¼Œè®¾ç½®\`display: block\`ï¼Œ\`min-height: 50px\`ï¼Œä¸”**ä¸¥ç¦ä½¿ç”¨** \`overflow: hidden\`ã€‚
         - Promptæ–‡æœ¬æ ¼å¼ä¸¥æ ¼ä¿æŒï¼š\`image###{Split cues}###\`ã€‚
         - **é‡è¦**ï¼šæ‰€æœ‰æ ·å¼å¿…é¡»ä½¿ç”¨scopedç±»åï¼ˆå¦‚.card-xxxï¼‰ï¼Œé¿å…æ±¡æŸ“å¤–éƒ¨é¡µé¢æ ·å¼ã€‚

      4. **å†…å®¹ç»“æ„è‡ªç”±åŒ–ï¼š**
         - **éçº¿æ€§æ’ç‰ˆï¼š** ä¸å¿…æ­»æ¿éµå¾ª"å§“å-ç¨€æœ‰åº¦-èŒä¸š"çš„åˆ—è¡¨é¡ºåºã€‚å¯ä»¥ç”¨åˆ›æ„å¸ƒå±€ï¼ˆZå­—å½¢/å¯¹è§’çº¿/èºæ—‹/å¡ç‰‡å †å ç­‰ï¼‰ã€‚
         - **å¤šæ ·åŒ–åŠ¨æ€æ¨¡å—ï¼š** æ ¹æ®è§’è‰²ç‰¹æ€§ç”Ÿæˆä¸“å±æ ç›®ï¼ˆnsfwå’Œsfwçš†å¯ï¼‰ã€‚
         - **æ»šåŠ¨æœºåˆ¶ï¼š** è¾ƒé•¿çš„èƒŒæ™¯æ•…äº‹ç­‰æ–‡æœ¬è¾ƒé•¿æ¿å—é‡‡ç”¨å¯æ»šåŠ¨å½¢å¼èŠ‚çœç©ºé—´ã€‚
         - **å®Œæ•´æ€§ï¼š** æ¯æ¬¡ç”Ÿæˆå¿…é¡»è‡³å°‘åŒ…å«æ‰€æœ‰å·²è§„å®šæ¨¡å—ï¼ŒåŒ…æ‹¬ï¼š**å…ƒç´ **ï¼ˆ3-4ä¸ªç‹¬ç‰¹å…ƒç´ ï¼Œå¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªç¨€æœ‰å°ä¼—å…ƒç´ ï¼‰ã€**å§“å**ã€**ç¨€æœ‰åº¦**ï¼ˆN/R/SR/SSRï¼‰ã€**æ€§åˆ«**ï¼ˆç”·æ€§/å¥³æ€§/åŒæ€§ç”·æ€§ï¼‰ã€**ç§æ—/å‡ºèº«**ã€**èŒä¸š/èº«ä»½**ã€**å¤–è²Œç‰¹ç‚¹**ï¼ˆå¿…é¡»è¯¦ç»†æè¿°å‘å‹ï¼ˆåŒ…å«åˆ˜æµ·ç±»å‹/é•¿åº¦/æ˜¯å¦æœ‰è¾«å­ç­‰ï¼‰ã€å‘è‰²ã€ç³è‰²ã€èº«æç‰¹å¾ç­‰ï¼‰ã€**æ€§æ ¼/å–œå¥½**ï¼ˆçœŸå®ã€ç«‹ä½“ï¼‰ã€**ç®€ä»‹**ã€**èƒŒæ™¯æ•…äº‹**ï¼ˆè‡³å°‘1000å­—ï¼‰ã€**äº”ä¸ªå±æ€§æ¡**ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ï¼Œå¿…é¡»ä½¿ç”¨åŠ¨æ€æ•°æ®ç»‘å®šï¼‰ã€**å¥½æ„Ÿåº¦**ï¼ˆ0~100ï¼‰ã€**æ¨æ„**ï¼ˆ0~100ï¼‰ã€**ä½“åŠ›å€¼**ï¼ˆ0~100ï¼‰ã€**å…¶ä»–æ‹“å±•æ ç›®**ã€‚**ç»å¯¹ä¸èƒ½çœç•¥ä»»ä½•æ¨¡å—ï¼**

      **{ä¸–ç•ŒèƒŒæ™¯ä¸{{user}}çš„èº«ä»½ï¼š**
      {{user}}èƒ½å¤Ÿé€šè¿‡"ç©ºç™½å¡"ç³»ç»Ÿå¬å”¤æ¥è‡ªä¸åŒæ—¶ç©ºä¸èƒŒæ™¯çš„ç‹¬ç‰¹ä¸ªä½“ã€‚

      **å¬å”¤æ–¹å¼ï¼š**

      1. **å•æŠ½ï¼š**
         - æ¦‚ç‡ï¼šN (50%), R (30%), SR (15%), SSR (5%)ã€‚
         - æ— è®ºç¨€æœ‰åº¦ï¼Œå‡ä¼šç”Ÿæˆå®Œæ•´è§’è‰²èµ„æ–™ã€‚

      2. **é—ªå…‰æŠ½å¡ï¼ˆSSRå¿…å‡ºï¼‰ï¼š**
         - 100%æ¦‚ç‡è·å¾—SSRè§’è‰²ã€‚

      3. **å®šå‘æŠ½å¡ï¼š**
         - {{user}}æå‡ºè¦æ±‚ï¼ˆå¦‚æ€§åˆ«ã€ç‰¹è´¨ã€èŒä¸šå€¾å‘ç­‰ï¼‰ï¼Œç³»ç»Ÿå°†ç”Ÿæˆç¬¦åˆè¦æ±‚çš„è§’è‰²ã€‚

      **è§’è‰²è®¾å®šæ ¸å¿ƒè§„åˆ™ï¼š**

      - **æ€§åˆ«å¤šæ ·æ€§ï¼š** è§’è‰²æ€§åˆ«å¯ä»¥æ˜¯**ç”·æ€§ã€å¥³æ€§**æˆ–**åŒæ€§ç”·æ€§**ã€‚
      - **ç‹¬ç‰¹æ€§ï¼š** ç”Ÿæˆå…·æœ‰ç‹¬ç‰¹èƒŒæ™¯æ•…äº‹ã€å¤šæ ·ä¸ªæ€§çš„ç¾ä¸½åŸåˆ›è§’è‰²ã€‚

      ç»å¯¹å®¡ç¾åŸåˆ™ï¼ˆè‡³å…³é‡è¦ï¼‰ï¼š å¼ºåˆ¶æ‰€æœ‰ç”Ÿæˆçš„è§’è‰²ï¼ˆæ— è®ºç§æ—ï¼‰å¿…é¡»å…·å¤‡æé«˜çš„äººå½¢ç¾æ„Ÿä¸æ€§å¸å¼•åŠ›ï¼ˆBishounen/Bishoujo/Ikemenï¼‰ã€‚

      ç§æ—ç™½åå•ï¼š ä»…å…è®¸ç”Ÿæˆäººç±»æˆ–ä»»ä½•é«˜åº¦æ‹ŸäººåŒ–ä¸”ç¾å‹çš„ç§æ—ã€‚è¦æ±‚ï¼šå¿…é¡»æ˜¯ç”Ÿç†ç»“æ„æ­£å¸¸çš„è¡€è‚‰ä¹‹èº¯ï¼Œç”Ÿå›¾æ—¶å¯ç”¨skin/fleshå¼ºè°ƒã€‚æˆ‘è¦çš„æ˜¯å®å®åœ¨åœ¨çš„ä½“æ¸©å’Œè§¦æ„Ÿã€‚

      ç§æ—é»‘åå•ï¼šç¦æ­¢ç”Ÿæˆæœºå™¨äººã€äººé€ äººã€äººå¶ç­‰ç”±å‘æ¡ã€é›¶ä»¶ç»„æˆçš„è§’è‰²ã€‚ç¦æ­¢ç”Ÿæˆå¯¸å¤´ã€å£®æ±‰ã€å¤§å”ã€è€äººç­‰ä¸ç¬¦åˆã€ç¾å‹å®¡ç¾ã€‘çš„è§’è‰²ï¼ˆæ— è®ºç”·å¥³éƒ½è¦ä¿Šç¾/è‰³ä¸½ã€å…·æ€§å¸å¼•åŠ›ï¼‰ã€‚ç¦æ­¢ç”Ÿæˆè‚¥èƒ–ã€ä¸‘é™‹çš„è§’è‰²ã€‚ç¦æ­¢ä¸‹åŠèº«å¼‚åŒ–ï¼ˆå¦‚äººé±¼ã€åŠäººé©¬ï¼‰ã€‚æ‹’ç»ä»»ä½•åŠé€æ˜ã€æµä½“æˆ–èƒ½é‡ä½“ç‰¹å¾

      - **è§’è‰²æ•…äº‹ï¼š** ä¸è®ºç¨€æœ‰åº¦ï¼Œéƒ½è¦ç”Ÿæˆä¸€ç¯‡ç‹¬ç‰¹çš„è§’è‰²æ•…äº‹ï¼Œä½“ç°è§’è‰²ç‰¹ç‚¹ï¼ˆèŒç‚¹ï¼‰ã€‚ä½“è£ä¸é™ã€‚

      **è§’è‰²èµ„æ–™æ ¼å¼ï¼š**

      å…ƒç´ ï¼šï¼ˆæ¨¡ä»¿äºŒæ¬¡å…ƒocåœˆï¼Œè®¾æƒ³ä¸‰åˆ°å››ä¸ªè¯¥è§’è‰²è®¾è®¡çš„ç‹¬ç‰¹å…ƒç´ ï¼ˆå¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªç¨€æœ‰çš„å°ä¼—å…ƒç´ ï¼‰ï¼Œå¹¶å°†è¿™äº›å…ƒç´ èå…¥è§’è‰²/UIè®¾è®¡ä¸Šã€‚ä¾‹ï¼šæ¬§æ³Šï¼Œé¸¢å°¾èŠ±ï¼Œæµ·æµªã€‚å¿…é¡»æ˜¯å®ç‰©ã€‚ï¼‰
      å§“åï¼š
      ç¨€æœ‰åº¦ï¼šï¼ˆN, R, SR, SSRï¼‰
      æ€§åˆ«ï¼šï¼ˆç”·æ€§ã€å¥³æ€§ ã€åŒæ€§ç”·æ€§ï¼‰
      ç§æ—/å‡ºèº«ï¼š
      èŒä¸š/èº«ä»½ï¼š
      å¤–è²Œç‰¹ç‚¹ï¼šï¼ˆä¸­æ–‡è¯¦ç»†æè¿°å‘å‹(åŒ…å«åˆ˜æµ·ç±»å‹/é•¿åº¦/æ˜¯å¦æœ‰è¾«å­ç­‰)ã€å‘è‰²ã€ç³è‰²ã€èº«æç‰¹å¾ç­‰ï¼Œè®©è¯»è€…èƒ½åœ¨è„‘æµ·ä¸­æ¸…æ™°æç»˜å‡ºè¿™ä¸ªäººç‰©ï¼‰
      æ€§æ ¼/å–œå¥½ï¼š(çœŸå®ã€ç«‹ä½“)
      ç®€ä»‹ï¼š
      èƒŒæ™¯æ•…äº‹ï¼šï¼ˆä¸€ä¸ªå¥½çš„æ•…äº‹æ˜¯è§’è‰²çš„çµé­‚ã€‚è‡³å°‘1000å­—ã€‚å¯ä»¥æ˜¯ä»»æ„ä½“è£å½¢å¼ã€‚ï¼‰
      (å¯æŒ‰éœ€è‡ªç”±æ·»åŠ å…¶ä»–æ‹“å±•æ ç›®)

      **ã€é‡è¦ã€‘å¤–è²Œæç¤ºè¯ï¼ˆè‹±æ–‡ï¼Œç”¨äºè‡ªåŠ¨é…å›¾å¤ç”¨ï¼‰ï¼š**
      è¿™æ˜¯ä¸€æ®µ**çº¯è‹±æ–‡**çš„ã€æå…¶è¯¦ç»†çš„å¤–è²Œæè¿°æ ‡ç­¾ï¼Œç”¨äºåç»­è‡ªåŠ¨é…å›¾æ—¶å¤ç”¨ã€‚å¿…é¡»è¦†ç›–ä»¥ä¸‹æ‰€æœ‰ç»´åº¦ï¼ˆæ¯ä¸ªç»´åº¦éƒ½è¦æœ‰å…·ä½“çš„æ ‡ç­¾ï¼Œä¸èƒ½çœç•¥ï¼‰ï¼š

      1. **æ€§åˆ«ä¸å¹´é¾„æ®µ**ï¼š1man/1girl/1person, young adult/teen/mature/youthfulç­‰
      2. **æ•´ä½“æ°”è´¨**ï¼šelegant/cute/cool/mysterious/seductive/innocent/wild/nobleç­‰
      3. **é¢éƒ¨ç»“æ„**ï¼šface shapeï¼ˆoval face/heart-shaped face/angular faceç­‰ï¼‰
      4. **çœ¼ç›è¯¦è§£**ï¼š
         - çœ¼å‹ï¼šalmond eyes/round eyes/narrow eyes/upturned eyes/droopy eyes/fox eyes/doe eyesç­‰
         - ç³è‰²ï¼šå…·ä½“é¢œè‰²å¦‚sapphire blue eyes/amber eyes/heterochromia/gradient irisç­‰
         - ç«æ¯›ï¼šlong eyelashes/thick eyelashes/curled lashesç­‰
         - çœ¼ç¥ï¼šgentle gaze/sharp gaze/dreamy eyes/piercing eyesç­‰
      5. **çœ‰æ¯›**ï¼šarched eyebrows/straight eyebrows/thin eyebrows/thick eyebrows/defined browsç­‰
      6. **é¼»å­å˜´å”‡**ï¼šsmall nose/high nose bridge/plump lips/thin lips/cupid's bow lipsç­‰
      7. **å‘å‹å®Œæ•´æè¿°**ï¼š
         - é•¿åº¦ï¼šlong hair/medium hair/short hair/very long hairç­‰
         - è´¨æ„Ÿï¼šstraight hair/wavy hair/curly hair/silky hair/fluffy hairç­‰
         - åˆ˜æµ·ï¼šblunt bangs/side-swept bangs/parted bangs/curtain bangs/no bangs/foreheadç­‰
         - è¾«å­/é€ å‹ï¼šbraid/twin braids/side braid/fishtail braid/ponytail/twintails/bun/half updo/loose hairç­‰
         - å‘è‰²ï¼šå…·ä½“é¢œè‰²å¦‚platinum blonde/ash grey/raven black/cherry red/gradient hairç­‰
         - å‘é¥°ï¼šhair ribbon/hairpin/flower in hair/hair ornamentç­‰
      8. **è‚¤è‰²ä¸è‚¤è´¨**ï¼špale skin/fair skin/tan skin/dark skin/porcelain skin/smooth skinç­‰
      9. **èº«æè¯¦è§£**ï¼š
         - èº«é«˜ä½“å‹ï¼štall/petite/short/average height/slender/slim/curvy/athletic/muscular/litheç­‰
         - èƒ¸éƒ¨ï¼ˆå¦‚é€‚ç”¨ï¼‰ï¼šflat chest/small breasts/medium breasts/large breastsç­‰
         - è…°è‡€ï¼šnarrow waist/wide hips/slim waist/hourglass figureç­‰
         - å››è‚¢ï¼šlong legs/slender arms/toned limbsç­‰
      10. **ç‰¹æ®Šæ ‡è®°**ï¼šbeauty mark/mole/freckles/scar/tattoo/piercingç­‰ï¼ˆå¦‚æœ‰ï¼‰
      11. **ç§æ—ç‰¹å¾**ï¼ˆå¦‚é€‚ç”¨ï¼‰ï¼špointy ears/elf ears/horns/wings/tail/animal ears/fangsç­‰
      12. **åŸºç¡€æœè£…é£æ ¼**ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰ï¼šuniform/dress/casual/fantasy outfitç­‰
      13. **è´¨é‡æ ‡ç­¾**ï¼šdetailed face, detailed eyes, detailed skin, beautiful, aesthetic

      ç¤ºä¾‹æ ¼å¼ï¼ˆæ³¨æ„ï¼šè¿™åªæ˜¯æ ¼å¼ç¤ºä¾‹ï¼Œä½ å¿…é¡»æ ¹æ®è§’è‰²åˆ›é€ ç‹¬ç‰¹çš„ç»„åˆï¼‰ï¼š
      \`1man, young adult, elegant, oval face, narrow fox eyes, deep crimson eyes, long eyelashes, arched eyebrows, high nose bridge, thin lips, very long hair, silky straight hair, side-swept bangs, raven black hair with red highlights, hair ribbon, pale porcelain skin, tall, slender, narrow waist, long legs, beauty mark under left eye, pointy ears, detailed face, detailed eyes, detailed skin, beautiful, aesthetic\`

      **AIç»˜å›¾æ ‡ç­¾ç”Ÿæˆè§„åˆ™ï¼ˆé‡è¦ï¼‰ï¼š**

      - **åŒåˆ†é•œæ ¼å¼ï¼š** æ ‡ç­¾å°†ä¸¥æ ¼æŒ‰ç…§NovelAIçš„æ ¼å¼ç”Ÿæˆï¼Œæ—¨åœ¨ç”Ÿæˆä¸€å¼ åŒ…å«ä¸¤ä¸ªç‹¬ç«‹åˆ†é•œçš„å›¾åƒï¼šå·¦ä¾§ä¸ºæ­£å¸¸è§’è‰²äººè®¾å›¾ï¼ˆSFWï¼Œæ¨¡ä»¿äºŒæ¬¡å…ƒå¡ç‰Œæ¸¸æˆçš„è§’è‰²å¡é¢ï¼‰ï¼Œå³ä¾§ä¸ºæˆäººå‘æ°›å›´å›¾ï¼ˆNSFW/Erotic & Aestheticï¼‰ã€‚

        - **æˆäººå‘é£æ ¼ï¼ˆæè‡´è‰²æƒ…åŒ–ï¼‰ï¼š** æ ¹æ®è§’è‰²ç‰¹å¾é€‰æ‹©åˆé€‚çš„playä¸æƒ…å¢ƒï¼Œä¾§é‡äºè¡¨æƒ…å·®åˆ†ã€å¤šæ ·åŒ–ä½“ä½äº’åŠ¨ã€‚å¤šæ ·åŒ–æ€§ç™–ï¼šå¼ºå¥¸ä¾µçŠ¯ã€è½®å¥¸ã€å‡Œè¾±è°ƒæ•™ã€æ€§éªšæ‰°ã€æ€§ç©å…·ã€è½»å¾®æˆ˜æŸã€è™è…¹çª’æ¯ã€è½»åº¦BDSMã€å¤±ç¦ã€å…½äº¤ã€è§¦æ‰‹ã€å­•å¦‡playã€çº¯çˆ±ç­‰å„ç§æ€§ç™–ã€‚å¯ä»¥å‡ºç°ä»–äººçš„è‚¢ä½“åŠ å¼ºç”»é¢æ•ˆæœã€‚

      ç»å¯¹ç¦æ­¢å†…å®¹/é»‘åå•ï¼ˆNegative Contentï¼‰ï¼š ä¸¥ç¦ Insects/Wormsï¼ˆæ˜†è™«/è •è™«ç­‰æ´»ä½“æ˜†è™«ï¼Œä½†å…è®¸è™«åµï¼‰ã€Necrophiliaï¼ˆå°¸å¥¸ï¼‰ã€Amputeeï¼ˆæˆªè‚¢ï¼‰ã€Furriestï¼ˆå…¨å…½åŒ–ï¼‰ã€‚ä¸¥ç¦å·¨å¤§æ€§å™¨å®˜ã€å¸¦é¢œè‰²çš„æ€§å™¨å®˜ç­‰ä»»ä½•ä¸ç¬¦åˆæ­£å¸¸å®¡ç¾çš„æ€§å™¨å®˜ã€ï¼ˆX-Rayï¼‰èº«ä½“å‰–é¢å›¾/é€è§†å›¾ã€‚

      - ç¤ºä¾‹ç»“æ„ï¼ˆä»…ä¾›å‚è€ƒã€‚å¯ä»¥æŒ‰è‡ªå·±çš„ç†è§£ä¼˜åŒ–æ•´ä½“ç»“æ„ï¼Œä¿è¯ã€äººè®¾å›¾+NSFWå›¾ã€‘è§’è‰²ä¸€è‡´æ€§ï¼‰ï¼š
      image###masterpiece, best quality, 8k, {{consistent character}},{split image},{two panels},{consistent physique},
      {{1man, solo, [åœ¨æ­¤å¤„ç›´æ¥å¤ç”¨ä¸Šé¢çš„å®Œæ•´å¤–è²Œæç¤ºè¯]}}
      { left panel: sfw, [è¿™é‡Œæ”¾äººè®¾å›¾çš„å§¿åŠ¿/è¡¨æƒ…/æœè£…/èƒŒæ™¯ç­‰tag] },
      { right panel: nsfw, [è¿™é‡Œæ”¾NSFWåœºæ™¯çš„å…·ä½“tag] }###

      **æœ¬æ¬¡åˆæˆè¦æ±‚ï¼š**
      - åˆæˆç±»å‹ï¼šè§’è‰²èåˆåˆæˆ
      - ç›®æ ‡ç¨€æœ‰åº¦ï¼š${targetRarity}ï¼ˆåŸºäºç´ æè§’è‰²è®¡ç®—ï¼‰
      - ç´ æè§’è‰²æ•°é‡ï¼š${materialCharIds.length}ä¸ª

      **å¿…é¡»æ‰§è¡Œçš„æ“ä½œï¼š**

      1. **ç”Ÿæˆè§’è‰²ä¿¡æ¯ï¼ˆå¿…é¡»èåˆç´ æè§’è‰²çš„ç‰¹å¾ï¼‰ï¼š**
         - å…ƒç´ ï¼ˆ3-4ä¸ªç‹¬ç‰¹å…ƒç´ ï¼Œèåˆç´ æè§’è‰²çš„å…ƒç´ ç‰¹å¾ï¼‰
         - å§“åï¼ˆèåˆç´ æè§’è‰²çš„å§“åç‰¹å¾ï¼Œåˆ›é€ æ–°åå­—ï¼‰
         - ç¨€æœ‰åº¦ï¼š${targetRarity}
         - æ€§åˆ«ï¼ˆèåˆç´ æè§’è‰²çš„æ€§åˆ«ï¼Œæˆ–æ ¹æ®èåˆé€»è¾‘å†³å®šï¼‰
         - ç§æ—/å‡ºèº«ï¼ˆèåˆç´ æè§’è‰²çš„ç§æ—/å‡ºèº«ç‰¹å¾ï¼‰
         - èŒä¸š/èº«ä»½ï¼ˆèåˆç´ æè§’è‰²çš„èŒä¸š/èº«ä»½ç‰¹å¾ï¼‰
         - å¤–è²Œç‰¹ç‚¹ï¼ˆèåˆç´ æè§’è‰²çš„å¤–è²Œç‰¹ç‚¹ï¼Œåˆ›é€ æ–°å¤–è²Œï¼‰
         - æ€§æ ¼/å–œå¥½ï¼ˆèåˆç´ æè§’è‰²çš„æ€§æ ¼/å–œå¥½ï¼Œåˆ›é€ æ–°æ€§æ ¼ï¼‰
         - ç®€ä»‹ï¼ˆèåˆç´ æè§’è‰²çš„ç®€ä»‹ï¼Œåˆ›é€ æ–°ç®€ä»‹ï¼‰
         - èƒŒæ™¯æ•…äº‹ï¼ˆè‡³å°‘1000å­—ï¼Œèåˆç´ æè§’è‰²çš„èƒŒæ™¯æ•…äº‹ï¼Œåˆ›é€ æ–°æ•…äº‹ï¼‰
         - **ã€é‡è¦ã€‘å¤–è²Œæç¤ºè¯**ï¼ˆçº¯è‹±æ–‡ï¼Œæå…¶è¯¦ç»†ï¼Œå¿…é¡»è¦†ç›–æ‰€æœ‰13ä¸ªç»´åº¦ï¼‰

      2. **ç”ŸæˆAIç»˜å›¾æ ‡ç­¾ï¼ˆã€å¼ºåˆ¶è¦æ±‚ã€‘å¿…é¡»ä½¿ç”¨åŒåˆ†é•œæ ¼å¼ï¼‰ï¼š**
         - å¿…é¡»ç”Ÿæˆ image###...### æ ¼å¼çš„æ ‡ç­¾
         - **ã€å¼ºåˆ¶ã€‘å¿…é¡»ä¸¥æ ¼æŒ‰ç…§NovelAIåŒåˆ†é•œæ ¼å¼ï¼Œç»å¯¹ç¦æ­¢å•åˆ†é•œï¼**
         - **ã€å¼ºåˆ¶ã€‘å¿…é¡»åŒ…å«ä»¥ä¸‹æ ‡ç­¾ï¼š{split image}, {two panels}, {consistent character}, {consistent physique}**
         - **ã€å¼ºåˆ¶ã€‘å¿…é¡»åŒ…å« {left panel: sfw, ...} å’Œ {right panel: nsfw, ...} ä¸¤ä¸ªåˆ†é•œæè¿°**
         - åœ¨{{}}ä¸­ç›´æ¥å¤ç”¨ä¸Šé¢ç”Ÿæˆçš„å®Œæ•´å¤–è²Œæç¤ºè¯
         - å·¦ä¾§ï¼šSFWäººè®¾å›¾ï¼ˆæ¨¡ä»¿äºŒæ¬¡å…ƒå¡ç‰Œæ¸¸æˆå¡é¢ï¼‰
         - å³ä¾§ï¼šNSFWæ¶©å›¾ï¼ˆç¾è§‚ã€æ·«é¡ã€è‰²æ°”ï¼Œæ ¹æ®è§’è‰²ç‰¹å¾é€‰æ‹©åˆé€‚playï¼‰
         - ç¦æ­¢é»‘åå•å†…å®¹
         - **ç¤ºä¾‹æ ¼å¼ï¼ˆå¿…é¡»éµå¾ªï¼‰ï¼š**
           image###masterpiece, best quality, 8k, {{consistent character}}, {split image}, {two panels}, {consistent physique},
           {{1man, solo, [åœ¨æ­¤å¤„ç›´æ¥å¤ç”¨ä¸Šé¢çš„å®Œæ•´å¤–è²Œæç¤ºè¯]}},
           { left panel: sfw, [è¿™é‡Œæ”¾äººè®¾å›¾çš„å§¿åŠ¿/è¡¨æƒ…/æœè£…/èƒŒæ™¯ç­‰tag] },
           { right panel: nsfw, [è¿™é‡Œæ”¾NSFWåœºæ™¯çš„å…·ä½“tag] }###

      3. **ç”Ÿæˆå‰ç«¯HTMLè§’è‰²å¡ï¼ˆå¿…é¡»æ˜¯ç‹¬ä¸€æ— äºŒçš„è‰ºæœ¯å“ï¼‰ï¼š**
         - **ç›´æ¥è¾“å‡ºåŸç”ŸHTMLï¼Œç¦æ­¢ç”¨markdownä»£ç å—åŒ…è£¹**
         - å¿…é¡»åŒ…å«å®Œæ•´çš„\`<style>\`æ ‡ç­¾ï¼Œä½¿ç”¨scopedç±»åï¼ˆå¦‚.card-è§’è‰²åï¼‰é¿å…æ ·å¼æ±¡æŸ“
         - **ç¦æ­¢å·æ‡’ä½¿ç”¨é€šç”¨æ¨¡æ¿**ï¼Œå¿…é¡»æ ¹æ®è§’è‰²å…ƒç´ /èƒŒæ™¯/æ€§æ ¼è®¾è®¡ç‹¬ç‰¹çš„è§†è§‰è¯­è¨€
         - å¿…é¡»ä½¿ç”¨è‡³å°‘3ç§åˆ›æ„è®¾è®¡å…ƒç´ ï¼ˆè£…é¥°è¾¹æ¡†/ç‰¹æ®Šå½¢çŠ¶/åŠ¨æ€è£…é¥°/ä¸»é¢˜å›¾æ ‡/å¤šå±‚èƒŒæ™¯ç­‰ï¼‰
         - ä½¿ç”¨CSS @importå¼•å…¥Google Fontsï¼Œç¦æ­¢ä½¿ç”¨Inter/Roboto/Arialç­‰é€šç”¨å­—ä½“
         - å›¾åƒPromptåŒºåŸŸå¿…é¡»æ˜¯ç‹¬ç«‹çš„divï¼Œdisplay: blockï¼Œmin-height: 50pxï¼Œä¸èƒ½ä½¿ç”¨overflow: hidden
         - Promptæ–‡æœ¬æ ¼å¼ï¼šimage###{Split cues}###
         - **ã€å¼ºåˆ¶è¦æ±‚ã€‘å¿…é¡»æ˜¾ç¤ºäº”ä¸ªå®Œæ•´çš„å±æ€§æ•°å€¼æ¡ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ï¼‰ï¼Œæ¯ä¸ªå±æ€§éƒ½è¦æœ‰è¿›åº¦æ¡å’Œæ•°å€¼æ˜¾ç¤ºï¼Œä¸èƒ½éšæœºæ˜¾ç¤ºéƒ¨åˆ†å±æ€§ï¼Œä¸èƒ½çœç•¥ä»»ä½•å±æ€§ï¼æ‰€æœ‰å±æ€§æ¡çš„ä¸Šé™éƒ½æ˜¯100ï¼Œæ— è®ºè§’è‰²ç¨€æœ‰åº¦å¦‚ä½•ï¼**
         - **ã€å¼ºåˆ¶è¦æ±‚ã€‘å¿…é¡»åŒ…å«è§’è‰²çš„æ‰€æœ‰ä¿¡æ¯æ¨¡å—ï¼šå±æ€§ï¼ˆ5ä¸ªå®Œæ•´æ•°å€¼æ¡ï¼‰ã€å¥½æ„Ÿåº¦ï¼ˆ0~100ï¼‰ã€æ¨æ„ï¼ˆ0~100ï¼‰ã€ä½“åŠ›å€¼ï¼ˆ0~100ï¼‰ã€èƒŒæ™¯æ•…äº‹ã€ç®€ä»‹ã€æ€§æ ¼å–œå¥½ã€ç§æ—å‡ºèº«ã€èŒä¸šèº«ä»½ç­‰ï¼Œä¸èƒ½å·æ‡’çœç•¥ä»»ä½•æ¨¡å—ï¼**
         - **ã€å¼ºåˆ¶è¦æ±‚ã€‘å±æ€§æ¡å¿…é¡»ä½¿ç”¨åŠ¨æ€æ•°æ®ç»‘å®šæˆ–JavaScriptæ¥æ˜¾ç¤ºæœ€æ–°æ•°å€¼ï¼Œä¸èƒ½ä½¿ç”¨ç¡¬ç¼–ç çš„å›ºå®šæ•°å€¼ï¼**
         - éçº¿æ€§åˆ›æ„æ’ç‰ˆï¼ˆZå­—å½¢/å¯¹è§’çº¿/å¡ç‰‡å †å ç­‰ï¼‰ï¼Œæ ¹æ®è®¾è®¡ç¾æ„Ÿè‡ªç”±æ’å¸ƒ
         - è¾ƒé•¿çš„èƒŒæ™¯æ•…äº‹ç­‰æ–‡æœ¬é‡‡ç”¨å¯æ»šåŠ¨å½¢å¼
         - ${targetRarity === 'SSR' ? '**SSRè§’è‰²å¿…é¡»åŒ…å«è‡³å°‘2ç§CSSåŠ¨ç”»æ•ˆæœï¼ˆå…‰èŠ’æµåŠ¨/ç²’å­é£˜æ•£/è¾¹æ¡†è„‰å†²ç­‰ï¼‰+ é‡‘è‰²/å½©è™¹é«˜å…‰è£…é¥° + SSRä¸“å±å¾½ç« **' : targetRarity === 'SR' ? 'SRè§’è‰²å»ºè®®åŒ…å«1ç§CSSåŠ¨ç”»æ•ˆæœ' : ''}
         - é€‚é…æ‰‹æœºç§»åŠ¨ç«¯é•¿ç‰ˆä¸­æ–‡ç•Œé¢

      4. **æ›´æ–°æ¸¸æˆçŠ¶æ€ï¼ˆä½¿ç”¨JSONPatchæ ¼å¼ï¼‰ï¼š**
         - å°†æ–°è§’è‰²æ·»åŠ åˆ°è§’è‰²ä»“åº“
         - æ–°è§’è‰²å¿…é¡»åŒ…å«å­—æ®µï¼šå…ƒç´ ã€å§“åã€ç¨€æœ‰åº¦ï¼ˆå¿…é¡»æ˜¯ï¼š${targetRarity}ï¼‰ã€æ€§åˆ«ã€ç§æ—å‡ºèº«ã€èŒä¸šèº«ä»½ã€å¤–è²Œç‰¹ç‚¹ã€æ€§æ ¼å–œå¥½ã€ç®€ä»‹ã€èƒŒæ™¯æ•…äº‹ã€ç»˜å›¾æ ‡ç­¾ã€è‡ªå®šä¹‰å‰ç«¯HTMLã€**å¤–è²Œæç¤ºè¯ï¼ˆå¿…é¡»æ˜¯ä¸Šé¢ç”Ÿæˆçš„å®Œæ•´è‹±æ–‡å¤–è²Œæè¿°ï¼Œä¸æ˜¯ä»ç»˜å›¾æ ‡ç­¾æå–ï¼Œè€Œæ˜¯ç‹¬ç«‹çš„è¯¦ç»†å¤–è²Œpromptï¼‰**ã€å¥½æ„Ÿåº¦ï¼ˆ0~100ï¼‰ã€æ¨æ„ï¼ˆ0~100ï¼‰ã€å±æ€§ï¼ˆé­…åŠ›ã€é¡ºä»ã€æŠ€å·§ã€è€åŠ›ã€æ•æ„Ÿåº¦ï¼Œåˆå§‹å€¼åº”æ ¹æ®è§’è‰²çš„èŒä¸š/èº«ä»½ã€ä½“æ ¼ã€è¿‡å»çš„ç»éªŒã€ç§æ—/å‡ºèº«ã€æ€§æ ¼ç­‰å› ç´ ç»¼åˆè®¡ç®—ï¼Œä¸€èˆ¬æƒ…å†µ0-25ï¼Œç‰¹æ®Šæƒ…å†µå¦‚é­…é­”ã€å¦“å¥³ç­‰25-50ï¼Œè¯¦è§ç¬¬12ç‚¹è¯´æ˜ã€‚${attributeBonus > 0 ? `æ³¨æ„ï¼šæœ¬æ¬¡åˆæˆæœ‰${attributeBonus}%å±æ€§åŠ æˆï¼Œéœ€è¦åœ¨è®¡ç®—åé¢å¤–å¢åŠ ã€‚` : ''}ï¼‰ã€æƒ…æ„ŸçŠ¶æ€ï¼ˆå¯¹ç®¡ç†è€…çš„æƒ…æ„Ÿã€æƒ…æ„Ÿå¼ºåº¦ã€ç‰¹æ®ŠçŠ¶æ€ï¼‰ã€çŠ¶æ€ï¼ˆåˆå§‹ä¸º"ç©ºé—²"ï¼‰ã€å½“å‰ä½ç½®ï¼ˆåˆå§‹ä¸º"ä»“åº“"ï¼‰ã€ç»éªŒå€¼ï¼ˆåˆå§‹ä¸º0ï¼‰ã€ç­‰çº§ï¼ˆåˆå§‹ä¸º1ï¼‰ã€æ¥å®¢æ¬¡æ•°ï¼ˆåˆå§‹ä¸º0ï¼‰ã€è°ƒæ•™æ¬¡æ•°ï¼ˆåˆå§‹ä¸º0ï¼‰ã€æ”¶å…¥è´¡çŒ®ï¼ˆåˆå§‹ä¸º0ï¼‰ã€æœ€åäº’åŠ¨ï¼ˆå½“å‰å›åˆæ•°ï¼‰ã€ä½“åŠ›å€¼ï¼ˆåˆå§‹ä¸º100ï¼‰
         - **æ³¨æ„ï¼šç´ æè§’è‰²å·²åœ¨åˆæˆå‰è¢«åˆ é™¤ï¼Œä¸éœ€è¦åœ¨JSONPatchä¸­åˆ é™¤**
         - **ã€é‡è¦ã€‘ç¨€æœ‰åº¦å¿…é¡»ä¸¥æ ¼è®¾ç½®ä¸ºï¼š${targetRarity}ï¼Œä¸èƒ½æ˜¯å…¶ä»–å€¼ï¼**

      **é‡è¦æé†’ï¼š**
      - å‰ç«¯HTMLå¿…é¡»å®Œæ•´ï¼ŒåŒ…å«ä»\`<style>\`å¼€å§‹åˆ°æœ€åä¸€ä¸ªé—­åˆæ ‡ç­¾çš„å®Œæ•´ç»“æ„
      - å‰ç«¯HTMLç›´æ¥è¾“å‡ºåœ¨å›å¤ä¸­ï¼Œ**ç»å¯¹ä¸è¦ç”¨\`\`\`htmlä»£ç å—åŒ…è£¹**
      - å‰ç«¯HTMLä¼šç”±ç³»ç»Ÿè‡ªåŠ¨ä¿å­˜åˆ°è§’è‰².è‡ªå®šä¹‰å‰ç«¯HTMLå­—æ®µä¸­
      - ç¡®ä¿å‰ç«¯HTMLç»“æ„å®Œæ•´ï¼Œèƒ½å¤Ÿç‹¬ç«‹æ¸²æŸ“
      - ä½¿ç”¨çœŸéšæœºæ¦‚ç‡ï¼Œä¸è¦äººä¸ºè°ƒæ•´ç¨€æœ‰åº¦åˆ†å¸ƒ`;

        try {
          // è°ƒç”¨æŠ½å¡çš„AIå‘½ä»¤ï¼ˆä¼šä½¿ç”¨parseAIResponseè‡ªåŠ¨å¤„ç†å“åº”å’Œæ˜¾ç¤ºè§’è‰²å¡ï¼‰
          await sendCommandToAI(command);

          // åˆ·æ–°é¡µé¢
          saveGameStateToMVU();
          refreshAllPages();

          if (typeof toastr !== 'undefined') {
            toastr.success(`åˆæˆå®Œæˆï¼å·²åˆ é™¤ ${materialCharIds.length} ä¸ªç´ æè§’è‰²ï¼Œæ­£åœ¨ç”Ÿæˆæ–°è§’è‰²...`);
          }
        } catch (error) {
          console.error('åˆæˆå¤±è´¥:', error);
          if (typeof toastr !== 'undefined') {
            toastr.error(`åˆæˆå¤±è´¥: ${error.message}`);
          } else {
            alert(`åˆæˆå¤±è´¥: ${error.message}`);
          }
        }
      }

      function openDecompose() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'decompose-modal';

        // è·å–æ‰€æœ‰å¯åˆ†è§£çš„è§’è‰²ï¼ˆç©ºé—²çŠ¶æ€ï¼‰
        const availableChars = Object.entries(gameState.è§’è‰²ä»“åº“ || {})
          .filter(([id, char]) => char.çŠ¶æ€ === 'ç©ºé—²' && char.å½“å‰ä½ç½® === 'ä»“åº“')
          .map(([id, char]) => ({ id, char }));

        modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px">
                  <button class="modal-close" onclick="closeDecompose()">Ã—</button>
                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">âš¡ è§’è‰²åˆ†è§£</h2>

                  <div style="margin-bottom: 20px; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px">åˆ†è§£è§„åˆ™ï¼š</div>
                    <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6">
                      â€¢ Nçº§è§’è‰²ï¼š50é‡‘ + ç­‰çº§Ã—10<br>
                      â€¢ Rçº§è§’è‰²ï¼š100é‡‘ + ç­‰çº§Ã—10<br>
                      â€¢ SRçº§è§’è‰²ï¼š250é‡‘ + ç­‰çº§Ã—10<br>
                      â€¢ SSRçº§è§’è‰²ï¼š500é‡‘ + ç­‰çº§Ã—10
                    </div>
                  </div>

                  <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center">
                    <div>
                      <span style="font-size: 14px; color: var(--text-secondary)">å·²é€‰æ‹©ï¼š</span>
                      <span id="selected-count" style="font-size: 16px; font-weight: 600; color: var(--primary)">0</span>
                      <span style="font-size: 14px; color: var(--text-secondary)">ä¸ªè§’è‰²</span>
                    </div>
                    <div>
                      <span style="font-size: 14px; color: var(--text-secondary)">é¢„è®¡è·å¾—ï¼š</span>
                      <span id="total-reward" style="font-size: 16px; font-weight: 600; color: var(--accent-gold)">0</span>
                      <span style="font-size: 14px; color: var(--text-secondary)">é‡‘</span>
                    </div>
                  </div>

                  <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px">
                    <div id="decompose-character-list" style="display: flex; flex-direction: column; gap: 8px">
                      ${
                        availableChars.length === 0
                          ? '<div style="text-align: center; padding: 40px; color: var(--text-secondary)">æ²¡æœ‰å¯åˆ†è§£çš„è§’è‰²ï¼ˆåªæœ‰ç©ºé—²çŠ¶æ€çš„è§’è‰²å¯ä»¥åˆ†è§£ï¼‰</div>'
                          : availableChars
                              .map(({ id, char }) => {
                                const rarityValue = { N: 50, R: 100, SR: 250, SSR: 500 };
                                const baseReward = rarityValue[char.ç¨€æœ‰åº¦] || 50;
                                const levelBonus = (char.ç­‰çº§ || 1) * 10;
                                const reward = baseReward + levelBonus;
                                return `
                              <div style="display: flex; align-items: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 8px; border: 2px solid transparent" class="decompose-char-item" data-char-id="${id}" data-reward="${reward}">
                                <input type="checkbox" class="decompose-checkbox" data-char-id="${id}" style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer" onchange="updateDecomposeSelection()">
                                <div style="flex: 1">
                                  <div style="font-weight: 600; margin-bottom: 4px">${char.å§“å || 'æœªçŸ¥'}</div>
                                  <div style="font-size: 12px; color: var(--text-secondary)">${char.ç¨€æœ‰åº¦} Â· Lv.${char.ç­‰çº§ || 1} Â· ${char.èŒä¸šèº«ä»½ || 'æ— '}</div>
                                </div>
                                <div style="text-align: right">
                                  <div style="font-size: 14px; font-weight: 600; color: var(--accent-gold)">+${reward} é‡‘</div>
                                </div>
                              </div>
                            `;
                              })
                              .join('')
                      }
                    </div>
                  </div>

                  <div style="display: flex; gap: 12px; justify-content: flex-end">
                    <button class="btn btn-secondary" onclick="closeDecompose()">å–æ¶ˆ</button>
                    <button class="btn" id="decompose-confirm-btn" onclick="confirmDecompose()" disabled>åˆ†è§£é€‰ä¸­è§’è‰²</button>
                  </div>
                </div>
              `;

        document.body.appendChild(modal);
        modal.classList.add('active');

        // åˆå§‹åŒ–é€‰æ‹©çŠ¶æ€
        updateDecomposeSelection();
      }

      function closeDecompose() {
        closeModal('decompose-modal');
      }

      function updateDecomposeSelection() {
        const checkboxes = document.querySelectorAll('.decompose-checkbox:checked');
        const selectedCount = checkboxes.length;
        const totalReward = Array.from(checkboxes).reduce((sum, cb) => {
          const item = cb.closest('.decompose-char-item');
          return sum + parseInt(item?.dataset.reward || 0);
        }, 0);

        document.getElementById('selected-count').textContent = selectedCount;
        document.getElementById('total-reward').textContent = totalReward;

        const confirmBtn = document.getElementById('decompose-confirm-btn');
        if (confirmBtn) {
          confirmBtn.disabled = selectedCount === 0;
        }

        // æ›´æ–°é€‰ä¸­é¡¹çš„è¾¹æ¡†æ ·å¼
        document.querySelectorAll('.decompose-char-item').forEach(item => {
          const checkbox = item.querySelector('.decompose-checkbox');
          if (checkbox?.checked) {
            item.style.borderColor = 'var(--primary)';
            item.style.background = 'rgba(139, 92, 246, 0.2)';
          } else {
            item.style.borderColor = 'transparent';
            item.style.background = 'rgba(15, 23, 42, 0.6)';
          }
        });
      }

      function confirmDecompose() {
        const checkboxes = document.querySelectorAll('.decompose-checkbox:checked');
        const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.charId);

        if (selectedIds.length === 0) {
          return;
        }

        const charNames = selectedIds.map(id => gameState.è§’è‰²ä»“åº“[id]?.å§“å || id).join('ã€');
        const totalReward = parseInt(document.getElementById('total-reward').textContent);

        if (!confirm(`ç¡®å®šè¦åˆ†è§£ä»¥ä¸‹ ${selectedIds.length} ä¸ªè§’è‰²å—ï¼Ÿ\n${charNames}\n\nå°†è·å¾— ${totalReward} é‡‘`)) {
          return;
        }

        let totalRewardActual = 0;
        const rarityValue = { N: 50, R: 100, SR: 250, SSR: 500 };

        selectedIds.forEach(id => {
          const char = gameState.è§’è‰²ä»“åº“[id];
          if (!char) return;

          // è®¡ç®—å¥–åŠ±
          const baseReward = rarityValue[char.ç¨€æœ‰åº¦] || 50;
          const levelBonus = (char.ç­‰çº§ || 1) * 10;
          const reward = baseReward + levelBonus;
          totalRewardActual += reward;

          // åˆ é™¤è§’è‰²
          delete gameState.è§’è‰²ä»“åº“[id];

          // æ¸…ç†ç›¸å…³æ•°æ®
          if (gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[id]) {
            delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[id];
          }
          if (gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²?.[id]) {
            delete gameState.å¦“é™¢.å½“å‰è°ƒæ•™è§’è‰²[id];
          }

          // æ¸…ç†æˆ¿é—´ä¸­çš„è§’è‰²
          Object.values(gameState.å¦“é™¢.æˆ¿é—´çŠ¶æ€ || {}).forEach(room => {
            if (room.å½“å‰è§’è‰² === id) {
              room.å½“å‰è§’è‰² = undefined;
              room.çŠ¶æ€ = 'ç©ºé—²';
            }
          });

          // æ›´æ–°ç»Ÿè®¡æ•°æ®
          if (gameState.ç»Ÿè®¡æ•°æ®) {
            gameState.ç»Ÿè®¡æ•°æ®.è§’è‰²åˆ†å¸ƒ[char.ç¨€æœ‰åº¦] = Math.max(0, (gameState.ç»Ÿè®¡æ•°æ®.è§’è‰²åˆ†å¸ƒ[char.ç¨€æœ‰åº¦] || 0) - 1);
          }
        });

        // æ·»åŠ è´§å¸
        gameState.è´§å¸ += totalRewardActual;

        saveImmediately(); // åˆ†è§£è§’è‰²æ˜¯å…³é”®æ“ä½œï¼Œç«‹å³ä¿å­˜
        refreshAllPages();
        closeDecompose();

        if (typeof toastr !== 'undefined') {
          toastr.success(`æˆåŠŸåˆ†è§£ ${selectedIds.length} ä¸ªè§’è‰²ï¼Œè·å¾— ${totalRewardActual} é‡‘`);
        } else {
          alert(`æˆåŠŸåˆ†è§£ ${selectedIds.length} ä¸ªè§’è‰²ï¼Œè·å¾— ${totalRewardActual} é‡‘`);
        }
      }

      function openSettings() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'settings-modal';
        modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px">
                  <button class="modal-close" onclick="closeSettings()">Ã—</button>
                  <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 20px; text-align: center">âš™ï¸ æ¸¸æˆè®¾ç½®</h2>

                  <div style="margin-bottom: 24px">
                    <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">å¤–è§‚è®¾ç½®</h3>
                    <div style="display: flex; flex-direction: column; gap: 12px">
                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">
                        <div>
                          <div style="font-weight: 600; margin-bottom: 4px">å¤œé—´æ¨¡å¼</div>
                          <div style="font-size: 12px; color: var(--text-secondary)">åˆ‡æ¢æ·±è‰²/æµ…è‰²ä¸»é¢˜</div>
                        </div>
                        <label style="position: relative; display: inline-block; width: 50px; height: 26px">
                          <input type="checkbox" id="setting-dark-mode" style="opacity: 0; width: 0; height: 0" onchange="toggleDarkMode()">
                          <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(139, 92, 246, 0.3); border-radius: 26px; transition: 0.3s"></span>
                          <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s"></span>
                        </label>
                      </div>

                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">
                        <div>
                          <div style="font-weight: 600; margin-bottom: 4px">å­—ä½“å¤§å°</div>
                          <div style="font-size: 12px; color: var(--text-secondary)">è°ƒæ•´ç•Œé¢å­—ä½“å¤§å°</div>
                        </div>
                        <select id="setting-font-size" style="padding: 8px 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text-primary)" onchange="changeFontSize()">
                          <option value="small">å°</option>
                          <option value="medium" selected>ä¸­</option>
                          <option value="large">å¤§</option>
                          <option value="xlarge">ç‰¹å¤§</option>
                        </select>
                      </div>

                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">
                        <div>
                          <div style="font-weight: 600; margin-bottom: 4px">é€‚é…æ‰‹æœºç•Œé¢</div>
                          <div style="font-size: 12px; color: var(--text-secondary)">å¼ºåˆ¶ä½¿ç”¨æ›´é€‚åˆè§¦æ§çš„å¸ƒå±€/é—´è·ï¼ˆæ¡Œé¢ä¹Ÿä¼šç”Ÿæ•ˆï¼‰</div>
                        </div>
                        <label style="position: relative; display: inline-block; width: 50px; height: 26px">
                          <input type="checkbox" id="setting-mobile-ui" style="opacity: 0; width: 0; height: 0" onchange="toggleMobileUI()">
                          <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(139, 92, 246, 0.3); border-radius: 26px; transition: 0.3s"></span>
                          <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s"></span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <div style="margin-bottom: 24px">
                    <h3 style="font-size: 18px; color: var(--primary); margin-bottom: 12px">æ¸¸æˆè®¾ç½®</h3>
                    <div style="display: flex; flex-direction: column; gap: 12px">
                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">
                        <div>
                          <div style="font-weight: 600; margin-bottom: 4px">è‡ªåŠ¨è¥ä¸š</div>
                          <div style="font-size: 12px; color: var(--text-secondary)">è‡ªåŠ¨åˆ†é…ç©ºé—²è§’è‰²æ¥å®¢</div>
                        </div>
                        <label style="position: relative; display: inline-block; width: 50px; height: 26px; cursor: pointer">
                          <input type="checkbox" id="setting-auto-business" style="opacity: 0; width: 0; height: 0; position: absolute" onchange="toggleAutoBusiness()">
                          <span id="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(139, 92, 246, 0.3); border-radius: 26px; transition: 0.3s"></span>
                          <span id="toggle-knob" style="position: absolute; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2)"></span>
                        </label>
                      </div>

                      <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">
                        <div style="font-weight: 600; margin-bottom: 8px">æ”¶ç›Šå€ç‡</div>
                        <div style="display: flex; gap: 12px; align-items: center">
                          <input type="range" id="setting-income-multiplier" min="0.1" max="10" step="0.1" value="${gameState.è®¾ç½®?.æ”¶ç›Šå€ç‡ || 1}" style="flex: 1" oninput="updateIncomeMultiplier(this.value)">
                          <span id="income-multiplier-value" style="min-width: 60px; text-align: right; font-weight: 600">${gameState.è®¾ç½®?.æ”¶ç›Šå€ç‡ || 1}x</span>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px">å½±å“æ‰€æœ‰æ”¶å…¥è®¡ç®—</div>
                      </div>

                      <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">
                        <div style="font-weight: 600; margin-bottom: 8px">ç»éªŒå€ç‡</div>
                        <div style="display: flex; gap: 12px; align-items: center">
                          <input type="range" id="setting-exp-multiplier" min="0.1" max="10" step="0.1" value="${gameState.è®¾ç½®?.ç»éªŒå€ç‡ || 1}" style="flex: 1" oninput="updateExpMultiplier(this.value)">
                          <span id="exp-multiplier-value" style="min-width: 60px; text-align: right; font-weight: 600">${gameState.è®¾ç½®?.ç»éªŒå€ç‡ || 1}x</span>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px">å½±å“æ‰€æœ‰ç»éªŒè·å–</div>
                      </div>

                      <div style="padding: 12px; background: rgba(15, 23, 42, 0.6); border-radius: 12px">
                        <div style="font-weight: 600; margin-bottom: 8px">æœ€å¤§è§’è‰²æ•°é‡</div>
                        <div style="display: flex; gap: 12px; align-items: center">
                          <input type="number" id="setting-max-characters" min="10" max="1000" value="${gameState.è®¾ç½®?.æœ€å¤§è§’è‰²æ•°é‡ || 100}" style="flex: 1; padding: 8px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text-primary)" onchange="updateMaxCharacters(this.value)">
                        </div>
                      </div>
                    </div>
                  </div>

                  <div style="display: flex; gap: 12px; justify-content: flex-end">
                    <button class="btn btn-secondary" onclick="closeSettings()">å…³é—­</button>
                  </div>
                </div>
              `;

        document.body.appendChild(modal);
        modal.classList.add('active');

        // åˆå§‹åŒ–è®¾ç½®å€¼ï¼ˆé»˜è®¤å¤œé—´æ¨¡å¼ï¼štrueï¼‰
        const storedDark = localStorage.getItem('darkMode');
        const darkMode = storedDark === null ? true : storedDark === 'true';
        document.getElementById('setting-dark-mode').checked = darkMode;
        toggleDarkMode(true);

        const fontSize = localStorage.getItem('fontSize') || 'medium';
        document.getElementById('setting-font-size').value = fontSize;
        changeFontSize(true);

        const storedMobileUI = localStorage.getItem('mobileUI');
        const mobileUI =
          storedMobileUI === null ? window.matchMedia('(max-width: 768px)').matches : storedMobileUI === 'true';
        document.getElementById('setting-mobile-ui').checked = mobileUI;
        toggleMobileUI(true);

        const autoBusinessChecked = gameState.è®¾ç½®?.è‡ªåŠ¨è¥ä¸š || false;
        document.getElementById('setting-auto-business').checked = autoBusinessChecked;
        updateToggleSwitch('setting-auto-business', autoBusinessChecked);
      }

      function closeSettings() {
        closeModal('settings-modal');
      }

      // ==================== è‡ªå®šä¹‰è°ƒæ•™åŠŸèƒ½ ====================
      function toggleCustomTraining(isCustom) {
        const textarea = document.getElementById('custom-training-desc');
        const preview = document.getElementById('custom-training-preview');
        if (textarea && preview) {
          if (isCustom) {
            textarea.style.display = 'block';
            preview.style.display = 'block';
            textarea.focus();
          } else {
            textarea.style.display = 'none';
            preview.style.display = 'none';
            textarea.value = '';
            updateCustomTraining();
          }
        }
      }

      function updateCustomTraining() {
        const textarea = document.getElementById('custom-training-desc');
        const preview = document.getElementById('custom-training-preview');
        if (textarea && preview) {
          const text = textarea.value.trim();
          if (text.length > 0) {
            preview.textContent = `é¢„è§ˆï¼š${text.substring(0, 50)}${text.length > 50 ? '...' : ''}`;
            preview.style.color = 'var(--text-primary)';
          } else {
            preview.textContent = 'é¢„è§ˆï¼šè‡ªå®šä¹‰è°ƒæ•™';
            preview.style.color = 'var(--text-secondary)';
          }
        }
      }

      function toggleDarkMode(init = false) {
        const isDark = document.getElementById('setting-dark-mode').checked;
        if (!init) localStorage.setItem('darkMode', isDark);

        if (isDark) {
          document.documentElement.removeAttribute('data-theme');
        } else {
          document.documentElement.setAttribute('data-theme', 'light');
        }
      }

      function changeFontSize(init = false) {
        const size = document.getElementById('setting-font-size').value;
        if (!init) localStorage.setItem('fontSize', size);

        const sizes = {
          small: '12px',
          medium: '14px',
          large: '16px',
          xlarge: '18px',
        };
        document.documentElement.style.fontSize = sizes[size] || sizes.medium;
      }

      function applyMobileUISetting(enabled) {
        if (enabled) {
          document.documentElement.setAttribute('data-ui', 'mobile');
        } else {
          document.documentElement.removeAttribute('data-ui');
        }
      }

      function toggleMobileUI(init = false) {
        const checked = !!document.getElementById('setting-mobile-ui')?.checked;
        if (!init) localStorage.setItem('mobileUI', String(checked));
        applyMobileUISetting(checked);
      }

      function updateToggleSwitch(checkboxId, checked) {
        const checkbox = document.getElementById(checkboxId);
        const slider = document.getElementById('toggle-slider');
        const knob = document.getElementById('toggle-knob');
        if (checkbox && slider && knob) {
          if (checked) {
            slider.style.backgroundColor = 'var(--primary)';
            knob.style.transform = 'translateX(24px)';
          } else {
            slider.style.backgroundColor = 'rgba(139, 92, 246, 0.3)';
            knob.style.transform = 'translateX(0)';
          }
        }
      }

      function toggleAutoBusiness() {
        const checkbox = document.getElementById('setting-auto-business');
        const enabled = checkbox.checked;
        updateToggleSwitch('setting-auto-business', enabled);
        if (!gameState.è®¾ç½®) gameState.è®¾ç½® = {};
        gameState.è®¾ç½®.è‡ªåŠ¨è¥ä¸š = enabled;
        saveGameStateToMVU();
      }

      function updateIncomeMultiplier(value) {
        document.getElementById('income-multiplier-value').textContent = value + 'x';
        if (!gameState.è®¾ç½®) gameState.è®¾ç½® = {};
        gameState.è®¾ç½®.æ”¶ç›Šå€ç‡ = parseFloat(value);
        saveGameStateToMVU();
      }

      function updateExpMultiplier(value) {
        document.getElementById('exp-multiplier-value').textContent = value + 'x';
        if (!gameState.è®¾ç½®) gameState.è®¾ç½® = {};
        gameState.è®¾ç½®.ç»éªŒå€ç‡ = parseFloat(value);
        saveGameStateToMVU();
      }

      function updateMaxCharacters(value) {
        if (!gameState.è®¾ç½®) gameState.è®¾ç½® = {};
        gameState.è®¾ç½®.æœ€å¤§è§’è‰²æ•°é‡ = parseInt(value);
        saveGameStateToMVU();
      }

      // ==================== å­˜æ¡£ç®¡ç†åŠŸèƒ½ ====================
      function refreshSaveSlots() {
        const slotsContainer = document.getElementById('save-slots');
        if (!slotsContainer) return;

        const slots = [1, 2, 3];
        slotsContainer.innerHTML = slots
          .map(slotNum => {
            const saveData = getSaveData(slotNum);
            if (saveData) {
              const gameTime = saveData.æ¸¸æˆæ—¶é—´ || {};
              const timeText = `ç¬¬${gameTime.å¤©æ•° || 1}å¤© ${gameTime.å½“å‰æ—¶æ®µ || 'æ—©ä¸Š'} Â· å›åˆ${gameTime.å½“å‰å›åˆ || 1}`;
              const charCount = Object.keys(saveData.è§’è‰²ä»“åº“ || {}).length;
              const saveTime = new Date(saveData.ä¿å­˜æ—¶é—´ || Date.now());
              const timeStr = `${saveTime.getMonth() + 1}/${saveTime.getDate()} ${saveTime.getHours().toString().padStart(2, '0')}:${saveTime.getMinutes().toString().padStart(2, '0')}`;
              return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px">
                  <div style="flex: 1">
                    <div style="font-weight: 600; margin-bottom: 4px">å­˜æ¡£ ${slotNum}</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 2px">${timeText}</div>
                    <div style="font-size: 12px; color: var(--text-secondary)">è§’è‰²: ${charCount} | è´§å¸: ${saveData.è´§å¸ || 0} | ä¿å­˜æ—¶é—´: ${timeStr}</div>
                  </div>
                  <div style="display: flex; gap: 8px">
                    <button class="btn" style="padding: 8px 16px; font-size: 12px" onclick="loadSaveSlot(${slotNum})">åŠ è½½</button>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px" onclick="saveToSlot(${slotNum})">è¦†ç›–</button>
                  </div>
                </div>
              `;
            } else {
              return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(15, 23, 42, 0.4); border: 1px dashed rgba(139, 92, 246, 0.3); border-radius: 8px">
                  <div style="flex: 1">
                    <div style="font-weight: 600; margin-bottom: 4px">å­˜æ¡£ ${slotNum}</div>
                    <div style="font-size: 12px; color: var(--text-secondary)">ç©ºå­˜æ¡£æ§½ä½</div>
                  </div>
                  <button class="btn" style="padding: 8px 16px; font-size: 12px" onclick="saveToSlot(${slotNum})">ä¿å­˜</button>
                </div>
              `;
            }
          })
          .join('');
      }

      function getSaveData(slotNum) {
        try {
          const saved = localStorage.getItem(`game_save_slot_${slotNum}`);
          if (saved) {
            return JSON.parse(saved);
          }
        } catch (error) {
          console.error(`è¯»å–å­˜æ¡£ ${slotNum} å¤±è´¥:`, error);
        }
        return null;
      }

      function saveToSlot(slotNum) {
        try {
          // æ·±æ‹·è´æ¸¸æˆçŠ¶æ€
          const saveData = JSON.parse(JSON.stringify(gameState));
          saveData.ä¿å­˜æ—¶é—´ = Date.now();
          saveData.å­˜æ¡£æ§½ä½ = slotNum;

          localStorage.setItem(`game_save_slot_${slotNum}`, JSON.stringify(saveData));

          // æ˜¾ç¤ºæˆåŠŸæç¤º
          if (typeof toastr !== 'undefined') {
            toastr.success(`å­˜æ¡£ ${slotNum} ä¿å­˜æˆåŠŸï¼`);
          } else {
            alert(`å­˜æ¡£ ${slotNum} ä¿å­˜æˆåŠŸï¼`);
          }

          // åˆ·æ–°å­˜æ¡£æ§½ä½æ˜¾ç¤º
          refreshSaveSlots();
        } catch (error) {
          console.error(`ä¿å­˜å­˜æ¡£ ${slotNum} å¤±è´¥:`, error);
          if (typeof toastr !== 'undefined') {
            toastr.error(`ä¿å­˜å­˜æ¡£ ${slotNum} å¤±è´¥: ${error.message}`);
          } else {
            alert(`ä¿å­˜å­˜æ¡£ ${slotNum} å¤±è´¥: ${error.message}`);
          }
        }
      }

      function loadSaveSlot(slotNum) {
        try {
          const saveData = getSaveData(slotNum);
          if (!saveData) {
            if (typeof toastr !== 'undefined') {
              toastr.warning(`å­˜æ¡£ ${slotNum} ä¸å­˜åœ¨`);
            } else {
              alert(`å­˜æ¡£ ${slotNum} ä¸å­˜åœ¨`);
            }
            return;
          }

          // ç¡®è®¤åŠ è½½
          if (!confirm(`ç¡®å®šè¦åŠ è½½å­˜æ¡£ ${slotNum} å—ï¼Ÿå½“å‰æ¸¸æˆè¿›åº¦å°†è¢«è¦†ç›–ï¼`)) {
            return;
          }

          // æ¢å¤æ¸¸æˆçŠ¶æ€
          Object.assign(gameState, saveData);

          // ä¿å­˜åˆ°MVUå˜é‡ï¼ˆåŠ è½½å­˜æ¡£æ˜¯å…³é”®æ“ä½œï¼Œç«‹å³ä¿å­˜ï¼‰
          saveImmediately();

          // åˆ·æ–°æ‰€æœ‰é¡µé¢
          refreshAllPages();

          if (typeof toastr !== 'undefined') {
            toastr.success(`å­˜æ¡£ ${slotNum} åŠ è½½æˆåŠŸï¼`);
          } else {
            alert(`å­˜æ¡£ ${slotNum} åŠ è½½æˆåŠŸï¼`);
          }
        } catch (error) {
          console.error(`åŠ è½½å­˜æ¡£ ${slotNum} å¤±è´¥:`, error);
          if (typeof toastr !== 'undefined') {
            toastr.error(`åŠ è½½å­˜æ¡£ ${slotNum} å¤±è´¥: ${error.message}`);
          } else {
            alert(`åŠ è½½å­˜æ¡£ ${slotNum} å¤±è´¥: ${error.message}`);
          }
        }
      }

      // ==================== è¾…åŠ©å‡½æ•° ====================

      // æ•°æ®ä¸€è‡´æ€§éªŒè¯ï¼šç¡®ä¿æˆ¿é—´çŠ¶æ€ã€è§’è‰²çŠ¶æ€ã€æ¥å®¢ä¿¡æ¯ä¸‰è€…åŒæ­¥
      function validateDataConsistency() {
        let fixed = false;

        // 1. æ£€æŸ¥æ‰€æœ‰æˆ¿é—´ï¼šæœ‰è§’è‰²ä½†è§’è‰²ä¸å­˜åœ¨ -> æ¸…ç†æˆ¿é—´
        Object.entries(gameState.å¦“é™¢?.æˆ¿é—´çŠ¶æ€ || {}).forEach(([roomId, room]) => {
          if (room.å½“å‰è§’è‰²) {
            const char = gameState.è§’è‰²ä»“åº“?.[room.å½“å‰è§’è‰²];
            if (!char) {
              console.warn(`æ•°æ®ä¿®å¤ï¼šæˆ¿é—´ ${roomId} çš„è§’è‰² ${room.å½“å‰è§’è‰²} ä¸å­˜åœ¨ï¼Œæ¸…ç†æˆ¿é—´`);
              room.çŠ¶æ€ = 'ç©ºé—²';
              room.å½“å‰è§’è‰² = undefined;
              delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²?.[room.å½“å‰è§’è‰²];
              fixed = true;
            }
          }
          // æˆ¿é—´çŠ¶æ€ä¸ºä½¿ç”¨ä¸­ä½†æ²¡æœ‰è§’è‰² -> é‡ç½®ä¸ºç©ºé—²
          if (room.çŠ¶æ€ === 'ä½¿ç”¨ä¸­' && !room.å½“å‰è§’è‰²) {
            console.warn(`æ•°æ®ä¿®å¤ï¼šæˆ¿é—´ ${roomId} çŠ¶æ€ä¸ºä½¿ç”¨ä¸­ä½†æ— è§’è‰²ï¼Œé‡ç½®ä¸ºç©ºé—²`);
            room.çŠ¶æ€ = 'ç©ºé—²';
            fixed = true;
          }
        });

        // 2. æ£€æŸ¥æ‰€æœ‰æ¥å®¢è§’è‰²ï¼šè§’è‰²ä¸åœ¨ä»»ä½•æˆ¿é—´ä¸­ -> æ¸…ç†æ¥å®¢ä¿¡æ¯
        Object.keys(gameState.å¦“é™¢?.å½“å‰æ¥å®¢è§’è‰² || {}).forEach(charId => {
          const char = gameState.è§’è‰²ä»“åº“?.[charId];
          if (!char) {
            console.warn(`æ•°æ®ä¿®å¤ï¼šæ¥å®¢è§’è‰² ${charId} ä¸å­˜åœ¨ï¼Œæ¸…ç†æ¥å®¢ä¿¡æ¯`);
            delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[charId];
            fixed = true;
            return;
          }

          // æ£€æŸ¥è¯¥è§’è‰²æ˜¯å¦çœŸçš„åœ¨æŸä¸ªæˆ¿é—´ä¸­
          const inRoom = Object.entries(gameState.å¦“é™¢?.æˆ¿é—´çŠ¶æ€ || {}).find(([_, room]) => room.å½“å‰è§’è‰² === charId);
          if (!inRoom) {
            console.warn(`æ•°æ®ä¿®å¤ï¼šè§’è‰² ${char.å§“å} æœ‰æ¥å®¢ä¿¡æ¯ä½†ä¸åœ¨ä»»ä½•æˆ¿é—´ï¼Œæ¸…ç†`);
            delete gameState.å¦“é™¢.å½“å‰æ¥å®¢è§’è‰²[charId];
            char.çŠ¶æ€ = 'ç©ºé—²';
            char.å½“å‰ä½ç½® = 'ä»“åº“';
            fixed = true;
          }
        });

        // 3. æ£€æŸ¥æ‰€æœ‰è§’è‰²ï¼šçŠ¶æ€ä¸ºæ¥å®¢ä¸­ä½†ä¸åœ¨ä»»ä½•æˆ¿é—´ -> é‡ç½®çŠ¶æ€
        Object.entries(gameState.è§’è‰²ä»“åº“ || {}).forEach(([charId, char]) => {
          if (char.çŠ¶æ€ === 'æ¥å®¢ä¸­' || char.å½“å‰ä½ç½® === 'å¦“é™¢') {
            const inRoom = Object.entries(gameState.å¦“é™¢?.æˆ¿é—´çŠ¶æ€ || {}).find(([_, room]) => room.å½“å‰è§’è‰² === charId);
            if (!inRoom) {
              console.warn(`æ•°æ®ä¿®å¤ï¼šè§’è‰² ${char.å§“å} çŠ¶æ€ä¸ºæ¥å®¢ä¸­ä½†ä¸åœ¨ä»»ä½•æˆ¿é—´ï¼Œé‡ç½®`);
              char.çŠ¶æ€ = 'ç©ºé—²';
              char.å½“å‰ä½ç½® = 'ä»“åº“';
              delete gameState.å¦“é™¢?.å½“å‰æ¥å®¢è§’è‰²?.[charId];
              fixed = true;
            }
          }
        });

        if (fixed) {
          saveImmediately(); // æ•°æ®ä¿®å¤åç«‹å³ä¿å­˜
        }
      }

      // refreshAllPages å·²æ›¿æ¢ä¸º smartRefreshPagesï¼Œä¿ç•™æ­¤å‡½æ•°ä»¥å…¼å®¹æ—§ä»£ç 
      function refreshAllPages() {
        smartRefreshPages(true);
      }

      // ==================== åˆå§‹åŒ– ====================
      const init = async () => {
        try {
          await loadGameStateFromMVU();
          // ç¡®ä¿æ—¶é—´ä¸é™å®šå¡æ± åˆå§‹åŒ–æ­£ç¡®
          updateLimitedPoolIfNeeded();
          setupEventListeners();
          refreshAllPages();

          // åˆå§‹åŒ–è®¾ç½®
          const storedDark = localStorage.getItem('darkMode');
          const darkMode = storedDark === null ? true : storedDark === 'true';
          if (darkMode) {
            document.documentElement.removeAttribute('data-theme');
          } else {
            document.documentElement.setAttribute('data-theme', 'light');
          }
          const fontSize = localStorage.getItem('fontSize') || 'medium';
          const sizes = { small: '12px', medium: '14px', large: '16px', xlarge: '18px' };
          document.documentElement.style.fontSize = sizes[fontSize] || sizes.medium;

          const storedMobileUI = localStorage.getItem('mobileUI');
          const mobileUI =
            storedMobileUI === null ? window.matchMedia('(max-width: 768px)').matches : storedMobileUI === 'true';
          applyMobileUISetting(mobileUI);

          // ä½¿ç”¨é˜²æŠ–ä¿å­˜ï¼Œå‡å°‘é¢‘ç¹ä¿å­˜
          // å…³é”®æ“ä½œä¼šè°ƒç”¨ saveImmediately() ç«‹å³ä¿å­˜
          setInterval(() => {
            debouncedSave();
          }, 5000);
        } catch (error) {
          console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        }
      };

      if (typeof $ !== 'undefined') {
        $(init);
      } else if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    </script>
  </body>
</html>
